<?php


class ToolRepair extends CI_Controller
{

    public function __construct()
    {
        parent::__construct();
        $this->masterConfigUi = $this->config->item("heTransaksi_ui");
        $this->load->helper("he_angka");
    }

    function index()
    {
        $arrTools = array(
            "kas" => "viewUnsyncedKas",
            "produk" => "viewUnsyncedProduk",
            "produk rakitan" => "viewUnsyncedProdukRakitan",
            "supplies" => "viewUnsyncedSupplies",
            "valas" => "viewUnsyncedValas",
        );

//        foreach ($arrTools as $key => $value) {
//            echo "<div>";
//            echo "<h3>";
//            echo "<a href='" . base_url() . get_class($this) . "/$value' target='_blank'>:: $key ::</a>";
//            echo "</h3>";
//            echo "</div>";
//        }
    }

    /*
     * untuk generate coa rekening pembantu produk,supplier,bank
     * data coa rekening pembantu lama wajib dihapus dulu
     */
    public function createCoaChild()
    {
        $mdl = "MdlProduk";//model diganti disesuaikan yang akan digenerate
//        $mdl = "MdlSuppliers";//model diganti disesuaikan yang akan digenerate
        $tokoID = "0";
        $mdlaccount = "MdlAccounts";

        $this->load->model("Mdls/$mdlaccount");
        $this->load->model("Mdls/$mdl");

        $p = new $mdl();
        $a = new $mdlaccount();
        $this->db->trans_start();
//        $this->db->limit(2);
        $tempProduk = $p->lookUpAll()->result();
        $connectings = array(
            "MdlAccounts" => array(
                array(
                    "path" => "Mdls",
                    "fungsi" => "addExtern_coa_tk",
                    /* ------------------- ------------------- -------------------
                     * staticOptions bisa handling array atau singgle
                     * ---------------------------------------------------------*/
                    "staticOptions" => "1010030030",//persediaan
//                    "staticOptions" => "2010010010",//
                    "fields" => array(
                        "extern_jenis" => array(
                            "str" => "item",
                        ),
                        "extern_id" => array(
                            "var_main" => "id",
                        ),
                        "head_name" => array(
                            "var_main" => "nama",
                        ),
                        "p_head_name" => array(
                            "var_main" => "strHead_code",
                        ),
                        "create_by" => array(
                            "var_main" => "oleh_nama",
                        ),
                        /* -------------------------------------------------
                         * filter yg ingin langsung diaktifkan
                         * -------------------------------------------------*/
                        "is_active" => array(
                            "str" => "1",
                        ),
                        /*
                         * penanda sebagai rekening pembantu
                         */
                        "is_rekening_pembantu" => array(
                            "str" => "1",
                        ),
                        "is_gl" => array(
                            "str" => "0",
                        ),
                        "is_neraca" => array(
                            "str" => "0",
                        ),
                    ),
                    "updateMain" => array(
                        "condites" => array(
                            "id" => "id",
                        ),
                        "datas" => array(
                            "coa_code" => "lastInset_code",
                        )
                    )
                ),
            )
        );
//        arrprint($connectings);
//        $this->db->limit(2);
//        cekBiru($strHead_code);
        $strHead_code = $connectings[$mdlaccount]["0"]['staticOptions'];
        $oleh_nama = "sys";
        foreach ($tempProduk as $tempProduk_0) {
            foreach ($connectings as $model => $param_connecting) {
                foreach ($param_connecting as $paramConnecting) {
                    $fields = isset($paramConnecting['fields']) ? $paramConnecting['fields'] : $paramConnecting;
//                    arrPrint($fields);
                    $this->load->model($paramConnecting['path'] . "/$model");
                    $connObj = new $model();
//                    if (isset($paramConnecting['staticOptions'])) {
//                        $strHead_code = is_array($paramConnecting['staticOptions']) ? $paramConnecting['staticOptions'][$extern_tipe] : $paramConnecting['staticOptions'];
//                    }
//                    else {
//                        matiHere("static optionnya tolong dikasih di data modelnya");
//                    }
//                    cekHitam($strHead_code);
//                    arrPrintWebs($fields);
                    $datas = array();
                    foreach ($fields as $field => $cfParams) {
                        if (isset($cfParams['var_main'])) {
//                            arrPrint($cfParams);
                            $cNilai = isset($tempProduk_0->$cfParams['var_main']) ? $tempProduk_0->$cfParams['var_main'] : $$cfParams['var_main'];
                        }
                        else {
                            $cNilai = $cfParams['str'];
                        }
                        $datas[$field] = $cNilai;
                    }
//                    arrPrint($datas);
//                    matiHere();
                    $lastInset_code = $connObj->$paramConnecting['fungsi']($strHead_code, $tokoID, $datas);
                    showLast_query("merah");
                    /* -------------------------------------------------
                     * ngupdate ke data utama
                     * -------------------------------------------------*/
                    if (isset($paramConnecting['updateMain'])) {
//                        foreach ($paramConnecting['updateMain']['condites'] as $key => $condite) {
//                            $mainCondites[$key] = $$condite;
//                        }
                        $mainCondites = array(
                            "id" => $tempProduk_0->id,
                        );
                        foreach ($paramConnecting['updateMain']['datas'] as $key => $val) {
                            $mainUpdate[$key] = $$val;
                        }
//                        arrprint($mainUpdate);
                        $p->setFilters(array());
                        $p->updateData($mainCondites, $mainUpdate);
                        showLast_query("orange");
                    }
                }
            }
        }
//        cekMErah(count($tempProduk));
        matiHEre("komplitt");
//        cekBiru("HABISSSSS");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
    }

    public function generateSerialNumber()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComProdukSerialNumber");
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");
        $this->load->model("Mdls/MdlProduk2");

        $pd = New MdlProduk2();

        $jenisTr = "3333";
        $jenisStepCode = "3333";
//        $trID = "280629";
//        $trID = "280635";
//        $trID = "280643";
//        $trID = "285655";
        $trID = "296422";
//        $trID = "296432";

//        $produkIDs = array(
//            '239',
//////            '1543',
////            '23437',
////            '23434',
//////            '1547',
//////            '23432',
//////            '23429',
////            '23426',
////            '23423',
////            '23420',
////            '23417',
//        );

        $tr = New MdlTransaksi();
        $tr->addFilter("id='$trID'");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
            $id_current = $trTmp[0]->id;
            $nomer_current = $trTmp[0]->nomer;
            $id_top = $trTmp[0]->id_top;
            $nomer_top = $trTmp[0]->nomer_top;
            $dtime = $trTmp[0]->dtime;
            $fulldate = $trTmp[0]->fulldate;
            $cabang_id = $trTmp[0]->cabang_id;
            $gudang_id = $trTmp[0]->gudang_id;
            $ids_his_decode = blobDecode($trTmp[0]->ids_his);
            $count_master = 0;
            $count_master2 = 0;
            foreach ($ids_his_decode as $step => $spec) {
                if ($step == 1) {
                    $counter_decode = blobDecode($spec["counters"]);
                    foreach ($counter_decode["stepCode"] as $kk => $vv) {
                        $count_master = $vv;
                    }
                }
                if ($step == 2) {
                    $counter_decode2 = blobDecode($spec["counters"]);
                    foreach ($counter_decode2["stepCode"] as $kk2 => $vv2) {
                        $count_master2 = $vv2;
                    }
                }
            }

            $items = array();
            $items3_sum = array();
            $items5_sum = array();
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id='$trID'");
            $tmpReg = $tr->lookupDataRegistries()->result();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    foreach ($row as $key_reg => $val_reg) {
                        switch ($key_reg) {
                            case "items"://
                                $items = $items + unserialize(base64_decode($val_reg));
                                break;
                            case "items3_sum"://
                                $items3_sum = $items3_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items5_sum"://
                                $items5_sum = $items5_sum + unserialize(base64_decode($val_reg));
                                break;
                        }
                    }
                }
            }


            $this->db->trans_start();

            $data = array();
            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                if (sizeof($items3_sum) > 0) {
                    foreach ($items3_sum as $ii => $spec) {
//                    cekHere($spec["produk_sku_part_nama"]);
//                    arrPrintWebs($spec);
                        $itemFlip = array_flip($items[$spec["id"]]);
                        $key_data_arr = explode("_", $itemFlip[$spec["produk_sku_part_nama"]]);
                        switch ($key_data_arr[0]) {
                            case "outdoor":
                                $part_kode = "OT";
                                break;
                            case "indoor":
                                $part_kode = "IN";
                                break;
                            default:
                                $part_kode = "";
                                break;
                        }
                        $data[$ii] = array(
                            "static" => array(
                                "cabang_id" => $spec["placeID"],
                                "jumlah" => $spec["qty"],
                                "produk_id" => $spec["id"],
                                "produk_nama" => $spec["name"],
                                "produk_serial_number" => $spec["serial_number"],
                                "produk_sku" => $spec["produk_sku"],
                                "produk_sku_serial" => $spec["produk_sku_serial"],
                                "produk_sku_part_id" => $spec["produk_sku_part_id"],
                                "produk_sku_part_nama" => $spec["produk_sku_part_nama"],
                                "produk_sku_part_serial" => $spec["produk_sku_part_serial"],
                                "oleh_id" => $spec["olehID"],
                                "oleh_nama" => $spec["olehName"],
                                "supplier_id" => $spec["supplierID"],
                                "supplier_nama" => $spec["supplierName"],
                                "gudang_id" => $spec["gudangID"],
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => $count_master,
                                "transaksi_count" => 1,
                                "transaksi_jenis_count" => $count_master2,
                                "part_keterangan" => $part_kode,
                                "transaksi_id" => $id_current,
                                "transaksi_no" => $nomer_current,
                            ),
                        );
                    }

                    $cm = New ComProdukSerialNumber();
                    $cm->pair($data);
                    $cm->exec();

                }
            }
            else {
                cekHere("custom...");
                $free_produk = 1;
                if ($free_produk == 0) {
                    foreach ($items as $pID => $iSpec) {
//                    arrPrintKuning($iSpec);
//                    $iSpec["gudangID"] = $iSpec["gudangProjectID"];

                        $pd->setFilters(array());
                        $pd->addFilter("id='$pID'");
                        $pdTmp = $pd->lookupAll()->result();

                        $part_kode = $produk_kode = $pdTmp[0]->kode;
                        $produk_nama = $pdTmp[0]->nama;
                        $supplier_id = $pdTmp[0]->supplier_id;
                        $supplier_nama = $pdTmp[0]->supplier_nama;
                        $kategori_id = $pdTmp[0]->kategori_id;
                        $kategori_nama = $pdTmp[0]->kategori_nama;
                        $outdoor_sku = $pdTmp[0]->outdoor_sku;
                        $indoor_sku_1 = $pdTmp[0]->indoor_sku_1;
                        $indoor_sku_2 = $pdTmp[0]->indoor_sku_2;
                        $indoor_sku_3 = $pdTmp[0]->indoor_sku_3;
                        $indoor_sku_4 = $pdTmp[0]->indoor_sku_4;
                        $outdoor_sku_label = $pdTmp[0]->outdoor_sku_label;
                        $indoor_sku_1_label = $pdTmp[0]->indoor_sku_1_label;
                        $indoor_sku_2_label = $pdTmp[0]->indoor_sku_2_label;
                        $indoor_sku_3_label = $pdTmp[0]->indoor_sku_3_label;
                        $indoor_sku_4_label = $pdTmp[0]->indoor_sku_4_label;

                        $jml = $iSpec["jml"];
                        for ($i = 1; $i <= $jml; $i++) {
                            if ($outdoor_sku != NULL) {
//                            cekHere("masuk disini");
                                $data[] = array(
                                    "static" => array(
                                        "cabang_id" => $iSpec["placeID"],
                                        "jumlah" => 1,
                                        "produk_id" => $pID,
                                        "produk_nama" => $produk_nama,
                                        "produk_serial_number" => "",
                                        "produk_sku" => $outdoor_sku,
                                        "produk_sku_serial" => "",
                                        "produk_sku_part_id" => "",
                                        "produk_sku_part_nama" => $outdoor_sku,
                                        "produk_sku_part_serial" => "",
                                        "oleh_id" => $iSpec["olehID"],
                                        "oleh_nama" => $iSpec["olehName"],
                                        "supplier_id" => $supplier_id,
                                        "supplier_nama" => $supplier_nama,
                                        "gudang_id" => $iSpec["gudangID"],
                                        "jenis" => $iSpec["jenisTr"],
                                        //---------------
                                        "transaksi_reference_id" => $id_top,
                                        "transaksi_reference_no" => $nomer_top,
                                        "transaksi_reference_dtime" => $dtime,
                                        "transaksi_reference_fulldate" => $fulldate,
                                        "transaksi_reference_count" => 1,
                                        "transaksi_count" => 1,
                                        "transaksi_jenis_count" => 1,
                                        "part_keterangan" => strtoupper($outdoor_sku_label),
                                        "transaksi_id" => $id_current,
                                        "transaksi_no" => $nomer_current,
                                        "dtime" => $dtime,
                                        "fulldate" => $fulldate,
                                    ),
                                );
                            }
                            if ($indoor_sku_1 != NULL) {
                                $data[] = array(
                                    "static" => array(
                                        "cabang_id" => $iSpec["placeID"],
                                        "jumlah" => 1,
                                        "produk_id" => $pID,
                                        "produk_nama" => $produk_nama,
                                        "produk_serial_number" => "",
                                        "produk_sku" => $indoor_sku_1,
                                        "produk_sku_serial" => "",
                                        "produk_sku_part_id" => "",
                                        "produk_sku_part_nama" => $indoor_sku_1,
                                        "produk_sku_part_serial" => "",
                                        "oleh_id" => $iSpec["olehID"],
                                        "oleh_nama" => $iSpec["olehName"],
                                        "supplier_id" => $supplier_id,
                                        "supplier_nama" => $supplier_nama,
                                        "gudang_id" => $iSpec["gudangID"],
                                        "jenis" => $iSpec["jenisTr"],
                                        //---------------
                                        "transaksi_reference_id" => $id_top,
                                        "transaksi_reference_no" => $nomer_top,
                                        "transaksi_reference_dtime" => $dtime,
                                        "transaksi_reference_fulldate" => $fulldate,
                                        "transaksi_reference_count" => 1,
                                        "transaksi_count" => 1,
                                        "transaksi_jenis_count" => 1,
                                        "part_keterangan" => strtoupper($indoor_sku_1_label),
                                        "transaksi_id" => $id_current,
                                        "transaksi_no" => $nomer_current,
                                        "dtime" => $dtime,
                                        "fulldate" => $fulldate,
                                    ),
                                );
                            }

                        }


                    }
                }
                else {
                    foreach ($items5_sum as $pID => $iSpec) {

                        $pd->setFilters(array());
                        $pd->addFilter("id='$pID'");
                        $pd->addFilter("kategori_id='3'");
                        $pdTmp = $pd->lookupAll()->result();
                        showLast_query("biru");
                        if (sizeof($pdTmp) > 0) {

                            $part_kode = $produk_kode = $pdTmp[0]->kode;
                            $produk_nama = $pdTmp[0]->nama;
                            $supplier_id = $pdTmp[0]->supplier_id;
                            $supplier_nama = $pdTmp[0]->supplier_nama;
                            $kategori_id = $pdTmp[0]->kategori_id;
                            $kategori_nama = $pdTmp[0]->kategori_nama;
                            $outdoor_sku = $pdTmp[0]->outdoor_sku;
                            $indoor_sku_1 = $pdTmp[0]->indoor_sku_1;
                            $indoor_sku_2 = $pdTmp[0]->indoor_sku_2;
                            $indoor_sku_3 = $pdTmp[0]->indoor_sku_3;
                            $indoor_sku_4 = $pdTmp[0]->indoor_sku_4;
                            $outdoor_sku_label = $pdTmp[0]->outdoor_sku_label;
                            $indoor_sku_1_label = $pdTmp[0]->indoor_sku_1_label;
                            $indoor_sku_2_label = $pdTmp[0]->indoor_sku_2_label;
                            $indoor_sku_3_label = $pdTmp[0]->indoor_sku_3_label;
                            $indoor_sku_4_label = $pdTmp[0]->indoor_sku_4_label;

                            $outdoor_sku_label = "PART";

                            $jml = $iSpec["jml"];
                            for ($i = 1; $i <= $jml; $i++) {
                                $data[] = array(
                                    "static" => array(
                                        "cabang_id" => $iSpec["placeID"],
                                        "jumlah" => 1,
                                        "produk_id" => $pID,
                                        "produk_nama" => $produk_nama,
                                        "produk_serial_number" => "",
                                        "produk_sku" => $produk_kode,
//                                        "produk_sku" => $outdoor_sku,
                                        "produk_sku_serial" => "",
                                        "produk_sku_part_id" => "",
                                        "produk_sku_part_nama" => $produk_kode,
//                                        "produk_sku_part_nama" => $outdoor_sku,
                                        "produk_sku_part_serial" => "",
                                        "oleh_id" => $iSpec["olehID"],
                                        "oleh_nama" => $iSpec["olehName"],
                                        "supplier_id" => $supplier_id,
                                        "supplier_nama" => $supplier_nama,
                                        "gudang_id" => $iSpec["gudangID"],
                                        "jenis" => $iSpec["jenisTr"],
                                        //---------------
                                        "transaksi_reference_id" => $id_top,
                                        "transaksi_reference_no" => $nomer_top,
                                        "transaksi_reference_dtime" => $dtime,
                                        "transaksi_reference_fulldate" => $fulldate,
                                        "transaksi_reference_count" => 1,
                                        "transaksi_count" => 1,
                                        "transaksi_jenis_count" => 1,
                                        "part_keterangan" => strtoupper($outdoor_sku_label),
                                        "transaksi_id" => $id_current,
                                        "transaksi_no" => $nomer_current,
                                        "dtime" => $dtime,
                                        "fulldate" => $fulldate,
                                    ),
                                );


                            }
                        }


                    }
                }
                arrPrintCyan($data);
//                mati_disini(__LINE__);

                if (sizeof($data) > 0) {
                    cekHitam("total serial akan digenerate: " . count($data));
                    $cm = New ComProdukSerialNumber();
                    $cm->pair($data);
                    $cm->exec();
                    cekBiru($this->db->last_query());
                }
                else {
                    cekMerah("KOSONG...");
                }
            }


            mati_disini("SETOP.... " . __LINE__);
            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
            cekHijau("<h3>...DONE...</h3>");


        }
        else {
            cekHitam("kosong belum ada data");
        }

    }

    public function generateSerialNumberNonUnit()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlProduk2");
        $this->load->model("Coms/ComProdukSerialNumber");


        $jenisTr = "6699";
        $jenisStepCode = "6699";
//        $trID = "9";
//        $trID = "11";
//        $trID = "13";
        $trID = "134172";

        $pd = New MdlProduk2();

        $tr = New MdlTransaksi();
        $tr->addFilter("id='$trID'");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
//            arrPrintKuning($trTmp);
            $id_current = $trTmp[0]->id;
            $nomer_current = $trTmp[0]->nomer;
            $id_top = $trTmp[0]->id_top;
            $nomer_top = $trTmp[0]->nomer_top;
            $dtime = $trTmp[0]->dtime;
            $fulldate = $trTmp[0]->fulldate;
            $cabang_id = $trTmp[0]->cabang_id;
            $gudang_id = $trTmp[0]->gudang_id;
            $jenisTr = $trTmp[0]->jenis;
            $ids_his_decode = blobDecode($trTmp[0]->ids_his);
            $count_master = 0;
            $count_master2 = 0;
            foreach ($ids_his_decode as $step => $spec) {
                if ($step == 1) {
                    $counter_decode = blobDecode($spec["counters"]);
                    foreach ($counter_decode["stepCode"] as $kk => $vv) {
                        $count_master = $vv;
                    }
                }
                if ($step == 2) {
                    $counter_decode2 = blobDecode($spec["counters"]);
                    foreach ($counter_decode2["stepCode"] as $kk2 => $vv2) {
                        $count_master2 = $vv2;
                    }
                }
            }

            $items = array();
            $items3_sum = array();
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id='$trID'");
            $tmpReg = $tr->lookupDataRegistries()->result();
//            cekLime($this->db->last_query());
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    foreach ($row as $key_reg => $val_reg) {
                        switch ($key_reg) {
                            case "items"://
                                $items = $items + unserialize(base64_decode($val_reg));
                                break;
                            case "items3_sum"://
                                $items3_sum = $items3_sum + unserialize(base64_decode($val_reg));
                                break;
                        }
                    }
                }
            }
//            arrprint($items);
//            arrprint($items3_sum);
//matiHere(__LINE__);
            $data = array();
            if (sizeof($items) > 0) {
                foreach ($items as $ii => $spec) {
//                    cekHere($spec["produk_sku_part_nama"]);
//                    arrPrintWebs($spec);
                    $pd->setFilters(array());
//                    $pd->addFilter("id='$ii'");
                    $pd->addFilter("id='" . $spec['extern_id'] . "'");
                    $pdTmp = $pd->lookupAll()->result();
                    $produk_kode = $pdTmp[0]->kode;

                    $jml = $spec["jml"];
//                    cekHere(":: $jml ::");
//                    $i=1;
                    for ($i = 1; $i <= $jml; $i++) {

                        $itemFlip = array_flip($items[$spec["id"]]);
                        $key_data_arr = explode("_", $itemFlip[$spec["produk_sku_part_nama"]]);
                        switch ($key_data_arr[0]) {
                            case "outdoor":
                                $part_kode = "OT";
                                break;
                            case "indoor":
                                $part_kode = "IN";
                                break;
                            default:
                                $part_kode = "PART";
                                break;
                        }
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $spec["placeID"],
//                                "jumlah" => $spec["qty"],
                                "jumlah" => 1,
                                "produk_id" => $spec["extern_id"],
                                "produk_nama" => $spec["extern_nama"],
                                "produk_serial_number" => $spec["serial_number"],
//                                "produk_sku" => $spec["produk_sku"],
                                "produk_sku" => $produk_kode,
                                "produk_sku_serial" => $spec["produk_sku_serial"],
                                "produk_sku_part_id" => $spec["produk_sku_part_id"],
//                                "produk_sku_part_nama" => $spec["produk_sku_part_nama"],
                                "produk_sku_part_nama" => $produk_kode,
                                "produk_sku_part_serial" => $spec["produk_sku_part_serial"],
                                "oleh_id" => $spec["olehID"],
                                "oleh_nama" => $spec["olehName"],
                                "supplier_id" => $spec["supplierID"],
                                "supplier_nama" => $spec["supplierName"],
                                "gudang_id" => $spec["gudangID"],
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => $count_master,
                                "transaksi_count" => 1,
                                "transaksi_jenis_count" => $count_master2,
                                "part_keterangan" => $part_kode,
                                "transaksi_id" => $id_current,
                                "transaksi_no" => $nomer_current,
                            ),
                        );
                    }
                }
//                arrPrintHijau($data);
//                mati_disini(__LINE__);

                $this->db->trans_start();

//
                $cm = New ComProdukSerialNumber();
                $cm->pair($data);
                $cm->exec();

                mati_disini(__LINE__);
                $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
                cekHijau("<h3>...DONE...</h3>");

            }
            else {
                cekMerah("KOSONG...");
            }
        }

    }

    public function generateSerialNumber2()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComProdukSerialNumber");


        $jenisTr = "6699";
        $jenisStepCode = "6699s";
//        $trID = "21";
        $trID = "1";

        $tr = New MdlTransaksi();
        $tr->addFilter("id='$trID'");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
//            arrPrintKuning($trTmp);
            $id_current = $trTmp[0]->id;
            $nomer_current = $trTmp[0]->nomer;
            $id_top = $trTmp[0]->id_top;
            $nomer_top = $trTmp[0]->nomer_top;
            $dtime = $trTmp[0]->dtime;
            $fulldate = $trTmp[0]->fulldate;
            $cabang_id = $trTmp[0]->cabang_id;
            $gudang_id = $trTmp[0]->gudang_id;
            $ids_his_decode = blobDecode($trTmp[0]->ids_his);
            $count_master = 0;
            $count_master2 = 0;
            foreach ($ids_his_decode as $step => $spec) {
                if ($step == 1) {
                    $counter_decode = blobDecode($spec["counters"]);
                    foreach ($counter_decode["stepCode"] as $kk => $vv) {
                        $count_master = $vv;
                    }
                }
                if ($step == 2) {
                    $counter_decode2 = blobDecode($spec["counters"]);
                    foreach ($counter_decode2["stepCode"] as $kk2 => $vv2) {
                        $count_master2 = $vv2;
                    }
                }
            }

            $items = array();
            $items3_sum = array();
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id='$trID'");
            $tmpReg = $tr->lookupDataRegistries()->result();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    foreach ($row as $key_reg => $val_reg) {
                        switch ($key_reg) {
                            case "items"://
                                $items = $items + unserialize(base64_decode($val_reg));
                                break;
                            case "items3_sum"://
                                $items3_sum = $items3_sum + unserialize(base64_decode($val_reg));
                                break;
                        }
                    }
                }
            }
//            arrPrintPink($items3_sum);
//            arrPrintPink($items);
            if (sizeof($items3_sum) > 0) {
                foreach ($items3_sum as $ii => $spec) {
//                    cekHere($spec["produk_sku_part_nama"]);
//                    arrPrintWebs($spec);
                    $itemFlip = array_flip($items[$spec["id"]]);
                    $key_data_arr = explode("_", $itemFlip[$spec["produk_sku_part_nama"]]);
                    switch ($key_data_arr[0]) {
                        case "outdoor":
                            $part_kode = "OT";
                            break;
                        case "indoor":
                            $part_kode = "IN";
                            break;
                        default:
                            $part_kode = "";
                            break;
                    }
                    $data[$ii] = array(
                        "static" => array(
                            "cabang_id" => $spec["placeID"],
                            "jumlah" => $spec["qty"],
                            "produk_id" => $spec["id"],
                            "produk_nama" => $spec["name"],
                            "produk_serial_number" => $spec["serial_number"],
                            "produk_sku" => $spec["produk_sku"],
                            "produk_sku_serial" => $spec["produk_sku_serial"],
                            "produk_sku_part_id" => $spec["produk_sku_part_id"],
                            "produk_sku_part_nama" => $spec["produk_sku_part_nama"],
                            "produk_sku_part_serial" => $spec["produk_sku_part_serial"],
                            "oleh_id" => $spec["olehID"],
                            "oleh_nama" => $spec["olehName"],
                            "supplier_id" => $spec["supplierID"],
                            "supplier_nama" => $spec["supplierName"],
                            "gudang_id" => $spec["gudangID"],
                            //---------------
                            "transaksi_reference_id" => $id_top,
                            "transaksi_reference_no" => $nomer_top,
                            "transaksi_reference_dtime" => $dtime,
                            "transaksi_reference_fulldate" => $fulldate,
                            "transaksi_reference_count" => $count_master,
                            "transaksi_count" => 1,
                            "transaksi_jenis_count" => $count_master2,
                            "part_keterangan" => $part_kode,
                            "transaksi_id" => $id_current,
                            "transaksi_no" => $nomer_current,
                        ),
                    );
                }
//                arrPrintHijau($data);


                $this->db->trans_start();

//
                $cm = New ComProdukSerialNumber();
                $cm->pair($data);
                $cm->exec();

                mati_disini(__LINE__);
                $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
                cekHijau("<h3>...DONE...</h3>");

            }
        }
        else {
            cekMerah("tidak ada transaksi...");
        }

    }

    //-------------------------
    public function sinkronOutdoor()
    {
        $this->load->model("Mdls/MdlModelOutdoor");
        $this->load->model("Mdls/MdlMerek");
        $this->load->model("Mdls/MdlSupplier");

        $sp = New MdlSupplier();
        $mr = New MdlMerek();
        $mo = New MdlModelOutdoor();
        $arrSupplier = array();
        $arrMerek = array();

        $spTmp = $sp->lookupAll()->result();
        foreach ($spTmp as $spSpec) {
            $arrSupplier[$spSpec->id] = $spSpec->nama;
        }

        $mrTmp = $mr->lookupAll()->result();
        foreach ($mrTmp as $mrSpec) {
            $arrMerek[$mrSpec->id] = $mrSpec->nama;
        }


        $this->db->trans_start();


        $moTmp = $mo->lookupAll()->result();
        foreach ($moTmp as $moSpec) {
            $tbl_id = $moSpec->id;
            $where = array(
                "id" => $tbl_id,
            );
            $data = array(
                "merek_nama" => $arrMerek[$moSpec->merek_id],
                "supplier_nama" => $arrSupplier[$moSpec->supplier_id],
            );

            $mo = New MdlModelOutdoor();
            $mo->setFilters(array());
            $mo->updateData($where, $data);
            showLast_query("orange");
        }


        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");

    }

    //-------------------------
    public function patchDataProduk()
    {
        $this->load->model("Mdls/MdlModelOutdoor");
        $this->load->model("Mdls/MdlProduk2");
        $this->load->model("Mdls/MdlModelIndoor_1");

        $sp = New MdlModelIndoor_1();
        $mr = New MdlProduk2();
        $mo = New MdlModelOutdoor();
        $arrIndoor = array();
        $arrOutdoor = array();

        $sp->setFilters(array());
        $spTmp = $sp->lookupAll()->result();
        foreach ($spTmp as $spSpec) {
            $arrIndoor[$spSpec->id] = $spSpec->sku;
        }

        $mo->setFilters(array());
        $moTmp = $mo->lookupAll()->result();
        foreach ($moTmp as $moSpec) {
            $arrOutdoor[$moSpec->id] = $moSpec->sku;
        }


        $this->db->trans_start();

        $mr->setFilters(array());
        $mr->addFilter("outdoor_sku is null");
        $mr->addFilter("kategori_id='1'");
        $mrTmp = $mr->lookupAll()->result();
        showLast_query("biru");
        foreach ($mrTmp as $mrSpec) {
            $tbl_id = $mrSpec->id;
            $outdoor_id = $mrSpec->outdoor_id;
            $indoor_id_1 = $mrSpec->indoor_id_1;
            $indoor_id_2 = $mrSpec->indoor_id_2;
            $indoor_id_3 = $mrSpec->indoor_id_3;
            $indoor_id_4 = $mrSpec->indoor_id_4;
            cekHere("pid: $tbl_id, ot: $outdoor_id, in1: $indoor_id_1, in2: $indoor_id_2, in3: $indoor_id_3, in4: $indoor_id_4");
            $where = array(
                "id" => $tbl_id,
            );
            $data = array(
                "outdoor_sku" => isset($arrOutdoor[$outdoor_id]) ? $arrOutdoor[$outdoor_id] : NULL,
                "indoor_sku_1" => isset($arrIndoor[$indoor_id_1]) ? $arrIndoor[$indoor_id_1] : NULL,
                "indoor_sku_2" => isset($arrIndoor[$indoor_id_2]) ? $arrIndoor[$indoor_id_2] : NULL,
                "indoor_sku_3" => isset($arrIndoor[$indoor_id_3]) ? $arrIndoor[$indoor_id_3] : NULL,
                "indoor_sku_4" => isset($arrIndoor[$indoor_id_4]) ? $arrIndoor[$indoor_id_4] : NULL,
            );
//            arrPrintWebs($data);
            $mr->setFilters(array());
            $mr->updateData($where, $data);
            showLast_query("orange");
        }


        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");

    }

    public function generateRekeningSerialNumber()
    {
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");
        $this->load->model("Mdls/MdlProdukPerSerialNumber");

        $psn = New MdlProdukPerSerialNumber();
        $csn = New ComRekeningPembantuProdukPerSerial();


        $this->db->trans_start();


//        $psn->addFilter("transaksi_id!=189");
        $psnTmp = $psn->lookupAll()->result();
//        showLast_query("biru");
//        mati_disini(__LINE__);
        if (sizeof($psnTmp) > 0) {
            foreach ($psnTmp as $ctr => $psnSpec) {
                $params = (array)$psnSpec;
//                arrPrintWebs($params);
                $l = new ComRekeningPembantuProdukPerSerial();
                $l->addFilter("extern_nama=" . $params["produk_serial_number_2"]);
                $l->addFilter("cabang_id=" . my_cabang_id());
                $tmp = $l->lookupAll()->result();
                if (sizeof($tmp) == 0) {
                    $arrData = array();
                    $arrData[$ctr] = array(
                        "loop" => array(
                            "1010030030" => "1",//persediaan produk, sub_diskon_nilai_total
                        ),
                        "static" => array(
                            "cabang_id" => $params["cabang_id"],
                            "gudang_id" => $params["gudang_id"],
                            "extern_id" => "0",
                            "extern_nama" => $params["produk_serial_number_2"],// nomer serial
                            "extern2_id" => "0",
                            "extern2_nama" => $params["produk_sku_part_nama"],// sku indoor, outdoor
                            "produk_id" => $params["produk_id"],// produk id
                            "produk_nama" => $params["produk_nama"],// produk nama
                            "produk_qty" => 1,
                            "produk_nilai" => 1,
                            "jenis" => isset($params["jenis"]) ? $params["jenis"] : "0000",
                            "transaksi_id" => $params["transaksi_id"],
                            "transaksi_no" => $params["transaksi_no"],
                            "supplierID" => $params["supplier_id"],
                            "dtime" => $params["dtime_last"],
//                        "dtime" => $params["transaksi_reference_dtime"],
//                        "fulldate" => $params["fulldate"],
                            "fulldate" => $params["dtime_last"],
                        ),
                    );
                    $l = new ComRekeningPembantuProdukPerSerial();
                    $l->pair($arrData);
                    $l->exec();
                }

//                break;
            }
        }


        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");


    }

    public function generateBarcodeSerialNumber()
    {
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");
        $this->load->model("Coms/ComProdukSerialNumber");
        $this->load->model("Mdls/MdlProdukPerSerialNumber");
        $this->load->model("Mdls/MdlProduk2");
        $this->load->model("MdlTransaksi");

        $psn = New MdlProdukPerSerialNumber();
        $psd = New MdlProduk2();
        $tr = New MdlTransaksi();

        $trIDs = array(
//            99685,
//            99689,
//            99691,
//            99703,//////
//            99715,
//            99723,
//            99823,
//            100127,
            "543175",
        );


        $this->db->trans_start();

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("id in ('" . implode("','", $trIDs) . "')");
        $tmp = $tr->lookupAll()->result();
//        arrPrint($tmp);
        $tr_id = $tmp[0]->id;
        $tr_no = $tmp[0]->nomer;
        $dtime = $tmp[0]->dtime;
        $fulldate = $tmp[0]->fulldate;
        $jenisTr_top = $tmp[0]->jenis_top;
        $jenisTr = $tmp[0]->jenis;
        $ids_his = blobDecode($tmp[0]->ids_his);
        $ids_his_1 = $ids_his[1];
        $ids_his_2 = $ids_his[2];
//        arrPrintPink($ids_his_1);
//        arrPrintPink($ids_his_2);
        $counter_decode_1 = blobDecode($ids_his_1["counters"]);
        $counter_decode_2 = blobDecode($ids_his_2["counters"]);
//        arrPrint($counter_decode);
        $transaksi_reference_dtime = $ids_his_2["dtime"];
        $transaksi_reference_fulldate = $ids_his_2["fulldate"];
        $transaksi_reference_count = $counter_decode_1["stepCode"][$jenisTr_top];
        $transaksi_count = $counter_decode_2["stepCode"][$jenisTr];
        $transaksi_jenis_count = $counter_decode_2["stepCode"][$jenisTr];

        $main = array();
        $items = array();
        $items2_sum = array();
        $items3_sum = array();
        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
        $tmpReg = $tr->lookupDataRegistries()->result();
        if (sizeof($tmpReg) > 0) {
            foreach ($tmpReg as $row) {
                foreach ($row as $key_reg => $val_reg) {
                    switch ($key_reg) {
                        case "main"://
                            $main = $main + unserialize(base64_decode($val_reg));
                            break;
                        case "items"://
                            $items = $items + unserialize(base64_decode($val_reg));
                            break;
                        case "items2_sum"://
                            $items2_sum = $items2_sum + unserialize(base64_decode($val_reg));
                            break;
                        case "items3_sum"://
                            $items3_sum = $items3_sum + unserialize(base64_decode($val_reg));
                            break;
                    }
                }
            }
        }
        $dataRegistry = array(
            "main" => $main,
            "items" => $items,
            "items2_sum" => $items2_sum,
            "items3_sum" => $items3_sum,
        );

        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            if (sizeof($items2_sum) > 0) {
                $no = 0;
                foreach ($items2_sum as $ii => $spec) {
                    $jml = $spec["jml"];
                    for ($i = 1; $i <= $jml; $i++) {
                        $no++;
                        $data[$no] = array(
                            "loop" => array(),
                            "static" => array(
                                "cabang_id" => $spec["placeID"],
                                "jumlah" => 1,
                                "produk_id" => $spec["id"],
                                "produk_nama" => $spec["nama"],
                                "produk_serial_number" => "",
                                "produk_sku" => $spec["produk_kode"],
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $spec["produk_kode"],
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $spec["olehID"],
                                "oleh_nama" => $spec["olehName"],
                                "supplier_id" => $spec["supplierID"],
                                "supplier_nama" => $spec["supplierName"],
                                "gudang_id" => $spec["gudangID"],
                                "transaksi_reference_id" => $trID,
                                "transaksi_reference_no" => $tmp[0]->nomer,
                                "transaksi_reference_dtime" => "$transaksi_reference_dtime",
                                "transaksi_reference_fulldate" => "$transaksi_reference_fulldate",
                                "transaksi_reference_count" => "$transaksi_reference_count",
                                "transaksi_count" => "$transaksi_count",
                                "transaksi_jenis_count" => "$transaksi_jenis_count",
                                "transaksi_id" => "$tr_id",
                                "transaksi_no" => "$tr_no",
                                "dtime" => "$dtime",
                                "fulldate" => "$fulldate",
                                "jenis" => "$jenisTr",
                            ),
                        );
                    }
                }
            }
            arrPrintHijau($data);

            $cm = New ComProdukSerialNumber();
            $cm->pair($data);
            $cm->exec();
        }
        else {
            $postProcessor = array(
                "master" => array(),
                "detail" => array(
                    // serial number produk
                    array(
                        "comName" => "ProdukSerialNumber",
                        "loop" => array(),
                        "static" => array(
                            "cabang_id" => "placeID",
                            "jumlah" => "qty",
                            "produk_id" => "id",
                            "produk_nama" => "name",
                            "produk_serial_number" => "serial_number",
                            "produk_sku" => "produk_sku",
                            "produk_sku_serial" => "produk_sku_serial",
                            "produk_sku_part_id" => "produk_sku_part_id",
                            "produk_sku_part_nama" => "produk_sku_part_nama",
                            "produk_sku_part_serial" => "produk_sku_part_serial",
                            "oleh_id" => "olehID",
                            "oleh_nama" => "olehName",
                            "supplier_id" => "supplierID",
                            "supplier_nama" => "supplierName",
                            "gudang_id" => "gudangID",
                            //---------------
                            "transaksi_reference_id" => "referenceID",
                            "transaksi_reference_no" => "referenceNomer",
                            "transaksi_reference_dtime" => "referenceDate",
                            "transaksi_reference_fulldate" => "referenceFulldate",
                            "transaksi_reference_count" => "referenceCount",
                            "transaksi_count" => "transaksi_count",
                            "transaksi_jenis_count" => "transaksi_jenis_count",
                            "part_keterangan" => "part_keterangan",
                        ),
                        "srcGateName" => "items3_sum",
                        "srcRawGateName" => "items3_sum",
                    ),
                ),
            );

            //region processing sub-post-processors, always
            $iterator = isset($postProcessor['detail']) ? $postProcessor['detail'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "sub-postProcessor: $comName, initializing values MENYIAPKAN DATA SUB-PROCESSORS UNTUK DIKIRIM... <br>";

                    $tmpOutParams[$cCtr] = array();
                    if (isset($dataRegistry[$srcGateName]) && count($dataRegistry[$srcGateName]) > 0) {
//                    matiHere(__LINE__);
                        foreach ($dataRegistry[$srcGateName] as $cnt => $dSpec) {
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {

                                    $realValue = makeValue($value, $dataRegistry[$srcGateName][$cnt], $dataRegistry[$srcGateName][$cnt], 0);
                                    $subParams['loop'][$key] = $realValue;

                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $dataRegistry[$srcGateName][$cnt], $dataRegistry[$srcGateName][$cnt], 0);
                                    $subParams['static'][$key] = $realValue;
//                                    cekBiru("$key diisi dengan $realValue");

                                }

                                if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                    foreach ($paramPatchers[$comName] as $k => $v) {
                                        if (!isset($subParams['static'][$k])) {
                                            $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                        }
                                    }
                                }
                                if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                    $jenis = $dataRegistry['main']['jenis'];
                                    foreach ($paramForceFillers[$comName] as $k => $v) {
                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                        cekorange(":: $k diisikan dengan " . $subParams['static'][$k]);
                                    }
                                }
                                // tambahan custom gerbang saat simpan transaksi, tidak bisa ditambahkan di coTransaksiCore/coTransaksiValues
                                if (isset($paramForceFillersJenisTR[$comName][$this->jenisTr]) && sizeof($paramForceFillersJenisTR[$comName][$this->jenisTr]) > 0) {
                                    foreach ($paramForceFillersJenisTR[$comName][$this->jenisTr] as $k => $v) {
                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                        cekorange(":: $k diisikan dengan " . $subParams['static'][$k]);
                                    }
                                }

                                $subParams['static']["fulldate"] = $fulldate;
                                $subParams['static']["dtime"] = $dtime;
                                $subParams['static']["keterangan"] = "";
                                $subParams['static']["transaksi_id"] = $tr_id;
                                $subParams['static']["transaksi_no"] = $tr_no;
                                $subParams['static']["jenis"] = $jenisTr;
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }

                        }
                    }
                    else {
                        //buang dari list array supaya diskip
                        unset($tmpOutParams[$cCtr]);
                    }

                }
//                arrPrintHijau($tmpOutParams);
//                mati_disini(__LINE__);
                if (count($tmpOutParams) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        echo "sub-postProcessor: $comName, sending values <br>";
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or mati_disini("Tidak berhasil memasang  values pada post-processor: $comName/");
                        $m->exec() or mati_disini("Gagal saat berusaha  exec values pada post-processor: $comName/");
                        cekBiru($this->db->last_query());
                    }
                }
                else {
                    cekHitam("tidak ada gerbang untuk dieksekusi");
                }
            }
            //endregion


        }


        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");

    }

    public function repairRekSerialNumber()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");


        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $csn = New ComRekeningPembantuProdukPerSerial();
        $jenisTr = "585";
        $tr->addFilter("jenis='$jenisTr'");
        $trTmp = $tr->lookupAll()->result();
        $regDatas = array();
        $trDatas = array();
        $trIDs = array();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $spec) {
                $trDatas[$spec->id] = $spec;
                $trIDs[$spec->id] = $spec->id;
            }
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
            $trReg = $tr->lookupDataRegistries()->result();
//            showLast_query("biru");
//            arrPrintKuning($trReg);
            foreach ($trReg as $regSpec) {
                $regDatas[$regSpec->transaksi_id] = array(
                    "items3_sum" => blobDecode($regSpec->items3_sum),
                );
            }
//            arrPrintKuning($regDatas);
            $ctr = 0;
            $ctrs = 0;
            foreach ($regDatas as $trID => $spec) {
                foreach ($spec["items3_sum"] as $subSpec) {
                    arrPrintKuning($subSpec);
                    $params = $subSpec;
                    $l = new ComRekeningPembantuProdukPerSerial();
                    $l->addFilter("extern_nama=" . $subSpec["produk_serial"]);
                    $l->addFilter("cabang_id=" . $subSpec["cabangID"]);
//                    $l->addFilter("cabang_id=" . $subSpec["cabang2ID"]);
                    $tmp = $l->lookupAll()->result();
                    if (sizeof($tmp) == 0) {
//                        showLast_query("biru");
//                        cekMerah("belum ada [$trID] " . $subSpec["produk_serial"]);
//                        $ctr++;
//                        $ctrs++;
                        $arrData[0] = array(
                            "loop" => array(
                                "1010030030" => "1",//persediaan produk, sub_diskon_nilai_total
                            ),
                            "static" => array(
                                "cabang_id" => $params["cabangID"],
                                "gudang_id" => $params["gudangID"],
                                "extern_id" => "0",
                                "extern_nama" => $params["produk_serial"],// nomer serial
                                "extern2_id" => "0",
                                "extern2_nama" => $params["produk_sku_part_nama"],// sku indoor, outdoor
                                "produk_id" => $params["id"],// produk id
                                "produk_nama" => $params["nama"],// produk nama
                                "produk_qty" => 1,
                                "produk_nilai" => 1,
                                "jenis" => isset($params["jenisTrMaster"]) ? $params["jenisTrMaster"] : "0000",
                                "transaksi_id" => $trDatas[$trID]->id,
                                "transaksi_no" => $trDatas[$trID]->nomer,
                                "supplierID" => $trDatas[$trID]->suppliers_id,
                                "dtime" => $trDatas[$trID]->dtime,
                                "fulldate" => $trDatas[$trID]->dtime,
                            ),
                        );
                        $arrDataa[0] = array(
                            "loop" => array(
                                "1010030030" => "-1",//persediaan produk, sub_diskon_nilai_total
                            ),
                            "static" => array(
                                "cabang_id" => $params["cabang2ID"],
                                "gudang_id" => $params["gudang2ID"],
                                "extern_id" => "0",
                                "extern_nama" => $params["produk_serial"],// nomer serial
                                "extern2_id" => "0",
                                "extern2_nama" => $params["produk_sku_part_nama"],// sku indoor, outdoor
                                "produk_id" => $params["id"],// produk id
                                "produk_nama" => $params["nama"],// produk nama
                                "produk_qty" => -1,
                                "produk_nilai" => -1,
                                "jenis" => isset($params["jenisTrMaster"]) ? $params["jenisTrMaster"] : "0000",
                                "transaksi_id" => $trDatas[$trID]->id,
                                "transaksi_no" => $trDatas[$trID]->nomer,
                                "supplierID" => $trDatas[$trID]->suppliers_id,
                                "dtime" => $trDatas[$trID]->dtime,
                                "fulldate" => $trDatas[$trID]->dtime,
                            ),
                        );
                        $l = new ComRekeningPembantuProdukPerSerial();
                        $l->pair($arrData);
                        $l->exec();

                        $l = new ComRekeningPembantuProdukPerSerial();
                        $l->pair($arrDataa);
                        $l->exec();

                    }
//                    arrPrintPink($arrData);
                }
            }


        }


        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");


    }


    public function cleansingData()
    {
        $this->load->model("Mdls/MdlModelIndoor_1");
        $this->load->model("Mdls/MdlModelOutdoor");
        $this->load->model("Mdls/MdlProdukPartUkuran");
        $this->load->model("Mdls/MdlProduk2");


        $this->db->trans_start();

        // region DATA INDOOR
        $indoorNamaKode = array();
        $indoorData = array();
        $indoorDatas = array();
        $pin = New MdlModelIndoor_1();
        $pinTmp = $pin->lookupAll()->result();
        foreach ($pinTmp as $pinSpec) {
            $sku = trim($pinSpec->sku);
            $nama = trim($pinSpec->nama);
            $indoorData[$pinSpec->id] = (array)$pinSpec;
            $indoorDatas[$sku][$nama][] = $pinSpec->id;
            $indoorNamaKode[$nama] = $sku;
        }
        foreach ($indoorDatas as $sku => $xx) {
            foreach ($xx as $nama => $idTbls) {
                if (sizeof($idTbls) > 1) {
//                    arrPrintKuning($idTbls);
                    $count = count($idTbls);
                    $count_min = $count - 1;
                    foreach ($idTbls as $key => $idTbl) {
                        if ($key < $count_min) {
                            $where = array(
                                "id" => $idTbl,
                            );
                            $data = array(
                                "trash" => 1
                            );
                            $pin = New MdlModelIndoor_1();
                            $pin->setFilters(array());
                            $pin->updateData($where, $data);
                            showLast_query("orange");
                        }
                    }

                }
            }
        }
        // endregion

        // region DATA OUTDOOR
        $outdoorNamaKode = array();
        $outdoorData = array();
        $indoorDatas = array();
        $pin = New MdlModelOutdoor();
        $pinTmp = $pin->lookupAll()->result();
        foreach ($pinTmp as $pinSpec) {
            $sku = trim($pinSpec->sku);
            $nama = trim($pinSpec->nama);
            $outdoorData[$pinSpec->id] = (array)$pinSpec;
            $indoorDatas[$sku][$nama][] = $pinSpec->id;
            $outdoorNamaKode[$nama] = $sku;
        }
        foreach ($indoorDatas as $sku => $xx) {
            foreach ($xx as $nama => $idTbls) {
                if (sizeof($idTbls) > 1) {
//                    arrPrintKuning($idTbls);
                    $count = count($idTbls);
                    $count_min = $count - 1;
                    foreach ($idTbls as $key => $idTbl) {
                        if ($key < $count_min) {
                            $where = array(
                                "id" => $idTbl,
                            );
                            $data = array(
                                "trash" => 1
                            );
                            $pin = New MdlModelOutdoor();
                            $pin->setFilters(array());
                            $pin->updateData($where, $data);
                            showLast_query("pink");
                        }
                    }

                }
            }
        }
        // endregion

        // region DATA UKURAN
        $ukuranDatas = array();
        $pin = New MdlProdukPartUkuran();
        $pinTmp = $pin->lookupAll()->result();
        foreach ($pinTmp as $pinSpec) {
            $nama = trim($pinSpec->nama);
            $ukuranDatas[$pinSpec->kategori_id][$nama][] = $pinSpec->id;
        }
        foreach ($ukuranDatas as $kategoriID => $xx) {
            foreach ($xx as $nama => $idTbls) {
                if (sizeof($idTbls) > 1) {
//                    arrPrintKuning($idTbls);
                    $count = count($idTbls);
                    $count_min = $count - 1;
                    foreach ($idTbls as $key => $idTbl) {
                        if ($key < $count_min) {
                            $where = array(
                                "id" => $idTbl,
                            );
                            $data = array(
                                "trash" => 1
                            );
                            $pin = New MdlProdukPartUkuran();
                            $pin->setFilters(array());
                            $pin->updateData($where, $data);
                            showLast_query("pink");
                        }
                    }

                }
            }
        }
        // endregion

        $pakai_ini = 1;
        if ($pakai_ini == 1) {

            // region DATA PRODUK UNIT
            $produkDataUnit = array();
            $produkDatas = array();
            $p = New MdlProduk2();
            $p->addFilter("kategori_id='1'");
            $pTmp = $p->lookupAll()->result();
//        showLast_query("biru");
//        mati_disini(__LINE__);
            foreach ($pTmp as $pSpec) {
                $kode = trim($pSpec->kode);
                $nama = trim($pSpec->nama);
                $produkDataUnit[$pSpec->id] = $pSpec;
                $produkDatas[$kode][$nama][] = $pSpec->id;
            }
            foreach ($produkDatas as $kode => $xx) {
                foreach ($xx as $nama => $idTbls) {
                    if (sizeof($idTbls) > 1) {
//                    arrPrintKuning($idTbls);
                        $count = count($idTbls);
                        $count_min = $count - 1;
                        foreach ($idTbls as $key => $idTbl) {
                            if ($key < $count_min) {
                                $where = array(
                                    "id" => $idTbl,
                                );
                                $data = array(
                                    "trash" => 1
                                );
                                $pin = New MdlProduk2();
                                $pin->setFilters(array());
                                $pin->updateData($where, $data);
                                showLast_query("orange");
                            }
                        }
                    }
                }
            }
            // endregion

            // region DATA PRODUK NON UNIT
            $produkDataNonUnit = array();
            $produkDatas = array();
            $p = New MdlProduk2();
            $p->addFilter("kategori_id='3'");
            $pTmp = $p->lookupAll()->result();
            foreach ($pTmp as $pSpec) {
                $kode = trim($pSpec->kode);
                $nama = trim($pSpec->nama);
                $produkDataNonUnit[$pSpec->id] = $pSpec;
                $produkDatas[$kode][$nama][] = $pSpec->id;
            }
            foreach ($produkDatas as $kode => $xx) {
                foreach ($xx as $nama => $idTbls) {
                    if (sizeof($idTbls) > 1) {
                        $count = count($idTbls);
                        $count_min = $count - 1;
                        foreach ($idTbls as $key => $idTbl) {
                            if ($key < $count_min) {
                                $where = array(
                                    "id" => $idTbl,
                                );
                                $data = array(
                                    "trash" => 1
                                );
                                $pin = New MdlProduk2();
                                $pin->setFilters(array());
                                $pin->updateData($where, $data);
                                showLast_query("orange");
                            }
                        }
                    }
                }
            }
            // endregion
        }

        $pakai_ini = 0;// tabel produk_ex
        if ($pakai_ini == 1) {
            // region DATA PRODUK UNIT EVEREST
            $produkDatas = array();
            $p = New MdlProduk2();
            $p->setTableName("produk_ex");
            $p->addFilter("kategori_id='1'");
            $pTmp = $p->lookupAll()->result();
//        showLast_query("biru");
//        mati_disini(__LINE__);
            foreach ($pTmp as $pSpec) {
                $kode = trim($pSpec->kode);
                $nama = trim($pSpec->nama);
                $produkDatas[$kode][$nama][] = $pSpec->id;
            }
            foreach ($produkDatas as $kode => $xx) {
                foreach ($xx as $nama => $idTbls) {
                    if (sizeof($idTbls) > 1) {
//                    arrPrintKuning($idTbls);
                        $count = count($idTbls);
                        $count_min = $count - 1;
                        foreach ($idTbls as $key => $idTbl) {
                            if ($key < $count_min) {
                                $where = array(
                                    "id" => $idTbl,
                                );
                                $data = array(
                                    "trash" => 1
                                );
//                            $pin = New MdlProduk2();
//                            $pin->setTableName("produk_ex");
                                $p->setFilters(array());
                                $p->updateData($where, $data);
                                showLast_query("orange");
                            }
                        }
                    }
                }
            }
            // endregion

            // region DATA PRODUK NON UNIT EVEREST
            $produkDataNonUnit = array();
            $produkDatas = array();
            $p = New MdlProduk2();
            $p->setTableName("produk_ex");
            $p->addFilter("kategori_id='3'");
            $pTmp = $p->lookupAll()->result();
            foreach ($pTmp as $pSpec) {
                $kode = trim($pSpec->kode);
                $nama = trim($pSpec->nama);
                $produkDataNonUnit[$pSpec->id] = $pSpec;
                $produkDatas[$kode][$nama][] = $pSpec->id;
            }
            foreach ($produkDatas as $kode => $xx) {
                foreach ($xx as $nama => $idTbls) {
                    if (sizeof($idTbls) > 1) {
                        $count = count($idTbls);
                        $count_min = $count - 1;
                        foreach ($idTbls as $key => $idTbl) {
                            if ($key < $count_min) {
                                $where = array(
                                    "id" => $idTbl,
                                );
                                $data = array(
                                    "trash" => 1
                                );
//                            $pin = New MdlProduk2();
                                $p->setFilters(array());
                                $p->updateData($where, $data);
                                showLast_query("orange");
                            }
                        }
                    }
                }
            }
            // endregion
        }

        //-----------------------------------------------------
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $indoorData = array();
            $outdoorData = array();
            $pin = New MdlModelIndoor_1();
            $pin->setFilters(array());
            $pinTmp = $pin->lookupAll()->result();
            foreach ($pinTmp as $pinSpec) {
                $indoorData[$pinSpec->id] = (array)$pinSpec;
            }
            $pin = New MdlModelOutdoor();
            $pin->setFilters(array());
            $pinTmp = $pin->lookupAll()->result();
            foreach ($pinTmp as $pinSpec) {
                $outdoorData[$pinSpec->id] = (array)$pinSpec;
            }

            foreach ($produkDataUnit as $pID => $pSpec) {
                $outdoorID = $pSpec->outdoor_id;
                $indoorID_1 = $pSpec->indoor_id_1;
                $indoorID_2 = $pSpec->indoor_id_2;
                $indoorID_3 = $pSpec->indoor_id_3;
                $indoorID_4 = $pSpec->indoor_id_4;
                $outdoorBarcode = isset($outdoorData[$outdoorID]["barcode"]) ? $outdoorData[$outdoorID]["barcode"] : "";
                $indoorBarcode_1 = isset($indoorData[$indoorID_1]["barcode"]) ? $indoorData[$indoorID_1]["barcode"] : "";
                $indoorBarcode_2 = isset($indoorData[$indoorID_2]["barcode"]) ? $indoorData[$indoorID_2]["barcode"] : "";
                $indoorBarcode_3 = isset($indoorData[$indoorID_3]["barcode"]) ? $indoorData[$indoorID_3]["barcode"] : "";
                $indoorBarcode_4 = isset($indoorData[$indoorID_4]["barcode"]) ? $indoorData[$indoorID_4]["barcode"] : "";
                $outdoorSku = isset($outdoorData[$outdoorID]["sku"]) ? $outdoorData[$outdoorID]["sku"] : "";
                $indoorSku_1 = isset($indoorData[$indoorID_1]["sku"]) ? $indoorData[$indoorID_1]["sku"] : "";
                $indoorSku_2 = isset($indoorData[$indoorID_2]["sku"]) ? $indoorData[$indoorID_2]["sku"] : "";
                $indoorSku_3 = isset($indoorData[$indoorID_3]["sku"]) ? $indoorData[$indoorID_3]["sku"] : "";
                $indoorSku_4 = isset($indoorData[$indoorID_4]["sku"]) ? $indoorData[$indoorID_4]["sku"] : "";
//            cekHere("outdoor: [$pID] [$outdoorBarcode] [$outdoorSku]");
//            cekHere("indoor 1: [$pID] [$indoorBarcode_1] [$indoorSku_1]");
//            cekHere("indoor 2: [$pID] [$indoorBarcode_2] [$indoorSku_2]");
//            cekHere("indoor 3: [$pID] [$indoorBarcode_3] [$indoorSku_3]");
//            cekHere("indoor 4: [$pID] [$indoorBarcode_4] [$indoorSku_4]");

                $where = array(
                    "id" => "$pID",
                );
                $data = array(
                    "outdoor_barcode" => "$outdoorBarcode",
                    "indoor_barcode_1" => "$indoorBarcode_1",
                    "indoor_barcode_2" => "$indoorBarcode_2",
                    "indoor_barcode_3" => "$indoorBarcode_3",
                    "indoor_barcode_4" => "$indoorBarcode_4",
                    "outdoor_sku" => "$outdoorSku",
                    "indoor_sku_1" => "$indoorSku_1",
                    "indoor_sku_2" => "$indoorSku_2",
                    "indoor_sku_3" => "$indoorSku_3",
                    "indoor_sku_4" => "$indoorSku_4",
                );
                $p = New MdlProduk2();
                $p->updateData($where, $data);
                showLast_query("orange");
            }
        }
        //-----------------------------------------------------

        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            $p = New MdlProduk2();
            $p->addFilter("kategori_id='3'");
            $pTmp = $p->lookupAll()->result();
            foreach ($pTmp as $pSpec) {
                $id_tbl = $pSpec->id;
                $nama = trim($pSpec->nama);
                $where = array(
                    "id" => $id_tbl,
                );
                if (isset($indoorNamaKode[$nama]) && ($indoorNamaKode[$nama] != null)) {
                    $data = array(
                        "kode" => $indoorNamaKode[$nama],
                    );
                    $p->setFilters(array());
                    $p->updateData($where, $data);
                    showLast_query("orange");
                }
                elseif (isset($outdoorNamaKode[$nama]) && ($outdoorNamaKode[$nama] != null)) {
                    $data = array(
                        "kode" => $outdoorNamaKode[$nama],
                    );
                    $p->setFilters(array());
                    $p->updateData($where, $data);
                    showLast_query("orange");
                }
            }
        }


//        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");


    }

    public function updateSerial()
    {
        $this->load->model("Mdls/MdlModelOutdoor");
        $this->load->model("Mdls/MdlModelIndoor_1");
        $this->load->model("Mdls/MdlProdukPerSerialNumber");
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");


        $this->db->trans_start();


        $psn = New MdlModelOutdoor();
        $psn->setFilters(array());
        $psnTmp = $psn->lookupAll()->result();
        foreach ($psnTmp as $psnSpec) {
            $skuOutdoor[$psnSpec->sku] = $psnSpec->sku;
        }

        $psn = New MdlModelIndoor_1();
        $psn->setFilters(array());
        $psnTmp = $psn->lookupAll()->result();
        foreach ($psnTmp as $psnSpec) {
            $skuIndoor[$psnSpec->sku] = $psnSpec->sku;
        }

        $psn = New MdlProdukPerSerialNumber();
        $psn->setFilters(array());
        $psn->addFilter("id>='331'");
        $psnTmp = $psn->lookupAll()->result();
        foreach ($psnTmp as $psnSpec) {
            $id = $psnSpec->id;
            $sku = $psnSpec->produk_sku;
            $serial = $psnSpec->produk_serial_number_2;
            if (isset($skuOutdoor[$sku])) {
                $keterangan = "OT";
            }
            elseif (isset($skuIndoor[$sku])) {
                $keterangan = "IN";
            }
            else {
                $keterangan = "";
            }
            $serial_new = $serial . $keterangan;

            $data = array(
                "produk_serial_number_2" => $serial_new,
                "produk_sku_label" => $keterangan,
            );
            $where = array(
                "id" => $id
            );
            $psn = New MdlProdukPerSerialNumber();
            $psn->setFilters(array());
            $psn->updateData($where, $data);
            showLast_query("orange");

            $cps = New ComRekeningPembantuProdukPerSerial();
            $cps->setFilters(array());
            $cps->addFilter("extern_nama=$serial");
            $cpsTmp = $cps->lookupAll()->result();
            if (sizeof($cpsTmp) > 0) {
                foreach ($cpsTmp as $cpsSpec) {
                    $rek_id = $cpsSpec->id;
                    $data = array(
                        "extern_nama" => $serial_new
                    );
                    $where = array(
                        "id" => $rek_id
                    );
                    $cps->setFilters(array());
                    $cps->updateData($where, $data);
                    showLast_query("hitam");
                }
            }
        }


        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");


    }


    //-------------------------------------------
    public function generateSerialNumberNonUnitPindahbuku()
    {
        $this->load->model("Mdls/MdlTransaksiPemindahbukuan");
        $this->load->model("Mdls/MdlProduk2");
        $this->load->model("Coms/ComProdukSerialNumber");
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");


        $jenisTr = "7778";
        $jenisStepCode = "7778";
//        $trID = "15";
        $extern_id = "1310";
        $p_head_code = "1010030030";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $id_top = "217";
        $nomer_top = "";
        $transaksi_id = "217";
        $nomer_current = "";
        $cabang_id = "-1";
        $gudang_id = "-1";

        $pd = New MdlProduk2();
        $tr = New MdlTransaksiPemindahbukuan();
//        $tr->addFilter("extern_id='$extern_id'");
        $tr->addFilter("status='1'");
        $tr->addFilter("p_head_code='$p_head_code'");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        $items = array();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $iid = $trSpec->extern_id;
                $jml = $trSpec->qty;
                $oleh_id = $trSpec->oleh_id;
                $oleh_nama = $trSpec->oleh_nama;

                $pd->setFilters(array());
                $pd->addFilter("id='$iid'");
                $pdTmp = $pd->lookupAll()->result();
                $produk_kode = $pdTmp[0]->kode;
                $produk_nama = $pdTmp[0]->nama;
                $supplier_id = $pdTmp[0]->supplier_id;
                $supplier_nama = $pdTmp[0]->supplier_nama;

                for ($i = 1; $i <= $jml; $i++) {
//                    $itemFlip = array_flip($items[$spec["id"]]);
//                    $key_data_arr = explode("_", $itemFlip[$spec["produk_sku_part_nama"]]);
//                    switch ($key_data_arr[0]) {
//                        case "outdoor":
//                            $part_kode = "OT";
//                            break;
//                        case "indoor":
//                            $part_kode = "IN";
//                            break;
//                        default:
//                            $part_kode = "";
//                            break;
//                    }
                    $part_kode = "PART";
                    $data[] = array(
                        "static" => array(
                            "cabang_id" => $cabang_id,
                            "jumlah" => 1,
                            "produk_id" => $iid,
                            "produk_nama" => $produk_nama,
                            "produk_serial_number" => "",
                            "produk_sku" => $produk_kode,
                            "produk_sku_serial" => "",
                            "produk_sku_part_id" => "",
                            "produk_sku_part_nama" => $produk_kode,
                            "produk_sku_part_serial" => "",
                            "oleh_id" => $oleh_id,
                            "oleh_nama" => $oleh_nama,
                            "supplier_id" => $supplier_id,
                            "supplier_nama" => $supplier_nama,
                            "gudang_id" => $gudang_id,
                            "jenis" => $jenisTr,
                            //---------------
                            "transaksi_reference_id" => $id_top,
                            "transaksi_reference_no" => $nomer_top,
                            "transaksi_reference_dtime" => $dtime,
                            "transaksi_reference_fulldate" => $fulldate,
                            "transaksi_reference_count" => 1,
                            "transaksi_count" => 1,
                            "transaksi_jenis_count" => 1,
                            "part_keterangan" => $part_kode,
                            "transaksi_id" => $transaksi_id,
                            "transaksi_no" => $nomer_current,
                            "dtime" => $dtime,
                            "fulldate" => $fulldate,
                        ),
                    );
                }
//                break;
            }
        }


        if (sizeof($data) > 0) {


            $this->db->trans_start();


            $cm = New ComProdukSerialNumber();
            $cm->pair($data);
            $cm->exec();

            mati_disini(__LINE__);
            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

            cekHijau("<h3>...DONE...</h3>");

        }
        else {
            cekMerah("KOSONG...");
        }


    }

    //-------------------------------------------
    public function generateSerialNumberUnitPindahbuku()
    {
        $this->load->model("Mdls/MdlTransaksiPemindahbukuan");
        $this->load->model("Mdls/MdlProduk2");
        $this->load->model("Coms/ComProdukSerialNumber");
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");


        $jenisTr = "7778";
        $jenisStepCode = "7778";
//        $trID = "15";
        $extern_id = "1310";
        $p_head_code = "1010030030";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $id_top = "259";
        $nomer_top = "";
        $transaksi_id = "259";
        $nomer_current = "";
        $cabang_id = "1";
        $gudang_id = "-10";

        $pd = New MdlProduk2();
        $tr = New MdlTransaksiPemindahbukuan();
//        $tr->addFilter("extern_id='$extern_id'");
        $tr->addFilter("status='1'");
        $tr->addFilter("p_head_code='$p_head_code'");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        $items = array();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $iid = $trSpec->extern_id;
                $jml = $trSpec->qty;
                $oleh_id = $trSpec->oleh_id;
                $oleh_nama = $trSpec->oleh_nama;
                cekHitam("PID: $iid, jml: $jml");
                $pd->setFilters(array());
                $pd->addFilter("id='$iid'");
                $pdTmp = $pd->lookupAll()->result();
                $produk_kode = $pdTmp[0]->kode;
                $produk_nama = $pdTmp[0]->nama;
                $supplier_id = $pdTmp[0]->supplier_id;
                $supplier_nama = $pdTmp[0]->supplier_nama;
                $kategori_id = $pdTmp[0]->kategori_id;
                $kategori_nama = $pdTmp[0]->kategori_nama;
                $outdoor_sku = $pdTmp[0]->outdoor_sku;
                $indoor_sku_1 = $pdTmp[0]->indoor_sku_1;
                $indoor_sku_2 = $pdTmp[0]->indoor_sku_2;
                $indoor_sku_3 = $pdTmp[0]->indoor_sku_3;
                $indoor_sku_4 = $pdTmp[0]->indoor_sku_4;
                $outdoor_sku_label = $pdTmp[0]->outdoor_sku_label;
                $indoor_sku_1_label = $pdTmp[0]->indoor_sku_1_label;
                $indoor_sku_2_label = $pdTmp[0]->indoor_sku_2_label;
                $indoor_sku_3_label = $pdTmp[0]->indoor_sku_3_label;
                $indoor_sku_4_label = $pdTmp[0]->indoor_sku_4_label;
                $produk_part_nama_1 = $pdTmp[0]->produk_part_nama_1;
                $produk_part_nama_2 = $pdTmp[0]->produk_part_nama_2;
                $produk_part_nama_3 = $pdTmp[0]->produk_part_nama_3;
                if (($outdoor_sku == NULL) && ($indoor_sku_1 == NULL) && ($indoor_sku_2 == NULL) && ($indoor_sku_3 == NULL) && ($indoor_sku_4 == NULL)) {
                    mati_disini("sku outdoor dan indoor kosong boss... perlu dipatch dulu...");
                }
                else {
                    cekHijau("LANJUTKAN...");
                }


                for ($i = 1; $i <= $jml; $i++) {
                    if ($outdoor_sku != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $outdoor_sku,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $outdoor_sku,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "OT",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                    if ($indoor_sku_1 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $indoor_sku_1,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $indoor_sku_1,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "IN",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                    if ($indoor_sku_2 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $indoor_sku_2,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $indoor_sku_2,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "IN",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                    if ($indoor_sku_3 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $indoor_sku_3,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $indoor_sku_3,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "IN",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                    if ($indoor_sku_4 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $indoor_sku_4,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $indoor_sku_4,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "IN",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }

                    if ($produk_part_nama_1 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $produk_part_nama_1,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $produk_part_nama_1,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "P1",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                    if ($produk_part_nama_2 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $produk_part_nama_2,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $produk_part_nama_2,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "P2",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                    if ($produk_part_nama_3 != NULL) {
                        $data[] = array(
                            "static" => array(
                                "cabang_id" => $cabang_id,
                                "jumlah" => 1,
                                "produk_id" => $iid,
                                "produk_nama" => $produk_nama,
                                "produk_serial_number" => "",
                                "produk_sku" => $produk_part_nama_3,
                                "produk_sku_serial" => "",
                                "produk_sku_part_id" => "",
                                "produk_sku_part_nama" => $produk_part_nama_3,
                                "produk_sku_part_serial" => "",
                                "oleh_id" => $oleh_id,
                                "oleh_nama" => $oleh_nama,
                                "supplier_id" => $supplier_id,
                                "supplier_nama" => $supplier_nama,
                                "gudang_id" => $gudang_id,
                                "jenis" => $jenisTr,
                                //---------------
                                "transaksi_reference_id" => $id_top,
                                "transaksi_reference_no" => $nomer_top,
                                "transaksi_reference_dtime" => $dtime,
                                "transaksi_reference_fulldate" => $fulldate,
                                "transaksi_reference_count" => 2,
                                "transaksi_count" => 2,
                                "transaksi_jenis_count" => 2,
                                "part_keterangan" => "P3",
                                "transaksi_id" => $transaksi_id,
                                "transaksi_no" => $nomer_current,
                                "dtime" => $dtime,
                                "fulldate" => $fulldate,
                            ),
                        );
                    }
                }
//                break;
            }
        }


        if (sizeof($data) > 0) {


            $this->db->trans_start();


            $cm = New ComProdukSerialNumber();
            $cm->pair($data);
            $cm->exec();

            mati_disini(__LINE__);
            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

            cekHijau("<h3>...DONE...</h3>");

        }
        else {
            cekMerah("KOSONG...");
        }


    }

    //-------------------------------------------
    public function generatePaymentSource()
    {
        $this->load->model("Mdls/MdlTransaksiPemindahbukuan");
        $this->load->model("MdlTransaksi");

        $tr = New MdlTransaksi();

        // ambil saldo hutang dagang per-supplier
        $target_jenis_hd = "489";
        $rekening = "2010010";
        $cabang_id = "-1";
        $cabang_nama = "pusat";
        $pymsrc = New MdlTransaksiPemindahbukuan();
        $pymsrc->addFilter("p_head_code='$rekening'");
        $pymTmpHd = $pymsrc->lookupAll()->result();
        showLast_query("biru");

        // ambil saldo piutang dagang per-konsumen
        $target_jenis_pd = "749";
        $rekening = "1010020010";
        $cabang_id = "-1";
        $pymsrc = New MdlTransaksiPemindahbukuan();
        $pymsrc->addFilter("p_head_code='$rekening'");
        $pymTmpPd = $pymsrc->lookupAll()->result();
        showLast_query("biru");


        $this->db->trans_start();


        $pakai_ini = 1;
        // input PYM SRC HUTANG DAGANG
        if ($pakai_ini == 1) {
            if (sizeof($pymTmpHd) > 0) {
                $arrSupplierData = array();
                foreach ($pymTmpHd as $hdSpec) {
                    $supplier_id = $hdSpec->extern_id;
                    $supplier_nama = $hdSpec->sub_rekening;
//                    $cabang_id = $hdSpec->cabang_id;
//                    $cabang_nama = $hdSpec->cabang_nama;
                    $kredit = $hdSpec->kredit;
                    $dtime = $hdSpec->dtime;
                    $fulldate = $hdSpec->dtime;

                    $arrSupplierData[$supplier_id] = array(
                        "target_jenis" => $target_jenis_hd,
                        "extern_id" => $supplier_id,
                        "extern_nama" => $supplier_nama,
                        "transaksi_id" => "",
                        "nomer" => "pemindahbukuan",
                        "nomer_top" => "pemindahbukuan",
                        "label" => "hutang dagang",
                        "tagihan" => $kredit,
                        "sisa" => $kredit,
                        "cabang_id" => $cabang_id,
                        "cabang_nama" => $cabang_nama,
                        "dtime" => $dtime,
                        "fulldate" => $fulldate,
                    );
                }
                $tbl = $tr->getTableNames()["paymentSrc"];
                $tr->setTableName($tbl);
                foreach ($arrSupplierData as $spid => $spData) {
                    $tr->setFilters(array());
                    $tr->addData($spData);
                    showLast_query("hijau");
                }
            }
        }

        $pakai_ini = 0;
        // input PYM SRC HUTANG DAGANG
        if ($pakai_ini == 1) {
            if (sizeof($pymTmpPd) > 0) {
                $arrCustomerData = array();
                foreach ($pymTmpPd as $pdSpec) {
                    $customer_id = $pdSpec->extern_id;
                    $customer_nama = $pdSpec->sub_rekening;
//                    $cabang_id = $pdSpec->cabang_id;
//                    $cabang_nama = $pdSpec->cabang_nama;
                    $debet = $pdSpec->debet;
                    $dtime = $pdSpec->dtime;
                    $fulldate = $pdSpec->dtime;

                    $arrCustomerData[$supplier_id] = array(
                        "target_jenis" => $target_jenis_hd,
                        "extern_id" => $customer_id,
                        "extern_nama" => $customer_nama,
                        "transaksi_id" => "",
                        "nomer" => "pemindahbukuan",
                        "nomer_top" => "pemindahbukuan",
                        "label" => "piutang dagang",
                        "tagihan" => $debet,
                        "sisa" => $debet,
                        "cabang_id" => $cabang_id,
                        "cabang_nama" => $cabang_nama,
                        "dtime" => $dtime,
                        "fulldate" => $fulldate,
                    );
                }
                $tbl = $tr->getTableNames()["paymentSrc"];
                $tr->setTableName($tbl);
                foreach ($arrCustomerData as $spid => $spData) {
                    $tr->setFilters(array());
                    $tr->addData($spData);
                    showLast_query("hijau");
                }
            }
        }


//        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");

    }

    //-------------------------------------------
    public function preEntryEfakturPpnOut()
    {
        header("refresh:2");

        $this->load->model("MdlTransaksi");
        $gudang_status_id = "12";
        $jenisTr = "5822spd";
        $jenisTrMaster = "5822";
        $pemindahan = "0";
        $tgl_cek = "2024-01-15";

        $tr = New MdlTransaksi();
        $tr->addFilter("gudang_status_id='$gudang_status_id'");
        $tr->addFilter("pemindahan='$pemindahan'");
        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("date(dtime)<='$tgl_cek'");
//        $this->db->limit(1);
        $this->db->order_by("id", "asc");
        $trTmp = $tr->lookupAll()->result();
        cekMerah("total data: " . count($trTmp));


        $tr = New MdlTransaksi();
        $tr->addFilter("gudang_status_id='$gudang_status_id'");
        $tr->addFilter("pemindahan='$pemindahan'");
        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("date(dtime)<='$tgl_cek'");
        $this->db->limit(1);
        $this->db->order_by("id", "asc");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
//            arrPrint($trTmp[0]);
            $trID_selected = $trID = $id_current = $trTmp[0]->id;
            $nomer_current = $trTmp[0]->nomer;
            $id_top = $trTmp[0]->id_top;
            $nomer_top = $trTmp[0]->nomer_top;
            $dtime = $trTmp[0]->dtime;
            $fulldate = $trTmp[0]->fulldate;
            $cabang_id = $trTmp[0]->cabang_id;
            $gudang_id = $trTmp[0]->gudang_id;
            $this->jenisTr = $trTmp[0]->jenis_master;
            $masterID = $trTmp[0]->id_master;
            $topID = $trTmp[0]->id_top;
            $tmpNomorNota = $trTmp[0]->nomer;
            $origJenis = $trTmp[0]->jenis_master;
            $pengirimID = $trTmp[0]->pengirim_id;
            $pengirimName = $trTmp[0]->pengirim_nama;
            $olehID = $trTmp[0]->oleh_id;
            $olehName = $trTmp[0]->oleh_nama;
            //--------------------------------
            $gudangStatusJenis = $trTmp[0]->gudang_status_jenis;
            $cabangTujuanID = $trTmp[0]->cabang_id;
            $ids_his_decode = blobDecode($trTmp[0]->ids_his);
            $count_master = 0;
            $count_master2 = 0;
            foreach ($ids_his_decode as $step => $spec) {
                if ($step == 1) {
                    $counter_decode = blobDecode($spec["counters"]);
                    foreach ($counter_decode["stepCode"] as $kk => $vv) {
                        $count_master = $vv;
                    }
                }
                if ($step == 2) {
                    $counter_decode2 = blobDecode($spec["counters"]);
                    foreach ($counter_decode2["stepCode"] as $kk2 => $vv2) {
                        $count_master2 = $vv2;
                    }
                }
            }

            $cCode = "_TR_" . $this->jenisTr;
            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }
            $configUiMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiUi");
            $configCoreMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiCore");
            $configLayoutMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiLayout");
            $configValuesMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiValues");

            $configUiMasterModulOrigJenis = loadConfigModulJenis_he_misc($origJenis, "coTransaksiUi");
            $configCoreMasterModulOrigJenis = loadConfigModulJenis_he_misc($origJenis, "coTransaksiCore");
            $configLayoutMasterModulOrigJenis = loadConfigModulJenis_he_misc($origJenis, "coTransaksiLayout");

            //region take from registries
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id='$trID'");
            $tmpReg = $trr->lookupDataRegistries()->result();
            cekKuning($this->db->last_query());
            $main = array();
            $items = array();
            $items2 = array();
            $items2_sum = array();
            $items3 = array();
            $items3_sum = array();
            $items4_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();
            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();
            $mainInputs = array();
            $itemsKomposisi = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    foreach ($row as $key_reg => $val_reg) {
                        switch ($key_reg) {
                            case "main"://
                                $main = $main + unserialize(base64_decode($val_reg));
                                break;
                            case "items"://
                                $items = $items + unserialize(base64_decode($val_reg));
                                break;
                            case "items2"://
                                $items2 = $items2 + unserialize(base64_decode($val_reg));
                                break;
                            case "rsltItems"://
                                $rsltItems = $rsltItems + unserialize(base64_decode($val_reg));
                                break;
                            case "rsltItems2"://
                                $rsltItems2 = $rsltItems2 + unserialize(base64_decode($val_reg));
                                break;
                            case "items2_sum"://
                                $items2_sum = $items2_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items3"://
                                $items3 = $items3 + unserialize(base64_decode($val_reg));
                                break;
                            case "items3_sum"://
                                $items3_sum = $items3_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items4_sum"://
                                $items4_sum = $items4_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_master"://
                                $masterTableInParams = $masterTableInParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail"://
                                $childTableInParams = $childTableInParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_rsltItems"://
                                $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_rsltItems2"://
                                $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_master_values"://
                                $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_values"://
                                $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_values_rsltItems"://
                                $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_values_rsltItems2"://
                                $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($val_reg));
                                break;
                            case "main_add_values"://
                                $masterAddValues = $masterAddValues + unserialize(base64_decode($val_reg));
                                break;
                            case "main_add_fields"://
                                $masterAddFields = $masterAddFields + unserialize(base64_decode($val_reg));
                                break;
                            case "main_elements"://
                                $mainElements = unserialize(base64_decode($val_reg));
                                break;
                            case "main_inputs"://
                                $mainInputs = unserialize(base64_decode($val_reg));
                                break;
                            case "items_komposisi"://
                                $itemsKomposisi = unserialize(base64_decode($val_reg));
                                break;
                        }
                    }
                }

            }
            else {
                mati_disini("Cannot read the registry entries from $masterID!");
            }
            //endregion

            $masterReplacers = array(
                "jenisTrMaster" => $this->jenisTr,
                "jenisTrTop" => $masterTableInParams['jenis_top'],
                "harga" => 0,
                "masterID" => $masterID,
            );
            foreach ($masterReplacers as $key => $src) {
                $main[$key] = $src;
                $mainValues[$key] = $src;
                $masterGates[$key] = $src;
            }

            //region session-swapper
            $main["pengirimID"] = $pengirimID;
            $main["pengirimName"] = $pengirimName;
            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "items3" => $items3,
                "items3_sum" => $items3_sum,
                "items4_sum" => $items4_sum,
                "items_child" => isset($itemChildData) ? $itemChildData : array(),
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => isset($extractedItems) ? $extractedItems : array(),
                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                "main_add_fields" => $masterAddFields,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                "extSteps" => isset($extSteps) ? $extSteps : array(),
                "paySrcs" => isset($paySrcs) ? $paySrcs : array(),
                "lockerPayment" => isset($tempBtnUndo) ? $tempBtnUndo : array(),
                "items_komposisi" => $itemsKomposisi,
            );
            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;

            }
            //endregion

            $stepNum = 4;
            $stepNumCurrent = 3;
            $this->load->helper("he_value_builder");
//            resetValues($this->jenisTr);
            fillValues_he_value_builder($this->jenisTr, $stepNumCurrent, $stepNum, $configCoreMasterModulJenis, $configUiMasterModulJenis, $configValuesMasterModulJenis, my_ppn_factor());

//            arrPrintHijau($_SESSION[$cCode]);


            $this->db->trans_start();


            $stepNum = 4;
//            mati_disini(__LINE__);

            //region connecting antar cabang
            $configUiMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiUi");
            $configCoreMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiCore");
            $configLayoutMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiLayout");
            $configValuesMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiValues");

            $configUiMasterModulOrigJenis = loadConfigModulJenis_he_misc($origJenis, "coTransaksiUi");
            $configCoreMasterModulOrigJenis = loadConfigModulJenis_he_misc($origJenis, "coTransaksiCore");
            $configLayoutMasterModulOrigJenis = loadConfigModulJenis_he_misc($origJenis, "coTransaksiLayout");

            $steps = isset($configUiMasterModulOrigJenis['steps']) ? $configUiMasterModulOrigJenis['steps'] : array();
            $connector = isset($configUiMasterModulOrigJenis['connectTo']) ? $configUiMasterModulOrigJenis['connectTo'] : "";
            $preReplacer = isset($configUiMasterModulJenis['replacerConnectTo']) ? $configUiMasterModulJenis['replacerConnectTo'] : array();
            $validateValueConnector = isset($configUiMasterModulJenis['connectoValidate'][$stepNum]) ? $configUiMasterModulJenis['connectoValidate'][$stepNum] : array();
//arrPrintWebs($configUiMasterModulOrigJenis);
//            mati_disini(__LINE__ . " :: $connector :: ");
            $mongoListConnect = array();
            $mongRegIDConnect = array();
            $insertConnectingID = 0;
            if (strlen($connector) > 0) {
                cekMerah("TO BE CONNECT TO $connector |$stepNum|" . sizeof($steps));
                if (isset($configUiMasterModulJenis['connectoValidate'][$stepNum])) {
                    $validateValueConnector = $configUiMasterModulJenis['connectoValidate'][$stepNum];
                    $preVal = $_SESSION[$cCode]['main'][$validateValueConnector];
                    $stepNum = $preVal > 0 ? $stepNum : "1000";//1000 untuk nglewatin step biar gak jalan connectingnya karena nilai yang dicari 0 kasusnya cash in advance ppn sudah masuk pusat tidak perlu diterbitkan auto dorong ppn ke pusat
                }
                if ($stepNum == sizeof($steps)) {
                    cekMerah("NOW CONNECTING to $connector");

                    $configUiMasterModulJenis = loadConfigModulJenis_he_misc($connector, "coTransaksiUi");
                    $configCoreMasterModulJenis = loadConfigModulJenis_he_misc($connector, "coTransaksiCore");
                    $configLayoutMasterModulJenis = loadConfigModulJenis_he_misc($connector, "coTransaksiLayout");
                    $configValuesMasterModulJenis = loadConfigModulJenis_he_misc($connector, "coTransaksiValues");

//arrPrintKuning($configUiMasterModulJenis);
//                    if (!array_key_exists($connector, $this->configUi)) {
                    if (sizeof($configUiMasterModulJenis) == 0) {
                        mati_disini("kode connector tidak dikenali!");
                    }
                    if (sizeof($configUiMasterModulJenis['steps']) < 2) {
                        mati_disini("konfigurasi connector harus memiliki step lebih dari satu!");
                    }


                    $oldCode = $cCode;
                    $cCode = "_TR_" . $connector;

                    $_SESSION[$cCode] = array();
                    $_SESSION[$cCode] = array(
                        "main" => $_SESSION[$oldCode]['main'],
                        "items" => $_SESSION[$oldCode]['items'],
                        "items2" => $_SESSION[$oldCode]['items2'],
                        "items2_sum" => $_SESSION[$oldCode]['items2_sum'],
                        "items3" => $_SESSION[$oldCode]['items3'],
                        "items3_sum" => $_SESSION[$oldCode]['items3_sum'],
                        "items4_sum" => $_SESSION[$oldCode]['items4_sum'],
                        "items_noapprove" => $_SESSION[$oldCode]['items_noapprove'],
                        "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                        "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                        "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                        "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                        "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                        "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                        "tableIn_detail_values_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'],
                    );

                    //==replace pertama
                    $masterReplacersO = array(
                        "jenisTr" => $connector,
                        "jenisTrMaster" => $connector,
                        "jenisTrTop" => $configUiMasterModulJenis['steps'][1]['target'],
                        "jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                        "jenis_label" => $configUiMasterModulJenis['steps'][1]['label'],
                        "transaksi_jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                        "stepCode" => $configUiMasterModulJenis['steps'][1]['target'],
                        "placeID" => isset($preReplacer['place2ID']) ? $preReplacer['place2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                        "placeName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                        "place2ID" => $_SESSION[$cCode]['main']['placeID'],
                        "place2Name" => $_SESSION[$cCode]['main']['placeName'],
                        "cabangID" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                        "cabangName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                        "cabang2ID" => $_SESSION[$cCode]['main']['placeID'],
                        "cabang2Name" => $_SESSION[$cCode]['main']['placeName'],
                        //
                        "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                        "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                        "gudangID" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['main']['gudang2ID'],
                        "gudangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['main']['gudang2Name'],
                        "pihakID" => isset($_SESSION[$cCode]['main']['placeID']) ? $_SESSION[$cCode]['main']['placeID'] : "",
                        "pihakName" => isset($_SESSION[$cCode]['main']['placeName']) ? $_SESSION[$cCode]['main']['placeName'] : "",
                        "pihakName2" => $_SESSION[$cCode]['main']['placeName'],
                        "gudang" => $_SESSION[$cCode]['main']['gudangID'],
                        "gudang__name" => $_SESSION[$cCode]['main']['gudangName'],
                        "gudang__label" => $_SESSION[$cCode]['main']['gudangName'],
                        "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",

                    );
                    foreach ($masterReplacersO as $key => $val) {
                        $_SESSION[$cCode]['main'][$key] = $val;
                        //                    $_SESSION[$cCode]['main'][$key] = $val;
                    }
                    $masterReplacers = array(
                        //                    "referensi_id" => $masterID, (dimatikan)
                        "inv" => $tmpNomorNota,
                        "jenis_master" => $connector,
                        "jenis_top" => $configUiMasterModulJenis['steps'][1]['target'],
                        "jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                        "jenis_label" => $configUiMasterModulJenis['steps'][1]['label'],
                        "transaksi_jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                        "cabang_id" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['tableIn_master']['cabang2_id'],
                        "cabang_nama" => isset($preReplacer['cabang2Name']) ? $preReplacer['cabang2Name'] : $_SESSION[$cCode]['tableIn_master']['cabang2_nama'],
                        "cabang2_id" => $_SESSION[$cCode]['tableIn_master']['cabang_id'],
                        "cabang2_nama" => $_SESSION[$cCode]['tableIn_master']['cabang_nama'],
                        "gudang_id" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['tableIn_master']['gudang2_id'],
                        "gudang_nama" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['tableIn_master']['gudang2_nama'],
                        "gudang2_id" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                        "gudang2_nama" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                        "gudang" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                        "gudang__name" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                        "gudang__label" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],

                        "step_avail" => sizeof($configUiMasterModulJenis['steps']),
                        "step_current" => 1,
                        "step_number" => 1,
                        "next_step_code" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['target'] : "",
                        "next_step_label" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['label'] : "",
                        "next_group_code" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['userGroup'] : "",
                        "next_step_num" => isset($configUiMasterModulJenis['steps'][2]) ? 2 : "0",
                        "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",
                        //===references
                        //                    "id_master"            => $masterID,
                        //                    "id_top"               => $topID,
                        //                    "ids_prev"             => base64_encode(serialize(array($prevProp['id']))),
                        //                    "ids_prev_intext"      => print_r(array($prevProp['id'], true)),
                        //                    "nomer_top"            => $_SESSION[$cCode]['main']['nomer'],
                        //                    "nomers_prev"          => base64_encode(serialize(array($prevProp['nomer']))),
                        //                    "nomers_prev_intext"   => print_r(array($prevProp['nomer'], true)),
                        //                    "jenis_top"            => $this->jenisTr,
                        //                    "jenises_prev"        => base64_encode(serialize(array($prevProp['jenis']))),
                        //                    "jenises_prev_intext" => print_r(array($prevProp['jenis'], true)),
                    );
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }


                    //region penomoran receipt #2
                    //<editor-fold desc="==========penomoran">
                    $this->load->model("CustomCounter");
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");

                    $counterForNumber = array($configCoreMasterModulJenis['formatNota']);
                    if (!in_array($counterForNumber[0], $configCoreMasterModulJenis['counters'])) {
                        die(__LINE__ . " Used number should be registered in 'counters' config as well");
                    }

                    foreach ($counterForNumber as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    }

                    $tmpNomorNotaConnecting = $tmpNomorNota2 = $paramSpec['paramString'];
                    $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);


                    //</editor-fold>
                    //endregion

                    //region dynamic counters #2
                    // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");
                    $configCustomParams = $configCoreMasterModulJenis['counters'];
                    $configCustomParams[] = "stepCode";
                    if (sizeof($configCustomParams) > 0) {
                        $cContent = array();
                        foreach ($configCustomParams as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                            $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                            switch ($paramSpec['id']) {
                                case 0: //===counter type is new
                                    $paramKeyRaw = print_r($cParams, true);
                                    $paramValuesRaw = print_r($cValues[$i], true);
                                    $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                    break;
                                default: //===counter to be updated
                                    $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                    break;
                            }
                            //echo "<hr>";
                        }
                    }
                    $appliedCounters2 = base64_encode(serialize($cContent));
                    $appliedCounters_inText2 = print_r($cContent, true);
                    // </editor-fold>
                    //endregion

                    //region tambahan counter
                    $this->load->library("CounterNumber");
                    $ccn = new CounterNumber();
                    $ccn->setCCode($cCode);
                    $ccn->setJenisTr($connector);
                    $ccn->setTransaksiGate($_SESSION[$cCode]['tableIn_master']);
                    $ccn->setMainGate($_SESSION[$cCode]['main']);
                    $ccn->setItemsGate($_SESSION[$cCode]['items']);
                    $ccn->setItems2SumGate($_SESSION[$cCode]['items2_sum']);
                    $new_counter = $ccn->getCounterNumber();
                    cekHitam("jenistr yang disett dari create " . $this->jenisTr);


                    if (isset($new_counter['main']) && sizeof($new_counter['main']) > 0) {
                        foreach ($new_counter['main'] as $ckey => $cval) {
                            $_SESSION[$cCode]['tableIn_master'][$ckey] = $cval;
                            $_SESSION[$cCode]['main'][$ckey] = $cval;
                        }
                    }
                    if (isset($new_counter['items']) && sizeof($new_counter['items']) > 0) {
                        foreach ($new_counter['items'] as $ikey => $iSpec) {
                            foreach ($iSpec as $iikey => $iival) {
                                $_SESSION[$cCode]['items'][$ikey][$iikey] = $iival;
                            }
                        }
                    }
                    if (isset($new_counter['items2_sum']) && sizeof($new_counter['items2_sum']) > 0) {
                        foreach ($new_counter['items2_sum'] as $ikey => $iSpec) {
                            foreach ($iSpec as $iikey => $iival) {
                                $_SESSION[$cCode]['items2_sum'][$ikey][$iikey] = $iival;
                            }
                        }
                    }
                    //endregion
                    $addValues = array(
                        'counters' => $appliedCounters2,
                        'counters_intext' => $appliedCounters_inText2,
                        'nomer' => $tmpNomorNota2,
                        'nomer2' => $tmpNomorNota2Alias,
                        'dtime' => $dtime,
                        'fulldate' => $dtime,
                    );
                    foreach ($addValues as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning nota cab1 ke cab2
                    //===daftar perbedaan
                    //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,

                    //==replace kedua
                    $masterReplacers = array(
                        "nomer" => $tmpNomorNota2,
                        "nomer2" => $tmpNomorNota2Alias,
                        "counters" => $appliedCounters2,
                        "counters_intext" => $appliedCounters_inText2,
                    );
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning detail/items cabang1 ke cabang2
                    //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                    $detailReplacers = array(
                        "sub_step_avail" => sizeof($configUiMasterModulJenis['steps']),
                        "sub_step_current" => 1,
                        "sub_step_number" => 1,
                        "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                        "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                        "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                        "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                    );
                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                            foreach ($dSpec as $key => $val) {
                                $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                            }
                        }
                    }
                    else {
                        //                    cekmerah("GAGAL tulis rincian transaksi kedua");
                    }

                    arrprint($_SESSION[$cCode]['tableIn_detail']);
//                    mati_disini(__LINE__);
                    //region ----------write transaksi & transaksi_data #2
                    if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                        $tr = new MdlTransaksi();
                        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                        $insertConnectingID = $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                        cekUngu($this->db->last_query());
                        $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                        $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                        $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                        $mongoListConnect['main'] = array($insertID, $epID);
                        cekmerah("tulis transaksi kedua :: trID $insertID");
                        cekmerah($this->db->last_query());
                        if ($insertID < 1) {
                            die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                        }
                    }
                    else {
                        cekmerah("GAGAL tulis transaksi kedua");
                    }
                    if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                        $inserMainValues = array();
                        foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                        if (sizeof($inserMainValues) > 0) {
                            $arrBlob = blobEncode($inserMainValues);
                            $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                        }
                    }
                    if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                        foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                    }
                    if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                        foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                    }
                    if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                        //                    cekMerah("ada mainElements");
                        foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                            $tr->writeMainElements($insertID, array(
                                "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                "name" => $aSpec['name'],
                                "label" => $aSpec['label'],
                                "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                            ));
                        }
                    }
                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        $insertIDs = array();
                        $insertDeIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                            $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                            if ($insertDetailID < 1) {
                                die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                            }
                            else {
                                $insertIDs[] = $insertDetailID;
                                $insertDeIDs[$insertID][] = $insertDetailID;
                                $mongoListConnect['detail'][] = $insertDetailID;
                            }
                            if ($epID != 999) {
                                $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                if ($insertEpID < 1) {
                                    die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                                }
                                else {
                                    $insertIDs[] = $insertEpID;
                                    $insertDeIDs[$epID][] = $insertEpID;
                                    $mongoListConnect['detail'][] = $insertEpID;
                                }
                            }
                        }
                        if (sizeof($insertIDs) == 0) {
                            die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                        }
                        else {
                            $indexing_details = array();
                            foreach ($insertDeIDs as $key => $numb) {
                                $indexing_details[$key] = $numb;
                            }

                            foreach ($indexing_details as $k => $arrID) {
                                $arrBlob = blobEncode($arrID);
                                $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                                cekOrange($this->db->last_query());
                            }
                        }
                    }
                    if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                            $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                            $mongoListConnect['detail'] = $insertIDs;
                            if ($epID != 999) {
                                $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                $mongoListConnect['detail'] = $mongoListConnect['detail'] = $insertIDs;;
                            }
                        }
                    }
                    if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                            if (isset($this->configCore[$this->jenisTr]['tableIn']['detailValues'])) {
                                foreach ($this->configCore[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                    //                                $insertIDs[$pID][] = $tr->writeDetailValues($insertID, array(
                                    //                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    //                                    "produk_id" => $pID,
                                    //                                    "key" => $key,
                                    //                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                    //                                ));
                                    $dd = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                    ));
                                    $insertIDs[] = $dd;
                                    $mongoListConnect['detailValues'][] = $dd;

                                }
                            }
                        }
                        if (sizeof($insertIDs) > 0) {
                            $arrBlob = blobEncode($insertIDs);
                            $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                        }
                    }
                    if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                            if (isset($this->configCore[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                                foreach ($this->configCore[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                    $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => $dSpec[$src],
                                    ));

                                }
                            }
                        }
                    }

                    //
                    //region nulis paymentSource
                    $stepCode = $configUiMasterModulJenis['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_source");
                    if (array_key_exists($stepCode, $paymentSources)) {
                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentSrc($insertID, array(
                                    "jenis" => $stepCode,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $tmpNomorNota2,
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $olehID,
                                    "oleh_nama" => $olehName,
                                    "dtime" => $dtime,
                                    "fulldate" => $dtime,
                                    "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                    "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                    "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                    "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                    "terbayar_valas" => 0,
                                    "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                ));
                            }
                        }
                        //cekMerah($this->db->last_query());
                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion


                    //region nulis paymentAntiSource
                    //                $stepCode = $configUiMasterModulJenis['steps'][1]['target'];
                    $stepCode = $configUiMasterModulJenis['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_antiSource");
                    if (array_key_exists($stepCode, $paymentSources)) {
                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentAntiSrc($insertID, array(
                                    "jenis" => $stepCode,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $tmpNomorNota2,
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $olehID,
                                    "oleh_nama" => $olehName,
                                    "dtime" => $dtime,
                                    "fulldate" => $dtime,
                                ));
                            }
                        }


                        //cekMerah($this->db->last_query());

                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion


                    $idHis_decode[$stepNum] = array(
                        "olehID" => $_SESSION[$cCode]['main']['olehID'],
                        "olehName" => $_SESSION[$cCode]['main']['olehName'],
                        "step" => $stepNum,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota2,
                        "nomer2" => $tmpNomorNota2Alias,
                        "counters" => $appliedCounters2,
                        "counters_intext" => $appliedCounters_inText2,
                        "dtime" => $dtime,
                        "fulldate" => $dtime,
                    );
                    $idHis_blob = blobEncode($idHis_decode);
                    $idHis_intext = print_r($idHis_decode, true);

                    $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                    $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;

                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array("id" => $insertID), array(
                        "id_master" => $masterID,
                        "id_top" => $insertID,
                        "ids_his" => $idHis_blob,
                        "ids_his_intext" => $idHis_intext,
                    )) or die("Failed to update tr next-state!");
                    showLast_query("orange");

                    //                if($seluruhnya){
                    //                    $dupState = $tr->updateData(array("id" => $insertID), array(
                    //                        "tail_number" => $nextStepNum,
                    //                        "tail_code" => $configUiMasterModulJenis['steps'][$nextStepNum]['target'],
                    //
                    //                    )) or die("Failed to update trans tail!");
                    //                }
                    //cekHijau($this->db->last_query());


                    $baseRegistries = array(
                        'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                        'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                        'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                        'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                        'itemSrc' => isset($_SESSION[$cCode]['itemSrc']) ? $_SESSION[$cCode]['itemSrc'] : array(),
                        'itemSrc_sum' => isset($_SESSION[$cCode]['itemSrc_sum']) ? $_SESSION[$cCode]['itemSrc_sum'] : array(),
                        'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                        'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                        'items4' => isset($_SESSION[$cCode]['items4']) ? $_SESSION[$cCode]['items4'] : array(),
                        'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                        'items5_sum' => isset($_SESSION[$cCode]['items5_sum']) ? $_SESSION[$cCode]['items5_sum'] : array(),
                        'items6_sum' => isset($_SESSION[$cCode]['items6_sum']) ? $_SESSION[$cCode]['items6_sum'] : array(),
                        'items7_sum' => isset($_SESSION[$cCode]['items7_sum']) ? $_SESSION[$cCode]['items7_sum'] : array(),
                        'items8_sum' => isset($_SESSION[$cCode]['items8_sum']) ? $_SESSION[$cCode]['items8_sum'] : array(),
                        'items9_sum' => isset($_SESSION[$cCode]['items9_sum']) ? $_SESSION[$cCode]['items9_sum'] : array(),
                        'items10_sum' => isset($_SESSION[$cCode]['items10_sum']) ? $_SESSION[$cCode]['items10_sum'] : array(),
                        'items_noapprove' => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),

                        'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                        'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                        'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                        'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                        'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                        'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                        'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                        'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                        'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                        'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                        'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                        'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                        'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                        'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                        'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                        'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                        'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        "receiptDetailFields" => isset($configLayoutMasterModulJenis['receiptDetailFields'][1]) ? $configLayoutMasterModulJenis['receiptDetailFields'][1] : array(),
                        "receiptSumFields" => isset($configLayoutMasterModulJenis['receiptSumFields'][1]) ? $configLayoutMasterModulJenis['receiptSumFields'][1] : array(),
                        "receiptDetailFields2" => isset($configLayoutMasterModulJenis['receiptDetailFields2'][1]) ? $configLayoutMasterModulJenis['receiptDetailFields2'][1] : array(),
                        "receiptSumFields2" => isset($configLayoutMasterModulJenis['receiptSumFields2'][1]) ? $configLayoutMasterModulJenis['receiptSumFields2'][1] : array(),
                        "receiptDetailSrcFields" => isset($configLayoutMasterModulJenis['receiptDetailSrcFields'][1]) ? $configLayoutMasterModulJenis['receiptDetailSrcFields'][1] : array(),
                        "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                        "componentsBuilder" => isset($_SESSION[$cCode]['componentsBuilder']) ? $_SESSION[$cCode]['componentsBuilder'] : array(),
                        "jurnalItems" => isset($_SESSION[$cCode]['jurnalItems']) ? $_SESSION[$cCode]['jurnalItems'] : array(),
                        "jurnal_index" => isset($_SESSION[$cCode]['jurnal_index']) ? $_SESSION[$cCode]['jurnal_index'] : array(),
                        "postProcessor" => isset($_SESSION[$cCode]['postProcessor']) ? $_SESSION[$cCode]['postProcessor'] : array(),
                        "preProcessor" => isset($_SESSION[$cCode]['preProcessor']) ? $_SESSION[$cCode]['preProcessor'] : array(),
                        "revert" => isset($_SESSION[$cCode]['revert']) ? $_SESSION[$cCode]['revert'] : array(),

                    );
                    $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                    showLast_query("biru");
                    $mongRegIDConnect = $doWriteReg;
                    //endregion


                    //==================================================================================================
                    //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
//                    $this->load->model("Mdls/MdlLockerTransaksi");
//                    $lt = New MdlLockerTransaksi();
//                    $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], NULL, $insertID);
                    //                mati_disini();
                    //==================================================================================================
                }
                else {
                    cekMerah("to be delayed to connect to $connector");
                }
            }
            else {
                cekKuning("not connecting to any tCode");
            }
            //endregion


            $tr = New MdlTransaksi();
            $where = array(
                "id" => "$trID_selected"
            );
            $data = array(
                "pemindahan" => 1
            );
            $tr->updateData($where, $data);
            showLast_query("orange");


//            mati_disini(__LINE__);
            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

            cekHijau("<h3>...DONE...</h3>");

        }


    }

    //-------------------------------------------
    public function cekStok()
    {
        $this->load->helper("he_mass_table");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuProduk");


        $str = "";
        $str .= "<table rules='all' style='width:100%;'>";
        $str .= "<tr>";
        $str .= "<td>trID</td>";
        $str .= "<td>trNomer</td>";
        $str .= "<td>MM debet</td>";
        $str .= "<td>MM kredit</td>";
        $str .= "<td>DD debet</td>";
        $str .= "<td>DD kredit</td>";
        $str .= "</tr>";

        //-----------------------------
        $rekening = "1010030030";
        $crp = New ComRekeningPembantuProduk();
        $crpMts = $crp->fetchMovement($rekening);
//        showLast_query("biru");
        $arrDetail = array();
        if (sizeof($crpMts) > 0) {
            foreach ($crpMts as $crSpec) {
                $tr_id = $crSpec->transaksi_id;
                if (!isset($arrDetail[$tr_id]["debet"])) {
                    $arrDetail[$tr_id]["debet"] = 0;
                }
                $arrDetail[$tr_id]["debet"] += $crSpec->debet;

                if (!isset($arrDetail[$tr_id]["kredit"])) {
                    $arrDetail[$tr_id]["kredit"] = 0;
                }
                $arrDetail[$tr_id]["kredit"] += $crSpec->kredit;


            }
        }
        //-----------------------------
        $rekening = "1010030030";
        $cr = New ComRekening();
        $crMts = $cr->fetchMoves($rekening);
//        showLast_query("biru");
        $master_netto_total = 0;
        $detail_netto_total = 0;
        $arrData = array();
        if (sizeof($crMts) > 0) {
            foreach ($crMts as $crSpec) {
                $trID = $crSpec->transaksi_id;
                $trNomer = $crSpec->transaksi_no;
                $debet = formatField_he_format("debet", $crSpec->debet);
                $kredit = formatField_he_format("debet", $crSpec->kredit);
                $debet_detail = isset($arrDetail[$trID]["debet"]) ? formatField_he_format("debet", $arrDetail[$trID]["debet"]) : 0;
                $kredit_detail = isset($arrDetail[$trID]["kredit"]) ? formatField_he_format("debet", $arrDetail[$trID]["kredit"]) : 0;
                $selisih = $crSpec->debet - $arrDetail[$trID]["debet"];
                $selisih = ($selisih < 0) ? ($selisih * -1) : $selisih;
                if ($selisih > 0) {
                    $bgcolor = "yellow";
                }
                else {
                    $bgcolor = "";
                }
                $master_netto = $crSpec->debet - $crSpec->kredit;
                $detail_netto = $arrDetail[$trID]["debet"] - $arrDetail[$trID]["kredit"];
                $master_netto_total += $master_netto;
                $detail_netto_total += $detail_netto;

                $str .= "<tr style='background-color:$bgcolor'>";
                $str .= "<td>$trID</td>";
                $str .= "<td>$trNomer</td>";
                $str .= "<td style='text-align: right;'>$debet</td>";
                $str .= "<td style='text-align: right;'>$kredit</td>";
                $str .= "<td style='text-align: right;'>$debet_detail</td>";
                $str .= "<td style='text-align: right;'>$kredit_detail</td>";
                $str .= "</tr>";
            }
            cekHitam("MASTER: $master_netto_total");
            cekHitam("DETAIL: $detail_netto_total");
        }

        $str .= "</table>";
        echo $str;
    }

    public function viewProdukDobelPeriode()
    {
        $ctrl = $this->uri->segment(1);
        $method = $this->uri->segment(2);
        $branchID = null != $this->uri->segment(3) ? $this->uri->segment(3) : -1;
        $whID = getDefaultWarehouseID($branchID)['gudang_id'];
        if (isset($_GET['q']) && (strlen($_GET['q']) < 3)) {
            $q = $search = NULL;
        }
        elseif (isset($_GET['q']) && (strlen($_GET['q']) > 3)) {
            $q = $search = $_GET['q'];
        }
        else {
            $q = $search = NULL;
        }


        $this->load->model("Coms/ComRekeningPembantuProduk");
        $this->load->model("Mdls/MdlCabang");
        $this->load->model("Mdls/MdlProduk2");

        $cb = new MdlCabang();
        $arrCabangData = $cb->lookupAll()->result();
        $arrCabangs['-1'] = "Center";
        if (sizeof($arrCabangData) > 0) {
            foreach ($arrCabangData as $cabSpec) {
                $arrCabangs[$cabSpec->id] = $cabSpec->nama;
            }
        }


        $productsData = array();
        $products = array();
        $products_rakitan = array();
        $ids = array();
        $ffStocks = array();
        $pIDs = array();

        $pd = New MdlProduk2();
        $pd->setFilters(array());
        $pd->addFilter("jenis in ('item','item_rakitan')");
        if (strlen($search) > 3) {
            if ($search != "semua") {
                $pdTmp = $pd->lookupByKeyword($search)->result();
            }
            else {
                $pdTmp = $pd->lookupAll()->result();
            }
        }
        else {
            $pdTmp = $pd->lookupAll()->result();
        }
        if (sizeof($pdTmp) > 0) {
            foreach ($pdTmp as $pdSpec) {
                $productsData[$pdSpec->id] = array(
                    "nama" => strtolower($pdSpec->nama),
                    "kode" => $pdSpec->kode,
                    "kategori" => $pdSpec->folders_nama,
                );
                $pIDs[$pdSpec->id] = $pdSpec->id;
            }
            //            asort($productsData);
        }


        $c = new ComRekeningPembantuProduk();
        $c->addFilter("cabang_id='$branchID'");
        $c->addFilter("gudang_id='$whID'");
        if (sizeof($pIDs) > 0) {
            $c->addFilter("extern_id in ('" . implode("','", $pIDs) . "')");
        }
        $tmp = $c->fetchBalances("1010030030");
        if (sizeof($tmp) > 0) {
            foreach ($tmp as $row) {
                $products[$row->extern_id] = array(
                    "name" => $row->extern_nama,
                    "stock" => $row->qty_debet,
                    "debet" => $row->debet,
                );
                $ids[] = $row->extern_id;

            }
        }

        $c = new ComRekeningPembantuProduk();
        $c->addFilter("cabang_id='$branchID'");
        $c->addFilter("gudang_id='$whID'");
//        if (sizeof($pIDs) > 0) {
//            $c->addFilter("extern_id in ('" . implode("','", $pIDs) . "')");
//        }
        $c->addFilter("periode in ('bulanan','tahunan')");
        $tmpProduk = $c->lookupAll()->result();
        $dataDeble = array();
        foreach ($tmpProduk as $spec) {
            if (!isset($dataDeble[$spec->extern_id][$spec->periode])) {
                $dataDeble[$spec->extern_id][$spec->periode] = 0;
            }
            $dataDeble[$spec->extern_id][$spec->periode] += 1;
        }


        $arrButton = array();
        foreach ($arrCabangs as $branchIDc => $branchNama) {
            $link = base_url() . "$ctrl/$method/$branchIDc";
            $selected = $branchIDc == $branchID ? "selected" : "";
            $btn = $branchIDc == $branchID ? "btn-success" : "btn-secondary";
            $arrButton[$branchIDc] = "<button class='btn $btn' $selected onclick=\"location.href='$link'\">$branchNama</button>";
        }

        $headerFields = array(
            "pID" => "pID",
            "kode" => "code",
            "pName" => "product",
            "kategori" => "kategory",
            "bulanan" => "bulanan",
            "tahunan" => "tahunan",
//            "fifo" => "fifo",
//            "fifo_rakitan" => "fifo<br>rakitan",
//            "avg" => "fifo avg",
//            "debet" => "rek debet",
//            "debet_rakitan" => "rek debet<br>rakitan",
//            "active" => "locker<br>active",
//            "active_rakitan" => "locker<br>active rkt",
//            "hold" => "locker<br>hold",
//            "holdTrID" => "locker<br>hold trID",
//            //            "sold" => "locker<br>sold",
//            //            "moved" => "locker<br>moved",
//            //            "deactivate" => "locker<br>deactivate",
//            //            "distribute" => "locker<br>distribute",
//            //            "returned" => "locker<br>returned",
//            "totalLocker" => "total<br>locker",
//            "totalLockerCache" => "locker<br>cache",
//
//            "debet_value" => "debet<br>value",
////            "fifo_value" => "fifo<br>jml nilai",
////            "fifo_kali" => "fifo<br>jml * hpp",
//            "fifo_avg" => "fifo<br>jml * hpp",
//            "selisih" => "selisih",
        );
        $nof = 0;
        $items = array();
        $itemsGeseh = array();
        $warning = array();
        $marking = array();
        $markingColumn = array();
        $arrPIDDobel = array();
        if (sizeof($productsData) > 0) {

            $this->db->trans_start();

            $nof = 0;
            foreach ($productsData as $pID => $spec) {
                $pName = $spec['nama'];
                $kode = $spec['kode'];
                $kategori = $spec['kategori'];
                $pSpec = isset($products[$pID]) ? $products[$pID] : array();
                $pSpec_rakitan = isset($products_rakitan[$pID]) ? $products_rakitan[$pID] : array();
                $bulanan = isset($dataDeble[$pID]["bulanan"]) ? $dataDeble[$pID]["bulanan"] : 0;
                $tahunan = isset($dataDeble[$pID]["tahunan"]) ? $dataDeble[$pID]["tahunan"] : 0;

                $markingColumn[$pID] = array(
                    "debet" => array(
                        "background-color" => "#B5FF7B",
                    ),
                    "active" => array(
                        "background-color" => "#7BFFF9",
                    ),
                    "hold" => array(
                        "background-color" => "#AC9AFF",
                    ),
                    "holdTrID" => array(
                        "background-color" => "#AC9AFF",
                    ),
                    "totalLocker" => array(
                        "background-color" => "#B5FF7B",
                    ),
                );

                if ($bulanan > 1) {
                    $marking[$pID] = array(
                        "add_name" => "(yellow)",
                        "background-color" => "yellow",
                    );
                    $itemsGeseh[] = array(
                        "pID" => $pID,
                        "kode" => $kode,
                        "pName" => $pName,
                        "kategori" => $kategori,
                        "bulanan" => $bulanan,
                        "tahunan" => $tahunan,
                    );
                    $arrPIDDobel[$pID] = $pID;
                }
                elseif ($tahunan > 1) {
                    $marking[$pID] = array(
                        "add_name" => "(yellow)",
                        "background-color" => "yellow",
                    );
                    $itemsGeseh[] = array(
                        "pID" => $pID,
                        "kode" => $kode,
                        "pName" => $pName,
                        "kategori" => $kategori,
                        "bulanan" => $bulanan,
                        "tahunan" => $tahunan,
                    );
                    $arrPIDDobel[$pID] = $pID;
                }
                else {
//                    $marking[$pID] = array();
//                    $items[] = array(
//                        "pID" => $pID,
//                        "kode" => $kode,
//                        "pName" => $pName,
//                        "kategori" => $kategori,
//                        "bulanan" => $bulanan,
//                        "tahunan" => $tahunan,
//                    );
                    $items = array();
                }


            }


            //            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        }
        if (sizeof($arrPIDDobel) > 0) {
            cekMerah(implode(",", $arrPIDDobel));
        }

        $thisPage = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/?";
        $warning = array();
        $data = array(
            "mode" => "stock",
            "title" => "PRODUCT BRANCH ($branchID)",
            "subTitle" => "WAREHOUSE ($whID)",
            "headerFields" => $headerFields,
            "items" => $items,
            "itemsGeseh" => isset($itemsGeseh) ? $itemsGeseh : array(),
            "warning" => isset($warning) ? $warning : array(),
            "marking" => isset($marking) ? $marking : array(),
            "markingColumn" => isset($markingColumn) ? $markingColumn : array(),
            "button" => $arrButton,
            "thisPage" => $thisPage,
            "q" => "$q",
        );

        $this->load->view("tool", $data);
    }


    public function rebuildMutasiDetail()
    {
        // __rek_pembantu_antarcabang__piutang_cabang


        $this->db->trans_begin();


//        $cabangID = isset($_GET['cb']) ? $_GET['cb'] : "-1";
//        $gudangID = "-1";
        $cabangID = "1";
        $gudangID = "-10";
        $periode = "forever";
        $tahun = "2023";
//        $externID = "23414";
        $externIDs = array(
            "1276",
            "1279",
            "23557",
            "23573",
//            "23564",
//            "23630",
        );
        //---------------------------------------------------------------
        $this->load->model("Mdls/MdlFifoAverage");
        $this->load->model("Coms/ComRekeningPembantuProduk");
        $crd = New ComRekeningPembantuProduk();
        $tbl = "__rek_pembantu_produk__1010030030";
        $tbl_cache = "_rek_pembantu_produk_cache";
        $this->load->model("Mdls/MdlProduk");
        $md = New MdlProduk();
        $fmd = New MdlFifoAverage();
        //---------------------------------------------------------------


        $md->setFilters(array());
        $md->addFilter("id in ('" . implode("','", $externIDs) . "')");
        $mdTmp = $md->lookupAll()->result();
        $externIDs = array();
        foreach ($mdTmp as $mdSpec) {
            $externIDs[$mdSpec->id] = $mdSpec->id;
        }

        $var_tbl = "";
        $contensCache = array();
        foreach ($externIDs as $externID) {
            $condites = array(
//                "jenis!=" => "",
                "cabang_id" => $cabangID,
                "gudang_id" => $gudangID,
//                "year(fulldate)" => $tahun,
//                "extern_id" => 3,// diskonnya
                "extern_id" => $externID,
            );
            $crd->setTableName($tbl);
            $contens_0 = $crd->lookupByCondition($condites)->result();
            showLast_query("lime");
//            mati_disini(__LINE__);
//            cekOrange(sizeof($contens_0));
            $contens = array();
            if (sizeof($contens_0) > 0) {
                foreach ($contens_0 as $ix => $item) {
                    if ($ix == 0) {
//                        $firs_debet_awal = $item->debet_akhir * 1;
                        $firs_debet_awal = $item->debet * 1;
                        $firs_qtydebet_awal = $item->qty_debet * 1;
                    }

                    /* ----------------------------
                     * menyusun data untuk koreksi
                     * ----------------------------*/
                    if ($ix > 0) {
                        $data_yg_bener["db_awal"] = $firs_debet_awal;
                        $db_akhir = $firs_debet_awal + $item->debet - $item->kredit;
                        $data_yg_bener["db_akhir"] = $db_akhir;
                        $contens[$ix] = (array)$item + $data_yg_bener;
                        $firs_debet_awal = $db_akhir;

                        $data_qtyyg_bener["db_qtyawal"] = $firs_qtydebet_awal;
                        $db_qtyakhir = $firs_qtydebet_awal + $item->qty_debet - $item->qty_kredit;
                        $data_qtyyg_bener["db_qtyakhir"] = $db_qtyakhir;
//                        $contens[$ix] = (array)$item + $data_qtyyg_bener;
                        $contens[$ix] = $contens[$ix] + $data_qtyyg_bener;
                        $firs_qtydebet_awal = $db_qtyakhir;

                        $contensCache[$item->extern_id] = array(
                            "qty_debet" => $db_qtyakhir,
                            "debet" => $db_akhir,
                        );
                    }
                }
            }

            $koloms = array(
                "id" => array(
                    "label" => "id",
                ),
                "jenis" => array(
                    "label" => "jenis",
                ),
                "transaksi_no" => array(
                    "label" => "transaksi_no",
                ),
                "dtime" => array(
                    "label" => "dtime",
                ),
                "extern_id" => array(
                    "label" => "id biaya",
                ),
                "extern_nama" => array(
                    "label" => "nama biaya",
                ),

                "debet_awal" => array(
                    "label" => "debet_awal",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_awal" => array(
                    "label" => "db_awal",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
                "debet" => array(
                    "label" => "debet",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "kredit" => array(
                    "label" => "kredit",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "debet_akhir" => array(
                    "label" => "debet_akhir",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_akhir" => array(
                    "label" => "db_akhir",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),

                "qty_debet_awal" => array(
                    "label" => "qty debet_awal",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_qtyawal" => array(
                    "label" => "qty db_awal",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
                "qty_debet" => array(
                    "label" => "qty debet",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "qty_kredit" => array(
                    "label" => "qty kredit",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "qty_debet_akhir" => array(
                    "label" => "qty debet_akhir",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_qtyakhir" => array(
                    "label" => "qty db_akhir",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
            );

            //region header table
            $var_head = "";
            $var_head .= "<tr class='bg-info'>";

            $kolom_params = reset($koloms);
            $attr_head = isset($kolom_params['attr_head']) ? $kolom_params['attr_head'] : "";
            $var_head .= "<th $attr_head width='20px;'>no</th>";

            foreach ($koloms as $kolom => $attrs) {
                $label = $attrs['label'];
                $attr = isset($attrs['attr_head']) ? $attrs['attr_head'] : "";

                $var_head .= "<th $attr>";
                $var_head .= $label;
                $var_head .= "</th>";
            }
            $var_head .= "</tr>";
            //endregion

            //region body table
            $var_body = "";
            if (sizeof($contens) > 0) {
                $no = 0;
                $totals = array();
                foreach ($contens as $var_body_id => $lsr_nama) {
                    $dmain = (object)$lsr_nama;

                    $no++;
                    $var_body .= "<tr>";
                    $var_body .= "<td class='text-right'>$no</td>";

                    foreach ($koloms as $kolom => $attrs) {
                        $nilai = isset($dmain->$kolom) ? $dmain->$kolom : 0;

                        $attr = isset($attrs['attr']) ? $attrs['attr'] : "";
                        $format_key = isset($attrs['format_key']) ? $attrs['format_key'] : $kolom;
                        $nilai_f = isset($attrs['format']) ? $attrs['format']($format_key, $nilai) : $nilai;

                        $linking = isset($attrs['link']) ? $attrs['link'] . "/$var_body_id" : "";
                        $linkDetile = base_url() . $linking . "";
                        // $linkModal = modalDialogBtn("'$nama'", $linkDetile);
                        $nilai_link = isset($attrs['link']) ? "<a href='JavaScript:Void(0);' onclick=\"$linkModal\" title='lihat komposisi'>$nilai_f</a>" : $nilai_f;

                        $var_body .= "<td $attr>";
                        $var_body .= $nilai_link;
                        $var_body .= "</td>";

                        if (isset($attrs['summary'])) {
                            if (!isset($totals[$kolom])) {
                                $totals[$kolom] = 0;
                            }
                            $totals[$kolom] += $nilai;
                        }
                    }
                    $var_body .= "</tr>";

                    /* ----------------------------
                     * eksekutor data ke database
                     * ----------------------------*/
                    $updCondite = array(
                        "id" => $dmain->id,
                    );
                    $updData = array(
                        "debet_awal" => $dmain->db_awal,
                        "debet_akhir" => $dmain->db_akhir,
                        "qty_debet_awal" => $dmain->db_qtyawal,
                        "qty_debet_akhir" => $dmain->db_qtyakhir,
                    );
                    $crd->updateData($updCondite, $updData);
                    // showLast_query("kuning");
                    // break;
                    // --------------------------------------------------done
                }
            }
            else {
//                $var_body .= tplNoData("2");
                $var_body .= "";
            }
            //endregion

            //region footer table
            $var_foot = "";
            $var_foot .= "<tr class='bg-danger'>";
            $var_foot .= "<th></th>";
            foreach ($koloms as $kolom => $attrs) {
                $fNilai = isset($totals[$kolom]) ? $totals[$kolom] : "-";
                $fNilai_f = isset($attrs['format']) ? $attrs['format']($kolom, $fNilai) : $fNilai;
                // $label = $attrs['label'];

                $var_foot .= "<th>";
                $var_foot .= $fNilai_f;
                $var_foot .= "</th>";
            }
            //endregion

            // ---------------
            $str_tbl_id = "";
            $var_tbl .= "<br>";
            $var_tbl .= "<div class='table-responsive'>";
            $var_tbl .= "<table class='table table-condensed table-striped' $str_tbl_id border='1' rules='all'>";
            $var_tbl .= "<thead>";
            $var_tbl .= $var_head;
            $var_tbl .= "</thead>";

            $var_tbl .= "<tbody>";
            $var_tbl .= $var_body;
            $var_tbl .= "</tbody>";

            // cekBiru(sizeof($totals));
            if (isset($totals) && is_array($totals) && sizeof($totals) > 0) {

                $var_tbl .= "<tfoot>";
                $var_tbl .= $var_foot;
                $var_tbl .= "</tfoot>";
            }

            $var_tbl .= "</table>";
            $var_tbl .= "</div>";
        }
        echo $var_tbl;
//        arrPrintPink($contensCache);
        //--------------
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (sizeof($contensCache) > 0) {
                foreach ($contensCache as $pid => $pSpec) {
                    $crd->setFilters(array());
                    $where = array(
                        "cabang_id" => $cabangID,
                        "gudang_id" => $gudangID,
                        "periode" => $periode,
                        "extern_id" => $pid,
                    );
                    $data = array(
                        "debet" => $pSpec["debet"],
                        "qty_debet" => $pSpec["qty_debet"],
                    );
                    $crd->setTableName($tbl_cache);
                    $crd->updateData($where, $data);
                    showLast_query("orange");

//                    $fmd->setFilters(array());
//                    $whereff = array(
//                        "cabang_id" => $cabangID,
//                        "gudang_id" => $gudangID,
//                        "produk_id" => $pid,
//                    );
//                    $dataff = array(
//                        "jml" => $pSpec["qty_debet"],
//                        "hpp" => $pSpec["debet"] / $pSpec["qty_debet"],
//                        "jml_nilai" => $pSpec["debet"],
//                    );
//                    $fmd->updateData($whereff, $dataff);
//                    showLast_query("orange");
                }
            }
        }
        //--------------

//        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @" . __LINE__);
    }

    public function rebuildCacheRekening()
    {
        // __rek_pembantu_antarcabang__piutang_cabang

        $this->load->model("Coms/ComRekeningPembantuBiayaUsaha");
        $cr = New ComRekeningPembantuBiayaUsaha();


        $this->db->trans_begin();


        $periode = "tahunan";
        $cabangID = isset($_GET['cb']) ? $_GET['cb'] : "-1";
        $tahun = "2023";
        $dtime = "2024-01-01 00:03:13";
        $fulldate = "2024-01-01";
        $externID = "34";
        $externIDs = array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40);
//        $externIDs = array(7);

        //biaya usaha------------------------------------------------------------
//        $this->load->model("Coms/ComRekeningPembantuBiayaUsaha");
//        $crd = New ComRekeningPembantuBiayaUsaha();
//        $tbl = "__rek_pembantu_subbiayausaha__6010";
//        $tbl_cache = "_rek_pembantu_subbiayausaha_cache";
//        $rekening = "6010";
//        $this->load->model("Mdls/MdlDtaBiayaUsaha");
//        $md = New MdlDtaBiayaUsaha();

        //biaya umum------------------------------------------------------------
//        $this->load->model("Coms/ComRekeningPembantuBiayaUmum");
//        $crd = New ComRekeningPembantuBiayaUmum();
//        $tbl = "__rek_pembantu_subbiayaumum__6030";
//        $tbl_cache = "_rek_pembantu_subbiayaumum_cache";
//        $rekening = "6030";
//        $this->load->model("Mdls/MdlDtaBiayaUmum");
//        $md = New MdlDtaBiayaUmum();

        //biaya produksi------------------------------------------------------------
        $this->load->model("Coms/ComRekeningPembantuBiayaProduksi");
        $crd = New ComRekeningPembantuBiayaProduksi();
        $tbl = "__rek_pembantu_subbiayaproduksi__6020";
        $tbl_cache = "__rek_pembantu_subbiayaproduksi__6020";
        $rekening = "6020";
        $this->load->model("Mdls/MdlDtaBiayaProduksi");
        $md = New MdlDtaBiayaProduksi();

        //------------------------------------------------------------
        $arrCabangCeklist = array(
            "-1" => array(
                "tr_id" => "257319",
                "tr_no" => "1000.-1.3",
                "jenisTr" => "1000",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "1" => array(
                "tr_id" => "257321",
                "tr_no" => "1001.1.3",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "21" => array(
                "tr_id" => "257323",
                "tr_no" => "1001.21.3",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "25" => array(
                "tr_id" => "257325",
                "tr_no" => "1001.25.3",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "26" => array(
                "tr_id" => "257327",
                "tr_no" => "1001.26.2",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "27" => array(
                "tr_id" => "257329",
                "tr_no" => "1001.27.2",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "28" => array(
                "tr_id" => "257331",
                "tr_no" => "1001.28.2",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "29" => array(
                "tr_id" => "257333",
                "tr_no" => "1001.29.2",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "30" => array(
                "tr_id" => "257335",
                "tr_no" => "1001.30.2",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
            "31" => array(
                "tr_id" => "257337",
                "tr_no" => "1001.31.2",
                "jenisTr" => "1001",
                "dtime" => "$dtime",
                "fulldate" => "$fulldate",
                "oleh_id" => "-100",
                "oleh_nama" => "sys",
            ),
        );
//        arrPrintKuning($arrCabangCeklist[$cabangID]);
        //------------------------------------------------------------

        $md->setFilters(array());
        $mdTmp = $md->lookupAll()->result();
        foreach ($mdTmp as $mdSpec) {
            $externIDs[$mdSpec->id] = $mdSpec->id;
        }


        // ---------------
        //region header table
        $var_head = "";
        $var_head .= "<tr class='bg-info'>";
        $koloms = array(
            "id" => array(
                "label" => "id",
            ),
            "jenis" => array(
                "label" => "jenis",
            ),
            "transaksi_no" => array(
                "label" => "transaksi_no",
            ),
            "dtime" => array(
                "label" => "dtime",
            ),
            "extern_id" => array(
                "label" => "id biaya",
            ),
            "extern_nama" => array(
                "label" => "nama biaya",
            ),
            "debet_awal" => array(
                "label" => "debet_awal",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_awal" => array(
                "label" => "db_awal",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
            "debet" => array(
                "label" => "debet",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "kredit" => array(
                "label" => "kredit",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "debet_akhir" => array(
                "label" => "debet_akhir",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_akhir" => array(
                "label" => "db_akhir",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
                "summary" => "width='100px'",
            ),
            "debet_akumulasi" => array(
                "label" => "db_akhir",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
                "summary" => "width='100px'",
            ),
        );
        $kolom_params = reset($koloms);
        $attr_head = isset($kolom_params['attr_head']) ? $kolom_params['attr_head'] : "";
        $var_head .= "<th $attr_head width='20px;'>no</th>";

        foreach ($koloms as $kolom => $attrs) {
            $label = $attrs['label'];
            $attr = isset($attrs['attr_head']) ? $attrs['attr_head'] : "";

            $var_head .= "<th $attr>";
            $var_head .= $label;
            $var_head .= "</th>";
        }
        $var_head .= "</tr>";
        //endregion
        $str_tbl_id = "";
        $var_tbl = "";
        $var_tbl .= "<div class='table-responsive'>";
        $var_tbl .= "<table class='table table-condensed table-striped' $str_tbl_id border='1' rules='all'>";
        $var_tbl .= "<thead>";
        $var_tbl .= $var_head;
        $var_tbl .= "</thead>";
        $no = 0;
        $totals = array();
        $cacheAkhir = array();
        foreach ($externIDs as $externID) {
            $condites = array(
                "jenis!=" => "",
                "cabang_id" => $cabangID,
                "year(fulldate)" => $tahun,
                "extern_id" => $externID,
            );
            $crd->setTableName($tbl);
            $contens_0 = $crd->lookupByCondition($condites)->result();
//            showLast_query("lime");
//            cekOrange(sizeof($contens_0));
//            $contens = array();
            if (sizeof($contens_0) > 0) {
                foreach ($contens_0 as $ix => $item) {
                    if (!isset($cacheAkhir[$item->extern_id])) {
                        $cacheAkhir[$item->extern_id] = (array)$item;
                    }
                    $cacheAkhir[$item->extern_id]["db_akhir"] = $item->debet_akhir;
//                    $cacheAkhir[$item->extern_id] = (array)$item + $data_yg_bener;
                    if (!isset($cacheAkhir[$item->extern_id]["debet_akumulasi"])) {
                        $cacheAkhir[$item->extern_id]["debet_akumulasi"] = 0;
                    }
                    $cacheAkhir[$item->extern_id]["debet_akumulasi"] += ($item->debet - $item->kredit);

                }
            }

        }
//arrPrintKuning($cacheAkhir);
        //region body table
        $var_body = "";
        if (sizeof($cacheAkhir) > 0) {
            foreach ($cacheAkhir as $var_body_id => $lsr_nama) {
                $dmain = (object)$lsr_nama;
                $no++;
                $var_body .= "<tr>";
                $var_body .= "<td class='text-right'>$no</td>";
                foreach ($koloms as $kolom => $attrs) {
                    $nilai = isset($dmain->$kolom) ? $dmain->$kolom : 0;

                    $attr = isset($attrs['attr']) ? $attrs['attr'] : "";
                    $format_key = isset($attrs['format_key']) ? $attrs['format_key'] : $kolom;
                    $nilai_f = isset($attrs['format']) ? $attrs['format']($format_key, $nilai) : $nilai;

                    $linking = isset($attrs['link']) ? $attrs['link'] . "/$var_body_id" : "";
                    $linkDetile = base_url() . $linking . "";
                    // $linkModal = modalDialogBtn("'$nama'", $linkDetile);
                    $nilai_link = isset($attrs['link']) ? "<a href='JavaScript:Void(0);' onclick=\"$linkModal\" title='lihat komposisi'>$nilai_f</a>" : $nilai_f;

                    $var_body .= "<td $attr>";
                    $var_body .= $nilai_link;
                    $var_body .= "</td>";

                    if (isset($attrs['summary'])) {
                        if (!isset($totals[$kolom])) {
                            $totals[$kolom] = 0;
                        }
                        $totals[$kolom] += $nilai;
                    }
                }
                $var_body .= "</tr>";

                $debet_akhir = $dmain->debet_akhir;
                $debet_akumulasi = $dmain->debet_akumulasi;

                // update cache tahunan
                $where = array(
                    "rekening" => "$rekening",
                    "extern_id" => $dmain->extern_id,
                    "cabang_id" => $dmain->cabang_id,
                    "periode" => "$periode",
                    "thn" => "$tahun",
                );
                $data = array(
                    "debet" => $debet_akumulasi,
                    "kredit" => 0,
                );
                $crd->setTableName($tbl_cache);
                $crd->updateData($where, $data);
                showLast_query("orange");

                // update cache forever
                $where = array(
                    "rekening" => "$rekening",
                    "extern_id" => $dmain->extern_id,
                    "cabang_id" => $dmain->cabang_id,
                    "periode" => "forever",
                );
                $data = array(
                    "debet" => $debet_akhir,
                    "kredit" => 0,
                );
                $crd->setTableName($tbl_cache);
                $crd->updateData($where, $data);
                showLast_query("orange");

                // memotong forever
                $comData[$no] = array(
                    "loop" => array(
                        "$rekening" => -$debet_akhir,
                    ),
                    "static" => array(
                        "cabang_id" => $cabangID,
                        "extern_id" => $dmain->extern_id,
                        "extern_nama" => $dmain->extern_nama,
                        "jenis" => $arrCabangCeklist[$cabangID]["jenisTr"],
                        "transaksi_id" => $arrCabangCeklist[$cabangID]["tr_id"],
                        "transaksi_no" => $arrCabangCeklist[$cabangID]["tr_no"],
                        "dtime" => $arrCabangCeklist[$cabangID]["dtime"],
                        "fulldate" => $arrCabangCeklist[$cabangID]["fulldate"],
                        "periode" => "forever",
                    ),
                );

            }
            $crd->pair($comData);
            $crd->exec();

        }
        else {
//                $var_body .= tplTableNoData("2");
            $var_body .= "";
        }
        //endregion

        //region footer table
        $var_foot = "";
        $var_foot .= "<tr class='bg-danger'>";
        $var_foot .= "<th></th>";
        foreach ($koloms as $kolom => $attrs) {
            $fNilai = isset($totals[$kolom]) ? $totals[$kolom] : "-";
            $fNilai_f = isset($attrs['format']) ? $attrs['format']($kolom, $fNilai) : $fNilai;

            $var_foot .= "<th>";
            $var_foot .= $fNilai_f;
            $var_foot .= "</th>";
        }
        //endregion

        $var_tbl .= "<tbody>";
        $var_tbl .= $var_body;
        $var_tbl .= "</tbody>";
        if (isset($totals) && is_array($totals) && sizeof($totals) > 0) {
            $var_tbl .= "<tfoot>";
            $var_tbl .= $var_foot;
            $var_tbl .= "</tfoot>";
        }


        $var_tbl .= "</table>";
        $var_tbl .= "</div>";

        echo $var_tbl;

        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @" . __LINE__);
    }

    //-------------------------------------------
    public function koreksiPersediaan()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlProduk2");


        // load transaksi opname, mengambil data yang akan dieksekusi
//        $cabangID = "-1";
//        $cabangNama = "PUSAT/DC";
//        $gudangID = "-1";
//        $gudangNama = "default warehouse at branch #-1";
        $cabangID = "1";
        $cabangNama = "CABANG 1";
        $gudangID = "-10";
        $gudangNama = "default warehouse at branch #1";

//        $cabang2ID = "-1";
//        $cabang2Nama = "pusat dc";
//        $gudang2ID = "-1";
//        $gudang2Nama = "default warehouse at branch #-1";

        $olehID = "100";
        $olehNama = "system";
//        $tokoID = "1001";
//        $tokoNama = "JODOMART";
//        $supplierID = "13";
//        $supplierNama = "CV MULIA ABADI";
//        $supplier2ID = "32";
//        $supplier2Nama = "PT. SEDAYU";
//        $pihakID = "1";
//        $pihakNama = "CABANG 1";
//        $pihakID = "473";
//        $pihakNama = "ISHWAR MANWANI";
        $pihakID = "269";
        $pihakNama = "TOKO SANIKO";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $cash_account = 0;
        $cash_account_nama = "";
        $referenceID = 0;
        $referenceNomer = "";
        $modul_transaksi = "adjustment";
        $tCodeTargetJenisTransaksi = $target_transaksi = $jenisTrMaster;


        $this->db->trans_start();


        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
//            "description" => "koreksi piutang TOKO SANIKO pada SO 5822so.1.269.27 dengan pengiriman 5822spd.1.269.22 sebesar 8,600,000",
            "description" => "koreksi piutang TOKO SANIKO pada pelunasan nomer RPC.1.269.4701571 dengan pengiriman 5822spd.1.269.22, pemakaian deposit sebesar 8,600,000",
//            "keterangan" => "koreksi piutang TOKO SANIKO pada SO 5822so.1.269.27 dengan pengiriman 5822spd.1.269.22 sebesar 8,600,000",
            "keterangan" => "koreksi piutang TOKO SANIKO pada pelunasan nomer RPC.1.269.4701571 dengan pengiriman 5822spd.1.269.22, pemakaian deposit sebesar 8,600,000",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );

        $harga_pokok = 0;
        $persediaan_produk = 0;
        $hutang_ke_pusat = 0;
        $piutang_cabang = 0;
        $laba_lain_lain = 0;
        $hutang_dagang = 0;

        $detailGate = array();
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $total_nilai = 0;
            $arrProdukDatas = array();
            $arrprodukIDs = array(
                "269" => array(
                    "hpp" => "8600000",
                    "harga" => "8600000",
                    "jml" => "1",
                    "qty" => "1",
//                    "nomer" => "5822so.1.473.2",
                    "nama" => "TOKO SANIKO",
                    "name" => "TOKO SANIKO",
//                    "target_id" => "602",
                ),
//                "22085" => array(
//                    "hpp" => "106606",
//                    "harga" => "106606",
//                    "jml" => "1",
//                    "qty" => "1",
////                    "nomer" => "5822so.1.473.2",
////                    "nama" => "5822so.1.473.2",
////                    "name" => "5822so.1.473.2",
//                    "target_id" => "339",
//                ),
//                "22078" => array(
//                    "hpp" => "266515.5",
//                    "harga" => "266515.5",
//                    "jml" => "6",
//                    "qty" => "6",
////                    "nomer" => "5822so.1.473.2",
////                    "nama" => "5822so.1.473.2",
////                    "name" => "5822so.1.473.2",
//                    "target_id" => "332",
//                ),
//                "22006" => array(
//                    "hpp" => "1775000",
//                    "harga" => "1775000",
//                    "jml" => "10",
//                    "qty" => "10",
////                    "nomer" => "5822so.1.473.2",
////                    "nama" => "5822so.1.473.2",
////                    "name" => "5822so.1.473.2",
//                    "target_id" => "260",
//                ),
            );
            $arrprodukIDKey = array_keys($arrprodukIDs);
            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                $pr = New MdlProduk2();
                $pr->addFilter("id in ('" . implode("','", $arrprodukIDKey) . "')");
                $prTmp = $pr->lookupAll()->result();
                showLast_query("biru");
                foreach ($prTmp as $prSpec) {
                    $arrProdukDatas[$prSpec->id] = $prSpec;
                }
                foreach ($arrProdukDatas as $pid => $specc) {
                    $pnama = $specc->nama;
                    $kode = $specc->kode;
                    $barcode = $specc->barcode;
                    $satuan = $specc->satuan;
                    $jml = $arrprodukIDs[$pid]["jml"];
                    $qty = $arrprodukIDs[$pid]["qty"];
                    $hpp = $arrprodukIDs[$pid]["hpp"];
                    $harga = $arrprodukIDs[$pid]["harga"];
                    $target_id = $arrprodukIDs[$pid]["target_id"];
//                $sub_hpp = $hpp * $jml;
//                $sub_harga = $harga * $jml;
                    $sub_hpp = $hpp * $jml;
                    $sub_harga = $harga * $jml;
                    $total_nilai += $sub_hpp;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "target_id" => $target_id,
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $harga,
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => $pnama,
                        "kode" => $kode,
                        "barcode" => $barcode,
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $qty,
                        "name" => $pnama,
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }
            else {
                // kalau transaksi detailnya
                foreach ($arrprodukIDs as $pid => $specc) {
                    $sub_hpp = $specc["jml"] * $specc["hpp"];
                    $sub_harga = $specc["jml"] * $specc["harga"];
                    $total_nilai += $sub_harga;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $specc["jml"],
                        "harga" => $specc["harga"],
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $specc["hpp"],
                        "nama" => $specc["nama"],
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $specc["qty"],
                        "name" => $specc["name"],
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }

            //region 1 produk
            $mainHarga = 0;
            $harga_pokok = 0;
            $persediaan_produk = 0;
            $hutang_dagang = 0;
            $hutang_dagang_detail_1 = 0;
            $hutang_dagang_detail_2 = 0;
            $hutang_ke_pusat = 0;
            $piutang_cabang = 0;
            $piutang_dagang = $total_nilai;
            $laba_lain_lain = 0;
            $ppn_masukan = 0;
            $modal = $total_nilai;
            $kas = 0;
            $kas_minus = 0;
            $hutang_ke_konsumen = $total_nilai;
            $hutang_ke_konsumen_noppn = 0;

            foreach ($detailGate as $pid => $spec) {
                foreach ($mainGate as $key => $val) {
                    $spec[$key] = $val;
                }

//                $spec["produk_qty_item"] = -$spec["jml"];
//                $spec["produk_nilai_item"] = $spec["harga"];
//                $spec["produk_nilai_minus_item"] = $spec["harga"];
//                $spec["persediaan_produk_item"] = -$spec["sub_harga"];
//
//                $spec["produk_qty_item_target"] = $spec["jml"];
//                $spec["produk_nilai_item_target"] = $spec["harga"];
//                $spec["produk_nilai_minus_item_target"] = $spec["harga"];
//                $spec["persediaan_produk_item_target"] = $spec["sub_harga"];

                $detailGate[$pid] = $spec;

                foreach ($tableIn["detail"] as $ikey => $ival) {
                    $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                }
            }
            //endregion
        }
        else {
            // region multi produk
            $itemID_blacklist = array("50648");
            $selected_jenis = array(
//                "759",
                "1119",
            );

            // tabel hpp avg > jual
            $pid_avg = array();
            $p_avg = $this->db->get("fifo_avg_sementara")->result();
            foreach ($p_avg as $pSpec) {
                $pid_avg[$pSpec->produk_id] = $pSpec->produk_id;
            }


            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek_avg_fifo = $this->db->get("fifo_avg")->result();
            $p_rek_avg_fifo_hpp = array();
            foreach ($p_rek_avg_fifo as $pSpec) {
                $p_rek_avg_fifo_hpp[$pSpec->produk_id] = $pSpec->hpp;
            }
//arrPrint($p_rek_avg_fifo_hpp);

            // tabel rek pembantu produk
            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
                "jenis" => "759",
//                "jenis" => "1119",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek = $this->db->get("__rek_pembantu_produk__1010030")->result();
            showLast_query("biru");
            $p_rek_salah = array();
            foreach ($p_rek as $pSpec) {
                $p_rek_salah[$pSpec->produk_id]["produk_id"] = $pSpec->produk_id;
                $p_rek_salah[$pSpec->produk_id]["produk_nama"] = $pSpec->produk_nama;
                $p_rek_salah[$pSpec->produk_id]["hpp_avg"] = $pSpec->harga;


                if (!isset($p_rek_salah[$pSpec->produk_id]["qty"])) {
                    $p_rek_salah[$pSpec->produk_id]["qty"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_kredit;
//                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_debet;


                if (!isset($p_rek_salah[$pSpec->produk_id]["nilai"])) {
                    $p_rek_salah[$pSpec->produk_id]["nilai"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->kredit;
//                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->debet;

            }
//            arrPrintPink($p_rek_salah);
            foreach ($p_rek_salah as $pid => $pSpec) {
                $nama = $pSpec["produk_nama"];
                if (!in_array($pSpec['produk_id'], $itemID_blacklist)) {
                    $jml = $pSpec["qty"];
//                    $nilai = $pSpec["nilai"];
//                    $hpp = $nilai/$jml;
//                    $hpp = $pSpec["hpp_avg"];
                    $hpp = $p_rek_avg_fifo_hpp[$pid];
                    $nilai = $pSpec["qty"] * $hpp;

                    $persediaan_produk += $nilai;
                    $harga_pokok += $nilai;
//                    $laba_lain_lain += $nilai;

                    $detailGate[$pid] = array(
                        //region detail/items
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $hpp,
                        "subtotal" => 33,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => "$nama",
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 3,
                        "stok" => 26750,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $jml,
                        "name" => "$nama",
                        "sub_harga" => $nilai,
                        "sub_subtotal" => $nilai,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $nilai,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                        //endregion

                        "produk_qty_item" => -$jml,
                        "produk_nilai_item" => $hpp,
                        "produk_nilai_minus_item" => $hpp,
                        "persediaan_produk_item" => -$nilai,
                    );
                    foreach ($detailGate as $pid => $spec) {
                        foreach ($mainGate as $key => $val) {
                            $spec[$key] = $val;
                        }
                        $detailGate[$pid] = $spec;
                        foreach ($tableIn["detail"] as $ikey => $ival) {
                            $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                        }
                    }
                }
            }
//            mati_disini(__LINE__);


            // endregion multi produk
        }


        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }


        $mainGate["hpp"] = -$harga_pokok;
        $mainGate["persediaan_produk"] = -$persediaan_produk;
        $mainGate["hutang_ke_pusat"] = $hutang_ke_pusat;
        $mainGate["piutang_cabang_minus_3"] = $piutang_cabang;
        $mainGate["piutang_dagang"] = -$piutang_dagang;
        $mainGate["laba_lain_lain"] = $laba_lain_lain;
        $mainGate["hutang_dagang"] = -$hutang_dagang;
        $mainGate["hutang_dagang_detail_1"] = $hutang_dagang_detail_1;
        $mainGate["hutang_dagang_detail_2"] = -$hutang_dagang_detail_2;
        $mainGate["modal"] = -$modal;
        $mainGate["ppn_masukan"] = $ppn_masukan;
        $mainGate["kas"] = $kas;
        $mainGate["kas_minus"] = -$kas_minus;
        $mainGate["hutang_ke_konsumen"] = -$hutang_ke_konsumen;
        $mainGate["hutang_ke_konsumen_noppn"] = $hutang_ke_konsumen_noppn;

        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;

        //--------------------------
        $preProcessor = array(
            "master" => array(),
            "detail" => array(
                array(
                    "comName" => "FifoAverage",
                    "loop" => array(),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "produk_qty" => "qty_kredit",
                        "gudang_id" => "gudangID",
                        "toko_id" => "tokoID",
                        "toko_nama" => "tokoName",
                    ),
                    "resultParams" => array(
//                        "items" => array(
//                            "kredit_rsltItems" => "hpp",
//                        ),
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );
        $components = array(
            "master" => array(
                // JURNAL 1
                array(
                    "comName" => "Jurnal",
                    "loop" => array(
//                        "1010030030" => "persediaan_produk",
//                        "3010020" => "modal", // hutang dagang
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "5010" => "hpp", // hpp
//                        "1010040050" => "ppn_masukan", // ppn masukan
                        //-------------------
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "1010010010" => "kas_minus", // hutang dagang
                        "1010020010" => "piutang_dagang", // piutang dagang
                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                array(
                    "comName" => "Rekening",
                    "loop" => array(
//                        "1010030030" => "persediaan_produk",
//                        "3010020" => "modal", // hutang dagang
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "5010" => "hpp", // hpp
//                        "1010040050" => "ppn_masukan", // ppn masukan
                        //-------------------
//                        "1010060010" => "piutang_cabang_minus_3", // piutang cabang dagang
//                        "1010010010" => "kas_minus", // kas
                        "1010020010" => "piutang_dagang", // piutang dagang
                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

//                //pembantu antarcabang (pusat)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "1010060010" => "piutang_cabang_minus_3",
//                    ),
//                    "static" => array(
//                        "cabang_id" => ".-1",
//                        "cabang2_id" => "cabang2ID",
//                        "cabang2_nama" => "cabang2Name",
//                        "extern_id" => "cabangID",
//                        "extern_nama" => "cabangName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu hutang ke supplier (pusat)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu antarcabang (caabng)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "2040010" => "hutang_ke_pusat",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "cabang2_id" => "placeID",
//                        "cabang2_nama" => "placeName",
//                        "extern_id" => "cabang2ID",
//                        "extern_nama" => "cabang2Name",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                // hutang ke konsumen, penjualan tunai
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050010",// uang muka konsumen
//                        "extern_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                // hutang ke konsumen, penjualan tunai, per-konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050010",// uang muka konsumen
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


                // JURNAL 2
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan plus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_j_2",
//                        "hpp" => "persediaan_j_2",
//                        "produk_nilai" => "persediaan_j_2",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan minus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_minus_item", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_produk_minus_item",
//                        "hpp" => "persediaan_produk_minus_item",
//                        "produk_nilai" => "persediaan_produk_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail laba lain-lain
//                array(
//                    "comName" => "RekeningPembantuLRLainlain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".7010150",
//                        "extern_nama" => ".laba lain lain",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail kerugian
//                array(
//                    "comName" => "RekeningPembantuKerugian",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".702020",
//                        "extern_nama" => ".kerugian stok opname",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw laba lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7010150",//lokal ,non lokal
//                        "extern_nama" => ".laba lain lain",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jml" => ".0",
//                        "harga" => "laba_lain_lain",
//                        "hpp" => "laba_lain_lain",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw rugi lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7020020",//lokal ,non lokal
//                        "extern_nama" => ".kerugian stok opname",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7020020",
//                        "produk_nama" => ".kerugian stok opname",
//                        "jml" => ".0",
//                        "harga" => "kerugian_minus_minus_item",
//                        "hpp" => "kerugian_minus_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //rekening pembantu hpp harga pokok produk
//                array(
//                    "comName" => "RekeningPembantuHpp",
//                    "loop" => array(
//                        "5010" => "hpp", // hpp
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".5010010",//
//                        "extern_nama" => ".lokal",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "harga" => "hpp",
//                        "hpp" => "hpp",
//                        "produk_nilai" => "hpp",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang dagang
//                array(
//                    "comName" => "RekeningPembantHutangUsaha",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "extern_nama" => ".hutang usaha",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "produk_nama" => ".hutang dagang",
//                        "jml" => ".1",
//                        "harga" => "hutang_dagang",
//                        "produk_nilai" => "hutang_dagang",
//                        "hpp" => "hutang_dagang",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "0leh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010010010",
//                        "extern_nama" => ".lokal",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => "pihakID",
//                        "produk_nama" => "pihakName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu piutang dagang
                array(
                    "comName" => "RekeningPembantuCustomer",
                    "loop" => array(
                        "1010020010" => "piutang_dagang", // piutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                //pembantu hutang ke konsumen
                array(
                    "comName" => "RekeningPembantuCustomer",
                    "loop" => array(
                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => ".2010050010",
                        "extern_nama" => ".Uang Muka Konsumen",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                array(
                    "comName" => "RekeningPembantuCustomerDetail",
                    "loop" => array(
                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "extern2_id" => ".2010050010",
                        "extern2_nama" => ".Uang Muka Konsumen",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_1", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_2", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplier2ID",
//                        "extern_nama" => "supplier2Nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

            ),
            "detail" => array(
                // pembantu produk minus
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_minus_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // pembantu produk minus
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_item_target",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "target_id",
//                        "extern_nama" => "nama",
//                        "produk_qty" => "produk_qty_item_target",
//                        "produk_nilai" => "produk_nilai_minus_item_target",
//                        "harga" => "produk_nilai_minus_item_target",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // pembantu produk tambah
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".1010030030",
//                        "extern_nama" => ".persediaan produk",
//                        "produk_id" => "id",
//                        "produk_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

            ),
        );
        $postProcessor = array(
            "master" => array(),
            "detail" => array(
//                array(
//                    "comName" => "FifoAverage",
//                    "loop" => array(),
//                    "static" => array(
//                        "jenis" => ".produk",
//                        "jml" => "qty_debet",
//                        "produk_id" => "id",
//                        "hpp" => "hpp",
//                        "jml_nilai" => "sub_debet",
//                        "nama" => "name",
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                    array(
//                        "comName" => "LockerStock",
//                        "loop" => array(),
//                        "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
//                            "cabang_id" => "placeID",
//                            "jenis" => ".produk",
//                            "state" => ".active",
//                            "jumlah" => "qty_debet",
//                            "produk_id" => "id",
//                            "nama" => "name",
//                            "satuan" => "satuan",
//                            "transaksi_id" => ".0",
//                            "oleh_id" => ".0",
//                            "gudang_id" => "gudangID",
//                        ),
//                        "srcGateName" => "items",
//                        "srcRawGateName" => "items",
//                    ),

                array(
                    "comName" => "LockerStock",
                    "loop" => array(),
                    "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
                        "cabang_id" => "placeID",
                        "jenis" => ".produk",
                        "state" => ".active",
                        "jumlah" => "-qty",
                        "produk_id" => "id",
                        "nama" => "name",
                        "satuan" => "satuan",
                        "transaksi_id" => ".0",
                        "oleh_id" => ".0",
                        "gudang_id" => "gudangID",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

            ),
        );
        //--------------------------


        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }

//        mati_disini(__LINE__);

        // PRE-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            // PRE-PROCC (karena mengeluarkan stok)
            //region pre-processors (item)
            $iterator = $preProcessor["detail"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                cekHere("ITEM NUM LABELS");
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        cekHere("sub-preproc: $comName, initializing values <br>");
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                cekHere("sub preproc #: $comName, sending values " . __LINE__ . "<br>");

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);

                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();
                                    // arrPrintWebs($gotParams);
                                    // matiHEre(__LINE__);
                                    // cekmerah("gotparams dari pre-proc $comName");
                                    // arrPrint($gotParams);
                                    // matiHEre();
                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            // arrPrint($paramSpec);
                                            // cekHitam($gateName);
                                            // cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($this->cCodeData[$cCode][$gateName])) {
                                                $this->cCodeData[$cCode][$gateName] = array();
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }
                                            // matiHEre($cCode);
                                            foreach ($paramSpec as $id => $gSpec) {
                                                if (!isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    $this->cCodeData[$cCode][$gateName][$id] = array();
                                                }
                                                if (isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        // matiHEre("ada");
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val " . __LINE__);
                                                            $this->cCodeData[$cCode][$gateName][$id][$key] = $val;
                                                            cekMerah($cCode . "[" . $gateName . "][" . $id . "][" . $key . "]=" . $val);
                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                if (isset($this->cCodeData[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {

                                                        foreach ($gSpec as $key => $val) {
                                                            $this->cCodeData[$cCode][$srcGateName][$id][$key] = $val;

                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                if (sizeof($itemNumLabels) > 0) {
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        if (isset($this->cCodeData[$cCode][$gateName][$id][$key])) {
                                                            $this->cCodeData[$cCode][$gateName][$id]['sub_' . $key] = ($this->cCodeData[$cCode][$gateName][$id]['jml'] * $this->cCodeData[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }
                                // matiHEre(__LINE__);
                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                // arrprintWebs($this->cCodeData[$cCode]);

                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $this->cCodeData[$cCode]["revert"]["preProc"]["replacer"];
                    $tempCalculate = array(
                        "selisih" => ($this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"]) - ($this->cCodeData[$cCode]["main"]["nett"] + $this->cCodeData[$cCode]["main"]["ppv"]),
                        "hpp_nppv" => $this->cCodeData[$cCode]["main"]["hpp"],
                        "hpp_nppn" => $this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"],
                    );
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $this->cCodeData[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }
                }
                //endregion
            }
            else {
                cekHitam("no sub-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //region pre-processors (master)
            $iterator = $preProcessor["master"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $this->cCodeData[$cCode]["main"], $this->cCodeData[$cCode]["main"], 0);
                                $subParams['static'][$key] = $realValue;
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = "";
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);

                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //==inject gotParams to child gate
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($this->cCodeData[$cCode]["main"][$key])) {
                                                $this->cCodeData[$cCode]["main"]['sub_' . $key] = ($this->cCodeData[$cCode]["main"]['jml'] * $this->cCodeData[$cCode]["main"][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
            }
            else {
                cekHitam("no main-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }

                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }

        // POST-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            //region processing sub-post-processors, always
            $iterator = $postProcessor["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>");
                    $tmpOutParams[$cCtr] = array();
                    if (isset($this->cCodeData[$cCode][$srcGateName]) && (sizeof($this->cCodeData[$cCode][$srcGateName]) > 0)) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($this->cCodeData[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $this->cCodeData[$cCode]["main"]['pihakExternID'];
                                }
                                $subParams['static']["keterangan"] = "";
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($this->cCodeData[$cCode][$srcGateName])) {
                        cekHere("[$cCtr] sub-postProcessor: $comName, sending values " . __LINE__ . "<br>");
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekHitam($this->db->last_query());
                    }
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP SUB-POSTPROC");
            }
            //endregion

            //region processing main-post-processors, always
            $iterator = $postProcessor["master"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("post-processor: $comName<br>LINE: " . __LINE__);

                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }
                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = "";
                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP MAIN-POSTPROC");
            }
            //endregion
        }

        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (isset($core['components']) && sizeof($core['components'])) {
                $jurnalIndex = $core['components'];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //------------
            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
            }
            else {
                $coreBuilder = array();
            }
            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");

        }
        //endregion

//        mati_disini(__LINE__);

        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            $this->load->model("Coms/ComRekeningPembantuProduk");
            $this->load->model("Coms/ComProdukSerialNumber");
            foreach ($arrprodukIDs as $pid => $pSpec) {
                $itemID = $pid;
                $crd = New ComRekeningPembantuProduk();
                $crd->addFilter("gudang_id='$gudangID'");
                $crd->addFilter("cabang_id='$cabangID'");
                $crd->addFilter("extern_id='$itemID'");
                $crd->addFilter("periode='forever'");
                $crdTmp = $crd->lookupAll()->result();
                showLast_query("biru");
                cekBiru(count($crdTmp));
                if (sizeof($crdTmp) > 0) {
                    $qty = $crdTmp[0]->qty_debet;
                    $debet = $crdTmp[0]->debet;
                    $avg = ($qty > 0) ? $debet / $qty : 0;

                    $this->load->model("Mdls/MdlFifoAverage");
                    $ff = New MdlFifoAverage();
                    $ff->addFilter("jenis='produk'");
                    $ff->addFilter("produk_id='$itemID'");
                    $ff->addFilter("cabang_id='$cabangID'");
                    $ff->addFilter("gudang_id='$gudangID'");
                    $ffTmp = $ff->lookupAll()->result();
                    showLast_query("biru");
                    if (sizeof($ffTmp) > 0) {
                        $id_tbl = $ffTmp[0]->id;
                        $where = array(
                            "id" => $id_tbl
                        );
                        $data = array(
                            "jml" => $qty,
                            "hpp" => $avg,
                            "jml_nilai" => $debet,
                        );
                        $ff->updateData($where, $data);
                        showLast_query("orange");
                    }

                }

                if (isset($detailGate[$pid])) {
                    $jml = $detailGate[$pid]["jml"];
                    cekHere("[jml: $jml]");
//                arrPrintKuning($detailGate[$pid]);
                    for ($ii = 1; $ii <= $jml; $ii++) {
                        $anu[0] = array(
                            "loop" => array(),
                            "static" => array(
                                "jenis" => "99999",
                                "cabang_id" => "$cabangID",
                                "jumlah" => "1",
                                "produk_id" => $detailGate[$pid]["target_id"],
                                "produk_nama" => $detailGate[$pid]["name"],
                                "produk_serial_number" => "",//serial_number
                                "produk_sku" => $detailGate[$pid]["kode"],
                                "produk_sku_serial" => "",//produk_sku_serial
                                "produk_sku_part_id" => "",//produk_sku_part_id
                                "produk_sku_part_nama" => $detailGate[$pid]["kode"],//produk_sku_part_nama
                                "produk_sku_part_serial" => "",//produk_sku_part_serial
                                "oleh_id" => "$olehID",
                                "oleh_nama" => "$olehNama",
                                "supplier_id" => "$supplierID",
                                "supplier_nama" => "$supplierName",
                                "gudang_id" => "$gudangID",
                                //---------------
                                "transaksi_reference_id" => "$insertID",
                                "transaksi_reference_no" => "$insertNum",
                                "transaksi_reference_dtime" => date("Y-m-d H:i:s"),
                                "transaksi_reference_fulldate" => date("Y-m-d H:i:s"),
                                "transaksi_reference_count" => "1",
                                "transaksi_count" => "1",
                                "transaksi_jenis_count" => "1",
                                "part_keterangan" => "",
                                "transaksi_id" => "$insertID",
                                "transaksi_no" => "$insertNum",
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d H:i:s"),
                            ),
                        );
                        arrPrintPink($anu);
                        $ss = New ComProdukSerialNumber();
                        $ss->pair($anu);
                        $ss->exec();
                    }


                }
            }

        }

        cekMerah(":: cek validate lajur di " . __FUNCTION__ . ", " . __FILE__);
        validateAllBalances($cabangID);


        mati_disini("---SETOP--- " . __LINE__);

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");
    }

    //-------------------------------------------
    public function koreksiPenjualanTunai()
    {
        if ($_GET["r"]) {
            header("refresh:" . $_GET["r"]);
        }
        $starttime = microtime(true);
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComJurnal");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuCustomer");
        $this->load->model("Coms/ComRekeningPembantuCustomerDetail");

        $jenis = "749";
        $pembayaran = "cash";
        $label = "piutang dagang";
        $fulldate = date("Y-m-d");
        $dtime = date("Y-m-d H:i:s");
        $blacklistTrIDs = array(// karena sudah ditembak
//            "371",
            "10773",
            "1476",
        );
        $arrKoreksiNilai = array(
            "958" => "8778000.3",
            "1794" => "35450000.5225230000",
            "2324" => "7499999.8648649000",
            "2524" => "2200000.0270270000",
        );


        $this->db->trans_start();

        $trIDs = array();
        $trIDs_cash = array();
        $trPymSrc = array();
        $trPym = array();
        $trPymTrCash = array();

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("transaksi_id != 10773");
        $trTmp = $tr->lookupPaymentSrcByJenis($jenis)->result();
        showLast_query("biru");
//        mati_disini(__LINE__);

        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $trIDs[$trSpec->transaksi_id] = $trSpec->transaksi_id;
                $trPymSrc[$trSpec->transaksi_id] = array(
                    "id" => $trSpec->id,
                    "tagihan" => $trSpec->tagihan,
                    "sisa" => $trSpec->sisa,
                );
            }

            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("id in ('" . implode("','", $trIDs) . "')");
            $tr->addFilter("pembayaran='$pembayaran'");
            $tmp = $tr->lookupAll()->result();
            if (sizeof($tmp) > 0) {
                foreach ($tmp as $tSpec) {
                    $trIDs_cash[] = $tSpec->id;
                    $trPym[$tSpec->id] = array(
                        "id" => isset($trPymSrc[$tSpec->id]["id"]) ? $trPymSrc[$tSpec->id]["id"] : 0,
                        "tagihan" => isset($trPymSrc[$tSpec->id]["tagihan"]) ? $trPymSrc[$tSpec->id]["tagihan"] : 0,
                        "sisa" => isset($trPymSrc[$tSpec->id]["sisa"]) ? $trPymSrc[$tSpec->id]["sisa"] : 0,
                    );
                }
            }
//            cekHere(sizeof($trPym));
//            arrPrintWebs($trPym);

            // update tabel payment source
            foreach ($trPym as $trID => $specc) {
                $trPymTrCash[$trID] = $trID;

                $data = array(
                    "dihapus" => $specc["tagihan"],
                    "sisa" => 0,
                );
                $where = array(
                    "transaksi_id" => $trID,
                    "target_jenis" => $jenis,
                    "label" => $label,
                    "id" => $specc["id"],
                );
//                $tr = New MdlTransaksi();
//                $tr->setFilters(array());
//                $tr->updatePaymentSrc($where, $data);
//                showLast_query("orange");
            }

            $pakai_ini = 1;
            if ($pakai_ini == 1) {
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("transaksi_id in ('" . implode("','", $trPymTrCash) . "')");
                $tr->addFilter("dihapus>0");
                $tr->addFilter("lunas=0");
                $this->db->limit(1);
                $trTmp = $tr->lookupPaymentSrcByJenis($jenis)->result();
                showLast_query("biru");
//                arrPrintWebs($trTmp);
                foreach ($trTmp as $spec) {
                    $trPymTrCash_1[$spec->transaksi_id] = $spec->transaksi_id;
                }
//                mati_disini(__LINE__);

                // hutang ke konsumen pada piutang dagang
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("transaksi_id in ('" . implode("','", $trPymTrCash_1) . "')");
                $tr->setJointSelectFields("transaksi_id, main");
                $tmpReg = $tr->lookupDataRegistries()->result();
                showLast_query("biru");
                if (sizeof($tmpReg) > 0) {
                    foreach ($tmpReg as $regSpec) {
//                    arrPrintPink($regSpec);
                        $trID = $regSpec->transaksi_id;
                        if (!in_array($trID, $blacklistTrIDs)) {
                            $main = blobDecode($regSpec->main);
                            if (array_key_exists($trID, $arrKoreksiNilai)) {
                                $main["nilai_tambah_2010050_2010050010"] = $arrKoreksiNilai[$trID];
                            }

                            $arrRekening = array(
                                "loop" => array(
                                    "2010050" => -$main["nilai_tambah_2010050_2010050010"],// hutang ke konsumen
                                    "1010020010" => -$main["nilai_tambah_2010050_2010050010"],// piutang dagang
                                ),
                                "static" => array(
                                    "cabang_id" => $main["placeID"],
                                    "jenis" => $main["jenisTr"],
                                    "transaksi_no" => $main["nomer"],
                                    "transaksi_id" => $trID,
                                    "fulldate" => $fulldate,
                                    "dtime" => $dtime,
                                ),
                            );
                            $arrPembantuCustomer = array(
                                "loop" => array(
                                    "1010020010" => -$main["nilai_tambah_2010050_2010050010"],// piutang dagang
                                ),
                                "static" => array(
                                    "cabang_id" => $main["placeID"],
                                    "extern_id" => $main["pihakID"],
                                    "extern_nama" => $main["pihakName"],
                                    "jenis" => $main["jenisTr"],
                                    "transaksi_no" => $main["nomer"],
                                    "transaksi_id" => $trID,
                                    "fulldate" => $fulldate,
                                    "dtime" => $dtime,
                                ),
                            );
                            $arrPembantucustomerUM = array(
                                "loop" => array(
                                    "2010050" => -$main["nilai_tambah_2010050_2010050010"],// hutang ke konsumen
                                ),
                                "static" => array(
                                    "cabang_id" => $main["placeID"],
                                    "extern_id" => "2010050010",
                                    "extern_nama" => "Uang Muka Konsumen",
                                    "jenis" => $main["jenisTr"],
                                    "transaksi_no" => $main["nomer"],
                                    "transaksi_id" => $trID,
                                    "fulldate" => $fulldate,
                                    "dtime" => $dtime,
                                ),
                            );
                            $arrPembantucustomerUMDetail = array(
                                "loop" => array(
                                    "2010050" => -$main["nilai_tambah_2010050_2010050010"],// hutang ke konsumen
                                ),
                                "static" => array(
                                    "cabang_id" => $main["placeID"],
                                    "extern_id" => $main["pihakID"],
                                    "extern_nama" => $main["pihakName"],
                                    "extern2_id" => "2010050010",
                                    "extern2_nama" => "Uang Muka Konsumen",
                                    "jenis" => $main["jenisTr"],
                                    "transaksi_no" => $main["nomer"],
                                    "transaksi_id" => $trID,
                                    "fulldate" => $fulldate,
                                    "dtime" => $dtime,
                                ),
                            );

                            $j = New ComJurnal();
                            $j->pair($arrRekening);
                            $j->exec();

                            $r = New ComRekening();
                            $r->pair($arrRekening);
                            $r->exec();

                            $ppd = New ComRekeningPembantuCustomer();
                            $ppd->pair($arrPembantuCustomer);
                            $ppd->exec();

                            $pum = New ComRekeningPembantuCustomer();
                            $pum->pair($arrPembantucustomerUM);
                            $pum->exec();

                            $pumd = New ComRekeningPembantuCustomerDetail();
                            $pumd->pair($arrPembantucustomerUMDetail);
                            $pumd->exec();


//                    break;

                        }
                    }
                }


                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $where = array("id" => $trTmp[0]->id);
                $data = array("lunas" => 1);
                $tr->updatePaymentSrc($where, $data);
                showLast_query("orange");
            }


        }


        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;


//        mati_disini("---SETOP--- [$val] ::  " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");


    }

    //-------------------------------------------
    public function patchSerialUpdate()
    {
        $this->load->model("Coms/ComRekeningPembantuProdukPerSerial");
        $this->load->model("Mdls/MdlProdukPerSerialNumber");
        $this->load->model("Mdls/MdlProduk2");

        $csnProdukRek = array();
        $serialProdukRek = array();
        $skuProduk = array();
        $produkUnitPart = array(
            "outdoor_id" => "outdoor_sku",
            "indoor_id_1" => "indoor_sku_1",
            "indoor_id_2" => "indoor_sku_2",
            "indoor_id_3" => "indoor_sku_3",
            "indoor_id_4" => "indoor_sku_4",
            "heater_id" => "heater_nama",
            "produk_part_id_1" => "produk_part_nama_1",
            "produk_part_id_2" => "produk_part_nama_2",
            "produk_part_id_3" => "produk_part_nama_3",
        );

        $csn = New ComRekeningPembantuProdukPerSerial();
        $csn->addFilter("qty_debet>0");
        $csnTmp = $csn->lookupAll()->result();
        if (sizeof($csnTmp) > 0) {
            foreach ($csnTmp as $ii => $iiSpec) {
//                arrPrintWebs($iiSpec);
                $csnProdukRek[$iiSpec->produk_id][$iiSpec->extern2_nama] = $iiSpec->extern2_nama;
            }
        }

        $msn = New MdlProdukPerSerialNumber();
        $msnTmp = $msn->lookupAll()->result();
        if (sizeof($msnTmp) > 0) {
            foreach ($msnTmp as $ii => $iiSpec) {
//                arrPrintWebs($iiSpec);
                $serialProdukRek[$iiSpec->produk_id][$iiSpec->produk_sku_part_nama] = $iiSpec->produk_sku_part_nama;
            }
        }

        $psn = New MdlProduk2();
//        $psn->addFilter("kategori_id='1'");
        $psnTmp = $psn->lookupAll()->result();
        if (sizeof($psnTmp) > 0) {
            foreach ($psnTmp as $ii => $iiSpec) {
//                arrPrintWebs($iiSpec);
                if ($iiSpec->kategori_id == 1) {
                    foreach ($produkUnitPart as $sku_nama) {
                        if ((isset($iiSpec->$sku_nama)) && ($iiSpec->$sku_nama != NULL)) {
                            $sku = $iiSpec->$sku_nama;
                            $skuProduk[$iiSpec->id][$sku] = $sku;
                        }
                    }
                }
                elseif ($iiSpec->kategori_id == 3) {
                    $sku = $iiSpec->kode;
                    $skuProduk[$iiSpec->id][$sku] = $sku;
                }

            }
        }
//        arrPrintWebs($skuProduk);
//        arrPrintPink($serialProdukRek);
        $arrProdukDiffSku = array();
        $arrProdukDiffSku2 = array();
        foreach ($serialProdukRek as $pid => $spec) {
            $skuProduk = $skuProduk[$pid];
            $hasil = array_diff($spec, $skuProduk);
            if (sizeof($hasil) > 0) {
                $arrProdukDiffSku[$pid] = $hasil;
            }
            //---------------
            $skuSerialProduk = $serialProdukRek[$pid];
            $hasil2 = array_diff($spec, $skuSerialProduk);
            if (sizeof($hasil2) > 0) {
                $arrProdukDiffSku2[$pid] = $hasil2;
            }
        }
        arrPrintKuning($arrProdukDiffSku);
        arrPrintWebs($arrProdukDiffSku2);


    }

    public function koreksi2()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlProduk2");


        // load transaksi opname, mengambil data yang akan dieksekusi
        $cabangID = "1";
        $cabangNama = "cabang 1";
        $gudangID = "-10";
        $gudangNama = "default warehouse at branch #1";
        $cabang2ID = "-1";
        $cabang2Nama = "pusat dc";
        $gudang2ID = "-1";
        $gudang2Nama = "default warehouse at branch #-1";

        $olehID = "100";
        $olehNama = "system";
//        $tokoID = "1001";
//        $tokoNama = "JODOMART";
//        $supplierID = "13";
//        $supplierNama = "CV MULIA ABADI";
//        $supplier2ID = "32";
//        $supplier2Nama = "PT. SEDAYU";
//        $pihakID = "1";
//        $pihakNama = "CABANG 1";
        $pihakID = "473";
        $pihakNama = "ISHWAR MANWANI";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $cash_account = 1160;
        $cash_account_nama = 8830713132;
        $referenceID = 12287;
        $referenceNomer = "5822so.1.473.2";


        $this->db->trans_start();


        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
            "description" => "pemindahan penerimaan penjualan tunai ke uang muka tana ppn pada tgl 01 feb 2024 konsumen ISHWAR MANWANI",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );

        $harga_pokok = 0;
        $persediaan_produk = 0;
        $hutang_ke_pusat = 0;
        $piutang_cabang = 0;
        $laba_lain_lain = 0;
        $hutang_dagang = 0;

        $detailGate = array();
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $total_nilai = 0;
            $arrProdukDatas = array();
            $arrprodukIDs = array(
                "12287" => array(
                    "hpp" => "110268000",
                    "harga" => "110268000",
                    "jml" => "1",
                    "qty" => "1",
                    "nomer" => "5822so.1.473.2",
                    "nama" => "5822so.1.473.2",
                    "name" => "5822so.1.473.2",
                ),
            );
            $arrprodukIDKey = array_keys($arrprodukIDs);
            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                $pr = New MdlProduk2();
                $pr->addFilter("id in ('" . implode("','", $arrprodukIDKey) . "')");
                $prTmp = $pr->lookupAll()->result();
                showLast_query("biru");
                foreach ($prTmp as $prSpec) {
                    $arrProdukDatas[$prSpec->id] = $prSpec;
                }
                foreach ($arrProdukDatas as $pid => $specc) {
                    $pnama = $specc->nama;
                    $kode = $specc->kode;
                    $barcode = $specc->barcode;
                    $satuan = $specc->satuan;
                    $jml = $arrprodukIDs[$pid]["jml"];
                    $qty = $arrprodukIDs[$pid]["qty"];
                    $hpp = $arrprodukIDs[$pid]["hpp"];
                    $harga = $arrprodukIDs[$pid]["harga"];
//                $sub_hpp = $hpp * $jml;
//                $sub_harga = $harga * $jml;
                    $sub_hpp = $hpp * 10;
                    $sub_harga = $harga * 10;
                    $total_nilai += $sub_hpp;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $harga,
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => $pnama,
                        "kode" => $kode,
                        "barcode" => $barcode,
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $qty,
                        "name" => $pnama,
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }
            else {
                // kalau transaksi detailnya
                foreach ($arrprodukIDs as $pid => $specc) {
                    $sub_hpp = $specc["jml"] * $specc["hpp"];
                    $sub_harga = $specc["jml"] * $specc["harga"];
                    $total_nilai += $sub_harga;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $specc["jml"],
                        "harga" => $specc["harga"],
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $specc["hpp"],
                        "nama" => $specc["nama"],
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $specc["qty"],
                        "name" => $specc["name"],
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }

            //region 1 produk
            $mainHarga = $total_nilai;
            $harga_pokok = 0;
            $persediaan_produk = 0;
            $hutang_dagang = 0;
            $hutang_dagang_detail_1 = 0;
            $hutang_dagang_detail_2 = 0;
            $hutang_ke_pusat = $total_nilai;
            $piutang_cabang = $total_nilai;
            $laba_lain_lain = 0;
            $ppn_masukan = 0;
            $modal = 0;
            $kas = $total_nilai;
            $kas_minus = $total_nilai;
            $hutang_ke_konsumen = $total_nilai;
            $hutang_ke_konsumen_noppn = $total_nilai;

//            $detailGate = array(
//                "$itemID" => array(
//                    "handler" => "opname/_processSelectProduct",
//                    "id" => $itemID,
//                    "jml" => $itemJml,
//                    "harga" => $itemHarga,
//                    "subtotal" => 33,
//                    "satuan" => "gram",
//                    "discount_persen" => 0,
//                    "discount_qty" => 0,
//                    "hpp" => $itemHarga,
//                    "nama" => "$itemNama",
//                    "kode" => "",
//                    "barcode" => "",
//                    "no_part" => 0,
//                    "label" => "",
//                    "ppn" => 3,
//                    "stok" => 26750,
//                    "debet" => 0,
//                    "kredit" => 0,
//                    "qty_selisih" => 0,
//                    "qty" => $itemJml,
//                    "name" => "$itemNama",
//                    "sub_harga" => $itemSubHarga,
//                    "sub_subtotal" => $itemSubHarga,
//                    "sub_discount_persen" => 0,
//                    "sub_discount_qty" => 0,
//                    "sub_hpp" => $itemSubHarga,
//                    "sub_no_part" => 0,
//                    "sub_ppn" => 0,
//                    "sub_stok" => 0,
//                    "sub_debet" => 0,
//                    "sub_kredit" => 0,
//                    "sub_qty_selisih" => 0,
//
//                    "next_substep_code" => $jenis,
//                    "next_subgroup_code" => "o_holding",
//                    "sub_step_number" => 1,
//                    "sub_step_current" => 1,
//                ),
////                "$item2ID" => array(
////                    "handler" => "opname/_processSelectProduct",
////                    "id" => $item2ID,
////                    "jml" => $item2Jml,
////                    "harga" => $item2Harga,
////                    "subtotal" => 33,
////                    "satuan" => "gram",
////                    "discount_persen" => 0,
////                    "discount_qty" => 0,
////                    "hpp" => $item2Harga,
////                    "nama" => "TELUR",
////                    "kode" => "",
////                    "barcode" => "TEL01",
////                    "no_part" => 0,
////                    "label" => "",
////                    "ppn" => 3,
////                    "stok" => 26750,
////                    "debet" => 0,
////                    "kredit" => 0,
////                    "qty_selisih" => 0,
////                    "qty" => $item2Jml,
////                    "name" => "TELUR",
////                    "sub_harga" => $item2SubHarga,
////                    "sub_subtotal" => $item2SubHarga,
////                    "sub_discount_persen" => 0,
////                    "sub_discount_qty" => 0,
////                    "sub_hpp" => $item2SubHarga,
////                    "sub_no_part" => 0,
////                    "sub_ppn" => 0,
////                    "sub_stok" => 0,
////                    "sub_debet" => 0,
////                    "sub_kredit" => 0,
////                    "sub_qty_selisih" => 0,
////
////                    "next_substep_code" => $jenis,
////                    "next_subgroup_code" => "o_holding",
////                    "sub_step_number" => 1,
////                    "sub_step_current" => 1,
////                ),
//            );
            foreach ($detailGate as $pid => $spec) {
                foreach ($mainGate as $key => $val) {
                    $spec[$key] = $val;
                }

//                $spec["produk_qty_item"] = -$spec["jml"];
//                $spec["produk_nilai_item"] = $spec["harga"];
//                $spec["produk_nilai_minus_item"] = $spec["harga"];
//                $spec["persediaan_produk_item"] = -$spec["sub_harga"];
                $detailGate[$pid] = $spec;

                foreach ($tableIn["detail"] as $ikey => $ival) {
                    $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                }
            }
            //endregion
        }
        else {
            // region multi produk
            $itemID_blacklist = array("50648");
            $selected_jenis = array(
//                "759",
                "1119",
            );

            // tabel hpp avg > jual
            $pid_avg = array();
            $p_avg = $this->db->get("fifo_avg_sementara")->result();
            foreach ($p_avg as $pSpec) {
                $pid_avg[$pSpec->produk_id] = $pSpec->produk_id;
            }


            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek_avg_fifo = $this->db->get("fifo_avg")->result();
            $p_rek_avg_fifo_hpp = array();
            foreach ($p_rek_avg_fifo as $pSpec) {
                $p_rek_avg_fifo_hpp[$pSpec->produk_id] = $pSpec->hpp;
            }
//arrPrint($p_rek_avg_fifo_hpp);

            // tabel rek pembantu produk
            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
                "jenis" => "759",
//                "jenis" => "1119",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek = $this->db->get("__rek_pembantu_produk__1010030")->result();
            showLast_query("biru");
            $p_rek_salah = array();
            foreach ($p_rek as $pSpec) {
                $p_rek_salah[$pSpec->produk_id]["produk_id"] = $pSpec->produk_id;
                $p_rek_salah[$pSpec->produk_id]["produk_nama"] = $pSpec->produk_nama;
                $p_rek_salah[$pSpec->produk_id]["hpp_avg"] = $pSpec->harga;


                if (!isset($p_rek_salah[$pSpec->produk_id]["qty"])) {
                    $p_rek_salah[$pSpec->produk_id]["qty"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_kredit;
//                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_debet;


                if (!isset($p_rek_salah[$pSpec->produk_id]["nilai"])) {
                    $p_rek_salah[$pSpec->produk_id]["nilai"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->kredit;
//                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->debet;

            }
//            arrPrintPink($p_rek_salah);
            foreach ($p_rek_salah as $pid => $pSpec) {
                $nama = $pSpec["produk_nama"];
                if (!in_array($pSpec['produk_id'], $itemID_blacklist)) {
                    $jml = $pSpec["qty"];
//                    $nilai = $pSpec["nilai"];
//                    $hpp = $nilai/$jml;
//                    $hpp = $pSpec["hpp_avg"];
                    $hpp = $p_rek_avg_fifo_hpp[$pid];
                    $nilai = $pSpec["qty"] * $hpp;

                    $persediaan_produk += $nilai;
                    $harga_pokok += $nilai;
//                    $laba_lain_lain += $nilai;

                    $detailGate[$pid] = array(
                        //region detail/items
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $hpp,
                        "subtotal" => 33,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => "$nama",
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 3,
                        "stok" => 26750,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $jml,
                        "name" => "$nama",
                        "sub_harga" => $nilai,
                        "sub_subtotal" => $nilai,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $nilai,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                        //endregion

                        "produk_qty_item" => -$jml,
                        "produk_nilai_item" => $hpp,
                        "produk_nilai_minus_item" => $hpp,
                        "persediaan_produk_item" => -$nilai,
                    );
                    foreach ($detailGate as $pid => $spec) {
                        foreach ($mainGate as $key => $val) {
                            $spec[$key] = $val;
                        }
                        $detailGate[$pid] = $spec;
                        foreach ($tableIn["detail"] as $ikey => $ival) {
                            $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                        }
                    }
                }
            }
//            mati_disini(__LINE__);


            // endregion multi produk
        }


        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }


        $mainGate["hpp"] = -$harga_pokok;
        $mainGate["persediaan_produk"] = -$persediaan_produk;
        $mainGate["hutang_ke_pusat"] = $hutang_ke_pusat;
        $mainGate["piutang_cabang_minus_3"] = $piutang_cabang;
        $mainGate["laba_lain_lain"] = $laba_lain_lain;
        $mainGate["hutang_dagang"] = -$hutang_dagang;
        $mainGate["hutang_dagang_detail_1"] = $hutang_dagang_detail_1;
        $mainGate["hutang_dagang_detail_2"] = -$hutang_dagang_detail_2;
        $mainGate["modal"] = -$modal;
        $mainGate["ppn_masukan"] = $ppn_masukan;
        $mainGate["kas"] = $kas;
        $mainGate["kas_minus"] = -$kas_minus;
        $mainGate["hutang_ke_konsumen"] = -$hutang_ke_konsumen;
        $mainGate["hutang_ke_konsumen_noppn"] = $hutang_ke_konsumen_noppn;
        arrPrintHijau($mainGate);
        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;

        //--------------------------
        $preProcessor = array(
            "master" => array(),
            "detail" => array(
                array(
                    "comName" => "FifoAverage",
                    "loop" => array(),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "produk_qty" => "qty_kredit",
                        "gudang_id" => "gudangID",
                        "toko_id" => "tokoID",
                        "toko_nama" => "tokoName",
                    ),
                    "resultParams" => array(
//                        "items" => array(
//                            "kredit_rsltItems" => "hpp",
//                        ),
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );
        $components = array(
            "master" => array(
//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
////                        "1010030030" => "persediaan_produk",
////                        "3010020" => "modal", // hutang dagang
////                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
////                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
////                        "5010" => "hpp", // hpp
////                        "1010040050" => "ppn_masukan", // ppn masukan
//
//                        //-------------------
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
////                        "1010030030" => "persediaan_produk",
////                        "3010020" => "modal", // hutang dagang
////                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
////                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
////                        "5010" => "hpp", // hpp
////                        "1010040050" => "ppn_masukan", // ppn masukan
//
//                        //-------------------
//                        "1010060010" => "piutang_cabang_minus_3", // piutang cabang dagang
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu antarcabang (pusat)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "1010060010" => "piutang_cabang_minus_3",
//                    ),
//                    "static" => array(
//                        "cabang_id" => ".-1",
//                        "cabang2_id" => "cabang2ID",
//                        "cabang2_nama" => "cabang2Name",
//                        "extern_id" => "cabangID",
//                        "extern_nama" => "cabangName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu hutang ke supplier (pusat)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//
//
//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu antarcabang (caabng)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "2040010" => "hutang_ke_pusat",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "cabang2_id" => "placeID",
//                        "cabang2_nama" => "placeName",
//                        "extern_id" => "cabang2ID",
//                        "extern_nama" => "cabang2Name",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//

                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // hutang ke konsumen, penjualan tunai
                array(
                    "comName" => "RekeningPembantuCustomer",
                    "loop" => array(
                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => ".2010050010",// uang muka konsumen
                        "extern_nama" => ".Uang Muka Konsumen",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                // hutang ke konsumen, penjualan tunai, per-konsumen
                array(
                    "comName" => "RekeningPembantuCustomerDetail",
                    "loop" => array(
                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "extern2_id" => ".2010050010",// uang muka konsumen
                        "extern2_nama" => ".Uang Muka Konsumen",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

                // hutang ke konsumen, penjualan tunai
                array(
                    "comName" => "RekeningPembantuCustomer",
                    "loop" => array(
                        "2010050" => "hutang_ke_konsumen_noppn", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => ".2010050050",// uang muka konsumen
                        "extern_nama" => ".Uang Muka Konsumen tanpa ppn",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                // hutang ke konsumen, penjualan tunai, per-konsumen
                array(
                    "comName" => "RekeningPembantuCustomerDetail",
                    "loop" => array(
                        "2010050" => "hutang_ke_konsumen_noppn", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "extern2_id" => ".2010050050",// uang muka konsumen
                        "extern2_nama" => ".Uang Muka Konsumen tanpa ppn",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),


                // JURNAL 2
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan plus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_j_2",
//                        "hpp" => "persediaan_j_2",
//                        "produk_nilai" => "persediaan_j_2",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan minus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_minus_item", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_produk_minus_item",
//                        "hpp" => "persediaan_produk_minus_item",
//                        "produk_nilai" => "persediaan_produk_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail laba lain-lain
//                array(
//                    "comName" => "RekeningPembantuLRLainlain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".7010150",
//                        "extern_nama" => ".laba lain lain",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail kerugian
//                array(
//                    "comName" => "RekeningPembantuKerugian",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".702020",
//                        "extern_nama" => ".kerugian stok opname",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw laba lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7010150",//lokal ,non lokal
//                        "extern_nama" => ".laba lain lain",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jml" => ".0",
//                        "harga" => "laba_lain_lain",
//                        "hpp" => "laba_lain_lain",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw rugi lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7020020",//lokal ,non lokal
//                        "extern_nama" => ".kerugian stok opname",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7020020",
//                        "produk_nama" => ".kerugian stok opname",
//                        "jml" => ".0",
//                        "harga" => "kerugian_minus_minus_item",
//                        "hpp" => "kerugian_minus_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //rekening pembantu hpp harga pokok produk
//                array(
//                    "comName" => "RekeningPembantuHpp",
//                    "loop" => array(
//                        "5010" => "hpp", // hpp
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".5010010",//
//                        "extern_nama" => ".lokal",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "harga" => "hpp",
//                        "hpp" => "hpp",
//                        "produk_nilai" => "hpp",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang dagang
//                array(
//                    "comName" => "RekeningPembantHutangUsaha",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "extern_nama" => ".hutang usaha",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "produk_nama" => ".hutang dagang",
//                        "jml" => ".1",
//                        "harga" => "hutang_dagang",
//                        "produk_nilai" => "hutang_dagang",
//                        "hpp" => "hutang_dagang",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "0leh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010010010",
//                        "extern_nama" => ".lokal",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => "pihakID",
//                        "produk_nama" => "pihakName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "1010040050" => "ppn_masukan", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_1", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_2", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplier2ID",
//                        "extern_nama" => "supplier2Nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

            ),
            "detail" => array(
                // pembantu produk minus

//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_minus_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),


                // pembantu produk tambah
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".1010030030",
//                        "extern_nama" => ".persediaan produk",
//                        "produk_id" => "id",
//                        "produk_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

            ),
        );
        $postProcessor = array(
            "master" => array(),
            "detail" => array(
//                array(
//                    "comName" => "FifoAverage",
//                    "loop" => array(),
//                    "static" => array(
//                        "jenis" => ".produk",
//                        "jml" => "qty_debet",
//                        "produk_id" => "id",
//                        "hpp" => "hpp",
//                        "jml_nilai" => "sub_debet",
//                        "nama" => "name",
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                    array(
//                        "comName" => "LockerStock",
//                        "loop" => array(),
//                        "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
//                            "cabang_id" => "placeID",
//                            "jenis" => ".produk",
//                            "state" => ".active",
//                            "jumlah" => "qty_debet",
//                            "produk_id" => "id",
//                            "nama" => "name",
//                            "satuan" => "satuan",
//                            "transaksi_id" => ".0",
//                            "oleh_id" => ".0",
//                            "gudang_id" => "gudangID",
//                        ),
//                        "srcGateName" => "items",
//                        "srcRawGateName" => "items",
//                    ),

                array(
                    "comName" => "LockerStock",
                    "loop" => array(),
                    "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
                        "cabang_id" => "placeID",
                        "jenis" => ".produk",
                        "state" => ".active",
                        "jumlah" => "-qty",
                        "produk_id" => "id",
                        "nama" => "name",
                        "satuan" => "satuan",
                        "transaksi_id" => ".0",
                        "oleh_id" => ".0",
                        "gudang_id" => "gudangID",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

            ),
        );
        //--------------------------


        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }

//        mati_disini(__LINE__);

        // PRE-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            // PRE-PROCC (karena mengeluarkan stok)
            //region pre-processors (item)
            $iterator = $preProcessor["detail"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                cekHere("ITEM NUM LABELS");
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        cekHere("sub-preproc: $comName, initializing values <br>");
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                cekHere("sub preproc #: $comName, sending values " . __LINE__ . "<br>");

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);

                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();
                                    // arrPrintWebs($gotParams);
                                    // matiHEre(__LINE__);
                                    // cekmerah("gotparams dari pre-proc $comName");
                                    // arrPrint($gotParams);
                                    // matiHEre();
                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            // arrPrint($paramSpec);
                                            // cekHitam($gateName);
                                            // cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($this->cCodeData[$cCode][$gateName])) {
                                                $this->cCodeData[$cCode][$gateName] = array();
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }
                                            // matiHEre($cCode);
                                            foreach ($paramSpec as $id => $gSpec) {
                                                if (!isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    $this->cCodeData[$cCode][$gateName][$id] = array();
                                                }
                                                if (isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        // matiHEre("ada");
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val " . __LINE__);
                                                            $this->cCodeData[$cCode][$gateName][$id][$key] = $val;
                                                            cekMerah($cCode . "[" . $gateName . "][" . $id . "][" . $key . "]=" . $val);
                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                if (isset($this->cCodeData[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {

                                                        foreach ($gSpec as $key => $val) {
                                                            $this->cCodeData[$cCode][$srcGateName][$id][$key] = $val;

                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                if (sizeof($itemNumLabels) > 0) {
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        if (isset($this->cCodeData[$cCode][$gateName][$id][$key])) {
                                                            $this->cCodeData[$cCode][$gateName][$id]['sub_' . $key] = ($this->cCodeData[$cCode][$gateName][$id]['jml'] * $this->cCodeData[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }
                                // matiHEre(__LINE__);
                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                // arrprintWebs($this->cCodeData[$cCode]);

                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $this->cCodeData[$cCode]["revert"]["preProc"]["replacer"];
                    $tempCalculate = array(
                        "selisih" => ($this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"]) - ($this->cCodeData[$cCode]["main"]["nett"] + $this->cCodeData[$cCode]["main"]["ppv"]),
                        "hpp_nppv" => $this->cCodeData[$cCode]["main"]["hpp"],
                        "hpp_nppn" => $this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"],
                    );
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $this->cCodeData[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }
                }
                //endregion
            }
            else {
                cekHitam("no sub-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //region pre-processors (master)
            $iterator = $preProcessor["master"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $this->cCodeData[$cCode]["main"], $this->cCodeData[$cCode]["main"], 0);
                                $subParams['static'][$key] = $realValue;
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = "";
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);

                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //==inject gotParams to child gate
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($this->cCodeData[$cCode]["main"][$key])) {
                                                $this->cCodeData[$cCode]["main"]['sub_' . $key] = ($this->cCodeData[$cCode]["main"]['jml'] * $this->cCodeData[$cCode]["main"][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
            }
            else {
                cekHitam("no main-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }

                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->configUiModul[$this->jenisTr]["steps"][$stepNum]["label"] . " nomor " . $tmpNomorNota . " oleh " . $this->cCodeData[$cCode]["tableIn_master"]['oleh_nama'];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }

        // POST-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            //region processing sub-post-processors, always
            $iterator = $postProcessor["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>");
                    $tmpOutParams[$cCtr] = array();
                    if (isset($this->cCodeData[$cCode][$srcGateName]) && (sizeof($this->cCodeData[$cCode][$srcGateName]) > 0)) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($this->cCodeData[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $this->cCodeData[$cCode]["main"]['pihakExternID'];
                                }
                                $subParams['static']["keterangan"] = "";
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($this->cCodeData[$cCode][$srcGateName])) {
                        cekHere("[$cCtr] sub-postProcessor: $comName, sending values " . __LINE__ . "<br>");
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekHitam($this->db->last_query());
                    }
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP SUB-POSTPROC");
            }
            //endregion

            //region processing main-post-processors, always
            $iterator = $postProcessor["master"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("post-processor: $comName<br>LINE: " . __LINE__);

                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }
                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = "";
                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP MAIN-POSTPROC");
            }
            //endregion
        }

        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (isset($core['components']) && sizeof($core['components'])) {
                $jurnalIndex = $core['components'];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //------------
            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
            }
            else {
                $coreBuilder = array();
            }
            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");

        }
        //endregion

//        mati_disini(__LINE__);

        $this->load->model("Coms/ComRekeningPembantuProduk");

        foreach ($arrprodukIDs as $pid => $pSpec) {
            $itemID = $pid;
            $crd = New ComRekeningPembantuProduk();
            $crd->addFilter("gudang_id='$gudangID'");
            $crd->addFilter("cabang_id='$cabangID'");
            $crd->addFilter("extern_id='$itemID'");
            $crd->addFilter("periode='forever'");
            $crdTmp = $crd->lookupAll()->result();
            showLast_query("biru");
            cekBiru(count($crdTmp));
            if (sizeof($crdTmp) > 0) {
                $qty = $crdTmp[0]->qty_debet;
                $debet = $crdTmp[0]->debet;
                $avg = ($qty > 0) ? $debet / $qty : 0;

                $this->load->model("Mdls/MdlFifoAverage");
                $ff = New MdlFifoAverage();
                $ff->addFilter("jenis='produk'");
                $ff->addFilter("produk_id='$itemID'");
                $ff->addFilter("cabang_id='$cabangID'");
                $ff->addFilter("gudang_id='$gudangID'");
                $ffTmp = $ff->lookupAll()->result();
                showLast_query("biru");
                if (sizeof($ffTmp) > 0) {
                    $id_tbl = $ffTmp[0]->id;
                    $where = array(
                        "id" => $id_tbl
                    );
                    $data = array(
                        "jml" => $qty,
                        "hpp" => $avg,
                        "jml_nilai" => $debet,
                    );
                    $ff->updateData($where, $data);
                    showLast_query("orange");
                }

            }

        }


        cekMerah(":: cek validate lajur di " . __FUNCTION__ . ", " . __FILE__);
        validateAllBalances($cabangID);


        mati_disini("---SETOP--- " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");
    }


    //-------------------------------------------
    public function koreksiPiutangDagang()
    {
        $starttime = microtime(true);
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlProduk2");
        $this->load->model("Coms/ComRekeningPembantuCustomer");


        // load transaksi opname, mengambil data yang akan dieksekusi
        $cabangID = "1";
        $cabangNama = "cabang 1";
        $gudangID = "-10";
        $gudangNama = "default warehouse at branch #1";
        $cabang2ID = "-1";
        $cabang2Nama = "pusat dc";
        $gudang2ID = "-1";
        $gudang2Nama = "default warehouse at branch #-1";

        $olehID = "100";
        $olehNama = "system";
//        $tokoID = "1001";
//        $tokoNama = "JODOMART";
//        $supplierID = "13";
//        $supplierNama = "CV MULIA ABADI";
//        $supplier2ID = "32";
//        $supplier2Nama = "PT. SEDAYU";
//        $pihakID = "1";
//        $pihakNama = "CABANG 1";
        $pihakID = "0";
        $pihakNama = "";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $cash_account = 0;
        $cash_account_nama = "";
        $referenceID = 0;
        $referenceNomer = "";


        $this->db->trans_start();


        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
            "description" => "pemindahan rekening piutang usaha dari pusat ke cabang (sumber pemindahbukuan)",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );

        $harga_pokok = 0;
        $persediaan_produk = 0;
        $hutang_ke_pusat = 0;
        $piutang_cabang = 0;
        $laba_lain_lain = 0;
        $hutang_dagang = 0;

        $detailGate = array();
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $total_nilai = 0;
            $piutang_ini = 1;
            if ($piutang_ini == 1) {
                $rekening = "1010020010";
                $crc = New ComRekeningPembantuCustomer();
                $crc->addFilter("cabang_id='$cabang2ID'");
                $crcTmp = $crc->fetchBalances($rekening);
                showLast_query("biru");
                cekHere(sizeof($crcTmp));
                if (sizeof($crcTmp) > 0) {
                    foreach ($crcTmp as $crcSpec) {
//                        arrPrintWebs($crcSpec);
                        $customer_id = $crcSpec->extern_id;
                        $customer_nama = $crcSpec->extern_nama;
                        $debet = $crcSpec->debet;
                        $total_nilai += $debet;
                        $detailGate[$customer_id] = array(
                            "handler" => "opname/_processSelectProduct",
                            "id" => $customer_id,
                            "jml" => 1,
                            "harga" => $debet,
                            "subtotal" => 0,
                            "satuan" => "gram",
                            "discount_persen" => 0,
                            "discount_qty" => 0,
                            "hpp" => $debet,
                            "nama" => $customer_nama,
                            "kode" => "",
                            "barcode" => "",
                            "no_part" => 0,
                            "label" => "",
                            "ppn" => 0,
                            "stok" => 0,
                            "debet" => 0,
                            "kredit" => 0,
                            "qty_selisih" => 0,
                            "qty" => 1,
                            "name" => $customer_nama,
                            "sub_harga" => $debet,
                            "sub_subtotal" => $debet,
                            "sub_discount_persen" => 0,
                            "sub_discount_qty" => 0,
                            "sub_hpp" => $debet,
                            "sub_no_part" => 0,
                            "sub_ppn" => 0,
                            "sub_stok" => 0,
                            "sub_debet" => 0,
                            "sub_kredit" => 0,
                            "sub_qty_selisih" => 0,

                            "next_substep_code" => $jenis,
                            "next_subgroup_code" => "o_holding",
                            "sub_step_number" => 1,
                            "sub_step_current" => 1,
                        );

//                        break;
                    }
                }
            }
            else {
                $arrProdukDatas = array();
                $arrprodukIDs = array(
                    "12287" => array(
                        "hpp" => "110268000",
                        "harga" => "110268000",
                        "jml" => "1",
                        "qty" => "1",
                        "nomer" => "5822so.1.473.2",
                        "nama" => "5822so.1.473.2",
                        "name" => "5822so.1.473.2",
                    ),
                );
                $arrprodukIDKey = array_keys($arrprodukIDs);
                $pakai_ini = 0;
                if ($pakai_ini == 1) {
                    $pr = New MdlProduk2();
                    $pr->addFilter("id in ('" . implode("','", $arrprodukIDKey) . "')");
                    $prTmp = $pr->lookupAll()->result();
                    showLast_query("biru");
                    foreach ($prTmp as $prSpec) {
                        $arrProdukDatas[$prSpec->id] = $prSpec;
                    }
                    foreach ($arrProdukDatas as $pid => $specc) {
                        $pnama = $specc->nama;
                        $kode = $specc->kode;
                        $barcode = $specc->barcode;
                        $satuan = $specc->satuan;
                        $jml = $arrprodukIDs[$pid]["jml"];
                        $qty = $arrprodukIDs[$pid]["qty"];
                        $hpp = $arrprodukIDs[$pid]["hpp"];
                        $harga = $arrprodukIDs[$pid]["harga"];
//                $sub_hpp = $hpp * $jml;
//                $sub_harga = $harga * $jml;
                        $sub_hpp = $hpp * 10;
                        $sub_harga = $harga * 10;
                        $total_nilai += $sub_hpp;
                        $detailGate[$pid] = array(
                            "handler" => "opname/_processSelectProduct",
                            "id" => $pid,
                            "jml" => $jml,
                            "harga" => $harga,
                            "subtotal" => 0,
                            "satuan" => "gram",
                            "discount_persen" => 0,
                            "discount_qty" => 0,
                            "hpp" => $hpp,
                            "nama" => $pnama,
                            "kode" => $kode,
                            "barcode" => $barcode,
                            "no_part" => 0,
                            "label" => "",
                            "ppn" => 0,
                            "stok" => 0,
                            "debet" => 0,
                            "kredit" => 0,
                            "qty_selisih" => 0,
                            "qty" => $qty,
                            "name" => $pnama,
                            "sub_harga" => $sub_harga,
                            "sub_subtotal" => $sub_harga,
                            "sub_discount_persen" => 0,
                            "sub_discount_qty" => 0,
                            "sub_hpp" => $sub_hpp,
                            "sub_no_part" => 0,
                            "sub_ppn" => 0,
                            "sub_stok" => 0,
                            "sub_debet" => 0,
                            "sub_kredit" => 0,
                            "sub_qty_selisih" => 0,

                            "next_substep_code" => $jenis,
                            "next_subgroup_code" => "o_holding",
                            "sub_step_number" => 1,
                            "sub_step_current" => 1,
                        );
                    }
                }
                else {
                    // kalau transaksi detailnya
                    foreach ($arrprodukIDs as $pid => $specc) {
                        $sub_hpp = $specc["jml"] * $specc["hpp"];
                        $sub_harga = $specc["jml"] * $specc["harga"];
                        $total_nilai += $sub_harga;
                        $detailGate[$pid] = array(
                            "handler" => "opname/_processSelectProduct",
                            "id" => $pid,
                            "jml" => $specc["jml"],
                            "harga" => $specc["harga"],
                            "subtotal" => 0,
                            "satuan" => "gram",
                            "discount_persen" => 0,
                            "discount_qty" => 0,
                            "hpp" => $specc["hpp"],
                            "nama" => $specc["nama"],
                            "kode" => "",
                            "barcode" => "",
                            "no_part" => 0,
                            "label" => "",
                            "ppn" => 0,
                            "stok" => 0,
                            "debet" => 0,
                            "kredit" => 0,
                            "qty_selisih" => 0,
                            "qty" => $specc["qty"],
                            "name" => $specc["name"],
                            "sub_harga" => $sub_harga,
                            "sub_subtotal" => $sub_harga,
                            "sub_discount_persen" => 0,
                            "sub_discount_qty" => 0,
                            "sub_hpp" => $sub_hpp,
                            "sub_no_part" => 0,
                            "sub_ppn" => 0,
                            "sub_stok" => 0,
                            "sub_debet" => 0,
                            "sub_kredit" => 0,
                            "sub_qty_selisih" => 0,

                            "next_substep_code" => $jenis,
                            "next_subgroup_code" => "o_holding",
                            "sub_step_number" => 1,
                            "sub_step_current" => 1,
                        );
                    }
                }
            }

            //region detail
            $mainHarga = $total_nilai;
            $harga_pokok = 0;
            $persediaan_produk = 0;
            $hutang_dagang = 0;
            $hutang_dagang_detail_1 = 0;
            $hutang_dagang_detail_2 = 0;
            $hutang_ke_pusat = $total_nilai;
            $piutang_cabang = $total_nilai;
            $piutang_konsumen = $total_nilai;
            $piutang_konsumen_minus = $total_nilai;
            $laba_lain_lain = 0;
            $ppn_masukan = 0;
            $modal = 0;
            $kas = 0;
            $kas_minus = 0;
            $hutang_ke_konsumen = 0;
            $hutang_ke_konsumen_noppn = 0;

            foreach ($detailGate as $pid => $spec) {
                foreach ($mainGate as $key => $val) {
                    $spec[$key] = $val;
                }

//                $spec["produk_qty_item"] = -$spec["jml"];
//                $spec["produk_nilai_item"] = $spec["harga"];
//                $spec["produk_nilai_minus_item"] = $spec["harga"];
                $spec["piutang_konsumen"] = $spec["sub_harga"];
                $spec["piutang_konsumen_minus"] = -$spec["sub_harga"];
                $detailGate[$pid] = $spec;

                foreach ($tableIn["detail"] as $ikey => $ival) {
                    $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                }
            }
            //endregion
        }
        else {
            // region multi produk
            $itemID_blacklist = array("50648");
            $selected_jenis = array(
//                "759",
                "1119",
            );

            // tabel hpp avg > jual
            $pid_avg = array();
            $p_avg = $this->db->get("fifo_avg_sementara")->result();
            foreach ($p_avg as $pSpec) {
                $pid_avg[$pSpec->produk_id] = $pSpec->produk_id;
            }


            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek_avg_fifo = $this->db->get("fifo_avg")->result();
            $p_rek_avg_fifo_hpp = array();
            foreach ($p_rek_avg_fifo as $pSpec) {
                $p_rek_avg_fifo_hpp[$pSpec->produk_id] = $pSpec->hpp;
            }
//arrPrint($p_rek_avg_fifo_hpp);

            // tabel rek pembantu produk
            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
                "jenis" => "759",
//                "jenis" => "1119",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek = $this->db->get("__rek_pembantu_produk__1010030")->result();
            showLast_query("biru");
            $p_rek_salah = array();
            foreach ($p_rek as $pSpec) {
                $p_rek_salah[$pSpec->produk_id]["produk_id"] = $pSpec->produk_id;
                $p_rek_salah[$pSpec->produk_id]["produk_nama"] = $pSpec->produk_nama;
                $p_rek_salah[$pSpec->produk_id]["hpp_avg"] = $pSpec->harga;


                if (!isset($p_rek_salah[$pSpec->produk_id]["qty"])) {
                    $p_rek_salah[$pSpec->produk_id]["qty"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_kredit;
//                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_debet;


                if (!isset($p_rek_salah[$pSpec->produk_id]["nilai"])) {
                    $p_rek_salah[$pSpec->produk_id]["nilai"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->kredit;
//                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->debet;

            }
//            arrPrintPink($p_rek_salah);
            foreach ($p_rek_salah as $pid => $pSpec) {
                $nama = $pSpec["produk_nama"];
                if (!in_array($pSpec['produk_id'], $itemID_blacklist)) {
                    $jml = $pSpec["qty"];
//                    $nilai = $pSpec["nilai"];
//                    $hpp = $nilai/$jml;
//                    $hpp = $pSpec["hpp_avg"];
                    $hpp = $p_rek_avg_fifo_hpp[$pid];
                    $nilai = $pSpec["qty"] * $hpp;

                    $persediaan_produk += $nilai;
                    $harga_pokok += $nilai;
//                    $laba_lain_lain += $nilai;

                    $detailGate[$pid] = array(
                        //region detail/items
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $hpp,
                        "subtotal" => 33,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => "$nama",
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 3,
                        "stok" => 26750,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $jml,
                        "name" => "$nama",
                        "sub_harga" => $nilai,
                        "sub_subtotal" => $nilai,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $nilai,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                        //endregion

                        "produk_qty_item" => -$jml,
                        "produk_nilai_item" => $hpp,
                        "produk_nilai_minus_item" => $hpp,
                        "persediaan_produk_item" => -$nilai,
                    );
                    foreach ($detailGate as $pid => $spec) {
                        foreach ($mainGate as $key => $val) {
                            $spec[$key] = $val;
                        }
                        $detailGate[$pid] = $spec;
                        foreach ($tableIn["detail"] as $ikey => $ival) {
                            $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                        }
                    }
                }
            }
//            mati_disini(__LINE__);


            // endregion multi produk
        }

//        arrPrintHijau($detailGate);
//        mati_disini(__LINE__);

        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }


        $mainGate["hpp"] = -$harga_pokok;
        $mainGate["persediaan_produk"] = -$persediaan_produk;
        $mainGate["hutang_ke_pusat"] = $hutang_ke_pusat;
        $mainGate["piutang_cabang_minus_3"] = $piutang_cabang;
        $mainGate["piutang_konsumen"] = $piutang_konsumen;
        $mainGate["piutang_konsumen_minus"] = -$piutang_konsumen_minus;
        $mainGate["laba_lain_lain"] = $laba_lain_lain;
        $mainGate["hutang_dagang"] = -$hutang_dagang;
        $mainGate["hutang_dagang_detail_1"] = $hutang_dagang_detail_1;
        $mainGate["hutang_dagang_detail_2"] = -$hutang_dagang_detail_2;
        $mainGate["modal"] = -$modal;
        $mainGate["ppn_masukan"] = $ppn_masukan;
        $mainGate["kas"] = $kas;
        $mainGate["kas_minus"] = -$kas_minus;
        $mainGate["hutang_ke_konsumen"] = -$hutang_ke_konsumen;
        $mainGate["hutang_ke_konsumen_noppn"] = $hutang_ke_konsumen_noppn;
//        arrPrintHijau($mainGate);
        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;

        //--------------------------
        $preProcessor = array(
            "master" => array(),
            "detail" => array(
                array(
                    "comName" => "FifoAverage",
                    "loop" => array(),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "produk_qty" => "qty_kredit",
                        "gudang_id" => "gudangID",
                        "toko_id" => "tokoID",
                        "toko_nama" => "tokoName",
                    ),
                    "resultParams" => array(
//                        "items" => array(
//                            "kredit_rsltItems" => "hpp",
//                        ),
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );
        $components = array(
            "master" => array(
//                // JURNAL 1
                array(
                    "comName" => "Jurnal",
                    "loop" => array(
                        //-------------------
                        "1010060010" => "piutang_cabang_minus_3", // piutang cabang
                        "1010020010" => "piutang_konsumen_minus", // piutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "place2ID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                array(
                    "comName" => "Rekening",
                    "loop" => array(
                        //-------------------
                        "1010060010" => "piutang_cabang_minus_3", // piutang cabang
                        "1010020010" => "piutang_konsumen_minus", // piutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "place2ID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

//                //pembantu antarcabang (pusat)
                array(
                    "comName" => "RekeningPembantuAntarcabang",
                    "loop" => array(
                        "1010060010" => "piutang_cabang_minus_3",
                    ),
                    "static" => array(
                        "cabang_id" => ".-1",
                        "cabang2_id" => "cabang2ID",
                        "cabang2_nama" => "cabang2Name",
                        "extern_id" => "cabangID",
                        "extern_nama" => "cabangName",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

//                //pembantu hutang ke supplier (pusat)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//
//
//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // JURNAL 1
                array(
                    "comName" => "Jurnal",
                    "loop" => array(
                        //-------------------
                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
                        "1010020010" => "piutang_konsumen", // piutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                array(
                    "comName" => "Rekening",
                    "loop" => array(
                        //-------------------
                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
                        "1010020010" => "piutang_konsumen", // piutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                //pembantu antarcabang (caabng)
                array(
                    "comName" => "RekeningPembantuAntarcabang",
                    "loop" => array(
                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "cabang2_id" => "placeID",
                        "cabang2_nama" => "placeName",
                        "extern_id" => "cabang2ID",
                        "extern_nama" => "cabang2Name",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // hutang ke konsumen, penjualan tunai
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050010",// uang muka konsumen
//                        "extern_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // hutang ke konsumen, penjualan tunai, per-konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050010",// uang muka konsumen
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // hutang ke konsumen, penjualan tunai
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen_noppn", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050050",// uang muka konsumen
//                        "extern_nama" => ".Uang Muka Konsumen tanpa ppn",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // hutang ke konsumen, penjualan tunai, per-konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen_noppn", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050050",// uang muka konsumen
//                        "extern2_nama" => ".Uang Muka Konsumen tanpa ppn",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


                // JURNAL 2
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan plus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_j_2",
//                        "hpp" => "persediaan_j_2",
//                        "produk_nilai" => "persediaan_j_2",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan minus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_minus_item", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_produk_minus_item",
//                        "hpp" => "persediaan_produk_minus_item",
//                        "produk_nilai" => "persediaan_produk_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail laba lain-lain
//                array(
//                    "comName" => "RekeningPembantuLRLainlain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".7010150",
//                        "extern_nama" => ".laba lain lain",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail kerugian
//                array(
//                    "comName" => "RekeningPembantuKerugian",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".702020",
//                        "extern_nama" => ".kerugian stok opname",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw laba lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7010150",//lokal ,non lokal
//                        "extern_nama" => ".laba lain lain",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jml" => ".0",
//                        "harga" => "laba_lain_lain",
//                        "hpp" => "laba_lain_lain",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw rugi lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7020020",//lokal ,non lokal
//                        "extern_nama" => ".kerugian stok opname",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7020020",
//                        "produk_nama" => ".kerugian stok opname",
//                        "jml" => ".0",
//                        "harga" => "kerugian_minus_minus_item",
//                        "hpp" => "kerugian_minus_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //rekening pembantu hpp harga pokok produk
//                array(
//                    "comName" => "RekeningPembantuHpp",
//                    "loop" => array(
//                        "5010" => "hpp", // hpp
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".5010010",//
//                        "extern_nama" => ".lokal",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "harga" => "hpp",
//                        "hpp" => "hpp",
//                        "produk_nilai" => "hpp",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang dagang
//                array(
//                    "comName" => "RekeningPembantHutangUsaha",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "extern_nama" => ".hutang usaha",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "produk_nama" => ".hutang dagang",
//                        "jml" => ".1",
//                        "harga" => "hutang_dagang",
//                        "produk_nilai" => "hutang_dagang",
//                        "hpp" => "hutang_dagang",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "0leh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010010010",
//                        "extern_nama" => ".lokal",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => "pihakID",
//                        "produk_nama" => "pihakName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "1010040050" => "ppn_masukan", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_1", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_2", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplier2ID",
//                        "extern_nama" => "supplier2Nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

            ),
            "detail" => array(
                // pembantu produk minus

//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_minus_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // pembantu produk tambah
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".1010030030",
//                        "extern_nama" => ".persediaan produk",
//                        "produk_id" => "id",
//                        "produk_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // piutang konsumen pusat
                array(
                    "comName" => "RekeningPembantuCustomerItem",
                    "loop" => array(
                        "1010020010" => "piutang_konsumen_minus", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "place2ID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

                // piutang konsumen cabang
                array(
                    "comName" => "RekeningPembantuCustomerItem",
                    "loop" => array(
                        "1010020010" => "piutang_konsumen", // hutang ke konsumen
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),


            ),
        );
        $postProcessor = array(
            "master" => array(),
            "detail" => array(
//                array(
//                    "comName" => "FifoAverage",
//                    "loop" => array(),
//                    "static" => array(
//                        "jenis" => ".produk",
//                        "jml" => "qty_debet",
//                        "produk_id" => "id",
//                        "hpp" => "hpp",
//                        "jml_nilai" => "sub_debet",
//                        "nama" => "name",
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                    array(
//                        "comName" => "LockerStock",
//                        "loop" => array(),
//                        "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
//                            "cabang_id" => "placeID",
//                            "jenis" => ".produk",
//                            "state" => ".active",
//                            "jumlah" => "qty_debet",
//                            "produk_id" => "id",
//                            "nama" => "name",
//                            "satuan" => "satuan",
//                            "transaksi_id" => ".0",
//                            "oleh_id" => ".0",
//                            "gudang_id" => "gudangID",
//                        ),
//                        "srcGateName" => "items",
//                        "srcRawGateName" => "items",
//                    ),

                array(
                    "comName" => "LockerStock",
                    "loop" => array(),
                    "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
                        "cabang_id" => "placeID",
                        "jenis" => ".produk",
                        "state" => ".active",
                        "jumlah" => "-qty",
                        "produk_id" => "id",
                        "nama" => "name",
                        "satuan" => "satuan",
                        "transaksi_id" => ".0",
                        "oleh_id" => ".0",
                        "gudang_id" => "gudangID",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

            ),
        );
        //--------------------------


        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }

//        mati_disini(__LINE__);

        // PRE-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            // PRE-PROCC (karena mengeluarkan stok)
            //region pre-processors (item)
            $iterator = $preProcessor["detail"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                cekHere("ITEM NUM LABELS");
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        cekHere("sub-preproc: $comName, initializing values <br>");
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                cekHere("sub preproc #: $comName, sending values " . __LINE__ . "<br>");

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);

                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();
                                    // arrPrintWebs($gotParams);
                                    // matiHEre(__LINE__);
                                    // cekmerah("gotparams dari pre-proc $comName");
                                    // arrPrint($gotParams);
                                    // matiHEre();
                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            // arrPrint($paramSpec);
                                            // cekHitam($gateName);
                                            // cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($this->cCodeData[$cCode][$gateName])) {
                                                $this->cCodeData[$cCode][$gateName] = array();
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }
                                            // matiHEre($cCode);
                                            foreach ($paramSpec as $id => $gSpec) {
                                                if (!isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    $this->cCodeData[$cCode][$gateName][$id] = array();
                                                }
                                                if (isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        // matiHEre("ada");
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val " . __LINE__);
                                                            $this->cCodeData[$cCode][$gateName][$id][$key] = $val;
                                                            cekMerah($cCode . "[" . $gateName . "][" . $id . "][" . $key . "]=" . $val);
                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                if (isset($this->cCodeData[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {

                                                        foreach ($gSpec as $key => $val) {
                                                            $this->cCodeData[$cCode][$srcGateName][$id][$key] = $val;

                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                if (sizeof($itemNumLabels) > 0) {
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        if (isset($this->cCodeData[$cCode][$gateName][$id][$key])) {
                                                            $this->cCodeData[$cCode][$gateName][$id]['sub_' . $key] = ($this->cCodeData[$cCode][$gateName][$id]['jml'] * $this->cCodeData[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }
                                // matiHEre(__LINE__);
                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                // arrprintWebs($this->cCodeData[$cCode]);

                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $this->cCodeData[$cCode]["revert"]["preProc"]["replacer"];
                    $tempCalculate = array(
                        "selisih" => ($this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"]) - ($this->cCodeData[$cCode]["main"]["nett"] + $this->cCodeData[$cCode]["main"]["ppv"]),
                        "hpp_nppv" => $this->cCodeData[$cCode]["main"]["hpp"],
                        "hpp_nppn" => $this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"],
                    );
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $this->cCodeData[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }
                }
                //endregion
            }
            else {
                cekHitam("no sub-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //region pre-processors (master)
            $iterator = $preProcessor["master"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $this->cCodeData[$cCode]["main"], $this->cCodeData[$cCode]["main"], 0);
                                $subParams['static'][$key] = $realValue;
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = "";
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);

                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //==inject gotParams to child gate
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($this->cCodeData[$cCode]["main"][$key])) {
                                                $this->cCodeData[$cCode]["main"]['sub_' . $key] = ($this->cCodeData[$cCode]["main"]['jml'] * $this->cCodeData[$cCode]["main"][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
            }
            else {
                cekHitam("no main-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }

                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->configUiModul[$this->jenisTr]["steps"][$stepNum]["label"] . " nomor " . $tmpNomorNota . " oleh " . $this->cCodeData[$cCode]["tableIn_master"]['oleh_nama'];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }

        // POST-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            //region processing sub-post-processors, always
            $iterator = $postProcessor["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>");
                    $tmpOutParams[$cCtr] = array();
                    if (isset($this->cCodeData[$cCode][$srcGateName]) && (sizeof($this->cCodeData[$cCode][$srcGateName]) > 0)) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($this->cCodeData[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $this->cCodeData[$cCode]["main"]['pihakExternID'];
                                }
                                $subParams['static']["keterangan"] = "";
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($this->cCodeData[$cCode][$srcGateName])) {
                        cekHere("[$cCtr] sub-postProcessor: $comName, sending values " . __LINE__ . "<br>");
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekHitam($this->db->last_query());
                    }
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP SUB-POSTPROC");
            }
            //endregion

            //region processing main-post-processors, always
            $iterator = $postProcessor["master"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("post-processor: $comName<br>LINE: " . __LINE__);

                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }
                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = "";
                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP MAIN-POSTPROC");
            }
            //endregion
        }

        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (isset($core['components']) && sizeof($core['components'])) {
                $jurnalIndex = $core['components'];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //------------
            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
            }
            else {
                $coreBuilder = array();
            }
            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");

        }
        //endregion

//        mati_disini(__LINE__);

        $this->load->model("Coms/ComRekeningPembantuProduk");

        // generate payment source penerimaan piutang denga id -
        if (sizeof($detailGate) > 0) {
            $target_jenis_hd = "749";
            $jenis_hd = "7778";
            $reference_jenis_hd = "7778";
            foreach ($detailGate as $customer_id => $spec) {
                $customer_nama = $spec["nama"];
                $harga = $spec["harga"];
                $arrSupplierData[$customer_id] = array(
                    "id" => $customer_id * -1,
                    "target_jenis" => $target_jenis_hd,
                    "jenis" => $jenis_hd,
                    "reference_jenis" => $reference_jenis_hd,
                    "extern_id" => $customer_id,
                    "extern_nama" => $customer_nama,
                    "transaksi_id" => $insertID,
                    "nomer" => "pemindahbukuan",
                    "nomer_top" => "pemindahbukuan",
                    "label" => "piutang dagang",
                    "tagihan" => $harga,
                    "sisa" => $harga,
                    "cabang_id" => $cabangID,
                    "cabang_nama" => $cabangNama,
                    "dtime" => $dtime,
                    "fulldate" => $fulldate,
                );

            }

            $tbl = $tr->getTableNames()["paymentSrc"];
            $tr->setTableName($tbl);
            foreach ($arrSupplierData as $spid => $spData) {
                $tr->setFilters(array());
                $tr->addData($spData);
                showLast_query("hijau");
            }

        }


        cekMerah(":: cek validate lajur di " . __FUNCTION__ . ", " . __FILE__);
        validateAllBalances($cabangID);

        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;

        mati_disini("---SETOP--- [$val] " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");
    }

    public function patchPL()
    {
        $this->load->model("MdlTransaksi");
        $arrJenis = array(
            "5822pkd", "5822spd",
        );
        $cabang = array(
            "id" => "1",
            "nama" => "CABANG 1",
        );

        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $tr->addFilter("jenis in ('" . implode("','", $arrJenis) . "')");
        $trTmp = $tr->lookupAll()->result();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $spec) {
                if ($spec->cabang_id == "-1") {

                    $data = array(
                        "cabang_id" => $cabang["id"],
                        "cabang_nama" => $cabang["nama"],
                    );
                    $where = array(
                        "id" => $spec->id,
                    );
                    $tr = New MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->updateData($where, $data);
                    showLast_query("orange");
                }
            }
        }

        mati_disini("---SETOP--- " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>DONE...</h3>");


    }

    //18 feb 2024-------------------------------------------
    public function generateHutangDagang()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComJurnal");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuSupplier");
        $rekening = "2010010";
        $rekening_2 = "1010040050";
        $jenis_target = "489";
        $cabang_id = "-1";
        $dtime = date("Y-m-d H:i:s");

        //----------------------
        $cabangID = "1";
        $cabangNama = "cabang 1";
        $gudangID = "-10";
        $gudangNama = "default warehouse at branch #1";
        $cabang2ID = "-1";
        $cabang2Nama = "pusat dc";
        $gudang2ID = "-1";
        $gudang2Nama = "default warehouse at branch #-1";
        $olehID = "100";
        $olehNama = "system";
//        $pihakID = "473";
//        $pihakNama = "ISHWAR MANWANI";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
//        $cash_account = 1160;
//        $cash_account_nama = 8830713132;
//        $referenceID = 12287;
//        $referenceNomer = "5822so.1.473.2";
        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
            "description" => "pemindahan penerimaan penjualan tunai ke uang muka tana ppn pada tgl 01 feb 2024 konsumen ISHWAR MANWANI",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );
        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }
        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
//            else {
//                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
//            }
//
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }
        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
//            if (isset($core['components']) && sizeof($core['components'])) {
//                $jurnalIndex = $core['components'];
//            }
//            else {
//                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
//                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
//                }
//                else {
//                    $jurnalIndex = array();
//                }
//            }
//            //------------
//            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
//                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
//            }
//            else {
//                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
//                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
//                }
//                else {
//                    $jurnalPostProc = array();
//                }
//            }
//            //------------
//            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
//                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
//            }
//            else {
//                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
//                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
//                }
//                else {
//                    $jurnalPreProc = array();
//                }
//            }
//            //------------
//            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
//                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
//            }
//            else {
//                $coreBuilder = array();
//            }
//            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");
        }
        //endregion

        //----------------------

        $this->db->trans_start();

        $cr = New ComRekening();
        $cr->addFilter("rekening=$rekening");
        $cr->addFilter("cabang_id=$cabang_id");
        $crTmp = $cr->fetchAllBalances();
        showLast_query("biru");
        if (sizeof($crTmp) > 0) {
            foreach ($crTmp as $spec) {
                $saldo = $spec["kredit"];
                $saldo_new = ($saldo / 1.11);
                $selisih_ppn = $saldo - $saldo_new;
                cekHere("[$saldo] [$saldo_new] [$selisih_ppn]");

                $com = array(
                    "loop" => array(
                        "$rekening" => -$selisih_ppn,// hutang dagang
                        "$rekening_2" => -$selisih_ppn,// ppn masukan belum ada faktur
                    ),
                    "static" => array(
                        "cabang_id" => "$cabang_id",
                        "jenis" => "$jenis",
                        "transaksi_id" => "$insertID",
                        "transaksi_no" => "$insertNum",
                        "dtime" => $dtime,
                        "fulldate" => $dtime,
                    ),
                );
                // COMJURNAL dan COMREKENING
                $cr = New ComJurnal();
                $cr->pair($com);
                $cr->exec();

                $cr = New ComRekening();
                $cr->pair($com);
                $cr->exec();


            }

            $crp = New ComRekeningPembantuSupplier();
            $crp->addFilter("cabang_id=$cabang_id");
            $crpTmp = $crp->fetchBalances($rekening);
            showLast_query("biru");
            if (sizeof($crpTmp) > 0) {
                foreach ($crpTmp as $iSpec) {
                    $extern_id = $iSpec->extern_id;
                    $extern_nama = $iSpec->extern_nama;
                    $saldo = $iSpec->kredit;
                    $saldo_new = ($saldo / 1.11);
                    $selisih_ppn = $saldo - $saldo_new;

                    // COM HUTANG DAGANG DETAIL
                    $comd = array(
                        "loop" => array(
                            "$rekening" => -$selisih_ppn,// hutang dagang
                        ),
                        "static" => array(
                            "extern_id" => "$extern_id",
                            "extern_nama" => "$extern_nama",
                            "cabang_id" => "$cabang_id",
                            "jenis" => "$jenis",
                            "transaksi_id" => "$insertID",
                            "transaksi_no" => "$insertNum",
                            "dtime" => $dtime,
                            "fulldate" => $dtime,
                        ),
                    );
                    $crp = New ComRekeningPembantuSupplier();
                    $crp->pair($comd);
                    $crp->exec();
                    // COM PPN MASUKAN DETAIL
                    $comdd = array(
                        "loop" => array(
                            "$rekening_2" => -$selisih_ppn,// ppn masukan belum ada faktur
                        ),
                        "static" => array(
                            "extern_id" => "$extern_id",
                            "extern_nama" => "$extern_nama",
                            "cabang_id" => "$cabang_id",
                            "jenis" => "$jenis",
                            "transaksi_id" => "$insertID",
                            "transaksi_no" => "$insertNum",
                            "dtime" => $dtime,
                            "fulldate" => $dtime,
                        ),
                    );
                    $crpd = New ComRekeningPembantuSupplier();
                    $crpd->pair($comdd);
                    $crpd->exec();
                }
            }


            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("sisa>'0'");
            $pymsrc = $tr->lookupPaymentSrcByJenis($jenis_target)->result();
            showLast_query("biru");
            if (sizeof($pymsrc) > 0) {
                foreach ($pymsrc as $pSpec) {
//                    arrPrintWebs($pSpec);
                    $sisa = $pSpec->sisa;
                    $sisa_new = ($sisa / 1.11);
                    $selisih_ppn = $sisa - $sisa_new;
                    $where = array(
                        "id" => $pSpec->id,
                    );
                    $data = array(
                        "dpp_ppn" => $sisa_new,
                        "sisa" => $sisa_new,
                        "dihapus" => $selisih_ppn,
                    );
                    $tr = New MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->updatePaymentSrc($where, $data);
                    showLast_query("orange");
                }
            }
        }


        validateAllBalances($cabang_id);

        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>SELESAI...</h3>");

    }


    //-------------------------------------------
    public function followupPrePreviewInvoicing($arrKiriman)
    {
//
//        $no = rtrim($this->uri->segment(5), "-");
//        $stepNumber = $this->uri->segment(6);
//        $currentStepNum = $this->uri->segment(7);
        $no = $arrKiriman["transaksi_id"];
        $stepNumber = $arrKiriman["step_number"];
        $currentStepNum = $arrKiriman["currentStepNumber"];
        $this->jenisTr = $arrKiriman["jenisTr"];
        $this->configUiJenis = $arrKiriman["uiJenis"];
        $this->configCoreJenis = $arrKiriman["coreJenis"];
        $this->configLayoutJenis = $arrKiriman["layoutJenis"];
        $this->configValuesJenis = $arrKiriman["valuesJenis"];
//        $url = str_replace("index.php/", "", current_url());
//        $rawBuilderURL = blobEncode($url);
//        $modePengirim = isset($_GET["pengirim"]) ? $_GET["pengirim"] : "";
//        $getmode = isset($_GET["getmode"]) ? $_GET["getmode"] : "";


        // region mengunci transaksi by $no dan userID
//        if ($this->session->login['ghost'] == 0) {
//
//            $this->load->model("Mdls/MdlLockerTransaksi");
//            $lt = New MdlLockerTransaksi();
//            $lt->addFilter("transaksi_id='$no'");
//            $ltTmp = $lt->lookupAll()->result();
//            if (sizeof($ltTmp) == 0) {
//                $ltActive = array(
//                    "state" => "active",
//                    "produk_id" => "$no",
//                    "transaksi_id" => "$no",
//                    "cabang_id" => $this->session->login['cabang_id'],
//                    "oleh_id" => 0,
//                    "oleh_nama" => "",
//                    "jenis" => "transaksi",
//                    "jenis_locker" => "transaksi",
//                    "jumlah" => "0",
//                    "gudang_id" => "0",
//                );
//                $ltHold = array(
//                    "state" => "hold",
//                    "produk_id" => "$no",
//                    "transaksi_id" => "$no",
//                    "cabang_id" => $this->session->login['cabang_id'],
//                    "oleh_id" => $this->session->login['id'],
//                    "oleh_nama" => $this->session->login['nama'],
//                    "jenis" => "transaksi",
//                    "jenis_locker" => "transaksi",
//                    "jumlah" => "1",
//                    "gudang_id" => "0",
//                );
//
//                // insert ke tabel locker transaksi
//                $lt->addData($ltActive);
//                $lt->addData($ltHold);
//            }
//            else {
//                $byUpdateHold = array();
//                $totalUpdateHold = 0;
//                $insertHold = true;
//                foreach ($ltTmp as $ltSpec) {
//                    if (($ltSpec->state == "hold") && ($ltSpec->jumlah == "1")) {
//                        $insertHold = false;
//                        break;
//                    }
//                    elseif (($ltSpec->state == "hold")) {
//                        $totalUpdateHold += isset($ltSpec->jumlah) ? $ltSpec->jumlah : 0;
//                        $byUpdateHold[] = $ltSpec->oleh_id;
//                    }
//                }
//                if ($insertHold == true) {
//                    if (($totalUpdateHold == 0) && (in_array($this->session->login['id'], $byUpdateHold))) {
//                        $ltHold = array(
//                            "jumlah" => "1",
//                        );
//                        $ltWhere = array(
//                            "state" => "hold",
//                            "produk_id" => "$no",
//                            "transaksi_id" => "$no",
//                            "jenis" => "transaksi",
//                            "jenis_locker" => "transaksi",
//                            "oleh_id" => $this->session->login['id'],
//                        );
//                        $lt->updateData($ltWhere, $ltHold);
//                    }
//                    else {
//                        //                    cekPink("total HOLDnya 0 dan saya BELUM pernah HOLD transaksi ini");
//                        $ltHold = array(
//                            "state" => "hold",
//                            "produk_id" => "$no",
//                            "transaksi_id" => "$no",
//                            "cabang_id" => $this->session->login['cabang_id'],
//                            "oleh_id" => $this->session->login['id'],
//                            "oleh_nama" => $this->session->login['nama'],
//                            "jenis" => "transaksi",
//                            "jenis_locker" => "transaksi",
//                            "jumlah" => "1",
//                            "gudang_id" => "0",
//                        );
//                        $lt->addData($ltHold);
//                    }
//
//                    $ltActive = array(
//                        "jumlah" => "0",
//                    );
//                    $ltWhere = array(
//                        "state" => "active",
//                        "produk_id" => "$no",
//                        "transaksi_id" => "$no",
//                        "jenis" => "transaksi",
//                        "jenis_locker" => "transaksi",
//                    );
//                    $lt->updateData($ltWhere, $ltActive);
//                }
//                else {
//                    //                cekPink("sudah ada yang HOLD");
//                }
//            }
//        }
        // endregion

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("id in (" . implode(",", explode("-", $no)) . ")");
        $tmpTr = $tr->lookupJoined();
        cekBiru($this->db->last_query());
        //endregion


        $cancelPackingId = isset($tmpTr[0]->cancel_packing_source_id) ? $tmpTr[0]->cancel_packing_source_id : 0;
        $tmpTrCancelPacking = array();
        $id_top_source_cancel_packing = array();
        if ($cancelPackingId > 0) {
            $tr->setFilters(array());
            $tr->addFilter("id in (" . implode(",", explode("-", $cancelPackingId)) . ")");
            $tmpTrCancelPacking = $tr->lookupJoined();
            $id_top_source_cancel_packing = $tmpTrCancelPacking[0]->id_top;
        }

        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {
                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }

        $rawItems = array();
        if (sizeof($tmpTr) > 0) {
//            $this->jenisTr = $tmpTr[0]->jenis_master;
            $cCode = "_TR_" . $this->jenisTr;
            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }

            $initMasterValues = heInitMasterValues_he_cart($this->jenisTr, 1, $this->configUiJenis);
            heInitGates_he_cart($this->jenisTr, $initMasterValues);

//mati_disini(__LINE__);


            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->configLayoutJenis['receiptDetailFields'][$stepNumber]) ? $this->configLayoutJenis['receiptDetailFields'][$stepNumber] : array();
            $itemNumLabels = isset($this->configUiJenis['shoppingCartNumFields'][$stepNumber]) ? $this->configUiJenis['shoppingCartNumFields'][$stepNumber] : array();
            $subAmountConfig = isset($this->configUiJenis['shoppingCartAmountValue'][$stepNumber]) ? $this->configUiJenis['shoppingCartAmountValue'][$stepNumber] : null;
            $measurementDetails = isset($this->configUiJenis["receiptMesurementRows"]) ? $this->configUiJenis["receiptMesurementRows"] : array();
            $validatePaymentLocker = isset($this->configUiJenis["validatePaymentSource"][$stepNumber]) ? $this->configUiJenis["validatePaymentSource"][$stepNumber] : array();
            $itemsChild = isset($this->configUiJenis["shopingCartDetailFields"][$stepNumber]['fields']) ? $this->configUiJenis["shopingCartDetailFields"][$stepNumber]['fields'] : array();//dipake detil pembelian aset
            $itemsChildGate = isset($this->configUiJenis["shopingCartDetailFields"][$stepNumber]['gate']) ? $this->configUiJenis["shopingCartDetailFields"][$stepNumber]['gate'] : array();//dipake detil pembelian aset/penambahan aset dari supplies sebagai switcer baca item atau main

            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = ($currentStepNum + 1);
            $pengirimID = $tmpTr[0]->pengirim_id;
            $pengirimName = $tmpTr[0]->pengirim_nama;
            //--------------------------------
            $gudangStatusJenis = $tmpTr[0]->gudang_status_jenis;
            $idsHis = ($tmpTr[0]->ids_his != null) ? blobDecode($tmpTr[0]->ids_his) : array();

            $pakai_ini = 0;
            if ($pakai_ini == 1) {

                //region periksa locker value;
                $tempLocker = array();
                $tempBtnUndo = array();
                if (sizeof($validatePaymentLocker) > 0) {
                    $mdlName = "Mdls/" . $validatePaymentLocker;
                    $this->load->model($mdlName);
                    $l = new $validatePaymentLocker();
                    $l->addFilter("transaksi_id='$no'");
                    $l->addFilter("state='active'");
                    $l->addFilter("nilai > 0");
                    $tempLocker = $l->lookupAll()->result();
                    //cekUngu($this->db->last_query() . " >> $validatePaymentLocker");
                    //arrPrint($tempLocker);
                    if (sizeof($tempLocker) > 0) {
                        $tempBtnUndo = array(
                            "allowedUndone" => false,//tidak boleh di undo/reject
                            "allowedFollow" => false,//boleh di followup
                        );
                    }
                    else {
                        //                    arrPrint($this->config->item('payment_source')[$this->jenisTr]);
                        //                    cekKuning(":: $currentStepNum ::");
                        $jnTarget = isset($this->config->item('payment_source')[$this->jenisTr][$currentStepNum][0]['jenisTarget']) ? $this->config->item('payment_source')[$this->jenisTr][$currentStepNum][0]['jenisTarget'] : "";
                        //                    cekHitam(":: ** $jnTarget ** ::");
                        $tempBtnUndo = array(
                            "allowedUndone" => true,// boleh di undo/reject
                            "allowedFollow" => true,//tidak boleh di followup
                            "label" => isset($this->configUi[$jnTarget]['label']) ? $this->configUi[$jnTarget]['label'] : "",
                        );
                    }
                }


                //            arrPrint($tempLocker);
                //endregion

                //==periksa apakah ada ganjalan
                $trA = new MdlTransaksi();
                $extSteps = $trA->lookupExtSteps($masterID);
                if (sizeof($extSteps) > 0) {
                    //                cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
                }
                else {
                    //                cekhijau("TAK ada ganjalan step");
                }
                $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");
                if (sizeof($paySrcs) > 0) {
                    //                cekmerah("ada ganjalan paymentSrc sebanyak " . sizeof($paySrcs));
                }
                else {
                    //                cekhijau("TAK ada ganjalan paymentSrc");
                }

                $allowEdit = isset($this->configUi[$this->jenisTr]['steps'][$stepNumber]['allowEdit']) ? $this->configUi[$this->jenisTr]['steps'][$stepNumber]['allowEdit'] : false;
                $allowCancel = isset($this->configUi[$this->jenisTr]['steps'][$stepNumber]['allowCancel']) ? $this->configUi[$this->jenisTr]['steps'][$stepNumber]['allowCancel'] : false;
                $editableFields = isset($this->configUi[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber]) ? $this->configUi[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber] : array();

                //region valid items
                $this->load->model("MdlTransaksi");
                $tr = new MdlTransaksi();
                $tr->addFilter("id in (" . implode(",", explode("-", $no)) . ")");
                $tr->addFilterJoin("sub_step_number='" . $currentStepNum . "'");
                $tr->addFilterJoin("next_substep_code='" . $this->configUi[$this->jenisTr]['steps'][$stepNumber]['target'] . "'");
                $tr->addFilterJoin("next_substep_num='$stepNumber'");
                $tr->addFilterJoin("valid_qty>0");
                $tmpTr = $tr->lookupJoined();
                //            cekhitam($this->db->last_query());

                $id_top = isset($tmpTr[0]->id_top) ? $tmpTr[0]->id_top : "";


                //            arrPrint($tmpTr);
                //            cekHere($id_top);
                //            cekHere($no);
                //            matiHere($no);


                if ($id_top != "") {
                    $idTr = isset($tmpTr[0]->id) ? $tmpTr[0]->id : "";
                    $trPack = new MdlTransaksi();
                    $trPack->setFilters(array());
                    $trPack->addFilter("id_top in (" . implode(",", explode("-", $id_top)) . ")");
                    $trPack->addFilterJoin("valid_qty>0");
                    $tmpTrPacked = $trPack->lookupJoined();
                }


                $tmpTrPrePacked = array();
                if (sizeof($id_top_source_cancel_packing) > 0) {
                    $trPrePack = new MdlTransaksi();
                    $trPrePack->setFilters(array());
                    $trPrePack->addFilter("id_top in (" . implode(",", explode("-", $id_top_source_cancel_packing)) . ")");
                    $trPrePack->addFilterJoin("valid_qty>0");
                    $trPrePack->addFilter("trash_4<1");
                    $tmpTrPrePacked = $trPrePack->lookupJoined();
                }
                else {
                    $trPrePack = new MdlTransaksi();
                    $trPrePack->setFilters(array());
                    $trPrePack->addFilter("cancel_packing_source_id in (" . implode(",", explode("-", $no)) . ")");
                    $trPrePack->addFilterJoin("valid_qty>0");
                    $trPrePack->addFilter("trash_4<1");
                    $tmpTrPrePacked = $trPrePack->lookupJoined();
                }

                $arrPreTmp__ = array();
                if (!empty($tmpTrPrePacked)) {
                    foreach ($tmpTrPrePacked as $y => $dd) {
                        if (!isset($arrPreTmp__[$dd->jenis][$dd->produk_id])) {
                            $arrPreTmp__[$dd->jenis][$dd->produk_id] = 0;
                        }
                        $arrPreTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
                    }
                }

                $arrTmp__ = array();

                if (sizeof($tmpTrPacked) > 0) {
                    foreach ($tmpTrPacked as $y => $dd) {
                        if (!isset($arrTmp__[$dd->jenis][$dd->produk_id])) {
                            $arrTmp__[$dd->jenis][$dd->produk_id] = 0;
                        }
                        $arrTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
                    }
                }


                $extractedItems = array();//==untuk urusan update transaksi referer
                $validItems = array();
                $validItemSends = array();
                $validItemReqCancels = array();
                $validItemCancels = array();
                $validItemPreCancels = array();
                $validItemSents = array();

                if (sizeof($tmpTr) > 0) {
                    cekmerah("ada yang mau diekstrak");
                    foreach ($tmpTr as $row) {
                        if (!isset($validItems[$row->produk_id])) {
                            $validItems[$row->produk_id] = 0;
                        }
                        if (!isset($validItemSends[$row->produk_id])) {
                            $validItemSends[$row->produk_id] = 0;
                        }
                        if (!isset($validItemCancels[$row->produk_id])) {
                            $validItemCancels[$row->produk_id] = 0;
                        }
                        if (!isset($validItemReqCancels[$row->produk_id])) {
                            $validItemReqCancels[$row->produk_id] = 0;
                        }
                        if (!isset($validItemPackeds[$row->produk_id])) {
                            $validItemPackeds[$row->produk_id] = 0;
                        }
                        if (!isset($validItemPreCancels[$row->produk_id])) {
                            $validItemPreCancels[$row->produk_id] = 0;
                        }

                        $validItems[$row->produk_id] += isset($row->valid_qty) ? $row->valid_qty : 0;
                        $validItemSends[$row->produk_id] += isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0;
                        $validItemCancels[$row->produk_id] += isset($row->cancel_qty) ? $row->cancel_qty : 0;
                        $validItemReqCancels[$row->produk_id] += isset($row->req_cancel_qty) ? $row->req_cancel_qty : 0;
                        $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0;
                        $validItemPackeds[$row->produk_id] += isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0;

                        if (!isset($extractedItems[$row->produk_id])) {
                            $extractedItems[$row->produk_id] = array();
                        }
                        $extractedItems[$row->produk_id][$row->id_detail] = array(
                            "id" => $row->id_detail,
                            "produk_id" => $row->produk_id,
                            "qty" => $row->produk_ord_jml,
                            "valid_qty" => $row->valid_qty,
                            "transaksi_id" => $row->transaksi_id,
                            "packed_qty" => isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0,
                            "sent_qty" => isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0,
                            "req_cancel_qty" => isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0,
                            "cancel_qty" => isset($row->cancel_qty) ? $row->cancel_qty : 0,
                            "outstanding" => $row->produk_ord_jml - ($row->produk_ord_jml - $row->valid_qty),
                        );
                    }
                }
                else {
                    cekmerah("TIDAK ada yang mau diekstrak");
                }
                cekBiru($validItems);


                //endregion

                //
                //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
                $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
                $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
                //            //cekMerah($this->db->last_query());
                $mainValues = array();
                if (sizeof($tmpVal_main) > 0) {
                    foreach ($tmpVal_main as $row) {
                        $mainValues[$row->key] = $row->value;
                    }
                }
                $detailValues = array();
                if (sizeof($tmpVal_detail) > 0) {
                    foreach ($tmpVal_detail as $row) {
                        $detailValues[$row->produk_id][$row->key] = $row->value;
                    }
                }
                //            arrPrint($detailValues);
                //endregion

            }


            //region take from registries
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            $tmpReg = $trr->lookupDataRegistries()->result();
            cekKuning($this->db->last_query());
            //            matiHere();
            $main = array();
            $items = array();
            $items2 = array();
            $items2_sum = array();
            $items3 = array();
            $items3_sum = array();
            $items4 = array();
            $items4_sum = array();
            $items5_sum = array();
            $items6 = array();
            $items6_sum = array();
            $items7 = array();
            $items7_sum = array();
            $items8_sum = array();
            $items9_sum = array();
            $items10_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();

            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();
            $mainInputs = array();
            $itemsKomposisi = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    foreach ($row as $key_reg => $val_reg) {
                        if ($val_reg == NULL) {
                            $val_reg = blobEncode(array());
                        }
                        switch ($key_reg) {
                            case "main"://
                                $main = $main + unserialize(base64_decode($val_reg));
                                break;
                            case "items"://
                                $items = $items + unserialize(base64_decode($val_reg));
                                break;
                            case "items2"://
                                $items2 = $items2 + unserialize(base64_decode($val_reg));
                                break;
                            case "rsltItems"://
                                $rsltItems = $rsltItems + unserialize(base64_decode($val_reg));
                                break;
                            case "rsltItems2"://
                                $rsltItems2 = $rsltItems2 + unserialize(base64_decode($val_reg));
                                break;
                            case "items2_sum"://
                                $items2_sum = $items2_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items3"://
                                $items3 = $items3 + unserialize(base64_decode($val_reg));
                                break;
                            case "items3_sum"://
                                $items3_sum = $items3_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items4"://
                                $items4 = $items4 + unserialize(base64_decode($val_reg));
                                break;
                            case "items4_sum"://
                                $items4_sum = $items4_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items5_sum"://
                                $items5_sum = $items5_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items6"://
//                                arrPrint($items6);
//                                arrPrint(unserialize(base64_decode($val_reg)));
//                                cekHere($val_reg);
                                $items6 = $items6 + unserialize(base64_decode($val_reg));
                                break;
                            case "items6_sum"://
                                $items6_sum = $items6_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items7"://
                                $items7 = $items7 + unserialize(base64_decode($val_reg));
                                break;
                            case "items7_sum"://
                                $items7_sum = $items7_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items8_sum"://
                                $items8_sum = $items8_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items9_sum"://
                                $items9_sum = $items9_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "items10_sum"://
                                $items10_sum = $items10_sum + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_master"://
                                $masterTableInParams = $masterTableInParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail"://
                                $childTableInParams = $childTableInParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_rsltItems"://
                                $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_rsltItems2"://
                                $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_master_values"://
                                $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_values"://
                                $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_values_rsltItems"://
                                $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($val_reg));
                                break;
                            case "tableIn_detail_values_rsltItems2"://
                                $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($val_reg));
                                break;
                            case "main_add_values"://
                                $masterAddValues = $masterAddValues + unserialize(base64_decode($val_reg));
                                break;
                            case "main_add_fields"://
                                $masterAddFields = $masterAddFields + unserialize(base64_decode($val_reg));
                                break;
                            case "main_elements"://
                                $mainElements = unserialize(base64_decode($val_reg));
                                break;
                            case "main_inputs"://
                                $mainInputs = unserialize(base64_decode($val_reg));
                                break;
                            case "items_komposisi"://
                                $itemsKomposisi = unserialize(base64_decode($val_reg));
                                break;
                        }
                    }
                }

            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            $pakai_ini = 0;
            if ($pakai_ini == 1) {

                //region replacer Downpayment avail
                if (isset($mainInputs['dp'])) {
                    if (isset($this->configUi[$this->jenisTr]["updateDownpayment"][$stepNumber])) {
                        //                    arrPrint($mainInputs);
                        $this->load->model("Coms/ComLockerValue");
                        $mi = new ComLockerValue();
                        $mi->addFilter("produk_id='" . $main['masterID'] . "'");
                        $mainInputAvail = $mi->fetchBalances("downpayment");
                        $lockerVal = $mainInputAvail[0]->nilai;
                        //                    $mainValTmp = reversePpn($mainInputs['dp'],"10");
                        $mainValTmp_dp = $main['dp_value'];
                        $mainValTmp_dp_ppn = $main['dp_ppn_value'];

                        if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                            cekOrange();
                            $validate = round($mainInputAvail[0]->nilai - $mainValTmp_dp, 2);
                            if ($lockerVal > 0) {
                                $valnew = $main['new_net1'] - $lockerVal > 0 ? 0 : $main['new_net1'];
                                $main['dp_value'] = $valnew;
                                $main['dp_ppn_value'] = $valnew * 10 / 100;
                            }
                            else {
                                $main['dp_value'] = 0;
                                $main['dp_ppn_value'] = 0;
                                //                        $main['valid_dp'] = 0;
                            }

                            if ($validate > 0) {
                                $mainInputs['dp'] = $mainInputAvail[0]->nilai;

                            }
                            else {
                                if ($validate < 0) {
                                    if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                                        $main['downpayment'] = $mainInputs['dp'];
                                        $mainInputs['downpayment'] = $mainInputs['dp'];
                                        $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['dp_ppn_value'];

                                    }
                                    unset($mainInputs['dp']);
                                    //                                cekhere("sini po");
                                }
                                //                        if(!isset($main['valid_dp'])){
                                //                            $main['valid_dp'] = $mainInputAvail[0]->nilai;
                                //                        }

                            }
                        }
                        else {
                            //                         $mainInputs['dp'] = 0;
                            $main['dp_value'] = 0;
                            $main['dp_ppn_value'] = 0;
                            unset ($mainInputs['dp']);
                        }

                        if (!isset($main['valid_dp'])) {
                            $main['valid_dp'] = $mainInputAvail[0]->nilai;
                        }
                    }


                }
                else {
                    if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                        $main['downpayment'] = $main['dp'];
                        $mainInputs['downpayment'] = $main['dp'];
                        //                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['nilai_tambah_ppn_out'];
                        $main['total_ui'] = $masterTableInValueParams['new_net1'] - $main['valid_dp'];
                        cekBiru($masterTableInValueParams['new_net1'] . " - " . $main['valid_dp']);
                    }
                    else {
                        if (isset($masterTableInValueParams['new_net1'])) {

                            $main['total_ui'] = $masterTableInValueParams['new_net1'];
                        }
                        else {
                            $main['total_ui'] = isset($masterTableInValueParams['nett1']) ? $masterTableInValueParams['nett1'] : 0;
                            $main['new_grand_ppn'] = isset($masterTableInValueParams['grand_ppn']) ? $masterTableInValueParams['grand_ppn'] : 0;
                        }
                    }
                }
                //endregion

                $masterReplacers = array(
                    "jenisTrMaster" => $this->jenisTr,
                    "jenisTrTop" => $masterTableInParams['jenis_top'],
                    "harga" => 0,
                    "masterID" => $masterID,
                );
                foreach ($masterReplacers as $key => $src) {
                    $main[$key] = $src;
                    $mainValues[$key] = $src;
                    $masterGates[$key] = $src;
                }

            }

            //==revalidate items
            $this->load->library("FieldCalculator");
            $this->load->helper("he_angka");
            $cal = new FieldCalculator();

            $pakai_ini = 0;
            if ($pakai_ini == 1) {

                $itemChildData = array();
                if (sizeof($items) > 0) {
                    foreach ($items as $xid => $iSpec) {
                        $id = $iSpec['id'];
                        $tipeSize = isset($iSpec['detilSize']) && sizeof($iSpec['detilSize']) > 0 ? $iSpec['detilSize'] : "";

                        if (array_key_exists($id, $validItems)) {
                            $items[$id]['jml'] = $validItems[$id];
                            $items[$id]['max_jml'] = $validItems[$id];
                            $items[$id]['packed_jml'] = $validItemPackeds[$id];
                            $items[$id]['sent_jml'] = $validItemSends[$id];
                            $items[$id]['cancel_jml'] = $validItemCancels[$id];
                            $items[$id]['req_cancel_jml'] = $validItemPreCancels[$id];
                            if (sizeof($editableFields) > 0) {
                                foreach ($editableFields as $fName) {
                                    $items[$id]["max_$fName"] = isset($iSpec[$fName]) ? $iSpec[$fName] : 0;
                                }
                            }

                            if (sizeof($measurementDetails)) {
                                if (in_array($stepNumber, $measurementDetails["allowView"]) && isset($measurementDetails[$tipeSize])) {
                                    $selectedColl = $measurementDetails[$tipeSize];
                                    foreach ($selectedColl as $colSelected => $tempHelper) {
                                        foreach ($tempHelper as $newKey => $heAngka) {
                                            $items[$id][$newKey] = $heAngka($iSpec[$colSelected]);
                                        }
                                    }
                                }
                            }


                            if ($subAmountConfig != null) {
                                $tmpEx = $cal->multiExplode($subAmountConfig);
                                if (sizeof($tmpEx) > 1) {
                                    //                            echo lgShowAlert("menghitung subtotal pakai rumus $subAmountConfig di step ke # $stepNumber");
                                    $newSrc = $subAmountConfig;
                                    foreach ($tmpEx as $key2 => $val2) {
                                        if (isset($items[$id][$val2])) {
                                            $newSrc = str_replace($val2, $items[$id][$val2], $newSrc);

                                        }
                                        else {
                                            if (isset($tmp[$val2])) {
                                                $newSrc = str_replace($val2, $items[$val2], $newSrc);

                                            }
                                            else {
                                                $newSrc = str_replace($val2, "0", $newSrc);

                                            }
                                        }


                                    }
                                    $subtotal = $cal->calculate($newSrc);


                                }
                                else {
                                    //                            echo lgShowAlert("memasang subtotal dari $subAmountConfig");
                                    $subtotal = $items[$id][$subAmountConfig];

                                }
                            }
                            else {
                                //                        echo lgShowAlert("tidak mengapa-apakan subtotal");
                                $subtotal = 0;

                            }

                            $items[$id]['subtotal'] = $subtotal;
                            //region item child

                            if (sizeof($itemsChild) > 0 && ($itemsChildGate == 'detail')) {
                                //                        if (sizeof($itemsChild)  > 0 ) {
                                for ($x = 1; $x <= $validItems[$id]; $x++) {
                                    foreach ($itemsChild as $col => $col_label) {
                                        $itemChildData[$id][$x][$col] = isset($items[$id][$col]) ? $items[$id][$col] : "";
                                        $itemChildData[$id][$x]["jml"] = 1;
                                        $itemChildData[$id][$x]["qty"] = 1;
                                        $itemChildData[$id][$x]["folders"] = $main['pihakMainID'];
                                    }

                                }
                                //                            arrPrint($itemsChild);
                                //                        foreach ($itemsChild as )
                            }

                            //endregion
                            cekBiru($itemsKomposisi);
                            if (sizeof($itemsKomposisi) > 0) {
                                if (array_key_exists($id, $itemsKomposisi)) {
                                    foreach ($items2[$id] as $jenis_komposisi => $iiSpec) {
                                        foreach ($iiSpec as $ee => $eeSpec) {
                                            $komposisi = $itemsKomposisi[$id][$jenis_komposisi][$ee];
                                            // re-kalkulasi gerbang items2
                                            $items2[$id][$jenis_komposisi][$ee]['jml'] = $komposisi->jml * $validItems[$id];
                                            $items2[$id][$jenis_komposisi][$ee]['sub_nilai'] = $komposisi->nilai * $validItems[$id];
                                            cekhijau("pID: $id [], jml: " . $komposisi->jml . " validItems: " . $validItems[$id]);
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            unset($items[$id]);
                            unset($items2[$id]);
                            unset($childGates[$id]);
                            unset($childTableInParams[$id]);
                            unset($childTableInValueParams[$id]);
                        }
                    }

                    if (sizeof($itemsKomposisi) > 0) {
                        $items2_sum = array();// supplies-nya...
                        $items3_sum = array();// biaya-nya...
                        foreach ($items2 as $pID => $pSpec) {
                            foreach ($pSpec as $jenis => $jSpec) {
                                foreach ($jSpec as $eSpec) {
                                    if ($jenis == "produk") {
                                        if (!isset($items2_sum[$eSpec['id']])) {
                                            $items2_sum[$eSpec['id']] = $eSpec;
                                            $items2_sum[$eSpec['id']]['jml'] = 0;
                                            $items2_sum[$eSpec['id']]['produk_ids'] = array();
                                        }
                                        $items2_sum[$eSpec['id']]['jml'] += $eSpec['jml'];
                                        $items2_sum[$eSpec['id']]['produk_ids'][$pID] = $pID;

                                        cekBiru("pID: " . $eSpec['id'] . " jml: " . $eSpec['jml']);
                                    }
                                    if ($jenis == "biaya") {
                                        if (!isset($items3_sum[$eSpec['id']])) {
                                            $items3_sum[$eSpec['id']] = $eSpec;
                                            $items3_sum[$eSpec['id']]['jml'] = 0;
                                            $items3_sum[$eSpec['id']]['sub_nilai'] = 0;
                                            $items3_sum[$eSpec['id']]['produk_ids'] = array();
                                        }
                                        $items3_sum[$eSpec['id']]['jml'] += $eSpec['jml'];
                                        $items3_sum[$eSpec['id']]['sub_nilai'] += $eSpec['sub_nilai'];
                                        $items3_sum[$eSpec['id']]['produk_ids'][$pID] = $pID;
                                    }
                                }
                            }
                        }
                    }

                }
                if (sizeof($itemsChild) > 0 && ($itemsChildGate == 'main')) {

                    $fieldAlias = isset($this->configUi[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fieldAlias']) ? $this->configUi[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fieldAlias'] : $itemsChild;//dipake detil pembelian aset
                    foreach ($fieldAlias as $col => $col_label) {
                        $itemChildData[$main['pihakMainRulesID']][1][$col] = isset($main[$col_label]) ? $main[$col_label] : "";
                    }
                    $itemChildData[$main['pihakMainRulesID']][1]["jml"] = 1;
                    $itemChildData[$main['pihakMainRulesID']][1]["qty"] = 1;
                    $itemChildData[$main['pihakMainRulesID']][1]["folders"] = $main['pihakID'];
                    //                cekBiru("main");
                }

            }

            //region session-swapper
            unset($main["nilai_pembulatan"]);
            $main["pengirimID"] = $pengirimID;
            $main["pengirimName"] = $pengirimName;

            if (isset($_SESSION[$cCode]["main"])) {
                $_SESSION[$cCode]["main"]["olehID"] = "-100";
                $_SESSION[$cCode]["main"]["olehName"] = "system";
                foreach ($_SESSION[$cCode]["main"] as $mkey => $mval) {
                    $main[$mkey] = $mval;
                }
            }

            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "items3" => $items3,
                "items3_sum" => $items3_sum,
                "items4" => $items4,
                "items4_sum" => $items4_sum,
                "items5_sum" => $items5_sum,
                "items6" => $items6,
                "items6_sum" => $items6_sum,
                "items7" => $items7,
                "items7_sum" => $items7_sum,
                "items8_sum" => $items8_sum,
                "items9_sum" => $items9_sum,
                "items10_sum" => $items10_sum,
                "items_child" => $itemChildData,
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => $extractedItems,


                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                //        ""=>$childAddValues ,
                "main_add_fields" => $masterAddFields,
                //                "main_applets"          => $mainApplets,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                //
                "extSteps" => $extSteps,
                "paySrcs" => $paySrcs,
                "lockerPayment" => $tempBtnUndo,
                "items_komposisi" => $itemsKomposisi,
            );
            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;

            }
            //endregion

            if (sizeof($idsHis) > 0) {
                foreach ($idsHis as $step_his => $data_his) {
                    $_SESSION[$cCode]['main']['referenceID_' . $step_his] = $data_his["trID"];
                    $_SESSION[$cCode]['main']['referenceNumber' . $step_his] = $data_his["nomer"];
                }
            }
            $_SESSION[$cCode]['main']['referenceID_current'] = $tmpTr[0]->id;
            $_SESSION[$cCode]['main']['referenceNumber_current'] = $tmpTr[0]->nomer;

//            arrPrint($_SESSION[$cCode]['main']);
//            mati_disini(__LINE__);

            $this->load->helper("he_value_builder");

            //-------------------------------------------
            $receiptElementsInjector = isset($this->configUiJenis["receiptElementsInjector"]) ? $this->configUiJenis["receiptElementsInjector"] : array();
            if (sizeof($receiptElementsInjector) > 0) {
                foreach ($receiptElementsInjector as $eName => $eSpec) {

                    if ((!isset($main[$eName])) || (!isset($mainElements[$eName]))) {
                        //                        cekhitam("tidak kenal ppv, maka diinjeckkan...");
                        if (isset($eSpec['defaultValue'])) {//==cek apakah ada seting defaultValue
                            //                        cekmerah("default value for $eName is: " . $eSpec['defaultValue']);
                            $defValueSrc = $eSpec['defaultValue'];
                            switch ($eSpec['elementType']) {
                                case "dataModel":
                                    heFetchElement_modul($this->jenisTr, $eName, $eSpec['mdlName'], $defValueSrc, $this->configUiJenis);
                                    break;
                                case "dataField":
                                    heRecordElement_modul($this->jenisTr, $eName, $defValueSrc, $this->configUiJenis);
                                    break;
                            }
                            $_SESSION[$cCode]['main_elements'][$eName]['autoSelect'] = true;
                        }
                        else {//==cek apakah pilihannya cuma satu
                            if (isset($eSpec['noPrefetch']) && $eSpec['noPrefetch'] == true) {

                            }
                            else {
                                //                            cekHere(__LINE__);
                                switch ($eSpec['elementType']) {
                                    case "dataModel":
                                        $amdlName = $eSpec['mdlName'];
                                        $this->load->model("Mdls/" . $amdlName);
                                        $labelSrc = $eSpec['labelSrc'];
                                        $keySrc = $eSpec['key'];
                                        $oo = new $amdlName();
                                        $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();
                                        //                                    cekHitam($amdlName);
                                        //                                    arrPrint($aFilter);
                                        if (sizeof($aFilter) > 0) {
                                            $oo = makeFilter($aFilter, $_SESSION[$cCode]['main'], $oo);
                                        }
                                        $tmpo = $oo->lookupAll()->result();
                                        if (sizeof($tmpo) == 1) {
                                            $usedKey = $eSpec['key'];
                                            $defValueSrc = $tmpo[0]->$usedKey;
                                            heFetchElement_modul($this->jenisTr, $eName, $eSpec['mdlName'], $defValueSrc, $this->configUiJenis);
                                        }
                                        break;
                                    case "dataField":
                                        break;
                                }
                            }
                        }

                        resetValues($this->jenisTr);
                        fillValues_he_value_builder($this->jenisTr, $this->uri->segment(7), $this->uri->segment(6), $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis);

                    }
                }
            }

            //==init replacer
            //==recover nilai HARGA master
            $_SESSION[$cCode]['main']['harga'] = 0;
            $_SESSION[$cCode]['main']['currentID'] = $no;

            //==default load dari nota, maka dianggap langsung done
            $_SESSION[$cCode]['main']['status_4'] = 1;
            $_SESSION[$cCode]['main']['trash_4'] = 0;
            if (sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);
                    /*---untuk keperluan mobile view---*/
                    $_SESSION[$cCode]['items'][$xid]['jml_target_scan'] = $iSpec['jml'];
                }
            }


            //overwriter ppn facrot
            if (isset($_SESSION[$cCode]["main"]["ppnFactor"]) && $_SESSION[$cCode]["main"]["ppnFactor"] == $this->session->login["ppnFactor"]) {

            }
            else {
                $_SESSION[$cCode]["main"]["ppnFactor"] = $this->session->login["ppnFactor"];//baca dari session login
            }
            $ppnFactor = isset($_SESSION[$cCode]["main"]["ppnFactor"]) && $_SESSION[$cCode]["main"]["ppnFactor"] == "11" ? $_SESSION[$cCode]["main"]["ppnFactor"] : matiHere("error on build values on PrePrev " . __LINE__ . " silahkan relogin");


            /* ----------------------------------------------------------------------
             * deteksi mobile auto atau hanya orang tertentu,
             * diatur di heWeb mobile
             * ----------------------------------------------------------------------*/
//            $isMob0 = isMobile_he_misc();
//            $isMob = isset($_GET['ismob']) ? $_GET['ismob'] : $isMob0;
//            cekHere("mob: $isMob");
//

            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                // region reload data produk sesuai config dari shoppingcart-----------------------------------
                $arrItemsKey = array_keys($_SESSION[$cCode]["items"]);
                $arrDataTambahan = $this->dataTambahan;

                $selectorSrcModel = isset($_SESSION[$cCode]['main']['pihakMdlNameSrc']) ? $_SESSION[$cCode]['main']['pihakMdlNameSrc'] : $this->configUi[$this->jenisTr]['selectorSrcModel'];
                $fieldSrcs = isset($this->configUi[$this->jenisTr]['shoppingCartFieldSrc']) ? $this->configUi[$this->jenisTr]['shoppingCartFieldSrc'] : array("nama" => "nama");

                $this->load->model("Mdls/" . $selectorSrcModel);
                $b = new $selectorSrcModel();
                $b->addFilter("id in ('" . implode("','", $arrItemsKey) . "')");
                $tmpB = $b->lookupAll()->result();
                if (sizeof($tmpB) > 0) {
                    foreach ($tmpB as $row) {
                        $rows = $row;
                        $tmp = (array)$row;
                        $produk_id = $idp = $row->id;
                        $produk_jenis = $row->kategori_nama;
//                        if (!isset($_SESSION[$cCode]['items2'][$idp])) {
//                            $_SESSION[$cCode]['items2'][$idp] = array();
//                        }
//                        foreach ($fieldSrcs as $key => $src) {
////                        cekHitam("$key => $src");
//                            if (is_array($src) && sizeof($src) > 0) {
////                            cekHitam("masuk disini " . __LINE__);
//                                foreach ($src as $srcSpec) {
//                                    if (isset($tmp[$srcSpec]) || isset($rows->$srcSpec)) {
//                                        $_SESSION[$cCode]['items'][$idp][$key] = makeValue($srcSpec, $tmp, $tmp, isset($rows->$srcSpec) ? $rows->$srcSpec : "-");
//                                    }
//                                }
//                            }
//                            else {
////                            cekUngu("masuk disini [$key => $src] " . __LINE__);
//                                $_SESSION[$cCode]['items'][$idp][$key] = makeValue($src, $tmp, $tmp, isset($rows->$src) ? $rows->$src : 0);
//                            }
//                        }
                        // memasukkan kolom sku ke items2
//                    $tmp = $_SESSION[$cCode]['items'][$id];
                        $arrCat = array();
                        $arrCode = array();
                        if ($produk_jenis == "unit") {
                            foreach ($arrDataTambahan as $cat => $catSpec) {
                                foreach ($catSpec as $dkey => $dval) {
                                    if (isset($rows->$dval) && ($rows->$dval != NULL)) {
//                                        $_SESSION[$cCode]['items2'][$produk_id][$rows->$dval] = array();
                                        //--------------
                                        if (!isset($arrCat[$cat])) {
                                            $arrCat[$cat] = 0;
                                        }
                                        $arrCat[$cat] += 1;
                                        //--------------
                                        if (!isset($arrCode[$rows->$dval])) {
                                            $arrCode[$rows->$dval] = 0;
                                        }
                                        $arrCode[$rows->$dval] += 1;
                                        //--------------
                                    }
                                }
                            }
//                            if (isset($_SESSION[$cCode]['items3_sum']) && count($_SESSION[$cCode]['items3_sum']) > 0) {
//                                $sessionSource = $_SESSION[$cCode]['items3_sum'];
//                                foreach ($sessionSource as $ks => $rowVal) {
//                                    $produk_sku_part_nama = $rowVal['produk_sku_part_nama'];
//                                    $serial_number = $rowVal['serial_number'];
//                                    if (isset($_SESSION[$cCode]['items2'][$produk_id][$produk_sku_part_nama])) {
//                                        if (!isset($_SESSION[$cCode]['items2'][$produk_id][$produk_sku_part_nama][$serial_number])) {
//                                            $_SESSION[$cCode]['items2'][$produk_id][$produk_sku_part_nama][$serial_number] = array();
//                                        }
//                                        $_SESSION[$cCode]['items2'][$produk_id][$produk_sku_part_nama][$serial_number]["serial"] = $serial_number;
////                                    $_SESSION[$cCode]['items2'][$produk_id][$produk_sku_part_nama][$serial_number]["serial"] = $serial_number;
//                                    }
//                                }
//                            }
                        }
                        else {
                            //handle serial 1
                            $jml_serial = $rows->jml_serial;
                            $tmp['jml_serial'] = $jml_serial;
                            $tmp['scan_mode'] = $jml_serial > 0 ? "serial" : "simple";
                            if ($jml_serial * 1 == 1) {
                                $d_kode = $rows->kode;
//                                $_SESSION[$cCode]['items2'][$produk_id][$d_kode] = array();
                            }
                        }
                        $keterangan = "";
                        $static_keterangan = "";
                        if (!empty($arrCat)) {
                            foreach ($arrCat as $kcat => $vcat) {
                                $new_vcat = $vcat * $_SESSION[$cCode]['items'][$idp]["jml"];
                                if ($keterangan == "") {
                                    $keterangan = " $new_vcat $kcat";
                                }
                                else {
                                    $keterangan .= "<br> $new_vcat $kcat";
                                }
                                if ($static_keterangan == "") {
                                    $static_keterangan = " $vcat $kcat";
                                }
                                else {
                                    $static_keterangan .= "<br> $vcat $kcat";
                                }
                                $new_keyy = "qty_" . $kcat;
                                $_SESSION[$cCode]['items'][$idp][$new_keyy] = $vcat;
                            }
                        }
                        if (!empty($arrCode)) {
                            foreach ($arrCode as $kcat => $vcat) {
                                $new_vcat = $vcat * $_SESSION[$cCode]['items'][$idp]["jml"];
                                $_SESSION[$cCode]['items'][$idp][$kcat] = $new_vcat;
                            }
                        }
                        $_SESSION[$cCode]['items'][$idp]['keterangan'] = $keterangan;
                        $_SESSION[$cCode]['items'][$idp]['static_keterangan'] = $static_keterangan;
                    }
                }
                // endregion reload data produk sesuai config dari shoppingcart-----------------------------------
            }

            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                // region copy gerbang serial dari distribusi
                $shoppingCartCopySerialNumber = isset($this->configUi[$this->jenisTr]["shoppingCartCopySerialNumber"][$stepNumber]) ? $this->configUi[$this->jenisTr]["shoppingCartCopySerialNumber"][$stepNumber] : array();
                if (sizeof($shoppingCartCopySerialNumber) > 0) {
                    $statusGudangConfig = $shoppingCartCopySerialNumber["statusGudang"];
                    $copyGateConfig = $shoppingCartCopySerialNumber["copyGate"];
                    $copyJenisConfig = $shoppingCartCopySerialNumber["copyJenis"];
                    if ($gudangStatusJenis == $statusGudangConfig) {
                        $trs = new MdlTransaksi();
                        $trs->addFilter("jenis='$copyJenisConfig'");
                        $trs->addFilter("reference_id_top='$topID'");
                        $trsTmp = $trs->lookupAll()->result();
                        $trsID = $trsTmp[0]->id;

                        $trs = new MdlTransaksi();
                        $trs->setFilters(array());
                        $trs->setJointSelectFields($copyGateConfig);
                        $trs->addFilter("transaksi_id='$trsID'");
                        $tmpReg = $trs->lookupDataRegistries()->result();
                        if (sizeof($tmpReg) > 0) {
                            foreach ($tmpReg as $row) {
                                foreach ($row as $key_reg => $val_reg) {
                                    $_SESSION[$cCode][$key_reg] = blobDecode($val_reg);
                                }
                            }
                        }
                    }

                }
                // endregion copy gerbang serial dari distribusi
            }


            resetValues($this->jenisTr);
            fillValues_he_value_builder($this->jenisTr, $currentStepNum, $stepNumber, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);

            return true;
        }
        else {
            mati_disini(("No such transaction. You may want to refresh the browser to re-fetch actual content."));
        }

    }

    public function save($arrKiriman)
    {
//        echo "<script>top.writeProgress('MEMULAI PROSES SAVING....');</script>";

//        if ($this->transaksiMaintenance === true) {
//            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
//            mati_disini($msg);
//        }

        //        $this->jenisTr = $this->uri->segment(3);
//        $cCode = $this->cCode;
//        $configUi = $this->configUi;
        $no = $arrKiriman["transaksi_id"];
        $stepNumber = $arrKiriman["step_number"];
        $currentStepNum = $arrKiriman["currentStepNumber"];
        $this->jenisTr = $arrKiriman["jenisTr"];
        $this->configUiJenis = $arrKiriman["uiJenis"];
        $this->configCoreJenis = $arrKiriman["coreJenis"];
        $this->configLayoutJenis = $arrKiriman["layoutJenis"];
        $this->configValuesJenis = $arrKiriman["valuesJenis"];
        $transaksi_current_dtime = $arrKiriman["dtime"];
        $transaksi_current_fulldate = $arrKiriman["fulldate"];
        $cCode = "_TR_" . $this->jenisTr;
        cekHitam(":::: jenisTR : " . $this->jenisTr);
        $modul_transaksi = $this->config->item("heTransaksi_ui")[$this->jenisTr]["modul"];
        $tCodeTargetJenisTransaksi = $jenisTrTarget = isset($this->configUiJenis["steps"][1]["target"]) ? $this->configUiJenis["steps"][1]["target"] : NULL;
        $relOptionConfigs = isset($this->configUiJenis['relativeOptions']) ? $this->configUiJenis['relativeOptions'] : array();
        $ppnFactor = isset($_SESSION[$cCode]["main"]["ppnFactor"]) ? $_SESSION[$cCode]["main"]["ppnFactor"] : matiHere("gagal menghitung ppn silahkan refresh atau relogin");
        $inputLabels = array();
        $inputAuthConfigs = array();

        $this->load->model("MdlTransaksi");
        $this->load->library("FieldCalculator");
        $cal = new FieldCalculator();

//        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
//        $prevUrl = blobDecode($rawPrevURL);
        $mongoList = array();
        $mongRegID = array();
        if (isset($_SESSION[$cCode])) {
            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                //            unset($_SESSION[$cCode]["main"]["bookingNumber"]);
                if (!isset($_SESSION[$cCode]["main"]["bookingNumber"])) {
                    $msg = "Nomer Booking transaksi baru belum terdaftar. code: " . __LINE__;
                    mati_disini($msg);
                }
                elseif ($_SESSION[$cCode]["main"]["bookingNumber"] == null) {
                    $msg = "Nomer/Kode Booking transaksi baru belum terdaftar. Silahkan referesh halaman ini. code: " . __LINE__;
                    mati_disini($msg);
                }
                $nomerBookingTransaksi = $_SESSION[$cCode]["main"]["bookingNumber"];
            }

            if (!isset($_SESSION[$cCode]['items'])) {
                mati_disini("belum ada item yang dipilih");
            }
            else {
                if (sizeof($_SESSION[$cCode]['items']) < 1) {
                    mati_disini("belum ada item yang dipilih");
                }
            }
            echo("now processing your transaction..<br>");

            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                //region build table rekening
                $buildTablesMaster = isset($this->configCoreJenis['components'][$jenisTrTarget]['master']) ? $this->configCoreJenis['components'][$jenisTrTarget]['master'] : array();
                $buildTablesDetail = isset($this->configCoreJenis['components'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['components'][$jenisTrTarget]['detail'] : array();
                $addMasterTables = array(
                    "rugilaba",
                    "laba ditahan",
                    "rugilaba lain lain",
                );
                foreach ($addMasterTables as $trek) {
                    $buildTablesMaster[] = array(
                        "comName" => "RugiLaba",
                        "loop" => array(
                            "$trek" => .0,
                        ),
                    );
                }
                if (sizeof($buildTablesMaster) > 0) {
                    $bCtr = 0;
                    foreach ($buildTablesMaster as $buildTablesMaster_specs) {
                        $bCtr++;
                        $mdlName = $buildTablesMaster_specs['comName'];
                        if (substr($mdlName, 0, 1) == "{") {
                            $mdlName = trim($mdlName, "{");
                            $mdlName = trim($mdlName, "}");
                            $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                        }
                        else {
                            cekkuning("TIDAK mengandung kurawal");
                        }
                        $mdlName = "Com" . $mdlName;
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        if (isset($buildTablesMaster_specs['loop']) && sizeof($buildTablesMaster_specs['loop']) > 0) {
                            foreach ($buildTablesMaster_specs['loop'] as $key => $val) {
                                if (substr($key, 0, 1) == "{") {
                                    $oldParam = $buildTablesMaster_specs['loop'][$key];
                                    cekHere($oldParam);
                                    unset($buildTablesMaster_specs['loop'][$key]);
                                    $key = trim($key, "{");
                                    $key = trim($key, "}");
                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                    $buildTablesMaster_specs['loop'][$key] = $oldParam;
                                }
                            }
                        }
                        if (method_exists($m, "getTableNameMaster")) {
                            if (sizeof($m->getTableNameMaster())) {
                                $m->buildTables($buildTablesMaster_specs);
                            }
                        }
                    }
                }
                if (sizeof($buildTablesDetail) > 0) {
                    foreach ($buildTablesDetail as $buildTablesDetail_specs) {
                        foreach ($_SESSION[$cCode]['items'] as $itemSpec) {
                            //arrPrint($itemSpec);
                            $mdlName = $buildTablesDetail_specs['comName'];
                            cekLime($mdlName);
                            if (substr($mdlName, 0, 1) == "{") {
                                $mdlName = trim($mdlName, "{");
                                $mdlName = trim($mdlName, "}");
                                $mdlName = str_replace($mdlName, $itemSpec[$mdlName], $mdlName);
                                //                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                            }
                            $mdlName = "Com" . $mdlName;
                            cekbiru("model: $mdlName");
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();

                            if (isset($buildTablesDetail_specs['loop']) && sizeof($buildTablesDetail_specs['loop']) > 0) {
                                foreach ($buildTablesDetail_specs['loop'] as $key => $val) {
                                    if (substr($key, 0, 1) == "{") {
                                        $oldParam = $buildTablesDetail_specs['loop'][$key];
                                        unset($buildTablesDetail_specs['loop'][$key]);
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $itemSpec[$key], $key);
                                        //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                        $buildTablesDetail_specs['loop'][$key] = $oldParam;
                                    }
                                }
                            }
                            if (method_exists($m, "getTableNameMaster")) {
                                if (sizeof($m->getTableNameMaster())) {
                                    $m->buildTables($buildTablesDetail_specs);
                                }
                            }
                        }
                    }
                }
                //endregion
            }

//
//            $this->db->trans_start();

            cekMerah("start pre-processor...");
            //
            //region pre-processors (item)
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['preProc']['detail']) ? $_SESSION[$cCode]['revert']['preProc']['detail'] : array();
                cekMerah(":: iterator preprocc dari gerbang revert ::");
                arrPrintWebs($iterator);
            }
            else {
                $iterator = isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['preProcessor'][$jenisTrTarget]['detail'] : array();
            }

            if (sizeof($iterator) > 0) {


                $itemNumLabels = isset($this->configUiJenis['shoppingCartNumFields']) ? $this->configUiJenis['shoppingCartNumFields'] : array();
                echo "ITEM NUM LABELS";

                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        echo "sub-preproc: $comName, initializing values <br>";

                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();

                            //                            $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (!isset($subParams['static']["transaksi_id"])) {
                                    //									$subParams['static']["transaksi_id"] = $masterID;
                                }


                                $subParams['static']["fulldate"] = $transaksi_current_fulldate;
                                $subParams['static']["dtime"] = $transaksi_current_dtime;
                                $subParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                            }
                            //                            cekLime(":: cetak preprocc... $comName :: $srcGateName ::");
                            //                            arrPrint($subParams);
                            //mati_disini();
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;


                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                //                                echo "sub preproc #$it: $comName, sending values <br>";

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);


                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();

                                    cekmerah("gotparams dari pre-proc $comName");
                                    arrprint($gotParams);


                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor

                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($_SESSION[$cCode][$gateName])) {
                                                $_SESSION[$cCode][$gateName] = array();
                                                //                                    cekhijau("building the session: $gateName");
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }

                                            foreach ($paramSpec as $id => $gSpec) {
                                                //										$id=$gSpec['id'];


                                                if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                    $_SESSION[$cCode][$gateName][$id] = array();
                                                }


                                                if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val");
                                                            $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                cekHitam("srcGateName = $srcGateName :: " . __LINE__);
                                                if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }

                                                //cekMerah("REBUILDING VALUES..");
                                                if (sizeof($itemNumLabels) > 0) {
                                                    //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        //cekHere("$id === $key => $label");
                                                        if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                            $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                            //                                    arrPrint($items);die();
                                        }


                                    }

                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }


                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }


                $this->load->helper("he_value_builder");
                fillValues_he_value_builder($this->jenisTr, 1, 1, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);


                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($_SESSION[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $_SESSION[$cCode]["revert"]["preProc"]["replacer"];
                    $jenisTrReference = $_SESSION[$cCode]["main"]["jenisTr_reference"];
                    switch ($jenisTrReference) {
                        case "460":
                            $tempCalculate = array(
                                //                                "selisih" => ($_SESSION[$cCode]["main"]["hpp_riil"] + $_SESSION[$cCode]["main"]["exchange__nilai_tambah_ppn_in"]) - ($_SESSION[$cCode]["main"]["exchange__nilai_tambah_piutang_pembelian"]),
                                //                                "exchange__harga" => $_SESSION[$cCode]["main"]["hpp_riil"],//riil
                                //                                "exchange__hpp_nppv" => $_SESSION[$cCode]["main"]["hpp_nppv"],//riil+ppv
                                //                                "exchange__ppv" => $_SESSION[$cCode]["main"]["ppv_riil"],//riil+ppv
                            );
                            break;
                        default:
                            $tempCalculate = array(
                                "selisih" => ($_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"]) - ($_SESSION[$cCode]["main"]["nett"] + $_SESSION[$cCode]["main"]["ppv"]),
                                "hpp_nppv" => $_SESSION[$cCode]["main"]["hpp"],
                                "hpp_nppn" => $_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"],
                            );
                            break;
                    }
                    //                    $tempCalculate = array(
                    //                        "selisih" => ($_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"]) - ($_SESSION[$cCode]["main"]["nett"] + $_SESSION[$cCode]["main"]["ppv"]),
                    //                        "hpp_nppv" => $_SESSION[$cCode]["main"]["hpp"],
                    //                        "hpp_nppn" => $_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"],
                    //                    );

                    //arrPrintWebs($tempCalculate);
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $_SESSION[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }

                    cekLime($_SESSION[$cCode]["main"]["hpp"] . "+" . $_SESSION[$cCode]["main"]["ppn"] . "-" . $_SESSION[$cCode]["main"]["nett"]);

                }

                //endregion


            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion


            //region pre-processors (master)
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['preProc']['master']) ? $_SESSION[$cCode]['revert']['preProc']['master'] : array();
            }
            else {
                $iterator = isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]['master']) ? $this->configCoreJenis['preProcessor'][$jenisTrTarget]['master'] : array();
            }

            if (sizeof($iterator) > 0) {

                $itemNumLabels = isset($this->configUiJenis['shoppingCartNumFields']) ? $this->configUiJenis['shoppingCartNumFields'] : array();


                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {

                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $switchResultParams = isset($tComSpec['switchResultParams']) ? $tComSpec['switchResultParams'] : false;

                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                $subParams['static'][$key] = $realValue;

                                //                                cekPink2("$comName == $value || $realValue");
                                //                                cekPink2("valas_harga " . $_SESSION[$cCode]['main']['valas_harga']);
                                //                                cekPink2("uang_muka_valas_harga " . $_SESSION[$cCode]['main']['uang_muka_valas_harga']);
                            }

                            if (!isset($subParams['static']["transaksi_id"])) {
                                //									$subParams['static']["transaksi_id"] = $masterID;
                            }

                            $subParams['static']["fulldate"] = $transaksi_current_fulldate;
                            $subParams['static']["dtime"] = $transaksi_current_dtime;
                            $subParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);


                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            cekbiru("gotparams dari pre-proc $comName");
                            arrprint($gotParams);

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    //										$id=$gSpec['id'];

                                    if ($switchResultParams == true) {

                                        foreach ($gSpec as $id => $ggSpec) {
                                            if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                $_SESSION[$cCode][$gateName][$id] = array();
                                            }

                                            if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                if (is_array($ggSpec) && sizeof($ggSpec) > 0) {
                                                    foreach ($ggSpec as $key => $val) {
                                                        $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                    }
                                                }
                                            }

                                            //cekMerah("REBUILDING VALUES..");
                                            if (sizeof($itemNumLabels) > 0) {
                                                //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                foreach ($itemNumLabels as $key => $label) {
                                                    //cekHere("$id === $key => $label");
                                                    if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                        $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                    }
                                                }
                                            }

                                        }
                                    }
                                    else {
                                        if (isset($_SESSION[$cCode]['main'])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode]['main'][$key] = $val;
                                                }
                                            }
                                        }
                                        //==inject gotParams to child gate
                                        if (isset($_SESSION[$cCode]['main'])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode]['main'][$key] = $val;
                                                }
                                            }
                                        }
                                        //cekMerah("REBUILDING VALUES..");
                                        if (sizeof($itemNumLabels) > 0) {
                                            //cekHijau("REBUILDING SUBS FOR ITEMS");
                                            foreach ($itemNumLabels as $key => $label) {
                                                cekHere("$id === $key => $label");
                                                if (isset($_SESSION[$cCode]['main'][$key])) {
                                                    $_SESSION[$cCode]['main']['sub_' . $key] = ($_SESSION[$cCode]['main']['jml'] * $_SESSION[$cCode]['main'][$key]);
                                                }
                                            }
                                        }
                                    }

                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }

                        cekPink2("fillvalue setelah $comName");
                        $this->load->helper("he_value_builder");
                        fillValues_he_value_builder($this->jenisTr, 1, 1, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);


                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }

                $this->load->helper("he_value_builder");
                fillValues_he_value_builder($this->jenisTr, 1, 1, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);
            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion


            $this->load->library("Validator");
            $vd = new Validator();
            $vd->setCCode($cCode);
            $vd->setConfigUiJenis($this->configUiJenis);
            $step = $_SESSION[$cCode]['main']['step_number'];
            $vd->midValidate($step);
            $vd->unionValidate();
//            mati_disini(__LINE__);
            //===finalisasi sebelum masuk tabel beneran
            //===isinya ada pembentukan nomor nota dll


            //region penomoran receipt
            //<editor-fold desc="==========penomoran">
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $counterForNumber = array($this->configCoreJenis['formatNota']);
            echo "format_nota";
            arrPrintPink($counterForNumber);
            if (!in_array($counterForNumber[0], $this->configCoreJenis['counters'])) {
                mati_disini(__LINE__ . " Used number should be registered in 'counters' config as well");
            }
            echo "<div style='background:#ff7766;'>";
            foreach ($counterForNumber as $i => $cRawParams) {
                $cParams = explode("|", $cRawParams);
                $cValues = array();
                foreach ($cParams as $param) {
                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                }
                $cRawValues = implode("|", $cValues[$i]);
//                arrPrintKuning($cParams);
//                arrPrintHijau($cValues);
                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

            }
            echo "</div style='background:#ff7766;'>";
            arrPrintWebs($paramSpec);
            // mati_disini("hahaha " . __LINE__);

            $stepNumber = 1;
            $tmpNomorNota = $paramSpec['paramString'];
            $tmpNomorNotaAlias = formatNota("nomer_nolink", $tmpNomorNota);
            if (isset($this->configUiJenis['steps'][2])) {
                $nextProp = array(
                    "num" => 2,
                    "code" => $this->configUiJenis['steps'][2]['target'],
                    "label" => $this->configUiJenis['steps'][2]['label'],
                    "groupID" => $this->configUiJenis['steps'][2]['userGroup'],
                );
            }
            else {
                $nextProp = array(
                    "num" => 0,
                    "code" => "",
                    "label" => "",
                    "groupID" => "",
                );
            }
            //</editor-fold>
            //endregion


            //region dynamic counters
            // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $configCustomParams = $this->configCoreJenis['counters'];
            $configCustomParams[] = "stepCode";
            //arrPrint($configCustomParams);
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                    switch ($paramSpec['id']) {
                        case 0: //===counter type is new
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                            break;
                    }
                    //echo "<hr>";
                    showLast_query("orange");
                }
            }
            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);
            //mati_disini();

            // arrPrintKuning($paramSpec);
            //region addition on master


            $addValues = array(
                'counters' => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'nomer2' => $tmpNomorNotaAlias,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => sizeof($this->configUiJenis['steps']),
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp['num'],
                "next_step_code" => $nextProp['code'],
                "next_step_label" => $nextProp['label'],
                "next_group_code" => $nextProp['groupID'],
                "tail_number" => 1,
                "tail_code" => $this->configUiJenis['steps'][1]['target'],


            );
            foreach ($addValues as $key => $val) {
                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
            }
            //endregion

            //
            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => sizeof($this->configUiJenis['steps']),
                "next_substep_num" => $nextProp['num'],
                "next_substep_code" => $nextProp['code'],
                "next_substep_label" => $nextProp['label'],
                "next_subgroup_code" => $nextProp['groupID'],
                "sub_tail_number" => 1,
                "sub_tail_code" => $this->configUiJenis['steps'][1]['target'],


            );
            foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
                }
            }
            //endregion
            // </editor-fold>
            //endregion


            //region numbering tambahan jasmanto
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($_SESSION[$cCode]['tableIn_master']);
            $ccn->setMainGate($_SESSION[$cCode]['main']);
            $ccn->setItemsGate($_SESSION[$cCode]['items']);
            $ccn->setItems2SumGate($_SESSION[$cCode]['items2_sum']);
            $new_counter = $ccn->getCounterNumber();
            cekHitam("jenistr yang disett dari create " . $this->jenisTr);
            echo "___counter";
            arrPrintHijau($new_counter);


            $costum_counter = array(
                "_dtime",
                "_company",
                "_company_stepCode"
            );

            foreach ($costum_counter as $item) {
                $counter_nilai = $new_counter['main'][$item];

                $var = $counter_nilai;
                if ($hasil == "") {
                    $hasil .= "$var";
                }
                else {
                    $hasil = "$hasil" . "-" . "$var";
                }

            }
            // cekBiru("hasil $hasil");
            // matiHere(__LINE__);
            if (isset($new_counter['main']) && sizeof($new_counter['main']) > 0) {
                foreach ($new_counter['main'] as $ckey => $cval) {
                    $_SESSION[$cCode]['tableIn_master'][$ckey] = $cval;
                    $_SESSION[$cCode]['main'][$ckey] = $cval;
                }
            }
            if (isset($new_counter['items']) && sizeof($new_counter['items']) > 0) {
                foreach ($new_counter['items'] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $_SESSION[$cCode]['items'][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter['items2_sum']) && sizeof($new_counter['items2_sum']) > 0) {
                foreach ($new_counter['items2_sum'] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $_SESSION[$cCode]['items2_sum'][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion


            //region ----------write transaksi, transaksi_data, main_fields, main_values, main_applets, etc
            if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

                $_SESSION[$cCode]['tableIn_master']['status_4'] = 11;
                $_SESSION[$cCode]['tableIn_master']['trash_4'] = 0;
                $_SESSION[$cCode]['tableIn_master']['cli'] = 1;
                $_SESSION[$cCode]['tableIn_master']['dtime'] = $transaksi_current_dtime;
                $_SESSION[$cCode]['tableIn_master']['fulldate'] = $transaksi_current_fulldate;


                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }
                $mongoList['main'] = array($insertID, $epID);
                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => $tmpNomorNotaAlias,
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($_SESSION[$cCode][$target])) {
                            foreach ($_SESSION[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec['id']) && $iSpec['id'] > 0 ? $iSpec['id'] : $xid;
                                if (isset($_SESSION[$cCode][$target][$id])) {
                                    $_SESSION[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
                    "step_name" => $this->configUiJenis['steps'][1]['label'],
                    "group_code" => $this->configUiJenis['steps'][1]['userGroup'],
                    "oleh_id" => "-100",
                    "oleh_nama" => "system",
                    "keterangan" => $this->configUiJenis['steps'][1]['label'] . " oleh system",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");
                $mongoList['sign'][] = $dwsign;
                $idHis = array(
                    $stepNumber => array(
                        "dtime" => date("Y-m-d H:i:s"),
                        "fulldate" => date("Y-m-d"),
                        "olehID" => $_SESSION[$cCode]['main']['olehID'],
                        "olehName" => $_SESSION[$cCode]['main']['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => $tmpNomorNotaAlias,
                        "counters" => $appliedCounters,
                        "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp['num'],
                    "next_step_code" => $nextProp['code'],
                    "next_step_label" => $nextProp['label'],
                    "next_group_code" => $nextProp['groupID'],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());

                arrPrintWebs($_SESSION[$cCode]['tableIn_master']);

                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,
                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

            }
            if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configCoreJenis['tableIn']['mainValues'])) {
                    //matiHEre("hooppp");
                    $inserMainValues = array();
                    foreach ($this->configCoreJenis['tableIn']['mainValues'] as $key => $src) {
                        if (isset($_SESSION[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $_SESSION[$cCode]['tableIn_master_values'][$key],
                            ));

                            $inserMainValues[] = $dd;
                            $mongoList['mainValues'][] = $dd;
                        }
                    }
                }

                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }

            }
            if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                    $mongoList['mainValues'][] = $dd;
                }

                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    //                    cekkuning("making a clone for input key $key / $val");
                    //                    $tmpTableIn=$_SESSION[$cCode]['tableIn_master'];
                    //                    $replacers=array(
                    //                        "nomer"=>$_SESSION[$cCode]['tableIn_master']['nomer']."_$key",
                    //                    );
                    //                    foreach($replacers as $key=>$val){
                    //                        $tmpTableIn[$key]=$val;
                    //                    }
                    //                    $subInputInsertID = $tr->writeMainEntries($tmpTableIn);
                }
            }
            if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($_SESSION[$cCode]['main_applets']) && sizeof($_SESSION[$cCode]['main_applets']) > 0) {
                foreach ($_SESSION[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec['label'],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
//                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));


                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec['value'];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        //					cekhijau("$eName terdaftar pada relInputs");


                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec['label'];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']['groupID'])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']['groupID'];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }

                    }

                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {

                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                        $mongoList['detail'][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                            $mongoList['detail'][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }


                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }

                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detail'] = $insertIDs;
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    $mongoList['detail'][] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detil'][] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detil'] = $insertIDs;
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {

                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configCoreJenis['tableIn']['detailValues'])) {
                        foreach ($this->configCoreJenis['tableIn']['detailValues'] as $key => $src) {
                            if (isset($_SESSION[$cCode]['tableIn_detail'][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                                $mongoList['detailValues'][] = $dd;

                            }
                        }
                    }
                }

                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }

            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configCoreJenis['tableIn']['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configCoreJenis['tableIn']['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }
                }
            }
            //endregion


            //===components akan langsung dieksekusi jika steps-nya tidak pakai approval
            $steps = $this->configUiJenis['steps'];

            //region processing sub-components, if in single step geser ke CLI

            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            //            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $filterNeeded = false;
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['jurnal']['detail']) ? $_SESSION[$cCode]['revert']['jurnal']['detail'] : array();
                $revertedTarget = $_SESSION[$cCode]['main']['pihakExternID'];
            }
            else {
                $iterator = isset($this->configCoreJenis['components'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['components'][$jenisTrTarget]['detail'] : array();
                $revertedTarget = "";
            }
            $componentConfig['detail'] = $iterator;
            //            //region processing sub-components
            //            if (sizeof($iterator) > 0) {
            //                foreach ($iterator as $cCtr => $tComSpec) {
            //                    $tmpOutParams[$cCtr] = array();
            //                    $gg = 0;
            //                    $srcGateName = $tComSpec['srcGateName'];
            //                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
            //                        $srcRawGateName = $tComSpec['srcRawGateName'];
            //                        $comName = $tComSpec['comName'];
            //                        if (substr($comName, 0, 1) == "{") {
            //                            $comName = trim($comName, "{");
            //                            $comName = trim($comName, "}");
            //                            //                            $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
            //                            cekLime($cCode . " || " . $srcGateName . " || " . $id . " || " . $comName);
            //                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
            //                        }
            //                        cekHitam(":: $comName ::");
            //                        $mdlName = "Com" . ucfirst($comName);
            //                        if (in_array($mdlName, $compValidators)) {//perlu validasi filter
            ////cekLime($mdlName. "line");
            //                            $filterNeeded = true;
            //                        }
            //                        else {
            //                            cekLime($mdlName . "like");
            //                            $filterNeeded = false;
            //                        }
            //                        echo "sub-component: $comName, initializing values <br>";
            //                        //                        cekHitam(__LINE__);
            //                        //                        $tmpOutParams[$cCtr] = array();
            //
            //                        //                        cekhitam("$comName filterneeded: $filterNeeded");
            //                        //                        cekhitam("mau mengiterasi $srcGateName");
            //                        //                        cekhitam("telah mengiterasi $srcGateName");
            //                        //
            //                        $subParams = array();
            ////arrPrint($tComSpec);
            //                        if (isset($tComSpec['loop'])) {
            //                            foreach ($tComSpec['loop'] as $key => $value) {
            //                                cekMerah(":: $key => $value ::");
            //                                if (substr($key, 0, 1) == "{") {
            //                                    $key = trim($key, "{");
            //                                    $key = trim($key, "}");
            //                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
            //                                    $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$id][$key], $key);
            //                                }
            //
            //                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
            //                                $subParams['loop'][$key] = $realValue;
            //
            //                                if ($filterNeeded) {
            //                                    if ($subParams['loop'][$key] == 0) {
            //                                        unset($subParams['loop'][$key]);
            //                                    }
            //                                }
            //                            }
            //                        }
            //                        if (isset($tComSpec['static'])) {
            //                            foreach ($tComSpec['static'] as $key => $value) {
            //
            //                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
            //                                $subParams['static'][$key] = $realValue;
            //
            //                            }
            //                            if (!isset($subParams['static']["transaksi_id"])) {
            //                                $subParams['static']["transaksi_id"] = $insertID;
            //                            }
            //                            if (!isset($subParams['static']["transaksi_no"])) {
            //                                $subParams['static']["transaksi_no"] = $insertNum;
            //                            }
            //
            //                            $subParams['static']["fulldate"] = $transaksi_current_fulldate;
            //                            $subParams['static']["dtime"] = $transaksi_current_dtime;
            //                            $subParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
            //                            if (strlen($revertedTarget) > 1) {
            //                                $subParams['static']['reverted_target'] = $revertedTarget;
            //                            }
            //                        }
            //                        //arrPrint($subParams);
            //                        if (sizeof($subParams) > 0) {
            ////                            arrprint($subParams);
            //                            cekhitam("subparam ada isinya");
            //                            if ($filterNeeded) {
            //                                if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
            //                                    $tmpOutParams[$cCtr][] = $subParams;
            //                                }
            //                            }
            //                            else {
            //                                $tmpOutParams[$cCtr][] = $subParams;
            ////                                CekHijiau("asem" .$gg++);
            //                            }
            //                        }
            //                        else {
            //                            cekhitam("subparam TIDAK ada isinya");
            //                        }
            //                    }
            //
            //                    $componentGate['detail'][$cCtr] = $subParams;
            //                }
            //                //cekHitam("cetak tmpOutParams");
            //
            //                foreach ($iterator as $cCtr => $tComSpec) {
            //                    $srcGateName = $tComSpec['srcGateName'];
            //                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
            //
            //                        $srcRawGateName = $tComSpec['srcRawGateName'];
            //                        $comName = $tComSpec['comName'];
            //                        if (substr($comName, 0, 1) == "{") {
            //                            $comName = trim($comName, "{");
            //                            $comName = trim($comName, "}");
            //                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
            //                            //                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
            //                        }
            //                    }
            //                    echo "sub component: $comName, sending values <br>";
            //
            //                    $mdlName = "Com" . ucfirst($comName);
            //                    $this->load->model("Coms/" . $mdlName);
            //                    $m = new $mdlName();
            //                    //===filter value nol, jika harus difilter
            ////                    arrPrint($tmpOutParams[$cCtr]);
            //                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
            //                        $tobeExecuted = true;
            //                    }
            //                    else {
            //                        $tobeExecuted = false;
            //                    }
            //
            //                    if ($tobeExecuted) {
            //                        cekMerah("$comName dieksekusiii");
            //                        arrPrint($tmpOutParams[$cCtr]);
            //                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
            //                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
            //                        cekBiru($this->db->last_query());
            //                    }
            //                    else {
            //                        cekMerah("$comName tidak eksekusi");
            //                    }
            //
            //                }
            //            }
            //            else {
            //                //cekKuning("subcomponents is not set");
            //            }
            //            //endregion

            //endregion

            //region processing main components, if in single step
            $componentJurnal = array();
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['jurnal']['master']) ? $_SESSION[$cCode]['revert']['jurnal']['master'] : array();
            }
            else {
                $iterator = isset($this->configCoreJenis['components'][$jenisTrTarget]['master']) ? $this->configCoreJenis['components'][$jenisTrTarget]['master'] : array();
            }

            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "component # $cCtr: $comName<br>";

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                            }

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                            //                            cekKuning("LOOP $key diisi dengan $realValue");
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = $transaksi_current_fulldate;
                        $tmpOutParams['static']["dtime"] = $transaksi_current_dtime;
                        $tmpOutParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }


                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;

                    if (in_array($mdlName, $compValidators)) {

                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }

                    }

                    if ($tobeExecuted) {

                        //cekBiru("kiriman komponem $comName");
                        //                        arrPrint($tmpOutParams);
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }

                    $componentGate['master'][$cCtr] = $tmpOutParams;
                    if ($comName == "Jurnal") {
                        $componentJurnal[] = $tmpOutParams;
                    }
                }
            }
            else {
                //cekKuning("components is not set");
            }


            //endregion


            cekHitam(":: START POST PROCC DETAIL... ::");

            //region processing sub-post-processors, always
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['postProc']['detail']) ? $_SESSION[$cCode]['revert']['postProc']['detail'] : array();
                cekHitam("post procc pakai revert");
            }
            else {
                $iterator = isset($this->configCoreJenis['postProcessor'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['postProcessor'][$jenisTrTarget]['detail'] : array();
                cekHitam("post procc pakai config core");
            }
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();
                    if (isset($_SESSION[$cCode][$srcGateName]) && (sizeof($_SESSION[$cCode][$srcGateName]) > 0)) {
                        arrPrint($_SESSION[$cCode][$srcGateName]);
                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            //                            $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    cekHitam("gate: $srcGateName, dengan key $id");
                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = $transaksi_current_fulldate;
                                $subParams['static']["dtime"] = $transaksi_current_dtime;
                                if (isset($_SESSION[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $_SESSION[$cCode]['main']['pihakExternID'];
                                }

                                $subParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($_SESSION[$cCode][$srcGateName])) {
                        echo "[$cCtr] sub-postProcessor: $comName, sending values <br>";

                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        //arrPrint($tmpOutParams[$cCtr]);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekPink($this->db->last_query());
                    }

                }
            }
            //endregion


            //region relesaese connected payment source dan marking trash transaksi
            //            arrPrint($_SESSION[$cCode]["revert"]);
            if (isset($_SESSION[$cCode]["revert"]["connectedPaymentsource"]) && $_SESSION[$cCode]["revert"]["connectedPaymentsource"] == true) {
                $keyRel = $_SESSION[$cCode]["main"]["referenceID"];
                $keyRelRef = $_SESSION[$cCode]["main"]["pihakExternID"];
                $relPaymentSrc = isset($this->config->item("payment_source")[$keyRelRef]) ? $this->config->item("payment_source")[$keyRelRef] : array();
                if (sizeof($relPaymentSrc) > 0) {
                    $this->load->model("Mdls/MdlPaymentSource");
                    $m = new MdlPaymentSource();
                    $m->addFilter("transaksi_id='$keyRel'");
                    $tmpRelPay = $m->lookupAll()->result();
                    $paymentRelUsed = array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "label" => ".hutang biaya",
                        "target_jenis" => "jenisTr",
                        "transaksi_id" => "refID",
                        "terbayar" => "nilai_bayar",
                        "sisa" => "new_sisa",
                        "ppn" => "valid_ppn",
                        "extern_nilai2" => "valid_dpp",
                    );
                    if (sizeof($tmpRelPay) > 0) {
                        $tmpOutParams = array();
                        $iterator = array();
                        foreach ($tmpRelPay as $indexKey => $relData) {
                            $tmp = array();
                            foreach ($paymentRelUsed as $key => $keyGate) {
                                if ($key == "terbayar") {
                                    $val = $relData->sisa;
                                }
                                else {
                                    if ($key == "sisa") {
                                        $val = "-" . $relData->sisa;
                                    }
                                    else {
                                        $val = $relData->$key;
                                    }
                                }
                                $tmp["static"][$key] = $val;
                                $tmp["static"]["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];

                            }
                            $iterator[$indexKey]["loop"] = array();
                            $iterator[$indexKey]["comName"] = "PaymentSrcItem";
                            if (sizeof($tmp) > 0) {
                                $tmpOutParams[$indexKey][] = $tmp;
                            }
                        }
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $comName = $tComSpec['comName'];
                            //                            $srcGateName = $tComSpec['srcGateName'];
                            //                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            echo "sub-postProcessor: $comName, sending values <br>";

                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();
                            $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            //                            cekHitam($this->db->last_query());
                        }
                    }
                    //                    foreach()
                    cekLime("yuk direset paymentsource**");
                }


            }
            //endregion


            //region processing main-post-processors, always
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['postProc']['detail']) ? $_SESSION[$cCode]['revert']['postProc']['master'] : array();
            }
            else {
                $iterator = isset($this->configCoreJenis['postProcessor'][$jenisTrTarget]['master']) ? $this->configCoreJenis['postProcessor'][$jenisTrTarget]['master'] : array();
            }

            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "post-processor: $comName<br>LINE: " . __LINE__;

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;

                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static']["fulldate"] = $transaksi_current_fulldate;
                        $tmpOutParams['static']["dtime"] = $transaksi_current_dtime;
                        $tmpOutParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }
                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    arrPrint($tmpOutParams);
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    //cekHitam($this->db->last_query());

                }
            }
            else {

            }
            //endregion

            //cekHijau(":: HALLOOO ::");

            //region updater main transaksi rejection jurnal next step exist
            $mongUpdateList = array();
            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {

                $tr->setFilters(array());
                $tr->addFilter("id='" . $_SESSION[$cCode]["main"]["referenceID"] . "'");
                $tempData = $tr->lookupAll()->result();
                $refMasterID = $tempData[0]->id_master;
                $refMasterJenis = $tempData[0]->jenis_master;
                $nextStepCode = $tempData[0]->next_step_code;
                $mainStepCode = $tempData[0]->jenis;
                $stepnum = $tempData[0]->step_number;
                $stepnumAvail = $tempData[0]->step_avail;
                if (($stepnumAvail - $stepnum) > 0) {
                    //                    matiHere("masukk".$nextStepCode);
                    $this->load->model("Coms/ComTransaksi_jurnal_revert");
                    $r = new ComTransaksi_jurnal_revert();
                    $outParams = array(
                        "refID" => $refMasterID,
                        "main_code" => $mainStepCode,
                        "next_code" => $nextStepCode,
                        "step_num" => $stepnum,
                    );
                    $r->pair($outParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $r->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);

                    //marking main transaksi trash4
                    $udpate = array(
                        "trash_4" => "1",
                    );
                    $tr->setFilters(array());
                    //                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array(
                        //                "id" => $no,
                        "id" => $_SESSION[$cCode]["main"]["referenceID"],
                    ), $udpate) or die("Failed to update tr next-state!");
                    $mongUpdateList['update']['main'][] = array(
                        "where" => array("id" => $_SESSION[$cCode]["main"]["referenceID"]),
                        "value" => array(
                            "trash_4" => "1",
                        ),
                    );
                    cekHijau("UPDATE transaksi step sebelumnya...");
                    cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                    //update validqty 0 supaya gak bisa difollowup
                    //                    $arrData_detail["valid_qty"] = 0;
                    $td = new MdlTransaksi();
                    $td->setFilters(array());
                    $rslt = $td->lookupJoinedByID($_SESSION[$cCode]["main"]["referenceID"])->result();
                    if (sizeof($rslt) > 0) {
                        foreach ($rslt as $rsltSpec) {
                            if (array_key_exists($rsltSpec->produk_id, $_SESSION[$cCode]["items"])) {
                                //                                $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");
                                //
                                //                                if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty;
                                //                                    //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                //                                }
                                //                                else {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                }
                                $arrData_detail["valid_qty"] = 0;
                                $tr = new MdlTransaksi();
                                $tr->setFilters(array());
                                $tr->setTableName($tr->getTableNames()['detail']);
                                $dupState = $tr->updateData(array(
                                    "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                    "produk_id" => $rsltSpec->produk_id,
                                ), $arrData_detail) or die("Failed to update tr next-state!");
                                $mongUpdateList['update']['detail'][] = array(
                                    "where" => array(
                                        "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                        "produk_id" => $rsltSpec->produk_id,
                                    ),
                                    "value" => $arrData_detail,
                                );
                                cekKuning("UPDATE transaksi data...");
                                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                            }
                        }
                    }

                    $dwsign = $tr->writeSignature($refMasterID, array(
                        "prev_id" => "",
                        "nomer" => "pembatalan jurnal",
                        "step_number" => "-" . $stepnum, // ini minus step number
                        "step_code" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['target'],
                        "step_name" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['label'],
                        "group_code" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['userGroup'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "keterangan" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['label'] . " oleh " . $this->session->login['nama'],
                        //            "transaksi_id" => $no,
                    )) or die("Failed to write signature");
                    $mongoList['sign'][] = $dwsign;
                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    //                    matiHere();
                }
                else {

                    //marking main transaksi trash4
                    $udpate = array(
                        "trash_4" => "1",
                    );
                    $tr->setFilters(array());
                    //                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array(
                        //                "id" => $no,
                        "id" => $_SESSION[$cCode]["main"]["referenceID"],
                    ), $udpate) or die("Failed to update tr next-state!");
                    cekHijau("UPDATE transaksi step sebelumnya...");
                    cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    $mongUpdateList['update']['main'][] = array(
                        "where" => array("id" => $_SESSION[$cCode]["main"]["referenceID"]),
                        "value" => array(
                            "trash_4" => "1",
                        ),
                    );

                    //update validqty 0 supaya gak bisa difollowup
                    $arrData_detail["valid_qty"] = $new_valid_qty;
                    $td = new MdlTransaksi();
                    $td->setFilters(array());
                    $rslt = $td->lookupJoinedByID($_SESSION[$cCode]["main"]["referenceID"])->result();
                    if (sizeof($rslt) > 0) {
                        foreach ($rslt as $rsltSpec) {
                            if (array_key_exists($rsltSpec->produk_id, $_SESSION[$cCode]["items"])) {
                                //                                $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");
                                //
                                //                                if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty;
                                //                                    //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                //                                }
                                //                                else {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                }
                                $arrData_detail["valid_qty"] = 0;
                                $tr = new MdlTransaksi();
                                $tr->setFilters(array());
                                $tr->setTableName($tr->getTableNames()['detail']);
                                $dupState = $tr->updateData(array(
                                    "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                    "produk_id" => $rsltSpec->produk_id,
                                ), $arrData_detail) or die("Failed to update tr next-state!");
                                cekKuning("UPDATE transaksi data...");
                                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                $mongUpdateList['update']['detail'][] = array(
                                    "where" => array(
                                        "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                        "produk_id" => $rsltSpec->produk_id,
                                    ),
                                    "value" => $arrData_detail,
                                );
                            }
                        }
                    }

                    $dwsign = $tr->writeSignature($refMasterID, array(
                        "prev_id" => "",
                        "nomer" => "pembatalan jurnal",
                        "step_number" => "-" . $stepnum, // ini minus step number
                        "step_code" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['target'],
                        "step_name" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['label'],
                        "group_code" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['userGroup'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "keterangan" => $this->configUi[$refMasterJenis]['steps'][abs($stepnum)]['label'] . " oleh " . $this->session->login['nama'],
                        //            "transaksi_id" => $no,
                    )) or die("Failed to write signature");
                    $mongoList['sign'][] = $dwsign;
                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                    //                    matiHEre("uhuu");
                }
            }

            //endregion

            // region berlaku pembatalan transaksi bila ada config revertStep di model MdlRevertJurnal (true)
            if (isset($_SESSION[$cCode]['main']['pihakExternRevertStep']) && ($_SESSION[$cCode]['main']['pihakExternRevertStep'] == true)) {
                $referenceNextProp = (isset($_SESSION[$cCode]['main']['referenceNextProp']) && (sizeof($_SESSION[$cCode]['main']['referenceNextProp']) > 0)) ? $_SESSION[$cCode]['main']['referenceNextProp'] : array();
                if (sizeof($referenceNextProp) > 0) {
                    // update transaksi reference, step sebelumnya menjadi aktif lagi
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $dupState = $tr->updateData(array("id" => $referenceNextProp['trID']), array(
                        "next_step_code" => $referenceNextProp['code'],
                        "next_step_label" => $referenceNextProp['label'],
                        "next_group_code" => $referenceNextProp['groupID'],
                        "next_step_num" => $referenceNextProp['num'],
                        "step_current" => $referenceNextProp['step_num'],

                    )) or die("Failed to update tr next-state!");
                    cekHijau("BATAL :: " . $this->db->last_query() . " -- " . $this->db->affected_rows());
                    $mongUpdateList['update']['main'][] = array(
                        "where" => array("id" => $referenceNextProp['trID']),
                        "value" => array(
                            "next_step_code" => $referenceNextProp['code'],
                            "next_step_label" => $referenceNextProp['label'],
                            "next_group_code" => $referenceNextProp['groupID'],
                            "next_step_num" => $referenceNextProp['num'],
                            "step_current" => $referenceNextProp['step_num'],
                        ),
                    );


                    // update transaksi data reference, step sebelumnya menjadi aktif lagi
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("trash='0'");
                    $tr->addFilter("transaksi_id='" . $referenceNextProp['trID'] . "'");
                    $tr->setTableName($tr->getTableNames()['detail']);
                    $detailTmp = $tr->lookupAll()->result();
                    $detailData = array();
                    foreach ($detailTmp as $dTmpSpec) {
                        $detailData[$dTmpSpec->produk_id] = array(
                            "valid_qty" => $dTmpSpec->valid_qty,
                        );
                    }
                    cekOrange($referenceNextProp['detailGate']);
                    if (isset($_SESSION[$cCode][$referenceNextProp['detailGate']]) && ($_SESSION[$cCode][$referenceNextProp['detailGate']] != NULL)) {

                        foreach ($_SESSION[$cCode][$referenceNextProp['detailGate']] as $itemsSpec) {
                            //                        arrPrint($itemsSpec);
                            $valid_qty = isset($detailData[$itemsSpec['id']]['valid_qty']) ? $detailData[$itemsSpec['id']]['valid_qty'] : 0;
                            $valid_qty_new = $valid_qty + $itemsSpec['qty'];

                            $tr = new MdlTransaksi();
                            $tr->setFilters(array());
                            $tr->setTableName($tr->getTableNames()['detail']);
                            $ddupState = $tr->updateData(
                                array(
                                    "transaksi_id" => $referenceNextProp['trID'],
                                    "trash" => 0,
                                    "produk_id" => $itemsSpec['id'],
                                ), array(
                                "next_substep_code" => $referenceNextProp['code'],
                                "next_substep_label" => $referenceNextProp['label'],
                                "next_subgroup_code" => $referenceNextProp['groupID'],
                                "next_substep_num" => $referenceNextProp['num'],
                                "sub_step_current" => $referenceNextProp['step_num'],
                                "valid_qty" => $valid_qty_new,

                            )) or die("Failed to update tr next-state!");
                            cekHijau("BATAL :: " . $this->db->last_query() . " -- " . $this->db->affected_rows());
                            $mongUpdateList['update']['detail'][] = array(
                                "where" => array(
                                    "transaksi_id" => $referenceNextProp['trID'],
                                    "trash" => 0,
                                    "produk_id" => $itemsSpec['id'],
                                ),
                                "value" => array(
                                    "next_substep_code" => $referenceNextProp['code'],
                                    "next_substep_label" => $referenceNextProp['label'],
                                    "next_subgroup_code" => $referenceNextProp['groupID'],
                                    "next_substep_num" => $referenceNextProp['num'],
                                    "sub_step_current" => $referenceNextProp['step_num'],
                                    "valid_qty" => $valid_qty_new,
                                ),
                            );

                        }
                    }
                }
            }
            // endregion


            //
            //region nulis paymentSource
            $stepCode = $this->configUiJenis['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_source");
            if (array_key_exists($stepCode, $paymentSources)) {

                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs[1] as $paymentSrcConfig) {
                        $valueLabel = isset($paymentSrcConfig['label_key']) ? $paymentSrcConfig['label_key'] : $paymentSrcConfig['label'];
                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        $paymentMethod = isset($paymentSrcConfig['method']) ? $paymentSrcConfig['method'] : "insert";

                        if ($paymentMethod == "update") {
                            $filters = array(
                                "extern_id" => ""
                            );
                            //                            arrPrint($externSrc);
                            $tr->setFilters(array());
                            $tmpData = $tr->lookupPaymentSrcByJenis($paymentSrcConfig['jenisTarget'])->result();
                            if (sizeof($tmpData) > 0) {
                                //sudah ada update aja gak perlu insert
                                $prevID = $tmpData[0]->id;
                                $preValue = $tmpData[0]->sisa;
                                $currValue = isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0;
                                $newValue = $preValue + $currValue;
                                $where = array(
                                    "id" => $prevID,
                                    //                                    "transaksi_id" => $pSpec->transaksi_id,
                                );
                                $data = array(
                                    "tagihan" => $newValue,
                                    "sisa" => $newValue,
                                );
                                $tr->updatePaymentSrc($where, $data);
                                //                                cekHitam($this->db->last_query());
                            }
                            else {
                                //di insert baru
                                $tr->writePaymentSrc($insertID, array(
                                    "jenis" => $stepCode,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                    "terbayar" => 0,
                                    "sisa" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                    "valas_id" => (isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']])) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                    "valas_nama" => (isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']])) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                    "valas_nilai" => (isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']])) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : 0,
                                    "tagihan_valas" => (isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : 0,
                                    "terbayar_valas" => (isset($externSrc['valasTerbayar']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : 0,
                                    "sisa_valas" => (isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']])) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : 0,
                                    "extern_label2" => (isset($externSrc['extern_label2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_label2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_label2']] : "",
                                    "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : 0,
                                ));
                            }


                        }
                        else {
                            //region cek duplikasi paymentsource
                            $tr->setFilters(array());
                            $tr->addFilter("transaksi_id='$insertID'");
                            $tr->addFilter("target_jenis='" . $paymentSrcConfig['jenisTarget'] . "'");
                            // $tr->addFilter("target_jenis='759'");
                            $validateIsInserted = $tr->lookUpAllPaymentSrc()->result();
                            if (sizeof($validateIsInserted) > 0) {
                                matiHEre("Gagal menulis transaksi. Silahkan relogin untuk membersihkan sesi demi menghindari duplikasi data, dan coba kembali transaksi yang gagal");
                            }
                            //endregion

                            //-----------------------
                            cekHitam("valuelabel: $valueLabel, valueSrc: $valueSrc");
                            $this->load->helper("he_payment_source");
                            paymentSource($this->jenisTr, $componentJurnal, $_SESSION[$cCode]['main'], $valueLabel, $valueSrc);
                            //-----------------------

                            $arrDataPym = array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                "terbayar" => 0,
                                "sisa" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                                "valas_id" => (isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']])) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                "valas_nama" => (isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']])) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                "valas_nilai" => (isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']])) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : 0,
                                "tagihan_valas" => (isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : 0,
                                "terbayar_valas" => (isset($externSrc['valasTerbayar']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : 0,
                                "sisa_valas" => (isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']])) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : 0,
                                "extern_label2" => (isset($externSrc['extern_label2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_label2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_label2']] : "",
                                "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : 0,
                                "payment_locked" => (isset($externSrc['payment_locked']) && ($_SESSION[$cCode]['main'][$externSrc['payment_locked']])) ? $_SESSION[$cCode]['main'][$externSrc['payment_locked']] : 0,
                                "cash_account" => (isset($externSrc['cash_account']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account']] : 0,
                                "cash_account_nama" => (isset($externSrc['cash_account_nama']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account_nama']] : 0,
                                "extern2_id" => (isset($externSrc['extern2_id']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_id']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_id']] : 0,
                                "extern2_nama" => (isset($externSrc['extern2_nama']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_nama']] : 0,
                            );
                            arrPrintWebs($arrDataPym);
                            $tr->writePaymentSrc($insertID, $arrDataPym);
                        }

                        cekMerah($this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion


            //
            //region nulis paymentAntiSource
            $stepCode = $this->configUiJenis['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_antiSource") != null ? $this->config->item("payment_antiSource") : array();
            if (array_key_exists($stepCode, $paymentSources)) {
                cekHitam(":: starting PAYMENT ANTI SOURCE");
                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs as $paymentSrcConfig) {
                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        $tr->writePaymentAntiSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $_SESSION[$cCode]['main']['nomer'],
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                            "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                            "terbayar_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : '',
                            "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',

                        ));
                        //cekMerah($this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion


            //====registri value-gate
            if (isset($this->configCoreJenis['components'][$jenisTrTarget]) && sizeof($this->configCoreJenis['components'][$jenisTrTarget])) {
                $jurnalIndex = $this->configCoreJenis['components'][$jenisTrTarget];
            }
            else {
                if (isset($_SESSION[$cCode]["revert"]["jurnal"]) && sizeof($_SESSION[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $_SESSION[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //---------------------------------------------------
            if (isset($this->configCoreJenis['postProcessor'][$jenisTrTarget]) && sizeof($this->configCoreJenis['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configCoreJenis['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($_SESSION[$cCode]["revert"]["postProc"]) && sizeof($_SESSION[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $_SESSION[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //---------------------------------------------------
            if (isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]) && sizeof($this->configCoreJenis['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $this->configCoreJenis['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($_SESSION[$cCode]["revert"]["preProc"]) && sizeof($_SESSION[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $_SESSION[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //---------------------------------------------------


            $baseRegistries = array(
                'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                'itemSrc' => isset($_SESSION[$cCode]['itemSrc']) ? $_SESSION[$cCode]['itemSrc'] : array(),
                'itemSrc_sum' => isset($_SESSION[$cCode]['itemSrc_sum']) ? $_SESSION[$cCode]['itemSrc_sum'] : array(),
                'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                'items4' => isset($_SESSION[$cCode]['items4']) ? $_SESSION[$cCode]['items4'] : array(),
                'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                'items5_sum' => isset($_SESSION[$cCode]['items5_sum']) ? $_SESSION[$cCode]['items5_sum'] : array(),
                'items6_sum' => isset($_SESSION[$cCode]['items6_sum']) ? $_SESSION[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($_SESSION[$cCode]['items7_sum']) ? $_SESSION[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($_SESSION[$cCode]['items8_sum']) ? $_SESSION[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($_SESSION[$cCode]['items9_sum']) ? $_SESSION[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($_SESSION[$cCode]['items10_sum']) ? $_SESSION[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),
                'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutJenis['receiptDetailFields'][1]) ? $this->configLayoutJenis['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutJenis['receiptSumFields'][1]) ? $this->configLayoutJenis['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutJenis['receiptDetailFields2'][1]) ? $this->configLayoutJenis['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutJenis['receiptDetailSrcFields'][1]) ? $this->configLayoutJenis['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutJenis['receiptSumFields2'][1]) ? $this->configLayoutJenis['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($_SESSION[$cCode]['revert']) ? $_SESSION[$cCode]['revert'] : array(),
                "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($_SESSION[$cCode]['jurnalItems']) ? $_SESSION[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($_SESSION[$cCode]['componentsBuilder']) ? $_SESSION[$cCode]['componentsBuilder'] : array(),
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            $mongRegID = $doWriteReg;
            //            cekHitam($this->db->last_query());

            //========extended steps (if any)
            //region extended steps
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $iKey => $iVal) {
                    if ($iVal > 0) {

                        cekbiru("evaluating $iKey ($iVal) for paymentSrc..");
                        $stepCode = $this->jenisTr . "_";
                        $paymentSources = $this->config->item("payment_source");


                        if (array_key_exists($stepCode, $paymentSources)) {
                            $payConfigs = $paymentSources[$stepCode];
                            cekbiru("$stepCode registered");


                            //===kalau melibatkan payment-source
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    if ($paymentSrcConfig['valueSrc'] == $iKey) {
                                        cekhijau($paymentSrcConfig['valueSrc'] . "/$iKey akan dieksekusi");
                                        $valueSrc = $paymentSrcConfig['valueSrc'];
                                        $externSrc = $paymentSrcConfig['externSrc'];
                                        if ($tr->paymentSrcExistsInMaster($insertID, $stepCode, $paymentSrcConfig['label'])) {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID sudah ada, tidak perlu ditulis");
                                        }
                                        else {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID BELUM ada, ditulis sekarang");
                                            $tr->writePaymentSrc($insertID, array(
                                                "_key" => $iKey,
                                                "jenis" => $stepCode,
                                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                                "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                                "label" => $paymentSrcConfig['label'],
                                                "tagihan" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "terbayar" => 0,
                                                "sisa" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                                "oleh_id" => $this->session->login['id'],
                                                "oleh_nama" => $this->session->login['nama'],
                                                "dtime" => date("Y-m-d H:i:s"),
                                                "fulldate" => date("Y-m-d"),
                                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                                "terbayar_valas" => 0,
                                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                            ));
                                        }
                                        //									cekMerah("paySrc: ".$this->db->last_query());

                                    }
                                    else {
                                        cekmerah($paymentSrcConfig['valueSrc'] . "/$iKey tidak untuk dieksekusi");
                                    }
                                }
                            }

                        }
                        else {
                            cekbiru("$stepCode NOT registered");
                        }


                        //==periksa apakah mainInput memerlukan auth
                        if (array_key_exists($iKey, $inputAuthConfigs)) {
                            $gID = $inputAuthConfigs[$iKey];
                            if (strlen($gID) > 0) {
                                cekhijau("input $iKey bernilai $iVal memerlukan auth dari $gID");
                                $trA = new MdlTransaksi();
                                if ($trA->extStepExistsInMaster($insertID, $iKey)) {
                                    cekhijau("extStep SUDAH terdaftar, sekarang nggak akan ditulis");
                                }
                                else {
                                    cekhijau("extStep belum terdaftar, sekarang hendak ditulis");
                                    $insertNew = $trA->writeExtStep($insertID, array(
                                        "master_id" => $insertID,
                                        "transaksi_id" => $insertID,
                                        "_key" => $iKey,
                                        "_label" => $inputLabels[$iKey],
                                        "_value" => $iVal,
                                        "group_id" => $gID,
                                        "state" => "0",
                                        "proposed_by" => $this->session->login['id'],
                                        "proposed_dtime" => date("Y-m-d H:i:s"),
                                        "done_by",
                                        "done_dtime",
                                    ));
                                    $mongoList['extras'][] = $insertNew;
                                    cekhijau($this->db->last_query());
                                }
                            }

                        }
                    }

                }
            }
            //endregion


            //==================================================================================================
            //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
            // bila step lebih dari 1
            if ($nextProp['num'] > 1) {
                $this->load->model("Mdls/MdlLockerTransaksi");
                $lt = New MdlLockerTransaksi();
                $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], NULL, $insertID);
            }

            //==========================================================================================================

            $masterID = $insertID;

            $pakai_ini = 0;
            if ($pakai_ini == 1) {

                // region auto approve
                $autoMasterApprove = (isset($this->configUiJenis['autoApprove'][1]) && ($this->configUiJenis['autoApprove'][1] == true)) ? $this->configUiJenis['autoApprove'][1] : false;
                if ($autoMasterApprove == true) {

                    $autoApprove = false;
                    //            if (isset($_SESSION[$cCode]["main"]["add_diskon"]) && ($_SESSION[$cCode]["main"]["add_diskon"] > 0)) {
                    if (($_SESSION[$cCode]["main"]["add_diskon"] > 0) || (($_SESSION[$cCode]["main"]["disc"] > 0))) {
                        // ada diskon tambahan, maka approval manual step 2
                        //                    $autoApprove = true;
                    }
                    else {
                        $autoApprove = true;
                    }
                    if ($autoApprove == true) {
                        // tidak ada diskon tambahan, maka langsung auto approval step 2
                        cekHitam(":: AUTO APPROVAL STEP 2 ::");
                        $transaksiID_reference = $no = $masterID;
                        $stepNum = 2;
                        $stepNumCurrent = 1;
                        $nextStepNum = $stepNum + 1;

                        $paramPatchers = $this->config->item('heTransaksi_paramPatchers') != null ? $this->config->item('heTransaksi_paramPatchers') : array();
                        $paramForceFillers = $this->config->item('heTransaksi_paramForceFillers') != null ? $this->config->item('heTransaksi_paramForceFillers') : array();
                        $this->load->library("FieldCalculator");
                        $cal = new FieldCalculator();
                        $stepNowParameter = array();
                        $this->load->model("MdlTransaksi");
                        $tr = new MdlTransaksi();
                        $tr->addFilter("id in (" . implode(",", explode("-", $no)) . ")");
                        $tr->addFilter("step_number='" . $stepNumCurrent . "'");
                        $tr->addFilterJoin("transaksi_data.trash='0'");
                        $tmpTr = $tr->lookupJoined();
                        if (sizeof($tmpTr) > 0) {
                            $extractedItems = array();//==untuk urusan update transaksi referer
                            $validItems = array();
                            $validItemSends = array();
                            $validItemReqCancels = array();
                            $validItemCancels = array();
                            $validItemPreCancels = array();
                            $validItemSents = array();
                            foreach ($tmpTr as $row) {
                                if ($row->valid_qty > 0) {
                                    if (!isset($validItems[$row->produk_id])) {
                                        $validItems[$row->produk_id] = 0;
                                    }
                                    if (!isset($validItemSends[$row->produk_id])) {
                                        $validItemSends[$row->produk_id] = 0;
                                    }
                                    if (!isset($validItemCancels[$row->produk_id])) {
                                        $validItemCancels[$row->produk_id] = 0;
                                    }
                                    if (!isset($validItemReqCancels[$row->produk_id])) {
                                        $validItemReqCancels[$row->produk_id] = 0;
                                    }
                                    if (!isset($validItemPackeds[$row->produk_id])) {
                                        $validItemPackeds[$row->produk_id] = 0;
                                    }
                                    if (!isset($validItemPreCancels[$row->produk_id])) {
                                        $validItemPreCancels[$row->produk_id] = 0;
                                    }

                                    $validItems[$row->produk_id] += isset($row->valid_qty) ? $row->valid_qty : 0;
                                    $validItemSends[$row->produk_id] += isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0;
                                    $validItemCancels[$row->produk_id] += isset($row->cancel_qty) ? $row->cancel_qty : 0;
                                    $validItemReqCancels[$row->produk_id] += isset($row->req_cancel_qty) ? $row->req_cancel_qty : 0;
                                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0;
                                    $validItemPackeds[$row->produk_id] += isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0;

                                    if (!isset($extractedItems[$row->produk_id])) {
                                        $extractedItems[$row->produk_id] = array();
                                    }
                                    $extractedItems[$row->produk_id][$row->id_detail] = array(
                                        "id" => $row->id_detail,
                                        "produk_id" => $row->produk_id,
                                        "qty" => $row->produk_ord_jml,
                                        "valid_qty" => $row->valid_qty,
                                        "transaksi_id" => $row->transaksi_id,
                                        "packed_qty" => isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0,
                                        "sent_qty" => isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0,
                                        "req_cancel_qty" => isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0,
                                        "cancel_qty" => $row->cancel_qty,
                                        "outstanding" => $row->produk_ord_jml - ($row->produk_ord_jml - $row->valid_qty),
                                    );
                                }
                            }
                            //                    arrPrintKuning($tmpTr);
                            //                    mati_disini(__LINE__);
                            $this->jenisTr = $tmpTr[0]->jenis_master;
                            $cCode = "_TR_" . $this->jenisTr;
                            //region session init
                            //                    if (!isset($_SESSION[$cCode])) {
                            //                        $_SESSION[$cCode] = array(
                            //                            "items" => array(),
                            //                            "main"  => array(),
                            //                        );
                            //                    }
                            //                    if (!isset($_SESSION[$cCode]['main'])) {
                            //                        $_SESSION[$cCode]['main'] = array();
                            //                    }
                            //                    if (!isset($_SESSION[$cCode]['items'])) {
                            //                        $_SESSION[$cCode]['items'] = array();
                            //                    }
                            //                    $_SESSION[$cCode]['rsltItems'] = array();
                            //                    $_SESSION[$cCode]['rsltItems2'] = array();
                            //endregion
                            $_SESSION[$cCode]['extractedItems'] = $extractedItems;

                            $jenisTrTarget = isset($this->configUiJenis["steps"][$stepNum]["target"]) ? $this->configUiJenis["steps"][$stepNum]["target"] : NULL;
                            $detailValuesConfig = isset($this->configCoreJenis['tableIn']['detailValues']) ? $this->configCoreJenis['tableIn']['detailValues'] : array();
                            $additionalData = isset($this->configUiJenis["addDetailData"][$stepNum]) ? $this->configUiJenis["addDetailData"][$stepNum] : array();

                            //                    $masterID = $_SESSION[$cCode]['main']['masterID'];
                            $topID = $tmpTr[0]->id_top;
                            $tmpNomorNota = $tmpTr[0]->nomer;
                            $origJenis = $tmpTr[0]->jenis_master;
                            $trID = $tmpTr[0]->transaksi_id;

                            $totalSteps = sizeof($this->configUiJenis['steps']);

                            //==references, previous entry
                            $prevProp = array(
                                "id" => $tmpTr[0]->transaksi_id,
                                "jenis" => $tmpTr[0]->jenis,
                                "nomer" => $tmpTr[0]->nomer,
                            );

                            //------
                            $stepNowParameter = array(
                                "next_step_code" => $tmpTr[0]->next_step_code,
                                "next_step_label" => $tmpTr[0]->next_step_label,
                                "next_group_code" => $tmpTr[0]->next_group_code,
                                "next_step_num" => $tmpTr[0]->next_step_num,
                                "step_current" => $tmpTr[0]->step_current,
                            );

                            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
                            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
                            $mainValues = array();
                            if (sizeof($tmpVal_main) > 0) {
                                foreach ($tmpVal_main as $row) {
                                    $mainValues[$row->key] = $row->value;
                                }
                            }
                            $detailValues = array();
                            if (sizeof($tmpVal_detail) > 0) {
                                foreach ($tmpVal_detail as $row) {
                                    $detailValues[$row->produk_id][$row->key] = $row->value;
                                }
                            }

                            $main = array();
                            $items = array();
                            $prevIDs = array();
                            $prevNos = array();
                            foreach ($tmpTr as $row) {
                                $items[$row->produk_id] = array(
                                    "id" => $row->produk_id,
                                    "nama" => $row->produk_nama,
                                    "jml" => $row->produk_ord_jml,
                                    "harga" => $row->produk_ord_hrg,
                                    "valid_qty" => $row->valid_qty,
                                    "transaksi_id" => $row->transaksi_id,
                                    "nomer" => $row->nomer,
                                );

                                if ($row->valid_qty > 0) {
                                    cekHitam("ok lanjut");
                                }
                                else {
                                    if (isset($_SESSION[$cCode]['items'][$row->produk_id])) {
                                        matiHere("Followed up already. Please close and refresh your browser " . $row->produk_nama . " " . $row->produk_id);//kalo session active ya harus dimatiin biar gak dobel
                                    }
                                }

                                if (!in_array($row->transaksi_id, $prevIDs)) {
                                    $prevIDs[] = $row->transaksi_id;
                                }
                                if (!in_array($row->nomer, $prevNos)) {
                                    $prevNos[] = $row->nomer;
                                }
                                if (sizeof($detailValuesConfig) > 0) {
                                    echo "detail values ada..<br>";
                                    foreach ($detailValuesConfig as $key => $src) {
                                        echo "$key akan ambil nilai dari $src<br>";
//                                        echo "<script>top.writeProgress('$key akan ambil nilai dari $src');</script>";
                                        //                            $tmp[$key]=isset($iSpec[$val])?$iSpec[$val]:0;
                                        if (isset($detailValues[$row->produk_id][$key])) {
                                            //                            $tmp[$key] = formatField($key, $detailValues[$row->produk_id][$key]);
                                            $items[$row->produk_id][$key] = $detailValues[$row->produk_id][$key];
                                        }
                                        else {
                                            if (isset($row->$key)) {
                                                //                                $tmp[$key] = formatField($key, $row->$key);
                                                $items[$row->produk_id][$key] = $row->$key;
                                            }
                                        }
                                        echo "dan sekarang nilainya: " . $items[$row->produk_id][$key] . "<br>";
//                                        echo "<script>top.writeProgress('dan sekarang nilainya: " . $items[$row->produk_id][$key] . "');</script>";
                                    }
                                }
                            }

                            //region pembulatan replacer disini
                            $injectBulat = isset($this->configCoreJenis['valuePembulatan'][$stepNum]) ? $this->configCoreJenis['valuePembulatan'][$stepNum] : array();
                            if (sizeof($injectBulat) > 0) {
//                                echo "<script>top.writeProgress('PEMBULATAN', 'HEAD');</script>";
                                //            arrPrint($injectBulat);
                                $selectedSource = $injectBulat['source'];
                                $injectSource = makeDppBulat($_SESSION[$cCode]['main'][$selectedSource]);
                                foreach ($injectBulat['replacer'] as $k => $fields) {
                                    $_SESSION[$cCode]['main'][$fields] = $injectSource[$k];
//                                    echo "<script>top.writeProgress('PEMBULATAN ($fields)');</script>";
                                }

                            }
                            //endregion

                            cekMerah(":: MEMULAI PRE-PROCC ITEMS...");
                            $ppnFactor = isset($_SESSION[$cCode]["main"]["ppnFactor"]) ? $_SESSION[$cCode]["main"]["ppnFactor"] : matiHere("gagal menghitung ppn silahkan refresh atau relogin");

                            //region pre-processors (item)
                            if (isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]['detail'])) {
                                $iterator = isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['preProcessor'][$jenisTrTarget]['detail'] : array();
                                $itemNumLabels = isset($this->configUiJenis['shoppingCartNumFields'][$stepNum]) ? $this->configUiJenis['shoppingCartNumFields'][$stepNum] : array();
                                echo "ITEM NUM LABELS";

                                if (sizeof($iterator) > 0) {
//                                    echo "<script>top.writeProgress('PERSIAPAN PRE-PROCESSOR...', 'HEAD');</script>";
                                    foreach ($iterator as $cCtr => $tComSpec) {
                                        $comName = $tComSpec['comName'];
                                        $srcGateName = $tComSpec['srcGateName'];
                                        $srcRawGateName = $tComSpec['srcRawGateName'];
                                        echo __LINE__ . " :: sub-preproc: $comName, initializing values <br>";

                                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                                            $tmpOutParams[$cCtr] = array();
                                            //                        $id = $dSpec['id'];
                                            $id = $xid;
                                            $subParams = array();

                                            if (isset($tComSpec['static'])) {
                                                foreach ($tComSpec['static'] as $key => $value) {

                                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                                    $subParams['static'][$key] = $realValue;

                                                }

                                                if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                                    foreach ($paramPatchers[$comName] as $k => $v) {
                                                        if (!isset($subParams['static'][$k])) {
                                                            $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                        }
                                                    }
                                                }
                                                if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                                    $jenis = $_SESSION[$cCode]['main']['jenis'];
                                                    foreach ($paramForceFillers[$comName] as $k => $v) {
                                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                    }
                                                }

                                                $subParams['static']["fulldate"] = date("Y-m-d");
                                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                                $subParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                                            }

                                            if (sizeof($subParams) > 0) {

                                                $tmpOutParams[$cCtr][] = $subParams;
                                            }


                                            $comName = $tComSpec['comName'];
                                            $srcGateName = $tComSpec['srcGateName'];
                                            $srcRawGateName = $tComSpec['srcRawGateName'];
                                            $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                            echo "sub preproc #$it: $comName, sending values <br>";

                                            $mdlName = "Pre" . ucfirst($comName);
                                            $this->load->model("Preprocs/" . $mdlName);
                                            $m = new $mdlName($resultParams);
                                            if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                                $tobeExecuted = true;
                                            }
                                            else {
                                                $tobeExecuted = false;
                                            }

                                            if ($tobeExecuted) {
                                                $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                                $gotParams = $m->exec();
                                                cekHitam(":: PRE-PROCC -> GOTNAME, ITERATING...");
                                                arrprint($gotParams);
                                                if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                                    foreach ($gotParams as $gateName => $paramSpec) {

                                                        if (!isset($_SESSION[$cCode][$gateName])) {
                                                            $_SESSION[$cCode][$gateName] = array();
                                                            //                                    cekhijau("building the session: $gateName");
                                                        }
                                                        else {
                                                            //                                    cekhijau("NOT building the session: $gateName");
                                                        }

                                                        foreach ($paramSpec as $id => $gSpec) {
                                                            //                                        $id = $gSpec['id'];
                                                            if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                                $_SESSION[$cCode][$gateName][$id] = array();
                                                            }

                                                            if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                                if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                                    foreach ($gSpec as $key => $val) {
                                                                        $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                                    }
                                                                }
                                                            }
                                                            //==inject gotParams to child gate
                                                            if ($gateName == $srcGateName) {
                                                                if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                                        foreach ($gSpec as $key => $val) {
                                                                            $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            //cekMerah("REBUILDING VALUES..");
                                                            if (sizeof($itemNumLabels) > 0) {
                                                                //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                                foreach ($itemNumLabels as $key => $label) {
                                                                    //cekHere("$id === $key => $label");
                                                                    $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                                    //                                        die();
                                                                }
                                                            }
                                                        }
                                                        //                                    arrPrint($_SESSION[$cCode][$gateName]);die();
                                                    }
                                                }

                                            }
                                            else {
                                                cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                            }
                                        }

                                        $this->load->helper("he_value_builder");
                                        fillValues_he_value_builder($this->jenisTr, $stepNumCurrent, $stepNum, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);
                                    }
                                }
                                else {
                                    //cekKuning("sub-preproc is not set");
                                }


                                $this->load->helper("he_value_builder");
                                fillValues_he_value_builder($this->jenisTr, $stepNumCurrent, $stepNum, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);
                            }
                            else {
                                echo("no processor defined. skipping preprocessor..<br>");
                            }

                            //endregion

                            //region pre-processors (master)
                            if (isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]['master'])) {
                                $iterator = isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]['master']) ? $this->configCoreJenis['preProcessor'][$jenisTrTarget]['master'] : array();
                                $itemNumLabels = isset($this->configUiJenis['shoppingCartNumFields']) ? $this->configUiJenis['shoppingCartNumFields'] : array();

                                echo "ITEM NUM LABELS";

                                if (sizeof($iterator) > 0) {
//                                    echo "<script>top.writeProgress('PERSIAPAN PRE-PROCESSOR...', 'HEAD');</script>";
                                    foreach ($iterator as $cCtr => $tComSpec) {
                                        $comName = $tComSpec['comName'];
                                        $srcGateName = $tComSpec['srcGateName'];
                                        $srcRawGateName = $tComSpec['srcRawGateName'];
                                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                                        $switchResultParams = isset($tComSpec['switchResultParams']) ? $tComSpec['switchResultParams'] : false;

                                        echo "master-preproc: $comName, initializing values <br>";
                                        $tmpOutParams[$cCtr] = array();


                                        $subParams = array();
                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                                $subParams['static'][$key] = $realValue;

                                            }

                                            if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                                foreach ($paramPatchers[$comName] as $k => $v) {
                                                    if (!isset($subParams['static'][$k])) {
                                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                    }
                                                }
                                            }
                                            if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                                $jenis = $_SESSION[$cCode]['main']['jenis'];
                                                foreach ($paramForceFillers[$comName] as $k => $v) {
                                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                }
                                            }

                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                                        }
                                        if (sizeof($subParams) > 0) {
                                            $tmpOutParams[$cCtr] = $subParams;
                                        }


                                        $mdlName = "Pre" . ucfirst($comName);
                                        $this->load->model("Preprocs/" . $mdlName);
                                        $m = new $mdlName($resultParams);


                                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                            $tobeExecuted = true;
                                        }
                                        else {
                                            $tobeExecuted = false;
                                        }

                                        if ($tobeExecuted) {
                                            $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                            $gotParams = $m->exec();

                                            cekbiru("gotparams dari $comName");
                                            arrprint($gotParams);

                                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                                cekhijau("ada gotparam, sekarang mau replace");
                                                foreach ($gotParams as $gateName => $gSpec) {

                                                    if ($switchResultParams == true) {
                                                        foreach ($gSpec as $id => $ggSpec) {
                                                            if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                                $_SESSION[$cCode][$gateName][$id] = array();
                                                            }
                                                            if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                                if (is_array($ggSpec) && sizeof($ggSpec) > 0) {
                                                                    foreach ($ggSpec as $key => $val) {
                                                                        $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                                    }
                                                                }
                                                            }
                                                            //cekMerah("REBUILDING VALUES..");
                                                            if (sizeof($itemNumLabels) > 0) {
                                                                //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                                foreach ($itemNumLabels as $key => $label) {
                                                                    //cekHere("$id === $key => $label");
                                                                    if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                                        $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    else {

                                                        if (isset($_SESSION[$cCode]['main'])) {
                                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                                foreach ($gSpec as $key => $val) {
                                                                    cekbiru("injecting param $key with $val");
                                                                    $_SESSION[$cCode]['main'][$key] = $val;
                                                                }
                                                            }
                                                        }
                                                        //==inject gotParams to child gate
                                                        if (isset($_SESSION[$cCode]['main'])) {
                                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                                foreach ($gSpec as $key => $val) {
                                                                    $_SESSION[$cCode]['main'][$key] = $val;
                                                                }
                                                            }
                                                        }
                                                    }

                                                }
                                            }
                                            else {
                                                cekmerah("TIDAK ada gotparam, tidak perlu replace");
                                            }

                                        }
                                        else {
                                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                        }
                                    }
                                }
                                else {
                                    //cekKuning("sub-preproc is not set");
                                }


                                $this->load->helper("he_value_builder");
                                fillValues_he_value_builder($this->jenisTr, $stepNumCurrent, $stepNum, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);


                            }
                            else {
                                echo("no processor defined. skipping preprocessor..<br>");
                            }

                            //endregion

                            //region pre-proc value injector items2 items2_sum dari gerbang main
                            $injectValues = isset($this->configCoreJenis['preInjectValue'][$stepNum]) ? $this->configCoreJenis['preInjectValue'][$stepNum] : array();
                            if (sizeof($injectValues) > 0) {
                                $iterator = isset($this->configCoreJenis['preInjectValue'][$stepNum]['master']) ? $this->configCoreJenis['preInjectValue'][$stepNum]['master'] : array();
                                $itemNumLabels = isset($this->configUiJenis['shoppingCartNumFields']) ? $this->configUiJenis['shoppingCartNumFields'] : array();
                                if (sizeof($iterator) > 0) {
                                    foreach ($iterator as $cCtr => $tComSpec) {
                                        $comName = $tComSpec['comName'];
                                        $srcGateName = $tComSpec['srcGateName'];
                                        $srcRawGateName = $tComSpec['srcRawGateName'];
                                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                                        //                    echo "master-preproc: $comName, initializing values <br>";
                                        $tmpOutParams[$cCtr] = array();


                                        $subParams = array();
                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                                $subParams['static'][$key] = $realValue;

                                            }

                                            if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                                foreach ($paramPatchers[$comName] as $k => $v) {
                                                    if (!isset($subParams['static'][$k])) {
                                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                    }
                                                }
                                            }
                                            if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                                $jenis = $_SESSION[$cCode]['main']['jenis'];
                                                foreach ($paramForceFillers[$comName] as $k => $v) {
                                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                }
                                            }

                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                                        }
                                        if (sizeof($subParams) > 0) {
                                            $tmpOutParams[$cCtr] = $subParams;
                                        }


                                        $mdlName = "Pre" . ucfirst($comName);
                                        $this->load->model("Preprocs/" . $mdlName);
                                        $m = new $mdlName($resultParams);


                                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                            $tobeExecuted = true;
                                        }
                                        else {
                                            $tobeExecuted = false;
                                        }

                                        if ($tobeExecuted) {
                                            $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                            $gotParams = $m->exec();
                                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                                //                            cekhijau("ada gotparam, sekarang mau replace");
                                                foreach ($gotParams as $gateName => $gSpec) {
                                                    if ($gateName == "main") {
                                                        foreach ($gSpec as $key => $val) {
                                                            $_SESSION[$cCode]['main'][$key] = $val;
                                                        }
                                                    }
                                                    if ($gateName == "items2") {
                                                        foreach ($_SESSION[$cCode]['items2'] as $k => $tmpSes) {
                                                            foreach ($gSpec as $key => $val) {
                                                                foreach ($tmpSes as $y => $sesData) {
                                                                    if (array_key_exists($key, $sesData)) {
                                                                        $_SESSION[$cCode]['items2'][$k][$y][$key] = $val;
                                                                    }
                                                                }
                                                            }
                                                        }

                                                    }
                                                    if ($gateName == "items2_sum") {
                                                        foreach ($_SESSION[$cCode]['items2_sum'] as $k => $tmpSes) {
                                                            foreach ($gSpec as $key => $val) {
                                                                $_SESSION[$cCode]['items2_sum'][$k][$key] = $val;
                                                            }
                                                        }

                                                    }

                                                }
                                            }
                                            else {
                                                cekmerah("TIDAK ada gotparam, tidak perlu replace");
                                            }

                                        }
                                        else {
                                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                        }

                                    }
                                }
                                else {
                                    //cekKuning("sub-preproc is not set");
                                }

                                $this->load->helper("he_value_builder");
                                fillValues_he_value_builder($this->jenisTr, $stepNumCurrent, $stepNum, $this->configCoreJenis, $this->configUiJenis, $this->configValuesJenis, $ppnFactor);

                            }
                            //endregion

                            $this->load->library("Validator");
                            $va = new Validator();
                            $va->setConfigUiJenis($this->configUiJenis);
                            $va->setCCode($this->cCode);
                            $va->midValidate($stepNum);
                            $va->unionValidate();

                            //region update step2an
                            if (isset($this->configUiJenis['steps'][$nextStepNum])) {//===masih ada langkah selanjutnya
                                echo "authorizing to next step..<br>";
                                $nextProp = array(
                                    "num" => $nextStepNum,
                                    "code" => $this->configUiJenis['steps'][$nextStepNum]['target'],
                                    "label" => $this->configUiJenis['steps'][$nextStepNum]['label'],
                                    "groupID" => $this->configUiJenis['steps'][$nextStepNum]['userGroup'],
                                );
                            }
                            else {//==ini step terakhir, tulis komponen jika ada
                                $nextProp = array(
                                    "num" => 0,
                                    "code" => "",
                                    "label" => "",
                                    "groupID" => "",
                                );
                            }
                            //endregion
                            //arrPrintHijau($nextProp);
                            //mati_disini("LINE: " . __LINE__ . " under maintenance, tunggu beberapa saat lagi yaa.., TRID: $insertID");
                            //==tulis signature
                            $dwsign = $tr->writeSignature($masterID, array(
                                "nomer" => $tmpNomorNota,
                                "step_number" => $stepNum,
                                "step_code" => $this->configUi[$origJenis]['steps'][$stepNum]['target'],
                                "step_name" => $this->configUi[$origJenis]['steps'][$stepNum]['label'],
                                "group_code" => $this->configUi[$origJenis]['steps'][$stepNum]['userGroup'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "keterangan" => $this->configUi[$origJenis]['steps'][$stepNum]['label'] . " oleh " . $this->session->login['nama'],
                                "transaksi_id" => $masterID,
                            )) or die("Failed to write signature");
                            $mongoList['sign'][] = $dwsign;
                            //cekKuning($this->db->last_query());

                            //region update step terdahulu
                            $tr = new MdlTransaksi();
                            $dupState = $tr->updateData(array("id" => $topID), array(
                                "next_step_code" => $nextProp['code'],
                                "next_step_label" => $nextProp['label'],
                                "next_group_code" => $nextProp['groupID'],
                                "next_step_num" => $nextProp['num'],
                                "step_current" => $stepNum,

                                "partial" => isset($_SESSION[$cCode]['main']['partial']) ? $_SESSION[$cCode]['main']['partial'] : 0,

                            )) or die("Failed to update tr next-state!");
                            $mongUpdateList['update']['main'][] = array(
                                "where" => array("id" => "$topID"),
                                "value" => array(
                                    "next_step_code" => $nextProp['code'],
                                    "next_step_label" => $nextProp['label'],
                                    "next_group_code" => $nextProp['groupID'],
                                    "next_step_num" => $nextProp['num'],
                                    "step_current" => $stepNum,
                                ),
                            );
                            cekHijau($this->db->last_query());

                            //-------------------------------------------------
                            $tr = new MdlTransaksi();
                            $dupState = $tr->updateData(array("id" => $trID), array(
                                "partial" => isset($_SESSION[$cCode]['main']['partial']) ? $_SESSION[$cCode]['main']['partial'] : 0,
                            )) or die("Failed to update tr next-state!");
                            $mongUpdateList['update']['main'][] = array(
                                "where" => array("id" => "$trID"),
                                "value" => array(
                                    "partial" => isset($_SESSION[$cCode]['main']['partial']) ? $_SESSION[$cCode]['main']['partial'] : 0,
                                ),
                            );


                            //mati_disini("==== ==== ====");
                            //endregion

                            $tCode = $this->configUi[$origJenis]['steps'][$stepNum]['target'];
                            $tCodeName = $this->configUi[$origJenis]['steps'][$stepNum]['label'];
                            $masterReplacers = array(
                                //            "referensi_id" => $masterID, (dimatikan)
                                //            "id_master"       => $masterID,
                                //            "id_top"          => $topID,
                                "inv" => $tmpNomorNota,
                                //            "jenis_top"           => $tCode,
                                "jenis" => $tCode,
                                "jenis_label" => $tCodeName,
                                "transaksi_jenis" => $tCode,
                                "cabang_id" => selectedTransactionSession() ? $_SESSION[$cCode]['main']['cabangID'] : $this->session->login['cabang_id'],
                                "cabang_nama" => selectedTransactionSession() ? $_SESSION[$cCode]['main']['cabangName'] : $this->session->login['cabang_nama'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "step_current" => "0",
                                "step_number" => $stepNum,
                                //            "next_step_code"      => "",
                                //            "next_step_label"     => "",
                                //            "next_group_code"     => "",
                                "next_step_code" => $nextProp['code'],
                                "next_step_label" => $nextProp['label'],
                                "next_group_code" => $nextProp['groupID'],
                                //===references
                                "id_master" => $masterID,
                                "id_top" => $topID,
                                "ids_prev" => base64_encode(serialize($prevIDs)),
                                "ids_prev_intext" => print_r($prevIDs, true),
                                "nomer_top2" => isset($_SESSION[$cCode]['main']['nomer_top2']) ? $_SESSION[$cCode]['main']['nomer_top2'] : "",
                                "nomer_top" => $_SESSION[$cCode]['tableIn_master']['nomer_top'],
                                "nomers_prev" => base64_encode(serialize($prevNos)),
                                "nomers_prev_intext" => print_r($prevNos, true),
                                //            "jenis_top"           => $this->jenisTr,
                                "jenises_prev" => base64_encode(serialize(array($prevProp['jenis']))),
                                "jenises_prev_intext" => print_r(array($prevProp['jenis']), true),
                                "tail_number" => $stepNum,
                                "tail_code" => $this->configUiJenis['steps'][$stepNum]['target'],
                            );

                            foreach ($masterReplacers as $key => $val) {
                                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                            }

                            $childTableRepaclers = array(
                                "sub_step_number" => $stepNum,
                                "sub_step_current" => $stepNum,
                                "sub_step_avail" => sizeof($this->configUiJenis['steps']),
                                "next_substep_num" => $nextProp['num'],
                                "next_substep_code" => $nextProp['code'],
                                "next_substep_label" => $nextProp['label'],
                                "next_subgroup_code" => $nextProp['groupID'],
                            );
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
                                //			$id = $dSpec['id'];
                                foreach ($childTableRepaclers as $key => $val) {
                                    $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
                                }
                            }


                            $masterReplacersO = array(

                                "jenisTr" => $tCode,
                                "jenisTrName" => $tCodeName,
                                "olehID" => $this->session->login['id'],
                                "olehName" => $this->session->login['nama'],
                                "stepNumber" => $stepNum,
                                "stepCode" => $tCode,
                            );
                            foreach ($masterReplacersO as $key => $val) {
                                $_SESSION[$cCode]['main'][$key] = $val;
                            }

                            //region menimbulkan nilai tagihan
                            $unpaidList = null != $this->config->item('tr_unpaidList') ? $this->config->item('tr_unpaidList') : array();
                            //        arrprint($_SESSION[$cCode]['tableIn_master']);
                            if (in_array($tCode, $unpaidList)) {
                                $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_tagihan"] = $_SESSION[$cCode]['tableIn_master']['transaksi_nilai'];
                                $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_terbayar"] = 0;
                                $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_sisa"] = ($_SESSION[$cCode]['tableIn_master']['transaksi_nilai_tagihan'] - $_SESSION[$cCode]['tableIn_master']['transaksi_nilai_terbayar']);
                                //cekMerah("NULIS TAGIHANN");
                            }
                            else {
                                //cekMerah("TIDAK NULIS TAGIHANN");
                            }
                            //endregion


                            //region penomoran receipt #1

                            $this->load->model("CustomCounter");
                            $cn = new CustomCounter("transaksi");
                            $cn->setType("transaksi");

                            $counterForNumber = array($this->configCore[$origJenis]['formatNota']);
                            if (!in_array($counterForNumber[0], $this->configCore[$origJenis]['counters'])) {
                                die(__LINE__ . " Used number should be registered in 'counters' config as well");
                            }

                            foreach ($counterForNumber as $i => $cRawParams) {
                                $cParams = explode("|", $cRawParams);
                                $cValues = array();
                                foreach ($cParams as $param) {
                                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                }
                                $cRawValues = implode("|", $cValues[$i]);
                                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);
                            }
                            $tmpNomorNota2_current = $tmpNomorNota2 = $paramSpec['paramString'];
                            $tmpNomorNota2Alias_current = $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);

                            //endregion

                            //region dynamic counters #1
//                            echo "<script>top.writeProgress('sedang membuat penomoran');</script>";
                            // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                            $cn = new CustomCounter("transaksi");
                            $cn->setType("transaksi");
                            $configCustomParams = $this->configCore[$origJenis]['counters'];
                            $configCustomParams[] = "stepCode";
                            if (sizeof($configCustomParams) > 0) {
                                $cContent = array();
                                foreach ($configCustomParams as $i => $cRawParams) {
                                    $cParams = explode("|", $cRawParams);
                                    $cValues = array();
                                    foreach ($cParams as $param) {
                                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                    }
                                    $cRawValues = implode("|", $cValues[$i]);
                                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                                    $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                                    switch ($paramSpec['id']) {
                                        case 0: //===counter type is new
                                            $paramKeyRaw = print_r($cParams, true);
                                            $paramValuesRaw = print_r($cValues[$i], true);
                                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                            break;
                                        default: //===counter to be updated
                                            $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                            break;
                                    }
                                    //echo "<hr>";
                                }
                            }
                            $appliedCounters2 = base64_encode(serialize($cContent));
                            $appliedCounters_inText2 = print_r($cContent, true);


                            $masterReplacers = array(
                                "nomer" => $tmpNomorNota2,
                                "nomer2" => $tmpNomorNota2Alias,
                                "counters" => $appliedCounters2,
                                "counters_intext" => $appliedCounters_inText2,
                            );
                            foreach ($masterReplacers as $key => $val) {
                                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                            }

                            $addValues = array(
                                'counters' => $appliedCounters2,
                                'counters_intext' => $appliedCounters_inText2,
                                'nomer' => $tmpNomorNota2,
                                'nomer2' => $tmpNomorNota2Alias,
                                'dtime' => date("Y-m-d H:i:s"),
                                'fulldate' => date("Y-m-d"),
                            );
                            foreach ($addValues as $key => $val) {
                                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                            }

                            // </editor-fold>
                            //endregion

                            //region numbering tambahan
                            $this->load->library("CounterNumber");
                            $ccn = new CounterNumber();
                            $ccn->setCCode($this->cCode);
                            $ccn->setJenisTr($this->jenisTr);
                            $ccn->setTransaksiGate($_SESSION[$cCode]['tableIn_master']);
                            $ccn->setMainGate($_SESSION[$cCode]['main']);
                            $ccn->setItemsGate($_SESSION[$cCode]['items']);
                            $ccn->setItems2SumGate($_SESSION[$cCode]['items2_sum']);
                            $new_counter = $ccn->getCounterNumber();
                            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

                            if (isset($new_counter['main']) && sizeof($new_counter['main']) > 0) {
                                foreach ($new_counter['main'] as $ckey => $cval) {
                                    $_SESSION[$cCode]['tableIn_master'][$ckey] = $cval;
                                    $_SESSION[$cCode]['main'][$ckey] = $cval;
                                }
                            }
                            if (isset($new_counter['items']) && sizeof($new_counter['items']) > 0) {
                                foreach ($new_counter['items'] as $ikey => $iSpec) {
                                    foreach ($iSpec as $iikey => $iival) {
                                        $_SESSION[$cCode]['items'][$ikey][$iikey] = $iival;
                                    }
                                }
                            }
                            if (isset($new_counter['items2_sum']) && sizeof($new_counter['items2_sum']) > 0) {
                                foreach ($new_counter['items2_sum'] as $ikey => $iSpec) {
                                    foreach ($iSpec as $iikey => $iival) {
                                        $_SESSION[$cCode]['items2_sum'][$ikey][$iikey] = $iival;
                                    }
                                }
                            }
                            //endregion
                            //==tulis kloningan transaksi

                            //region write entries
                            if (sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

                                // region locker transaksi---------------------------------
                                $pakai_ini = 0;
                                if ($pakai_ini == 1) {
                                    if ($this->session->login['ghost'] == 0) {
                                        //                $followUpValidator = isset($this->configUi[$origJenis]['followUpValidator'][$stepNum]) ? $this->configUi[$origJenis]['followUpValidator'][$stepNum] : false;
                                        //                if ($followUpValidator == true) {

                                        $this->load->model("Mdls/MdlLockerTransaksi");
                                        $lt = New MdlLockerTransaksi();
                                        $lt->addFilter("transaksi_id='$no'");
                                        $lt->addFilter("state='hold'");
                                        $lt->addFilter("jumlah='1'");
                                        $lt->addFilter("oleh_id=" . my_id());
                                        $ltTmp = $lt->lookupAll()->result();
                                        showLast_query("biru");
                                        if (sizeof($ltTmp) == 1) {
                                            cekHijau(":: lanjuut eksekusi transaksi ini....");
                                        }
                                        else {
                                            $msg = "Transaksi sudah dieksekusi atau ada indikasi transaksi ganda. Silahkan tutup halaman ini dan refresh ulang.";
                                            cekMerah($msg);
                                            die(lgShowAlertBiru($msg));
                                        }

                                        //                }
                                    }
                                }
                                // endregion locker transaksi---------------------------------

                                $_SESSION[$cCode]['tableIn_master']['status_4'] = 11;
                                $_SESSION[$cCode]['tableIn_master']['trash_4'] = 0;
                                $_SESSION[$cCode]['main']['status_4'] = 1;
                                $_SESSION[$cCode]['main']['trash_4'] = 0;


                                $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                                $midmaster = $insertID;
                                cekBiru("master invoice " . $insertID);
                                $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                                $mongoList['main'] = array($insertID, $epID);
                                $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                                $mNumMaster = $insertNum;
                                $mJenisMaster = $_SESSION[$cCode]['tableIn_master']['jenis'];
                                $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                                if ($insertID < 1) {
                                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                                }


                                if (isset($_SESSION[$cCode]['tableIn_master']['ids_his'])) {
                                    $idHis_decode = blobDecode($_SESSION[$cCode]['tableIn_master']['ids_his']);
                                    $idHis_decode[$stepNum] = array(
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                        "olehID" => $_SESSION[$cCode]['main']['olehID'],
                                        "olehName" => $_SESSION[$cCode]['main']['olehName'],
                                        "step" => $stepNum,
                                        "trID" => $insertID,
                                        "nomer" => $tmpNomorNota2,
                                        "nomer2" => $tmpNomorNota2Alias,
                                        "counters" => $appliedCounters2,
                                        "counters_intext" => $appliedCounters_inText2,
                                    );
                                    $idHis_blob = blobEncode($idHis_decode);
                                    $idHis_intext = print_r($idHis_decode, true);

                                    $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                                    $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;


                                    $tr = new MdlTransaksi();
                                    $dup = $tr->updateData(array("id" => $insertID), array(
                                        "ids_his" => $idHis_blob,
                                        "ids_his_intext" => $idHis_intext,

                                    )) or die("Failed to update tr next-state!");
                                    cekUngu($this->db->last_query());
                                }


                                cekUngu(":: insertID => $insertID ::");
                                if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                                    $inserMainValues = array();
                                    $mongoList['mainValues'] = array();
                                    foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                        $inserMainValues[] = $dd;
                                        $mongoList['mainValues'][] = $dd;
                                    }
                                    if (sizeof($inserMainValues) > 0) {
                                        $arrBlob = blobEncode($inserMainValues);
                                        $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                                    }
                                }
                                if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                                    foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                        $mongoList['mainValues'][] = $dd;
                                    }
                                }
                                if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                                    foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                        $mongoList['mainValues'][] = $dd;
                                    }
                                }
                                if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                                    foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                                        $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                                    }
                                }


                                if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                                    //                cekMerah("ada mainElements $cCode");
                                    //                arrprint($_SESSION[$cCode]['main_elements']);die();
                                    foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                                        $tr->writeMainElements($insertID, array(
                                            "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                            "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                            "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                            "name" => $aSpec['name'],
                                            "label" => $aSpec['label'],
                                            "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                            "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                                        ));
                                    }
                                }
                                else {
                                    //                cekMerah("TAK ada mainElements");
                                }

                                if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                                    $insertIDs = array();
                                    foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                                        if (isset($this->configCoreJenis['tableIn']['detailValues'])) {
                                            foreach ($this->configCoreJenis['tableIn']['detailValues'] as $key => $src) {
                                                $dd = $tr->writeDetailValues($insertID, array(
                                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                                    "produk_id" => $pID,
                                                    "key" => $key,
                                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                                ));
                                                $insertIDs[$pID][] = $dd;
                                                $mongoList['detailValues'][] = $dd;
                                            }

                                        }
                                    }
                                    if (sizeof($insertIDs) > 0) {
                                        $arrBlob = blobEncode($insertIDs);
                                        $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                                    }
                                }
                                if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                                    foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                                        if (isset($this->configCoreJenis['tableIn']['detailValues2_sum'])) {
                                            foreach ($this->configCoreJenis['tableIn']['detailValues2_sum'] as $key => $src) {
                                                $dd = $tr->writeDetailValues($insertID, array(
                                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                                    "produk_id" => $pID,
                                                    "key" => $key,
                                                    "value" => $dSpec[$src],
                                                ));
                                                $insertIDs[] = $dd;
                                                $mongoList['detailValues'][] = $dd;
                                            }
                                        }


                                    }
                                }
                                if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                                    foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $pID => $dSpec) {
                                        if (isset($this->configCoreJenis['tableIn']['detail_rsltItems'])) {
                                            foreach ($this->configCoreJenis['tableIn']['detail_rsltItems'] as $key => $src) {
                                                $dd = $tr->writeDetailValues($insertID, array(
                                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail_rsltItems'][$pID]['produk_jenis'],
                                                    "produk_id" => $pID,
                                                    "key" => $key,
                                                    "value" => $dSpec[$src],
                                                ));
                                                $insertIDs[$pID][] = $dd;
                                                $mongoList['detailValues'][] = $dd;
                                            }
                                        }


                                    }
                                }

                                //region update validQty pada step sebelumnya yang di-refer
//                                echo "<script>top.writeProgress('EXTRACT ITEMS...','head');</script>";
                                $seluruhnya = true;
                                $prevTrID = 0;
                                $arrvalidQtySisa = array();
                                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                                    $closedRequest = isset($this->configCore[$origJenis]['closedRequest'][$stepNum]['enabled']) ? $this->configCore[$origJenis]['closedRequest'][$stepNum]['enabled'] : false;
                                    $insertIDs = array();
                                    $insertDeIDs = array();
                                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $iID => $dSpec) {
                                        $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                                        if ($insertDetailID < 1) {
                                            die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                                        }
                                        else {
                                            $insertIDs[] = $insertDetailID;
                                            $insertDeIDs[$insertID][] = $insertDetailID;
                                            $mongoList['detail'][] = $insertDetailID;

                                        }

                                        if ($epID != 999) {
                                            $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                            if ($insertEpID < 1) {
                                                die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                                            }
                                            else {
                                                $insertIDs[] = $insertEpID;
                                                $insertDeIDs[$epID][] = $insertEpID;
                                                $mongoList['detail'][] = $insertDetailID;
                                            }
                                        }

                                        cekHitam("EXTRACTED ITEMS... [$iID]");
//                                        echo "<script>top.writeProgress('" . strtoupper($dSpec['produk_nama']) . "');</script>";


                                        if (isset($_SESSION[$cCode]['extractedItems'])) {
                                            if (array_key_exists($iID, $_SESSION[$cCode]['extractedItems'])) {
                                                $itemFulfilledJml = 0;
                                                foreach ($_SESSION[$cCode]['extractedItems'][$iID] as $triID => $triSpec) {
                                                    $prevTrID = $triSpec['transaksi_id'];
                                                    $tru = new MdlTransaksi();
                                                    $tru->setFilters(array());
                                                    $tru->setTableName($tru->getTableNames()['detail']);
                                                    //----------------------------------------------------------
                                                    if ($triSpec['valid_qty'] >= $dSpec['produk_ord_jml']) {
                                                        $newValidQty = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);
                                                        //                                    cekmerah("validQty dikurangi oleh produk_ord_jml, yaitu " . $dSpec['produk_ord_jml']);
                                                    }
                                                    else {
                                                        $newValidQty = ($triSpec['valid_qty'] - $triSpec['valid_qty']);
                                                        //                                    cekmerah("validQty dikurangi oleh triSpec,  myaitu " . $triSpec['valid_qty']);
                                                    }
                                                    //----------------------------------------------------------
                                                    $newValidQtyNotApprove = 0;
                                                    if ($closedRequest == true) {
                                                        cekPink2("closed Request enabled, request: " . $triSpec['valid_qty'] . ", approve: " . $dSpec['produk_ord_jml'] . ", newValidQty: " . $newValidQty);
                                                        if ($triSpec['valid_qty'] >= $dSpec['produk_ord_jml']) {
                                                            $newValidQty = 0;
                                                            $newValidQtyNotApprove = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);

                                                        }
                                                        //                                    else{
                                                        //                                        $newValidQty = 0;
                                                        //                                        $newValidQtyNotApprove = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);
                                                        //                                    }
                                                        cekPink2("new valid qty: $newValidQty, valid qty not approve: $newValidQtyNotApprove");
                                                    }
                                                    //----------------------------------------------------------


                                                    $itemFulfilledJml += $newValidQty;
                                                    $updateContents = array(
                                                        "valid_qty" => $newValidQty,
                                                        "valid_qty_no_approve" => $newValidQtyNotApprove,
                                                    );
                                                    if ($newValidQty < 1) {
                                                        $childPrevRepaclers = array(
                                                            "next_substep_code" => "",
                                                            "next_substep_label" => "",
                                                            "next_subgroup_code" => "",
                                                            "sub_tail_number" => $stepNum,
                                                            "sub_tail_code" => $this->configUiJenis['steps'][$stepNum]['target'],
                                                        );
                                                        foreach ($childPrevRepaclers as $key => $val) {
                                                            $updateContents[$key] = $val;
                                                        }
                                                    }
                                                    else {//==kalau ada yang tidak habis, berarti TIDAK seluruhnya yang dilanjutkan pada step berikutnya
                                                        $seluruhnya = false;
                                                        $arrvalidQtySisa[$iID] = $newValidQty;
                                                    }
                                                    $dupState = $tru->updateData(array(
                                                        "produk_id" => $iID,
                                                        "id" => $triID,
                                                        "transaksi_id" => $triSpec['transaksi_id'],
                                                    ), $updateContents) or die("Failed to update previous detail entries!");
                                                    cekHijau($this->db->last_query());

                                                    $mongUpdateList['update']['detail'][] = array(
                                                        "where" => array(
                                                            //                                        "transaksi_id" => $triSpec['transaksi_id'],
                                                            "id" => "$triID",
                                                            //                                        "produk_id" => $iID,
                                                        ),
                                                        "value" => $updateContents,
                                                    );
                                                    unset($tru);
                                                }
                                            }
                                            //                        else{
                                            //                            if($closedRequest == true){
                                            //
                                            //                            }
                                            //                        }
                                        }
                                    }

                                    if ($closedRequest == true) {
                                        if (isset($_SESSION[$cCode]['extractedItems'])) {
                                            foreach ($_SESSION[$cCode]['extractedItems'] as $iIDex => $exSpec) {
                                                if (!array_key_exists($iIDex, $_SESSION[$cCode]['tableIn_detail'])) {
                                                    foreach ($exSpec as $trDataID => $trdSpec) {
                                                        $tru = new MdlTransaksi();
                                                        $tru->setFilters(array());
                                                        $tru->setTableName($tru->getTableNames()['detail']);
                                                        $updateContents = array(
                                                            "valid_qty" => 0,
                                                            "valid_qty_no_approve" => $trdSpec['qty'],
                                                        );
                                                        $childPrevRepaclers = array(
                                                            "next_substep_code" => "",
                                                            "next_substep_label" => "",
                                                            "next_subgroup_code" => "",
                                                            "sub_tail_number" => $stepNum,
                                                            "sub_tail_code" => $this->configUiJenis['steps'][$stepNum]['target'],
                                                        );
                                                        foreach ($childPrevRepaclers as $key => $val) {
                                                            $updateContents[$key] = $val;
                                                        }
                                                        $dupState = $tru->updateData(array(
                                                            "produk_id" => $iIDex,
                                                            "id" => $trDataID,
                                                            "transaksi_id" => $trdSpec['transaksi_id'],
                                                        ), $updateContents) or die("Failed to update previous detail entries!");
                                                        //                                    cekHijau($this->db->last_query());
                                                        $mongUpdateList['update']['detail'][] = array(
                                                            "where" => array(
                                                                //                                            "transaksi_id" => $trdSpec['transaksi_id'],
                                                                "id" => "$trDataID",
                                                                //                                            "produk_id" => $iIDex,
                                                            ),
                                                            "value" => $updateContents,
                                                        );
                                                        unset($tru);
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    if (sizeof($insertIDs) == 0) {
                                        die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                                    }
                                    else {
                                        $indexing_details = array();
                                        foreach ($insertDeIDs as $key => $numb) {
                                            $indexing_details[$key] = $numb;
                                        }
                                        foreach ($indexing_details as $k => $arrID) {
                                            arrPrint($arrID);
                                            $arrBlob = blobEncode($arrID);
                                            $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                                            cekOrange($this->db->last_query());
                                        }
                                    }

                                    //-------------
                                    $lastStepPartialApprove = isset($this->configUiJenis['lastStepPartialApprove']) ? $this->configUiJenis['lastStepPartialApprove'] : false;
                                    if ($lastStepPartialApprove == true) {
                                        cekKuning(__LINE__ . " $lastStepPartialApprove :: $totalSteps");
                                        if ($totalSteps == 2) {
                                            if (sizeof($arrvalidQtySisa) > 0) {
                                                cekPink("ada valid qty yang tersisa");
                                                $tr = new MdlTransaksi();
                                                $dupState = $tr->updateData(array("id" => $topID), $stepNowParameter) or die("Failed to update tr next-state!");
                                                cekHitam(__LINE__ . " ## 2 step, dan step akhir partial, YESS...");
                                                showLast_query("orange");
                                            }
                                        }
                                    }
                                }
                                else {
                                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                                }

                                if ($seluruhnya) {
                                    $tr = new MdlTransaksi();
                                    $dupState = $tr->updateData(array("id" => $prevTrID), array(
                                        "tail_number" => $stepNum,
                                        "tail_code" => $this->configUiJenis['steps'][$stepNum]['target'],
                                        "status_4" => $_SESSION[$cCode]['main']['status_4'],
                                        "trash_4" => $_SESSION[$cCode]['main']['trash_4'],
                                    )) or die("Failed to update tr next-state!");
                                    cekHijau(":: UOPDATE transaksi dengan trID -> $prevTrID");
                                    $mongUpdateList['update']['main'][] = array(
                                        "where" => array(
                                            "id" => "$prevTrID",
                                        ),
                                        "value" => array(
                                            "tail_number" => $stepNum,
                                            "tail_code" => $this->configUiJenis['steps'][$stepNum]['target'],
                                            "status_4" => $_SESSION[$cCode]['main']['status_4'],
                                            "trash_4" => $_SESSION[$cCode]['main']['trash_4'],
                                        ),
                                    );
                                    cekHijau($this->db->last_query());
                                }
                                //endregion

                                //region cloner items to item_child
                                if (sizeof($additionalData) > 0) {
//                                    echo "<script>top.writeProgress('CLONING ITEMS TO ITEM CHILD...','head');</script>";
                                    cekHitam("ini data");
                                    $dataMdl = $additionalData["mdlName"];
                                    $this->load->model("Mdls/" . $dataMdl);
                                    $da = new $dataMdl();
                                    $arrColl = $da->getFields();
                                    $selectedCol = array();
                                    foreach ($arrColl as $colSpec) {
                                        $selectedCol[] = $colSpec['kolom'];
                                    }

                                    if (isset($_SESSION[$cCode]['items_child']) && sizeof($_SESSION[$cCode]['items_child'])) {
                                        $gateData = isset($this->configUiJenis['shopingCartDetailFields'][$stepNum]['gate']) ? $this->configUiJenis['shopingCartDetailFields'][$stepNum]['gate'] : "detail";

                                        $arrBlacklist = array(
                                            "jml", "max_jml", "qty",
                                        );
                                        if (isset($_SESSION[$cCode]["items2_sum"])) {
                                            unset($_SESSION[$cCode]["items2_sum"]);
                                            unset($_SESSION[$cCode]["items2"]);
                                            unset($_SESSION[$cCode]["tableIn_detail_values2_sum"]);
                                        }
                                        foreach ($_SESSION[$cCode]['items_child'] as $mainProdsID => $defData) {
                                            if ($gateData == "detail") {
                                                $itemsMain = isset($_SESSION[$cCode]['items'][$mainProdsID]) ? $_SESSION[$cCode]['items'][$mainProdsID] : array();
                                            }
                                            else {
                                                $forceMainToItems = isset($this->configUiJenis['shopingCartDetailFields'][$stepNum]['changeToItems'][$gateData]) ? $this->configUiJenis['shopingCartDetailFields'][$stepNum]['changeToItems'][$gateData] : array();
                                                if (sizeof($forceMainToItems) > 0) {
                                                    foreach ($forceMainToItems as $key1 => $key2) {
                                                        $keyForce = strlen($key2) > 2 ? $key2 : $key1;
                                                        $itemsMain[$key1] = isset($_SESSION[$cCode]['main'][$keyForce]) ? $_SESSION[$cCode]['main'][$keyForce] : "";
                                                    }
                                                    $itemsMain["jml"] = "1";
                                                    $itemsMain["qty"] = "1";
                                                    $itemsMain["max_jml"] = "1";

                                                }
                                                else {
                                                    matiHEre("detil aset gagal di tulis!");
                                                }
                                                //                            arrPrint($forceMainToItems);
                                            }

                                            $arrChilds = array_diff_key($itemsMain, array_flip($arrBlacklist));
                                            //                        arrPrint($itemsMain);
                                            //                        matiHEre();
                                            //
                                            //arrPrint($arrChilds);
                                            cekLime("ini brooo " . $gateData);

                                            $arrNew = array();
                                            if (sizeof($itemsMain) > 0) {
                                                foreach ($defData as $inID => $detil_child) {
                                                    //                        $arrNewChild = array_diff($itemsMain,$detil_child);

                                                    $paramDetil = array_replace($arrChilds, $detil_child);
                                                    if (array_key_exists("id", $paramDetil)) {

                                                        $paramDetil["parent_id"] = $paramDetil["id"];
                                                        if (!isset($paramDetil["folders"]) || $paramDetil["folders"] == 0) {
                                                            $paramDetil["folders"] = $paramDetil["pihakMainId"];
                                                            $paramDetil["keterangan"] = $paramDetil["pihakMainName"];
                                                        }
                                                        unset($paramDetil["id"]);
                                                    }
                                                    $tmpData = array();
                                                    foreach ($selectedCol as $i => $coloum) {
                                                        if (isset($paramDetil[$coloum])) {
                                                            $tmpData[$coloum] = $paramDetil[$coloum];
                                                        }
                                                    }
                                                    //                                arrPrint($paramDetil);
                                                    if (isset($paramDetil["subtotal"])) {
                                                        $paramDetil["subtotal"] = $paramDetil["jml"] * $paramDetil["harga"];
                                                    }

                                                    $insertDataID = $da->addData($tmpData, $da->getTableName()) or die(lgShowError("Gagal menulis pengajuan data", __FILE__));
                                                    cekHere($this->db->last_query());
                                                    $paramDetil["id"] = $insertDataID;
//                                                    echo "<script>top.writeProgress('PENGAJUAN DATA (TRID:$insertDataID)');</script>";
                                                    $_SESSION[$cCode]["items2_sum"][$insertDataID] = $paramDetil;
                                                    $_SESSION[$cCode]["items2"][$mainProdsID][$insertDataID] = $paramDetil;
                                                    //                            $arrNew

                                                }
                                            }


                                            //                        arrPrint($arrNew);
                                            //


                                            //                  arrPrint($itemsMain);
                                        }

                                    }
                                }

                                //endregion

                                if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                                    $insertIDs = array();
                                    foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $iID => $dSpec) {
                                        $dd = $tr->writeDetailEntries($insertID, $dSpec);
                                        $insertIDs[] = $dd;
                                        $mongoList['detail'][] = $dd;
                                        if ($epID != 999) {
                                            $dd = $tr->writeDetailEntries($epID, $dSpec);
                                            $insertIDs[] = $dd;
                                            $mongoList['detail'][] = $dd;
                                        }
                                    }
                                }
                                if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                                    $insertIDs = array();
                                    foreach ($_SESSION[$cCode]['tableIn_detail2'] as $iID => $dSpec) {
                                        $dd = $tr->writeDetailEntries($insertID, $dSpec);
                                        $insertIDs[] = $dd;
                                        $mongoList['detail'][] = $dd;
                                        if ($epID != 999) {
                                            $dd = $tr->writeDetailEntries($epID, $dSpec);
                                            $insertIDs[] = $dd;
                                            $mongoList['detail'][] = $dd;
                                        }
                                        cekUngu($this->db->last_query());
                                    }
                                }


                                if (isset($this->configUiJenis['updateDueDate'][$stepNum])) {
                                    $dueDateConf = $this->configUiJenis['updateDueDate'][$stepNum];
                                    $sourceDue = $dueDateConf['source'];
                                    $targetDue = $dueDateConf['target'];
                                    $datenow = date("Y-m-d");
                                    foreach ($sourceDue as $key => $val) {
                                        $indexVal = isset($_SESSION[$cCode]['main_elements'][$key][$val]) ? $_SESSION[$cCode]['main_elements'][$key][$val] : 14;
                                        $dueDate = dueDate($datenow, $indexVal);
                                    }
                                    $fieldDue = $tr->getFields()["dueDate"];
                                    $dataDue = array();
                                    foreach ($fieldDue as $kol) {
                                        if (isset($_SESSION[$cCode]['tableIn_master'][$kol])) {
                                            $dataDue[$kol] = $_SESSION[$cCode]['tableIn_master'][$kol];
                                        }
                                    }
                                    $dataDue['due_date'] = $dueDate;
                                    $validateDue = validateDueDate($_SESSION[$cCode]['main']['customerID'], $_SESSION[$cCode]['main']['dtime']);

                                    arrPrint($validateDue);
                                    if ($validateDue['allow_create'] == "true") {
                                        if (isset($_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen']) && $_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen'] > 0) {
                                            cekBiru($_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen']);

                                            $tr->writeDueDate($insertID, $dataDue);
                                        }
                                    }
                                    else {
                                        $allowedOver = validateOverDue($_SESSION[$cCode]['main']['customerID']);
                                        if ($allowedOver['status'] == "allowed") {

                                        }
                                        else {
                                            //                        matiHere($validateDue['error']);//matiin transaksi sudah over due
                                        }
                                        //                    arrPrint()
                                        //                    matiHere($validateDue['error']);//matiin transaksi sudah over due
                                    }
                                    //                matiHere();
                                    //update main elementnya
                                    foreach ($targetDue as $keyTarget => $valTarget) {
                                        $_SESSION[$cCode]['main_elements'][$keyTarget][$valTarget] = $dueDate;
                                        $_SESSION[$cCode]['main']['dueDate'] = $dueDate;
                                    }
                                }
                                arrPrintPink($_SESSION[$cCode]['tableIn_master']);

                                $baseRegistries = array(
                                    'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                                    'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                                    'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                                    'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                                    'itemSrc' => isset($_SESSION[$cCode]['itemSrc']) ? $_SESSION[$cCode]['itemSrc'] : array(),
                                    'itemSrc_sum' => isset($_SESSION[$cCode]['itemSrc_sum']) ? $_SESSION[$cCode]['itemSrc_sum'] : array(),
                                    'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                                    'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                                    'items4' => isset($_SESSION[$cCode]['items4']) ? $_SESSION[$cCode]['items4'] : array(),
                                    'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                                    'items5_sum' => isset($_SESSION[$cCode]['items5_sum']) ? $_SESSION[$cCode]['items5_sum'] : array(),
                                    'items6_sum' => isset($_SESSION[$cCode]['items6_sum']) ? $_SESSION[$cCode]['items6_sum'] : array(),
                                    'items7_sum' => isset($_SESSION[$cCode]['items7_sum']) ? $_SESSION[$cCode]['items7_sum'] : array(),
                                    'items8_sum' => isset($_SESSION[$cCode]['items8_sum']) ? $_SESSION[$cCode]['items8_sum'] : array(),
                                    'items9_sum' => isset($_SESSION[$cCode]['items9_sum']) ? $_SESSION[$cCode]['items9_sum'] : array(),
                                    'items10_sum' => isset($_SESSION[$cCode]['items10_sum']) ? $_SESSION[$cCode]['items10_sum'] : array(),
                                    'items_noapprove' => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),

                                    'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                                    'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                                    'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                                    'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                                    'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                                    'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                                    'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                                    'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                                    'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                                    'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                                    'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                                    'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                                    'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                                    'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                                    'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                                    'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                                    'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                                    'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                                    "receiptDetailFields" => isset($this->configLayoutJenis['receiptDetailFields'][$stepNum]) ? $this->configLayoutJenis['receiptDetailFields'][$stepNum] : array(),
                                    "receiptSumFields" => isset($this->configLayoutJenis['receiptSumFields'][$stepNum]) ? $this->configLayoutJenis['receiptSumFields'][$stepNum] : array(),
                                    "receiptDetailFields2" => isset($this->configLayoutJenis['receiptDetailFields2'][$stepNum]) ? $this->configLayoutJenis['receiptDetailFields2'][$stepNum] : array(),
                                    "receiptSumFields2" => isset($this->configLayoutJenis['receiptSumFields2'][$stepNum]) ? $this->configLayoutJenis['receiptSumFields2'][$stepNum] : array(),
                                    "receiptDetailSrcFields" => isset($this->configLayoutJenis['receiptDetailSrcFields'][$stepNum]) ? $this->configLayoutJenis['receiptDetailSrcFields'][$stepNum] : array(),
                                    "jurnal_index" => isset($this->configCoreJenis['components'][$jenisTrTarget]) ? $this->configCoreJenis['components'][$jenisTrTarget] : array(),
                                    "preProcessor" => isset($this->configCoreJenis['preProcessor'][$jenisTrTarget]) ? $this->configCoreJenis['preProcessor'][$jenisTrTarget] : array(),
                                    "postProcessor" => isset($this->configCoreJenis['postProcessor'][$jenisTrTarget]) ? $this->configCoreJenis['postProcessor'][$jenisTrTarget] : array(),
                                    "revert" => isset($_SESSION[$cCode]['revert']) ? $_SESSION[$cCode]['revert'] : array(),
                                    "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                                    "componentsBuilder" => isset($_SESSION[$cCode]['componentsBuilder']) ? $_SESSION[$cCode]['componentsBuilder'] : array(),
                                    "jurnalItems" => isset($_SESSION[$cCode]['jurnalItems']) ? $_SESSION[$cCode]['jurnalItems'] : array(),

                                );
                                $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                                $mongRegID = $doWriteReg;
//                                echo "<script>top.writeProgress('MENULIS KE-REGISTRY....');</script>";
                            }
                            else {
                                die(lgShowAlert("Transaksi gagal disimpan, silahkan cek kembali transaksi ini."));
                            }
                            //endregion
                            //mati_disini("LINE: " . __LINE__ . " under maintenance, tunggu beberapa saat lagi yaa.., TRID: $insertID");
                            //region processing sub-post-processors, always
                            //<editor-fold desc="----------sub postProc">
                            // matiHEre();
                            $iterator = isset($this->configCoreJenis['postProcessor'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['postProcessor'][$jenisTrTarget]['detail'] : array();
                            if (sizeof($iterator) > 0) {
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "sub-postProcessor: $comName, initializing values <br>";
//                                    echo "<script>top.writeProgress('MENYIAPKAN DATA SUB-PROCESSORS UNTUK DIKIRIM...', 'head');</script>";

                                    $tmpOutParams[$cCtr] = array();
                                    foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                                        $subParams = array();
                                        if (isset($tComSpec['loop'])) {
                                            foreach ($tComSpec['loop'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                                $subParams['loop'][$key] = $realValue;

                                            }
                                        }
                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                                $subParams['static'][$key] = $realValue;
                                                cekBiru("$key diisi dengan $realValue");

                                            }

                                            if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                                foreach ($paramPatchers[$comName] as $k => $v) {
                                                    if (!isset($subParams['static'][$k])) {
                                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                    }
                                                }
                                            }
                                            if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                                $jenis = $_SESSION[$cCode]['main']['jenis'];
                                                foreach ($paramForceFillers[$comName] as $k => $v) {
                                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                    cekorange(":: $k diisikan dengan " . $subParams['static'][$k]);
                                                }
                                            }

                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                                        }

                                        if (sizeof($subParams) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
//                                        echo "<script>top.writeProgress('" . isset($subParams['static']['name']) ? $subParams['static']['name'] : "" . " " . isset($subParams['static']['extern_nama']) ? $subParams['static']['extern_nama'] : "" . " " . isset($subParams['static']['nama']) ? $subParams['static']['nama'] : "" . "');</script>";
                                    }
                                }

                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "sub-postProcessor: $comName, sending values <br>";
//                                    echo "<script>top.writeProgress('SENDING SUB-PROCESSORS ($comName)...', 'head');</script>";
                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();

                                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    cekBiru($this->db->last_query());
                                }
                            }

                            //endregion
                            //
                            //region processing main-post-processors, always
                            //<editor-fold desc="----------postProc">

                            $iterator = isset($this->configCoreJenis['postProcessor'][$jenisTrTarget]['master']) ? $this->configCoreJenis['postProcessor'][$jenisTrTarget]['master'] : array();
                            if (sizeof($iterator) > 0) {
//                                echo "<script>top.writeProgress('MEMPROSES MAIN-PROCESSORS...', 'head');</script>";
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "post-processor: $comName<br>";

                                    $dSpec = $_SESSION[$cCode][$srcGateName];
                                    $tmpOutParams = array();
                                    if (isset($tComSpec['loop'])) {
                                        foreach ($tComSpec['loop'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $tmpOutParams['loop'][$key] = $realValue;

                                        }
                                    }
                                    if (isset($tComSpec['static'])) {
                                        //cekHere("DISINI OIII");
                                        foreach ($tComSpec['static'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $tmpOutParams['static'][$key] = $realValue;

                                        }
                                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                            foreach ($paramPatchers[$comName] as $k => $v) {
                                                if (!isset($tmpOutParams['static'][$k])) {
                                                    $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
//                                                    echo "<script>top.writeProgress(':: $key diisikan dengan " . $tmpOutParams['static'][$k] . ");</script>";
                                                }
                                            }
                                        }
                                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                                $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
//                                                echo "<script>top.writeProgress(':: $key diisikan dengan " . $tmpOutParams['static'][$k] . ");</script>";
                                            }
                                        }
                                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                                    }
                                    if (isset($tComSpec['static2'])) {
                                        //cekHere("DISINI OIII");
                                        foreach ($tComSpec['static2'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                                            $tmpOutParams['static2'][$key] = $realValue;

                                        }
                                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                            foreach ($paramPatchers[$comName] as $k => $v) {
                                                if (!isset($subParams['static'][$k])) {
                                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                }
                                            }
                                        }
                                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                            }
                                        }
                                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static2']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                                    }

                                    //lgShowError("Ada kesalahan",);
                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();

                                    //                cekBiru("kiriman komponem $comName");
                                    //                                    arrPrint($tmpOutParams);
                                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                                }
                            }


                            //</editor-fold>
                            //endregion
                            //
                            //region ----------subcomponents GESER KE CLI

                            //        $componentGate['detail'] = array();
                            //        //arrPrint($paramForceFillers);
                            $iterator = isset($this->configCoreJenis['components'][$jenisTrTarget]['detail']) ? $this->configCoreJenis['components'][$jenisTrTarget]['detail'] : array();
                            $componentConfig['detail'] = $iterator;
                            //        if (sizeof($iterator) > 0) {
                            //            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
                            //            $filterNeeded = false;
                            //            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                            //                $filterNeeded = true;
                            //            }
                            //            foreach ($iterator as $cCtr => $tComSpec) {
                            ////                $comName = $tComSpec['comName'];
                            //                $srcGateName = $tComSpec['srcGateName'];
                            //                $srcRawGateName = $tComSpec['srcRawGateName'];
                            //
                            //                echo "sub-component: $comName, $srcGateName, initializing values <br>";
                            //                $tmpOutParams[$cCtr] = array();
                            //                foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
                            //                    cekmerah("mengevaluasi $srcGateName..");
                            //                    $comName = $tComSpec['comName'];
                            //                    if (substr($comName, 0, 1) == "{") {
                            //                        $comName = trim($comName, "{");
                            //                        $comName = trim($comName, "}");
                            //                        $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
                            //                        $tComSpec['comName'] = $comName;
                            //                        $iterator[$cCtr]['comName'] = $comName;
                            //                    }
                            //
                            //                    $filterNeeded = false;
                            //                    $mdlName = "Com" . ucfirst($comName);
                            //                    if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                            //                        $filterNeeded = true;
                            //                    }
                            //
                            //
                            //                    $subParams = array();
                            //                    if (isset($tComSpec['loop'])) {
                            //                        foreach ($tComSpec['loop'] as $key => $value) {
                            //                            if (substr($key, 0, 1) == "{") {
                            //                                $key = trim($key, "{");
                            //                                $key = trim($key, "}");
                            //                                $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$id][$key], $key);
                            //                            }
                            //                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                            //                            $subParams['loop'][$key] = $realValue;
                            //                            cekKuning("LOOP: $key diisi dengan $realValue");
                            //
                            //                            if ($filterNeeded) {
                            //                                if ($subParams['loop'][$key] == 0) {
                            //                                    unset($subParams['loop'][$key]);
                            //                                }
                            //                            }
                            //                        }
                            //                    }
                            //                    if (isset($tComSpec['static'])) {
                            //                        foreach ($tComSpec['static'] as $key => $value) {
                            //
                            //                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                            //                            $subParams['static'][$key] = $realValue;
                            //                            cekKuning("STATIC: $key diisi dengan $realValue");
                            //
                            //                        }
                            //                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            //                            foreach ($paramPatchers[$comName] as $k => $v) {
                            //                                if (!isset($subParams['static'][$k])) {
                            //                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            //                                    cekOrange("fill :: $comName :: $k => " . $subParams['static'][$k]);
                            //                                }
                            //                            }
                            //                        }
                            //                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            //                            //                            cekOrange("comName:: $comName");
                            //                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            //                            foreach ($paramForceFillers[$comName] as $k => $v) {
                            //                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            //                                cekOrange("fillforce :: $comName :: $k => " . $subParams['static'][$k]);
                            //                            }
                            //                        }
                            //                        $subParams['static']["fulldate"] = date("Y-m-d");
                            //                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            //                        $subParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                            //                    }
                            //                    cekHitam("cetak subParams");
                            //                    arrPrint($subParams);
                            //                    if (sizeof($subParams) > 0) {
                            //                        if ($filterNeeded) {
                            //                            if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                            //                                $tmpOutParams[$cCtr][] = $subParams;
                            //                            }
                            //                        }
                            //                        else {
                            //
                            //                            $tmpOutParams[$cCtr][] = $subParams;
                            //                        }
                            //                    }
                            //                }
                            //
                            //                $componentGate['detail'][$cCtr] = $subParams;
                            //            }
                            //
                            //
                            //            $it = 0;
                            //            foreach ($iterator as $cCtr => $tComSpec) {
                            //                $it++;
                            //
                            //
                            //                $comName = $tComSpec['comName'];
                            //                $srcGateName = $tComSpec['srcGateName'];
                            //                $srcRawGateName = $tComSpec['srcRawGateName'];
                            //
                            //                echo "sub component #$it: $comName, sending values <br>";
                            //
                            //                $mdlName = "Com" . ucfirst($comName);
                            //                $this->load->model("Coms/" . $mdlName);
                            //                $m = new $mdlName();
                            //
                            //
                            //                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            //                    $tobeExecuted = true;
                            //                }
                            //                else {
                            //                    $tobeExecuted = false;
                            //                }
                            //
                            //
                            //                if ($tobeExecuted) {
                            //                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            //                    $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            //                }
                            //                else {
                            //                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                            //                }
                            //            }
                            //        }
                            //        else {
                            //            //cekKuning("subcomponents is not set");
                            //        }

                            //endregion

                            //region ----------components
                            //<editor-fold desc="----------components">
                            $componentJurnal = array();
                            $componentGate['master'] = array();
                            $componentConfig['master'] = array();
                            if (isset($this->configCoreJenis['relativeComponets']) && $this->configCoreJenis['relativeComponets'] == true) {
                                $iterator = isset($_SESSION[$cCode]['revert']['jurnal'][$stepNum]['master']) ? $_SESSION[$cCode]['revert']['jurnal'][$stepNum]['master'] : array();
                            }
                            else {
                                if (isset($_SESSION[$cCode]['componentsBuilder'][$stepNum]['master'])) {
                                    $iterator = $_SESSION[$cCode]['componentsBuilder'][$stepNum]['master'];
                                }
                                elseif (isset($this->configCoreJenis['components'][$jenisTrTarget]['master'])) {
                                    $iterator = $this->configCoreJenis['components'][$jenisTrTarget]['master'];
                                }
                                else {
                                    $iterator = array();
                                }
                            }


                            if (sizeof($iterator) > 0) {
//                                echo "<script>top.writeProgress('KOMPONEN...', 'head');</script>";
                                $componentConfig['master'] = $iterator;

                                $it = 0;
                                //==filter nilai, jika NOL tidak dikirim, sesuai config==
                                $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    //                cekPink($tComSpec);
                                    //                mati_disini();
                                    $it++;
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "component #$it: $comName :: $srcGateName <br>";

                                    $dSpec = $_SESSION[$cCode][$srcGateName];
                                    $tmpOutParams = array();
                                    if (isset($tComSpec['loop'])) {
                                        foreach ($tComSpec['loop'] as $key => $value) {
                                            if (substr($key, 0, 1) == "{") {
                                                $key = trim($key, "{");
                                                $key = trim($key, "}");
                                                //                            $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                                $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$key], $key);
                                            }
                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            if ($key != null) {
                                                $tmpOutParams['loop'][$key] = $realValue;
                                            }

                                        }
                                    }
                                    //                cekBiru($tmpOutParams);
                                    //                mati_disini(__LINE__);
                                    if (isset($tComSpec['static'])) {
                                        foreach ($tComSpec['static'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $tmpOutParams['static'][$key] = $realValue;
                                            cekHijau(":: NORMAL :: $key => $realValue ::");
                                        }
                                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                            cekHijau(":: masuk ke PATCHER ::");
                                            foreach ($paramPatchers[$comName] as $k => $v) {
                                                cekHijau(":: ada yang mau di-PATCHER ::");
                                                arrPrint($tmpOutParams['static']);
                                                if (!isset($tmpOutParams['static'][$k])) {
                                                    $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                    cekHijau(":: PATCHER :: $key => $realValue ::");
                                                }

                                            }
                                        }
                                        else {
                                            cekMerah(":: TIDAK TERMASUK PATCHER ::");
                                        }
                                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                                $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                cekHijau(":: FORCEFILL :: $key => $realValue ::");
                                            }
                                        }
                                        $tmpOutParams['static']["urut"] = $cCtr;
                                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                                    }
                                    if (isset($tComSpec['static2'])) {
                                        foreach ($tComSpec['static2'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $tmpOutParams['static2'][$key] = $realValue;

                                        }
                                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                            foreach ($paramPatchers[$comName] as $k => $v) {
                                                if (!isset($subParams['static'][$k])) {
                                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                                }
                                            }
                                        }
                                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                            }
                                        }
                                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static2']["keterangan"] = $this->configUiJenis['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                                    }

                                    //lgShowError("Ada kesalahan",);
                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();

                                    //===filter value nol, jika harus difilter
                                    $tobeExecuted = true;

                                    if (in_array($mdlName, $compValidators)) {

                                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                                        if (sizeof($loopParams) > 0) {
                                            foreach ($loopParams as $key => $val) {
                                                cekmerah("$comName : $key = $val ");
                                                if ($val == 0) {
                                                    unset($tmpOutParams['loop'][$key]);
                                                }
                                            }
                                        }
                                        if (sizeof($tmpOutParams['loop']) < 1) {
                                            $tobeExecuted = false;
                                        }

                                    }


                                    if ($tobeExecuted) {
                                        cekBiru("kiriman komponen $comName");
                                        arrPrint($tmpOutParams);
                                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    }
                                    else {
                                        cekBiru("komponem $comName tidak memenuhi syarat untuk ditulis");
                                    }

                                    $componentGate['master'][$cCtr] = $tmpOutParams;
                                    if ($comName == "Jurnal") {
                                        $componentJurnal[] = $tmpOutParams;
                                    }
                                }
                            }
                            else {
                                //cekKuning("components is not set");
                            }


                            //endregion

                            //region nulis paymentSource
                            $stepCode = $this->configUiJenis['steps'][$stepNum]['target'];
                            $paymentSources = $this->config->item("payment_source");
                            if (array_key_exists($stepCode, $paymentSources)) {
                                $payConfigs = isset($paymentSources[$stepCode][$stepNum]) ? $paymentSources[$stepCode][$stepNum] : array();
                                if (sizeof($payConfigs) > 0) {
                                    foreach ($payConfigs as $paymentSrcConfig) {
                                        $valueLabel = isset($paymentSrcConfig['label_key']) ? $paymentSrcConfig['label_key'] : $paymentSrcConfig['label'];
                                        $valueSrc = $paymentSrcConfig['valueSrc'];
                                        $externSrc = $paymentSrcConfig['externSrc'];
                                        $valueAdd = isset($_SESSION[$cCode]['main'][$paymentSrcConfig['addValueValidator']]) ? $_SESSION[$cCode]['main'][$paymentSrcConfig['addValueValidator']] : 0;
                                        if (isset($paymentSrcConfig['model'])) {
                                            $mdlName = $paymentSrcConfig['model'];
                                            $this->load->model("Mdls/$mdlName");
                                            $pMdl = New $mdlName();
                                            $pTmpMdl = $pMdl->lookupAll()->result();
                                            $pTmpMdlResult = array();
                                            if (sizeof($pTmpMdl) > 0) {
                                                foreach ($pTmpMdl as $pTmpMdlSpec) {
                                                    $pTmpMdlResult[$pTmpMdlSpec->id] = $pTmpMdlSpec;
                                                }
                                            }
                                        }
                                        else {
                                            $pTmpMdlResult = array();
                                        }

                                        if (isset($_SESSION[$cCode]['main'][$valueSrc]) && $_SESSION[$cCode]['main'][$valueSrc] > 0) {
                                            if (isset($externSrc['extern_label2'])) {
                                                //cek ada isinya atau kosong
                                                $cek = strlen($_SESSION[$cCode]['main'][$externSrc['extern_label2']]) > 4 ? "" : matiHere("jenis biaya tidak dikenali " . __LINE__);//
                                            }
                                            //region cek duplikasi paymentsource
                                            $tr->setFilters(array());
                                            $tr->addFilter("transaksi_id='$insertID'");
                                            $tr->addFilter("target_jenis='" . $paymentSrcConfig['jenisTarget'] . "'");
                                            // $tr->addFilter("target_jenis='759'");
                                            $validateIsInserted = $tr->lookUpAllPaymentSrc()->result();
                                            if (sizeof($validateIsInserted) > 0) {
                                                matiHEre("Gagal menulis transaksi. Silahkan relogin untuk membersihkan sesi demi menghindari duplikasi data, dan coba kembali transaksi yang gagal");
                                            }
                                            //endregion

                                            //-----------------------
                                            cekHitam("valuelabel: $valueLabel, valueSrc: $valueSrc");
                                            $this->load->helper("he_payment_source");
                                            //                        paymentSource($this->jenisTr, $componentJurnal, $_SESSION[$cCode]['main'], $valueLabel, $valueSrc, $valueAdd);
                                            //-----------------------

                                            $arrPymSrc = array(
                                                "jenis" => $stepCode,
                                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                                "extern_id" => isset($_SESSION[$cCode]['main'][$externSrc['id']]) ? $_SESSION[$cCode]['main'][$externSrc['id']] : "",
                                                "extern_nama" => isset($_SESSION[$cCode]['main'][$externSrc['nama']]) ? $_SESSION[$cCode]['main'][$externSrc['nama']] : "",
                                                "nomer" => $tmpNomorNota2,
                                                "label" => $paymentSrcConfig['label'],

                                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                                "terbayar" => 0,
                                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],

                                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                                "oleh_id" => $this->session->login['id'],
                                                "oleh_nama" => $this->session->login['nama'],
                                                "dtime" => date("Y-m-d H:i:s"),
                                                "fulldate" => date("Y-m-d"),
                                                "valas_id" => isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                                "valas_nama" => isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                                "valas_nilai" => isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',

                                                "tagihan_valas" => isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                                "terbayar_valas" => 0,
                                                "sisa_valas" => isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',

                                                //                            "extern_label2" => isset($_SESSION[$cCode]['main']['pihakMainName']) ? $_SESSION[$cCode]['main']['pihakMainName'] : "",
                                                "extern_label2" => (isset($externSrc['extern_label2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_label2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_label2']] : "",

                                                "dpp_ppn" => (isset($externSrc['dpp_ppn']) && ($_SESSION[$cCode]['main'][$externSrc['dpp_ppn']])) ? $_SESSION[$cCode]['main'][$externSrc['dpp_ppn']] : 0,
                                                "ppn" => (isset($externSrc['ppn']) && ($_SESSION[$cCode]['main'][$externSrc['ppn']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn']] : 0,
                                                "ppn_approved" => (isset($externSrc['ppn_approved']) && ($_SESSION[$cCode]['main'][$externSrc['ppn_approved']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn_approved']] : 0,
                                                "ppn_sisa" => (isset($externSrc['ppn']) && ($_SESSION[$cCode]['main'][$externSrc['ppn']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn']] : "",
                                                "ppn_status" => (isset($externSrc['ppn_status'])) ? $externSrc['ppn_status'] : 0,
                                                "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : 0,
                                                "extern_date2" => (isset($externSrc['extern_date2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_date2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_date2']] : "",
                                                "pph_23" => (isset($externSrc['pph_23']) && ($_SESSION[$cCode]['main'][$externSrc['pph_23']])) ? $_SESSION[$cCode]['main'][$externSrc['pph_23']] : "",

                                                "npwp" => (isset($externSrc['npwp']) && ($_SESSION[$cCode]['main'][$externSrc['npwp']])) ? $_SESSION[$cCode]['main'][$externSrc['npwp']] : "",
                                                "extern2_id" => (isset($externSrc['extern2_id']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_id']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_id']] : "",
                                                "extern2_nama" => (isset($externSrc['extern2_nama']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_nama']] : "",
                                                "ppn_pph_faktor" => (isset($externSrc['ppn_pph_faktor']) && ($_SESSION[$cCode]['main'][$externSrc['ppn_pph_faktor']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn_pph_faktor']] : "",
                                                "extern_jenis" => (isset($externSrc['extern_jenis']) && ($_SESSION[$cCode]['main'][$externSrc['extern_jenis']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_jenis']] : "",
                                                "extern_nilai3" => (isset($externSrc['extern_nilai3']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai3']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai3']] : "",
                                                "extern_nilai4" => (isset($externSrc['extern_nilai4']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai4']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai4']] : "",
                                                "npwp" => (isset($externSrc['npwp']) && ($_SESSION[$cCode]['main'][$externSrc['npwp']])) ? $_SESSION[$cCode]['main'][$externSrc['npwp']] : "",
                                                //                            "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : "",
                                                "payment_locked" => (isset($externSrc['payment_locked']) && ($_SESSION[$cCode]['main'][$externSrc['payment_locked']])) ? $_SESSION[$cCode]['main'][$externSrc['payment_locked']] : 0,
                                                "cash_account" => (isset($externSrc['cash_account']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account']] : 0,
                                                "cash_account_nama" => (isset($externSrc['cash_account_nama']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account_nama']] : 0,
                                            );
                                            $tr->writePaymentSrc($insertID, $arrPymSrc);

                                        }


                                        cekMerah($this->db->last_query());
                                    }
                                }

                            }
                            else {
                                cekMerah("TIDAK nulis paymentSrc");
                            }

                            $addPaymentSource = isset($this->configUiJenis['steps'][$stepNum]['additionalStep']['shippingService']) ? $this->configUiJenis['steps'][$stepNum]['additionalStep']['shippingService'] : array();

                            //endregion

                            //region nulis paymentAntiSource
                            $stepCode = $this->configUiJenis['steps'][$stepNum]['target'];
                            $paymentSources = $this->config->item("payment_antiSource");
                            if (array_key_exists($stepCode, $paymentSources)) {
                                cekMerah(":: starting PAYMENT ANTI SOURCE");
                                $payConfigs = $paymentSources[$stepCode];
                                if (sizeof($payConfigs) > 0) {
                                    foreach ($payConfigs as $paymentSrcConfig) {
                                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                                        $valueSrc = $paymentSrcConfig['valueSrc'];
                                        $externSrc = $paymentSrcConfig['externSrc'];
                                        $tr->writePaymentAntiSrc($insertID, array(
                                            "jenis" => $stepCode,
                                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                            "nomer" => $tmpNomorNota2,
                                            "label" => $paymentSrcConfig['label'],
                                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                            "terbayar" => 0,
                                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                            "oleh_id" => $this->session->login['id'],
                                            "oleh_nama" => $this->session->login['nama'],
                                            "dtime" => date("Y-m-d H:i:s"),
                                            "fulldate" => date("Y-m-d"),
                                        ));
                                        //cekMerah($this->db->last_query());
                                    }
                                }

                            }
                            else {
                                //cekMerah("TIDAK nulis paymentSrc");
                            }
                            //endregion

                            //region nulis uangMukaSource
                            /*dimatiin geser ke ComUangmukaSourceDetail karena ada di items.
                        /*revisi tanggal 27 mei 2020 subject digeser ke vendor dari jenis transaksi misal uangmuka asuransi,uang muka pembelian ->uang muka.
                         *
                         */
                            $stepCode = $this->configUiJenis['steps'][$stepNum]['target'];
                            $uangMukaSources = $this->config->item("uang_muka");

                            if (array_key_exists($stepCode, $uangMukaSources)) {
                                cekMerah(":: starting UANG MUKA  SOURCE");
                                //            matiHere();
                                $uangMukaConfigs = isset($uangMukaSources[$stepCode][$stepNum]) ? $uangMukaSources[$stepCode][$stepNum] : array();
                                if (sizeof($uangMukaConfigs) > 0) {
                                    $cekPreValue = "";
                                    $this->load->model("Mdls/MdlPaymentUangMuka");
                                    $l = new MdlPaymentUangMuka();
                                    foreach ($uangMukaConfigs as $uangMukaSrcConfig) {
                                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                                        //                    arrPrint($uangMukaSrcConfig);
                                        $valueSrc = $uangMukaSrcConfig['valueSrc'];
                                        $externSrc = $uangMukaSrcConfig['externSrc'];
                                        $l->addFilter("extern_id='" . $_SESSION[$cCode]['main'][$externSrc['id']] . "'");
                                        $l->addFilter("extern_label2='" . $externSrc['extLabel'] . "'");
                                        $tmpUm = $l->lookupAll()->result();
                                        //                    arrPrint($tmpUm);
                                        if (sizeof($tmpUm) > 0) {
                                            //update here broo
                                            $preTagihan = $tmpUm[0]->tagihan;
                                            $preSisa = $tmpUm[0]->sisa;

                                            $newTahigan = $preTagihan + $_SESSION[$cCode]['main'][$valueSrc];
                                            $newsisa = $preSisa + $_SESSION[$cCode]['main'][$valueSrc];
                                            $update = array(
                                                "tagihan" => $newTahigan,
                                                "sisa" => $newsisa,
                                            );
                                            $where = array(
                                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                            );
                                            $tr->updateUangMukaSrc($where, $update);
                                            cekHitam($this->db->last_query());
                                        }
                                        else {
                                            //insertbaru brooo
                                            $tr->writeUangMukaSrc($insertID, array(
                                                "jenis" => $stepCode,
                                                "target_jenis" => $uangMukaSrcConfig['jenisTarget'],
                                                "reference_jenis" => $uangMukaSrcConfig['jenisSrc'],
                                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                                "nomer" => "",
                                                "note" => "",
                                                "label" => $uangMukaSrcConfig['label'],
                                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                                "terbayar" => 0,
                                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                                "oleh_id" => $this->session->login['id'],
                                                "oleh_nama" => $this->session->login['nama'],
                                                "dtime" => date("Y-m-d H:i:s"),
                                                "fulldate" => date("Y-m-d"),
                                                "extern_label2" => $externSrc['extLabel'],
                                            ));
                                        }
                                        cekMerah($this->db->last_query());
                                    }
                                }
                                else {
                                    cekLime("not write uang muka");
                                }

                            }
                            else {
                                cekMerah("not write uang muka");
                            }
                            //endregion


                        }
                        else {
                            $masterID = 0;
                            $tmpNomorNota = "XXXX";
                            $origJenis = 0;
                            $topID = 0;
                            die(lgShowAlert("No such receipt ID: $no!"));
                        }


                    }

                }
                // endregion auto approve

                //region connecting antar cabang
                $mongoListConnect = array();
                $mongRegIDConnect = array();
                $connector = isset($this->configUiJenis['connectTo']) ? $this->configUiJenis['connectTo'] : "";
                $preReplacer = isset($this->configUiJenis['replacerConnectTo']) ? $this->configUiJenis['replacerConnectTo'] : array();
                if (strlen($connector) > 0) {
                    cekMerah(":: CONNECTING BEGIN...");
                    //cekMerah("to be connected to $connector");
                    if (sizeof($steps) == 1) {
                        //cekMerah("now connecting to $connector");
                        if (!array_key_exists($connector, $this->configUi)) {
                            die("kode connector tidak dikenali!");
                        }
                        if (sizeof($this->configUi[$connector]['steps']) < 2) {
                            die("konfigurasi connector harus memiliki step lebih dari satu!");
                        }


                        $oldCode = $cCode;
                        $cCode = "_TR_" . $connector;

                        if (isset($_SESSION[$cCode])) {
                            $_SESSION[$cCode] = null;
                            unset($_SESSION[$cCode]);
                            $_SESSION[$cCode] = array();
                        }

                        //region detector cloner dalam satu cabang
                        $oldStep = $_SESSION[$oldCode]['main']["step_number"];
                        $clonerTransaction = isset($this->configUiJenis['clonerTransaction'][$oldStep]) ? $this->configUiJenis['clonerTransaction'][$oldStep] : array();


                        //endregion
                        if (sizeof($clonerTransaction) && isset($clonerTransaction['main']['cloner'])) {
                            cekHere("i am here");
                            $replacerTableinDetail = array(
                                "dtime" => "dtime",
                                "produk_id" => "id",
                                "produk_kode" => "kode",
                                "produk_label" => "label",
                                "produk_nama" => "nama",
                                "produk_ord_jml" => "produk_ord_jml",
                                "produk_ord_hrg" => "harga1",
                                "satuan" => "satuan",
                                "produk_jenis" => "produk_jenis",
                                "harga" => "harga1",
                                "valid_qty" => "produk_ord_jml",
                            );
                            $replacerStepItems2 = array(
                                "sub_tail_number" => "",
                                "sub_tail_code" => "",
                                "sub_step_avail" => "",
                                "sub_step_current" => "",
                                "sub_step_number" => "",
                                "next_substep_num" => "",
                                "next_substep_code" => "",
                                "next_substep_label" => "",
                                "next_subgroup_code" => "",
                            );

                            $itesmNewTmp = array();
                            foreach ($_SESSION[$oldCode]['items2'] as $indexItems2) {
                                foreach ($indexItems2 as $itemsDetail) {

                                    $itesmNewTmp[$itemsDetail['id']] = array_merge($itemsDetail, $replacerStepItems2);
                                    foreach ($replacerTableinDetail as $selCol => $xAlias) {
                                        $_SESSION[$oldCode]['tableIn_detail2'][$itemsDetail['id']][$selCol] = $itemsDetail[$selCol];
                                    }
                                    foreach ($replacerStepItems2 as $stepItems2 => $tempItems2Val) {
                                        $_SESSION[$oldCode]['tableIn_detail2'][$itemsDetail['id']][$stepItems2] = $tempItems2Val;
                                    }

                                }

                                //                            arrPrint($itesmNew);
                            }
                            $itesmNew = array();
                            foreach ($itesmNewTmp as $itemsID => $itemData) {
                                if (isset($itemData['harga'])) {
                                    $itemData['harga'] = $itemData['produk_ord_hrg'];
                                }
                                if (!isset($itemData['pihakName'])) {
                                    $itemData['pihakName'] = $_SESSION[$oldCode]['main']['pihakName'];
                                }

                                $itesmNew[$itemsID] = $itemData;
                            }

                            //region itemsToMaster
                            $itemTomasterStatic = isset($clonerTransaction['staticItemToMaster']) ? $clonerTransaction['staticItemToMaster'] : array();
                            $itemToMaster = isset($clonerTransaction['itemToMaster']) ? $clonerTransaction['itemToMaster'] : array();
                            //                        arrPrint($itemToMaster);
                            if (sizeof($itemToMaster) > 0) {
                                foreach ($_SESSION[$oldCode]['items'] as $itemsTemp) {
                                    foreach ($itemToMaster as $colItems => $aliasMaster) {
                                        if (isset($itemsTemp[$colItems])) {
                                            $_SESSION[$oldCode]['main'][$aliasMaster] = $itemsTemp[$colItems];
                                            $_SESSION[$oldCode]['tableIn_master'][$aliasMaster] = $itemsTemp[$colItems];
                                        }
                                    }
                                }
                                if (sizeof($itemTomasterStatic) > 0) {
                                    foreach ($itemTomasterStatic as $kolStatic => $valStatic) {
                                        $_SESSION[$oldCode]['main'][$kolStatic] = $valStatic;
                                        $_SESSION[$oldCode]['tableIn_master'][$kolStatic] = $valStatic;
                                    }
                                }

                            }


                            //endregion

                            $_SESSION[$cCode] = array(
                                "main" => $_SESSION[$oldCode]['main'],
                                "items" => $itesmNew,
                                'items2' => isset($_SESSION[$oldCode]['items2']) ? $_SESSION[$oldCode]['items2'] : array(),
                                'items2_sum' => isset($_SESSION[$oldCode]['items2_sum']) ? $_SESSION[$oldCode]['items2_sum'] : array(),
                                'items3' => isset($_SESSION[$oldCode]['items3']) ? $_SESSION[$oldCode]['items3'] : array(),
                                'items3_sum' => isset($_SESSION[$oldCode]['items3_sum']) ? $_SESSION[$oldCode]['items3_sum'] : array(),
                                'items4_sum' => isset($_SESSION[$oldCode]['items4_sum']) ? $_SESSION[$oldCode]['items4_sum'] : array(),
                                "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                                "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail2'],
                                'tableIn_detail2_sum' => isset($_SESSION[$oldCode]['tableIn_detail2_sum']) ? $_SESSION[$oldCode]['tableIn_detail2_sum'] : array(),
                                "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                                'rsltItems2' => isset($_SESSION[$oldCode]['rsltItems2']) ? $_SESSION[$oldCode]['rsltItems2'] : array(),
                                "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                                'tableIn_detail_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_rsltItems2'] : array(),
                                "main_add_values" => $_SESSION[$oldCode]['main_add_values'],
                                "main_add_fields" => $_SESSION[$oldCode]['main_add_fields'],
                                "main_elements" => $_SESSION[$oldCode]['main_elements'],
                                //
                                "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                                "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values2_sum'],
                                "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems2'] : array(),
                                'tableIn_detail_values2_sum' => isset($_SESSION[$oldCode]['tableIn_detail_values2_sum']) ? $_SESSION[$oldCode]['tableIn_detail_values2_sum'] : array(),
                            );

                            //region unset sessio details2
                            //                        unset($_SESSION[$cCode]['tableIn_detail_values2_sum']);
                            if (isset($clonerTransaction['resetGate']) && (sizeof($clonerTransaction['resetGate']) > 0)) {
                                foreach ($clonerTransaction['resetGate'] as $gate) {
                                    unset($_SESSION[$cCode][$gate]);
                                }
                            }
                            //endregion

                            $masterReplacers = array(
                                //                        "referensi_id" => $masterID, (dimatikan)
                                "inv" => $tmpNomorNota,
                                //                        "jenis_master"    => $connector,

                                "jenis_master" => $connector,
                                "jenis_top" => $this->configUi[$connector]['steps'][1]['target'],
                                //                        "jenis_top" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis_label" => $this->configUi[$connector]['steps'][1]['label'],
                                "transaksi_jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "div_id" => "18",
                                "div_nama" => "default",
                                //                            "cabang_id"       => $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                                //                            "cabang_nama"     => $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                                //                            "cabang2_id"      => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                                //                            "cabang2_nama"    => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                                //                            "gudang_id"       => $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                                //                            "gudang_nama"     => $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                                //                            "gudang2_id"      => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                                //                            "gudang2_nama"    => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                                "step_avail" => sizeof($this->configUi[$connector]['steps']),
                                "step_current" => 1,
                                "step_number" => 1,
                                "next_step_code" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['target'] : "",
                                "next_step_label" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['label'] : "",
                                "next_group_code" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['userGroup'] : "",
                                "next_step_num" => isset($this->configUi[$connector]['steps'][2]) ? 2 : "0",


                            );

                            //                        arrPrint( $_SESSION[$cCode]);
                            $masterReplacersO = array(
                                "jenisTr" => $connector,
                                "div_id" => "18",
                                "jenisTrMaster" => $connector,
                                "jenisTrTop" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis_label" => $this->configUi[$connector]['steps'][1]['label'],
                                "transaksi_jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "stepCode" => $this->configUi[$connector]['steps'][1]['target'],
                                //                            "placeID"         => $_SESSION[$oldCode]['main']['place2ID'],


                                //                            "placeName"       => $_SESSION[$oldCode]['main']['place2Name'],
                                //                            "place2ID"        => $_SESSION[$oldCode]['main']['placeID'],
                                //                            "place2Name"      => $_SESSION[$oldCode]['main']['placeName'],
                                //                            "cabangID"        => $_SESSION[$oldCode]['main']['place2ID'],
                                //                            "cabangName"      => $_SESSION[$oldCode]['main']['place2Name'],
                                //                            "cabang2ID"       => $_SESSION[$oldCode]['main']['placeID'],
                                //                            "cabang2Name"     => $_SESSION[$oldCode]['main']['placeName'],
                                //                            //
                                //                            "gudang2ID"       => $_SESSION[$cCode]['main']['gudangID'],
                                //                            "gudang2Name"     => $_SESSION[$cCode]['main']['gudangName'],
                                //                            "gudangID"        => $_SESSION[$cCode]['main']['gudang2ID'],
                                //                            "gudangName"      => $_SESSION[$cCode]['main']['gudang2Name'],
                            );
                        }
                        else {
                            $_SESSION[$cCode] = array(
                                "main" => $_SESSION[$oldCode]['main'],
                                "items" => $_SESSION[$oldCode]['items'],
                                'items2' => isset($_SESSION[$oldCode]['items2']) ? $_SESSION[$oldCode]['items2'] : array(),
                                'items2_sum' => isset($_SESSION[$oldCode]['items2_sum']) ? $_SESSION[$oldCode]['items2_sum'] : array(),
                                'items3' => isset($_SESSION[$oldCode]['items3']) ? $_SESSION[$oldCode]['items3'] : array(),
                                'items3_sum' => isset($_SESSION[$oldCode]['items3_sum']) ? $_SESSION[$oldCode]['items3_sum'] : array(),
                                'items4_sum' => isset($_SESSION[$oldCode]['items4_sum']) ? $_SESSION[$oldCode]['items4_sum'] : array(),

                                "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                                "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                                'tableIn_detail2_sum' => isset($_SESSION[$oldCode]['tableIn_detail2_sum']) ? $_SESSION[$oldCode]['tableIn_detail2_sum'] : array(),
                                "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                                'rsltItems2' => isset($_SESSION[$oldCode]['rsltItems2']) ? $_SESSION[$oldCode]['rsltItems2'] : array(),

                                "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                                'tableIn_detail_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_rsltItems2'] : array(),
                                "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                                "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                                "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems2'] : array(),
                                'tableIn_detail_values2_sum' => isset($_SESSION[$oldCode]['tableIn_detail_values2_sum']) ? $_SESSION[$oldCode]['tableIn_detail_values2_sum'] : array(),
                            );
                            $masterReplacers = array(
                                //                        "referensi_id" => $masterID, (dimatikan)
                                "inv" => $tmpNomorNota,
                                //                        "jenis_master"    => $connector,

                                "jenis_master" => $connector,
                                "jenis_top" => $this->configUi[$connector]['steps'][1]['target'],
                                //                        "jenis_top" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis_label" => $this->configUi[$connector]['steps'][1]['label'],
                                "transaksi_jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "cabang_id" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                                "cabang_nama" => isset($preReplacer['cabang2Name']) ? $preReplacer['cabang2Name'] : $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                                "cabang2_id" => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                                "cabang2_nama" => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                                "gudang_id" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                                "gudang_nama" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                                "gudang2_id" => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                                "gudang2_nama" => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                                "step_avail" => sizeof($this->configUi[$connector]['steps']),
                                "step_current" => 1,
                                "step_number" => 1,
                                "next_step_code" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['target'] : "",
                                "next_step_label" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['label'] : "",
                                "next_group_code" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['userGroup'] : "",
                                "next_step_num" => isset($this->configUi[$connector]['steps'][2]) ? 2 : "0",
                            );
                            $masterReplacersO = array(
                                "jenisTr" => $connector,
                                "jenisTrMaster" => $connector,
                                "jenisTrTop" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "jenis_label" => $this->configUi[$connector]['steps'][1]['label'],
                                "transaksi_jenis" => $this->configUi[$connector]['steps'][1]['target'],
                                "stepCode" => $this->configUi[$connector]['steps'][1]['target'],
                                "placeID" => isset($preReplacer['place2ID']) ? $preReplacer['place2ID'] : $_SESSION[$oldCode]['main']['place2ID'],
                                "placeName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$oldCode]['main']['place2Name'],
                                "place2ID" => $_SESSION[$oldCode]['main']['placeID'],
                                "place2Name" => $_SESSION[$oldCode]['main']['placeName'],
                                "cabangID" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$oldCode]['main']['place2ID'],
                                "cabangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$oldCode]['main']['place2Name'],
                                "cabang2ID" => $_SESSION[$oldCode]['main']['placeID'],
                                "cabang2Name" => $_SESSION[$oldCode]['main']['placeName'],
                                //
                                "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                                "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                                "gudangID" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['main']['gudang2ID'],
                                "gudangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['main']['gudang2Name'],
                                "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",
                            );
                        }

                        //==replace pertama
                        foreach ($masterReplacersO as $key => $val) {
                            $_SESSION[$cCode]['main'][$key] = $val;
                        }
                        foreach ($masterReplacers as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }


                        //region penomoran receipt #2
                        //<editor-fold desc="==========penomoran">
                        $this->load->model("CustomCounter");
                        $cn = new CustomCounter("transaksi");
                        $cn->setType("transaksi");

                        $counterForNumber = array($this->configCore[$connector]['formatNota']);
                        if (!in_array($counterForNumber[0], $this->configCore[$connector]['counters'])) {
                            die(__LINE__ . " Used number should be registered in 'counters' config as well");
                        }

                        foreach ($counterForNumber as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                        }

                        $tmpNomorNota2 = $paramSpec['paramString'];
                        $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);


                        //</editor-fold>
                        //endregion

                        //region dynamic counters #2
                        // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                        $cn = new CustomCounter("transaksi");
                        $cn->setType("transaksi");
                        $configCustomParams = $this->configCore[$connector]['counters'];
                        $configCustomParams[] = "stepCode";
                        if (sizeof($configCustomParams) > 0) {
                            $cContent = array();
                            foreach ($configCustomParams as $i => $cRawParams) {
                                $cParams = explode("|", $cRawParams);
                                $cValues = array();
                                foreach ($cParams as $param) {
                                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                }
                                $cRawValues = implode("|", $cValues[$i]);
                                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                                $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                                switch ($paramSpec['id']) {
                                    case 0: //===counter type is new
                                        $paramKeyRaw = print_r($cParams, true);
                                        $paramValuesRaw = print_r($cValues[$i], true);
                                        $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                        break;
                                    default: //===counter to be updated
                                        $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                        break;
                                }
                                //echo "<hr>";
                            }
                        }
                        $appliedCounters2 = base64_encode(serialize($cContent));
                        $appliedCounters_inText2 = print_r($cContent, true);
                        // </editor-fold>
                        //endregion

                        //region numbering tambahan
                        $this->load->library("CounterNumber");
                        $ccn = new CounterNumber();
                        $ccn->setCCode($cCode);
                        $ccn->setJenisTr($connector);
                        $ccn->setTransaksiGate($_SESSION[$cCode]['tableIn_master']);
                        $ccn->setMainGate($_SESSION[$cCode]['main']);
                        $ccn->setItemsGate($_SESSION[$cCode]['items']);
                        $ccn->setItems2SumGate($_SESSION[$cCode]['items2_sum']);
                        $new_counter = $ccn->getCounterNumber();
                        cekHitam("jenistr yang disett dari create " . $this->jenisTr);

                        if (isset($new_counter['main']) && sizeof($new_counter['main']) > 0) {
                            foreach ($new_counter['main'] as $ckey => $cval) {
                                $_SESSION[$cCode]['tableIn_master'][$ckey] = $cval;
                                $_SESSION[$cCode]['main'][$ckey] = $cval;
                            }
                        }
                        if (isset($new_counter['items']) && sizeof($new_counter['items']) > 0) {
                            foreach ($new_counter['items'] as $ikey => $iSpec) {
                                foreach ($iSpec as $iikey => $iival) {
                                    $_SESSION[$cCode]['items'][$ikey][$iikey] = $iival;
                                }
                            }
                        }
                        if (isset($new_counter['items2_sum']) && sizeof($new_counter['items2_sum']) > 0) {
                            foreach ($new_counter['items2_sum'] as $ikey => $iSpec) {
                                foreach ($iSpec as $iikey => $iival) {
                                    $_SESSION[$cCode]['items2_sum'][$ikey][$iikey] = $iival;
                                }
                            }
                        }
                        //endregion
                        $addValues = array(
                            'counters' => $appliedCounters,
                            'counters_intext' => $appliedCounters_inText,
                            'nomer' => $tmpNomorNota2,
                            'nomer2' => $tmpNomorNota2Alias,
                            'dtime' => date("Y-m-d H:i:s"),
                            'fulldate' => date("Y-m-d"),
                        );
                        foreach ($addValues as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }

                        //===cloning nota cab1 ke cab2
                        //===daftar perbedaan
                        //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,


                        //==replace kedua

                        $masterReplacers = array(
                            "nomer" => $tmpNomorNota2,
                            "nomer2" => $tmpNomorNota2Alias,
                            "counters" => $appliedCounters2,
                            "counters_intext" => $appliedCounters_inText2,
                        );
                        foreach ($masterReplacers as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }

                        //===cloning detail/items cabang1 ke cabang2
                        //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                        $detailReplacers = array(
                            "sub_step_avail" => sizeof($this->configUi[$connector]['steps']),
                            "sub_step_current" => 1,
                            "sub_step_number" => 1,
                            "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                            "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                            "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                            "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                            //                    "next_substep_code" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['target'] : "",
                            //                    "next_substep_label" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['label'] : "",
                            //                    "next_subgroup_code" => isset($this->configUi[$connector]['steps'][2]) ? $this->configUi[$connector]['steps'][2]['userGroup'] : "",
                        );
                        if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                                foreach ($dSpec as $key => $val) {
                                    $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                                }
                            }
                        }

                        //region ----------write transaksi & transaksi_data #2
                        if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                            $tr = new MdlTransaksi();
                            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                            $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                            cekHitam($this->db->last_query());
                            $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                            $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                            $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                            if ($insertID < 1) {
                                die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                            }
                            $mongoListConnect['main'] = array($insertID, $epID);
                        }
                        $inserMainValues = array();
                        if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                                $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                $inserMainValues[] = $dd;
                                $mongoListConnect['mainValues'][] = $dd;
                            }
                        }

                        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                            foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                                $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                $inserMainValues[] = $dd;
                                $mongoListConnect['mainValues'][] = $dd;
                            }
                        }

                        if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                            cekkuning("main_inputs detected");
                            $inserMainValues = array();
                            foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                                $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                $inserMainValues[] = $dd;
                                $mongoListConnect['mainValues'][] = $dd;
                                //                            cekkuning("making a clone for input key $key / $val");
                                //                            $subInputInsertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                            }
                        }

                        if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                            foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                                $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                            }
                        }


                        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                            foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                                $tr->writeMainElements($insertID, array(
                                    "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                    "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                    "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                    "name" => $aSpec['name'],
                                    "label" => $aSpec['label'],
                                    "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                    "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                                ));
                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                            $insertIDs = array();
                            $insertDeIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                                $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                                if ($insertDetailID < 1) {
                                    die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                                }
                                else {
                                    $insertIDs[] = $insertDetailID;
                                    $insertDeIDs[$insertID][] = $insertDetailID;
                                    $mongoListConnect['detail'][] = $insertDetailID;
                                }
                                if ($epID != 999) {
                                    $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                    if ($insertEpID < 1) {
                                        die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                                    }
                                    else {
                                        $insertIDs[] = $insertEpID;
                                        $insertDeIDs[$epID][] = $insertEpID;
                                        $mongoListConnect['detail'][] = $insertEpID;
                                    }
                                }
                            }
                            if (sizeof($insertIDs) == 0) {
                                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                            }
                            else {
                                $indexing_details = array();
                                foreach ($insertDeIDs as $key => $numb) {
                                    $indexing_details[$key] = $numb;
                                }

                                foreach ($indexing_details as $k => $arrID) {
                                    $arrBlob = blobEncode($arrID);
                                    $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                                    cekOrange($this->db->last_query());
                                }
                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                            $insertIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                                $insertIDDetail = $tr->writeDetailEntries($insertID, $dSpec);
                                $insertIDs[] = $insertIDDetail;
                                $mongoListConnect['detail'][] = $insertIDDetail;
                                if ($epID != 999) {
                                    $insertIDDetail = $tr->writeDetailEntries($epID, $dSpec);
                                    $insertIDs[] = $insertIDDetail;
                                    $mongoListConnect['detail'][] = $insertIDDetail;
                                }
                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                            $insertIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                                if (isset($this->configCoreJenis['tableIn']['detailValues'])) {
                                    foreach ($this->configCoreJenis['tableIn']['detailValues'] as $key => $src) {
                                        if (isset($_SESSION[$cCode]['tableIn_detail'][$pID])) {
                                            $dd = $tr->writeDetailValues($insertID, array(
                                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                                "produk_id" => $pID,
                                                "key" => $key,
                                                "value" => $dSpec[$src],
                                            ));
                                            $insertIDs[$pID][] = $dd;
                                            $mongoListConnect['detailValues'][] = $dd;
                                        }
                                    }
                                }
                            }
                            if (sizeof($insertIDs) > 0) {
                                $arrBlob = blobEncode($insertIDs);
                                $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                                if (isset($this->configCoreJenis['tableIn']['detailValues2_sum'])) {
                                    foreach ($this->configCoreJenis['tableIn']['detailValues2_sum'] as $key => $src) {
                                        $dd = $tr->writeDetailValues($insertID, array(
                                            "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                            "produk_id" => $pID,
                                            "key" => $key,
                                            "value" => $dSpec[$src],
                                        ));
                                        $insertIDs[] = $dd;
                                        $mongoListConnect['detailValues'][] = $dd;
                                    }
                                }


                            }
                        }


                        $idHis = array(
                            $stepNumber => array(
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                                "olehID" => $_SESSION[$cCode]['main']['olehID'],
                                "olehName" => $_SESSION[$cCode]['main']['olehName'],
                                "step" => $stepNumber,
                                "trID" => $insertID,
                                "nomer" => $tmpNomorNota2,
                                "nomer2" => $tmpNomorNota2Alias,
                                "counters" => $appliedCounters2,
                                "counters_intext" => $appliedCounters_inText2,
                            ),
                        );
                        $idHis_blob = blobEncode($idHis);
                        $idHis_intext = print_r($idHis, true);

                        $tr = new MdlTransaksi();
                        $dupState = $tr->updateData(array("id" => $insertID), array(
                            "id_master" => $masterID,
                            "id_top" => $insertID,

                            "ids_his" => $idHis_blob,
                            "ids_his_intext" => $idHis_intext,

                        )) or die("Failed to update tr next-state!");

                        $baseRegistries = array(
                            'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                            'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                            'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                            'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                            'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                            'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                            'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),

                            'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                            'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                            'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                            'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                            'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                            'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                            'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                            'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                            'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                            'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                            'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                            'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                            'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                            'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                            'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                            'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                            'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                            'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                            "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                            "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                            "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                            "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                            "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                        );
                        //                    arrPrint($baseRegistries);

                        $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                        $mongRegIDConnect = $doWriteReg;
                        cekBiru($this->db->last_query());
                        //endregion

                        //
                        //region nulis paymentSource
                        //                    $stepCode = $connector;
                        $stepCode = $this->configUi[$connector]['steps'][1]['target'];
                        $paymentSources = $this->config->item("payment_source");
                        cekHitam(":: $stepCode ::");
                        if (array_key_exists($stepCode, $paymentSources)) {

                            $payConfigs = $paymentSources[$stepCode];
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                                    $valueSrc = $paymentSrcConfig['valueSrc'];
                                    $externSrc = $paymentSrcConfig['externSrc'];
                                    $tr->writePaymentSrc($insertID, array(
                                        "jenis" => $connector,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                        "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                        "label" => $paymentSrcConfig['label'],
                                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "terbayar" => 0,
                                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                        "oleh_id" => $this->session->login['id'],
                                        "oleh_nama" => $this->session->login['nama'],
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                        "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                        "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                        "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                        "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                        "terbayar_valas" => 0,
                                        "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                    ));
                                    //cekMerah($this->db->last_query());
                                }
                            }


                        }
                        else {
                            //cekMerah("TIDAK nulis paymentSrc");
                        }
                        //endregion


                        //region nulis paymentAntiSource
                        //                    $stepCode = $connector;
                        $stepCode = $this->configUi[$connector]['steps'][1]['target'];
                        $paymentSources = $this->config->item("payment_antiSource");
                        if (array_key_exists($stepCode, $paymentSources)) {

                            $payConfigs = $paymentSources[$stepCode];
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                                    $valueSrc = $paymentSrcConfig['valueSrc'];
                                    $externSrc = $paymentSrcConfig['externSrc'];
                                    $tr->writePaymentAntiSrc($insertID, array(
                                        "jenis" => $connector,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                        "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                        "label" => $paymentSrcConfig['label'],
                                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "terbayar" => 0,
                                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                        "oleh_id" => $this->session->login['id'],
                                        "oleh_nama" => $this->session->login['nama'],
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                    ));
                                    //cekMerah($this->db->last_query());
                                }
                            }


                        }
                        else {
                            //cekMerah("TIDAK nulis paymentSrc");
                        }
                        //endregion


                        //==================================================================================================
                        //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
                        // bila step lebih dari 1
                        $nextStepConnector = sizeof($this->configUi[$connector]['steps']);
                        if ($nextStepConnector > 1) {
                            $this->load->model("Mdls/MdlLockerTransaksi");
                            $lt = New MdlLockerTransaksi();
                            $lt->execLocker($_SESSION[$cCode]['main'], $nextStepConnector, NULL, $insertID);
                        }


                    }
                    else {
                        //cekMerah("to be delayed to connect to $connector");
                    }
                }
                else {
                    //cekKuning("not connecting to any tCode");
                }

                //endregion

                //region --Bagian connectToStep, membuat koneksi ke cabang berdasarkan step
                $connectToStepByOptionData = isset($this->configUiJenis['connectToStepByOption'][1]) ? $this->configUiJenis['connectToStepByOption'][1] : NULL;
//                arrPrintKuning($connectToStepByOptionData);
                if ($connectToStepByOptionData != NULL) {
                    $keyMethode = $_SESSION[$cCode]["main"]["uangMukaMethod"];
                    cekHitam("MULAI CONNECT TO BY STEP [$keyMethode]");
                    // $connectToStepByOption = $connectToStepByOptionData[$keyMethode];
                    if (isset($connectToStepByOptionData[$keyMethode])) {
                        $connectToStep = $connectToStepByOptionData[$keyMethode];
                        cekHitam(":: connectToStep : $connectToStep ::");
                        $configUiMasterModulJenis = loadConfigModulJenis_he_misc($connectToStep, "coTransaksiUi");
                        $configCoreMasterModulJenis = loadConfigModulJenis_he_misc($connectToStep, "coTransaksiCore");
                        $configLayoutMasterModulJenis = loadConfigModulJenis_he_misc($connectToStep, "coTransaksiLayout");
                        $preReplacer = isset($this->configUiJenis['replacerConnectToStep']) ? $this->configUiJenis['replacerConnectToStep'] : array();
                        $connectToStepMainBuilder = isset($this->configUiJenis['connectToStepMainBuilder'][1]) ? $this->configUiJenis['connectToStepMainBuilder'][1] : array();

                        if (sizeof($configUiMasterModulJenis) == 0) {
                            die("kode connector tidak dikenali!");
                        }
                        if (sizeof($configUiMasterModulJenis['steps']) < 2) {
                            die("konfigurasi connector harus memiliki step lebih dari satu!");
                        }


                        $oldCode = $cCode;
                        $cCode = "_TR_" . $connectToStep;

                        $_SESSION[$cCode] = array();

                        $oldStep = $_SESSION[$oldCode]['main']["step_number"];
                        $clonerTransaction = isset($this->configUiJenis['clonerTransaction'][1]) ? $this->configUiJenis['clonerTransaction'][1] : array();
                        if (sizeof($clonerTransaction) && isset($clonerTransaction['main']['cloner'])) {
                            cekHere("i am here");
                            $rebuildGate = array();
                            if (isset($clonerTransaction['resetGate']) && (sizeof($clonerTransaction['resetGate']) > 0)) {
                                foreach ($clonerTransaction['resetGate'] as $gate) {
                                    //                                unset($_SESSION[$oldCode][$gate]);
                                }
                                if (isset($clonerTransaction['rebuildGate']) && (sizeof($clonerTransaction['rebuildGate']) > 0)) {
                                    foreach ($clonerTransaction['rebuildGate'] as $gate => $gateSpec) {
                                        $gateKey = $gateSpec["key"];
                                        foreach ($gateSpec["isi"] as $gkey => $gval) {
                                            $rebuildGate[$gate][$gateKey][$gkey] = makeValue($gval, $_SESSION[$oldCode]["main"], $_SESSION[$oldCode]["main"], 0);
                                        }
                                    }
                                }
                            }
                            else {
                                $rebuildGate = array(
                                    "items" => $_SESSION[$oldCode]['items'],
                                    "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                                );
                            }
                            //arrPrintWebs($rebuildGate);
                            //mati_disini();
                            $replacerTableinDetail = array(
                                "dtime" => "dtime",
                                "produk_id" => "id",
                                "produk_kode" => "kode",
                                "produk_label" => "label",
                                "produk_nama" => "nama",
                                "produk_ord_jml" => "produk_ord_jml",
                                "produk_ord_hrg" => "harga1",
                                "satuan" => "satuan",
                                "produk_jenis" => "produk_jenis",
                                "harga" => "harga1",
                                "valid_qty" => "produk_ord_jml",
                            );
                            $replacerStepItems2 = array(
                                "sub_tail_number" => "",
                                "sub_tail_code" => "",
                                "sub_step_avail" => "",
                                "sub_step_current" => "",
                                "sub_step_number" => "",
                                "next_substep_num" => "",
                                "next_substep_code" => "",
                                "next_substep_label" => "",
                                "next_subgroup_code" => "",
                            );

                            $itesmNewTmp = array();
                            //                foreach ($_SESSION[$oldCode]['items2'] as $indexItems2) {
                            //                    foreach ($indexItems2 as $itemsDetail) {
                            //
                            //                        $itesmNewTmp[$itemsDetail['id']] = array_merge($itemsDetail, $replacerStepItems2);
                            //                        foreach ($replacerTableinDetail as $selCol => $xAlias) {
                            //                            $_SESSION[$oldCode]['tableIn_detail2'][$itemsDetail['id']][$selCol] = $itemsDetail[$selCol];
                            //                        }
                            //                        foreach ($replacerStepItems2 as $stepItems2 => $tempItems2Val) {
                            //                            $_SESSION[$oldCode]['tableIn_detail2'][$itemsDetail['id']][$stepItems2] = $tempItems2Val;
                            //                        }
                            //
                            //                    }
                            //
                            //                    //                            arrPrint($itesmNew);
                            //                }
                            $itesmNew = array();
                            //                foreach ($itesmNewTmp as $itemsID => $itemData) {
                            //                    if (isset($itemData['harga'])) {
                            //                        $itemData['harga'] = $itemData['produk_ord_hrg'];
                            //                    }
                            //                    if (!isset($itemData['pihakName'])) {
                            //                        $itemData['pihakName'] = $_SESSION[$oldCode]['main']['pihakName'];
                            //                    }
                            //
                            //                    $itesmNew[$itemsID] = $itemData;
                            //                }

                            //region itemsToMaster

                            //                $itemTomasterStatic = isset($clonerTransaction['staticItemToMaster']) ? $clonerTransaction['staticItemToMaster'] : array();
                            //                $itemToMaster = isset($clonerTransaction['itemToMaster']) ? $clonerTransaction['itemToMaster'] : array();
                            //                //                        arrPrint($itemToMaster);
                            //                if (sizeof($itemToMaster) > 0) {
                            //                    foreach ($_SESSION[$oldCode]['items'] as $itemsTemp) {
                            //                        foreach ($itemToMaster as $colItems => $aliasMaster) {
                            //                            if (isset($itemsTemp[$colItems])) {
                            //                                $_SESSION[$oldCode]['main'][$aliasMaster] = $itemsTemp[$colItems];
                            //                                $_SESSION[$oldCode]['tableIn_master'][$aliasMaster] = $itemsTemp[$colItems];
                            //                            }
                            //                        }
                            //                    }
                            //                    if (sizeof($itemTomasterStatic) > 0) {
                            //                        foreach ($itemTomasterStatic as $kolStatic => $valStatic) {
                            //                            $_SESSION[$oldCode]['main'][$kolStatic] = $valStatic;
                            //                            $_SESSION[$oldCode]['tableIn_master'][$kolStatic] = $valStatic;
                            //                        }
                            //                    }
                            //
                            //                }

                            //endregion

                            $_SESSION[$cCode] = array(
                                "main" => $_SESSION[$oldCode]['main'],
                                //                            "items" => isset($_SESSION[$oldCode]['items']) ? $_SESSION[$oldCode]['items'] : array(),
                                "items" => isset($rebuildGate['items']) ? $rebuildGate['items'] : array(),
                                'items2' => isset($_SESSION[$oldCode]['items2']) ? $_SESSION[$oldCode]['items2'] : array(),
                                'items2_sum' => isset($_SESSION[$oldCode]['items2_sum']) ? $_SESSION[$oldCode]['items2_sum'] : array(),
                                'items3' => isset($_SESSION[$oldCode]['items3']) ? $_SESSION[$oldCode]['items3'] : array(),
                                'items3_sum' => isset($_SESSION[$oldCode]['items3_sum']) ? $_SESSION[$oldCode]['items3_sum'] : array(),
                                'items4' => isset($_SESSION[$oldCode]['items4']) ? $_SESSION[$oldCode]['items4'] : array(),
                                'items4_sum' => isset($_SESSION[$oldCode]['items4_sum']) ? $_SESSION[$oldCode]['items4_sum'] : array(),
                                'items5_sum' => isset($_SESSION[$oldCode]['items5_sum']) ? $_SESSION[$oldCode]['items5_sum'] : array(),
                                'items6_sum' => isset($_SESSION[$oldCode]['items6_sum']) ? $_SESSION[$oldCode]['items6_sum'] : array(),
                                'items7_sum' => isset($_SESSION[$oldCode]['items7_sum']) ? $_SESSION[$oldCode]['items7_sum'] : array(),
                                'items8_sum' => isset($_SESSION[$oldCode]['items8_sum']) ? $_SESSION[$oldCode]['items8_sum'] : array(),
                                'items9_sum' => isset($_SESSION[$oldCode]['items9_sum']) ? $_SESSION[$oldCode]['items9_sum'] : array(),
                                'items10_sum' => isset($_SESSION[$oldCode]['items10_sum']) ? $_SESSION[$oldCode]['items10_sum'] : array(),

                                "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                                //                            "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                                "tableIn_detail" => $rebuildGate['tableIn_detail'],
                                'tableIn_detail2_sum' => isset($_SESSION[$oldCode]['tableIn_detail2_sum']) ? $_SESSION[$oldCode]['tableIn_detail2_sum'] : array(),
                                "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                                'rsltItems2' => isset($_SESSION[$oldCode]['rsltItems2']) ? $_SESSION[$oldCode]['rsltItems2'] : array(),
                                "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                                'tableIn_detail_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_rsltItems2'] : array(),
                                "main_add_values" => $_SESSION[$oldCode]['main_add_values'],
                                "main_add_fields" => $_SESSION[$oldCode]['main_add_fields'],
                                "main_elements" => $_SESSION[$oldCode]['main_elements'],
                                //
                                "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                                "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values_sum'],
                                "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems2'] : array(),
                                'tableIn_detail_values2_sum' => isset($_SESSION[$oldCode]['tableIn_detail_values2_sum']) ? $_SESSION[$oldCode]['tableIn_detail_values2_sum'] : array(),

                                'itemSrc' => isset($_SESSION[$oldCode]['itemSrc']) ? $_SESSION[$oldCode]['itemSrc'] : array(),
                                'itemSrc_sum' => isset($_SESSION[$oldCode]['itemSrc_sum']) ? $_SESSION[$oldCode]['itemSrc_sum'] : array(),
                                'rsltItems3' => isset($_SESSION[$oldCode]['rsltItems3']) ? $_SESSION[$oldCode]['rsltItems3'] : array(),
                                "items_komposisi" => isset($_SESSION[$oldCode]['items_komposisi']) ? $_SESSION[$oldCode]['items_komposisi'] : array(),

                            );

                            //region unset sessio details2
                            //                //                        unset($_SESSION[$cCode]['tableIn_detail_values2_sum']);
                            //                if (isset($clonerTransaction['resetGate']) && (sizeof($clonerTransaction['resetGate']) > 0)) {
                            //                    foreach ($clonerTransaction['resetGate'] as $gate) {
                            //                        unset($_SESSION[$cCode][$gate]);
                            //                    }
                            //                }
                            //endregion

                            $masterReplacers = array(
                                //                        "referensi_id" => $masterID, (dimatikan)
                                "inv" => $tmpNomorNota,
                                "jenis_master" => $connectToStep,
                                "jenis_top" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis_label" => $configUiMasterModulJenis['steps'][1]['label'],
                                "transaksi_jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "div_id" => "18",
                                "div_nama" => "default",
                                //                            "cabang_id"       => $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                                //                            "cabang_nama"     => $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                                //                            "cabang2_id"      => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                                //                            "cabang2_nama"    => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                                //                            "gudang_id"       => $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                                //                            "gudang_nama"     => $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                                //                            "gudang2_id"      => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                                //                            "gudang2_nama"    => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                                "step_avail" => sizeof($configUiMasterModulJenis['steps']),
                                "step_current" => 1,
                                "step_number" => 1,
                                "next_step_code" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['target'] : "",
                                "next_step_label" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['label'] : "",
                                "next_group_code" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['userGroup'] : "",
                                "next_step_num" => isset($configUiMasterModulJenis['steps'][2]) ? 2 : "0",

                            );
                            $masterReplacersO = array(
                                "jenisTr" => $connectToStep,
                                "div_id" => "18",
                                "jenisTrMaster" => $connectToStep,
                                "jenisTrTop" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis_label" => $configUiMasterModulJenis['steps'][1]['label'],
                                "transaksi_jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "stepCode" => $configUiMasterModulJenis['steps'][1]['target'],
                                //                            "placeID"         => $_SESSION[$oldCode]['main']['place2ID'],
                                //                            "placeName"       => $_SESSION[$oldCode]['main']['place2Name'],
                                //                            "place2ID"        => $_SESSION[$oldCode]['main']['placeID'],
                                //                            "place2Name"      => $_SESSION[$oldCode]['main']['placeName'],
                                //                            "cabangID"        => $_SESSION[$oldCode]['main']['place2ID'],
                                //                            "cabangName"      => $_SESSION[$oldCode]['main']['place2Name'],
                                //                            "cabang2ID"       => $_SESSION[$oldCode]['main']['placeID'],
                                //                            "cabang2Name"     => $_SESSION[$oldCode]['main']['placeName'],
                                //                            //
                                //                            "gudang2ID"       => $_SESSION[$cCode]['main']['gudangID'],
                                //                            "gudang2Name"     => $_SESSION[$cCode]['main']['gudangName'],
                                //                            "gudangID"        => $_SESSION[$cCode]['main']['gudang2ID'],
                                //                            "gudangName"      => $_SESSION[$cCode]['main']['gudang2Name'],
                            );
                        }
                        else {
                            //==replace pertama
                            $_SESSION[$cCode] = array(
                                "main" => $_SESSION[$oldCode]['main'],
                                "items" => $_SESSION[$oldCode]['items'],
                                "items2" => $_SESSION[$oldCode]['items2'],
                                "items2_sum" => $_SESSION[$oldCode]['items2_sum'],
                                "items3" => $_SESSION[$oldCode]['items3'],
                                "items3_sum" => $_SESSION[$oldCode]['items3_sum'],
                                "items4_sum" => $_SESSION[$oldCode]['items4_sum'],
                                "items_noapprove" => isset($_SESSION[$oldCode]['items_noapprove']) ? $_SESSION[$oldCode]['items_noapprove'] : array(),

                                "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                                "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],

                                "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                                "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],

                                "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                                "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                                "tableIn_detail_values_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'],
                            );
                            $masterReplacersO = array(
                                "jenisTr" => $connectToStep,
                                "jenisTrMaster" => $connectToStep,
                                "jenisTrTop" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis_label" => $configUiMasterModulJenis['steps'][1]['label'],
                                "transaksi_jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "stepCode" => $configUiMasterModulJenis['steps'][1]['target'],
                                "placeID" => isset($preReplacer['place2ID']) ? $preReplacer['place2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                                "placeName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                                "place2ID" => $_SESSION[$cCode]['main']['placeID'],
                                "place2Name" => $_SESSION[$cCode]['main']['placeName'],
                                "cabangID" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                                "cabangName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                                "cabang2ID" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang2Name" => $_SESSION[$cCode]['main']['placeName'],
                                //
                                "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                                "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                                "gudangID" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['main']['gudang2ID'],
                                "gudangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['main']['gudang2Name'],
                                "pihakID" => isset($_SESSION[$cCode]['main']['placeID']) ? $_SESSION[$cCode]['main']['placeID'] : "",
                                "pihakName" => isset($_SESSION[$cCode]['main']['placeName']) ? $_SESSION[$cCode]['main']['placeName'] : "",
                                "pihakName2" => $_SESSION[$cCode]['main']['placeName'],
                                "gudang" => $_SESSION[$cCode]['main']['gudangID'],
                                "gudang__name" => $_SESSION[$cCode]['main']['gudangName'],
                                "gudang__label" => $_SESSION[$cCode]['main']['gudangName'],
                                "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",

                            );
                            $masterReplacers = array(
                                //                    "referensi_id" => $masterID, (dimatikan)
                                "inv" => $tmpNomorNota,
                                "jenis_master" => $connectToStep,
                                "jenis_top" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "jenis_label" => $configUiMasterModulJenis['steps'][1]['label'],
                                "transaksi_jenis" => $configUiMasterModulJenis['steps'][1]['target'],
                                "cabang_id" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['tableIn_master']['cabang2_id'],
                                "cabang_nama" => isset($preReplacer['cabang2Name']) ? $preReplacer['cabang2Name'] : $_SESSION[$cCode]['tableIn_master']['cabang2_nama'],
                                "cabang2_id" => $_SESSION[$cCode]['tableIn_master']['cabang_id'],
                                "cabang2_nama" => $_SESSION[$cCode]['tableIn_master']['cabang_nama'],
                                "gudang_id" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['tableIn_master']['gudang2_id'],
                                "gudang_nama" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['tableIn_master']['gudang2_nama'],
                                "gudang2_id" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                                "gudang2_nama" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                                "gudang" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                                "gudang__name" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                                "gudang__label" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],

                                "step_avail" => sizeof($configUiMasterModulJenis['steps']),
                                "step_current" => 1,
                                "step_number" => 1,
                                "next_step_code" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['target'] : "",
                                "next_step_label" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['label'] : "",
                                "next_group_code" => isset($configUiMasterModulJenis['steps'][2]) ? $configUiMasterModulJenis['steps'][2]['userGroup'] : "",
                                "next_step_num" => isset($configUiMasterModulJenis['steps'][2]) ? 2 : "0",
                                "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",

                            );
                        }


                        foreach ($masterReplacersO as $key => $val) {
                            $_SESSION[$cCode]['main'][$key] = $val;
                        }
                        foreach ($masterReplacers as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }


                        if (sizeof($connectToStepMainBuilder) > 0) {
                            foreach ($connectToStepMainBuilder as $r_key => $r_val) {
                                $_SESSION[$cCode]['main'][$r_key] = isset($_SESSION[$cCode]['main'][$r_val]) ? $_SESSION[$cCode]['main'][$r_val] : "";
                            }
                        }

                        //region penomoran receipt #2
                        //<editor-fold desc="==========penomoran">
                        $this->load->model("CustomCounter");
                        $cn = new CustomCounter("transaksi");
                        $cn->setType("transaksi");

                        $counterForNumber = array($configCoreMasterModulJenis['formatNota']);
                        if (!in_array($counterForNumber[0], $configCoreMasterModulJenis['counters'])) {
                            die(__LINE__ . " Used number should be registered in 'counters' config as well");
                        }

                        foreach ($counterForNumber as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                        }

                        $tmpNomorNota2 = $paramSpec['paramString'];
                        $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);


                        //</editor-fold>
                        //endregion

                        //region dynamic counters #2
                        // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                        $cn = new CustomCounter("transaksi");
                        $cn->setType("transaksi");
                        $configCustomParams = $configCoreMasterModulJenis['counters'];
                        $configCustomParams[] = "stepCode";
                        if (sizeof($configCustomParams) > 0) {
                            $cContent = array();
                            foreach ($configCustomParams as $i => $cRawParams) {
                                $cParams = explode("|", $cRawParams);
                                $cValues = array();
                                foreach ($cParams as $param) {
                                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                }
                                $cRawValues = implode("|", $cValues[$i]);
                                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                                $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                                switch ($paramSpec['id']) {
                                    case 0: //===counter type is new
                                        $paramKeyRaw = print_r($cParams, true);
                                        $paramValuesRaw = print_r($cValues[$i], true);
                                        $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                        break;
                                    default: //===counter to be updated
                                        $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                        break;
                                }
                                //echo "<hr>";
                            }
                        }
                        $appliedCounters2 = base64_encode(serialize($cContent));
                        $appliedCounters_inText2 = print_r($cContent, true);
                        // </editor-fold>
                        //endregion


                        $addValues = array(
                            'counters' => $appliedCounters2,
                            'counters_intext' => $appliedCounters_inText2,
                            'nomer' => $tmpNomorNota2,
                            'nomer_top' => $tmpNomorNota2,
                            'nomer2' => $tmpNomorNota2Alias,
                            'dtime' => date("Y-m-d H:i:s"),
                            'fulldate' => date("Y-m-d"),
                        );
                        foreach ($addValues as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }

                        //===cloning nota cab1 ke cab2
                        //===daftar perbedaan
                        //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,

                        //==replace kedua
                        $masterReplacers = array(
                            "nomer" => $tmpNomorNota2,
                            "nomer2" => $tmpNomorNota2Alias,
                            "counters" => $appliedCounters2,
                            "counters_intext" => $appliedCounters_inText2,
                        );
                        foreach ($masterReplacers as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }


                        //===cloning detail/items cabang1 ke cabang2
                        //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                        $detailReplacers = array(
                            "sub_step_avail" => sizeof($configUiMasterModulJenis['steps']),
                            "sub_step_current" => 1,
                            "sub_step_number" => 1,
                            "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                            "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                            "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                            "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                        );
                        if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                            //                    cekmerah("tulis rincian transaksi kedua");
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                                foreach ($dSpec as $key => $val) {
                                    $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                                }
                            }
                        }
                        else {
                            //                    cekmerah("GAGAL tulis rincian transaksi kedua");
                        }

                        //                    arrPrintPink($_SESSION[$cCode]['tableIn_master']);
                        //                    arrPrintHijau($_SESSION[$cCode]['tableIn_detail']);

                        //region ----------write transaksi & transaksi_data #2
                        if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

                            $tr = new MdlTransaksi();
                            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                            $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                            cekUngu($this->db->last_query());
                            $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                            $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                            $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                            $mongoListConnect['main'] = array($insertID, $epID);
                            cekmerah("tulis transaksi kedua :: trID $insertID");
                            cekmerah($this->db->last_query());
                            if ($insertID < 1) {
                                die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                            }
                        }
                        else {
                            cekmerah("GAGAL tulis transaksi kedua");
                        }
                        if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                            $inserMainValues = array();
                            foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                                $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                $inserMainValues[] = $dd;
                                $mongoListConnect['mainValues'][] = $dd;
                            }
                            if (sizeof($inserMainValues) > 0) {
                                $arrBlob = blobEncode($inserMainValues);
                                $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                            }
                        }
                        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                            foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                                $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                $mongoListConnect['mainValues'][] = $dd;
                            }
                        }
                        if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                            foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                                $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                $inserMainValues[] = $dd;
                                $mongoListConnect['mainValues'][] = $dd;
                            }
                        }
                        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                            //                    cekMerah("ada mainElements");
                            foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                                $tr->writeMainElements($insertID, array(
                                    "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                    "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                    "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                    "name" => $aSpec['name'],
                                    "label" => $aSpec['label'],
                                    "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                    "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                                ));
                            }
                        }
                        if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                            $insertIDs = array();
                            $insertDeIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                                $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                                showLast_query("ungu");
                                if ($insertDetailID < 1) {
                                    die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                                }
                                else {
                                    $insertIDs[] = $insertDetailID;
                                    $insertDeIDs[$insertID][] = $insertDetailID;
                                    $mongoListConnect['detail'][] = $insertDetailID;
                                }
                                if ($epID != 999) {
                                    $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                    if ($insertEpID < 1) {
                                        die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                                    }
                                    else {
                                        $insertIDs[] = $insertEpID;
                                        $insertDeIDs[$epID][] = $insertEpID;
                                        $mongoListConnect['detail'][] = $insertEpID;
                                    }
                                }
                            }
                            if (sizeof($insertIDs) == 0) {
                                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                            }
                            else {
                                $indexing_details = array();
                                foreach ($insertDeIDs as $key => $numb) {
                                    $indexing_details[$key] = $numb;
                                }

                                foreach ($indexing_details as $k => $arrID) {
                                    $arrBlob = blobEncode($arrID);
                                    $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                                    cekOrange($this->db->last_query());
                                }
                            }
                        }
                        if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                            $insertIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                                $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                                $mongoListConnect['detail'] = $insertIDs;
                                if ($epID != 999) {
                                    $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                    $mongoListConnect['detail'] = $mongoListConnect['detail'] = $insertIDs;;
                                }
                            }
                        }
                        if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                            $insertIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                                if (isset($this->configCoreJenis['tableIn']['detailValues'])) {
                                    foreach ($this->configCoreJenis['tableIn']['detailValues'] as $key => $src) {
                                        $dd = $tr->writeDetailValues($insertID, array(
                                            "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                            "produk_id" => $pID,
                                            "key" => $key,
                                            "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                        ));
                                        $insertIDs[] = $dd;
                                        $mongoListConnect['detailValues'][] = $dd;

                                    }
                                }
                            }
                            if (sizeof($insertIDs) > 0) {
                                $arrBlob = blobEncode($insertIDs);
                                $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                            }
                        }
                        if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                                if (isset($this->configCoreJenis['tableIn']['detailValues2_sum'])) {
                                    foreach ($this->configCoreJenis['tableIn']['detailValues2_sum'] as $key => $src) {
                                        $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                            "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                            "produk_id" => $pID,
                                            "key" => $key,
                                            "value" => $dSpec[$src],
                                        ));

                                    }
                                }
                            }
                        }

                        //
                        //region nulis paymentSource
                        $stepCode = $configUiMasterModulJenis['steps'][1]['target'];
                        $paymentSources = $this->config->item("payment_source");
                        if (array_key_exists($stepCode, $paymentSources)) {

                            $payConfigs = $paymentSources[$stepCode];
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                                    $valueSrc = $paymentSrcConfig['valueSrc'];
                                    $externSrc = $paymentSrcConfig['externSrc'];
                                    $tr->writePaymentSrc($insertID, array(
                                        "jenis" => $stepCode,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                        "nomer" => $tmpNomorNota2,
                                        "label" => $paymentSrcConfig['label'],
                                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "terbayar" => 0,
                                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                        "oleh_id" => $this->session->login['id'],
                                        "oleh_nama" => $this->session->login['nama'],
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                        "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                        "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                        "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                        "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                        "terbayar_valas" => 0,
                                        "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                    ));
                                }
                            }


                            //cekMerah($this->db->last_query());

                        }
                        else {
                            //cekMerah("TIDAK nulis paymentSrc");
                        }
                        //endregion


                        //region nulis paymentAntiSource
                        $stepCode = $configUiMasterModulJenis['steps'][1]['target'];
                        $paymentSources = $this->config->item("payment_antiSource");
                        if (array_key_exists($stepCode, $paymentSources)) {
                            $payConfigs = $paymentSources[$stepCode];
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                                    $valueSrc = $paymentSrcConfig['valueSrc'];
                                    $externSrc = $paymentSrcConfig['externSrc'];
                                    $tr->writePaymentAntiSrc($insertID, array(
                                        "jenis" => $stepCode,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                        "nomer" => $tmpNomorNota2,
                                        "label" => $paymentSrcConfig['label'],
                                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "terbayar" => 0,
                                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                        "oleh_id" => $this->session->login['id'],
                                        "oleh_nama" => $this->session->login['nama'],
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                    ));
                                }
                            }


                            //cekMerah($this->db->last_query());

                        }
                        else {
                            //cekMerah("TIDAK nulis paymentSrc");
                        }
                        //endregion

                        $idHis_decode = array();
                        $idHis_decode[1] = array(
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "olehID" => $_SESSION[$cCode]['main']['olehID'],
                            "olehName" => $_SESSION[$cCode]['main']['olehName'],
                            //                "step" => $stepNum,
                            "step" => 1,
                            "trID" => $insertID,
                            "nomer" => $tmpNomorNota2,
                            "nomer2" => $tmpNomorNota2Alias,
                            "counters" => $appliedCounters2,
                            "counters_intext" => $appliedCounters_inText2,
                        );
                        $idHis_blob = blobEncode($idHis_decode);
                        $idHis_intext = print_r($idHis_decode, true);

                        $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                        $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;

                        $tr = new MdlTransaksi();
                        $dupState = $tr->updateData(array("id" => $insertID), array(
                            "id_master" => $masterID,
                            "id_top" => $insertID,

                            "ids_his" => $idHis_blob,
                            "ids_his_intext" => $idHis_intext,

                        )) or die("Failed to update tr next-state!");


                        arrPrintPink($_SESSION[$cCode]['tableIn_master']);// diganti manjadi gerbang uang muka
                        arrPrintHijau($_SESSION[$cCode]['tableIn_detail']);// diganti manjadi gerbang uang muka


                        $baseRegistries = array(
                            'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                            'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                            'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                            'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                            'itemSrc' => isset($_SESSION[$cCode]['itemSrc']) ? $_SESSION[$cCode]['itemSrc'] : array(),
                            'itemSrc_sum' => isset($_SESSION[$cCode]['itemSrc_sum']) ? $_SESSION[$cCode]['itemSrc_sum'] : array(),
                            'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                            'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                            'items4' => isset($_SESSION[$cCode]['items4']) ? $_SESSION[$cCode]['items4'] : array(),
                            'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                            'items5_sum' => isset($_SESSION[$cCode]['items5_sum']) ? $_SESSION[$cCode]['items5_sum'] : array(),
                            'items6_sum' => isset($_SESSION[$cCode]['items6_sum']) ? $_SESSION[$cCode]['items6_sum'] : array(),
                            'items7_sum' => isset($_SESSION[$cCode]['items7_sum']) ? $_SESSION[$cCode]['items7_sum'] : array(),
                            'items8_sum' => isset($_SESSION[$cCode]['items8_sum']) ? $_SESSION[$cCode]['items8_sum'] : array(),
                            'items9_sum' => isset($_SESSION[$cCode]['items9_sum']) ? $_SESSION[$cCode]['items9_sum'] : array(),
                            'items10_sum' => isset($_SESSION[$cCode]['items10_sum']) ? $_SESSION[$cCode]['items10_sum'] : array(),
                            'items_noapprove' => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),

                            'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                            'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                            'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                            'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                            'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                            'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                            'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                            'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                            'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                            'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                            'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                            'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                            'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                            'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                            'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                            'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                            'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                            'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                            "receiptDetailFields" => isset($configLayoutMasterModulJenis['receiptDetailFields'][1]) ? $configLayoutMasterModulJenis['receiptDetailFields'][1] : array(),
                            "receiptSumFields" => isset($configLayoutMasterModulJenis['receiptSumFields'][1]) ? $configLayoutMasterModulJenis['receiptSumFields'][1] : array(),
                            "receiptDetailFields2" => isset($configLayoutMasterModulJenis['receiptDetailFields2'][1]) ? $configLayoutMasterModulJenis['receiptDetailFields2'][1] : array(),
                            "receiptSumFields2" => isset($configLayoutMasterModulJenis['receiptSumFields2'][1]) ? $configLayoutMasterModulJenis['receiptSumFields2'][1] : array(),
                            "receiptDetailSrcFields" => isset($configLayoutMasterModulJenis['receiptDetailSrcFields'][1]) ? $configLayoutMasterModulJenis['receiptDetailSrcFields'][1] : array(),
                            "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                            "componentsBuilder" => isset($_SESSION[$cCode]['componentsBuilder']) ? $_SESSION[$cCode]['componentsBuilder'] : array(),
                            "jurnalItems" => isset($_SESSION[$cCode]['jurnalItems']) ? $_SESSION[$cCode]['jurnalItems'] : array(),
                            "jurnal_index" => isset($_SESSION[$cCode]['jurnal_index']) ? $_SESSION[$cCode]['jurnal_index'] : array(),
                            "postProcessor" => isset($_SESSION[$cCode]['postProcessor']) ? $_SESSION[$cCode]['postProcessor'] : array(),
                            "preProcessor" => isset($_SESSION[$cCode]['preProcessor']) ? $_SESSION[$cCode]['preProcessor'] : array(),
                            "revert" => isset($_SESSION[$cCode]['revert']) ? $_SESSION[$cCode]['revert'] : array(),

                        );
                        $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                        showLast_query("biru");
                        $mongRegIDConnect = $doWriteReg;
                        //endregion


                        //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
                        $this->load->model("Mdls/MdlLockerTransaksi");
                        $lt = New MdlLockerTransaksi();
                        $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], NULL, $insertID);
                    }
                    else {
                        cekHitam("tidak ditulis");
                    }
                    matiHEre();
                    cekMerah("to be connected by Step to $connectToStepByOption |$stepNum|");
                    cekMerah("NOW CONNECTING to $connectToStep");

                    //                mati_disini();
                    //==================================================================================================

                }
                //endregion --Bagian connectToStep, membuat koneksi ke cabang berdasarkan step

                //region Com pre purchase
                //split to Pre Pre Purchase Supplies dari Request Cabang untuk stok yang tidak ada/kurang diPusat.
                //sekaligus check jika valid_qty sudah nol maka update next_substep_code transaksi bayangannya.
                //dimatikan sementara untuk TEST
                $iterator = isset($this->configUiJenis['comPrePurchase'][1]['detail']) ? $this->configUiJenis['comPrePurchase'][1]['detail'] : array();
                $aliasMainTrans = isset($this->configUiJenis['aliasMainTrans']) ? $this->configUiJenis['aliasMainTrans'] : 999;
                if (sizeof($iterator) > 0) {
                    //            matiHere();
                    $tmp = array();
                    $this->load->model("MdlTransaksi");
                    $l = new MdlTransaksi();
                    $l->setFilters(array());
                    $l->addFilter("transaksi.link_id=0");
                    $l->addFilterJoin("transaksi_data.valid_qty>0");
                    $l->addFilterJoin("transaksi_data.next_substep_code='" . $aliasMainTrans . "'");
                    $l->addFilterJoin("transaksi_data.produk_id in (" . implode(",", array_keys($_SESSION[$cCode]['items'])) . ")");
                    $tmp = $l->lookupJoined();
                    //            cekHitam($this->db->last_query());
                    //            arrPrint( implode(",",array_keys($_SESSION[$cCode]['items'])));
                    //matiHEre(sizeof($tmp). " iki ".__LINE__);
                    if (sizeof($tmp) > 0) {
                        //                matiHEre("masukk");
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $comName = $tComSpec['comName'];
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];

                            echo "post-processor: $comName<br>LINE: " . __LINE__;
                            $dSpec = $_SESSION[$cCode][$srcGateName];
                            $tmpOutParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $tmpOutParams['loop'][$key] = $value;
                                }
                            }
                            if (sizeof($dSpec) > 0) {
                                foreach ($dSpec as $pid => $arrValue) {
                                    $tmpOutParams[$srcGateName][$pid] = $arrValue['jml'];
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                    $tmpOutParams['static'][$key] = $realValue;
                                }
                                if (!isset($tmpOutParams['static']["jenis"])) {
                                    $tmpOutParams['static']["jenis"] = $aliasMainTrans;
                                }
                                if (!isset($tmpOutParams['static']["jenis_master"])) {
                                    $tmpOutParams['static']["jenis_master"] = $this->jenisTr;
                                }
                                if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                    $tmpOutParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                    $tmpOutParams['static']["transaksi_no"] = $insertNum;
                                }
                                $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $tmpOutParams['static']["keterangan"] = $this->configUiJenis['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                            }
                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();
                            $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        }
                    }

                }
                else {
                    cekHere("LINE: " . __LINE__ . " || jenis: " . $this->jenisTr . " Tidak masuk Iterator PRE PURCHASE SUPPLIES");
                }

                //endregion Com pre purchase

            }

            //region writelog
            $this->load->model("Mdls/" . "MdlActivityLog");
            $hTmp = new MdlActivityLog();
            $tmpHData = array(
                "title" => $_SESSION[$cCode]['main']['jenisTrName'],
                "sub_title" => "Saving new transaction",
                "uid" => $this->session->login['id'],
                "uname" => $this->session->login['nama'],
                "dtime" => date("Y-m-d H:i:s"),
                "transaksi_id" => $insertID,
                "deskripsi_old" => "",
                "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
                "jenis" => $this->jenisTr,
                "ipadd" => $_SERVER['REMOTE_ADDR'],
                "devices" => $_SERVER['HTTP_USER_AGENT'],
                "category" => "transaksi",
                "controller" => $this->uri->segment(1),
                "method" => $this->uri->segment(2),
                "url" => current_url(),

            );
            $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Gagal menulis riwayat data", __FILE__));
            //endregion


//            cekKuning(":: mulai cek rek besar dan rek pembantu");
            $cabangID_validate = $this->session->login['cabang_id'];
            validateAllBalances();

            $pakai_ini = 0;
            if ($pakai_ini == 1) {

                // cek ulang sesi bookingnumber masih ada atau hilang atau kosong... bila hilang/kosong maka hentikan.
                if (!isset($_SESSION[$cCode]["main"]["bookingNumber"])) {
                    $msg = "Nomer Booking transaksi baru belum terdaftar. code: " . __LINE__;
                    mati_disini($msg);
                }
                elseif ($_SESSION[$cCode]["main"]["bookingNumber"] == null) {
                    $msg = "Nomer Booking transaksi baru belum terdaftar. code: " . __LINE__;
                    mati_disini($msg);
                }
                if ($nomerBookingTransaksi != $_SESSION[$cCode]["main"]["bookingNumber"]) {
                    $msg = "Nomer/Kode Booking transaksi baru belum terdaftar. Silahkan referesh halaman ini. code: " . __LINE__;
                    mati_disini($msg);
                }
            }

//            mati_disini("LINE: " . __LINE__ . " under maintenance, tunggu beberapa saat lagi yaa.., TRID: $insertID");
//
//            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
//
//
//            if (isset($_SESSION[$cCode])) {
//                unset($_SESSION[$cCode]);
//            }
//            if (isset($oldCode)) {
//                if (isset($_SESSION[$oldCode])) {
//                    unset($_SESSION[$oldCode]);
//                }
//            }

//
//            //region feedback msg
//            $this->session->errMsg = "transaction entry has been saved<br>";
//            $nextNum = $nextProp["num"];
//            if (isset($this->configUiJenis['steps'][$nextNum])) {
//                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->configUiJenis['steps'][$nextNum]['stateLabel'] . "</strong><br>";
//                $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->configUiJenis['steps'][$nextNum]['userGroup'] . "</strong><br>";
//                $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;
//
//            }
//            else {
//                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->configUiJenis['steps'][$nextNum]['stateLabel'] . "</strong><br>";
//                $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;
//
//            }
//            $trBackClick = "location.href='$trBackLink'";
//            //            $this->session->errMsg .= "<a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
//            //endregion
//
//
//            if (strlen($rawPrevURL) > 3) {
//                $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
//                                   {
//                                       title:'Followup preview',
//                                       message: " . 'top.$' . "('<div><img class=\"text-center text-bold\" width=\"35%\" src=\"//cdn.mayagrahakencana.com/assets/images/d60eb1v-79212624-e842-4e55-8d58-4ac7514ca8e4.gif\"><br/><h2>MOHON TUNGGU, SYSTEM SEDANG MEMUAT DATA...</h2></div>').load('$prevUrl'),
//                                        size:top.BootstrapDialog.SIZE_WIDE,
//                                        draggable:false,
//                                        closable:true,
//                                        }
//                                        );";
//
//
//                echo "<script>top.open_holdon();$actionTarget</script>";
//
//                //                echo "</body>";
//                //                echo "</html>";
//            }
//            else {
//                if (isset($this->configLayoutJenis['allowPrint']['1'])) {
//                    $printSettings = isset($this->configLayoutJenis['allowPrint']['1']) ? $this->configLayoutJenis['allowPrint']['1'] : array();
//                    $printMod = isset($this->configLayoutJenis['printMod']['1']) ? $this->configLayoutJenis['printMod']['1'] : "";
//                    $printLocation = $this->configLayoutJenis['printLocation'];
//                    if (isset($printSettings['size'])) {
//                        //                        cekkuning("detecting printing size");
//
//                        switch ($printSettings['size']) {
//                            case "normal":
//                                echo "<script>";
//                                echo "top.popBig('" . MODUL_PATH . $printLocation . $this->jenisTr . "/$tmpNomorNota?" . "$printMod');";
//                                echo "top.location.reload();";
//                                echo "</script>";
//                                break;
//                            case "small":
//                                echo "<script>";
//                                echo "top.popSmall('" . MODUL_PATH . $printLocation . $this->jenisTr . "/$tmpNomorNota?" . "$printMod');";
//                                echo "top.location.reload();";
//                                echo "</script>";
//                                break;
//                            default:
//                                //                                cekkuning("size: UNKNOWN");
//                                break;
//                        }
//
//
//                    }
//                    else {
//                        cekkuning("not printing");
//                        $arrAlert = array(
//                            "type" => "success",
//                            "title" => "Transaction saved",
//                            //                        "html" => "your order has been saved and ready to process",
//                            "html" => $this->session->errMsg,
//                            "timer" => "1500",
//                            "showConfirmButton" => false,
//                            "allowOutsideClick" => false,
//                        );
//                        echo swalAlert($arrAlert);
//                        echo "<script>topReload(1500)</script>";
//                        echo topReload();
//                        echo "</script>";
//                        unset($this->session->errMsg);
//                    }
//
//                }
//                else {
//                    //                    cekkuning("settings dont exist, not printing");
//                    $arrAlert = array(
//                        "type" => "success",
//                        "title" => "Transaction saved",
//                        //                        "html" => "your order has been saved and ready to process",
//                        "html" => $this->session->errMsg,
//                        "timer" => "1500",
//                        "showConfirmButton" => false,
//                        "allowOutsideClick" => false,
//                    );
//                    echo swalAlert($arrAlert);
//                    echo "<script>topReload(1500)</script>";
//                    echo topReload();
//                    echo "</script>";
//                    unset($this->session->errMsg);
//                }
//
//            }
            return true;
        }
        else {
            die("the gate index you want to debug has not been formed yet!");
        }
    }

    public function generateInvoicing()
    {
//        mati_disini("LINE: " . __LINE__ . " under maintenance, tunggu beberapa saat lagi yaa.., TRID:.... ");
        header("refresh:2");

        if (!isset($this->session->login)) {
            mati_disini("SETOP... " . __LINE__);
        }
        if ($this->session->login['id'] == CB_ID_PUSAT) {
            mati_disini("SETOP... HARUS LOGIN CABANG " . __LINE__);
        }
        if ($this->session->login['id'] == 0) {
            mati_disini("SETOP... HARUS LOGIN CABANG " . __LINE__);
        }

        $start = microtime(true);
        $this->load->helper("he_session_replacer");
        $this->load->model("MdlTransaksi");
        $jenisTr = $this->jenisTr = "4822";
        $batas_tanggal = "2024-02-18";
        $cCode = "_TR_" . $this->jenisTr;
        if (isset($_SESSION[$cCode])) {
            $_SESSION[$cCode] = null;
            unset($_SESSION[$cCode]);
        }

        $configUiMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiUi");
        $configCoreMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiCore");
        $configLayoutMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiLayout");
        $configValuesMasterModulJenis = loadConfigModulJenis_he_misc($this->jenisTr, "coTransaksiValues");


        $this->db->trans_start();

        $tr = new MdlTransaksi();
        $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
        $tr->addFilter("transaksi.status_inv='0'");
        $tr->addFilter("transaksi.fulldate>='$batas_tanggal'");
        $this->db->limit(1);
        $this->db->order_by("transaksi.id", "ASC");
        $this->db->group_start();

        $where_1 = "transaksi.jenis='5822spd' and transaksi.pembayaran in ('credit','cod')";
        $this->db->group_start();
        $this->db->where($where_1);
        $this->db->group_end();

        $where_2 = "transaksi.jenis='4464'";
        $where_3 = "transaksi.jenis='7499'";// termin
        $this->db->or_where($where_2);
        $this->db->or_where($where_3);
        $this->db->group_end();

//        $this->db->group_start();
//        $this->db->where(
//            array(
//                "transaksi.jenis" => "5822spd",
//                "transaksi.pembayaran" => "credit",
//            )
//        );
//        $this->db->group_end();
//        $this->db->or_where(
//            array(
//                "transaksi.jenis" => "4464"
//            )
//        );
//        $this->db->group_end();


        $sesionReplacer = replaceSession();
        $tmpHist = $tr->lookupRecentUndoneEntries_joined($sesionReplacer)->result();
        showLast_query("biru");
        cekBiru(count($tmpHist));
//        arrPrintPink($tmpHist);
//        mati_disini(__LINE__);
        if (sizeof($tmpHist) > 0) {
            $transaksi_id = $tmpHist[0]->transaksi_id;
            $dtime = $tmpHist[0]->dtime;
            $jenisTransaksi = $tmpHist[0]->jenis;
            cekHitam("[$transaksi_id] [$dtime] [$jenisTransaksi]");
            $arrKiriman = array(
                "transaksi_id" => $transaksi_id,
                "step_number" => 1,
                "currentStepNumber" => 1,
                "jenisTr" => $jenisTr,
                "uiJenis" => $configUiMasterModulJenis,
                "coreJenis" => $configCoreMasterModulJenis,
                "layoutJenis" => $configLayoutMasterModulJenis,
                "valuesJenis" => $configValuesMasterModulJenis,
                "dtime" => $tmpHist[0]->dtime,
                "fulldate" => $tmpHist[0]->fulldate,
            );
//            arrPrintKuning($arrKiriman);
            $this->followupPrePreviewInvoicing($arrKiriman);
//            arrPrint($_SESSION[$cCode]["items"]);
//            mati_disini(__LINE__);
            cekHijau("MULAI EKSEKUTOR SAVE");
            $this->save($arrKiriman);


            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $where = array(
                "id" => $transaksi_id,
            );
            $data = array(
                "status_inv" => 1,
            );
            $tr->updateData($where, $data);
            showLast_query("orange");

        }

        $end = microtime(true);
        $selisih = $end - $start;

//        mati_disini("LINE: " . __LINE__ . " under maintenance, tunggu beberapa saat lagi yaa.., TRID:.... [$selisih]");


        if (isset($_SESSION[$cCode])) {
            unset($_SESSION[$cCode]);
        }
        if (isset($oldCode)) {
            if (isset($_SESSION[$oldCode])) {
                unset($_SESSION[$oldCode]);
            }
        }


        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>SELESAI... [$selisih]</h3>");


    }

    //-------------------------------------------
    public function koreksiDiskonHutangDagang()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlSupplier");


        // load transaksi opname, mengambil data yang akan dieksekusi
        $cabangID = "-1";
        $cabangNama = "PUSAT/DC";
        $gudangID = "-1";
        $gudangNama = "default warehouse at branch #-1";
        $cabang2ID = "-1";
        $cabang2Nama = "pusat dc";
        $gudang2ID = "-1";
        $gudang2Nama = "default warehouse at branch #-1";

        $olehID = "-100";
        $olehNama = "system";
//        $pihakID = "20";
//        $pihakNama = "PT. CHANGHONG";
        $pihakID = "4";
        $pihakNama = "PT.PANASONIC GOBEL INDONESIA";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $cash_account = 0;
        $cash_account_nama = "";
        $referenceID = 0;
        $referenceNomer = "";


        $this->db->trans_start();


        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
//            "description" => "koreksi pembayaran/AP Payment PT. CHANGHONG dari pemindahbukuan PM.FG.-1.20.400029 denga jurnal laba lain-lain pada hutang dagang.",
            "description" => "koreksi pembayaran/AP Payment PT.PANASONIC GOBEL INDONESIA dari pemindahbukuan PM.FG.-1.4.100030 denga jurnal laba lain-lain pada hutang dagang.",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );

        $harga_pokok = 0;
        $persediaan_produk = 0;
        $hutang_ke_pusat = 0;
        $piutang_cabang = 0;
        $laba_lain_lain = 0;
        $hutang_dagang = 0;

        $detailGate = array();
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $total_nilai = 0;
            $arrProdukDatas = array();
            $arrprodukIDs = array(
//                "20" => array(
//                    "hpp" => "347659999",
//                    "harga" => "347659999",
//                    "jml" => "1",
//                    "qty" => "1",
////                    "nomer" => "5822so.1.473.2",
////                    "nama" => "5822so.1.473.2",
////                    "name" => "5822so.1.473.2",
//                ),
                "4" => array(
                    "hpp" => "683775034",
                    "harga" => "683775034",
                    "jml" => "1",
                    "qty" => "1",
//                    "nomer" => "5822so.1.473.2",
//                    "nama" => "5822so.1.473.2",
//                    "name" => "5822so.1.473.2",
                ),
            );
            $arrprodukIDKey = array_keys($arrprodukIDs);
            $pakai_ini = 1;
            if ($pakai_ini == 1) {
                $pr = New MdlSupplier();
                $pr->addFilter("id in ('" . implode("','", $arrprodukIDKey) . "')");
                $prTmp = $pr->lookupAll()->result();
                showLast_query("biru");
                foreach ($prTmp as $prSpec) {
                    $arrProdukDatas[$prSpec->id] = $prSpec;
                }
                foreach ($arrProdukDatas as $pid => $specc) {
                    $pnama = $specc->nama;
                    $kode = $specc->kode;
                    $barcode = $specc->barcode;
                    $satuan = $specc->satuan;
                    $jml = $arrprodukIDs[$pid]["jml"];
                    $qty = $arrprodukIDs[$pid]["qty"];
                    $hpp = $arrprodukIDs[$pid]["hpp"];
                    $harga = $arrprodukIDs[$pid]["harga"];
                    $sub_hpp = $hpp * $jml;
                    $sub_harga = $harga * $jml;
                    $total_nilai += $sub_hpp;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $harga,
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => $pnama,
                        "kode" => $kode,
                        "barcode" => $barcode,
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $qty,
                        "name" => $pnama,
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }
            else {

                // kalau transaksi detailnya
                foreach ($arrprodukIDs as $pid => $specc) {
                    $sub_hpp = $specc["jml"] * $specc["hpp"];
                    $sub_harga = $specc["jml"] * $specc["harga"];
                    $total_nilai += $sub_harga;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $specc["jml"],
                        "harga" => $specc["harga"],
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $specc["hpp"],
                        "nama" => $specc["nama"],
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $specc["qty"],
                        "name" => $specc["name"],
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }

            //region 1 produk
            $mainHarga = $total_nilai;
            $harga_pokok = 0;
            $persediaan_produk = 0;
            $hutang_dagang = $total_nilai;
            $hutang_dagang_detail_1 = 0;
            $hutang_dagang_detail_2 = 0;
            $hutang_ke_pusat = 0;
            $piutang_cabang = 0;
            $laba_lain_lain = $total_nilai;
            $ppn_masukan = 0;
            $modal = 0;
            $kas = 0;
            $kas_minus = 0;
            $hutang_ke_konsumen = 0;
            $hutang_ke_konsumen_noppn = 0;

            foreach ($detailGate as $pid => $spec) {
                foreach ($mainGate as $key => $val) {
                    $spec[$key] = $val;
                }

                $spec["produk_qty_item"] = -$spec["jml"];
                $spec["produk_nilai_item"] = $spec["harga"];
                $spec["produk_nilai_minus_item"] = $spec["harga"];
                $spec["persediaan_produk_item"] = -$spec["sub_harga"];
                $detailGate[$pid] = $spec;

                foreach ($tableIn["detail"] as $ikey => $ival) {
                    $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                }
            }
            //endregion
        }
        else {
            // region multi produk
            $itemID_blacklist = array("50648");
            $selected_jenis = array(
//                "759",
                "1119",
            );

            // tabel hpp avg > jual
            $pid_avg = array();
            $p_avg = $this->db->get("fifo_avg_sementara")->result();
            foreach ($p_avg as $pSpec) {
                $pid_avg[$pSpec->produk_id] = $pSpec->produk_id;
            }


            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek_avg_fifo = $this->db->get("fifo_avg")->result();
            $p_rek_avg_fifo_hpp = array();
            foreach ($p_rek_avg_fifo as $pSpec) {
                $p_rek_avg_fifo_hpp[$pSpec->produk_id] = $pSpec->hpp;
            }
//arrPrint($p_rek_avg_fifo_hpp);

            // tabel rek pembantu produk
            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
                "jenis" => "759",
//                "jenis" => "1119",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek = $this->db->get("__rek_pembantu_produk__1010030")->result();
            showLast_query("biru");
            $p_rek_salah = array();
            foreach ($p_rek as $pSpec) {
                $p_rek_salah[$pSpec->produk_id]["produk_id"] = $pSpec->produk_id;
                $p_rek_salah[$pSpec->produk_id]["produk_nama"] = $pSpec->produk_nama;
                $p_rek_salah[$pSpec->produk_id]["hpp_avg"] = $pSpec->harga;


                if (!isset($p_rek_salah[$pSpec->produk_id]["qty"])) {
                    $p_rek_salah[$pSpec->produk_id]["qty"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_kredit;
//                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_debet;


                if (!isset($p_rek_salah[$pSpec->produk_id]["nilai"])) {
                    $p_rek_salah[$pSpec->produk_id]["nilai"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->kredit;
//                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->debet;

            }
//            arrPrintPink($p_rek_salah);
            foreach ($p_rek_salah as $pid => $pSpec) {
                $nama = $pSpec["produk_nama"];
                if (!in_array($pSpec['produk_id'], $itemID_blacklist)) {
                    $jml = $pSpec["qty"];
//                    $nilai = $pSpec["nilai"];
//                    $hpp = $nilai/$jml;
//                    $hpp = $pSpec["hpp_avg"];
                    $hpp = $p_rek_avg_fifo_hpp[$pid];
                    $nilai = $pSpec["qty"] * $hpp;

                    $persediaan_produk += $nilai;
                    $harga_pokok += $nilai;
//                    $laba_lain_lain += $nilai;

                    $detailGate[$pid] = array(
                        //region detail/items
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $hpp,
                        "subtotal" => 33,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => "$nama",
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 3,
                        "stok" => 26750,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $jml,
                        "name" => "$nama",
                        "sub_harga" => $nilai,
                        "sub_subtotal" => $nilai,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $nilai,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                        //endregion

                        "produk_qty_item" => -$jml,
                        "produk_nilai_item" => $hpp,
                        "produk_nilai_minus_item" => $hpp,
                        "persediaan_produk_item" => -$nilai,
                    );
                    foreach ($detailGate as $pid => $spec) {
                        foreach ($mainGate as $key => $val) {
                            $spec[$key] = $val;
                        }
                        $detailGate[$pid] = $spec;
                        foreach ($tableIn["detail"] as $ikey => $ival) {
                            $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                        }
                    }
                }
            }
//            mati_disini(__LINE__);


            // endregion multi produk
        }


        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }


        $mainGate["hpp"] = -$harga_pokok;
        $mainGate["persediaan_produk"] = -$persediaan_produk;
        $mainGate["hutang_ke_pusat"] = $hutang_ke_pusat;
        $mainGate["piutang_cabang_minus_3"] = $piutang_cabang;
        $mainGate["laba_lain_lain"] = -$laba_lain_lain;
        $mainGate["hutang_dagang"] = $hutang_dagang;
        $mainGate["hutang_dagang_detail_1"] = $hutang_dagang_detail_1;
        $mainGate["hutang_dagang_detail_2"] = -$hutang_dagang_detail_2;
        $mainGate["modal"] = -$modal;
        $mainGate["ppn_masukan"] = $ppn_masukan;
        $mainGate["kas"] = $kas;
        $mainGate["kas_minus"] = -$kas_minus;
        $mainGate["hutang_ke_konsumen"] = -$hutang_ke_konsumen;
        $mainGate["hutang_ke_konsumen_noppn"] = $hutang_ke_konsumen_noppn;

        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;

        //--------------------------
        $preProcessor = array(
            "master" => array(),
            "detail" => array(
                array(
                    "comName" => "FifoAverage",
                    "loop" => array(),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "produk_qty" => "qty_kredit",
                        "gudang_id" => "gudangID",
                        "toko_id" => "tokoID",
                        "toko_nama" => "tokoName",
                    ),
                    "resultParams" => array(
//                        "items" => array(
//                            "kredit_rsltItems" => "hpp",
//                        ),
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );
        $components = array(
            "master" => array(
                // JURNAL 1
                array(
                    "comName" => "Jurnal",
                    "loop" => array(
                        "7010150" => "laba_lain_lain", // laba_lain_lain
                        "2010010" => "hutang_dagang", // hutang dagang
                        "1010030030" => "persediaan_produk",
                        "3010020" => "modal", // hutang dagang
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "5010" => "hpp", // hpp
//                        "1010040050" => "ppn_masukan", // ppn masukan

                        //-------------------
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "1010010010" => "kas_minus", // hutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "place2ID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                array(
                    "comName" => "Rekening",
                    "loop" => array(
                        "7010150" => "laba_lain_lain", // laba_lain_lain
                        "2010010" => "hutang_dagang", // hutang dagang
                        "1010030030" => "persediaan_produk",
                        "3010020" => "modal", // hutang dagang
//                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "5010" => "hpp", // hpp
//                        "1010040050" => "ppn_masukan", // ppn masukan

                        //-------------------
//                        "1010060010" => "piutang_cabang_minus_3", // piutang cabang dagang
//                        "1010010010" => "kas_minus", // kas
                    ),
                    "static" => array(
                        "cabang_id" => "place2ID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

//                //pembantu antarcabang (pusat)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "1010060010" => "piutang_cabang_minus_3",
//                    ),
//                    "static" => array(
//                        "cabang_id" => ".-1",
//                        "cabang2_id" => "cabang2ID",
//                        "cabang2_nama" => "cabang2Name",
//                        "extern_id" => "cabangID",
//                        "extern_nama" => "cabangName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu hutang ke supplier (pusat)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu antarcabang (caabng)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "2040010" => "hutang_ke_pusat",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "cabang2_id" => "placeID",
//                        "cabang2_nama" => "placeName",
//                        "extern_id" => "cabang2ID",
//                        "extern_nama" => "cabang2Name",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                // hutang ke konsumen, penjualan tunai
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050010",// uang muka konsumen
//                        "extern_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                // hutang ke konsumen, penjualan tunai, per-konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050010",// uang muka konsumen
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


                // JURNAL 2
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan plus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_j_2",
//                        "hpp" => "persediaan_j_2",
//                        "produk_nilai" => "persediaan_j_2",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan minus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_minus_item", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_produk_minus_item",
//                        "hpp" => "persediaan_produk_minus_item",
//                        "produk_nilai" => "persediaan_produk_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail laba lain-lain
//                array(
//                    "comName" => "RekeningPembantuLRLainlain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".7010150",
//                        "extern_nama" => ".laba lain lain",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail kerugian
//                array(
//                    "comName" => "RekeningPembantuKerugian",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".702020",
//                        "extern_nama" => ".kerugian stok opname",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw laba lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7010150",//lokal ,non lokal
//                        "extern_nama" => ".laba lain lain",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jml" => ".0",
//                        "harga" => "laba_lain_lain",
//                        "hpp" => "laba_lain_lain",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw rugi lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7020020",//lokal ,non lokal
//                        "extern_nama" => ".kerugian stok opname",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7020020",
//                        "produk_nama" => ".kerugian stok opname",
//                        "jml" => ".0",
//                        "harga" => "kerugian_minus_minus_item",
//                        "hpp" => "kerugian_minus_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //rekening pembantu hpp harga pokok produk
//                array(
//                    "comName" => "RekeningPembantuHpp",
//                    "loop" => array(
//                        "5010" => "hpp", // hpp
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".5010010",//
//                        "extern_nama" => ".lokal",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "harga" => "hpp",
//                        "hpp" => "hpp",
//                        "produk_nilai" => "hpp",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang dagang
//                array(
//                    "comName" => "RekeningPembantHutangUsaha",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "extern_nama" => ".hutang usaha",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "produk_nama" => ".hutang dagang",
//                        "jml" => ".1",
//                        "harga" => "hutang_dagang",
//                        "produk_nilai" => "hutang_dagang",
//                        "hpp" => "hutang_dagang",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "0leh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang ke supplier
                array(
                    "comName" => "RekeningPembantuSupplier",
                    "loop" => array(
                        "2010010" => "hutang_dagang", // hutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "1010040050" => "ppn_masukan", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_1", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_2", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplier2ID",
//                        "extern_nama" => "supplier2Nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

            ),
            "detail" => array(
                // pembantu produk minus
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_minus_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudang2ID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
////                        "pihak_id" => "pihakID",
////                        "pihak_nama" => "pihakName",
////                        "oleh_id" => "olehID",
////                        "oleh_nama" => "olehNama",
////                        "oleh_top_id" => "sellerID",
////                        "oleh_top_nama" => "sellerName",
////                        "satuan_id" => "satuan_id",
////                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // pembantu produk tambah
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".1010030030",
//                        "extern_nama" => ".persediaan produk",
//                        "produk_id" => "id",
//                        "produk_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

            ),
        );
        $postProcessor = array(
            "master" => array(
//                array(
//                    "comName" => "PaymentSrc",
//                    "loop" => array(),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "id",
//                        "extern_nama" => "name",
//                        "label" => ".hutang dagang",
//                        "target_jenis" => "jenisTr",
//                        "transaksi_id" => "refID",
//                        "terbayar" => "nilai_bayar",
//                        "sisa" => "new_sisa",
//                        "tabel_id" => "tabel_id",
//                    ),
//                    "reversable" => true,
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
            ),
            "detail" => array(
//                array(
//                    "comName" => "FifoAverage",
//                    "loop" => array(),
//                    "static" => array(
//                        "jenis" => ".produk",
//                        "jml" => "qty_debet",
//                        "produk_id" => "id",
//                        "hpp" => "hpp",
//                        "jml_nilai" => "sub_debet",
//                        "nama" => "name",
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                    array(
//                        "comName" => "LockerStock",
//                        "loop" => array(),
//                        "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
//                            "cabang_id" => "placeID",
//                            "jenis" => ".produk",
//                            "state" => ".active",
//                            "jumlah" => "qty_debet",
//                            "produk_id" => "id",
//                            "nama" => "name",
//                            "satuan" => "satuan",
//                            "transaksi_id" => ".0",
//                            "oleh_id" => ".0",
//                            "gudang_id" => "gudangID",
//                        ),
//                        "srcGateName" => "items",
//                        "srcRawGateName" => "items",
//                    ),

//                array(
//                    "comName" => "LockerStock",
//                    "loop" => array(),
//                    "static" => array(
////                            "toko_id" => "tokoID",
////                            "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => ".produk",
//                        "state" => ".active",
//                        "jumlah" => "-qty",
//                        "produk_id" => "id",
//                        "nama" => "name",
//                        "satuan" => "satuan",
//                        "transaksi_id" => ".0",
//                        "oleh_id" => ".0",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

            ),
        );
        //--------------------------


        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }

//        mati_disini(__LINE__);

        // PRE-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            // PRE-PROCC (karena mengeluarkan stok)
            //region pre-processors (item)
            $iterator = $preProcessor["detail"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                cekHere("ITEM NUM LABELS");
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        cekHere("sub-preproc: $comName, initializing values <br>");
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                cekHere("sub preproc #: $comName, sending values " . __LINE__ . "<br>");

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);

                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();
                                    // arrPrintWebs($gotParams);
                                    // matiHEre(__LINE__);
                                    // cekmerah("gotparams dari pre-proc $comName");
                                    // arrPrint($gotParams);
                                    // matiHEre();
                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            // arrPrint($paramSpec);
                                            // cekHitam($gateName);
                                            // cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($this->cCodeData[$cCode][$gateName])) {
                                                $this->cCodeData[$cCode][$gateName] = array();
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }
                                            // matiHEre($cCode);
                                            foreach ($paramSpec as $id => $gSpec) {
                                                if (!isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    $this->cCodeData[$cCode][$gateName][$id] = array();
                                                }
                                                if (isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        // matiHEre("ada");
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val " . __LINE__);
                                                            $this->cCodeData[$cCode][$gateName][$id][$key] = $val;
                                                            cekMerah($cCode . "[" . $gateName . "][" . $id . "][" . $key . "]=" . $val);
                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                if (isset($this->cCodeData[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {

                                                        foreach ($gSpec as $key => $val) {
                                                            $this->cCodeData[$cCode][$srcGateName][$id][$key] = $val;

                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                if (sizeof($itemNumLabels) > 0) {
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        if (isset($this->cCodeData[$cCode][$gateName][$id][$key])) {
                                                            $this->cCodeData[$cCode][$gateName][$id]['sub_' . $key] = ($this->cCodeData[$cCode][$gateName][$id]['jml'] * $this->cCodeData[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }
                                // matiHEre(__LINE__);
                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                // arrprintWebs($this->cCodeData[$cCode]);

                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $this->cCodeData[$cCode]["revert"]["preProc"]["replacer"];
                    $tempCalculate = array(
                        "selisih" => ($this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"]) - ($this->cCodeData[$cCode]["main"]["nett"] + $this->cCodeData[$cCode]["main"]["ppv"]),
                        "hpp_nppv" => $this->cCodeData[$cCode]["main"]["hpp"],
                        "hpp_nppn" => $this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"],
                    );
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $this->cCodeData[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }
                }
                //endregion
            }
            else {
                cekHitam("no sub-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //region pre-processors (master)
            $iterator = $preProcessor["master"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $this->cCodeData[$cCode]["main"], $this->cCodeData[$cCode]["main"], 0);
                                $subParams['static'][$key] = $realValue;
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = "";
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);

                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //==inject gotParams to child gate
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($this->cCodeData[$cCode]["main"][$key])) {
                                                $this->cCodeData[$cCode]["main"]['sub_' . $key] = ($this->cCodeData[$cCode]["main"]['jml'] * $this->cCodeData[$cCode]["main"][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
            }
            else {
                cekHitam("no main-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }

                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->configUiModul[$this->jenisTr]["steps"][$stepNum]["label"] . " nomor " . $tmpNomorNota . " oleh " . $this->cCodeData[$cCode]["tableIn_master"]['oleh_nama'];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }

        // POST-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            //region processing sub-post-processors, always
            $iterator = $postProcessor["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>");
                    $tmpOutParams[$cCtr] = array();
                    if (isset($this->cCodeData[$cCode][$srcGateName]) && (sizeof($this->cCodeData[$cCode][$srcGateName]) > 0)) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($this->cCodeData[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $this->cCodeData[$cCode]["main"]['pihakExternID'];
                                }
                                $subParams['static']["keterangan"] = "";
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($this->cCodeData[$cCode][$srcGateName])) {
                        cekHere("[$cCtr] sub-postProcessor: $comName, sending values " . __LINE__ . "<br>");
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekHitam($this->db->last_query());
                    }
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP SUB-POSTPROC");
            }
            //endregion

            //region processing main-post-processors, always
            $iterator = $postProcessor["master"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("post-processor: $comName<br>LINE: " . __LINE__);

                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }
                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = "";
                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP MAIN-POSTPROC");
            }
            //endregion
        }

        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (isset($core['components']) && sizeof($core['components'])) {
                $jurnalIndex = $core['components'];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //------------
            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
            }
            else {
                $coreBuilder = array();
            }
            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");

        }
        //endregion

//        mati_disini(__LINE__);

        $this->load->model("Coms/ComRekeningPembantuProduk");

        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            foreach ($arrprodukIDs as $pid => $pSpec) {
                $itemID = $pid;
                $crd = New ComRekeningPembantuProduk();
                $crd->addFilter("gudang_id='$gudang2ID'");
                $crd->addFilter("cabang_id='$cabang2ID'");
                $crd->addFilter("extern_id='$itemID'");
                $crd->addFilter("periode='forever'");
                $crdTmp = $crd->lookupAll()->result();
                showLast_query("biru");
                cekBiru(count($crdTmp));
                if (sizeof($crdTmp) > 0) {
                    $qty = $crdTmp[0]->qty_debet;
                    $debet = $crdTmp[0]->debet;
                    $avg = ($qty > 0) ? $debet / $qty : 0;

                    $this->load->model("Mdls/MdlFifoAverage");
                    $ff = New MdlFifoAverage();
                    $ff->addFilter("jenis='produk'");
                    $ff->addFilter("produk_id='$itemID'");
                    $ff->addFilter("cabang_id='$cabangID'");
                    $ff->addFilter("gudang_id='$gudangID'");
                    $ffTmp = $ff->lookupAll()->result();
                    showLast_query("biru");
                    if (sizeof($ffTmp) > 0) {
                        $id_tbl = $ffTmp[0]->id;
                        $where = array(
                            "id" => $id_tbl
                        );
                        $data = array(
                            "jml" => $qty,
                            "hpp" => $avg,
                            "jml_nilai" => $debet,
                        );
                        $ff->updateData($where, $data);
                        showLast_query("orange");
                    }

                }

            }
        }


        cekMerah(":: cek validate lajur di " . __FUNCTION__ . ", " . __FILE__);
        validateAllBalances($cabangID);


        mati_disini("---SETOP--- " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");
    }

    public function koreksiPaymentSource()
    {
        $this->load->model("MdlTransaksi");

        // ambil saldo hutang dagang per-supplier
        $target_jenis_hd = "4464";
        $max_id = "2959";
        $pymsrc = New MdlTransaksi();
        $pymsrc->setFilters(array());
        $pymsrc->addFilter("id<='$max_id'");
        $pymTmpHd = $pymsrc->lookupPaymentSrcByJenis($target_jenis_hd)->result();
        showLast_query("biru");
//        cekHere(sizeof($pymTmpHd));


        $this->db->trans_start();

        if (sizeof($pymTmpHd) > 0) {
            foreach ($pymTmpHd as $pymSpec) {
//                arrPrintPink($pymSpec);
                $tagihan = $pymSpec->tagihan;
                $dpp = $tagihan / 1.11;
                $ppn = $dpp * 0.11;

                $where = array(
                    "id" => $pymSpec->id,
                );
                $data = array(
                    "ppn" => $ppn,
                    "dpp_ppn" => $dpp,
                );
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->updatePaymentSrc($where, $data);
                cekHere("tagihan: $tagihan");
                showLast_query("orange");

//                break;
            }
        }


        mati_disini(__LINE__ . " STOOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");

    }

    public function koreksiRaw()
    {

        $starttime = microtime(true);

        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuRaw");

//        $tbl = "__raw_rek_pembantu__4010";
        $tbl = "__raw_rek_pembantu__2010010";
        $arrjenis = array("467", "1467");

        $this->db->trans_start();

        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            $cr = New ComRekeningPembantuRaw();
            $cr->setTableName($tbl);
            $crTmp = $cr->lookupAll()->result();
            foreach ($crTmp as $crSpec) {
                $tbl_id = $crSpec->id;
                $harga_dpp = $crSpec->harga;
                $sub_harga_dpp = $crSpec->sub_harga;
                $ppn = $harga_dpp * 0.11;
                $sub_ppn = $sub_harga_dpp * 0.11;

                $cr = New ComRekeningPembantuRaw();
                $cr->setTableName($tbl);
                $where = array(
                    "id" => $tbl_id,
                );
                $data = array(
                    "ppn_nilai" => $ppn,
                    "sub_ppn_nilai" => $sub_ppn,
                );
                $cr->setFilters(array());
                $cr->updateData($where, $data);
                showLast_query("orange");
            }
        }

        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $tr = New MdlTransaksi();
            $tr->addFilter("jenis in ('" . implode("','", $arrjenis) . "')");
            $trTmp = $tr->lookupAll()->result();
            foreach ($trTmp as $spec) {
                $trIDs[$spec->id] = $spec->id;
            }
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->setJointSelectFields("transaksi_id, main");
            $tr->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
            $trReg = $tr->lookupDataRegistries()->result();
//        showLast_query("biru");
            foreach ($trReg as $regSpec) {
                $tr_id = $regSpec->transaksi_id;
                $tr_main = blobDecode($regSpec->main);
                $tr_ref_data = $tr_main["description_main_followup"];
                $trRefIDs[$tr_id] = array(
                    "invoice_supplier" => $tr_ref_data,
                );

            }
            foreach ($trRefIDs as $tr_id => $data) {
                $cr = New ComRekeningPembantuRaw();
                $cr->setTableName($tbl);
                $where = array(
                    "transaksi_id" => $tr_id,
                );
                $cr->setFilters(array());
                $cr->updateData($where, $data);
                showLast_query("orange");
            }
        }

        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;

//        rusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");


    }

    public function patchPenjualanTunai()
    {

        $starttime = microtime(true);
        $this->load->model("MdlTransaksi");

        $jenisTr = "4464";
        $trIDs = array();
        $trRefIDs = array();
        $trRefIDs_data = array();

        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $tr->addFilter("jenis='$jenisTr");
        $trTmp = $tr->lookupAll()->result();
//        showLast_query("biru");
        foreach ($trTmp as $spec) {
            $trIDs[$spec->id] = $spec->id;
        }

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->setJointSelectFields("transaksi_id, main");
        $tr->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
        $trReg = $tr->lookupDataRegistries()->result();
//        showLast_query("biru");
        foreach ($trReg as $regSpec) {
            $tr_id = $regSpec->transaksi_id;
            $tr_main = blobDecode($regSpec->main);
//            cekHere("$tr_id, " . $tr_main["refID"]);
            $tr_ref_id = $tr_main["refID"];
            $trRefIDs[$tr_id] = $tr_ref_id;
//            break;
        }

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->setJointSelectFields("id, nomer");
        $tr->addFilter("id in ('" . implode("','", $trRefIDs) . "')");
        $trTmp = $tr->lookupAll()->result();
//        showLast_query("biru");
        foreach ($trTmp as $spec) {
            $trRefIDs_data[$spec->id] = array(
                "nomer" => $spec->nomer,
                "jenis" => $spec->jenis,
                "jenis_top" => $spec->jenis_top,
                "jenis_master" => $spec->jenis_master,
                "id_top" => $spec->id_top,
                "nomer_top" => $spec->nomer_top,
            );
        }

        //------------------------------------
        foreach ($trIDs as $trid) {
            $refid = $trRefIDs[$trid];
            $data = array(
                "reference_id" => $refid,
                "reference_nomer" => $trRefIDs_data[$refid]["nomer"],
                "reference_jenis" => $trRefIDs_data[$refid]["jenis"],
                "reference_jenis_top" => $trRefIDs_data[$refid]["jenis_top"],
                "reference_id_top" => $trRefIDs_data[$refid]["id_top"],
                "reference_nomer_top" => $trRefIDs_data[$refid]["nomer_top"],

            );
//            arrPrintWebs($data);
            $where = array(
                "id" => $trid,
            );
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->updateData($where, $data);
            showLast_query("orange");
//            break;
        }
        //------------------------------------

        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;

//        mati_disini(__LINE__ . " STOOP... [$val]");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");


    }

    //-------------------------------------------
    public function repairDataProduk()
    {
        $this->load->model("Mdls/MdlProduk");


        $this->db->trans_start();


        $p = New MdlProduk();
        $p->setFilters(array());
        $p->addFilter("jenis='item'");
        $pTmp = $p->lookupAll()->result();
        if (sizeof($pTmp) > 0) {
            foreach ($pTmp as $pSpec) {
                $id = $pSpec->id;
                $size_id = $pSpec->size_id;
                $size_nama = $pSpec->size_nama;
                $satuan_id = $pSpec->satuan_id;
                $satuan = $pSpec->satuan;


                $where = array(
                    "id" => $id,
                );
                $data = array(
                    "satuan_id" => $size_id,
                    "satuan" => $size_nama,
                );
                $p = New MdlProduk();
                $p->setFilters(array());
                $pu = $p->updateData($where, $data);
                showLast_query("orange");

            }
        }


        mati_disini(__LINE__ . " STOOP... [$val]");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");

    }

    public function repairRawKas()
    {
        $starttime = microtime(true);
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuRaw");
        $jenisTr = "464";
        $tbl = "__raw_rek_pembantu__1010010010";
        $trIDs = array();
        $trRefIDs = array();
        $trRefIDs_data = array();

        $this->db->trans_start();

        $tr = New MdlTransaksi();
//        $tr->addFilter("id='41181'");
        $tr->addFilter("jenis='$jenisTr");
        $trTmp = $tr->lookupAll()->result();
//        showLast_query("biru");
        foreach ($trTmp as $spec) {
            $trIDs[$spec->id] = $spec->id;
        }
        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->setJointSelectFields("transaksi_id, main");
        $tr->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
        $trReg = $tr->lookupDataRegistries()->result();
//        showLast_query("biru");
        foreach ($trReg as $regSpec) {
            $tr_id = $regSpec->transaksi_id;
            $tr_main = blobDecode($regSpec->main);
//            cekHere("$tr_id, " . $tr_main["refID"]);
            $tr_ref_id = $tr_main;
            $trRefIDs[$tr_id] = $tr_ref_id;
//            break;
        }

//        arrPrintPink($trRefIDs);
        foreach ($trRefIDs as $trID => $spec) {
            $data = array(
                "tagihan_include_ppn" => ($spec["harga"]) > 0 ? $spec["harga"] : 0,
                "ppn_nilai" => isset($spec["ppn_pengganti"]) ? $spec["ppn_pengganti"] : 0,
                "sub_ppn_nilai" => isset($spec["ppn_pengganti"]) ? $spec["ppn_pengganti"] : 0,
                "tagihan" => isset($spec["dpp_pengganti"]) ? $spec["dpp_pengganti"] : 0,
                "date_faktur" => isset($spec["dateFaktur"]) ? $spec["dateFaktur"] : 0,
                "nomor_faktur" => isset($spec["eFaktur"]) ? $spec["eFaktur"] : 0,
                "dibayar" => isset($spec["kas_nilai"]) ? $spec["kas_nilai"] : $spec["harga"],
            );
            $where = array(
                "transaksi_id" => $trID,
            );
            $cr = New ComRekeningPembantuRaw();
            $cr->setTableName($tbl);
            $where = array(
                "transaksi_id" => $trID,
            );
            $cr->setFilters(array());
            $cr->updateData($where, $data);
            showLast_query("orange");

        }


        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;
        mati_disini(__LINE__ . " STOOP... [$val]");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");

    }

    public function cekStokProduk()
    {
        $starttime = microtime(true);
        $this->load->helper("he_mass_table");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuProduk");
        $this->load->model("Mdls/MdlFifoAverage");


        $this->db->trans_start();

        $str = "";


        //-----------------------------
        $rekening = "1010030030";
        $crp = New ComRekeningPembantuProduk();
        $crpMts = $crp->fetchBalances($rekening);
        showLast_query("biru");
        $arrDetail = array();
        if (sizeof($crpMts) > 0) {
            foreach ($crpMts as $crSpec) {
                $qty = $crSpec->qty_debet;
                $nilai = $crSpec->debet;
                $nilai_avg = ($qty > 0) ? $nilai / $qty : 0;
                $arrDatas[$crSpec->cabang_id][$crSpec->gudang_id][$crSpec->extern_id] = array(
                    "jml" => $qty,
                    "hpp" => $nilai_avg,
                    "jml_nilai" => $nilai,
                );

            }
            foreach ($arrDatas as $cabang_id => $spec) {
                foreach ($spec as $gudang_id => $specc) {
                    foreach ($specc as $produk_id => $data) {
                        $ff = New MdlFifoAverage();
                        $ff->setFilters(array());
                        $where = array(
                            "jenis" => "produk",
                            "cabang_id" => $cabang_id,
                            "gudang_id" => $gudang_id,
                            "produk_id" => $produk_id,
                        );
                        $ff->updateData($where, $data);
                        showLast_query("orange");
                    }
                }
            }
        }

        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;
        mati_disini(__LINE__ . " STOOP... [$val]");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE... [$val]</h3>");

    }

    //-------------------------------------------
    public function generateHutangDagangProject()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComJurnal");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuSupplier");
        $rekening = "2010010";
        $rekening_2 = "1010040050";
        $jenis_target = "489";
        $jenis_pymsrc = "1467";
        $cabang_id = "-1";
        $dtime = date("Y-m-d H:i:s");

        //----------------------
        $cabangID = "1";
        $cabangNama = "cabang 1";
        $gudangID = "-10";
        $gudangNama = "default warehouse at branch #1";
        $cabang2ID = "-1";
        $cabang2Nama = "pusat dc";
        $gudang2ID = "-1";
        $gudang2Nama = "default warehouse at branch #-1";
        $olehID = "100";
        $olehNama = "system";
//        $pihakID = "473";
//        $pihakNama = "ISHWAR MANWANI";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
//        $cash_account = 1160;
//        $cash_account_nama = 8830713132;
//        $referenceID = 12287;
//        $referenceNomer = "5822so.1.473.2";
        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
            "description" => "adjustment hutang dagang pada ppn masukan karena perubahan metode jurnal ppn masukan saat pembayaran.",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );
        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }
        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
//            else {
//                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
//            }
//
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }

        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
//            if (isset($core['components']) && sizeof($core['components'])) {
//                $jurnalIndex = $core['components'];
//            }
//            else {
//                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
//                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
//                }
//                else {
//                    $jurnalIndex = array();
//                }
//            }
//            //------------
//            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
//                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
//            }
//            else {
//                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
//                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
//                }
//                else {
//                    $jurnalPostProc = array();
//                }
//            }
//            //------------
//            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
//                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
//            }
//            else {
//                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
//                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
//                }
//                else {
//                    $jurnalPreProc = array();
//                }
//            }
//            //------------
//            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
//                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
//            }
//            else {
//                $coreBuilder = array();
//            }
//            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");
        }
        //endregion

        //----------------------

        $this->db->trans_start();


        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            $cr = New ComRekening();
            $cr->addFilter("rekening=$rekening");
            $cr->addFilter("cabang_id=$cabang_id");
            $crTmp = $cr->fetchAllBalances();
            showLast_query("biru");
            if (sizeof($crTmp) > 0) {
                foreach ($crTmp as $spec) {
                    $saldo = $spec["kredit"];
                    $saldo_new = ($saldo / 1.11);
                    $selisih_ppn = $saldo - $saldo_new;
                    cekHere("[$saldo] [$saldo_new] [$selisih_ppn]");

                    $com = array(
                        "loop" => array(
                            "$rekening" => -$selisih_ppn,// hutang dagang
                            "$rekening_2" => -$selisih_ppn,// ppn masukan belum ada faktur
                        ),
                        "static" => array(
                            "cabang_id" => "$cabang_id",
                            "jenis" => "$jenis",
                            "transaksi_id" => "$insertID",
                            "transaksi_no" => "$insertNum",
                            "dtime" => $dtime,
                            "fulldate" => $dtime,
                        ),
                    );
                    // COMJURNAL dan COMREKENING
                    $cr = New ComJurnal();
                    $cr->pair($com);
                    $cr->exec();

                    $cr = New ComRekening();
                    $cr->pair($com);
                    $cr->exec();


                }

                $crp = New ComRekeningPembantuSupplier();
                $crp->addFilter("cabang_id=$cabang_id");
                $crpTmp = $crp->fetchBalances($rekening);
                showLast_query("biru");
                if (sizeof($crpTmp) > 0) {
                    foreach ($crpTmp as $iSpec) {
                        $extern_id = $iSpec->extern_id;
                        $extern_nama = $iSpec->extern_nama;
                        $saldo = $iSpec->kredit;
                        $saldo_new = ($saldo / 1.11);
                        $selisih_ppn = $saldo - $saldo_new;

                        // COM HUTANG DAGANG DETAIL
                        $comd = array(
                            "loop" => array(
                                "$rekening" => -$selisih_ppn,// hutang dagang
                            ),
                            "static" => array(
                                "extern_id" => "$extern_id",
                                "extern_nama" => "$extern_nama",
                                "cabang_id" => "$cabang_id",
                                "jenis" => "$jenis",
                                "transaksi_id" => "$insertID",
                                "transaksi_no" => "$insertNum",
                                "dtime" => $dtime,
                                "fulldate" => $dtime,
                            ),
                        );
                        $crp = New ComRekeningPembantuSupplier();
                        $crp->pair($comd);
                        $crp->exec();
                        // COM PPN MASUKAN DETAIL
                        $comdd = array(
                            "loop" => array(
                                "$rekening_2" => -$selisih_ppn,// ppn masukan belum ada faktur
                            ),
                            "static" => array(
                                "extern_id" => "$extern_id",
                                "extern_nama" => "$extern_nama",
                                "cabang_id" => "$cabang_id",
                                "jenis" => "$jenis",
                                "transaksi_id" => "$insertID",
                                "transaksi_no" => "$insertNum",
                                "dtime" => $dtime,
                                "fulldate" => $dtime,
                            ),
                        );
                        $crpd = New ComRekeningPembantuSupplier();
                        $crpd->pair($comdd);
                        $crpd->exec();
                    }
                }


                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("sisa>'0'");
                $pymsrc = $tr->lookupPaymentSrcByJenis($jenis_target)->result();
                showLast_query("biru");
                if (sizeof($pymsrc) > 0) {
                    foreach ($pymsrc as $pSpec) {
//                    arrPrintWebs($pSpec);
                        $sisa = $pSpec->sisa;
                        $sisa_new = ($sisa / 1.11);
                        $selisih_ppn = $sisa - $sisa_new;
                        $where = array(
                            "id" => $pSpec->id,
                        );
                        $data = array(
                            "dpp_ppn" => $sisa_new,
                            "sisa" => $sisa_new,
                            "dihapus" => $selisih_ppn,
                        );
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->updatePaymentSrc($where, $data);
                        showLast_query("orange");
                    }
                }
            }
        }
        else {
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("sisa>'100'");
            $tr->addFilter("jenis='$jenis_pymsrc'");
            $pymsrc = $tr->lookupPaymentSrcByJenis($jenis_target)->result();
            showLast_query("biru");
            $selisih_total = 0;
            $selisih_supplier = array();
            if (sizeof($pymsrc) > 0) {
                foreach ($pymsrc as $pSpec) {
//                    arrPrintWebs($pSpec);
                    $sisa = $pSpec->sisa;
                    $sisa_new = ($sisa / 1.11);
                    $selisih_ppn = $sisa - $sisa_new;
                    $where = array(
                        "id" => $pSpec->id,
                    );
                    $data = array(
                        "dpp_ppn" => $sisa_new,
                        "sisa" => $sisa_new,
                        "dihapus" => $selisih_ppn,
                    );
                    $tr = New MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->updatePaymentSrc($where, $data);
                    showLast_query("orange");

                    $selisih_total += $selisih_ppn;
                    $selisih_supplier[$pSpec->extern_id] = array(
                        "extern_id" => $pSpec->extern_id,
                        "extern_nama" => $pSpec->extern_nama,
                        "cabang_id" => $pSpec->cabang_id,
                        "cabang_nama" => $pSpec->cabang_nama,
                        "nilai" => $selisih_ppn,
                    );
                }

                $com = array(
                    "loop" => array(
                        "$rekening" => -$selisih_total,// hutang dagang
                        "$rekening_2" => -$selisih_total,// ppn masukan belum ada faktur
                    ),
                    "static" => array(
                        "cabang_id" => "$cabang_id",
                        "jenis" => "$jenis",
                        "transaksi_id" => "$insertID",
                        "transaksi_no" => "$insertNum",
                        "dtime" => $dtime,
                        "fulldate" => $dtime,
                    ),
                );
                // COMJURNAL dan COMREKENING
                $cr = New ComJurnal();
                $cr->pair($com);
                $cr->exec();
                // COMREKENING
                $cr = New ComRekening();
                $cr->pair($com);
                $cr->exec();

                if (sizeof($selisih_supplier) > 0) {
                    foreach ($selisih_supplier as $supplier_id => $spsecc) {
                        $selisih_ppn = $spsecc["nilai"];
                        $extern_id = $spsecc["extern_id"];
                        $extern_nama = $spsecc["extern_nama"];

                        // COM HUTANG DAGANG DETAIL
                        $comd = array(
                            "loop" => array(
                                "$rekening" => -$selisih_ppn,// hutang dagang
                            ),
                            "static" => array(
                                "extern_id" => "$extern_id",
                                "extern_nama" => "$extern_nama",
                                "cabang_id" => "$cabang_id",
                                "jenis" => "$jenis",
                                "transaksi_id" => "$insertID",
                                "transaksi_no" => "$insertNum",
                                "dtime" => $dtime,
                                "fulldate" => $dtime,
                            ),
                        );
                        $crp = New ComRekeningPembantuSupplier();
                        $crp->pair($comd);
                        $crp->exec();

                        // COM PPN MASUKAN DETAIL
                        $comdd = array(
                            "loop" => array(
                                "$rekening_2" => -$selisih_ppn,// ppn masukan belum ada faktur
                            ),
                            "static" => array(
                                "extern_id" => "$extern_id",
                                "extern_nama" => "$extern_nama",
                                "cabang_id" => "$cabang_id",
                                "jenis" => "$jenis",
                                "transaksi_id" => "$insertID",
                                "transaksi_no" => "$insertNum",
                                "dtime" => $dtime,
                                "fulldate" => $dtime,
                            ),
                        );
                        $crpd = New ComRekeningPembantuSupplier();
                        $crpd->pair($comdd);
                        $crpd->exec();

                    }
                }
            }
        }


        validateAllBalances($cabang_id);

        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>SELESAI...</h3>");

    }

    //-------------------------------------------
    public function cekStokLockerProduk()
    {
        $starttime = microtime(true);
        $this->load->helper("he_mass_table");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuProduk");
        $this->load->model("Mdls/MdlFifoAverage");
        $this->load->model("Mdls/MdlLockerStock");
        $cabang_id = "-1";
        $gudang_id = "-1";
        $this->db->trans_start();

        $str = "";

        //-----------------------------
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            $rekening = "1010030030";
            $crp = New ComRekeningPembantuProduk();
            $crpMts = $crp->fetchBalances($rekening);
            showLast_query("biru");
            $arrDetail = array();
            if (sizeof($crpMts) > 0) {
                foreach ($crpMts as $crSpec) {
                    $qty = $crSpec->qty_debet;
                    $nilai = $crSpec->debet;
                    $nilai_avg = ($qty > 0) ? $nilai / $qty : 0;
                    $arrDatas[$crSpec->cabang_id][$crSpec->gudang_id][$crSpec->extern_id] = array(
                        "jml" => $qty,
                        "hpp" => $nilai_avg,
                        "jml_nilai" => $nilai,
                    );

                }
                foreach ($arrDatas as $cabang_id => $spec) {
                    foreach ($spec as $gudang_id => $specc) {
                        foreach ($specc as $produk_id => $data) {
                            $ff = New MdlFifoAverage();
                            $ff->setFilters(array());
                            $where = array(
                                "jenis" => "produk",
                                "cabang_id" => $cabang_id,
                                "gudang_id" => $gudang_id,
                                "produk_id" => $produk_id,
                            );
                            $ff->updateData($where, $data);
                            showLast_query("orange");
                        }
                    }
                }
            }
        }

        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $jmlPerProduk = array();
            $cl = New MdlLockerStock();
            $cl->addFilter("gudang_id='$gudang_id'");
            $cl->addFilter("cabang_id='$cabang_id'");
            $cl->addFilter("state='hold'");
            $cl->addFilter("jumlah<'0'");
            $cl->addFilter("transaksi_id>'0'");
            $clTmp = $cl->lookupAll()->result();
            foreach ($clTmp as $spec) {
                $idtbl = $spec->id;
                $pid = $spec->produk_id;
                $jml = $spec->jumlah;
                if (!isset($jmlPerProduk[$pid])) {
                    $jmlPerProduk[$pid] = 0;
                }
                $jmlPerProduk[$pid] += $jml;


                $where = array(
                    "id" => $idtbl
                );
                $data = array(
                    "jumlah" => 0
                );
                $cl->setFilters(array());
                $cl->updateData($where, $data);
                showLast_query("orange");
            }
//            arrPrintPink($jmlPerProduk);

            $cl = New MdlLockerStock();
            $cl->addFilter("gudang_id='$gudang_id'");
            $cl->addFilter("cabang_id='$cabang_id'");
            $cl->addFilter("state='hold'");
            $cl->addFilter("jumlah>'0'");
            $cl->addFilter("transaksi_id='0'");
            $cl->addFilter("oleh_id='0'");
            $clTmp = $cl->lookupAll()->result();
            foreach ($clTmp as $spec) {
                $idtbl = $spec->id;
                $pid = $spec->produk_id;
                $jml = $spec->jumlah;
                $jml_hold_minus = isset($jmlPerProduk[$pid]) ? ($jmlPerProduk[$pid] * -1) : 0;
                $jml_new = $jml - $jml_hold_minus;
                $where = array(
                    "id" => $idtbl
                );
                $data = array(
                    "jumlah" => $jml_new
                );
                $cl->setFilters(array());
                $cl->updateData($where, $data);
                showLast_query("pink");
            }

        }


        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;
        mati_disini(__LINE__ . " STOOP... [$val]");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE... [$val]</h3>");

    }

    //-------------------------------------------
    public function generateHutangDagangByTrans()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComJurnal");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuSupplier");

        $trID = "48358";
        $tr = New MdlTransaksi();
        $tr->addFilter("id='$trID'");
        $trTmp = $tr->lookupAll()->result();
        if (sizeof($trTmp) > 0) {

            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $trID)) . ")");
            $tmpReg = $trr->lookupDataRegistries()->result();
//            cekKuning($this->db->last_query());
            $main = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    foreach ($row as $key_reg => $val_reg) {
                        switch ($key_reg) {
                            case "main"://
                                $main = $main + unserialize(base64_decode($val_reg));
                                break;
                        }
                    }
                }
            }
            arrPrintPink($main);
            $pihakID = $main["pihakID"];
            $pihakName = $main["pihakName"];
            $cabang_id = $main["placeID"];
            $jenisTr = $main["jenisTr"];
            $nomer = $trTmp[0]->nomer;
            $transaksi_id = $trTmp[0]->id;
            $dtime = $trTmp[0]->dtime;
            $fulldate = $trTmp[0]->fulldate;
            $netto = $main["nett"] - $main["ppn"];

            $component["master"] = array(
                array(
                    "comName" => "Jurnal",
                    "pair" => array(
                        "loop" => array(
                            "1010030040" => $netto,//persediaan produk riil
//                            "1010040050" => "0",//ppn in belum ada faktur
                            "2010010" => $netto,//hutang dagan
//                            "1010020030" => "0",//piutang pembelian
                        ),
                        "static" => array(
                            "cabang_id" => $cabang_id,
                            "jenis" => $jenisTr,
                            "transaksi_no" => $nomer,
                            "transaksi_id" => $transaksi_id,
                            "dtime" => $dtime,
                            "fulldate" => $fulldate,
                        ),
                    ),

                ),
                array(
                    "comName" => "Rekening",
                    "pair" => array(
                        "loop" => array(
                            "1010030040" => $netto,//persediaan produk riil
//                            "1010040050" => "0",//ppn in belum ada faktur
                            "2010010" => $netto,//hutang dagan
//                            "1010020030" => "0",//piutang pembelian
                        ),
                        "static" => array(
                            "cabang_id" => $cabang_id,
                            "jenis" => $jenisTr,
                            "transaksi_no" => $nomer,
                            "transaksi_id" => $transaksi_id,
                            "dtime" => $dtime,
                            "fulldate" => $fulldate,
                        ),
                    ),
                ),

                array(
                    "comName" => "Jurnal",
                    "pair" => array(
                        "loop" => array(
                            "1010030030" => "$netto",//persediaan produk
                            "1010030040" => "-$netto",//persediaan produk riil
                        ),
                        "static" => array(
                            "cabang_id" => $cabang_id,
                            "jenis" => $jenisTr,
                            "transaksi_no" => $nomer,
                            "transaksi_id" => $transaksi_id,
                            "dtime" => $dtime,
                            "fulldate" => $fulldate,
                        ),
                    ),
                ),
                array(
                    "comName" => "Rekening",
                    "pair" => array(
                        "loop" => array(
                            "1010030030" => "$netto",//persediaan produk
                            "1010030040" => "-$netto",//persediaan produk riil
                        ),
                        "static" => array(
                            "cabang_id" => $cabang_id,
                            "jenis" => $jenisTr,
                            "transaksi_no" => $nomer,
                            "transaksi_id" => $transaksi_id,
                            "dtime" => $dtime,
                            "fulldate" => $fulldate,
                        ),
                    ),
                ),

                // pembantu hutang dagang (supplier)
                array(
                    "comName" => "RekeningPembantuSupplier",
                    "pair" => array(
                        "loop" => array(
                            "2010010" => "$netto",//hutang dagang
                        ),
                        "static" => array(
                            "extern_id" => $pihakID,
                            "extern_nama" => $pihakName,
                            "cabang_id" => $cabang_id,
                            "jenis" => $jenisTr,
                            "transaksi_no" => $nomer,
                            "transaksi_id" => $transaksi_id,
                            "dtime" => $dtime,
                            "fulldate" => $fulldate,
                        ),
                    ),
                ),

            );
        }


        $this->db->trans_start();


        if (sizeof($component["master"]) > 0) {
            foreach ($component["master"] as $ii => $spec) {
//                arrPrintKuning($spec);
                $this->load->model("Coms/Com" . $spec["comName"]);
                $comName = "Com" . $spec["comName"];
                $com = New $comName();
                $com->pair($spec["pair"]);
                $com->exec();
            }
        }


        validateAllBalances($cabang_id);

        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>SELESAI...</h3>");

    }

    public function generateReferenceInvoice()
    {
        $this->load->model("MdlTransaksi");
        $jenis = "4822";

        $tr = New MdlTransaksi();
        $tr->addFilter("jenis='$jenis'");
//        $tr->addFilter("reference_id is null");
        $tr->addFilter("reference_jenis='5822so'");
//        $this->db->limit(200);
        $this->db->order_by("id", "asc");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        cekHere(count($trTmp));
        $trIDs = array();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $spec) {
                $trIDs[$spec->id] = $spec->id;
            }

            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
            $tmpReg = $trr->lookupDataRegistries()->result();
            $referenceData = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
//                    arrPrintWebs($row);
                    foreach ($row as $key_reg => $val_reg) {
                        switch ($key_reg) {
                            case "main"://
                                $main = blobDecode($val_reg);
                                $referenceData[$row->transaksi_id] = array(
                                    "reference_id" => $main["referenceID_current"],
                                    "reference_nomer" => $main["referenceNumber_current"],
                                );
                                break;
                        }
                    }
                }
            }

//            arrPrintPink($referenceData);
            $this->db->trans_start();

            if (sizeof($referenceData) > 0) {
                foreach ($referenceData as $id => $data) {

                    $trr = new MdlTransaksi();
                    $trr->setFilters(array());
                    $where = array(
                        "id" => $id
                    );
                    $trr->updateData($where, $data);
                    showLast_query("orange");
                }
            }


            mati_disini(__LINE__ . " SETOP...");
            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
            cekHijau("<h3>SELESAI...</h3>");

        }

    }


    public function patchRataProduk()
    {

        $this->load->model("Mdls/MdlFifoAverage");
        $this->load->model("Coms/ComRekeningPembantuProduk");

        $cabangID = "-1";
        $gudangID = "-1";
        $arrProdukStok = array();


        $crd = New ComRekeningPembantuProduk();
        $crd->addFilter("gudang_id='$gudangID'");
        $crd->addFilter("cabang_id='$cabangID'");
        $crd->addFilter("qty_debet>'0'");
        $crd->addFilter("periode='forever'");
        $crdTmp = $crd->lookupAll()->result();
        showLast_query("biru");
        if (sizeof($crdTmp) > 0) {
            foreach ($crdTmp as $spec) {
                $pid = $spec->extern_id;
                $qty_debet = $spec->qty_debet;
                $debet = $spec->debet;
                $hpp = ($qty_debet > 0) ? $debet / $qty_debet : 0;

                $arrProdukStok[$pid] = array(
                    "jml" => $qty_debet,
                    "hpp" => $hpp,
                    "jml_nilai" => $debet,
                );
            }
        }
        arrPrint($arrProdukStok);

        $this->db->trans_start();


        if (sizeof($arrProdukStok) > 0) {
            foreach ($arrProdukStok as $pid => $spec) {
                $qty = $spec["jml"];
                $avg = $spec["hpp"];
                $debet = $spec["jml_nilai"];

                $ff = New MdlFifoAverage();
                $ff->addFilter("jenis='produk'");
                $ff->addFilter("produk_id='$pid'");
                $ff->addFilter("cabang_id='$cabangID'");
                $ff->addFilter("gudang_id='$gudangID'");
                $ffTmp = $ff->lookupAll()->result();
                showLast_query("biru");
                if (sizeof($ffTmp) > 0) {
                    $id_tbl = $ffTmp[0]->id;
                    $where = array(
                        "id" => $id_tbl
                    );
                    $data = array(
                        "jml" => $qty,
                        "hpp" => $avg,
                        "jml_nilai" => $debet,
                    );
                    $ff->setFilters(array());
                    $ff->updateData($where, $data);
                    showLast_query("orange");
                }

            }
        }


//        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>SELESAI...</h3>");


    }

    //-------------------------------------------
    public function patchLockerDiskon()
    {

        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlLockerStockDiskonVendor");
        $this->load->model("Coms/ComLockerDiskonValue");
        $this->load->model("Coms/ComRekeningPembantuPiutangSupplierDetailTransItem");

        $cabangID = "-1";
        $gudangID = "-1";
        $arrDiskonID = array(1, 2, 3, 4, 5, 6, 8);
        $rekening = "1010020030";
        $rekDiskonData = array();
        $rekDiskonDataInsert = array();
        $trAllow = array("467");

        $crd = New ComRekeningPembantuPiutangSupplierDetailTransItem();
        $crd->addFilter("extern2_id in ('" . implode("','", $arrDiskonID) . "')");
        $crdTmp = $crd->fetchBalances($rekening);
        showLast_query("biru");
        cekHere(count($crdTmp));
        if (sizeof($crdTmp) > 0) {
            foreach ($crdTmp as $crdSpec) {
//                arrPrint($crdSpec);
                $rekDiskonData[$crdSpec->id] = array(
                    "supplier_id" => $crdSpec->extern3_id,
                    "supplier_nama" => $crdSpec->extern3_nama,
                    "jenis" => "diskon",
                    "jenis_locker" => "stock",
                    "cabang_id" => $crdSpec->cabang_id,
                    "gudang_id" => $gudangID,
                    "produk_id" => $crdSpec->extern2_id,
                    "nama" => $crdSpec->extern2_nama,
                    "state" => "active",
                    "jumlah" => "1",
                    "fulldate" => $crdSpec->fulldate,
                    "transaksi_id" => $crdSpec->extern_id,
                    "nomer" => $crdSpec->extern_nama,
                    "extern_id" => $crdSpec->extern2_id,
                    "extern_nama" => $crdSpec->extern2_nama,
                    "extern2_id" => "",
                    "extern2_nama" => "",
                    "nilai_unit" => $crdSpec->debet,
                    "nilai" => $crdSpec->debet,
                );
            }
        }
//        arrPrintPink($rekDiskonData);
        if (sizeof($rekDiskonData) > 0) {
            foreach ($rekDiskonData as $ii => $spec) {
                $where = array(
                    "supplier_id=" . $spec["supplier_id"],
                    "jenis='diskon'",
                    "cabang_id=" . $spec["cabang_id"],
                    "produk_id=" . $spec["produk_id"],
                    "extern_id=" . $spec["extern_id"],
                    "state='active'",
                    "transaksi_id=" . $spec["transaksi_id"],
                );
                $lds = New MdlLockerStockDiskonVendor();
                $lds->setFilters(array());
                foreach ($where as $wherexx) {
                    $lds->addFilter($wherexx);
                }
                $ldsTmp = $lds->lookupAll()->result();
//                showLast_query("biru");
                if (sizeof($ldsTmp) == 0) {
                    $rekDiskonDataInsert[$ii] = $spec;
                }
            }
        }
//        arrPrintWebs($rekDiskonDataInsert);
        cekHere(count($rekDiskonDataInsert));

        $this->db->trans_start();

        if (sizeof($rekDiskonDataInsert) > 0) {
            foreach ($rekDiskonDataInsert as $ii => $data) {
                $lds = New MdlLockerStockDiskonVendor();
                $lds->setFilters(array());
                $lds->addData($data);
                showLast_query("hijau");

            }
        }


        $lds = New MdlLockerStockDiskonVendor();
        $lds->setFilters(array());
        $lds->addFilter("produk_id in ('" . implode("','", $arrDiskonID) . "')");
        $ldsTmp = $lds->lookupAll()->result();
        if (sizeof($ldsTmp) > 0) {
            foreach ($ldsTmp as $ldsSpec) {
                $id_tbl = $ldsSpec->id;
                $tr_id = $ldsSpec->transaksi_id;
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id=$tr_id");
                $tr->addFilter("jenis in ('" . implode("','", $trAllow) . "')");
                $trTmp = $tr->lookupAll()->result();
//                showLast_query("biru");
//                cekHere(count($trTmp));
                if (sizeof($trTmp) == 0) {
                    $lds = New MdlLockerStockDiskonVendor();
                    $lds->setFilters(array());
                    $where = array(
                        "id" => $id_tbl,
                    );
                    $data = array(
                        "jumlah" => 0,
                        "nilai_unit" => 0,
                        "nilai" => 0,
                    );
                    $lds->updateData($where, $data);
                    showLast_query("orange");
                }
//                break;
            }
        }


        mati_disini(__LINE__ . " SETOP...");

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>SELESAI...</h3>");


    }

    //-------------------------------------------
    public function koreksiAdjustment()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlProduk2");


        // load transaksi opname, mengambil data yang akan dieksekusi
        $cabangID = "-1";
        $cabangNama = "PUSAT/DC";
        $gudangID = "-1";
        $gudangNama = "default warehouse at branch #-1";
//        $cabangID = "1";
//        $cabangNama = "CABANG 1";
//        $gudangID = "-10";
//        $gudangNama = "default warehouse at branch #1";

//        $cabang2ID = "-1";
//        $cabang2Nama = "pusat dc";
//        $gudang2ID = "-1";
//        $gudang2Nama = "default warehouse at branch #-1";

        $olehID = "100";
        $olehNama = "system";
//        $tokoID = "1001";
//        $tokoNama = "JODOMART";
        $supplierID = "211";
        $supplierNama = "SAHABAT BALI INDONESIA";
        $pihakID = "211";
        $pihakNama = "SAHABAT BALI INDONESIA";
        $jenis = "999";
        $this->jenisTr = $jenisTr = "999";
        $jenisTrMaster = "999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $cash_account = 0;
        $cash_account_nama = "";
        $referenceID = 0;
        $referenceNomer = "";
        $referenceJenis = "";
        $modul_transaksi = "adjustment";
        $tCodeTargetJenisTransaksi = $target_transaksi = $jenisTrMaster;


        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $arrDataDetail = array(
                "3143" => array(
                    "id" => "3143",
                    "nama" => "GREE CASEETTE 5PK GU140T/A-K",
                    "name" => "GREE CASEETTE 5PK GU140T/A-K",
                    "hpp" => "21687387",
                    "harga" => "21687387",
                    "jml" => "8",
                    "qty" => "8",
                    "reference_nomer" => "",
                    "keterangan_detail" => "",
                ),
                "24407" => array(
                    "id" => "24407",
                    "nama" => "GREE GWC-18N1/A",
                    "name" => "GREE GWC-18N1/A",
                    "hpp" => "5562208",
                    "harga" => "5562208",
                    "jml" => "4",
                    "qty" => "4",
                    "reference_nomer" => "",
                    "keterangan_detail" => "",
                ),
            );
        }
        else {
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("cabang_id='$cabangID'");
//            $tr->addFilter("target_jenis='483'");
            $tr->addFilter("label='hutang dagang'");
            $tr->addFilter("sisa>'0'");
            $trPym = $tr->lookupPaymentSrcByJenis('483')->result();
            showLast_query("biru");
            cekBiru(count($trPym));
            if (sizeof($trPym) > 0) {
                foreach ($trPym as $pymSpec) {
                    $arrDataDetail[$pymSpec->transaksi_id] = array(
                        "id_tbl" => $pymSpec->id,
                        "id" => $pymSpec->transaksi_id,
                        "nama" => $pymSpec->nomer,
                        "name" => $pymSpec->nomer,
                        "hpp" => $pymSpec->ppn_sisa,
                        "harga" => $pymSpec->ppn_sisa,
                        "sisa" => $pymSpec->sisa,
                        "jml" => "1",
                        "qty" => "1",
                        "reference_id" => $pymSpec->extern3_id,
                        "reference_nomer" => $pymSpec->extern3_nama,
                        "extern_id" => $pymSpec->extern_id,
                        "extern_nama" => $pymSpec->extern_nama,
                        "pihakID" => $pymSpec->extern_id,
                        "pihakName" => $pymSpec->extern_nama,
                        "pihakNama" => $pymSpec->extern_nama,
                        "keterangan_detail" => "transaksi pembelian service/jasa project, ganti metode PPN MASUKAN di belakang saat pembayaran.",
                    );
                }
            }
        }


//        mati_disini(__LINE__);

        $this->db->trans_start();


        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
            "description" => "",
            "keterangan" => "",

            "cash_account" => $cash_account,
            "cash_account_nama" => $cash_account_nama,
            "referenceID" => $referenceID,
            "referenceNomer" => $referenceNomer,
            "referenceJenis" => $referenceJenis,
            "reference_id" => $referenceID,
            "reference_nomer" => $referenceNomer,
            "reference_jenis" => $referenceJenis,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",
                "reference_id" => "referenceID",
                "reference_nomer" => "referenceNomer",
                "reference_jenis" => "referenceJenis",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );

        $harga_pokok = 0;
        $persediaan_produk = 0;
        $hutang_ke_pusat = 0;
        $piutang_cabang = 0;
        $laba_lain_lain = 0;
        $hutang_dagang = 0;

        $detailGate = array();
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            $total_nilai = 0;
            $arrProdukDatas = array();
            $arrprodukIDs = $arrDataDetail;
            $arrprodukIDKey = array_keys($arrprodukIDs);
            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                $pr = New MdlProduk2();
                $pr->addFilter("id in ('" . implode("','", $arrprodukIDKey) . "')");
                $prTmp = $pr->lookupAll()->result();
                showLast_query("biru");
                foreach ($prTmp as $prSpec) {
                    $arrProdukDatas[$prSpec->id] = $prSpec;
                }
                foreach ($arrProdukDatas as $pid => $specc) {
                    $pnama = $specc->nama;
                    $kode = $specc->kode;
                    $barcode = $specc->barcode;
                    $satuan = $specc->satuan;
                    $jml = $arrprodukIDs[$pid]["jml"];
                    $qty = $arrprodukIDs[$pid]["qty"];
                    $hpp = $arrprodukIDs[$pid]["hpp"];
                    $harga = $arrprodukIDs[$pid]["harga"];
                    $target_id = $arrprodukIDs[$pid]["target_id"];
//                $sub_hpp = $hpp * $jml;
//                $sub_harga = $harga * $jml;
                    $sub_hpp = $hpp * $jml;
                    $sub_harga = $harga * $jml;
                    $total_nilai += $sub_hpp;
                    $detailGate[$pid] = array(
                        "handler" => "opname/_processSelectProduct",
                        "target_id" => $target_id,
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $harga,
                        "subtotal" => 0,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => $pnama,
                        "kode" => $kode,
                        "barcode" => $barcode,
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $qty,
                        "name" => $pnama,
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                }
            }
            else {
                // kalau transaksi detailnya
                foreach ($arrprodukIDs as $pid => $specc) {
                    $sub_hpp = $specc["jml"] * $specc["hpp"];
                    $sub_harga = $specc["jml"] * $specc["harga"];
                    $total_nilai += $sub_harga;
                    $detailGate[$pid] = array(
                        "handler" => "",
                        "id" => $pid,
                        "jml" => $specc["jml"],
                        "harga" => $specc["harga"],
                        "subtotal" => 0,
                        "satuan" => "",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $specc["hpp"],
                        "nama" => $specc["nama"],
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 0,
                        "stok" => 0,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $specc["qty"],
                        "name" => $specc["name"],
                        "sub_harga" => $sub_harga,
                        "sub_subtotal" => $sub_harga,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $sub_hpp,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                    );
                    foreach ($specc as $dkey => $dval) {
                        $detailGate[$pid][$dkey] = $dval;
                    }
                }
            }

            //region 1 produk
            $mainHarga = 0;
            $harga_pokok = 0;
            $persediaan_produk = $total_nilai;
            $hutang_dagang = $total_nilai;
            $hutang_dagang_detail_1 = 0;
            $hutang_dagang_detail_2 = 0;
            $hutang_ke_pusat = 0;
            $piutang_cabang = 0;
            $piutang_dagang = 0;
            $laba_lain_lain = 0;
            $ppn_masukan = 0;
            $ppn_masukan_jasa = 0;
            $modal = 0;
            $kas = 0;
            $kas_minus = 0;
            $hutang_ke_konsumen = 0;
            $hutang_ke_konsumen_noppn = 0;
            $titipan_tanpa_relasi = 0;
            $titipan_dengan_relasi = 0;
            foreach ($detailGate as $pid => $spec) {
                foreach ($mainGate as $key => $val) {
                    $spec[$key] = $val;
                }

                $detailGate[$pid] = $spec;

                foreach ($tableIn["detail"] as $ikey => $ival) {
                    $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                }
            }
            //endregion
        }
        else {
            // region multi produk
            $itemID_blacklist = array("50648");
            $selected_jenis = array(
//                "759",
                "1119",
            );

            // tabel hpp avg > jual
            $pid_avg = array();
            $p_avg = $this->db->get("fifo_avg_sementara")->result();
            foreach ($p_avg as $pSpec) {
                $pid_avg[$pSpec->produk_id] = $pSpec->produk_id;
            }


            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek_avg_fifo = $this->db->get("fifo_avg")->result();
            $p_rek_avg_fifo_hpp = array();
            foreach ($p_rek_avg_fifo as $pSpec) {
                $p_rek_avg_fifo_hpp[$pSpec->produk_id] = $pSpec->hpp;
            }
//arrPrint($p_rek_avg_fifo_hpp);

            // tabel rek pembantu produk
            $arrwhere = array(
                "cabang_id" => "$cabangID",
                "toko_id" => "$tokoID",
                "gudang_id" => "$gudangID",
                "jenis" => "759",
//                "jenis" => "1119",
            );
            $this->db->where($arrwhere);
            $this->db->where_in("produk_id", $pid_avg);
            $p_rek = $this->db->get("__rek_pembantu_produk__1010030")->result();
            showLast_query("biru");
            $p_rek_salah = array();
            foreach ($p_rek as $pSpec) {
                $p_rek_salah[$pSpec->produk_id]["produk_id"] = $pSpec->produk_id;
                $p_rek_salah[$pSpec->produk_id]["produk_nama"] = $pSpec->produk_nama;
                $p_rek_salah[$pSpec->produk_id]["hpp_avg"] = $pSpec->harga;


                if (!isset($p_rek_salah[$pSpec->produk_id]["qty"])) {
                    $p_rek_salah[$pSpec->produk_id]["qty"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_kredit;
//                $p_rek_salah[$pSpec->produk_id]["qty"] += $pSpec->qty_debet;


                if (!isset($p_rek_salah[$pSpec->produk_id]["nilai"])) {
                    $p_rek_salah[$pSpec->produk_id]["nilai"] = 0;
                }
                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->kredit;
//                $p_rek_salah[$pSpec->produk_id]["nilai"] += $pSpec->debet;

            }
//            arrPrintPink($p_rek_salah);
            foreach ($p_rek_salah as $pid => $pSpec) {
                $nama = $pSpec["produk_nama"];
                if (!in_array($pSpec['produk_id'], $itemID_blacklist)) {
                    $jml = $pSpec["qty"];
//                    $nilai = $pSpec["nilai"];
//                    $hpp = $nilai/$jml;
//                    $hpp = $pSpec["hpp_avg"];
                    $hpp = $p_rek_avg_fifo_hpp[$pid];
                    $nilai = $pSpec["qty"] * $hpp;

                    $persediaan_produk += $nilai;
                    $harga_pokok += $nilai;
//                    $laba_lain_lain += $nilai;

                    $detailGate[$pid] = array(
                        //region detail/items
                        "handler" => "opname/_processSelectProduct",
                        "id" => $pid,
                        "jml" => $jml,
                        "harga" => $hpp,
                        "subtotal" => 33,
                        "satuan" => "gram",
                        "discount_persen" => 0,
                        "discount_qty" => 0,
                        "hpp" => $hpp,
                        "nama" => "$nama",
                        "kode" => "",
                        "barcode" => "",
                        "no_part" => 0,
                        "label" => "",
                        "ppn" => 3,
                        "stok" => 26750,
                        "debet" => 0,
                        "kredit" => 0,
                        "qty_selisih" => 0,
                        "qty" => $jml,
                        "name" => "$nama",
                        "sub_harga" => $nilai,
                        "sub_subtotal" => $nilai,
                        "sub_discount_persen" => 0,
                        "sub_discount_qty" => 0,
                        "sub_hpp" => $nilai,
                        "sub_no_part" => 0,
                        "sub_ppn" => 0,
                        "sub_stok" => 0,
                        "sub_debet" => 0,
                        "sub_kredit" => 0,
                        "sub_qty_selisih" => 0,

                        "next_substep_code" => $jenis,
                        "next_subgroup_code" => "o_holding",
                        "sub_step_number" => 1,
                        "sub_step_current" => 1,
                        //endregion

                        "produk_qty_item" => -$jml,
                        "produk_nilai_item" => $hpp,
                        "produk_nilai_minus_item" => $hpp,
                        "persediaan_produk_item" => -$nilai,
                    );
                    foreach ($detailGate as $pid => $spec) {
                        foreach ($mainGate as $key => $val) {
                            $spec[$key] = $val;
                        }
                        $detailGate[$pid] = $spec;
                        foreach ($tableIn["detail"] as $ikey => $ival) {
                            $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                        }
                    }
                }
            }
//            mati_disini(__LINE__);


            // endregion multi produk
        }


        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }


        $mainGate["hpp"] = -$harga_pokok;
        $mainGate["persediaan_produk"] = -$persediaan_produk;
        $mainGate["hutang_ke_pusat"] = $hutang_ke_pusat;
        $mainGate["piutang_cabang_minus_3"] = $piutang_cabang;
        $mainGate["piutang_dagang"] = -$piutang_dagang;
        $mainGate["laba_lain_lain"] = -$laba_lain_lain;
        $mainGate["hutang_dagang"] = -$hutang_dagang;
        $mainGate["hutang_dagang_detail_1"] = $hutang_dagang_detail_1;
        $mainGate["hutang_dagang_detail_2"] = -$hutang_dagang_detail_2;
        $mainGate["modal"] = -$modal;
        $mainGate["ppn_masukan"] = $ppn_masukan;
        $mainGate["ppn_masukan_jasa"] = -$ppn_masukan_jasa;
        $mainGate["kas"] = $kas;
        $mainGate["kas_minus"] = -$kas_minus;
        $mainGate["hutang_ke_konsumen"] = -$hutang_ke_konsumen;
        $mainGate["hutang_ke_konsumen_noppn"] = $hutang_ke_konsumen_noppn;
        $mainGate["hutang_ke_konsumen_noppn_minus"] = -$hutang_ke_konsumen_noppn;
        $mainGate["titipan_tanpa_relasi"] = $titipan_tanpa_relasi;
        $mainGate["titipan_dengan_relasi"] = -$titipan_dengan_relasi;

        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;

        //--------------------------
        $preProcessor = array(
            "master" => array(),
            "detail" => array(
                array(
                    "comName" => "FifoAverage",
                    "loop" => array(),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "produk_qty" => "qty_kredit",
                        "gudang_id" => "gudangID",
                        "toko_id" => "tokoID",
                        "toko_nama" => "tokoName",
                    ),
                    "resultParams" => array(
//                        "items" => array(
//                            "kredit_rsltItems" => "hpp",
//                        ),
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );
        $components = array(
            "master" => array(
                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk",
////                        "3010020" => "modal", // hutang dagang
////                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
////                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
////                        "5010" => "hpp", // hpp
////                        "1010040050" => "ppn_masukan", // ppn masukan
//                        //-------------------
////                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
////                        "1010010010" => "kas_minus", // hutang dagang
////                        "1010020010" => "piutang_dagang", // hutang dagang
////                        "7010150" => "laba_lain_lain", // laba_lain_lain
////                        "2010050" => "hutang_ke_konsumen_noppn_minus", // hutang_ke_konsumen_noppn
//                        "2010010" => "hutang_dagang", // hutang_dagang
//////                        "1010040070" => "ppn_masukan_jasa", // ppn masukan jasa
//////                        "1010050010" => "titipan_dengan_relasi",// uang muka dibayar tanpa ppn
//////                        "1010050040" => "titipan_tanpa_relasi",// uang muka dibayar tanpa ppn
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk",
////                        "3010020" => "modal", // hutang dagang
////                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
////                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
////                        "5010" => "hpp", // hpp
////                        "1010040050" => "ppn_masukan", // ppn masukan
//                        //-------------------
////                        "1010060010" => "piutang_cabang_minus_3", // hutang dagang
////                        "1010010010" => "kas_minus", // hutang dagang
////                        "1010020010" => "piutang_dagang", // hutang dagang
////                        "7010150" => "laba_lain_lain", // laba_lain_lain
////                        "2010050" => "hutang_ke_konsumen_noppn_minus", // hutang_ke_konsumen_noppn
//                        "2010010" => "hutang_dagang", // hutang_dagang
//////                        "1010040070" => "ppn_masukan_jasa", // ppn masukan jasa
//////                        "1010050010" => "titipan_dengan_relasi",// uang muka dibayar tanpa ppn
//////                        "1010050040" => "titipan_tanpa_relasi",// uang muka dibayar tanpa ppn
///
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu antarcabang (pusat)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "1010060010" => "piutang_cabang_minus_3",
//                    ),
//                    "static" => array(
//                        "cabang_id" => ".-1",
//                        "cabang2_id" => "cabang2ID",
//                        "cabang2_nama" => "cabang2Name",
//                        "extern_id" => "cabangID",
//                        "extern_nama" => "cabangName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu hutang ke supplier (pusat)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "place2ID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2040010" => "hutang_ke_pusat", // hutang ke pusat
//                        "1010010010" => "kas", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu antarcabang (caabng)
//                array(
//                    "comName" => "RekeningPembantuAntarcabang",
//                    "loop" => array(
//                        "2040010" => "hutang_ke_pusat",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "cabang2_id" => "placeID",
//                        "cabang2_nama" => "placeName",
//                        "extern_id" => "cabang2ID",
//                        "extern_nama" => "cabang2Name",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


//                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        //-------------------
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                        "1010010010" => "kas_minus", // hutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                //pembantu kas (cabang)
//                array(
//                    "comName" => "RekeningPembantuKas",
//                    "loop" => array(
//                        "1010010010" => "kas_minus", // kas
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "cash_account",
//                        "extern_nama" => "cash_account_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                // hutang ke konsumen, penjualan tunai
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050010",// uang muka konsumen
//                        "extern_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                // hutang ke konsumen, penjualan tunai, per-konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050010",// uang muka konsumen
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),


                // JURNAL 2
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_minus_item",
//                        "7020" => "kerugian_minus_minus_item",
//                        // "1010030010" => "persediaan_supplies_minus",
//                        "3020010" => "efisiensi_biaya_minus",
//                        "5020040" => "quality_minus",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan plus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_j_2",
//                        "hpp" => "persediaan_j_2",
//                        "produk_nilai" => "persediaan_j_2",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu persediaan minus
//                array(
//                    "comName" => "RekeningPembantuPersediaan",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_minus_item", // persediaan
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".1010030030",//produk
//                        "extern_nama" => ".persediaan produk",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".1010030030",
//                        "produk_nama" => ".persediaan produk",
//                        "jml" => ".1",
//                        "harga" => "persediaan_produk_minus_item",
//                        "hpp" => "persediaan_produk_minus_item",
//                        "produk_nilai" => "persediaan_produk_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail laba lain-lain
//                array(
//                    "comName" => "RekeningPembantuLRLainlain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".7010150",
//                        "extern_nama" => ".laba lain lain",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                // detail kerugian
//                array(
//                    "comName" => "RekeningPembantuKerugian",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        //                            "extern_id" => ".2",
//                        //                            "extern_nama" => ".opname produk",
//                        "extern_id" => ".702020",
//                        "extern_nama" => ".kerugian stok opname",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw laba lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7010" => "laba_lain_lain", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7010150",//lokal ,non lokal
//                        "extern_nama" => ".laba lain lain",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7010150",
//                        "produk_nama" => ".laba lain lain",
//                        "jml" => ".0",
//                        "harga" => "laba_lain_lain",
//                        "hpp" => "laba_lain_lain",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //raw rugi lain lain
//                array(
//                    "comName" => "RekeningPembantuRawMain",
//                    "loop" => array(
//                        "7020" => "kerugian_minus_minus_item", // hutang dagang
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".7020020",//lokal ,non lokal
//                        "extern_nama" => ".kerugian stok opname",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "extern3_id" => ".0",
//                        "extern3_nama" => ".0",
//                        "extern4_id" => ".0",
//                        "extern4_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".7020020",
//                        "produk_nama" => ".kerugian stok opname",
//                        "jml" => ".0",
//                        "harga" => "kerugian_minus_minus_item",
//                        "hpp" => "kerugian_minus_minus_item",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //rekening pembantu hpp harga pokok produk
//                array(
//                    "comName" => "RekeningPembantuHpp",
//                    "loop" => array(
//                        "5010" => "hpp", // hpp
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".5010010",//
//                        "extern_nama" => ".lokal",
//                        "extern2_id" => ".0",//lihat coa untuk urutannya
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "harga" => "hpp",
//                        "hpp" => "hpp",
//                        "produk_nilai" => "hpp",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang dagang
//                array(
//                    "comName" => "RekeningPembantHutangUsaha",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                        "extern_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "extern_nama" => ".hutang usaha",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => ".2010010010",//dibuat gerbang relative nantinya
//                        "produk_nama" => ".hutang dagang",
//                        "jml" => ".1",
//                        "harga" => "hutang_dagang",
//                        "produk_nilai" => "hutang_dagang",
//                        "hpp" => "hutang_dagang",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_top_id" => "sellerID",
//                        "0leh_top_nama" => "sellerName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang", // hutang biaya
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010010010",
//                        "extern_nama" => ".lokal",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "produk_id" => "pihakID",
//                        "produk_nama" => "pihakName",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu piutang dagang
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "1010020010" => "piutang_dagang", // piutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen_noppn_minus", // hutang_ke_konsumen_noppn
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050010",
//                        "extern_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen_noppn_minus", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050010",
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke konsumen
//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen_noppn_minus", // hutang_ke_konsumen_noppn
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".2010050050",
//                        "extern_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                array(
//                    "comName" => "RekeningPembantuCustomerDetail",
//                    "loop" => array(
//                        "2010050" => "hutang_ke_konsumen_noppn_minus", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".2010050050",
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                array(
//                    "comName" => "RekeningPembantuCustomer",
//                    "loop" => array(
//                        "1010020010" => "piutang_dagang",// piutang dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplierID",
//                        "extern_nama" => "supplierNama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu hutang ke supplier
//                array(
//                    "comName" => "RekeningPembantuSupplier",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_detail_2", // ppn masukan
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "supplier2ID",
//                        "extern_nama" => "supplier2Nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

//                array(
//                    "comName" => "RekeningPembantuUangMukaMain",
//                    "loop" => array(
//                        "1010050010" => "titipan_dengan_relasi",// uang muka dibayar tanpa ppn
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".0",
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "RekeningPembantuUangMukaMainReference",
//                    "loop" => array(
//                        "1010050010" => ".0",// uang muka dibayar tanpa ppn
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".0",//jika tidak punya relasi diisi 0 bebas dipakai oleh uang muka tanpa relasi/ sebaliknya jika terelasi supaya bebas dibuat transaksi un-relasi dulu
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //pembantu uang muka tanpa ppn tanpa  relasi PO supplier
//                array(
//                    "comName" => "RekeningPembantuUangMukaMain",
//                    "loop" => array(
//                        "1010050040" => "titipan_tanpa_relasi",// uang muka dibayar tanpa ppn non relasi PO
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".0",
//                        "extern2_nama" => ".0",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

                //rekening pembantu uang muka tanpa ppn persupplier tanpa relasi PO
//                array(
//                    "comName" => "RekeningPembantuUangMukaMainReference",
//                    "loop" => array(
//                        "1010050040" => "titipan_tanpa_relasi",// uang muka dibayar tanpa ppn
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "pihakID",
//                        "extern_nama" => "pihakName",
//                        "extern2_id" => ".0",//jika tidak punya relasi diisi 0 bebas dipakai oleh uang muka tanpa relasi/ sebaliknya jika terelasi supaya bebas dibuat transaksi un-relasi dulu
//                        "extern2_nama" => ".0",
//                        "extern3_id" => "option_nota",
//                        "extern3_nama" => "option_nota__nama",
//                        "extern4_nama" => "option_nota__jenis",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),

            ),
            "detail" => array(
                // pembantu produk minus

//                array(
//                    "comName" => "RekeningPembantuSupplierItem",
//                    "loop" => array(
//                        "2010010" => "hutang_dagang_item", // hutang_dagang
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "extern_id",
//                        "extern_nama" => "extern_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),
//                array(
//                    "comName" => "RekeningPembantuSupplierItem",
//                    "loop" => array(
//                        "1010040070" => "ppn_masukan_jasa_item", // ppn masukan jasa
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "extern_id",
//                        "extern_nama" => "extern_nama",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),


                // pembantu produk minus
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_minus_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // pembantu produk minus
                array(
                    "comName" => "RekeningPembantuProduk",
                    "loop" => array(
                        "1010030030" => "-sub_harga",
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "nama",
                        "produk_qty" => "-jml",
                        "produk_nilai" => "harga",
                        "harga" => "harga",
                        "gudang_id" => "gudangID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

                // pembantu produk tambah
//                array(
//                    "comName" => "RekeningPembantuProduk",
//                    "loop" => array(
//                        "1010030" => "persediaan_produk_item",
//                    ),
//                    "static" => array(
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "extern_id" => ".1010030030",
//                        "extern_nama" => ".persediaan produk",
//                        "produk_id" => "id",
//                        "produk_nama" => "nama",
//                        "produk_qty" => "produk_qty_item",
//                        "produk_nilai" => "produk_nilai_item",
//                        "harga" => "produk_nilai_minus_item",
//                        "gudang_id" => "gudangID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                        "pihak_id" => "pihakID",
//                        "pihak_nama" => "pihakName",
//                        "oleh_id" => "olehID",
//                        "oleh_nama" => "olehNama",
//                        "oleh_top_id" => "sellerID",
//                        "oleh_top_nama" => "sellerName",
//                        "satuan_id" => "satuan_id",
//                        "satuan_nama" => "satuan",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                array(
//                    "comName" => "RekeningPembantuCustomerDetailItem",
//                    "loop" => array(
//                        "2010050" => "sub_harga", // hutang ke konsumen
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "extern2_id" => ".2010050050",
//                        "extern2_nama" => ".Uang Muka Konsumen",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

            ),
        );
        $postProcessor = array(
            "master" => array(),
            "detail" => array(
//                array(
//                    "comName" => "FifoAverage",
//                    "loop" => array(),
//                    "static" => array(
//                        "jenis" => ".produk",
//                        "jml" => "qty_debet",
//                        "produk_id" => "id",
//                        "hpp" => "hpp",
//                        "jml_nilai" => "sub_debet",
//                        "nama" => "name",
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                    array(
//                        "comName" => "LockerStock",
//                        "loop" => array(),
//                        "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
//                            "cabang_id" => "placeID",
//                            "jenis" => ".produk",
//                            "state" => ".active",
//                            "jumlah" => "qty_debet",
//                            "produk_id" => "id",
//                            "nama" => "name",
//                            "satuan" => "satuan",
//                            "transaksi_id" => ".0",
//                            "oleh_id" => ".0",
//                            "gudang_id" => "gudangID",
//                        ),
//                        "srcGateName" => "items",
//                        "srcRawGateName" => "items",
//                    ),

//                array(
//                    "comName" => "LockerStock",
//                    "loop" => array(),
//                    "static" => array(
////                            "toko_id" => "tokoID",
////                            "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "jenis" => ".produk",
//                        "state" => ".active",
//                        "jumlah" => "-qty",
//                        "produk_id" => "id",
//                        "nama" => "name",
//                        "satuan" => "satuan",
//                        "transaksi_id" => ".0",
//                        "oleh_id" => ".0",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

                // payment source uang muka tanpa ppn (lebih bayar)
//                array(
//                    "comName" => "PaymentUangMukaItem",
//                    "loop" => array(),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "cabang_nama" => "placeName",
//                        "transaksi_id" => "uangMuka__transaksi_id",
//                        "jenis" => "uangMuka__jenis",
//                        "extern_id" => "id",
//                        "extern_nama" => "nama",
//                        "label" => ".uang muka konsumen",
//                        "tambah" => "harga",
//                        "extern_label2" => ".customer",//ini update untuk pembeda vemdor/ customer
//                    ),
//                    "reversable" => true,
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),
            ),
        );
        //--------------------------


        // MEMBUAT TRANSAKSI
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "523786";
            $insertNum = "999.-1.56";
        }

//        mati_disini(__LINE__);

        // PRE-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            // PRE-PROCC (karena mengeluarkan stok)
            //region pre-processors (item)
            $iterator = $preProcessor["detail"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                cekHere("ITEM NUM LABELS");
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        cekHere("sub-preproc: $comName, initializing values <br>");
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                cekHere("sub preproc #: $comName, sending values " . __LINE__ . "<br>");

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);

                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();
                                    // arrPrintWebs($gotParams);
                                    // matiHEre(__LINE__);
                                    // cekmerah("gotparams dari pre-proc $comName");
                                    // arrPrint($gotParams);
                                    // matiHEre();
                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            // arrPrint($paramSpec);
                                            // cekHitam($gateName);
                                            // cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($this->cCodeData[$cCode][$gateName])) {
                                                $this->cCodeData[$cCode][$gateName] = array();
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }
                                            // matiHEre($cCode);
                                            foreach ($paramSpec as $id => $gSpec) {
                                                if (!isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    $this->cCodeData[$cCode][$gateName][$id] = array();
                                                }
                                                if (isset($this->cCodeData[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        // matiHEre("ada");
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val " . __LINE__);
                                                            $this->cCodeData[$cCode][$gateName][$id][$key] = $val;
                                                            cekMerah($cCode . "[" . $gateName . "][" . $id . "][" . $key . "]=" . $val);
                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                if (isset($this->cCodeData[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {

                                                        foreach ($gSpec as $key => $val) {
                                                            $this->cCodeData[$cCode][$srcGateName][$id][$key] = $val;

                                                        }
                                                    }
                                                    else {
                                                        cekMerah("bukan array");
                                                        matiHere();
                                                    }
                                                }
                                                if (sizeof($itemNumLabels) > 0) {
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        if (isset($this->cCodeData[$cCode][$gateName][$id][$key])) {
                                                            $this->cCodeData[$cCode][$gateName][$id]['sub_' . $key] = ($this->cCodeData[$cCode][$gateName][$id]['jml'] * $this->cCodeData[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }
                                // matiHEre(__LINE__);
                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                // arrprintWebs($this->cCodeData[$cCode]);

                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $this->cCodeData[$cCode]["revert"]["preProc"]["replacer"];
                    $tempCalculate = array(
                        "selisih" => ($this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"]) - ($this->cCodeData[$cCode]["main"]["nett"] + $this->cCodeData[$cCode]["main"]["ppv"]),
                        "hpp_nppv" => $this->cCodeData[$cCode]["main"]["hpp"],
                        "hpp_nppn" => $this->cCodeData[$cCode]["main"]["hpp"] + $this->cCodeData[$cCode]["main"]["ppn"],
                    );
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $this->cCodeData[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }
                }
                //endregion
            }
            else {
                cekHitam("no sub-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //region pre-processors (master)
            $iterator = $preProcessor["master"];
            if (sizeof($iterator) > 0) {
//            $itemNumLabels = isset($this->configUiModul[$this->jenisTr]['shoppingCartNumFields']) ? $this->configUiModul[$this->jenisTr]['shoppingCartNumFields'] : array();
                $itemNumLabels = array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $this->cCodeData[$cCode]["main"], $this->cCodeData[$cCode]["main"], 0);
                                $subParams['static'][$key] = $realValue;
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = "";
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);

                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //==inject gotParams to child gate
                                    if (isset($this->cCodeData[$cCode]["main"])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $this->cCodeData[$cCode]["main"][$key] = $val;
                                            }
                                        }
                                    }

                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($this->cCodeData[$cCode]["main"][$key])) {
                                                $this->cCodeData[$cCode]["main"]['sub_' . $key] = ($this->cCodeData[$cCode]["main"]['jml'] * $this->cCodeData[$cCode]["main"][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
//                fillValues_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr]);
                $this->cCodeData[$cCode] = fillValuesSessionData_he_value_builder($this->jenisTr, $this->stepNum, $this->stepNum, $this->configCoreModul[$this->jenisTr], $this->configUiModul[$this->jenisTr], $this->configValuesModul[$this->jenisTr], $this->cCodeData[$cCode]["main"]["ppnFactor"], $this->cCodeData[$cCode]);
            }
            else {
                cekHitam("no main-pre-processor defined. skipping preprocessor..<br>");
            }
            //endregion
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$srcGateName] [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }
//arrPrintKuning($subParams);
                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }
//arrPrintKuning($tmpOutParams);
                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }


        // POST-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            //region processing sub-post-processors, always
            $iterator = $postProcessor["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>");
                    $tmpOutParams[$cCtr] = array();
                    if (isset($this->cCodeData[$cCode][$srcGateName]) && (sizeof($this->cCodeData[$cCode][$srcGateName]) > 0)) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($this->cCodeData[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $this->cCodeData[$cCode]["main"]['pihakExternID'];
                                }
                                $subParams['static']["keterangan"] = "";
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($this->cCodeData[$cCode][$srcGateName])) {
                        cekHere("[$cCtr] sub-postProcessor: $comName, sending values " . __LINE__ . "<br>");
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekHitam($this->db->last_query());
                    }
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP SUB-POSTPROC");
            }
            //endregion

            //region processing main-post-processors, always
            $iterator = $postProcessor["master"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("post-processor: $comName<br>LINE: " . __LINE__);

                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }
                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = "";
                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP MAIN-POSTPROC");
            }
            //endregion
        }


        //region MENULIS KE REGISTRY
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            if (isset($core['components']) && sizeof($core['components'])) {
                $jurnalIndex = $core['components'];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //------------
            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
            }
            else {
                $coreBuilder = array();
            }
            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");

        }
        //endregion


        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            $this->load->model("Coms/ComRekeningPembantuProduk");
            $this->load->model("Coms/ComProdukSerialNumber");
            foreach ($arrprodukIDs as $pid => $pSpec) {
                $itemID = $pid;
                $crd = New ComRekeningPembantuProduk();
                $crd->addFilter("gudang_id='$gudangID'");
                $crd->addFilter("cabang_id='$cabangID'");
                $crd->addFilter("extern_id='$itemID'");
                $crd->addFilter("periode='forever'");
                $crdTmp = $crd->lookupAll()->result();
                showLast_query("biru");
                cekBiru(count($crdTmp));
                if (sizeof($crdTmp) > 0) {
                    $qty = $crdTmp[0]->qty_debet;
                    $debet = $crdTmp[0]->debet;
                    $avg = ($qty > 0) ? $debet / $qty : 0;

                    $this->load->model("Mdls/MdlFifoAverage");
                    $ff = New MdlFifoAverage();
                    $ff->addFilter("jenis='produk'");
                    $ff->addFilter("produk_id='$itemID'");
                    $ff->addFilter("cabang_id='$cabangID'");
                    $ff->addFilter("gudang_id='$gudangID'");
                    $ffTmp = $ff->lookupAll()->result();
                    showLast_query("biru");
                    if (sizeof($ffTmp) > 0) {
                        $id_tbl = $ffTmp[0]->id;
                        $where = array(
                            "id" => $id_tbl
                        );
                        $data = array(
                            "jml" => $qty,
                            "hpp" => $avg,
                            "jml_nilai" => $debet,
                        );
                        $ff->updateData($where, $data);
                        showLast_query("orange");
                    }

                }

                if (isset($detailGate[$pid])) {
                    $jml = $detailGate[$pid]["jml"];
                    cekHere("[jml: $jml]");
//                arrPrintKuning($detailGate[$pid]);
                    for ($ii = 1; $ii <= $jml; $ii++) {
                        $anu[0] = array(
                            "loop" => array(),
                            "static" => array(
                                "jenis" => "99999",
                                "cabang_id" => "$cabangID",
                                "jumlah" => "1",
                                "produk_id" => $detailGate[$pid]["target_id"],
                                "produk_nama" => $detailGate[$pid]["name"],
                                "produk_serial_number" => "",//serial_number
                                "produk_sku" => $detailGate[$pid]["kode"],
                                "produk_sku_serial" => "",//produk_sku_serial
                                "produk_sku_part_id" => "",//produk_sku_part_id
                                "produk_sku_part_nama" => $detailGate[$pid]["kode"],//produk_sku_part_nama
                                "produk_sku_part_serial" => "",//produk_sku_part_serial
                                "oleh_id" => "$olehID",
                                "oleh_nama" => "$olehNama",
                                "supplier_id" => "$supplierID",
                                "supplier_nama" => "$supplierName",
                                "gudang_id" => "$gudangID",
                                //---------------
                                "transaksi_reference_id" => "$insertID",
                                "transaksi_reference_no" => "$insertNum",
                                "transaksi_reference_dtime" => date("Y-m-d H:i:s"),
                                "transaksi_reference_fulldate" => date("Y-m-d H:i:s"),
                                "transaksi_reference_count" => "1",
                                "transaksi_count" => "1",
                                "transaksi_jenis_count" => "1",
                                "part_keterangan" => "",
                                "transaksi_id" => "$insertID",
                                "transaksi_no" => "$insertNum",
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d H:i:s"),
                            ),
                        );
                        arrPrintPink($anu);
                        $ss = New ComProdukSerialNumber();
                        $ss->pair($anu);
                        $ss->exec();
                    }


                }
            }

        }


        $pakai_ini = 0;// update tabel payment source
        if ($pakai_ini == 1) {
            foreach ($arrDataDetail as $spec) {
                $sisa = $spec["sisa"];
                $harga = $spec["harga"];
                $new_sisa = $sisa - $harga;
                $data = array(
                    "tagihan" => $new_sisa,
                    "sisa" => $new_sisa,
                    "dihapus" => $harga,
                );
                $where = array(
                    "id" => $spec["id_tbl"],
                );
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->updatePaymentSrc($where, $data);
                showLast_query("orange");

            }
        }


        cekMerah(":: cek validate lajur di " . __FUNCTION__ . ", " . __FILE__);
        validateAllBalances($cabangID);


        mati_disini("---SETOP--- ADJUSTMENT BERHASIL..." . __LINE__);

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");
    }

    public function patchPaymentSrc()
    {
        $this->load->model("MdlTransaksi");
//        target_jenis='489' and sisa>0 and extern2_id=0
        $jenisTr = "483";

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("target_jenis='$jenisTr'");
        $tr->addFilter("sisa>0");
        $tr->addFilter("extern3_id=0");
        $tr->addFilter("nomer!='pemindahbukuan'");
        $tmp = $tr->lookUpAllPaymentSrc()->result();
        showLast_query("biru");
        cekHere(count($tmp));


        $this->db->trans_start();


        if (sizeof($tmp) > 0) {
            $trIDs = array();
            foreach ($tmp as $tmpSpec) {
//                arrPrint($tmpSpec);
                $tbl_id = $tmpSpec->id;
                $transaksi_id = $tmpSpec->transaksi_id;
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id='$transaksi_id'");
                $trTmp = $tr->lookupAll()->result();
                if (sizeof($trTmp) > 0) {
                    $idshist = blobDecode($trTmp[0]->ids_his);
//                    arrPrintWebs($idshist);
                    if (sizeof($idshist) > 0) {
                        $trID_po = $idshist[2]["trID"];
                        $trNomer_po = $idshist[2]["nomer"];

                        //-----
                        $where = array(
                            "id" => $tbl_id,
                        );
                        $data = array(
                            "extern3_id" => $trID_po,
                            "extern3_nama" => $trNomer_po,
                        );
                        $trp = New MdlTransaksi();
                        $trp->setFilters(array());
                        $trp->updatePaymentSrc($where, $data);
                        showLast_query("orange");
                        //-----
                    }
                }


//                break;
            }
        }

        mati_disini("---SETOP--- " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>DONE...</h3>");


    }

    public function patchPaymentSrc749()
    {
        $this->load->model("MdlTransaksi");
//        target_jenis='489' and sisa>0 and extern2_id=0
        $jenisTr = "5822spd";
        $jenisTr_target = "749";
        $trIDs = array();


        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("date(dtime)>='2025-06-20'");
        $tr->addFilter("pembayaran='credit'");
        $tmp = $tr->lookUpAll()->result();
        showLast_query("biru");
        if (sizeof($tmp) > 0) {
            $nom = 0;
            foreach ($tmp as $tmpSpec) {
                $trIDs[$tmpSpec->id] = $tmpSpec->id;
                $trid = $tmpSpec->id;
                $pelaku_transaksi_id = $tmpSpec->oleh_id;
                $pelaku_transaksi_nama = $tmpSpec->oleh_nama;
                $dtime = $tmpSpec->dtime;
                $fulldate = $tmpSpec->fulldate;
                $tmpNomorNota = $tmpSpec->nomer;

                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("label='piutang dagang'");
                $tr->addFilter("target_jenis='$jenisTr_target'");
                $tr->addFilter("transaksi_id='$trid'");
                $tmp = $tr->lookUpAllPaymentSrc()->result();
                if (count($tmp) == 0) {
                    showLast_query("biru");
                    $nom++;
                    cekMerah("insert... [$trid] ");

                    $trr = New MdlTransaksi();
                    $trr->setFilters(array());
                    $trr->addFilter("transaksi_id=$trid");
                    $tmpReg = $trr->lookupDataRegistries()->result();
                    $main = blobDecode($tmpReg[0]->main);

                    $paymentSources = $this->config->item("payment_source");
                    if (array_key_exists($jenisTr, $paymentSources)) {
                        $payConfigs = isset($paymentSources[$jenisTr][4]) ? $paymentSources[$jenisTr][4] : array();
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                $valueLabel = isset($paymentSrcConfig['label_key']) ? $paymentSrcConfig['label_key'] : $paymentSrcConfig['label'];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                cekHijau($valueSrc);
                                $valueSrc_nilai = makeValue($valueSrc, $main, $main, 0);
                                cekHijau("[$valueSrc_nilai]");
//                                arrPrint($main);
//                                break;
                                if ($valueSrc_nilai > 0) {
                                    if (isset($externSrc['extern_label2'])) {
                                        //cek ada isinya atau kosong
                                        $cek = strlen($_SESSION[$cCode]['main'][$externSrc['extern_label2']]) > 4 ? "" : matiHere("jenis biaya tidak dikenali " . __LINE__);//
                                    }
                                    //region cek duplikasi paymentsource
                                    $tr->setFilters(array());
                                    $tr->addFilter("transaksi_id='$trid'");
                                    $tr->addFilter("target_jenis='" . $paymentSrcConfig['jenisTarget'] . "'");
                                    $validateIsInserted = $tr->lookUpAllPaymentSrc()->result();
                                    if (sizeof($validateIsInserted) > 0) {
                                        matiHEre("Gagal menulis transaksi. Silahkan relogin untuk membersihkan sesi demi menghindari duplikasi data, dan coba kembali transaksi yang gagal");
                                    }
                                    //endregion

                                    $arrPymSrc = array(
                                        "jenis" => $jenisTr,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => isset($main[$externSrc['id']]) ? $main[$externSrc['id']] : "",
                                        "extern_nama" => isset($main[$externSrc['nama']]) ? $main[$externSrc['nama']] : "",
                                        "nomer" => $tmpNomorNota,
                                        "label" => $paymentSrcConfig['label'],
//                                "tagihan"  => $main[$valueSrc],
//                                "terbayar" => 0,
//                                "sisa"     => $main[$valueSrc],
                                        "tagihan" => $valueSrc_nilai,
                                        "terbayar" => 0,
                                        "sisa" => $valueSrc_nilai,
                                        "cabang_id" => $main['placeID'],
                                        "cabang_nama" => $main['placeName'],
                                        "oleh_id" => $pelaku_transaksi_id,
                                        "oleh_nama" => $pelaku_transaksi_nama,
                                        "dtime" => $dtime,
                                        "fulldate" => $fulldate,
                                        "valas_id" => isset($externSrc['valasId']) && isset($main[$externSrc['valasId']]) ? $main[$externSrc['valasId']] : '',
                                        "valas_nama" => isset($externSrc['valasLabel']) && isset($main[$externSrc['valasLabel']]) ? $main[$externSrc['valasLabel']] : '',
                                        "valas_nilai" => isset($externSrc['valasValue']) && isset($main[$externSrc['valasValue']]) ? $main[$externSrc['valasValue']] : '',
                                        "tagihan_valas" => isset($externSrc['valasTagihan']) && isset($main[$externSrc['valasTagihan']]) ? $main[$externSrc['valasTagihan']] : '',
                                        "terbayar_valas" => 0,
                                        "sisa_valas" => isset($externSrc['valasSisa']) && isset($main[$externSrc['valasSisa']]) ? $main[$externSrc['valasSisa']] : '',
                                        "extern_label2" => (isset($externSrc['extern_label2']) && ($main[$externSrc['extern_label2']])) ? $main[$externSrc['extern_label2']] : "",
                                        "dpp_ppn" => (isset($externSrc['dpp_ppn']) && ($main[$externSrc['dpp_ppn']])) ? $main[$externSrc['dpp_ppn']] : 0,
                                        "ppn" => (isset($externSrc['ppn']) && ($main[$externSrc['ppn']])) ? $main[$externSrc['ppn']] : 0,
                                        "ppn_approved" => (isset($externSrc['ppn_approved']) && ($main[$externSrc['ppn_approved']])) ? $main[$externSrc['ppn_approved']] : 0,
                                        "ppn_sisa" => (isset($externSrc['ppn']) && ($main[$externSrc['ppn']])) ? $main[$externSrc['ppn']] : "",
                                        "ppn_status" => (isset($externSrc['ppn_status'])) ? $externSrc['ppn_status'] : 0,
                                        "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($main[$externSrc['extern_nilai2']])) ? $main[$externSrc['extern_nilai2']] : 0,
                                        "extern_date2" => (isset($externSrc['extern_date2']) && ($main[$externSrc['extern_date2']])) ? $main[$externSrc['extern_date2']] : "",
                                        "pph_23" => (isset($externSrc['pph_23']) && ($main[$externSrc['pph_23']])) ? $main[$externSrc['pph_23']] : "",
                                        "npwp" => (isset($externSrc['npwp']) && ($main[$externSrc['npwp']])) ? $main[$externSrc['npwp']] : "",
                                        "extern2_id" => (isset($externSrc['extern2_id']) && ($main[$externSrc['extern2_id']])) ? $main[$externSrc['extern2_id']] : "",
                                        "extern2_nama" => (isset($externSrc['extern2_nama']) && ($main[$externSrc['extern2_nama']])) ? $main[$externSrc['extern2_nama']] : "",
                                        "ppn_pph_faktor" => (isset($externSrc['ppn_pph_faktor']) && ($main[$externSrc['ppn_pph_faktor']])) ? $main[$externSrc['ppn_pph_faktor']] : "",
                                        "extern_jenis" => (isset($externSrc['extern_jenis']) && ($main[$externSrc['extern_jenis']])) ? $main[$externSrc['extern_jenis']] : "",
                                        "extern_nilai3" => (isset($externSrc['extern_nilai3']) && ($main[$externSrc['extern_nilai3']])) ? $main[$externSrc['extern_nilai3']] : "",
                                        "extern_nilai4" => (isset($externSrc['extern_nilai4']) && ($main[$externSrc['extern_nilai4']])) ? $main[$externSrc['extern_nilai4']] : "",
                                        "npwp" => (isset($externSrc['npwp']) && ($main[$externSrc['npwp']])) ? $main[$externSrc['npwp']] : "",
                                        "payment_locked" => (isset($externSrc['payment_locked']) && ($main[$externSrc['payment_locked']])) ? $main[$externSrc['payment_locked']] : 0,
                                        "cash_account" => (isset($externSrc['cash_account']) && ($main[$externSrc['cash_account']])) ? $main[$externSrc['cash_account']] : 0,
                                        "cash_account_nama" => (isset($externSrc['cash_account_nama']) && ($main[$externSrc['cash_account_nama']])) ? $main[$externSrc['cash_account_nama']] : 0,
                                        //------------------
                                        "extern3_id" => makeValue($externSrc['extern3_id'], $main, $main, 0),
                                        "extern3_nama" => makeValue($externSrc['extern3_nama'], $main, $main, 0),
                                        "extern4_id" => makeValue($externSrc['extern4_id'], $main, $main, 0),
                                        "extern4_nama" => makeValue($externSrc['extern4_nama'], $main, $main, 0),
                                        "extern5_id" => makeValue($externSrc['extern5_id'], $main, $main, 0),
                                        "extern5_nama" => makeValue($externSrc['extern5_nama'], $main, $main, 0),
                                        //------------------

                                    );
                                    $tr->writePaymentSrc($trid, $arrPymSrc);
                                    cekMerah($this->db->last_query());
                                }
                            }
                        }
                    }

                }

            }

        }
        cekHitam("transaksi 5822spd kredit: " . count($trIDs));


        mati_disini("---SETOP--- " . __LINE__);

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>DONE...</h3>");


    }


    public function cekRelasiUMPO()
    {
        $this->load->model("MdlTransaksi");

        $jenisTr = "466";
        $arrJenisTr = array("466", "1466", "463o");
        $extern_label = "uang muka";
        $extern_label2 = "uang muka supplier";

        $headers = array(
            "extern_nama" => "supplier",
            "transaksi_id" => "trid um",
            "nomer_um" => "nomer um/titipan",
            "extern2_id" => "trid po batal",
            "extern2_nama" => "nomer po sudah dibatalkan",
            "sisa" => "nilai",
            "cancel_dtime" => "dtime cancel po",
            "cancel_nama" => "pic cancel po",
        );


        $this->db->trans_start();


        // region cek PO yang dibatalkan
        $tr = New MdlTransaksi();
        $tr->setFilters(array());
//        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("jenis in ('" . implode("','", $arrJenisTr) . "')");
        $tr->addFilter("trash_4='1'");
        $trTmp = $tr->lookupAll()->result();
        $arrDataPo = array();
        $arrDataPoTrIDs = array();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $arrDataPoTrIDs[$trSpec->id] = $trSpec->id;
                $arrDataPo[$trSpec->id] = array(
                    "id_po" => $trSpec->id,
                    "nomer_po" => $trSpec->nomer,
                    "suppliers_id" => $trSpec->suppliers_id,
                    "suppliers_nama" => $trSpec->suppliers_nama,
                    "oleh_id" => $trSpec->oleh_id,
                    "oleh_nama" => $trSpec->oleh_nama,
                    "dtime" => $trSpec->dtime,
                    "fulldate" => $trSpec->fulldate,
                    "cancel_dtime" => $trSpec->cancel_dtime,
                    "cancel_nama" => $trSpec->cancel_name,
                );
            }
        }
        // endregion cek PO yang dibatalkan

        $arrExt2IDs = array(
//            163781,
//            163791,
//            163801,
//            163755,
//            178581,
//            184774,
//            203279,
            203879,
        );


        // region cek UM source dengan relasi
        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("label='$extern_label'");
//        $tr->addFilter("extern2_id in ('".implode("','", $arrDataPoTrIDs)."')");
        $tr->addFilter("extern2_id in ('" . implode("','", $arrExt2IDs) . "')");
        $tr->addFilter("sisa>0");
        $trUMSrc = $tr->lookupAllUangMukaSrc($jenisTr)->result();
        // endregion cek UM source dengan relasi

        // region cek PYN UM source dengan relasi
        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("label='$extern_label2'");
        $tr->addFilter("extern2_id in ('" . implode("','", $arrDataPoTrIDs) . "')");
        $tr->addFilter("sisa>0");
        $trPymUMSrc = $tr->lookUpAllPaymentSrc()->result();
        showLast_query("biru");
        // endregion cek UM source dengan relasi


        $cabangID = "-1";
        $cabangNama = "pusat dc";
        $gudangID = "-1";
        $gudangNama = "default warehouse at branch #-1";
        $cabang2ID = "-1";
        $cabang2Nama = "pusat dc";
        $gudang2ID = "-1";
        $gudang2Nama = "default warehouse at branch #-1";
        $olehID = "100";
        $olehNama = "system";
        $pihakID = "0";
        $pihakNama = "";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $modul_transaksi = "koreksi";
        $tCodeTargetJenisTransaksi = $jenisTrMaster;
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT.PANASONIC GOBEL INDONESIA Uang Muka sebesar 299.589.000 (PO-FG.-1.1018) 2024-08-06 10:44:59 oleh everest",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT.PANASONIC GOBEL INDONESIA Uang Muka sebesar 293.817.000 (PO-FG.-1.1019) 2024-08-06 10:45:50 oleh everest",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT.PANASONIC GOBEL INDONESIA Uang Muka sebesar 270.729.000 (PO-FG.-1.1020) 2024-08-06 10:46:37 oleh everest",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT.PANASONIC GOBEL INDONESIA Uang Muka sebesar 382.139.700 (PO-FG.-1.1017) 2024-08-06 10:44:19 oleh everest",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT. SHARP ELECTRONICS INDONESIA Uang Muka sebesar 71.953.530 (PO-FG.-1.1106) 2024-08-22 13:45:57 oleh MARTIN",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT. SHARP ELECTRONICS INDONESIA Uang Muka sebesar 154.068.000 (PO-FG.-1.1148) 2024-09-21 11:07:02 oleh Magdalena",
//            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO NEGERINDO Uang Muka sebesar 80.577 (PO-FG.-1.1221) 2024-09-25 15:50:14 Magdalena",
            "description" => "ADJ Uang Muka relasi PO ke Uang Muka tanpa relasi PO PT.SUMBER PUTRA MAKMUR Uang Muka sebesar 8.522.469 (PO-FG.-1.1222) 2024-09-20 13:14:30 Magdalena",

//            "cash_account" => $cash_account,
//            "cash_account_nama" => $cash_account_nama,
//            "referenceID" => $referenceID,
//            "referenceNomer" => $referenceNomer,
//
//            "um_noppn_nilai" => $total_nilai*-1,
//            "um_noppn_nonrelasi_nilai" => $total_nilai,

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );


        $str = "<h3>titipan dengan po dibatalkan</h3>";
        $str .= "<table class='table table-condensed' rules='all' width='100%'>";
        $str .= "<tr>";
        $str .= "<td>no.</td>";
        foreach ($headers as $key => $lbl) {
            $str .= "<td>$lbl</td>";
        }
        $str .= "</tr>";
        if (sizeof($trUMSrc) > 0) {
            $no = 0;
            $total_nilai = 0;
            foreach ($trUMSrc as $umSpec) {
                if (isset($arrDataPo[$umSpec->extern2_id])) {
                    foreach ($arrDataPo[$umSpec->extern2_id] as $po_key => $po_val) {
                        $umSpec->$po_key = $po_val;
                    }
                }
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id=" . $umSpec->transaksi_id);
                $trTmp = $tr->lookupAll()->result();
                $umSpec->nomer_um = $trTmp[0]->nomer;

                $no++;
                $str .= "<tr>";
                $str .= "<td>$no</td>";
                foreach ($headers as $key => $lbl) {
                    $str .= "<td>" . $umSpec->$key . "</td>";
                }
                $str .= "</tr>";

                $arrUmSpec = (array)$umSpec;
                $sub_harga = $arrUmSpec["sisa"];
                $total_nilai += $sub_harga;
                $detailGate[$arrUmSpec["extern2_id"]] = array(
                    "handler" => "",
                    "id" => $arrUmSpec["extern2_id"],
                    "jml" => 1,
                    "harga" => $arrUmSpec["sisa"],
                    "subtotal" => 0,
                    "satuan" => "gram",
                    "discount_persen" => 0,
                    "discount_qty" => 0,
                    "hpp" => $arrUmSpec["sisa"],
                    "nama" => $arrUmSpec["extern2_nama"],
                    "kode" => "",
                    "barcode" => "",
                    "no_part" => 0,
                    "label" => "",
                    "ppn" => 0,
                    "stok" => 0,
                    "debet" => 0,
                    "kredit" => 0,
                    "qty_selisih" => 0,
                    "qty" => 1,
                    "name" => $arrUmSpec["extern2_nama"],
                    "sub_harga" => $arrUmSpec["sisa"],
                    "sub_subtotal" => $arrUmSpec["sisa"],
                    "sub_discount_persen" => 0,
                    "sub_discount_qty" => 0,
                    "sub_hpp" => $arrUmSpec["sisa"],
                    "sub_no_part" => 0,
                    "sub_ppn" => 0,
                    "sub_stok" => 0,
                    "sub_debet" => 0,
                    "sub_kredit" => 0,
                    "sub_qty_selisih" => 0,

                    "next_substep_code" => "",
                    "next_subgroup_code" => "o_holding",
                    "sub_step_number" => 1,
                    "sub_step_current" => 1,
                    "supplier_id" => $arrUmSpec["extern_id"],
                    "supplier_nama" => $arrUmSpec["extern_nama"],
                    "cabang_id" => $arrUmSpec["cabang_id"],
                    "cabang_nama" => $arrUmSpec["cabang_nama"],
                    "pihakID" => $arrUmSpec["extern_id"],
                    "pihakName" => $arrUmSpec["extern_nama"],
                    "placeID" => $arrUmSpec["cabang_id"],
                    "placeName" => $arrUmSpec["cabang_nama"],

                    "um_noppn_nilai" => $arrUmSpec["sisa"] * -1,
                    "um_noppn_nonrelasi_nilai" => $arrUmSpec["sisa"],

                    "referensi_so__id" => $arrUmSpec["extern2_id"],
                    "referensi_so__nomer" => $arrUmSpec["extern2_nama"],
                );

            }
            foreach ($detailGate as $pid => $spec) {
                foreach ($mainGate as $key => $val) {
                    if (!isset($spec[$key])) {
                        $spec[$key] = $val;
                    }
                }
                $detailGate[$pid] = $spec;
                foreach ($tableIn["detail"] as $ikey => $ival) {
                    $tableIn_detail[$pid][$ikey] = isset($spec[$ival]) ? $spec[$ival] : "";
                }
            }
            $mainGate["um_noppn_nilai"] = $total_nilai * -1;
            $mainGate["um_noppn_nonrelasi_nilai"] = $total_nilai;

        }
        else {
            mati_disini("KOSONG...");
        }
        $str .= "</table>";
        echo $str;
        echo "<br>";
        echo "<br>";


        $str = "<h3>um supplier dengan po dibatalkan</h3>";
        $str .= "<table class='table table-condensed' rules='all' width='100%'>";
        $str .= "<tr>";
        $str .= "<td>no.</td>";
        foreach ($headers as $key => $lbl) {
            $str .= "<td>$lbl</td>";
        }
        $str .= "</tr>";
        if (sizeof($trPymUMSrc) > 0) {
            $no = 0;
            foreach ($trPymUMSrc as $umSpec) {
                if (isset($arrDataPo[$umSpec->extern2_id])) {
                    foreach ($arrDataPo[$umSpec->extern2_id] as $po_key => $po_val) {
                        $umSpec->$po_key = $po_val;
                    }
                }
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id=" . $umSpec->transaksi_id);
                $trTmp = $tr->lookupAll()->result();
                $umSpec->nomer_um = $trTmp[0]->nomer;

                $no++;
                $str .= "<tr>";
                $str .= "<td>$no</td>";
                foreach ($headers as $key => $lbl) {
                    $str .= "<td>" . $umSpec->$key . "</td>";
                }
                $str .= "</tr>";
            }
        }
        $str .= "</table>";
        echo $str;


        // region transaksi adj---------
        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }
        $this->cCode = $cCode = "_TR_" . $jenis;
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => $tableIn_detail,
        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;

        //--------------------------
        $preProcessor = array();
        $components = array(
            "master" => array(
                array(
                    "comName" => "Jurnal",
                    "loop" => array(
                        "1010050010" => "um_noppn_nilai",// uang muka dibayar tanpa ppn
                        "1010050040" => "um_noppn_nonrelasi_nilai",// uang muka dibayar tanpa ppn non relasi
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),
                array(
                    "comName" => "Rekening",
                    "loop" => array(
                        "1010050010" => "um_noppn_nilai",// uang muka dibayar tanpa ppn
                        "1010050040" => "um_noppn_nonrelasi_nilai",// uang muka dibayar tanpa ppn non relasi
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "main",
                    "srcRawGateName" => "main",
                ),

            ),
            "detail" => array(
                //pembantu uang muka tanpa ppn dengan relasi PO supplier
                array(
                    "comName" => "RekeningPembantuUangMuka",
                    "loop" => array(
                        "1010050010" => "um_noppn_nilai",// uang muka dibayar tanpa ppn
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "extern2_id" => ".0",
                        "extern2_nama" => ".0",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
                //pembantu uang muka tanpa ppn tanpa  relasi PO supplier
                array(
                    "comName" => "RekeningPembantuUangMuka",
                    "loop" => array(
                        "1010050040" => "um_noppn_nonrelasi_nilai",// uang muka dibayar tanpa ppn non relasi PO
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "extern2_id" => ".0",
                        "extern2_nama" => ".0",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

                //rekening pembantu uang muka tanpa ppn persupplier relasi PO
                array(
                    "comName" => "RekeningPembantuUangMukaReference",
                    "loop" => array(
                        "1010050010" => "um_noppn_nilai",// uang muka dibayar tanpa ppn
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
                        "extern2_id" => "referensi_so__id",//jika tidak punya relasi diisi 0 bebas dipakai oleh uang muka tanpa relasi/ sebaliknya jika terelasi supaya bebas dibuat transaksi un-relasi dulu
                        "extern2_nama" => "referensi_so__nomer",
                        "extern3_id" => "option_nota",
                        "extern3_nama" => "option_nota__nama",
                        "extern4_nama" => "option_nota__jenis",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
                //rekening pembantu uang muka tanpa ppn persupplier tanpa relasi PO
                array(
                    "comName" => "RekeningPembantuUangMukaReference",
                    "loop" => array(
                        "1010050040" => "um_noppn_nonrelasi_nilai",// uang muka dibayar tanpa ppn
                    ),
                    "static" => array(
                        "cabang_id" => "placeID",
                        "extern_id" => "pihakID",
                        "extern_nama" => "pihakName",
//                        "extern2_id" => "referensi_so__id",//jika tidak punya relasi diisi 0 bebas dipakai oleh uang muka tanpa relasi/ sebaliknya jika terelasi supaya bebas dibuat transaksi un-relasi dulu
//                        "extern2_nama" => "referensi_so__nomer",
                        "extern2_id" => ".0",//jika tidak punya relasi diisi 0 bebas dipakai oleh uang muka tanpa relasi/ sebaliknya jika terelasi supaya bebas dibuat transaksi un-relasi dulu
                        "extern2_nama" => ".0",
                        "extern3_id" => "option_nota",
                        "extern3_nama" => "option_nota__nama",
                        "extern4_nama" => "option_nota__jenis",
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );
        $postProcessor = array(
            "master" => array(),
            "detail" => array(
//                array(
//                    "comName" => "FifoAverage",
//                    "loop" => array(),
//                    "static" => array(
//                        "jenis" => ".produk",
//                        "jml" => "qty_debet",
//                        "produk_id" => "id",
//                        "hpp" => "hpp",
//                        "jml_nilai" => "sub_debet",
//                        "nama" => "name",
//                        "toko_id" => "tokoID",
//                        "toko_nama" => "tokoNama",
//                        "cabang_id" => "placeID",
//                        "gudang_id" => "gudangID",
//                    ),
//                    "srcGateName" => "items",
//                    "srcRawGateName" => "items",
//                ),

//                    array(
//                        "comName" => "LockerStock",
//                        "loop" => array(),
//                        "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
//                            "cabang_id" => "placeID",
//                            "jenis" => ".produk",
//                            "state" => ".active",
//                            "jumlah" => "qty_debet",
//                            "produk_id" => "id",
//                            "nama" => "name",
//                            "satuan" => "satuan",
//                            "transaksi_id" => ".0",
//                            "oleh_id" => ".0",
//                            "gudang_id" => "gudangID",
//                        ),
//                        "srcGateName" => "items",
//                        "srcRawGateName" => "items",
//                    ),

                array(
                    "comName" => "LockerStock",
                    "loop" => array(),
                    "static" => array(
//                            "toko_id" => "tokoID",
//                            "toko_nama" => "tokoNama",
                        "cabang_id" => "placeID",
                        "jenis" => ".produk",
                        "state" => ".active",
                        "jumlah" => "-qty",
                        "produk_id" => "id",
                        "nama" => "name",
                        "satuan" => "satuan",
                        "transaksi_id" => ".0",
                        "oleh_id" => ".0",
                        "gudang_id" => "gudangID",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),

            ),
        );
        //--------------------------
//arrPrint($components);
//mati_disini(__LINE__);

        // MEMBUAT TRANSAKSI
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            //region dynamic counters

            $counters = array(
                "stepCode|placeID",
//                "stepCode|tokoID",
//                "stepCode|tokoID|placeID",
//                "stepCode|tokoID|olehID",
//                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|placeID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion
        }
        else {
            $insertID = "1111111111111";
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "";
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }

                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->configUiModul[$this->jenisTr]["steps"][$stepNum]["label"] . " nomor " . $tmpNomorNota . " oleh " . $this->cCodeData[$cCode]["tableIn_master"]['oleh_nama'];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }

        // POST-PROCC
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            //region processing sub-post-processors, always
            $iterator = $postProcessor["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>");
                    $tmpOutParams[$cCtr] = array();
                    if (isset($this->cCodeData[$cCode][$srcGateName]) && (sizeof($this->cCodeData[$cCode][$srcGateName]) > 0)) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $xid => $dSpec) {
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($this->cCodeData[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $this->cCodeData[$cCode]["main"]['pihakExternID'];
                                }
                                $subParams['static']["keterangan"] = "";
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($this->cCodeData[$cCode][$srcGateName])) {
                        cekHere("[$cCtr] sub-postProcessor: $comName, sending values " . __LINE__ . "<br>");
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekHitam($this->db->last_query());
                    }
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP SUB-POSTPROC");
            }
            //endregion

            //region processing main-post-processors, always
            $iterator = $postProcessor["master"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("post-processor: $comName<br>LINE: " . __LINE__);

                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = "";
                    }
                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = "";
                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }
            else {
                cekHitam("TIDAK ADA SETUP MAIN-POSTPROC");
            }
            //endregion
        }

        //region MENULIS KE REGISTRY
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (isset($core['components']) && sizeof($core['components'])) {
                $jurnalIndex = $core['components'];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //------------
            if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
            }
            else {
                if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //------------
            if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
            }
            else {
                $coreBuilder = array();
            }
            //------------
            $baseRegistries = array(
                "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                //-----
            );
            $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            showLast_query("biru");

        }
        //endregion


        // endregion transaksi adj---------


        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>SELESAI...</h3>");


    }


    //-------------------------------------------
    public function cekUangMukaPPN()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMain");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMainReference");

        $tbl_mutasi_um = "__rek_pembantu_uang_muka__1010050030";
        $tbl_mutasi_um_reference = "__rek_pembantu_uang_muka_reference__1010050030";

        $extern_label2 = "uang muka supplier";
        $jenis = "464";
        $arrPO_ids = array();
        $arrUM_data = array();
        $arrUM_ref_data = array();
        $arrUM_ref_saldo = array();

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("label='$extern_label2'");
        $tr->addFilter("jenis='$jenis'");
        $tr->addFilter("sisa>1000");
        $trPymUMSrc = $tr->lookUpAllPaymentSrc()->result();
        if (sizeof($trPymUMSrc) > 0) {
            foreach ($trPymUMSrc as $umSpec) {
                $po_id = $umSpec->extern2_id;
                $po_nomer = $umSpec->extern2_nama;
                $um_id = $umSpec->transaksi_id;
                $um_nomer = $umSpec->nomer;
                $arrPO_ids[$po_id] = $po_id;

            }
        }


        $umr = New ComRekeningPembantuUangMukaMainReference();
        $umr->addFilter("extern2_id in ('" . implode("','", $arrPO_ids) . "')");
        $umrTmp = $umr->fetchBalances("1010050030");
        showLast_query("kuning");
        if (sizeof($umrTmp) > 0) {
            foreach ($umrTmp as $umrSpec) {
                $arrUM_ref_saldo[$umrSpec->extern2_id] = array(
                    "debet" => $umrSpec->debet,
                );
            }
        }


        $this->db->where_in("extern2_id", $arrPO_ids);
        $umTmp = $this->db->get($tbl_mutasi_um)->result();
        if (sizeof($umTmp) > 0) {
            foreach ($umTmp as $umSpec) {
                $arrUM_data[$umSpec->extern2_id] = array(
                    "nomer" => $umSpec->extern2_nama,
                    "debet" => $umSpec->debet,
                );
            }
        }


        $this->db->where_in("extern2_id", $arrPO_ids);
        $umTmpRef = $this->db->get($tbl_mutasi_um_reference)->result();
        if (sizeof($umTmpRef) > 0) {
            foreach ($umTmpRef as $umSpec) {
                $arrUM_ref_data[$umSpec->extern2_id] = array(
                    "nomer" => $umSpec->extern2_nama,
                    "debet" => $umSpec->debet,
                );
            }
        }

        if (sizeof($trPymUMSrc) > 0) {
            $str = "<table rules='all' style='border:1px solid black;' width='100%'>";
            $str .= "<tr>";
            $str .= "<td>No.</td>";
            $str .= "<td>dtime</td>";
            $str .= "<td>supplier ID</td>";
            $str .= "<td>supplier Nama</td>";
            $str .= "<td>trID UM</td>";
            $str .= "<td>Nomer UM</td>";
            $str .= "<td>trID PO</td>";
            $str .= "<td>Nomer PO</td>";
            $str .= "<td>Awal</td>";
            $str .= "<td>Terbayar</td>";
            $str .= "<td>Sisa</td>";

            $str .= "<td>Nomer UM</td>";
            $str .= "<td>Debet UM</td>";

            $str .= "<td>Nomer UM REF</td>";
            $str .= "<td>Debet UM REF</td>";

            $str .= "<td>Debet Cache<br>UM REF</td>";

            $str .= "</tr>";
            $no = 0;
            foreach ($trPymUMSrc as $umSpec) {
                $um_id = $umSpec->transaksi_id;
                $um_nomer = $umSpec->nomer;
                $extern_id = $umSpec->extern_id;
                $extern_nama = $umSpec->extern_nama;
                $po_id = $umSpec->extern2_id;
                $po_nomer = $umSpec->extern2_nama;
                $um_id = $umSpec->transaksi_id;
                $um_nomer = $umSpec->nomer;
                $sisa = $umSpec->sisa;
                $terbayar = $umSpec->terbayar;
                $tagihan = $umSpec->tagihan;
                $dtime = $umSpec->dtime;

                $um_um_nomer = isset($arrUM_data[$po_id]["nomer"]) ? $arrUM_data[$po_id]["nomer"] : "";
                $um_um_debet = isset($arrUM_data[$po_id]["debet"]) ? $arrUM_data[$po_id]["debet"] : "";

                $um_um_ref_nomer = isset($arrUM_ref_data[$po_id]["nomer"]) ? $arrUM_ref_data[$po_id]["nomer"] : "";
                $um_um_ref_debet = isset($arrUM_ref_data[$po_id]["debet"]) ? $arrUM_ref_data[$po_id]["debet"] : "";

                $um_um_ref_debet_saldo = isset($arrUM_ref_saldo[$po_id]["debet"]) ? $arrUM_ref_saldo[$po_id]["debet"] : "";
                $selisih = $sisa - $um_um_ref_debet_saldo;
                if ($selisih > 100) {
                    $trbgcolor = "pink";
                }
                else {
                    $trbgcolor = "";
                }

                $no++;
                $str .= "<tr style='background-color:$trbgcolor;'>";
                $str .= "<td>$no</td>";
                $str .= "<td>$dtime</td>";
                $str .= "<td>$extern_id</td>";
                $str .= "<td>$extern_nama</td>";
                $str .= "<td>$um_id</td>";
                $str .= "<td>$um_nomer</td>";
                $str .= "<td>$po_id</td>";
                $str .= "<td>$po_nomer</td>";
                $str .= "<td align='right' style='background-color:lime;'>" . number_format($tagihan) . "</td>";
                $str .= "<td align='right' style='background-color:yellow;'>" . number_format($terbayar) . "</td>";
                $str .= "<td align='right' style='background-color:lime;'>" . number_format($sisa) . "</td>";

                $str .= "<td>$um_um_nomer</td>";
                $str .= "<td align='right' style='background-color:lime;'>" . number_format($um_um_debet) . "</td>";

                $str .= "<td>$um_um_ref_nomer</td>";
                $str .= "<td align='right' style='background-color:lime;'>" . number_format($um_um_ref_debet) . "</td>";

                $str .= "<td align='right' style='background-color:lime;'>" . number_format($um_um_ref_debet_saldo) . "</td>";

                $str .= "</tr>";

            }
            $str .= "</table>";
            echo $str;
        }


    }

    public function patchUangMukaPPN()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMain");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMainReference");

        $tbl_mutasi_um = "__rek_pembantu_uang_muka__1010050030";
        $tbl_mutasi_um_reference = "__rek_pembantu_uang_muka_reference__1010050030";

        $rekening = "1010050030";
        $extern_label2 = "uang muka supplier";
        $jenis = "464";
        $target_jenis = "0464";
        $arrPO_ids = array();
        $arrUM_data = array();
        $arrUM_dataMulti = array();
        $arrUM_ref_data = array();
        $arrUM_ref_saldo = array();

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("label='$extern_label2'");
        $tr->addFilter("target_jenis='$target_jenis'");
        $tr->addFilter("sisa>1");
        $trPymUMSrc = $tr->lookUpAllPaymentSrc()->result();
        showLast_query("biru");
        if (sizeof($trPymUMSrc) > 0) {
            foreach ($trPymUMSrc as $umSpec) {
                $extern_id = $umSpec->extern_id;
                $extern_nama = $umSpec->extern_nama;
                $po_id = $umSpec->extern2_id;
                $po_nomer = $umSpec->extern2_nama;
                $um_id = $umSpec->transaksi_id;
                $um_nomer = $umSpec->nomer;
                $um_sisa = $umSpec->sisa;
                $id_tbl = $umSpec->id;

                $arrUM_data[$extern_id][$po_id][] = array(
                    "po_id" => $po_id,
                    "po_nomer" => $po_nomer,
                    "extern_id" => $extern_id,
                    "extern_nama" => $extern_nama,
                    "sisa" => $um_sisa,
                );
            }

            //--------------------------
            $arrPOIDs = array();
            foreach ($arrUM_data as $extern_id => $externSpec) {
                foreach ($externSpec as $po_id => $poSpec) {
                    if (count($poSpec) > 1) {
                        $arrPOIDs[$po_id] = $po_id;
                        $arrUM_dataMulti[$extern_id][$po_id] = $poSpec;
                    }
                }
            }
        }
        arrPrintCyan($arrUM_dataMulti);
        arrPrintHitam($arrPOIDs);


        $pakai_ini = 0;
        if ($pakai_ini == 1) {

            $umr = New ComRekeningPembantuUangMukaMainReference();
            $umr->addFilter("extern2_id in ('" . implode("','", $arrPO_ids) . "')");
            $umrTmp = $umr->fetchBalances("1010050030");
            showLast_query("kuning");
            if (sizeof($umrTmp) > 0) {
                foreach ($umrTmp as $umrSpec) {
                    $arrUM_ref_saldo[$umrSpec->extern2_id] = array(
                        "debet" => $umrSpec->debet,
                    );
                }
            }


            $this->db->where_in("extern2_id", $arrPO_ids);
            $umTmp = $this->db->get($tbl_mutasi_um)->result();
            if (sizeof($umTmp) > 0) {
                foreach ($umTmp as $umSpec) {
                    $arrUM_data[$umSpec->extern2_id] = array(
                        "nomer" => $umSpec->extern2_nama,
                        "debet" => $umSpec->debet,
                    );
                }
            }


            $this->db->where_in("extern2_id", $arrPO_ids);
            $umTmpRef = $this->db->get($tbl_mutasi_um_reference)->result();
            if (sizeof($umTmpRef) > 0) {
                foreach ($umTmpRef as $umSpec) {
                    $arrUM_ref_data[$umSpec->extern2_id] = array(
                        "nomer" => $umSpec->extern2_nama,
                        "debet" => $umSpec->debet,
                    );
                }
            }

            if (sizeof($trPymUMSrc) > 0) {
                $str = "<table rules='all' style='border:1px solid black;' width='100%'>";
                $str .= "<tr>";
                $str .= "<td>No.</td>";
                $str .= "<td>dtime</td>";
                $str .= "<td>supplier ID</td>";
                $str .= "<td>supplier Nama</td>";
                $str .= "<td>trID UM</td>";
                $str .= "<td>Nomer UM</td>";
                $str .= "<td>trID PO</td>";
                $str .= "<td>Nomer PO</td>";
                $str .= "<td>Awal</td>";
                $str .= "<td>Terbayar</td>";
                $str .= "<td>Sisa</td>";

                $str .= "<td>Nomer UM</td>";
                $str .= "<td>Debet UM</td>";

                $str .= "<td>Nomer UM REF</td>";
                $str .= "<td>Debet UM REF</td>";

                $str .= "<td>Debet Cache<br>UM REF</td>";

                $str .= "</tr>";
                $no = 0;
                foreach ($trPymUMSrc as $umSpec) {
                    $um_id = $umSpec->transaksi_id;
                    $um_nomer = $umSpec->nomer;
                    $extern_id = $umSpec->extern_id;
                    $extern_nama = $umSpec->extern_nama;
                    $po_id = $umSpec->extern2_id;
                    $po_nomer = $umSpec->extern2_nama;
                    $um_id = $umSpec->transaksi_id;
                    $um_nomer = $umSpec->nomer;
                    $sisa = $umSpec->sisa;
                    $terbayar = $umSpec->terbayar;
                    $tagihan = $umSpec->tagihan;
                    $dtime = $umSpec->dtime;

                    $um_um_nomer = isset($arrUM_data[$po_id]["nomer"]) ? $arrUM_data[$po_id]["nomer"] : "";
                    $um_um_debet = isset($arrUM_data[$po_id]["debet"]) ? $arrUM_data[$po_id]["debet"] : "";

                    $um_um_ref_nomer = isset($arrUM_ref_data[$po_id]["nomer"]) ? $arrUM_ref_data[$po_id]["nomer"] : "";
                    $um_um_ref_debet = isset($arrUM_ref_data[$po_id]["debet"]) ? $arrUM_ref_data[$po_id]["debet"] : "";

                    $um_um_ref_debet_saldo = isset($arrUM_ref_saldo[$po_id]["debet"]) ? $arrUM_ref_saldo[$po_id]["debet"] : "";
                    $selisih = $sisa - $um_um_ref_debet_saldo;
                    if ($selisih > 100) {
                        $trbgcolor = "pink";
                    }
                    else {
                        $trbgcolor = "";
                    }

                    $no++;
                    $str .= "<tr style='background-color:$trbgcolor;'>";
                    $str .= "<td>$no</td>";
                    $str .= "<td>$dtime</td>";
                    $str .= "<td>$extern_id</td>";
                    $str .= "<td>$extern_nama</td>";
                    $str .= "<td>$um_id</td>";
                    $str .= "<td>$um_nomer</td>";
                    $str .= "<td>$po_id</td>";
                    $str .= "<td>$po_nomer</td>";
                    $str .= "<td align='right' style='background-color:lime;'>" . number_format($tagihan) . "</td>";
                    $str .= "<td align='right' style='background-color:yellow;'>" . number_format($terbayar) . "</td>";
                    $str .= "<td align='right' style='background-color:lime;'>" . number_format($sisa) . "</td>";

                    $str .= "<td>$um_um_nomer</td>";
                    $str .= "<td align='right' style='background-color:lime;'>" . number_format($um_um_debet) . "</td>";

                    $str .= "<td>$um_um_ref_nomer</td>";
                    $str .= "<td align='right' style='background-color:lime;'>" . number_format($um_um_ref_debet) . "</td>";

                    $str .= "<td align='right' style='background-color:lime;'>" . number_format($um_um_ref_debet_saldo) . "</td>";

                    $str .= "</tr>";

                }
                $str .= "</table>";
                echo $str;
            }

        }

    }

    public function patchUangMukaRelasiPO()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMain");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMainReference");

        $tbl_mutasi_um = "__rek_pembantu_uang_muka__1010050010";
        $tbl_mutasi_um_reference = "__rek_pembantu_uang_muka_reference__1010050010";

        $rekening = "1010050010";
        $extern_label2 = "uang muka";
        $jenis = "464";
        $target_jenis = "0464";
        $arrPO_ids = array();
        $arrUM_data = array();
        $arrUM_dataMulti = array();
        $arrUM_ref_data = array();
        $arrUM_ref_saldo = array();

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("label='$extern_label2'");
//        $tr->addFilter("target_jenis='$target_jenis'");
//        $tr->addFilter("sisa>100");
        $tr->addFilter("extern2_id>0");
        $trPymUMSrc = $tr->lookupAllUangMukaSrc($target_jenis)->result();
        showLast_query("biru");
//        mati_disini(__LINE__);

        $this->db->trans_start();


        $umr = New ComRekeningPembantuUangMukaMainReference();
        $umr->addFilter("debet>0");
        $umrTmp = $umr->fetchBalances("1010050010");
        showLast_query("kuning");
        cekKuning(count($umrTmp));
        if (sizeof($umrTmp) > 0) {
            foreach ($umrTmp as $umrSpec) {
                $arrUM_ref_saldo[$umrSpec->extern2_id] = array(
                    "debet" => $umrSpec->debet,
                );
            }
        }
        arrPrintHitam($arrUM_ref_saldo);

        if (sizeof($trPymUMSrc) > 0) {
            foreach ($trPymUMSrc as $umSpec) {
                $extern_id = $umSpec->extern_id;
                $extern_nama = $umSpec->extern_nama;
                $po_id = $umSpec->extern2_id;
                $po_nomer = $umSpec->extern2_nama;
                $um_id = $umSpec->transaksi_id;
                $um_nomer = $umSpec->nomer;
                $um_sisa = $umSpec->sisa;
                $id_tbl = $umSpec->id;

                if (array_key_exists($po_id, $arrUM_ref_saldo)) {
//                    cekHere("update pym uang muka source dari $um_sisa ke " . $arrUM_ref_saldo[$po_id]["debet"]);
                    $selisih = $arrUM_ref_saldo[$po_id]["debet"] - $um_sisa;
                    $selisih = ($selisih < 0) ? ($selisih * -1) : $selisih;
                    if ($selisih > 100) {

                        $data = array(
                            "sisa" => $arrUM_ref_saldo[$po_id]["debet"],
                        );
                        $where = array(
                            "extern2_id" => $po_id,
                            "id" => $id_tbl,
                        );
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->updateUangMukaSrc($where, $data);
                        showLast_query("orange");
                    }
                }
            }


        }

        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");

    }

    public function patchUangMukaRelasiPO_PPN()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMain");
        $this->load->model("Coms/ComRekeningPembantuUangMukaMainReference");

        $tbl_mutasi_um = "__rek_pembantu_uang_muka__1010050030";
        $tbl_mutasi_um_reference = "__rek_pembantu_uang_muka_reference__1010050030";

        $rekening = "1010050030";
        $extern_label2 = "uang muka supplier";
        $jenis = "464";
        $target_jenis = "0464";
        $arrPO_ids = array();
        $arrUM_data = array();
        $arrUM_data_cek = array();
        $arrUM_dataMulti = array();
        $arrUM_ref_data = array();
        $arrUM_ref_saldo = array();

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("label='$extern_label2'");
//        $tr->addFilter("target_jenis='$target_jenis'");
//        $tr->addFilter("sisa>100");
        $tr->addFilter("extern2_id>0");
        $trPymUMSrc = $tr->lookUpAllPaymentSrc()->result();
        showLast_query("biru");
//        mati_disini(__LINE__);

        $this->db->trans_start();


        $umr = New ComRekeningPembantuUangMukaMainReference();
//        $umr->addFilter("debet>0");
        $umrTmp = $umr->fetchBalances("1010050030");
        showLast_query("kuning");
        cekKuning(count($umrTmp));
        if (sizeof($umrTmp) > 0) {
            foreach ($umrTmp as $umrSpec) {
                $arrUM_ref_saldo[$umrSpec->extern2_id] = array(
                    "debet" => $umrSpec->debet,
                    "transaksi_id" => $umrSpec->transaksi_id,
                    "extern_id" => $umrSpec->extern_id,
                );
            }
        }
        arrPrintHitam($arrUM_ref_saldo);

        if (sizeof($trPymUMSrc) > 0) {
            foreach ($trPymUMSrc as $umSpec) {
                $extern_id = $umSpec->extern_id;
                $extern_nama = $umSpec->extern_nama;
                $po_id = $umSpec->extern2_id;
                $po_nomer = $umSpec->extern2_nama;
                $um_id = $umSpec->transaksi_id;
                $um_nomer = $umSpec->nomer;
                $um_sisa = $umSpec->sisa;
                $id_tbl = $umSpec->id;

                if (array_key_exists($po_id, $arrUM_ref_saldo)) {
//                    cekHere("update pym uang muka source dari $um_sisa ke " . $arrUM_ref_saldo[$po_id]["debet"]);
                    $selisih = $arrUM_ref_saldo[$po_id]["debet"] - $um_sisa;
                    $selisih = ($selisih < 0) ? ($selisih * -1) : $selisih;
                    if ($selisih > 100) {
                        cekHere("[$po_id] [$po_nomer] [pymSrc: $um_sisa] [selisih: $selisih] || " . $arrUM_ref_saldo[$po_id]["debet"]);

                        $data = array(
                            "sisa" => $arrUM_ref_saldo[$po_id]["debet"],
                        );
                        $where = array(
                            "extern2_id" => $po_id,
                            "id" => $id_tbl,
                        );
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->updatePaymentSrc($where, $data);
                        showLast_query("orange");

                    }
                }

                $arrUM_data_cek[$po_id] = $um_sisa;

            }


        }

        if (sizeof($arrUM_ref_saldo) > 0) {
            foreach ($arrUM_ref_saldo as $po => $poSpec) {
                if ($poSpec["debet"] > 0) {
                    if (!array_key_exists($po, $arrUM_data_cek)) {
                        cekOrange("[$po], saldo: " . $poSpec["debet"] . ", trid: " . $poSpec["transaksi_id"]);
                    }
                }
            }
        }

        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        cekHijau("<h3>...DONE...</h3>");

    }

    public
    function patchPreFakturPpnKeluaran()
    {
        $this->load->model("MdlTransaksi");

        $jenisTr = "9912";
        $reference_jenis = "5822spd";
        $jenisTr_2 = "110r";
        $arrTrID_pl = array();
        cekHere("PATCH PRE-EFAKTUR 110r dengan PL yang sudah dibatalkan. ");
        cekHere("PRE-EFAKTUR 110r diupdate trash_4=1, . ");

        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("reference_jenis='$reference_jenis'");
        $trTmp = $tr->lookUpAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $tr_id_5822spd = $trSpec->reference_id;
                $arrTrID_pl[$tr_id_5822spd] = $tr_id_5822spd;
            }
//            arrPrintCyan($arrTrID_pl);

            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("jenis='$jenisTr_2'");
            $tr->addFilter("reference_id in ('" . implode("','", $arrTrID_pl) . "')");
            $trTmp = $tr->lookUpAll()->result();
            showLast_query("biru");
            if (sizeof($trTmp) > 0) {
                $trIDUpdate = array();
                $no = 0;
                foreach ($trTmp as $trTmpSpec) {
                    $no++;
//                    cekHere("$no ---- " . $trTmpSpec->jenis . " ## " . $trTmpSpec->id);
                    $trIDUpdate[$trTmpSpec->id] = $trTmpSpec->id;
                }
                if (sizeof($trIDUpdate) > 0) {
                    foreach ($trIDUpdate as $trid) {
                        $where = array(
                            "id" => $trid
                        );
                        $data = array(
                            "trash_4" => 1,
                            "deskripsi" => "rejection",
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                            "cancel_name" => "SYSTEM",
                            "cancel_id" => -100,
                        );
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->updateData($where, $data);
                        showLast_query("orange");
                    }
                }
            }
        }


        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>SELESAI...</h3>");


    }

    public
    function patchPreFakturPpnKeluaranReference()
    {
        header("refresh:1");

        $this->load->model("MdlTransaksi");

        $jenisTr = "110r";
//        $reference_jenis = "5822spd";


        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("reference_id is NULL");
        $tr->setSortBy(array("mode" => "ASC", "kolom" => "id"));
        $this->db->limit(1);
        $trTmp = $tr->lookUpAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
            $transaksi_id = $trTmp[0]->id;
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id='$transaksi_id'");
            $trReg = $tr->lookupDataRegistries()->result();
            $main = blobDecode($trReg[0]->main);
//            arrPrintCyan($main);
            $refID = 0;
            $refNomer = $main["efaktur_source"];

            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("nomer='$refNomer'");
            $trTmp = $tr->lookUpAll()->result();
            $refID = $trTmp[0]->id;


            $data = array(
                "reference_id" => $refID,
                "reference_nomer" => $refNomer,
            );
            $where = array(
                "id" => $transaksi_id,
            );
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->updateData($where, $data);
            showLast_query("orange");

        }
        else {
            mati_disini("HABIS...");
        }

//        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>SELESAI...</h3>");


    }

    public
    function patchPreFakturPpnKeluaranFaktur()
    {
        header("refresh:1");

        $this->load->model("MdlTransaksi");

        $jenisTr = "110e";
//        $reference_jenis = "5822spd";


        $this->db->trans_start();


        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("jenis='$jenisTr'");
        $tr->addFilter("efaktur is NULL");
        $tr->setSortBy(array("mode" => "ASC", "kolom" => "id"));
        $this->db->limit(1);
        $trTmp = $tr->lookUpAll()->result();
        showLast_query("biru");
        if (sizeof($trTmp) > 0) {
            $transaksi_id = $trTmp[0]->id;
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id='$transaksi_id'");
            $trReg = $tr->lookupDataRegistries()->result();
            $main = blobDecode($trReg[0]->main);
//            arrPrintCyan($main);
            $eFaktur = (strlen($main["eFaktur"]) > 0) ? $main["eFaktur"] : 0;
            $dateFaktur = $main["dateFaktur"];
            $dpp_ppn = $main["dpp_ppn"];
            $new_grand_ppn = $main["new_grand_ppn"];
            $grandTotal = $main["grandTotal"];


            $data = array(
                "efaktur" => $eFaktur,
                "efaktur_dtime" => $dateFaktur,
                "transaksi_nilai" => $dpp_ppn,
                "ppn_nilai" => $new_grand_ppn,
                "transaksi_net" => $grandTotal,
            );
            $where = array(
                "id" => $transaksi_id,
            );
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->updateData($where, $data);
            showLast_query("orange");

        }
        else {
            mati_disini("HABIS...");
        }

//        mati_disini(__LINE__ . " SETOP...");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>SELESAI...</h3>");


    }

//-------------------------
    public
    function patchSubGrn()
    {
        header("refresh:2");

        $this->load->model("MdlTransaksi");

//        $target_jenis = array("483");
//        $target_jenis = array("462", "1462");
        $target_jenis = array("489", "487", "483");

        $tr = New MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("sisa>0");
//        $tr->addFilter("target_jenis='$target_jenis'");
        $tr->addFilter("target_jenis in ('" . implode("','", $target_jenis) . "')");
        $tr->addFilter("cek='0'");
        $this->db->limit(1);
        $this->db->order_by("id", "ASC");
        $trPym = $tr->lookUpAllPaymentSrc()->result();
        showLast_query("biru");
        cekBiru(count($trPym));

        $this->db->trans_start();

        if (sizeof($trPym) > 0) {
            foreach ($trPym as $trPymSpec) {
                $id_tbl = $trPymSpec->id;
                $nilai = $trPymSpec->sisa;
                $extern_id = $trPymSpec->extern_id;
                $extern_nama = $trPymSpec->extern_nama;
                $transaksi_id = $trPymSpec->transaksi_id;
                $transaksi_nomer = $trPymSpec->nomer;
                $jenis = $trPymSpec->jenis;
                $dtime = $trPymSpec->dtime;
                $fulldate = $trPymSpec->fulldate;
                $cabang_id = $trPymSpec->cabang_id;
                $cabang_nama = $trPymSpec->cabang_nama;

                $patch = array(
                    "comName" => "ComRekeningPembantuSubSupplier",
                    "loop" => array(
//                        "2010040" => $nilai,//hutang biaya
                        "2010010" => $nilai,//hutang dagang
                    ),
                    "static" => array(
                        "cabang_id" => $cabang_id,
                        "extern_id" => $transaksi_id,
                        "extern_nama" => $transaksi_nomer,
                        "extern2_id" => $extern_id,
                        "extern2_nama" => $extern_nama,
                        "jenis" => $jenis,
                        "transaksi_id" => $transaksi_id,
                        "transaksi_no" => $transaksi_nomer,
                        "dtime" => $dtime,
                        "fulldate" => $fulldate,
                    ),
                );
                arrPrint($patch);

                $this->load->model("Coms/" . $patch["comName"]);
                $com = New $patch["comName"]();
                $com->pair($patch);
                $com->exec();


                $pym_data = array(
                    "cek" => 1,
                );
                $pym_where = array(
                    "id" => $id_tbl,
                );
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->updatePaymentSrc($pym_where, $pym_data);
                showLast_query("orange");

//                break;
            }
        }


//        mati_disini(__LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>...DONE...</h3>");

    }


    public
    function rebuildMutasiMasterDebet()
    {
        // __rek_pembantu_antarcabang__piutang_cabang


        $this->db->trans_begin();


        $cabangID = "-1";
        $gudangID = "-1";
        $periode = "forever";
        $tahun = "2025";

        $this->load->model("Mdls/MdlFifoAverage");
        $this->load->model("Coms/ComRekeningPembantuHpp");
        $crd = New ComRekeningPembantuHpp();
        $tbl = "__rek_master__5030";
        $tbl_cache = "_rek_pembantu_subbiayausaha_cache";
        $this->load->model("Mdls/MdlProduk");
        //---------------------------------------------------------------


//        $md->setFilters(array());
//        $md->addFilter("id in ('" . implode("','", $externIDs) . "')");
//        $mdTmp = $md->lookupAll()->result();
//        $externIDs = array();
//        foreach ($mdTmp as $mdSpec) {
//            $externIDs[$mdSpec->id] = $mdSpec->id;
//        }

        $var_tbl = "";
        $contensCache = array();
        $condites = array(
//            "date(fulldate)>=" => "2025-01-01",
            "cabang_id" => $cabangID,
            "id>=" => 11691,

        );
        $crd->setTableName($tbl);
        $contens_0 = $crd->lookupByCondition($condites)->result();
        showLast_query("lime");
//            mati_disini(__LINE__);
//            cekOrange(sizeof($contens_0));
        $contens = array();
        if (sizeof($contens_0) > 0) {
            foreach ($contens_0 as $ix => $item) {
                if ($ix == 0) {
//                        $firs_debet_awal = $item->debet_akhir * 1;
//                    $firs_debet_awal = $item->debet * 1;
//                    $firs_qtydebet_awal = $item->qty_debet_awal * 1;

                    $firs_debet_awal = $item->debet_akhir * 1;
//                    $firs_debet_awal = $item->debet * 1;
                    $firs_qtydebet_awal = $item->qty_debet_akhir * 1;

                    $data_yg_bener["db_awal"] = 0;
                    $data_yg_bener["db_akhir"] = $firs_debet_awal;
                    $contens[$ix] = (array)$item + $data_yg_bener;
                }

                /* ----------------------------
                 * menyusun data untuk koreksi
                 * ----------------------------*/
                if ($ix > 0) {
                    $data_yg_bener["db_awal"] = $firs_debet_awal;
                    $db_akhir = $firs_debet_awal + $item->debet - $item->kredit;
                    $data_yg_bener["db_akhir"] = $db_akhir;
                    $contens[$ix] = (array)$item + $data_yg_bener;
                    $firs_debet_awal = $db_akhir;

                    $data_qtyyg_bener["db_qtyawal"] = $firs_qtydebet_awal;
                    $db_qtyakhir = $firs_qtydebet_awal + $item->qty_debet - $item->qty_kredit;
                    $data_qtyyg_bener["db_qtyakhir"] = $db_qtyakhir;

                    $contens[$ix] = $contens[$ix] + $data_qtyyg_bener;
                    $firs_qtydebet_awal = $db_qtyakhir;

                    $contensCache[$item->extern_id] = array(
                        "qty_debet" => $db_qtyakhir,
                        "debet" => $db_akhir,
                    );
                }
            }
        }

        $koloms = array(
            "id" => array(
                "label" => "id",
            ),
            "jenis" => array(
                "label" => "jenis",
            ),
            "transaksi_no" => array(
                "label" => "transaksi_no",
            ),
            "dtime" => array(
                "label" => "dtime",
            ),
            "extern_id" => array(
                "label" => "id biaya",
            ),
            "extern_nama" => array(
                "label" => "nama biaya",
            ),

            "debet_awal" => array(
                "label" => "debet_awal",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_awal" => array(
                "label" => "db_awal",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
            "debet" => array(
                "label" => "debet",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "kredit" => array(
                "label" => "kredit",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "debet_akhir" => array(
                "label" => "debet_akhir",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_akhir" => array(
                "label" => "db_akhir",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),

            "qty_debet_awal" => array(
                "label" => "qty debet_awal",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_qtyawal" => array(
                "label" => "qty db_awal",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
            "qty_debet" => array(
                "label" => "qty debet",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "qty_kredit" => array(
                "label" => "qty kredit",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "qty_debet_akhir" => array(
                "label" => "qty debet_akhir",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_qtyakhir" => array(
                "label" => "qty db_akhir",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
        );

        //region header table
        $var_head = "";
        $var_head .= "<tr class='bg-info'>";

        $kolom_params = reset($koloms);
        $attr_head = isset($kolom_params['attr_head']) ? $kolom_params['attr_head'] : "";
        $var_head .= "<th $attr_head width='20px;'>no</th>";

        foreach ($koloms as $kolom => $attrs) {
            $label = $attrs['label'];
            $attr = isset($attrs['attr_head']) ? $attrs['attr_head'] : "";

            $var_head .= "<th $attr>";
            $var_head .= $label;
            $var_head .= "</th>";
        }
        $var_head .= "</tr>";
        //endregion

        //region body table
        $var_body = "";
        if (sizeof($contens) > 0) {
            $no = 0;
            $totals = array();
            foreach ($contens as $var_body_id => $lsr_nama) {
                $dmain = (object)$lsr_nama;

                $no++;
                $var_body .= "<tr>";
                $var_body .= "<td class='text-right'>$no</td>";

                foreach ($koloms as $kolom => $attrs) {
                    $nilai = isset($dmain->$kolom) ? $dmain->$kolom : 0;

                    $attr = isset($attrs['attr']) ? $attrs['attr'] : "";
                    $format_key = isset($attrs['format_key']) ? $attrs['format_key'] : $kolom;
                    $nilai_f = isset($attrs['format']) ? $attrs['format']($format_key, $nilai) : $nilai;

                    $linking = isset($attrs['link']) ? $attrs['link'] . "/$var_body_id" : "";
                    $linkDetile = base_url() . $linking . "";
                    // $linkModal = modalDialogBtn("'$nama'", $linkDetile);
                    $nilai_link = isset($attrs['link']) ? "<a href='JavaScript:Void(0);' onclick=\"$linkModal\" title='lihat komposisi'>$nilai_f</a>" : $nilai_f;

                    $var_body .= "<td $attr>";
                    $var_body .= $nilai_link;
                    $var_body .= "</td>";

                    if (isset($attrs['summary'])) {
                        if (!isset($totals[$kolom])) {
                            $totals[$kolom] = 0;
                        }
                        $totals[$kolom] += $nilai;
                    }
                }
                $var_body .= "</tr>";

                /* ----------------------------
                 * eksekutor data ke database
                 * ----------------------------*/
                $updCondite = array(
                    "id" => $dmain->id,
                );
                $updData = array(
                    "debet_awal" => $dmain->db_awal,
                    "debet_akhir" => $dmain->db_akhir,
                    "qty_debet_awal" => $dmain->db_qtyawal,
                    "qty_debet_akhir" => $dmain->db_qtyakhir,
                );
                $crd->updateData($updCondite, $updData);
//                showLast_query("kuning");
                // break;
                // --------------------------------------------------done
            }
        }
        else {
//                $var_body .= tplNoData("2");
            $var_body .= "";
        }
        //endregion

        //region footer table
        $var_foot = "";
        $var_foot .= "<tr class='bg-danger'>";
        $var_foot .= "<th></th>";
        foreach ($koloms as $kolom => $attrs) {
            $fNilai = isset($totals[$kolom]) ? $totals[$kolom] : "-";
            $fNilai_f = isset($attrs['format']) ? $attrs['format']($kolom, $fNilai) : $fNilai;
            // $label = $attrs['label'];

            $var_foot .= "<th>";
            $var_foot .= $fNilai_f;
            $var_foot .= "</th>";
        }
        //endregion

        // ---------------
        $str_tbl_id = "";
        $var_tbl .= "<br>";
        $var_tbl .= "<div class='table-responsive'>";
        $var_tbl .= "<table class='table table-condensed table-striped' $str_tbl_id border='1' rules='all'>";
        $var_tbl .= "<thead>";
        $var_tbl .= $var_head;
        $var_tbl .= "</thead>";

        $var_tbl .= "<tbody>";
        $var_tbl .= $var_body;
        $var_tbl .= "</tbody>";

        // cekBiru(sizeof($totals));
        if (isset($totals) && is_array($totals) && sizeof($totals) > 0) {

            $var_tbl .= "<tfoot>";
            $var_tbl .= $var_foot;
            $var_tbl .= "</tfoot>";
        }

        $var_tbl .= "</table>";
        $var_tbl .= "</div>";
        echo $var_tbl;
//        arrPrintPink($contensCache);
        //--------------
        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            if (sizeof($contensCache) > 0) {
                foreach ($contensCache as $pid => $pSpec) {
                    $crd->setFilters(array());
                    $where = array(
                        "cabang_id" => $cabangID,
//                        "gudang_id" => $gudangID,
                        "periode" => $periode,
                        "extern_id" => $pid,
                        "rekening" => 6010,
                    );
                    $data = array(
                        "debet" => $pSpec["debet"],
                        "qty_debet" => $pSpec["qty_debet"],
                    );
                    $crd->setTableName($tbl_cache);
                    $crd->updateData($where, $data);
                    showLast_query("orange");

//                    $fmd->setFilters(array());
//                    $whereff = array(
//                        "cabang_id" => $cabangID,
//                        "gudang_id" => $gudangID,
//                        "produk_id" => $pid,
//                    );
//                    $dataff = array(
//                        "jml" => $pSpec["qty_debet"],
//                        "hpp" => $pSpec["debet"] / $pSpec["qty_debet"],
//                        "jml_nilai" => $pSpec["debet"],
//                    );
//                    $fmd->updateData($whereff, $dataff);
//                    showLast_query("orange");
                }
            }
        }
        //--------------

//        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @" . __LINE__);
    }

    public
    function rebuildMutasiMasterKredit()
    {
        $this->db->trans_begin();


        $cabangID = "-1";
        $gudangID = "-1";
        $periode = "forever";
        $tahun = "2023";
//        $externID = "23414";
        $rekening = "2040010";
        $rekening2 = "4030030";
        $externIDs = array(
            "4030030",
//            "3451",
//            "23414",
//            "1607",
//            "1707",
//            "3240",
//            "1680",
//            "1697",
//            "1704",
//            "1685",
//            "1714",
//            "954",
//            "982",
//            "1708",
//            "964",
//            "1628",
//            "1671",
//            "1022",
//            "975",
//            "1613",
//            "1688",
//            "55",
//            "1705",
//            "58",
//            "1715",
//            "227",
//            "944",
//            "992",
//            "1706",
//            "3237",
//            "42",
//            "1534",
//            "1727",
//            "230",
//            "51",
//            "951",
//            "54",
//            "1011",
//            "233",
//            "76",
//            "251",
//            "1604",
//            "64",
//            "1531",
//            "236",
//            "1019",
//            "67",
//            "239",
//            "1681",
//            "175",
//            "940",
//            "178",
//            "960",
//            "1001",
//            "98",
//            "133",
//            "70",
//            "181",
//            "3310",
//            "112",
//            "45",
//            "109",
//            "1731",
//            "1006",
//            "1625",
//            "971",
//            "92",
//            "242",
//            "184",
//            "124",
//            "3313",
//            "1519",
//            "1674",
//            "1528",
//            "1517",
//            "48",
//            "187",
//            "196",
//            "1652",
//            "1649",
//            "245",
//            "190",
//            "3374",
//            "224",
//            "1526",
//            "73",
//            "1658",
//            "207",
//            "2133",
//            "3504",
//            "1662",
//            "1737",
//            "3322",
//            "3365",
//            "3368",
//            "3265",
        );
        //---------------------------------------------------------------
        $this->load->model("Coms/ComRekeningPembantuCustomer");
        $crd = New ComRekeningPembantuCustomer();
        $tbl = "__rek_master__7010200";
        $tbl_cache = "_rek_pembantu_customer_cache";
        $this->load->model("Mdls/MdlCustomer");
        $md = New MdlCustomer();
        //---------------------------------------------------------------

        $var_tbl = "";
        $contensCache = array();
        $condites = array(
            "cabang_id" => $cabangID,
//            "extern_id" => $externID,
            "rekening" => $rekening,
//            "id>=" => 177,
        );
        $crd->setTableName($tbl);
        $contens_0 = $crd->lookupByCondition($condites)->result();
        showLast_query("lime");
        $contens = array();
        if (sizeof($contens_0) > 0) {
            foreach ($contens_0 as $ix => $item) {
                if ($ix == 0) {
//                        $firs_debet_awal = $item->debet_akhir * 1;
                    $firs_debet_awal = $item->kredit * 1;
//                    $firs_qtydebet_awal = $item->qty_kredit * 1;
                    $firs_qtydebet_awal = $item->qty_kredit_akhir * 1;

                    $data_yg_bener["db_awal"] = 0;
                    $data_yg_bener["db_akhir"] = $firs_debet_awal;
                    $contens[$ix] = (array)$item + $data_yg_bener;
                }

                /* ----------------------------
                 * menyusun data untuk koreksi
                 * ----------------------------*/
                if ($ix > 0) {
                    $data_yg_bener["db_awal"] = $firs_debet_awal;
                    $db_akhir = $firs_debet_awal + $item->kredit - $item->debet;
                    $data_yg_bener["db_akhir"] = $db_akhir;
                    $contens[$ix] = (array)$item + $data_yg_bener;
                    $firs_debet_awal = $db_akhir;

                    $data_qtyyg_bener["db_qtyawal"] = $firs_qtydebet_awal;
                    $db_qtyakhir = $firs_qtydebet_awal + $item->qty_kredit - $item->qty_debet;
                    $data_qtyyg_bener["db_qtyakhir"] = $db_qtyakhir;
//                        $contens[$ix] = (array)$item + $data_qtyyg_bener;
                    $contens[$ix] = $contens[$ix] + $data_qtyyg_bener;
                    $firs_qtydebet_awal = $db_qtyakhir;

                    $contensCache[$item->extern_id] = array(
                        "qty_debet" => $db_qtyakhir,
                        "debet" => $db_akhir,
                    );
                }
            }
        }
        else {

        }

        $koloms = array(
            "id" => array(
                "label" => "id",
            ),
            "jenis" => array(
                "label" => "jenis",
            ),
            "transaksi_no" => array(
                "label" => "transaksi_no",
            ),
            "dtime" => array(
                "label" => "dtime",
            ),
            "extern_id" => array(
                "label" => "id biaya",
            ),
            "extern_nama" => array(
                "label" => "nama biaya",
            ),

            "debet_awal" => array(
                "label" => "debet_awal",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_awal" => array(
                "label" => "db_awal",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
            "debet" => array(
                "label" => "debet",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "kredit" => array(
                "label" => "kredit",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "debet_akhir" => array(
                "label" => "debet_akhir",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_akhir" => array(
                "label" => "db_akhir",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),

            "qty_debet_awal" => array(
                "label" => "qty debet_awal",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_qtyawal" => array(
                "label" => "qty db_awal",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
            "qty_debet" => array(
                "label" => "qty debet",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "qty_kredit" => array(
                "label" => "qty kredit",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "qty_debet_akhir" => array(
                "label" => "qty debet_akhir",
                "format" => "formatField",
                "attr" => "align='right'",
                "attr_head" => "width='100px'",
            ),
            "db_qtyakhir" => array(
                "label" => "qty db_akhir",
                "format" => "formatField",
                "attr" => "align='right' style='color:red;'",
                "attr_head" => "width='100px'",
            ),
        );

        //region header table
        $var_head = "";
        $var_head .= "<tr class='bg-info'>";

        $kolom_params = reset($koloms);
        $attr_head = isset($kolom_params['attr_head']) ? $kolom_params['attr_head'] : "";
        $var_head .= "<th $attr_head width='20px;'>no</th>";

        foreach ($koloms as $kolom => $attrs) {
            $label = $attrs['label'];
            $attr = isset($attrs['attr_head']) ? $attrs['attr_head'] : "";

            $var_head .= "<th $attr>";
            $var_head .= $label;
            $var_head .= "</th>";
        }
        $var_head .= "</tr>";
        //endregion

        //region body table
        $var_body = "";
        if (sizeof($contens) > 0) {
            $no = 0;
            $totals = array();

            foreach ($contens as $var_body_id => $lsr_nama) {
                $dmain = (object)$lsr_nama;

                $no++;
                $var_body .= "<tr>";
                $var_body .= "<td class='text-right'>$no</td>";

                foreach ($koloms as $kolom => $attrs) {
                    $nilai = isset($dmain->$kolom) ? $dmain->$kolom : 0;

                    $attr = isset($attrs['attr']) ? $attrs['attr'] : "";
                    $format_key = isset($attrs['format_key']) ? $attrs['format_key'] : $kolom;
                    $nilai_f = isset($attrs['format']) ? $attrs['format']($format_key, $nilai) : $nilai;

                    $linking = isset($attrs['link']) ? $attrs['link'] . "/$var_body_id" : "";
                    $linkDetile = base_url() . $linking . "";
                    // $linkModal = modalDialogBtn("'$nama'", $linkDetile);
                    $nilai_link = isset($attrs['link']) ? "<a href='JavaScript:Void(0);' onclick=\"$linkModal\" title='lihat komposisi'>$nilai_f</a>" : $nilai_f;

                    $var_body .= "<td $attr>";
                    $var_body .= $nilai_link;
                    $var_body .= "</td>";

                    if (isset($attrs['summary'])) {
                        if (!isset($totals[$kolom])) {
                            $totals[$kolom] = 0;
                        }
                        $totals[$kolom] += $nilai;
                    }
                }
                $var_body .= "</tr>";

                /* ----------------------------
                 * eksekutor data ke database
                 * ----------------------------*/
                $updCondite = array(
                    "id" => $dmain->id,
                );
                $updData = array(
                    "kredit_awal" => $dmain->db_awal,
                    "kredit_akhir" => $dmain->db_akhir,
                    "qty_kredit_awal" => $dmain->db_qtyawal,
                    "qty_kredit_akhir" => $dmain->db_qtyakhir,
                );
                $crd->updateData($updCondite, $updData);
                showLast_query("kuning");
                // break;
                // --------------------------------------------------done
            }
        }
        else {
//                $var_body .= tplNoData("2");
            $var_body .= "";
        }
        //endregion

        //region footer table
        $var_foot = "";
        $var_foot .= "<tr class='bg-danger'>";
        $var_foot .= "<th></th>";
        foreach ($koloms as $kolom => $attrs) {
            $fNilai = isset($totals[$kolom]) ? $totals[$kolom] : "-";
            $fNilai_f = isset($attrs['format']) ? $attrs['format']($kolom, $fNilai) : $fNilai;
            // $label = $attrs['label'];

            $var_foot .= "<th>";
            $var_foot .= $fNilai_f;
            $var_foot .= "</th>";
        }
        //endregion

        // ---------------
        $str_tbl_id = "";
        $var_tbl .= "<br>";
        $var_tbl .= "<div class='table-responsive'>";
        $var_tbl .= "<table class='table table-condensed table-striped' $str_tbl_id border='1' rules='all'>";
        $var_tbl .= "<thead>";
        $var_tbl .= $var_head;
        $var_tbl .= "</thead>";

        $var_tbl .= "<tbody>";
        $var_tbl .= $var_body;
        $var_tbl .= "</tbody>";

        // cekBiru(sizeof($totals));
        if (isset($totals) && is_array($totals) && sizeof($totals) > 0) {

            $var_tbl .= "<tfoot>";
            $var_tbl .= $var_foot;
            $var_tbl .= "</tfoot>";
        }

        $var_tbl .= "</table>";
        $var_tbl .= "</div>";
//        foreach ($externIDs as $externID) {
//        }
        echo $var_tbl;


//        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @ DONE " . __LINE__);
    }

    public
    function rebuildMutasiDetailKredit()
    {
        $this->db->trans_begin();


        $cabangID = "1";
        $gudangID = "-1";
        $periode = "forever";
        $tahun = "2023";
//        $externID = "23414";
        $rekening = "4030";
        $rekening2 = "4030030";
        $externIDs = array(
            "4030030",
//            "3451",
//            "23414",
//            "1607",
//            "1707",
//            "3240",
//            "1680",
//            "1697",
//            "1704",
//            "1685",
//            "1714",
//            "954",
//            "982",
//            "1708",
//            "964",
//            "1628",
//            "1671",
//            "1022",
//            "975",
//            "1613",
//            "1688",
//            "55",
//            "1705",
//            "58",
//            "1715",
//            "227",
//            "944",
//            "992",
//            "1706",
//            "3237",
//            "42",
//            "1534",
//            "1727",
//            "230",
//            "51",
//            "951",
//            "54",
//            "1011",
//            "233",
//            "76",
//            "251",
//            "1604",
//            "64",
//            "1531",
//            "236",
//            "1019",
//            "67",
//            "239",
//            "1681",
//            "175",
//            "940",
//            "178",
//            "960",
//            "1001",
//            "98",
//            "133",
//            "70",
//            "181",
//            "3310",
//            "112",
//            "45",
//            "109",
//            "1731",
//            "1006",
//            "1625",
//            "971",
//            "92",
//            "242",
//            "184",
//            "124",
//            "3313",
//            "1519",
//            "1674",
//            "1528",
//            "1517",
//            "48",
//            "187",
//            "196",
//            "1652",
//            "1649",
//            "245",
//            "190",
//            "3374",
//            "224",
//            "1526",
//            "73",
//            "1658",
//            "207",
//            "2133",
//            "3504",
//            "1662",
//            "1737",
//            "3322",
//            "3365",
//            "3368",
//            "3265",
        );
        //---------------------------------------------------------------
        $this->load->model("Coms/ComRekeningPembantuCustomer");
        $crd = New ComRekeningPembantuCustomer();
        $tbl = "__rek_pembantu_penjualan__4030";
        $tbl_cache = "_rek_pembantu_customer_cache";
        $this->load->model("Mdls/MdlCustomer");
        $md = New MdlCustomer();
        //---------------------------------------------------------------


//        $md->setFilters(array());
//        $md->addFilter("id in ('" . implode("','", $externIDs) . "')");
//        $mdTmp = $md->lookupAll()->result();
//        $externIDs = array();
//        foreach ($mdTmp as $mdSpec) {
//            $externIDs[$mdSpec->id] = $mdSpec->id;
//        }

        $var_tbl = "";
        $contensCache = array();
        foreach ($externIDs as $externID) {
            $condites = array(
                "cabang_id" => $cabangID,
                "extern_id" => $externID,
                "rekening" => $rekening,
                "id>=" => 177,
            );
            $crd->setTableName($tbl);
            $contens_0 = $crd->lookupByCondition($condites)->result();
            showLast_query("lime");
//            cekOrange(sizeof($contens_0));
            $contens = array();
            if (sizeof($contens_0) > 0) {
                foreach ($contens_0 as $ix => $item) {
                    if ($ix == 0) {
//                        $firs_debet_awal = $item->debet_akhir * 1;
                        $firs_debet_awal = $item->kredit * 1;
                        $firs_qtydebet_awal = $item->qty_kredit * 1;
                    }

                    /* ----------------------------
                     * menyusun data untuk koreksi
                     * ----------------------------*/
                    if ($ix > 0) {
                        $data_yg_bener["db_awal"] = $firs_debet_awal;
                        $db_akhir = $firs_debet_awal + $item->kredit - $item->debet;
                        $data_yg_bener["db_akhir"] = $db_akhir;
                        $contens[$ix] = (array)$item + $data_yg_bener;
                        $firs_debet_awal = $db_akhir;

                        $data_qtyyg_bener["db_qtyawal"] = $firs_qtydebet_awal;
                        $db_qtyakhir = $firs_qtydebet_awal + $item->qty_kredit - $item->qty_debet;
                        $data_qtyyg_bener["db_qtyakhir"] = $db_qtyakhir;
//                        $contens[$ix] = (array)$item + $data_qtyyg_bener;
                        $contens[$ix] = $contens[$ix] + $data_qtyyg_bener;
                        $firs_qtydebet_awal = $db_qtyakhir;

                        $contensCache[$item->extern_id] = array(
                            "qty_debet" => $db_qtyakhir,
                            "debet" => $db_akhir,
                        );
                    }
                }
            }
            else {

            }

            $koloms = array(
                "id" => array(
                    "label" => "id",
                ),
                "jenis" => array(
                    "label" => "jenis",
                ),
                "transaksi_no" => array(
                    "label" => "transaksi_no",
                ),
                "dtime" => array(
                    "label" => "dtime",
                ),
                "extern_id" => array(
                    "label" => "id biaya",
                ),
                "extern_nama" => array(
                    "label" => "nama biaya",
                ),

                "debet_awal" => array(
                    "label" => "debet_awal",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_awal" => array(
                    "label" => "db_awal",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
                "debet" => array(
                    "label" => "debet",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "kredit" => array(
                    "label" => "kredit",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "debet_akhir" => array(
                    "label" => "debet_akhir",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_akhir" => array(
                    "label" => "db_akhir",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),

                "qty_debet_awal" => array(
                    "label" => "qty debet_awal",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_qtyawal" => array(
                    "label" => "qty db_awal",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
                "qty_debet" => array(
                    "label" => "qty debet",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "qty_kredit" => array(
                    "label" => "qty kredit",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "qty_debet_akhir" => array(
                    "label" => "qty debet_akhir",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_qtyakhir" => array(
                    "label" => "qty db_akhir",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
            );

            //region header table
            $var_head = "";
            $var_head .= "<tr class='bg-info'>";

            $kolom_params = reset($koloms);
            $attr_head = isset($kolom_params['attr_head']) ? $kolom_params['attr_head'] : "";
            $var_head .= "<th $attr_head width='20px;'>no</th>";

            foreach ($koloms as $kolom => $attrs) {
                $label = $attrs['label'];
                $attr = isset($attrs['attr_head']) ? $attrs['attr_head'] : "";

                $var_head .= "<th $attr>";
                $var_head .= $label;
                $var_head .= "</th>";
            }
            $var_head .= "</tr>";
            //endregion

            //region body table
            $var_body = "";
            if (sizeof($contens) > 0) {
                $no = 0;
                $totals = array();

                foreach ($contens as $var_body_id => $lsr_nama) {
                    $dmain = (object)$lsr_nama;

                    $no++;
                    $var_body .= "<tr>";
                    $var_body .= "<td class='text-right'>$no</td>";

                    foreach ($koloms as $kolom => $attrs) {
                        $nilai = isset($dmain->$kolom) ? $dmain->$kolom : 0;

                        $attr = isset($attrs['attr']) ? $attrs['attr'] : "";
                        $format_key = isset($attrs['format_key']) ? $attrs['format_key'] : $kolom;
                        $nilai_f = isset($attrs['format']) ? $attrs['format']($format_key, $nilai) : $nilai;

                        $linking = isset($attrs['link']) ? $attrs['link'] . "/$var_body_id" : "";
                        $linkDetile = base_url() . $linking . "";
                        // $linkModal = modalDialogBtn("'$nama'", $linkDetile);
                        $nilai_link = isset($attrs['link']) ? "<a href='JavaScript:Void(0);' onclick=\"$linkModal\" title='lihat komposisi'>$nilai_f</a>" : $nilai_f;

                        $var_body .= "<td $attr>";
                        $var_body .= $nilai_link;
                        $var_body .= "</td>";

                        if (isset($attrs['summary'])) {
                            if (!isset($totals[$kolom])) {
                                $totals[$kolom] = 0;
                            }
                            $totals[$kolom] += $nilai;
                        }
                    }
                    $var_body .= "</tr>";

                    /* ----------------------------
                     * eksekutor data ke database
                     * ----------------------------*/
                    $updCondite = array(
                        "id" => $dmain->id,
                    );
                    $updData = array(
                        "kredit_awal" => $dmain->db_awal,
                        "kredit_akhir" => $dmain->db_akhir,
                        "qty_kredit_awal" => $dmain->db_qtyawal,
                        "qty_kredit_akhir" => $dmain->db_qtyakhir,
                    );
                    $crd->updateData($updCondite, $updData);
                    showLast_query("kuning");
                    // break;
                    // --------------------------------------------------done
                }
            }
            else {
//                $var_body .= tplNoData("2");
                $var_body .= "";
            }
            //endregion

            //region footer table
            $var_foot = "";
            $var_foot .= "<tr class='bg-danger'>";
            $var_foot .= "<th></th>";
            foreach ($koloms as $kolom => $attrs) {
                $fNilai = isset($totals[$kolom]) ? $totals[$kolom] : "-";
                $fNilai_f = isset($attrs['format']) ? $attrs['format']($kolom, $fNilai) : $fNilai;
                // $label = $attrs['label'];

                $var_foot .= "<th>";
                $var_foot .= $fNilai_f;
                $var_foot .= "</th>";
            }
            //endregion

            // ---------------
            $str_tbl_id = "";
            $var_tbl .= "<br>";
            $var_tbl .= "<div class='table-responsive'>";
            $var_tbl .= "<table class='table table-condensed table-striped' $str_tbl_id border='1' rules='all'>";
            $var_tbl .= "<thead>";
            $var_tbl .= $var_head;
            $var_tbl .= "</thead>";

            $var_tbl .= "<tbody>";
            $var_tbl .= $var_body;
            $var_tbl .= "</tbody>";

            // cekBiru(sizeof($totals));
            if (isset($totals) && is_array($totals) && sizeof($totals) > 0) {

                $var_tbl .= "<tfoot>";
                $var_tbl .= $var_foot;
                $var_tbl .= "</tfoot>";
            }

            $var_tbl .= "</table>";
            $var_tbl .= "</div>";
        }
        echo $var_tbl;
//        arrPrintPink($contensCache);
        //--------------
//        if (sizeof($contensCache) > 0) {
//            foreach ($contensCache as $pid => $pSpec) {
//                $crd->setFilters(array());
//                $where = array(
//                    "cabang_id" => $cabangID,
//                    "gudang_id" => $gudangID,
//                    "periode" => $periode,
//                    "extern_id" => $pid,
//                );
//                $data = array(
//                    "debet" => $pSpec["debet"],
//                    "qty_debet" => $pSpec["qty_debet"],
//                );
//                $crd->setTableName($tbl_cache);
//                $crd->updateData($where, $data);
//                showLast_query("orange");
//            }
//        }
        //--------------

//        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @ DONE " . __LINE__);
    }

    public
    function rebuildMutasiDetailDebet()
    {
        $this->db->trans_begin();


        $cabangID = "-1";
        $gudangID = "-1";
        $periode = "forever";
        $tahun = "2023";
//        $externID = "23414";
        $rekening = "1010010010";
//        $rekening2 = "4030030";
        $externIDs = array(
            "1160",
        );
        //---------------------------------------------------------------
        $this->load->model("Coms/ComRekeningPembantuCustomer");
        $crd = New ComRekeningPembantuCustomer();
        $tbl = "__rek_pembantu_subkas__1010010010";
//        $tbl_cache = "_rek_pembantu_customer_cache";
        $this->load->model("Mdls/MdlCustomer");
        $md = New MdlCustomer();
        //---------------------------------------------------------------


        $var_tbl = "";
        $contensCache = array();
        foreach ($externIDs as $externID) {
            $condites = array(
                "cabang_id" => $cabangID,
                "extern_id" => $externID,
                "rekening" => $rekening,
                "id>=" => 68503,
            );
            $crd->setTableName($tbl);
            $contens_0 = $crd->lookupByCondition($condites)->result();
            showLast_query("lime");
//            cekOrange(sizeof($contens_0));
            $contens = array();
            if (sizeof($contens_0) > 0) {
                foreach ($contens_0 as $ix => $item) {
                    if ($ix == 0) {
//                        $firs_debet_awal = $item->debet_akhir * 1;
                        $firs_debet_awal = $item->debet_akhir * 1;
                        $firs_qtydebet_awal = $item->qty_debet_akhir * 1;
                    }

                    /* ----------------------------
                     * menyusun data untuk koreksi
                     * ----------------------------*/
                    if ($ix > 0) {
                        $data_yg_bener["db_awal"] = $firs_debet_awal;
                        $db_akhir = $firs_debet_awal + $item->debet - $item->kredit;
                        $data_yg_bener["db_akhir"] = $db_akhir;
                        $contens[$ix] = (array)$item + $data_yg_bener;
                        $firs_debet_awal = $db_akhir;

                        $data_qtyyg_bener["db_qtyawal"] = $firs_qtydebet_awal;
                        $db_qtyakhir = $firs_qtydebet_awal + $item->qty_debet - $item->qty_kredit;
                        $data_qtyyg_bener["db_qtyakhir"] = $db_qtyakhir;
                        $contens[$ix] = $contens[$ix] + $data_qtyyg_bener;
                        $firs_qtydebet_awal = $db_qtyakhir;

                        $contensCache[$item->extern_id] = array(
                            "qty_debet" => $db_qtyakhir,
                            "debet" => $db_akhir,
                        );
                    }
                }
            }
            else {

            }

            $koloms = array(
                "id" => array(
                    "label" => "id",
                ),
                "jenis" => array(
                    "label" => "jenis",
                ),
                "transaksi_no" => array(
                    "label" => "transaksi_no",
                ),
                "dtime" => array(
                    "label" => "dtime",
                ),
                "extern_id" => array(
                    "label" => "id biaya",
                ),
                "extern_nama" => array(
                    "label" => "nama biaya",
                ),

                "debet_awal" => array(
                    "label" => "debet_awal",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_awal" => array(
                    "label" => "db_awal",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
                "debet" => array(
                    "label" => "debet",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "kredit" => array(
                    "label" => "kredit",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "debet_akhir" => array(
                    "label" => "debet_akhir",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_akhir" => array(
                    "label" => "db_akhir",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),

                "qty_debet_awal" => array(
                    "label" => "qty debet_awal",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_qtyawal" => array(
                    "label" => "qty db_awal",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
                "qty_debet" => array(
                    "label" => "qty debet",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "qty_kredit" => array(
                    "label" => "qty kredit",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "qty_debet_akhir" => array(
                    "label" => "qty debet_akhir",
                    "format" => "formatField",
                    "attr" => "align='right'",
                    "attr_head" => "width='100px'",
                ),
                "db_qtyakhir" => array(
                    "label" => "qty db_akhir",
                    "format" => "formatField",
                    "attr" => "align='right' style='color:red;'",
                    "attr_head" => "width='100px'",
                ),
            );

            //region header table
            $var_head = "";
            $var_head .= "<tr class='bg-info'>";

            $kolom_params = reset($koloms);
            $attr_head = isset($kolom_params['attr_head']) ? $kolom_params['attr_head'] : "";
            $var_head .= "<th $attr_head width='20px;'>no</th>";

            foreach ($koloms as $kolom => $attrs) {
                $label = $attrs['label'];
                $attr = isset($attrs['attr_head']) ? $attrs['attr_head'] : "";

                $var_head .= "<th $attr>";
                $var_head .= $label;
                $var_head .= "</th>";
            }
            $var_head .= "</tr>";
            //endregion

            //region body table
            $var_body = "";
            if (sizeof($contens) > 0) {
                $no = 0;
                $totals = array();

                foreach ($contens as $var_body_id => $lsr_nama) {
                    $dmain = (object)$lsr_nama;

                    $no++;
                    $var_body .= "<tr>";
                    $var_body .= "<td class='text-right'>$no</td>";

                    foreach ($koloms as $kolom => $attrs) {
                        $nilai = isset($dmain->$kolom) ? $dmain->$kolom : 0;

                        $attr = isset($attrs['attr']) ? $attrs['attr'] : "";
                        $format_key = isset($attrs['format_key']) ? $attrs['format_key'] : $kolom;
                        $nilai_f = isset($attrs['format']) ? $attrs['format']($format_key, $nilai) : $nilai;

                        $linking = isset($attrs['link']) ? $attrs['link'] . "/$var_body_id" : "";
                        $linkDetile = base_url() . $linking . "";
                        // $linkModal = modalDialogBtn("'$nama'", $linkDetile);
                        $nilai_link = isset($attrs['link']) ? "<a href='JavaScript:Void(0);' onclick=\"$linkModal\" title='lihat komposisi'>$nilai_f</a>" : $nilai_f;

                        $var_body .= "<td $attr>";
                        $var_body .= $nilai_link;
                        $var_body .= "</td>";

                        if (isset($attrs['summary'])) {
                            if (!isset($totals[$kolom])) {
                                $totals[$kolom] = 0;
                            }
                            $totals[$kolom] += $nilai;
                        }
                    }
                    $var_body .= "</tr>";

                    /* ----------------------------
                     * eksekutor data ke database
                     * ----------------------------*/
                    $updCondite = array(
                        "id" => $dmain->id,
                    );
                    $updData = array(
                        "debet_awal" => $dmain->db_awal,
                        "debet_akhir" => $dmain->db_akhir,
                        "qty_debet_awal" => $dmain->db_qtyawal,
                        "qty_debet_akhir" => $dmain->db_qtyakhir,
                    );
                    $crd->updateData($updCondite, $updData);
                    showLast_query("kuning");
                    // break;
                    // --------------------------------------------------done
                }
            }
            else {
//                $var_body .= tplNoData("2");
                $var_body .= "";
            }
            //endregion

            //region footer table
            $var_foot = "";
            $var_foot .= "<tr class='bg-danger'>";
            $var_foot .= "<th></th>";
            foreach ($koloms as $kolom => $attrs) {
                $fNilai = isset($totals[$kolom]) ? $totals[$kolom] : "-";
                $fNilai_f = isset($attrs['format']) ? $attrs['format']($kolom, $fNilai) : $fNilai;
                // $label = $attrs['label'];

                $var_foot .= "<th>";
                $var_foot .= $fNilai_f;
                $var_foot .= "</th>";
            }
            //endregion

            // ---------------
            $str_tbl_id = "";
            $var_tbl .= "<br>";
            $var_tbl .= "<div class='table-responsive'>";
            $var_tbl .= "<table class='table table-condensed table-striped' $str_tbl_id border='1' rules='all'>";
            $var_tbl .= "<thead>";
            $var_tbl .= $var_head;
            $var_tbl .= "</thead>";

            $var_tbl .= "<tbody>";
            $var_tbl .= $var_body;
            $var_tbl .= "</tbody>";

            // cekBiru(sizeof($totals));
            if (isset($totals) && is_array($totals) && sizeof($totals) > 0) {

                $var_tbl .= "<tfoot>";
                $var_tbl .= $var_foot;
                $var_tbl .= "</tfoot>";
            }

            $var_tbl .= "</table>";
            $var_tbl .= "</div>";
        }
        echo $var_tbl;


        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @ DONE " . __LINE__);
    }


    public function repairTransaksi585()
    {
        $this->load->model("MdlTransaksi");
        $jenis = "585";
        $cabangID = "-1";

        $this->db->trans_begin();

        $tr = New MdlTransaksi();
        $tr->addFilter("cabang_id='$cabangID'");
        $tr->addFilter("jenis='$jenis'");
        $trTmp = $tr->lookupAll()->result();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $idTbl = $trSpec->id;
                $gudangID = $trSpec->gudang_id;
                switch ($gudangID) {
                    case "-10":
                        $newCabangID = 1;
                        $newCabangNama = "CABANG 1";

                        $data = array(
                            "cabang_id" => $newCabangID,
                            "cabang_nama" => $newCabangNama,
                        );
                        $where = array(
                            "id" => $idTbl,
                        );
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->updateData($where, $data);
                        showLast_query("orange");
                        break;
                }
            }
        }

        mati_disini(__LINE__);
        $this->db->trans_complete() or mati_disini("gagal...");

        cekHitam(__FILE__ . " @ DONE " . __LINE__);
    }

    public function repairLockerDiskon()
    {
        $this->load->model("MdlTransaksi");
        $this->load->model("Mdls/MdlLockerStockDiskonVendor");
        $mlsd = New MdlLockerStockDiskonVendor();
        $supplierID = 11;
        $tbl = "stock_locker_diskon";
        $where = array(
            "nilai>" => 0,
            "supplier_id" => $supplierID,
        );
        $this->db->where($where);
        $this->db->group_by("transaksi_id");
        $getResult = $this->db->get($tbl)->result();
        showLast_query("biru");
        cekBiru(count($getResult));
        $arrTrID = array();
        $arrTrID_grn = array();
        $arrDataLockerSalah = array();
        foreach ($getResult as $getSpec) {
            $arrTrID[$getSpec->transaksi_id] = $getSpec->transaksi_id;
        }
        //--------
        $tr = New MdlTransaksi();
        $tr->addFilter("id in ('" . implode("','", $arrTrID) . "')");
        $tr->addFilter("jenis='467'");
        $trTmp = $tr->lookupAll()->result();
        showLast_query("biru");
        cekBiru(count($trTmp));
        $arrDataLocker = array();
        if (sizeof($trTmp) > 0) {
            foreach ($trTmp as $trSpec) {
                $trid = $trSpec->id;
                $arrTrID_grn[$trid] = $trid;

                $dtime = $trSpec->dtime;
                $trreg = New MdlTransaksi();
                $trreg->setFilters(array());
                $trreg->setJointSelectFields("transaksi_id, items");
                $trreg->addFilter("transaksi_id='$trid'");
                $tmpReg = $trreg->lookupDataRegistries()->result();
                $items = blobDecode($tmpReg[0]->items);
//                arrPrint($items);
//                if($trid == 429069){
//                    cekHere(count($items));
//                    arrPrintPink($items);
//                }
                foreach ($items as $pid => $pSpec) {
//                    $arrDataLocker[$trid][$pid] = array(
//                        "diskon_1_id" => $pSpec["diskon_1_id"],
//                        "diskon_1_nilai" => $pSpec["sub_diskon_1_nilai"],
//                        "diskon_2_id" => $pSpec["diskon_2_id"],
//                        "diskon_2_nilai" => $pSpec["sub_diskon_2_nilai"],
//                        "diskon_3_id" => $pSpec["diskon_3_id"],
//                        "diskon_3_nilai" => $pSpec["sub_diskon_3_nilai"],
//                        "diskon_4_id" => $pSpec["diskon_4_id"],
//                        "diskon_4_nilai" => $pSpec["sub_diskon_4_nilai"],
//                        "diskon_5_id" => $pSpec["diskon_5_id"],
//                        "diskon_5_nilai" => $pSpec["sub_diskon_5_nilai"],
//                        "diskon_6_id" => $pSpec["diskon_6_id"],
//                        "diskon_6_nilai" => $pSpec["sub_diskon_6_nilai"],
//                        "diskon_7_id" => $pSpec["diskon_7_id"],
//                        "diskon_7_nilai" => $pSpec["sub_diskon_7_nilai"],
//                        "diskon_8_id" => $pSpec["diskon_8_id"],
//                        "diskon_8_nilai" => $pSpec["sub_diskon_8_nilai"],
//                        "dtime" => $dtime,
//                    );
                    $arrDataLocker[$trid][$pid] = array(
                        "diskon_1_id" => $pSpec["diskon_1_id"],
                        "diskon_1_nilai" => $pSpec["sub_diskon_1_nilai"],
                        "diskon_2_id" => $pSpec["diskon_2_id"],
                        "diskon_2_nilai" => $pSpec["sub_diskon_2_nilai"],
                        "diskon_3_id" => $pSpec["diskon_3_id"],
                        "diskon_3_nilai" => $pSpec["sub_diskon_3_nilai"],
                        "diskon_4_id" => $pSpec["diskon_4_id"],
                        "diskon_4_nilai" => $pSpec["sub_diskon_4_nilai"],
                        "diskon_5_id" => $pSpec["diskon_5_id"],
                        "diskon_5_nilai" => $pSpec["sub_diskon_5_nilai"],
                        "diskon_6_id" => $pSpec["diskon_6_id"],
                        "diskon_6_nilai" => $pSpec["sub_diskon_6_nilai"],
                        "diskon_7_id" => $pSpec["diskon_7_id"],
                        "diskon_7_nilai" => $pSpec["sub_diskon_7_nilai"],
                        "diskon_8_id" => $pSpec["diskon_8_id"],
                        "diskon_8_nilai" => $pSpec["sub_diskon_8_nilai"],
                        "dtime" => $dtime,
                    );
                }
//                break;
            }
            $mlsd->setFilters(array());
            $mlsd->addFilter("transaksi_id in ('" . implode("','", $arrTrID_grn) . "')");
            $mlsdTmp = $mlsd->lookupAll()->result();
            showLast_query("biru");
            foreach ($mlsdTmp as $mlsdSpec) {
                $arrDataLockerSalah[$mlsdSpec->transaksi_id][$mlsdSpec->extern2_id] = 1;
            }
        }
        //--------

        arrPrintHitam($arrDataLockerSalah);
        arrPrintCyan($arrDataLocker);

        $this->db->trans_start();


        if (sizeof($arrDataLockerSalah) > 0) {
            foreach ($arrDataLockerSalah as $trid => $lspec) {
                foreach ($lspec as $pid => $xx) {
                    if (!isset($arrDataLocker[$trid][$pid])) {
                        cekHitam("$trid, $pid tidak ada dalam items, kolom nilai_unit dan nilai di nol kan");
                        $where = array(
                            "transaksi_id" => $trid,
                            "extern2_id" => $pid,
                        );
                        $data = array(
                            "nilai" => 0,
                        );
                        $mlsd->setFilters(array());
                        $mlsd->updateData($where, $data);
                        showLast_query("orange");
                    }
                }
            }
        }

        if (sizeof($arrDataLocker) > 0) {
            foreach ($arrDataLocker as $trid => $spec) {
                foreach ($spec as $pid => $specc) {
                    //----
                    $where_update_1 = array(
                        "extern_id" => $specc["diskon_1_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_1 = array(
                        "nilai" => $specc["diskon_1_nilai"],
                        "nilai_unit" => $specc["diskon_1_nilai"],
                    );
                    //----
                    $where_update_2 = array(
                        "extern_id" => $specc["diskon_2_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_2 = array(
                        "nilai" => $specc["diskon_2_nilai"],
                        "nilai_unit" => $specc["diskon_2_nilai"],
                    );
                    //----
                    $where_update_3 = array(
                        "extern_id" => $specc["diskon_3_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_3 = array(
                        "nilai" => $specc["diskon_3_nilai"],
                        "nilai_unit" => $specc["diskon_3_nilai"],
                    );
                    //----
                    $where_update_4 = array(
                        "extern_id" => $specc["diskon_4_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_4 = array(
                        "nilai" => $specc["diskon_4_nilai"],
                        "nilai_unit" => $specc["diskon_4_nilai"],
                    );
                    //----
                    $where_update_5 = array(
                        "extern_id" => $specc["diskon_5_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_5 = array(
                        "nilai" => $specc["diskon_5_nilai"],
                        "nilai_unit" => $specc["diskon_5_nilai"],
                    );
                    //----
                    $where_update_6 = array(
                        "extern_id" => $specc["diskon_6_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_6 = array(
                        "nilai" => $specc["diskon_6_nilai"],
                        "nilai_unit" => $specc["diskon_6_nilai"],
                    );
                    //----
                    $where_update_7 = array(
                        "extern_id" => $specc["diskon_7_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_7 = array(
                        "nilai" => $specc["diskon_7_nilai"],
                        "nilai_unit" => $specc["diskon_7_nilai"],
                    );
                    //----
                    $where_update_8 = array(
                        "extern_id" => $specc["diskon_8_id"],
                        "extern2_id" => $pid,
                        "transaksi_id" => $trid,
                        "state" => "active",
                    );
                    $data_update_8 = array(
                        "nilai" => $specc["diskon_8_nilai"],
                        "nilai_unit" => $specc["diskon_8_nilai"],
                    );
                    //----
                    //----
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_1, $data_update_1);
//                    showLast_query("orange");
//
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_2, $data_update_2);
//                    showLast_query("orange");
//
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_3, $data_update_3);
//                    showLast_query("orange");
//
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_4, $data_update_4);
//                    showLast_query("orange");
//
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_5, $data_update_5);
//                    showLast_query("orange");
//
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_6, $data_update_6);
//                    showLast_query("orange");
//
////                    $mlsd->setFilters(array());
////                    $mlsd->updateData($where_update_7, $data_update_7);
////                    showLast_query("orange");
//
//                    $mlsd->setFilters(array());
//                    $mlsd->updateData($where_update_8, $data_update_8);
//                    showLast_query("orange");
                }
            }
        }


        mati_disini(__LINE__ . " STOP...");

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3> DONE... </h3>");
    }


    //-------------------------
    public function rebuildPPh23DibayarDimuka()
    {
        $this->load->helper("he_mass_table");
        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComRekening");
        $this->load->model("Coms/ComRekeningPembantuPphMain");
        $this->load->model("Coms/ComRekeningPembantuPph");
        $rekening = "1010040030";// pph23 dibayar dimuka
        $rekening_target = "1010040130";// cadangan pph23 dibayar dimuka akan diterima dari supplier


        $this->db->trans_start();


        // region transaksi pindah pph23 dibayar dimuka ke cadngan pph23 dibayar dimuka
        $cabangID = "-1";
        $cabangNama = "DC/PUSAT";
        $gudangID = "-1";
        $gudangNama = "default warehouse at DC/PUSAT";
        $olehID = "100";
        $olehNama = "system";
        $jenis = "99999";
        $this->jenisTr = $jenisTr = "99999";
        $jenisTrMaster = "99999";
        $dtime = date("Y-m-d H:i:s");
        $fulldate = date("Y-m-d");
        $ppnFactor = 11;
        $divID = 18;
        $modul_transaksi = "adjustment";
        $tCodeTargetJenisTransaksi = $target_transaksi = $jenisTrMaster;
        $mainGate = array(
            "olehID" => $olehID,
            "olehName" => $olehNama,
            "sellerID" => "",
            "sellerName" => "",
            "pihakID" => $pihakID,
            "pihakName" => $pihakNama,
            "supplierID" => $supplierID,
            "supplierNama" => $supplierNama,
            "supplier2ID" => $supplier2ID,
            "supplier2Nama" => $supplier2Nama,
            "placeID" => $cabangID,
            "placeName" => $cabangNama,
            "cabangID" => $cabangID,
            "cabangName" => $cabangNama,
            "gudangID" => $gudangID,
            "gudangName" => $gudangNama,
            "place2ID" => $cabang2ID,
            "place2Name" => $cabang2Nama,
            "cabang2ID" => $cabang2ID,
            "cabang2Name" => $cabang2Nama,
            "gudang2ID" => $gudang2ID,
            "gudang2Name" => $gudang2Nama,
            "tokoEmail" => "",
            "tokoID" => $tokoID,
            "tokoNama" => $tokoNama,
            "jenisTr" => $jenis,
            "jenisTrMaster" => $jenisTrMaster,
            "jenisTrTop" => $jenis,
            "jenisTrName" => "",
            "stepNumber" => "",
            "stepCode" => $jenis,
            "dtime" => $dtime,
            "fulldate" => $fulldate,
            "ppnFactor" => $ppnFactor,
            "dummyElement" => "yes",
            "dummyElement__label" => "yes",
            "dummyElement__name" => "yes",
            "divID" => $divID,
            "jenis" => $jenis,
            "transaksi_jenis" => $jenis,
            "next_step_code" => $jenis,
            "next_group_code" => "o_holding",
            "step_number" => 1,
            "step_current" => 1,
            "longitude" => "",
            "lattitude" => "",
            "accuracy" => "",
            "description" => "pergantian metode akuntansi dari pph23 dibayar dimuka ke cadangan pph23 dibayar dimuka akan diterima dari supplier",
            "keterangan" => "pergantian metode akuntansi dari pph23 dibayar dimuka ke cadangan pph23 dibayar dimuka akan diterima dari supplier",

        );
        $tableIn = array(
            "master" => array(
                "jenis_master" => "jenisTrMaster",
                "jenis_top" => "jenisTrTop",
                "jenis" => "jenisTr",
                "jenis_label" => "jenisTrName",
                "div_id" => "divID",
                "div_nama" => "divName",
                "dtime" => "dtime",
                "fulldate" => "fulldate",
                "oleh_id" => "olehID",
                "oleh_nama" => "olehName",
                "customers_id" => "pihakID",
                "customers_nama" => "pihakName",
                "cabang_id" => "placeID",
                "cabang_nama" => "placeName",
                "transaksi_nilai" => "new_net2",
                "transaksi_jenis" => "jenisTr",
                "keterangan" => "description",
                "gudang_id" => "gudangID",
                "gudang_nama" => "gudangName",
                "toko_id" => "tokoID",
                "toko_nama" => "tokoName",

            ),
            "detail" => array(
                "dtime" => "dtime",
                "produk_id" => "id",
                "produk_kode" => "produk_kode",
                "produk_label" => "label",
                "produk_nama" => "name",
                "produk_ord_jml" => "qty",
                "produk_ord_hrg" => "harga",
                "satuan" => "satuan",
            ),
        );
        $this->cCode = $cCode = "_TR_" . $jenis;
//        $this->cCodeData[$cCode] = array(
//            "main" => $mainGate,
//            "items" => $detailGate,
//            "tableIn_master" => $tableIn_master,
//            "tableIn_detail" => $tableIn_detail,
//        );
        $componentsDetailLoop = true;
        $comsPrefix = "Com";
        $comsLocation = "Coms";
        $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        $runCliComponentDetail = false;
        $jenisTrTarget = $jenis;
        // endregion transaksi pindah pph23 dibayar dimuka ke cadngan pph23 dibayar dimuka

        // region komponen pph23 dibayar dimuka
        $cr = New ComRekening();
        $cr->addFilter("cabang_id='$cabangID'");
        $crTmp = $cr->fetchBalances($rekening);
        $debet_pph23 = $crTmp[0]->debet;
        $mainGate["nilai_pph23"] = $debet_pph23;
        $detailGate = array();
        // endregion komponen pph23 dibayar dimuka

        // region membuat pembantu cadangan pph23 dibayar dimuka
        $cpd = New ComRekening();
        $cpd->addFilter("cabang_id='$cabangID'");
        $cpdTmp = $cpd->fetchMoves($rekening);
        if (sizeof($cpdTmp) > 0) {
            foreach ($cpdTmp as $ii => $spec) {
//                arrPrint($spec);
                $jenis = $spec->jenis;
                $trid = $spec->transaksi_id;
                switch ($jenis) {
                    case "749":
                    case "4464":
                        $tr = New MdlTransaksi();
                        $tr->addFilter("id='$trid'");
                        $trTmp = $tr->lookupAll()->result();
                        $pihakID = $trTmp[0]->customers_id;
                        $pihakNama = $trTmp[0]->customers_nama;
                        $detailGate[$ii] = array(
                            "id" => $pihakID,
                            "nama" => $pihakNama,
                            "extern_id" => $pihakID,
                            "extern_nama" => $pihakNama,
                            "extern2_id" => "9",
                            "extern2_nama" => "customer",
                            "jenisTr" => $jenis,
                            "nomer" => $spec->transaksi_no,
                            "transaksi_id" => $trid,
                            "nilai" => $spec->debet,
                            "cabang_id" => $spec->cabang_id,
                            "cabang_nama" => $spec->cabang_nama,
                            "dtime" => $spec->dtime,
                            "fulldate" => $spec->fulldate,
                        );
                        break;
                    case "3333":
                        $tr = New MdlTransaksi();
                        $tr->addFilter("id='$trid'");
                        $trTmp = $tr->lookupAll()->result();
                        $pihakID = $trTmp[0]->suppliers_id;
                        $pihakNama = $trTmp[0]->suppliers_nama;
                        $detailGate[$ii] = array(
                            "id" => $pihakID,
                            "nama" => $pihakNama,
                            "extern_id" => $pihakID,
                            "extern_nama" => $pihakNama,
                            "extern2_id" => "2",
                            "extern2_nama" => "supplier",
                            "jenisTr" => $jenis,
                            "nomer" => $spec->transaksi_no,
                            "transaksi_id" => $trid,
                            "nilai" => $spec->debet,
                            "cabang_id" => $spec->cabang_id,
                            "cabang_nama" => $spec->cabang_nama,
                            "dtime" => $spec->dtime,
                            "fulldate" => $spec->fulldate,
                        );

                        break;
                }


//                break;
            }
        }
        // endregion membuat pembantu cadangan pph23 dibayar dimuka

//        arrPrintCyan($detailGate);

        foreach ($tableIn["master"] as $key => $val) {
            $tableIn_master[$key] = isset($mainGate[$val]) ? $mainGate[$val] : "";
        }
        $this->cCodeData[$cCode] = array(
            "main" => $mainGate,
            "items" => $detailGate,
            "tableIn_master" => $tableIn_master,
            "tableIn_detail" => isset($tableIn_detail) ? $tableIn_detail : array(),
        );
        $components = array(
            "master" => array(
                // JURNAL 1
//                array(
//                    "comName" => "Jurnal",
//                    "loop" => array(
//                        "1010040130" => "nilai_pph23",
//                        "1010040030" => "-nilai_pph23",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
//                array(
//                    "comName" => "Rekening",
//                    "loop" => array(
//                        "1010040130" => "nilai_pph23",
//                        "1010040030" => "-nilai_pph23",
//                    ),
//                    "static" => array(
//                        "cabang_id" => "placeID",
//                        "jenis" => "jenisTr",
//                        "transaksi_no" => "nomer",
//                    ),
//                    "srcGateName" => "main",
//                    "srcRawGateName" => "main",
//                ),
            ),
            "detail" => array(
                // cadangan pph23 dibayar dimuka akan diterima dari supplier
                array(
                    "comName" => "RekeningPembantuPph",
                    "loop" => array(
                        "1010040130" => "nilai",// pph23 dibayar dimuka
                    ),
                    "static" => array(
                        "cabang_id" => "cabang_id",
                        "extern_id" => "extern_id",// id vendor/supplier
                        "extern_nama" => "extern_nama",// id vendor/supplier
                        "extern2_id" => "extern2_id",// id vendor/supplier
                        "extern2_nama" => "extern2_nama",// id vendor/supplier
                        "jenis" => "jenisTr",
                        "transaksi_no" => "nomer",
                        "harga" => "nilai",
                    ),
                    "srcGateName" => "items",
                    "srcRawGateName" => "items",
                ),
            ),
        );


        $pakai_ini = 0;
        if ($pakai_ini == 1) {
            //region dynamic counters
            $counters = array(
                "stepCode|placeID",
                "stepCode|tokoID",
                "stepCode|tokoID|placeID",
                "stepCode|tokoID|olehID",
                "stepCode|tokoID|placeID|olehID",
            );
            $formatNota = "stepCode,placeID,stepCode|tokoID|placeID,stepCode|tokoID";

            //region penomoran receipt
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $configCustomParams = $counters;
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $this->cCodeData[$cCode]["main"][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i], $tokoID);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec["value"];
                    switch ($paramSpec["id"]) {
                        case 0: //===counter type is new
                            $addData = array(
//                                "toko_id" => $tokoID,
//                                "toko_nama" => $tokoNama,
                            );
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw, $addData);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec["id"], $paramSpec["value"]);
                            break;
                    }
                }
            }

            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);

            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $cn->setModul($modul_transaksi);
            $cn->setStepCode($tCodeTargetJenisTransaksi);
            $counterForNumber = array($formatNota);
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                foreach ($c0Params as $k => $cRawParams) {
                    $dParams = explode("|", $cRawParams);
                    if (count($dParams) > 1) {
                        if (!in_array($cRawParams, $counters)) {
                            die(__LINE__ . "( $cRawParams ) Used number should be registered in counters config as well");
                        }
                    }
                }
            }

            $tmpNomorNota = "";
            $arrNomorNota = array();
            foreach ($counterForNumber as $i => $c0RawParams) {
                $c0Params = explode(",", $c0RawParams);
                $c0Values = array();
                foreach ($c0Params as $k => $cRawParams) {
                    $arrRawParams = explode("|", $cRawParams);
                    if (sizeof($arrRawParams) > 1) {
                        $cRawParamsValues = array();
                        foreach ($arrRawParams as $key) {
                            $cRawParamsValues[$key] = $this->cCodeData[$cCode]['main'][$key];
                        }
                        $cRawParamsValuesK = implode("|", array_keys($cRawParamsValues));
                        $cRawParamsValuesV = implode("|", $cRawParamsValues);
                        $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                    }
                    else {
                        $cRawParamsValuesK = $arrRawParams[0];
                        $cRawParamsValuesV = $this->cCodeData[$cCode]['main'][$arrRawParams[0]];
                        if ($arrRawParams[0] == "fulldate") {
                            $arrNomorNota[] = $arrRawParams[0] . "|" . date("mY", strtotime($cRawParamsValuesV));
                        }
                        elseif ($arrRawParams[0] == "stepCode") {
                            $arrNomorNota[] = $cRawParamsValuesV; //ini harus ori tidak boleh di masking/ diformat
//                            $arrNomorNota[] = digit_4($cContent[$cRawParamsValuesK][$cRawParamsValuesV]);
                        }
                        elseif ($arrRawParams[0] == "placeID") {
                            $arrNomorNota[] = digit_2($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "customerID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "olehID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        elseif ($arrRawParams[0] == "supplierID") {
                            $arrNomorNota[] = digit_4($cRawParamsValuesV);
                        }
                        else {
                            $arrNomorNota[] = $cRawParamsValuesV;
                        }
                    }
                }
            }

            $stepNumber = 1;
            $tmpNomorNota = implode("-", $arrNomorNota);
//            cekMerah(":: $tmpNomorNota ::");
            //endregion penomoran receipt

            //region addition on master
            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
            $addValues = array(
                "counters" => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => 1,
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp["num"],
                "next_step_code" => $nextProp["code"],
                "next_step_label" => $nextProp["label"],
                "next_group_code" => $nextProp["groupID"],
                "tail_number" => 1,
                "tail_code" => "",
            );
            foreach ($addValues as $key => $val) {
                $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
            }
            //endregion

            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => 1,
                "next_substep_num" => $nextProp["num"],
                "next_substep_code" => $nextProp["code"],
                "next_substep_label" => $nextProp["label"],
                "next_subgroup_code" => $nextProp["groupID"],
                "sub_tail_number" => 1,
                "sub_tail_code" => "",
            );
            foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_detail"][$id][$key] = $val;
                }
            }
            //endregion

            //endregion

            //region numbering tambahan
            $this->load->library("CounterNumber");
            $ccn = new CounterNumber();
            $ccn->setCCode($this->cCode);
            $ccn->setJenisTr($this->jenisTr);
            $ccn->setTransaksiGate($this->cCodeData[$cCode]["tableIn_master"]);
            $ccn->setMainGate($this->cCodeData[$cCode]["main"]);
            $ccn->setItemsGate($this->cCodeData[$cCode]["items"]);

            if (isset($this->cCodeData[$cCode]["items2_sum"])) {
                $ccn->setItems2SumGate($this->cCodeData[$cCode]["items2_sum"]);
            }

            $new_counter = $ccn->getCounterNumber();

            cekHitam("jenistr yang disett dari create " . $this->jenisTr);

            if (isset($new_counter["main"]) && sizeof($new_counter["main"]) > 0) {
                foreach ($new_counter["main"] as $ckey => $cval) {
                    $this->cCodeData[$cCode]["tableIn_master"][$ckey] = $cval;
                    $this->cCodeData[$cCode]["main"][$ckey] = $cval;
                }
            }
            if (isset($new_counter["items"]) && sizeof($new_counter["items"]) > 0) {
                foreach ($new_counter["items"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items"][$ikey][$iikey] = $iival;
                    }
                }
            }
            if (isset($new_counter["items2_sum"]) && sizeof($new_counter["items2_sum"]) > 0) {
                foreach ($new_counter["items2_sum"] as $ikey => $iSpec) {
                    foreach ($iSpec as $iikey => $iival) {
                        $this->cCodeData[$cCode]["items2_sum"][$ikey][$iikey] = $iival;
                    }
                }
            }
            //endregion

            //region MENULIS TRANSAKSIONAL
            if (isset($this->cCodeData[$cCode]["tableIn_master"]) && sizeof($this->cCodeData[$cCode]["tableIn_master"]) > 0) {

                $this->cCodeData[$cCode]["tableIn_master"]['status_4'] = 11;
                $this->cCodeData[$cCode]["tableIn_master"]['trash_4'] = 0;
                if ($runCliComponentDetail == false) {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 1;
                }
                else {
                    $this->cCodeData[$cCode]["tableIn_master"]['cli'] = 0;
                }

                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->cCodeData[$cCode]["tableIn_master"]['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($this->cCodeData[$cCode]["tableIn_master"]);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $this->cCodeData[$cCode]["tableIn_master"]);
                $insertNum = $this->cCodeData[$cCode]["tableIn_master"]['nomer'];
                $this->cCodeData[$cCode]["main"]['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }

                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $this->cCodeData[$cCode]["main"][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($this->cCodeData[$cCode][$target])) {
                            foreach ($this->cCodeData[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec["id"]) && $iSpec["id"] > 0 ? $iSpec["id"] : $xid;
                                if (isset($this->cCodeData[$cCode][$target][$id])) {
                                    $this->cCodeData[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
//                    "step_name" => $this->configUiModul[$this->jenisTr]["steps"][1]["label"],
//                    "group_code" => $this->configUiModul[$this->jenisTr]["steps"][1]['userGroup'],
//                    "oleh_id" => $this->cCodeData[$cCode]["main"]['olehID'],
//                    "oleh_nama" => $this->cCodeData[$cCode]["main"]['olehName'],
                    "step_name" => "",
                    "group_code" => "",
                    "oleh_id" => "",
                    "oleh_nama" => "",
                    "keterangan" => "",
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");

                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $this->cCodeData[$cCode]["main"]['olehID'],
                        "olehName" => $this->cCodeData[$cCode]["main"]['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => isset($tmpNomorNotaAlias) ? $tmpNomorNotaAlias : "",
                        "counters" => $appliedCounters,
                        // "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp["num"],
                    "next_step_code" => $nextProp["code"],
                    "next_step_label" => $nextProp["label"],
                    "next_group_code" => $nextProp["groupID"],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());
                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "nomer_top" => $this->cCodeData[$cCode]["main"]['nomer'],
                    "nomers_prev" => "",
                    "jenises_prev" => "",
                    "ids_his" => $idHis_blob,
                );
                foreach ($addValues as $key => $val) {
                    $this->cCodeData[$cCode]["tableIn_master"][$key] = $val;
                }

            }
            if (isset($this->cCodeData[$cCode]['tableIn_master_values']) && sizeof($this->cCodeData[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'])) {
                    $inserMainValues = array();
                    foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['mainValues'] as $key => $src) {
                        if (isset($this->cCodeData[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $this->cCodeData[$cCode]['tableIn_master_values'][$key],
                            ));
                            $inserMainValues[] = $dd;
                        }
                    }
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_values']) && sizeof($this->cCodeData[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($this->cCodeData[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['main_inputs']) && sizeof($this->cCodeData[$cCode]['main_inputs']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_add_fields']) && sizeof($this->cCodeData[$cCode]['main_add_fields']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_applets']) && sizeof($this->cCodeData[$cCode]['main_applets']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($this->cCodeData[$cCode]['main_elements']) && sizeof($this->cCodeData[$cCode]['main_elements']) > 0) {
                foreach ($this->cCodeData[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec["value"]) ? $aSpec["value"] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec["label"],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));
                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec["value"];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec["label"];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']["groupID"])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']["groupID"];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]["tableIn_detail"]) && sizeof($this->cCodeData[$cCode]["tableIn_detail"]) > 0) {
                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($this->cCodeData[$cCode]["tableIn_detail"] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }
                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
//                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'])) {
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues'] as $key => $src) {
                            if (isset($this->cCodeData[$cCode]["tableIn_detail"][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $this->cCodeData[$cCode]["tableIn_detail"][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                            }
                        }
                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) && sizeof($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($this->cCodeData[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->configValuesModul[$this->jenisTr]["tableIn"]['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $this->cCodeData[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                        }
                    }
                }
            }
//        $steps = $this->configUiModul[$this->jenisTr]["steps"];

            //endregion

            //region MENULIS KE REGISTRY
            $pakai_ini = 1;
            if ($pakai_ini == 1) {
                if (isset($core['components']) && sizeof($core['components'])) {
                    $jurnalIndex = $core['components'];
                }
                else {
                    if (isset($this->cCodeData[$cCode]["revert"]["jurnal"]) && sizeof($this->cCodeData[$cCode]["revert"]["jurnal"]) > 0) {
                        $jurnalIndex = $this->cCodeData[$cCode]["revert"]["jurnal"];
                    }
                    else {
                        $jurnalIndex = array();
                    }
                }
                //------------
                if (isset($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget])) {
                    $jurnalPostProc = $this->configValuesModul[$this->jenisTr]['postProcessor'][$jenisTrTarget];
                }
                else {
                    if (isset($this->cCodeData[$cCode]["revert"]["postProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["postProc"]) > 0) {
                        $jurnalPostProc = $this->cCodeData[$cCode]["revert"]["postProc"];
                    }
                    else {
                        $jurnalPostProc = array();
                    }
                }
                //------------
                if (isset($core['preProcessor'][$jenisTrTarget]) && sizeof($core['preProcessor'][$jenisTrTarget])) {
                    $jurnalPreProc = $core['preProcessor'][$jenisTrTarget];
                }
                else {
                    if (isset($this->cCodeData[$cCode]["revert"]["preProc"]) && sizeof($this->cCodeData[$cCode]["revert"]["preProc"]) > 0) {
                        $jurnalPreProc = $this->cCodeData[$cCode]["revert"]["preProc"];
                    }
                    else {
                        $jurnalPreProc = array();
                    }
                }
                //------------
                if (isset($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget]) && sizeof($this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget])) {
                    $coreBuilder = $this->configValuesModul[$this->jenisTr]['coreBuilder'][$jenisTrTarget];
                }
                else {
                    $coreBuilder = array();
                }
                //------------
                $baseRegistries = array(
                    "main" => isset($this->cCodeData[$cCode]["main"]) ? $this->cCodeData[$cCode]["main"] : array(),
                    "items" => isset($this->cCodeData[$cCode]["items"]) ? $this->cCodeData[$cCode]["items"] : array(),
                    "items2" => isset($this->cCodeData[$cCode]["items2"]) ? $this->cCodeData[$cCode]["items2"] : array(),
                    "items2_sum" => isset($this->cCodeData[$cCode]["items2_sum"]) ? $this->cCodeData[$cCode]["items2_sum"] : array(),
                    "itemSrc" => isset($this->cCodeData[$cCode]["itemSrc"]) ? $this->cCodeData[$cCode]["itemSrc"] : array(),
                    "itemSrc_sum" => isset($this->cCodeData[$cCode]["itemSrc_sum"]) ? $this->cCodeData[$cCode]["itemSrc_sum"] : array(),
                    "items3" => isset($this->cCodeData[$cCode]["items3"]) ? $this->cCodeData[$cCode]["items3"] : array(),
                    "items3_sum" => isset($this->cCodeData[$cCode]["items3_sum"]) ? $this->cCodeData[$cCode]["items3_sum"] : array(),
                    "items4" => isset($this->cCodeData[$cCode]["items4"]) ? $this->cCodeData[$cCode]["items4"] : array(),
                    "items4_sum" => isset($this->cCodeData[$cCode]["items4_sum"]) ? $this->cCodeData[$cCode]["items4_sum"] : array(),
                    "items5_sum" => isset($this->cCodeData[$cCode]["items5_sum"]) ? $this->cCodeData[$cCode]["items5_sum"] : array(),
                    'items6_sum' => isset($this->cCodeData[$cCode]['items6_sum']) ? $this->cCodeData[$cCode]['items6_sum'] : array(),
                    'items7_sum' => isset($this->cCodeData[$cCode]['items7_sum']) ? $this->cCodeData[$cCode]['items7_sum'] : array(),
                    'items8_sum' => isset($this->cCodeData[$cCode]['items8_sum']) ? $this->cCodeData[$cCode]['items8_sum'] : array(),
                    'items9_sum' => isset($this->cCodeData[$cCode]['items9_sum']) ? $this->cCodeData[$cCode]['items9_sum'] : array(),
                    'items10_sum' => isset($this->cCodeData[$cCode]['items10_sum']) ? $this->cCodeData[$cCode]['items10_sum'] : array(),
                    'rsltItems' => isset($this->cCodeData[$cCode]['rsltItems']) ? $this->cCodeData[$cCode]['rsltItems'] : array(),
                    'rsltItems2' => isset($this->cCodeData[$cCode]['rsltItems2']) ? $this->cCodeData[$cCode]['rsltItems2'] : array(),
                    'rsltItems3' => isset($this->cCodeData[$cCode]['rsltItems3']) ? $this->cCodeData[$cCode]['rsltItems3'] : array(),
                    "tableIn_master" => isset($this->cCodeData[$cCode]["tableIn_master"]) ? $this->cCodeData[$cCode]["tableIn_master"] : array(),
                    "tableIn_detail" => isset($this->cCodeData[$cCode]["tableIn_detail"]) ? $this->cCodeData[$cCode]["tableIn_detail"] : array(),
                    'tableIn_detail2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail2_sum'] : array(),
                    'tableIn_detail_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems'] : array(),
                    'tableIn_detail_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_rsltItems2'] : array(),
                    'tableIn_master_values' => isset($this->cCodeData[$cCode]['tableIn_master_values']) ? $this->cCodeData[$cCode]['tableIn_master_values'] : array(),
                    'tableIn_detail_values' => isset($this->cCodeData[$cCode]['tableIn_detail_values']) ? $this->cCodeData[$cCode]['tableIn_detail_values'] : array(),
                    'tableIn_detail_values_rsltItems' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                    'tableIn_detail_values_rsltItems2' => isset($this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2']) ? $this->cCodeData[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                    'tableIn_detail_values2_sum' => isset($this->cCodeData[$cCode]['tableIn_detail_values2_sum']) ? $this->cCodeData[$cCode]['tableIn_detail_values2_sum'] : array(),
                    'main_add_values' => isset($this->cCodeData[$cCode]['main_add_values']) ? $this->cCodeData[$cCode]['main_add_values'] : array(),
                    'main_add_fields' => isset($this->cCodeData[$cCode]['main_add_fields']) ? $this->cCodeData[$cCode]['main_add_fields'] : array(),
                    'main_elements' => isset($this->cCodeData[$cCode]['main_elements']) ? $this->cCodeData[$cCode]['main_elements'] : array(),
//                'items_elements' => isset($this->cCodeData[$cCode]['items_elements']) ? $this->cCodeData[$cCode]['items_elements'] : array(),
                    'main_inputs' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                    'main_inputs_orig' => isset($this->cCodeData[$cCode]['main_inputs']) ? $this->cCodeData[$cCode]['main_inputs'] : array(),
                    "receiptDetailFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields'][1] : array(),
                    "receiptSumFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields'][1] : array(),
                    "receiptDetailFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                    "receiptDetailSrcFields" => isset($this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                    "receiptSumFields2" => isset($this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1]) ? $this->configLayoutModul[$this->jenisTr]['receiptSumFields2'][1] : array(),
                    "jurnal_index" => $jurnalIndex,
                    "postProcessor" => $jurnalPostProc,
                    "preProcessor" => $jurnalPreProc,
                    "revert" => isset($this->cCodeData[$cCode]['revert']) ? $this->cCodeData[$cCode]['revert'] : array(),
                    "items_komposisi" => isset($this->cCodeData[$cCode]['items_komposisi']) ? $this->cCodeData[$cCode]['items_komposisi'] : array(),
                    "items_noapprove" => isset($this->cCodeData[$cCode]['items_noapprove']) ? $this->cCodeData[$cCode]['items_noapprove'] : array(),
                    "jurnalItems" => isset($this->cCodeData[$cCode]['jurnalItems']) ? $this->cCodeData[$cCode]['jurnalItems'] : array(),
                    "componentsBuilder" => isset($this->cCodeData[$cCode]['componentsBuilder']) ? $this->cCodeData[$cCode]['componentsBuilder'] : array(),
//                "itemPrice" => isset($this->cCodeData[$cCode]['itemPrice']) ? $this->cCodeData[$cCode]['itemPrice'] : array(),
//                "itemPrice_sum" => isset($this->cCodeData[$cCode]['itemPrice_sum']) ? $this->cCodeData[$cCode]['itemPrice_sum'] : array(),
//                "requiredParam" => (isset($coreRequiredParam[$this->jenisTr]) && sizeof($coreRequiredParam[$this->jenisTr]) > 0) ? $coreRequiredParam[$this->jenisTr] : array(),
                    //-----
//                "coreBuilder" => $coreBuilder,
//                'diskon_event' => isset($this->cCodeData[$cCode]['diskon_event']) ? $this->cCodeData[$cCode]['diskon_event'] : array(),
//                'cashback_event' => isset($this->cCodeData[$cCode]['cashback_event']) ? $this->cCodeData[$cCode]['cashback_event'] : array(),
                    //-----
                );
                $doWriteReg = $tr->writeDataRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                showLast_query("biru");

            }
            //endregion
        }
        else {
            $insertID = "543545";
            $insertNum = "99999--1-0019-0042";
        }

        // COMPONENT
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            // COMPONENT-----
            //region processing sub-components, if in single step geser ke CLI
            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            $iterator = $components["detail"];
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();
                    $gg = 0;
                    $srcGateName = $tComSpec['srcGateName'];
                    if ($componentsDetailLoop == true) {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $comName = $tComSpec['comName'];
                            if (substr($comName, 0, 1) == "{") {
                                $comName = trim($comName, "{");
                                $comName = trim($comName, "}");
                                $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                            }

                            $mdlName = "$comsPrefix" . ucfirst($comName);
                            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                $filterNeeded = true;
                            }
                            else {
                                $filterNeeded = false;
                            }
                            cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                            $subParams = array();

                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {
                                    if (substr($key, 0, 1) == "{") {
                                        $key = trim($key, "{");
                                        $key = trim($key, "}");
                                        $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                    }

                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                    if ($filterNeeded) {
                                        if ($subParams['loop'][$key] == 0) {
                                            unset($subParams['loop'][$key]);
                                        }
                                    }
                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }

                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                                if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                    $subParams['static']['reverted_target'] = $revertedTarget;
                                }
                            }

                            if (sizeof($subParams) > 0) {
//                                cekhitam("subparam ada isinya");
                                if ($filterNeeded) {
                                    if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                cekhitam("subparam TIDAK ada isinya");
                            }
                        }
                    }
                    else {
                        foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                            if ($cCtr == $id) {
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $comName = $tComSpec['comName'];
                                if (substr($comName, 0, 1) == "{") {
                                    $comName = trim($comName, "{");
                                    $comName = trim($comName, "}");

                                    $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                                }

                                $mdlName = "$comsPrefix" . ucfirst($comName);
                                if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                                    $filterNeeded = true;
                                }
                                else {
                                    $filterNeeded = false;
                                }
                                cekHere("sub-component: [$comsLocation] $comName, initializing values <br>");

                                $subParams = array();

                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        if (substr($key, 0, 1) == "{") {
                                            $key = trim($key, "{");
                                            $key = trim($key, "}");

                                            $key = str_replace($key, $this->cCodeData[$cCode][$srcGateName][$id][$key], $key);
                                        }

                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['loop'][$key] = $realValue;

                                        if ($filterNeeded) {
                                            if ($subParams['loop'][$key] == 0) {
                                                unset($subParams['loop'][$key]);
                                            }
                                        }
                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {
                                        $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$id], $this->cCodeData[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "";
                                    if (isset($revertedTarget) && (strlen($revertedTarget) > 1)) {
                                        $subParams['static']['reverted_target'] = $revertedTarget;
                                    }
                                }

                                if (sizeof($subParams) > 0) {

                                    if ($filterNeeded) {
                                        if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                    else {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                                else {
                                    cekhitam("subparam TIDAK ada isinya");
                                }
                            }
                        }
                    }

                    $componentGate['detail'][$cCtr] = $subParams;
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($this->cCodeData[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $this->cCodeData[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                    }
                    cekHere("sub component: [$comsLocation] $comName, sending values " . __LINE__ . "<br>");

                    $mdlName = "$comsPrefix" . ucfirst($comName);
                    $this->load->model("$comsLocation/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter

                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    // matiHEre($tobeExecuted);
                    if ($tobeExecuted) {
                        //----- kiriman gerbang
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setDetail")) {
                            $m->setDetail($this->cCodeData[$cCode][$srcGateName]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                cekKuning("subcomponents is not set");
            }
            //endregion

            //region processing main components, if in single step
            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            $iterator = $components["master"];
            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $this->cCodeData[$cCode]["main"][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    cekHere("component # $cCtr: $comName<br>");


                    // arrPrint($this->cCodeData[$cCode][$srcGateName]);
                    // matiHEre(__LINE__);
                    $dSpec = $this->cCodeData[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $this->cCodeData[$cCode]["main"][$key], $key);
                            }
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName], $this->cCodeData[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                    }

                    if (isset($tComSpec['static2'])) {
                        foreach ($tComSpec['static2'] as $key => $value) {
                            $realValue = makeValue($value, $this->cCodeData[$cCode][$srcGateName][$cCtr], $this->cCodeData[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->cCodeData[$cCode]["main"]["keterangan"];
                    }

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;
                    if (in_array($mdlName, $compValidators)) {
                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }
                    }
                    if ($tobeExecuted) {
                        //----- kiriman gerbang untuk counter mutasi rekening
                        if (method_exists($m, "setTableInMaster")) {
                            $m->setTableInMaster($this->cCodeData[$cCode]["tableIn_master"]);
                        }
                        if (method_exists($m, "setMain")) {
                            $m->setMain($this->cCodeData[$cCode]["main"]);
                        }
                        if (method_exists($m, "setJenisTr")) {
                            $m->setJenisTr($this->jenisTr);
                        }
                        //----- kiriman gerbang untuk counter mutasi rekening
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                cekKuning("components is not set");
            }
            //endregion
        }

//        mati_disini(__LINE__);

        cekMerah(":: cek validate lajur di " . __FUNCTION__ . ", " . __FILE__);
        validateAllBalances($cabangID);

//        mati_disini("---SETOP--- " . __LINE__);
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        cekHijau("<h3>DONE...</h3>");
    }
}


