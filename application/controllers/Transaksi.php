<?php

class Transaksi extends CI_Controller
{
    private $template;
    private $jenisTr;
    private $jenisTrName;
    private $trConfig;
    private $tableInConfig;
    private $tableInConfig_static;

    private $arrButtonAction;
    private $dates = array();


    public function __construct()
    {
        parent::__construct();
        if (!isset($this->session->login['id'])) {
            gotoLogin();
        }
        validateUserSession($this->session->login['id']);

        $this->load->config("heWebs");


        $this->load->helper("he_stepping");
        $this->load->helper("he_access_right");
        $this->load->library("MobileDetect");
        $this->load->helper("he_session_replacer");
        $this->load->model("Mdls/MdlCurrency");
        $this->load->model("Mdls/MdlMongoMother");
        $this->load->helper('he_angka');
        $tmpJenis = $this->uri->segment(3);
        $this->allSteps = isset($this->config->item("heTransaksi_ui")[$tmpJenis]['steps']) ? $this->config->item("heTransaksi_ui")[$tmpJenis]['steps'] : array();
        if (strlen($tmpJenis) > 0) {
            $this->jenisTr = $tmpJenis;


            //            $membership = is_array($this->session->login['membership'])?$this->session->login['membership']:array();
            //            $steps=$this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'];
            //            $jmlAllowed=0;
            //            if(sizeof($steps)>0){
            //                foreach($steps as $num=>$sSpec){
            //                    if(in_array($sSpec['userGroup'],$membership)){
            //                        $jmlAllowed++;
            //                    }
            //                }
            //            }
            //            if($jmlAllowed<1){
            //                //cekMerah("__ILLEGAL ACCESS ATTEMPT__");die();
            //            }

            //            //cekMerah("bikin jenisTR ". $this->jenisTr);
            //            $this->jenisTr = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'] : $tmpJenis;
            $this->jenisTrName = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['label']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['label'] : "unnamed";

            $heTransaksi_ui = (null != $this->config->item("heTransaksi_ui")) ? $this->config->item("heTransaksi_ui") : array();
            if (sizeof($heTransaksi_ui) > 0) {
                $this->template = isset($heTransaksi_ui[$this->jenisTr]) ? base_url() . "template/" . $heTransaksi_ui[$this->jenisTr]['template'] . ".html" : "";
            }
            else {
                die("konfigurasi transaksi belum ditentukan");
            }
            //            $this->trConfig = (null != $this->config->item("heTransaksi_ui")[$this->jenisTr]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr] : array();
            $this->trConfig = (isset($this->config->item("heTransaksi_ui")[$this->jenisTr])) ? $this->config->item("heTransaksi_ui")[$this->jenisTr] : array();
        }
        else {
            // die("trJenis required!");

        }

        $this->load->model("CustomCounter");
        $this->load->model("MdlTransaksi");
        $this->tableInConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['tableIn']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['tableIn'] : array();
        $this->tableInConfig_static = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['tableIn_static']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['tableIn_static'] : array();
        $this->arrButtonAction = $this->config->item("button");

        $trd = new MdlTransaksi();
        $trd->addFilter("jenis_top='" . $this->jenisTr . "'");
        $this->dates = $trd->lookupDates();
        $this->dates['entries'][date("y-m-d")] = date("y-m-d");
        //        arrPrint($this->session->login);
        $this->accessList = alowedAccess($this->session->login['id']);
        // arrPrint($this->session->login['cabang_id']);
        $this->placeId = $this->session->login['cabang_id'];

        $this->transaksiMaintenance = $this->config->item("maintenanceTransaksi") != null && $this->config->item("maintenanceTransaksi") == true ? true : false;
        $this->transaksiMaintenanceMsg = isset($this->config->item("maintenanceOptions")[1]) ? $this->config->item("maintenanceOptions")[1] : array();
        $this->mongoTableList = array(
            "main" => "transaksi",
            "mainValues" => "transaksi_values",
            "detail" => "transaksi_data",
            "detailValues" => "transaksi_data_values",
            "sign" => "transaksi_sign",
            "extras" => "transaksi_extstep",
            "registry" => "transaksi_registry",
        );
        $this->jenisException = array("9911", "9912");
    }

    public function index()
    {
        // arrPrint($this->session->login);
        $starttime = microtime(true);
        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        $scriptBottom = "";
        $sesionReplacer = replaceSession();
        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        $paymentConfig = isset($this->config->item("heTransaksi_ui")[$jenisTr]['paymentConfig']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['paymentConfig'] : false;
        $myPaymentConfig = isset($this->config->item("heTransaksi_ui")[$jenisTr]['myPaymentConfig']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['myPaymentConfig'] : false;
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'] : array();
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $connectTo = isset($this->config->item("heTransaksi_ui")[$jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['connectTo'] : "";
        $stepHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStepHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortStepHistoryFields'] : array();
        $arrExtHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"] : array();

        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }
        $prePreFields = $historyFields;
        $prePreFields['state'] = "status";
        $prePreFields['action'] = "action";
        $swapJenisTr = isset($this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['masterCode']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['masterCode'] : array();
        $arrayOnprePre = array();
        $arrayOnprePreGroup = array();
        if (sizeof($swapJenisTr) > 0) {
            $steps = $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'];
            $arrFilters = array();
            if (sizeof($steps) > 1) {
                $this->load->model("MdlTransaksi");
                $tr = new MdlTransaksi();
                $stepCodes = array();
                $jmlStep = count($steps);
                if (isset($this->accessList[$swapJenisTr]) && sizeof($this->accessList) > 0) {
                    $indsteps = "(";
                    foreach ($this->accessList[$swapJenisTr] as $stepNumber => $stepSpec) {
                        if ($stepNumber <= $jmlStep) {
                            foreach ($stepSpec as $targetCode => $filters) {
                                $indsteps .= "'$targetCode',";
                                $stepCodes[] = $targetCode;
                                if ($filters['allowFollowUp'] == "true") {
                                    $arrFilters["allowFollowUp"][] = $targetCode;
                                }
                            }
                        }
                    }
                    $indsteps = rtrim($indsteps, ",");
                    $indsteps .= ")";
                    if (sizeof($arrFilters) > 0) {
                        $tr->addFilter("next_step_code in $indsteps");
                    }
                    else {
                        $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
                    }
                }
                else {

                }
                $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
                $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");
                $tr->addFilter("next_substep_code<>''");
                $tr->addFilter("sub_step_number>0");
                $tr->addFilter("valid_qty>0");
                $tmpHist = $tr->lookupRecentUndoneEntries_joined($sesionReplacer)->result();
                if (sizeof($tmpHist) > 0) {
                    $arrTransID = array();
                    $arrTransTopID = array();
                    $arrIdsHist = array();
                    $arrTransHist = array();
                    foreach ($tmpHist as $row) {
                        $arrTransID[] = $row->id;
                        $arrTransTopID[] = $row->id_top;

                        if ($row->ids_his != "") {
                            $hist = blobDecode($row->ids_his);
                            foreach ($hist as $hisSpec) {
                                $arrIdsHist[$row->id][$hisSpec['step']] = array(
                                    "step" => $hisSpec['step'],
                                    "trID" => $hisSpec['trID'],
                                    "nomer" => $hisSpec['nomer'],
                                );
                                $arrTransHist[] = $hisSpec['trID'];
                            }
                        }
                    }
                    $tmpReg_result = array();
                    $trReg = new MdlTransaksi();
                    $trReg->setFilters(array());
                    $trReg->addFilter("param='main'");
                    $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                    $tmpReg = $trReg->lookupRegistries()->result();

                    if (sizeof($tmpReg) > 0) {
                        foreach ($tmpReg as $regRow) {
                            $param = $regRow->param;
                            $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                        }
                    }

                    foreach ($tmpHist as $row) {
                        if (sizeof($pairRegistries) > 0) {
                            //                            $trReg = new MdlTransaksi();
                            //                            $trReg->setFilters(array());
                            //                            $trReg->addFilter("param in ('" . implode("','", $pairRegistries) . "')");
                            //                            $trReg->addFilter("transaksi_id='" . $row->transaksi_id . "'");
                            //                            $tmpReg = $trReg->lookupRegistries()->result();
                            //                            if (sizeof($tmpReg) > 0) {
                            //                                foreach ($tmpReg as $regRow) {
                            //                                    $param = $regRow->param;
                            //                                    $$param = blobDecode($regRow->values);
                            //                                }
                            //                                foreach ($pairRegistries as $eReg) {
                            //                                    foreach ($$eReg as $k => $v) {
                            //                                        if (!isset($row->$k)) {
                            //                                            $row->$k = $v;
                            //                                        }
                            //                                    }
                            //                                }
                            //                            }
                            if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->id]))) {
                                foreach ($tmpReg_result[$row->id] as $param => $eReg) {
                                    foreach ($eReg as $k => $v) {
                                        if (!isset($row->$k)) {
                                            $row->$k = $v;
                                        }
                                    }
                                }
                            }
                        }

                        $tmp = array();
                        foreach ($historyFields as $fName => $fLabel) {
                            $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                        }

                        //                        cekHijau('$swapJenisTr: ' . $swapJenisTr);

                        $showPoStatus = isset($this->config->item('heTransaksi_ui')[$swapJenisTr]['showPoStatus']) ? $this->config->item('heTransaksi_ui')[$swapJenisTr]['showPoStatus'] : array();
                        $cekStateLocation = ($this->session->login['cabang_id'] > 0) ? "cabang" : "pusat";

                        if ($row->sub_step_number > 0) {

                            $tmp['state'] = "<div class='panel panel-warning' style='padding: 3px;margin-bottom: 5px;' ><span style='color:" . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
                            $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail, $swapJenisTr) . "</div>";

                            // cek PO
                            $arrTransactionSource = array();
                            $id_master = $row->id_master;
                            $id_top1 = $row->id_top;
                            $this->load->model("MdlTransaksi");
                            $l = new MdlTransaksi();
                            $l->setFilters(array());
                            $l->addFilter("transaksi_data.valid_qty>0");
                            $l->addFilter("id_master='" . $id_master . "'");
                            $l->addFilter("jenis_master='" . $swapJenisTr . "'");
                            $l->addFilter("link_id=0");
                            $tmpTS = $l->lookupJoined()->result();

                            $arrsub_step_number = array();
                            $arrstep_avail = array();
                            $arrext_blob = array();
                            $arrjenis_master = array();
                            $arrtransaksi_no = array();
                            $arrketerangan = array();

                            if (sizeof($tmpTS) > 0) {
                                foreach ($tmpTS as $kk => $arVL) {
                                    $id = $arVL->id;
                                    $id_master = $arVL->id_master;
                                    $id_top2 = $arVL->id_top;
                                    $produk_id = $arVL->produk_id;
                                    $arrTransactionSource[$id_top1] = $produk_id;
                                    $arrsub_step_number[$id_top1] = $arVL->sub_step_number;
                                    $arrstep_avail[$id_top1] = $arVL->step_avail;
                                    $arrext_blob[$id_top1][$kk] = isset($arVL->ext_blob) ? ($arVL->ext_blob != "" ? blobDecode($arVL->ext_blob) : "") : "";
                                }

                                if (sizeof($arrext_blob[$id_top1]) > 0) {
                                    foreach ($arrext_blob[$id_top1] as $ky => $aVal) {
                                        if ($aVal != "") {
                                            foreach ($arrext_blob[$id_top1][$ky]['static'] as $numb => $numData) {
                                                $arrtransaksi_no[$id_top1][$numb] = formatField("nomer", $numb);
                                                $arrjenis_master[$id_top1][$numb] = $numData['jenis'];
                                                $arrketerangan[$id_top1][$numb] = $numData['keterangan'];
                                            }
                                        }
                                    }
                                }
                            }

                            if ($arrext_blob[$id_top1][$ky] != "") {
                                $tmp['state'] .= "<div class='panel panel-danger bg-green' style='padding: 3px;margin-bottom: 5px;'>";
                                if ($cekStateLocation == "cabang") {
                                    $tmp['state'] .= "<div><b>diproses oleh PUSAT</b></div>";
                                }
                                if (sizeof($arrtransaksi_no[$id_top1]) > 0) {
                                    foreach ($arrtransaksi_no[$id_top1] as $numb_) {
                                        $tmp['state'] .= "<div><span class='fa fa-check-circle text-warning'></span> " . $numb_ . "</div>";
                                    }
                                }
                                $tmp['state'] .= "</div>";
                            }

                        }
                        else {
                            $tmp['state'] = "<span style='color:#777777'>canceled</span>";
                        }

                        $tmp['action'] = "";
                        $nextStepNum = ($row->next_substep_num);
                        $currentStepNum = ($row->sub_step_number);
                        $currentStepCode = ($row->jenis);
                        $nextStepCode = ($row->next_step_code);

                        if ($row->sub_step_number > 0) {
                            $allowFollowup = true;
                            $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$currentStepNum]['label'];
                        }

                        if (isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum])) {
                            if (isset($this->accessList[$jenisTr])) {
                                if (isset($this->accessList[$swapJenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"])) {
                                    $allowFollowup = $this->accessList[$swapJenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"];
                                    $actionLabel = $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['actionLabel'];
                                }
                            }
                            else {
                                if (in_array($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
                                    $allowFollowup = true;
                                    $actionLabel = $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['actionLabel'];
                                }
                                else {
                                    $allowFollowup = true;
                                    $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$currentStepNum]['label'];
                                }
                            }
                        }

                        if ($allowFollowup) {
                            $allowJoin = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$swapJenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;
                            $stepLabel = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['label']) ? $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['label'] : "";
                            $isCancelPacking = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['isCancelPacking']) ? $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['isCancelPacking'] : false;
                            $allowCancel = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['allowCancel'] : false;

                            $targetFollowupLink = $isCancelPacking == true ? "followupCancelPackingPrePreview" : "followupPrePreview";
                            $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/$targetFollowupLink/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";

                            $tmp['action'] = "<div class='input-group'>";
                            $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\">" . $actionLabel . "</a>";
                            if ($allowJoin) {
                                $tmp['action'] .= "<span class='input-group-addon'>";
                                $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                                $tmp['action'] .= "</span class='input-group-addon'>";
                            }
                            $tmp['action'] .= "</div class='input-group'>";

                            if ($allowCancel) {
                                $tmp['action'] .= "<div class='input-group'>";
                                $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\">" . $actionLabel . "</a>";
                                if ($allowJoin) {
                                    $tmp['action'] .= "<span class='input-group-addon'>";
                                    $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                                    $tmp['action'] .= "</span class='input-group-addon'>";
                                }
                                $tmp['action'] .= "</div class='input-group'>";
                            }
                        }
                        else {

                        }
                        $arrayOnprePre[] = $tmp;
                        $arrayOnprePreGroup[$currentStepNum][] = $tmp;
                    }
                }
            }
            else {
                $arrayOnprePre = array();
            }
        }
        else {
            $arrayOnprePre = array();
        }
        //endregion prePre

        //region lookup preDistribution (khusus push PO distribution Supplies ke branch)
        $preDistributionFields = $historyFields;
        $preDistributionFields['state'] = "status";
        $preDistributionFields['action'] = "action";
        $swapJenisTr = isset($this->config->item("heTransaksi_ui")[$jenisTr]['distributionCode']['masterCode']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['distributionCode']['masterCode'] : array();
        $arrayOnpreDistribution = array();
        $arrayOnpreDistributionGroup = array();
        if (sizeof($swapJenisTr) > 0) {

            $steps = $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'];

            $arrFilters = array();
            if (sizeof($steps) > 1) {

                $this->load->model("MdlTransaksi");
                $tr = new MdlTransaksi();
                $stepCodes = array();
                $jmlStep = count($steps);

                if (isset($this->accessList[$swapJenisTr]) && sizeof($this->accessList) > 0) {
                    $indsteps = "(";
                    foreach ($this->accessList[$swapJenisTr] as $stepNumber => $stepSpec) {
                        if ($stepNumber <= $jmlStep) {
                            foreach ($stepSpec as $targetCode => $filters) {
                                $indsteps .= "'$targetCode',";
                                $stepCodes[] = $targetCode;
                                if ($filters['allowFollowUp'] == "true") {
                                    $arrFilters["allowFollowUp"][] = $targetCode;
                                }
                            }
                        }
                    }
                    $indsteps = rtrim($indsteps, ",");
                    $indsteps .= ")";
                    if (sizeof($arrFilters) > 0) {
                        $tr->addFilter("next_step_code in $indsteps");
                    }
                    else {
                        $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
                    }
                }
                else {

                }

                $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
                $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");
                $tr->addFilter("next_substep_code<>''");
                $tr->addFilter("sub_step_number>0");
                $tr->addFilter("valid_qty>0");

                $tmpHist = $tr->lookupRecentUndoneEntries_joined($sesionReplacer)->result();

                if (sizeof($tmpHist) > 0) {
                    foreach ($tmpHist as $row) {
                        $extHistoryFields2 = isset($arrExtHistoryFields2[$row->step_number]) ? $arrExtHistoryFields2[$row->step_number] : array();

                        if (sizeof($pairRegistries) > 0) {
                            $trReg = new MdlTransaksi();
                            $trReg->setFilters(array());
                            $trReg->addFilter("param in ('" . implode("','", $pairRegistries) . "')");
                            $trReg->addFilter("transaksi_id='" . $row->transaksi_id . "'");
                            $tmpReg = $trReg->lookupRegistries()->result();
                            if (sizeof($tmpReg) > 0) {
                                foreach ($tmpReg as $regRow) {
                                    $param = $regRow->param;
                                    $$param = blobDecode($regRow->values);
                                }
                                foreach ($pairRegistries as $eReg) {
                                    if ($eReg == "main") {
                                        foreach ($$eReg as $k => $v) {
                                            if (!isset($row->$k)) {
                                                $row->$k = $v;
                                            }
                                        }
                                    }
                                    elseif ($eReg == "items") {
                                        if (sizeof($extHistoryFields2) > 0) {
                                            foreach ($extHistoryFields2 as $k1 => $v1) {
                                                if (is_array($v1)) {
                                                    $kolom = $v1['kolom'];
                                                    $format = $v1['format'];
                                                    if (!isset($row->$k1)) {
                                                        $tmpDetail = "";
                                                        foreach ($eReg as $eeReg) {
                                                            $valDetail = formatField($format, $eeReg[$kolom]);
                                                            $tmpDetail .= "<span>$valDetail</span><br>";
                                                        }
                                                        $row->$k1 = $tmpDetail;
                                                    }
                                                }
                                                else {
                                                    if (!isset($row->$k1)) {
                                                        $tmpDetail = "";
                                                        foreach ($eReg as $eeReg) {
                                                            $valDetail = formatField("nomer", $eeReg[$v1]);
                                                            $tmpDetail .= "<span>$valDetail</span><br>";
                                                        }
                                                        $row->$k1 = $tmpDetail;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        $tmp = array();
                        foreach ($historyFields as $fName => $fLabel) {
                            $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                        }

                        if ($row->sub_step_number > 0) {
                            $tmp['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
                            $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail, $swapJenisTr);
                        }
                        else {
                            $tmp['state'] = "<span style='color:#777777'>canceled</span>";
                        }

                        $tmp['action'] = "";
                        $nextStepNum = ($row->next_substep_num);
                        $currentStepNum = ($row->sub_step_number);
                        $currentStepCode = ($row->jenis);
                        $nextStepCode = ($row->next_step_code);

                        if ($row->sub_step_number > 0) {
                            $allowFollowup = true;
                            $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$currentStepNum]['label'];
                        }

                        if (isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum])) {
                            if (isset($this->accessList[$jenisTr])) {
                                if (isset($this->accessList[$swapJenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"])) {
                                    $allowFollowup = $this->accessList[$swapJenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"];
                                    $actionLabel = $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['actionLabel'];
                                }
                            }
                            else {
                                if (in_array($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
                                    $allowFollowup = true;
                                    $actionLabel = $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['actionLabel'];
                                }
                                else {
                                    $allowFollowup = true;
                                    $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$currentStepNum]['label'];
                                }
                            }
                        }

                        if ($allowFollowup) {
                            $allowJoin = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$swapJenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;
                            $stepLabel = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['label']) ? $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['label'] : "";
                            $isCancelPacking = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['isCancelPacking']) ? $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['isCancelPacking'] : false;
                            $allowCancel = isset($this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$swapJenisTr]['steps'][$nextStepNum]['allowCancel'] : false;

                            $targetFollowupLink = $isCancelPacking == true ? "followupCancelPackingPrePreview" : "followupPrePreview";
                            $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/$targetFollowupLink/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";

                            $tmp['action'] = "<div class='input-group'>";
                            $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\">" . $actionLabel . "</a>";
                            if ($allowJoin) {
                                $tmp['action'] .= "<span class='input-group-addon'>";
                                $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                                $tmp['action'] .= "</span class='input-group-addon'>";
                            }
                            $tmp['action'] .= "</div class='input-group'>";

                            if ($allowCancel) {
                                $tmp['action'] .= "<div class='input-group'>";
                                $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\">" . $actionLabel . "</a>";
                                if ($allowJoin) {
                                    $tmp['action'] .= "<span class='input-group-addon'>";
                                    $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                                    $tmp['action'] .= "</span class='input-group-addon'>";
                                }
                                $tmp['action'] .= "</div class='input-group'>";
                            }
                        }
                        else {

                        }
                        $arrayOnpreDistribution[] = $tmp;
                        $arrayOnpreDistributionGroup[$currentStepNum][] = $tmp;
                    }
                }

            }
            else {
                $arrayOnpreDistribution = array();
            }

        }
        else {
            $arrayOnpreDistribution = array();
        }
        //        arrPrint($arrayOnpreDistribution);
        //endregion preDistribution

        //region lookup on-going transactions
        $progressFields = $historyFields;
        $progressFields['state'] = "status";
        $progressFields['action'] = "action";
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];

        $arrFilters = array();
        if (sizeof($steps) > 1) {

            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $stepCodes = array();
            $jmlStep = count($steps);

            if (isset($this->accessList[$jenisTr]) && sizeof($this->accessList) > 0) {
                $indsteps = "(";
                foreach ($this->accessList[$jenisTr] as $stepNumber => $stepSpec) {
                    if ($stepNumber <= $jmlStep) {
                        foreach ($stepSpec as $targetCode => $filters) {
                            $indsteps .= "'$targetCode',";
                            $stepCodes[] = $targetCode;
                            if ($filters['allowFollowUp'] == "true") {
                                $arrFilters["allowFollowUp"][] = $targetCode;
                            }

                        }
                    }
                }
                $indsteps = rtrim($indsteps, ",");
                $indsteps .= ")";
                if (sizeof($arrFilters) > 0) {
                    $tr->addFilter("next_step_code in $indsteps");
                }
                else {
                    $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
                    $tr->addFilter("next_step_code!=''");
                }
            }
            else {

            }

            $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
            $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");
            $tr->addFilter("next_substep_code<>''");
            $tr->addFilter("sub_step_number>0");
            $tr->addFilter("valid_qty>0");
            if ($this->session->login['employee_type'] == "employee_freelance") {
                $tr->addFilter("seller_id='" . $this->session->login['id'] . "'");
            }

            $tmpHist = $tr->lookupRecentUndoneEntries_joined($sesionReplacer)->result();
//            cekHitam($this->db->last_query());
            $arrayOnprogress = array();
            $arrayOnprogressGroup = array();
            $arrayOnprogressPartialMark = array();
            $arrayOnprogressGroupPartialMark = array();

            $extData = "";
            $extact = "";
            $selectProcessor = "";
            //end resetor jembreng ppn
            if (sizeof($tmpHist) > 0) {
                $arrTransID = array();
                $arrTransTopID = array();
                $arrIdsHist = array();
                $arrTransHist = array();
                $arrNextAction = array();
                foreach ($tmpHist as $row) {
                    $arrTransID[] = $row->transaksi_id;
                    $arrTransTopID[] = $row->id_top;
                    $arrNextAction[$row->transaksi_id] = array(
                        "next_step_num" => $row->next_substep_num,
                        "next_step_code" => $row->next_substep_code,
                    );
                    if ($row->ids_his != "") {
                        $hist = blobDecode($row->ids_his);
                        foreach ($hist as $hisSpec) {
                            $arrIdsHist[$row->id][$hisSpec['step']] = array(
                                "step" => $hisSpec['step'],
                                "trID" => $hisSpec['trID'],
                                "nomer" => $hisSpec['nomer'],
                            );
                            $arrTransHist[] = $hisSpec['trID'];
                        }
                    }
//                    arrPrint($row);
                }

                $tmpReg_result = array();
                if (sizeof($pairRegistries) > 0) {
                    foreach ($pairRegistries as $param) {

                        $trReg = new MdlTransaksi();
                        $trReg->setFilters(array());
                        $trReg->addFilter("param='$param'");
                        $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                        $tmpReg = $trReg->lookupRegistries()->result();

                        if (sizeof($tmpReg) > 0) {
                            foreach ($tmpReg as $regRow) {
                                $param = $regRow->param;
                                $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                            }
                        }
                    }
                }


                $arrNextPIC = callNextPIC($arrNextAction);

                if (sizeof($arrIdsHist) > 0) {
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("id in ('" . implode("','", $arrTransHist) . "')");
                    $tmpTransHist = $tr->lookupAll()->result();


                    if (sizeof($tmpTransHist) > 0) {
                        foreach ($tmpTransHist as $histSpec) {
                            $tmpTransHist_result[$histSpec->id] = array(
                                "oleh_id" => $histSpec->oleh_id,
                                "oleh_nama" => $histSpec->oleh_nama,
                            );
                        }
                    }

                    foreach ($arrIdsHist as $trID => $histSpec) {
                        foreach ($histSpec as $step => $detailSpec) {
                            if (array_key_exists($detailSpec['trID'], $tmpTransHist_result)) {
                                $detailSpec['main'] = $tmpTransHist_result[$detailSpec['trID']];
                            }
                            $arrTransMainHist[$trID][$step] = $detailSpec;
                        }
                    }
                }

                $numb = 0;
                foreach ($tmpHist as $row) {
//arrPrint($row);
                    $extHistoryFields2 = isset($arrExtHistoryFields2[$row->step_number]) ? $arrExtHistoryFields2[$row->step_number] : array();

                    if (sizeof($pairRegistries) > 0) {
                        if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->transaksi_id]))) {
                            foreach ($tmpReg_result[$row->transaksi_id] as $param => $eReg) {
                                if ($param == "main") {
                                    foreach ($eReg as $k => $v) {
                                        if (!isset($row->$k)) {
                                            $row->$k = $v;
                                        }
                                    }
                                }
                                elseif ($param == "items") {
                                    if (sizeof($extHistoryFields2) > 0) {
                                        foreach ($extHistoryFields2 as $k1 => $v1) {
                                            if (is_array($v1)) {
                                                $kolom = $v1['kolom'];
                                                $format = $v1['format'];
//                                                cekHitam(":: $kolom :: $format ::");
                                                if (!isset($row->$k1)) {
                                                    $tmpDetail = "";
                                                    foreach ($eReg as $eeReg) {
                                                        $valDetail = formatField($format, $eeReg[$kolom]);
                                                        $tmpDetail .= "<span>$valDetail</span><br>";
                                                    }
                                                    $row->$k1 = $tmpDetail;
                                                }
                                            }
                                            else {
                                                if (!isset($row->$k1)) {
                                                    $tmpDetail = "";
                                                    foreach ($eReg as $eeReg) {
                                                        $valDetail = formatField("nomer", $eeReg[$v1]);
                                                        $tmpDetail .= "<span>$valDetail</span><br>";
                                                    }
                                                    $row->$k1 = $tmpDetail;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
//arrPrint($row);


                    $numb++;

                    $tmp = array();
                    foreach ($historyFields as $fName => $fLabel) {
                        if (isset($row->$fName)) {
                            if (is_numeric($row->$fName)) {
                                if (!isset($sumFooter[$fName])) {
                                    $sumFooter[$fName] = 0;
                                }
                                $sumFooter[$fName] += $row->$fName;
                            }
                        }

                        if (is_array($fLabel)) {
                            $hisStep = $fLabel['step'];
                            $hisKey = $fLabel['key'];

                            if (isset($row->ids_his)) {
                                if ($hisKey == "nomer") {
                                    $returnVal = showHistoriGlobalNumbers($row->ids_his, $hisStep, true);
                                    if ($returnVal == "") {
                                        $tmp[$fName] = "-";
                                    }
                                    else {
                                        $tmp[$fName] = $returnVal;
                                    }
                                }
                                else {
                                    $ids_his_decode = blobDecode($row->ids_his);
                                    if (isset($ids_his_decode[$hisStep][$hisKey])) {
                                        $tmp[$fName] = $ids_his_decode[$hisStep][$hisKey];
                                    }
                                    else {
                                        $tmp[$fName] = "-";
                                    }
                                }
                            }
                            else {
                                $tmp[$fName] = "-";
                            }
                        }
                        else {
                            $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                        }

                        if ($fName == "no") {
                            $tmp[$fName] = formatField($fName, $numb);
                        }

                    }

                    if (sizeof($row->cancel_packing_source_id) > 0) {
                        arrPrint($row->cancel_packing_source_id);
                        $trx = new MdlTransaksi();
                        $trx->addFilter("id='" . $row->cancel_packing_source_id . "'");
                        $tmpTrx = $trx->lookupAll()->result();

                        //                        $tmp['nomer_top'] = $tmpTrx[0]->nomer;
                        $tmp['nomer_top'] = formatField("nomer_top", $tmpTrx[0]->nomer);
                        //                        arrPrint($tmpTrx[0]->nomer);
                    }


                    if ($row->sub_step_number > 0) {
                        $tmp['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
                        $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail, $jenisTr);
                    }
                    else {
                        $tmp['state'] = "<span style='color:#777777'>canceled</span>";
                    }


                    $tmp['next_pic'] = "-";
                    if (sizeof($arrNextPIC) > 0) {
                        if (isset($arrNextPIC[$row->next_substep_code][$row->next_substep_num])) {
                            $next_pic = "";
                            $nob = 1;
                            foreach ($arrNextPIC[$row->next_substep_code][$row->next_substep_num] as $spec) {
                                if ($row->cabang_id == $spec['cabang_id']) {

                                    if ($next_pic == "") {
                                        $next_pic = "$nob. " . $spec['nama'];
                                    }
                                    else {
                                        $nob++;
                                        $next_pic = $next_pic . "<br>" . "$nob. " . $spec['nama'];
                                    }

                                }

                            }
                            $tmp['next_pic'] = $next_pic;
                            //                            cekHitam($next_pic);
                        }
                    }


                    $tmp['action'] = "";
                    $nextStepNum = ($row->next_substep_num);
                    $currentStepNum = ($row->sub_step_number);
                    $currentStepCode = ($row->jenis);
                    $nextStepCode = ($row->next_step_code);


                    if ($row->sub_step_number > 0) {
                        //                        cekHere("koq");
                        $allowFollowup = true;
                        $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                    }

                    if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum])) {
                        if (isset($this->accessList[$jenisTr])) {
                            if (isset($this->accessList[$jenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"])) {
                                $allowFollowup = $this->accessList[$jenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"];
                                $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];
                            }


                        }
                        else {
                            if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
                                $allowFollowup = true;
                                $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];
                            }
                            else {
                                $allowFollowup = true;
                                $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                            }
                        }
                    }
                    $req_cancel_qty = $row->req_cancel_qty != '' ? $row->req_cancel_qty : 0;
                    $valid_qty = $row->valid_qty != '' ? $row->valid_qty : 0;


                    if ($allowFollowup) {
                        $allowJoin = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;
                        $stepLabel = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['label'] : "";
                        $isCancelPacking = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['isCancelPacking']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['isCancelPacking'] : false;
                        $allowCancel = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['allowCancel'] : false;

                        $targetFollowupLink = $isCancelPacking == true ? "followupCancelPackingPrePreview" : "followupPrePreview";

                        $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/$targetFollowupLink/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";

                        $tmp['action'] = "<div class='input-group'>";
                        $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\">" . $actionLabel . "</a>";
                        if ($allowJoin) {
                            $tmp['action'] .= "<span class='input-group-addon'>";
                            $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                            $tmp['action'] .= "</span class='input-group-addon'>";
                        }
                        $tmp['action'] .= "</div class='input-group'>";

                        if ($req_cancel_qty > 0 && $valid_qty == 0) {
                            $tmp['action'] = "<div class='btn-group' role='group' aria-label='cancel packing on progress'>";
                            $tmp['action'] .= "<button type='button' disabled class='btn btn-warning' title='sedang dalam process cancel packing' href='javascript:void(0)'>menuggu approve cancel</button>";
                            //                            $tmp['action'] .= "<button type='button' class='btn btn-warning' title='sedang dalam process cancel packing' href='javascript:void(0)'>x</button>";
                            $tmp['action'] .= "</div>";
                        }

                    }
                    else {

                    }

                    $tmpMark = array();
                    $tmp['keterangan'] = "-";
                    if ($row->partial == 1) {
                        $tmpMark['style'] = "background-color:yellow;";
                        $tmp['keterangan'] = "<span style='color:red;'>transaksi diproses sebagian</span>";
                    }


                    $arrayOnprogress[] = $tmp;
                    $arrayOnprogressGroup[$currentStepNum][] = $tmp;

                    $arrayOnprogressPartialMark[] = $tmpMark;
                    $arrayOnprogressGroupPartialMark[$currentStepNum][] = $tmpMark;

                    //                    break;
                }
            }


        }
        else {

            if (!$paymentConfig) {
                $arrayOnprogress = array();
                //ini bagian auto jembreng shopingcart
                $extData = "";
                $extact = "";
                $selectProcessor = "";
            }
            else {

                $targetJenis = $this->uri->segment(3);
                heInitCart($targetJenis);
                //==dapatkan srcJenis
                $extData = "";
                $extact = "";
                $selectProcessor = "";
                if (!isset($this->config->item("heTransaksi_ui")[$targetJenis]['shopingcartSource'])) {

                    $paymentSources = null != ($this->config->item("payment_source")) ? $this->config->item("payment_source") : array();
                    $readerDueDate = isset($this->config->item("heTransaksi_ui")[$targetJenis]['dueDateReader']) ? $this->config->item("heTransaksi_ui")[$targetJenis]['dueDateReader'] : false;

                    if (sizeof($paymentSources) > 0) {
                        foreach ($paymentSources as $src => $mainSpecs) {
                            if (sizeof($mainSpecs) > 0) {
                                foreach ($mainSpecs as $step => $sSpecTemp) {
                                    $sCtr = 0;
                                    foreach ($sSpecTemp as $sSpec) {
                                        if (isset($sSpec['jenisTarget']) && $sSpec['jenisTarget'] == $targetJenis) {
                                            $srcJenis = $sSpec['jenisSrc'];
                                            $rawSrcJenis = $src;
                                            $srcIndex = $sCtr;
                                            $srcStep = $step;
                                        }
                                        else {
                                            $srcJenis = isset($sSpec['jenisSrc']) ? $sSpec['jenisSrc'] : "";
                                            $rawSrcJenis = "";
                                            $step = "";
                                            $srcIndex = "";
                                            $srcStep = "";
                                        }
                                    }
                                    $sCtr++;
                                }
                            }
                        }
                    }
                    //                    matiHEre($srcJenis." LINE ".__LINE__);
                    $defItemLabels = array(
                        "extern_nama" => isset($paymentSources[$rawSrcJenis][$srcStep][$srcIndex]['externSrc']['extLabel']) ? $paymentSources[$rawSrcJenis][$srcStep][$srcIndex]['externSrc']['extLabel'] : "",
                        "tagihan" => "due amount",
                        "terbayar" => "paid",
                        "diskon" => "discount",
                        "sisa" => "due remain",
                        "tagihan_valas" => "due amount",
                        "terbayar_valas" => "paid",
                        "diskon_valas" => "discount",
                        "sisa_valas" => "due remain",
                    );
                    $itemLabels = (isset($this->config->item("heTransaksi_ui")[$targetJenis]["shoppingCartReferenceExternFields"])) ? $this->config->item("heTransaksi_ui")[$targetJenis]["shoppingCartReferenceExternFields"] : $defItemLabels;
                    $itemLabels["due_date"] = "due date";
                    $itemLabels["aging"] = "aging(days)";
                    $itemLabels["over_due"] = "over due";

                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("transaksi_payment_source.cabang_id='" . $this->session->login['cabang_id'] . "'");
                    $tr->addFilter("sisa>0.9");
                    if ($myPaymentConfig == true) {
                        //                        cekMerah("may payment true");
                        $tr->addFilter("extern_id='" . $this->session->login['id'] . "'");
                    }
                    $tmpSrc = $tr->lookupPaymentSrcByJenis($targetJenis)->result();
                    $tmpSrcDue = array();
                    $dueEmployee = array();
                    if ($readerDueDate) {
                        $tr->setFilters(array());
                        $tr->addFilter("status='1'");
                        $tmpSrcDue = $tr->lookupAllDueDate()->result();
                        $tempDataDues = array();
                        $validDate = array();
                        foreach ($tmpSrcDue as $tmpSrcDue_tmp) {
                            $tempDataDues[$tmpSrcDue_tmp->customers_id][] = array(
                                "due_date" => $tmpSrcDue_tmp->due_date,
                                "aging_dtime" => $tmpSrcDue_tmp->dtime,
                            );
                        }
                        $dtime_now = strtotime(date("Y-m-d"));
                        foreach ($tempDataDues as $cus_id => $tempDataDues_0) {
                            $dueVal = array();
                            $dtimeVal = array();
                            foreach ($tempDataDues_0 as $dtime_val) {
                                $keyIndex = strtotime($dtime_val['due_date']);
                                $dueVal[] = $keyIndex;
                                $dtimeVal[$keyIndex] = array(
                                    "due_date" => $dtime_val['due_date'],
                                    "aging" => $dtime_val['aging_dtime'],
                                );
                            }
                            asort($dueVal);
                            $key_index = $dueVal['0'];
                            $date_due = $dtimeVal[$key_index]['due_date'];
                            $aging = $dtimeVal[$key_index]['aging'];
                            if ($dtime_now > $key_index) {
                                $dueEmployee[$cus_id] = array(
                                    "due_date" => formatField("dtime", $date_due),
                                    "over_due" => umurDay($date_due) > 0 ? umurDay($date_due) : "0",
                                    "aging" => umurDay($aging) > 0 ? umurDay($aging) : "0",
                                );
                            }
                        }
                    }
                    $items = array();
                    $externs = array();
                    $tagihans = array();
                    $terbayars = array();
                    $sisas = array();
                    $diskons = array();
                    $tagihans_valas = array();
                    $terbayars_valas = array();
                    $sisas_valas = array();
                    $diskons_valas = array();
                    $srcLabel = "";
                    if (sizeof($tmpSrc) > 0) {
                        foreach ($tmpSrc as $row) {
                            $tmp = array();
                            $classMarking = "";
                            if (isset($dueEmployee[$row->extern_id])) {
                                $classMarking = "bg-danger";
                            }

                            if (!in_array($row->extern_id, $externs)) {
                                if (!isset($tagihans[$row->extern_id])) {
                                    $tagihans[$row->extern_id] = 0;
                                    $terbayars[$row->extern_id] = 0;
                                    $diskons[$row->extern_id] = 0;
                                    $sisas[$row->extern_id] = 0;
                                    $tagihans_valas[$row->extern_id] = 0;
                                    $terbayars_valas[$row->extern_id] = 0;
                                    $sisas_valas[$row->extern_id] = 0;
                                    $diskons_valas[$row->extern_id] = 0;
                                }

                                $tmp = (array)$row;
                                $tmp["link"] = base_url() . get_class($this) . "/selectPaymentSrc/$targetJenis/" . $row->extern_id;
                                $tmp["due_date"] = isset($dueEmployee[$row->extern_id]['due_date']) ? formatField("dtime", $dueEmployee[$row->extern_id]['due_date']) : "-";
                                $tmp["aging"] = isset($dueEmployee[$row->extern_id]['aging']) ? $dueEmployee[$row->extern_id]['aging'] : "-";
                                $tmp["over_due"] = isset($dueEmployee[$row->extern_id]['over_due']) ? $dueEmployee[$row->extern_id]['over_due'] : "-";
                                $tmp["class_marking"] = $classMarking;
                                $items[$row->extern_id] = $tmp;
                                $externs[] = $row->extern_id;
                                $externName = $row->extern_nama;
                            }
                            $tagihans[$row->extern_id] += isset($row->tagihan) ? $row->tagihan : 0;
                            $terbayars[$row->extern_id] += isset($row->terbayar) ? $row->terbayar : 0;
                            $sisas[$row->extern_id] += isset($row->sisa) ? $row->sisa : 0;
                            $diskons[$row->extern_id] += isset($row->diskon) ? $row->diskon : 0;
                            $tagihans_valas[$row->extern_id] += isset($row->tagihan_valas) ? $row->tagihan_valas : 0;
                            $terbayars_valas[$row->extern_id] += isset($row->terbayar_valas) ? $row->terbayar_valas : 0;
                            $sisas_valas[$row->extern_id] += isset($row->sisa_valas) ? $row->sisa_valas : 0;
                            $diskons_valas[$row->extern_id] += isset($row->diskon_valas) ? $row->diskon_valas : 0;
                            $srcLabel = $row->label;
                        }
                        foreach ($items as $externID => $iSpec) {
                            $items[$externID]['tagihan'] = $tagihans[$externID];
                            $items[$externID]['terbayar'] = $terbayars[$externID];
                            $items[$externID]['diskon'] = $diskons[$externID];
                            $items[$externID]['sisa'] = $sisas[$externID];
                            $items[$externID]['tagihan_valas'] = $tagihans_valas[$externID];
                            $items[$externID]['terbayar_valas'] = $terbayars_valas[$externID];
                            $items[$externID]['diskon_valas'] = $diskons_valas[$externID];
                            $items[$externID]['sisa_valas'] = $sisas_valas[$externID];
                        }
                    }
                    $arrayOnprogress = $items;
                }
                else {
                    //ini rencana du shopincart
                    cekHitam("dual shopingcart");
                    $defaultItemSrc = array(
                        "extern_date2" => "date e-faktur",
                        "extern_label2" => "e-faktur",
                        "extern_nama" => "vendor",
                        "nomer" => "invoice",
                        "extern_nilai2" => "tax base",
                        "sisa" => "input vat",
                    );
                    $defaultItemTrg = array(
                        "extern_date2" => "tgl faktur",
                        "extern_label2" => "no faktur",
                        //                        "extern_nama" => "vendor",
                        "nomer" => "no nota",
                        "extern_nilai2" => "tax base",
                        "sisa" => "output vat",
                    );
                    $defaultItemTrgEditable = array(
                        "extern_label2",
                    );

                    $paymentSources = null != ($this->config->item("payment_source")) ? $this->config->item("payment_source") : array();
                    $selectedTarget = $this->config->item("heTransaksi_ui")[$targetJenis]['shopingcartSource']['target'];
                    $returnRoutes = null != ($this->config->item("transaksi_returnRoutes")) ? $this->config->item("transaksi_returnRoutes") : array();

                    $jenisSrc = null;
                    if (sizeof($paymentSources) > 0) {
                        foreach ($paymentSources as $src => $sSpec) {
                            $payConfigs = $paymentSources[$src];
                            if (sizeof($payConfigs) > 0) {
                                //                    $sCtr = 0;
                                foreach ($payConfigs as $paymentSrcConfigTmp) {
                                    $sCtr = 0;
                                    foreach ($paymentSrcConfigTmp as $paymentSrcConfig) {
                                        if (isset($paymentSrcConfig['jenisTarget']) && $paymentSrcConfig['jenisTarget'] == $selectedTarget) {
                                            $srcJenis = $paymentSrcConfig['jenisSrc'];
                                            $rawSrcJenis = $src;
                                            $srcIndex = $sCtr;
                                            $jenisSrc = $srcJenis;
                                        }
                                        $sCtr++;
                                    }

                                }
                            }
                        }
                    }

                    $references = array();
                    if ($jenisSrc != null) {
                        if (isset($returnRoutes[$jenisSrc])) {
                            $retCode = $returnRoutes[$jenisSrc];
                            $trr = new MdlTransaksi();
                            $trr->setFilters(array());
                            $trr->addFilter("param='main'");
                            $trr->addFilter("jenis='$retCode'");
                            $tmpR = $trr->lookupRegistries_joined()->result();
                            if (sizeof($tmpR) > 0) {
                                foreach ($tmpR as $row) {
                                    $main = blobDecode($row->values);
                                    //                        arrprint($main);
                                    $references[$main['referenceID']] = array(
                                        "id" => $row->transaksi_id,
                                        "nomer" => $row->nomer,
                                        "refID" => $main['referenceID'],
                                        "refJenis" => $main['referenceJenis'],
                                        "refNum" => $main['referenceNomer'],
                                        "harga" => isset($main['harga']) ? $main['harga'] : 0,
                                        "nett" => isset($main['nett']) ? $main['nett'] : 0,


                                    );
                                }
                            }
                        }
                    }

                    //region items source
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("transaksi_payment_source.cabang_id='" . $this->session->login['cabang_id'] . "'");
                    $tr->addFilter("sisa>0.9");
                    //                    $tmpSrc = $tr->lookupPaymentSrcByJenis($selectedTarget)->result();
                    $tmpSrc = $tr->lookupPaymentSrcByJenis_joined($selectedTarget)->result();
                    $itemsSource = array();
                    $externs = array();
                    $tagihans = array();
                    $terbayars = array();
                    $sisas = array();
                    $diskons = array();
                    $tagihans_valas = array();
                    $terbayars_valas = array();
                    $sisas_valas = array();
                    $diskons_valas = array();
                    $extern_nilai2 = array();
                    $srcLabel = "";
                    $sumFooter = array();
                    if (sizeof($tmpSrc) > 0) {
                        foreach ($tmpSrc as $row) {
                            //                                                        arrPrintWebs($row);
                            $tmp = array();

                            $jenis = $row->jenis;
                            $transaksi_id = $row->id;

                            $tmp['class_bg'] = "";


                            $tmp['refID'] = array_key_exists($row->transaksi_id, $references) ? $references[$row->transaksi_id]['refID'] : "";
                            $tmp['refNum'] = array_key_exists($row->transaksi_id, $references) ? $references[$row->transaksi_id]['refNum'] : "";
                            $tmp['refValue'] = array_key_exists($row->transaksi_id, $references) ? $references[$row->transaksi_id]['nett'] : "";


                            if (isset($ppnDisabledConfig['enabled']) && $ppnDisabledConfig['enabled'] == true) {
                                //                    if (($row->ppn_sisa > 0) && ($row->ppn_status == 1)) {
                                if (($row->ppn_status == 1)) {
                                    $ppnDisabled[] = $row->transaksi_id;
                                    $tmp['notes'] = isset($ppnDisabledConfig['notes']) ? "<span style='color:red;font-size:10px;'>" . $ppnDisabledConfig['notes'] . "</span>" : "-";
                                }
                            }

                            $itemsSource[] = (array)$row + $tmp;
                            $externName = $row->extern_nama;

                            $trIDs[] = $row->transaksi_id;

                        }
                        foreach ($defaultItemSrc as $fName => $fLabel) {
                            foreach ($tmpSrc as $rowsTmp) {
                                if (isset($rowsTmp->$fName) && is_numeric($rowsTmp->$fName)) {
                                    if (!isset($sumFooter['itemsSrc'][$fName])) {
                                        $sumFooter['itemsSrc'][$fName] = 0;
                                    }
                                    $sumFooter['itemsSrc'][$fName] += $rowsTmp->$fName;
                                }
                            }

                        }
                    }
                    if (sizeof($trIDs) > 0) {
                        $this->load->model("Mdls/MdlLockerTransaksi");
                        $lt = New MdlLockerTransaksi();
                        $lt->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
                        $lt->addFilter("state='active'");
                        $lt->addFilter("jumlah='0'");
                        $lt_tmp = $lt->lookupAll()->result();
                        if (sizeof($lt_tmp) > 0) {
                            foreach ($lt_tmp as $lt_row) {
                                $lockerDisabled[] = $lt_row->transaksi_id;
                            }
                        }
                    }
                    //endregion

                    //region items
                    $jenisSrc = null;
                    if (sizeof($paymentSources) > 0) {
                        foreach ($paymentSources as $src => $sSpec) {
                            $payConfigs = $paymentSources[$src];
                            if (sizeof($payConfigs) > 0) {
                                //                    $sCtr = 0;
                                foreach ($payConfigs as $paymentSrcConfigTmp) {
                                    $sCtr = 0;
                                    foreach ($paymentSrcConfigTmp as $paymentSrcConfig) {
                                        if (isset($paymentSrcConfig['jenisTarget']) && $paymentSrcConfig['jenisTarget'] == $targetJenis) {
                                            $srcJenis = $paymentSrcConfig['jenisSrc'];
                                            $rawSrcJenis = $src;
                                            $srcIndex = $sCtr;
                                            $jenisSrc = $srcJenis;
                                        }
                                        $sCtr++;
                                    }

                                }
                            }
                        }
                    }

                    $references = array();
                    if ($jenisSrc != null) {
                        if (isset($returnRoutes[$jenisSrc])) {
                            $retCode = $returnRoutes[$jenisSrc];


                            $trr = new MdlTransaksi();
                            $trr->setFilters(array());
                            $trr->addFilter("param='main'");
                            $trr->addFilter("jenis='$retCode'");
                            $tmpR = $trr->lookupRegistries_joined()->result();
                            //cekHere($this->db->last_query());

                            if (sizeof($tmpR) > 0) {
                                foreach ($tmpR as $row) {
                                    $main = blobDecode($row->values);
                                    //                        arrprint($main);
                                    $references[$main['referenceID']] = array(
                                        "id" => $row->transaksi_id,
                                        "nomer" => $row->nomer,
                                        "refID" => $main['referenceID'],
                                        "refJenis" => $main['referenceJenis'],
                                        "refNum" => $main['referenceNomer'],
                                        "harga" => isset($main['harga']) ? $main['harga'] : 0,
                                        "nett" => isset($main['nett']) ? $main['nett'] : 0,


                                    );
                                }
                            }
                        }
                    }

                    $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();

                    //==dapatkan daftar kolom dari srcJenis
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("transaksi_payment_source.cabang_id='" . $this->session->login['cabang_id'] . "'");
                    //                    $tr->addFilter("extern_id='$externID'");
                    $tr->addFilter("sisa>0.9");

                    $tmpSrc = $tr->lookupPaymentSrcByJenis_joined($targetJenis)->result();
                    $externName = "";
                    $items = array();
                    $tempDueDate = array();
                    $ppnDisabled = array();
                    $lockerDisabled = array();
                    $trIDs = array();
                    if (sizeof($tmpSrc) > 0) {
                        //                        $sumFooter = array();
                        foreach ($tmpSrc as $rows) {
                            $tmp = array();

                            $jenis = $rows->jenis;
                            $transaksi_id = $rows->id;
                            $tmp['class_bg'] = "";
                            $tmp['refID'] = array_key_exists($rows->transaksi_id, $references) ? $references[$rows->transaksi_id]['refID'] : "";
                            $tmp['refNum'] = array_key_exists($rows->transaksi_id, $references) ? $references[$rows->transaksi_id]['refNum'] : "";
                            $tmp['refValue'] = array_key_exists($rows->transaksi_id, $references) ? $references[$rows->transaksi_id]['nett'] : "";


                            $items[] = (array)$rows + $tmp;
                            $externName = $rows->extern_nama;
                            //                            foreach($defaultItemTrg as $fname =>$fLabel){
                            //                                if (is_numeric($row->$fName)) {
                            //                                    if (!isset($sumFooter[$fName])) {
                            //                                        $sumFooter[$fName] = 0;
                            //                                    }
                            //                                    $sumFooter['items'][$fName] += $row->$fName;
                            //                                }
                            //                            }


                            $trIDs[] = $rows->transaksi_id;
                            foreach ($defaultItemTrg as $fName => $fLabel) {
                                //                                cekHitam($fName);
                                if (isset($row->$fName) && is_numeric($rows->$fName)) {
                                    if (!isset($sumFooter['items'][$fName])) {
                                        $sumFooter['items'][$fName] = 0;
                                    }
                                    $sumFooter['items'][$fName] += $rows->$fName;
                                }
                            }
                        }

                        if (sizeof($trIDs) > 0) {
                            $this->load->model("Mdls/MdlLockerTransaksi");
                            $lt = New MdlLockerTransaksi();
                            $lt->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
                            $lt->addFilter("state='active'");
                            $lt->addFilter("jumlah='0'");
                            $lt_tmp = $lt->lookupAll()->result();
                            if (sizeof($lt_tmp) > 0) {
                                foreach ($lt_tmp as $lt_row) {
                                    $lockerDisabled[] = $lt_row->transaksi_id;
                                }
                            }
                        }

                        foreach ($defaultItemTrg as $fName => $fLabel) {
                            foreach ($tmpSrc as $rowsTmp2) {
                                if (isset($rowsTmp2->$fName) && is_numeric($rowsTmp2->$fName)) {
                                    if (!isset($sumFooter['items'][$fName])) {
                                        $sumFooter['items'][$fName] = 0;
                                    }
                                    $sumFooter['items'][$fName] += $rowsTmp2->$fName;
                                }
                            }

                        }
                    }
                    //                    arrPrint(sizeof($items));
                    //                    arrPrint($items);
                    $arrayOnprogress = array(
                        "itemsSrc" => $itemsSource,
                        "items" => $items,
                    );

                    unset($progressFields);

                    $progressFields = array(
                        "itemsSrc" => $defaultItemSrc,
                        "items" => $defaultItemTrg,
                    );
                    //endregion

                    $extData = "continue " . $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'];
                    $extact = "top.$('#result').load('" . base_url() . "Transaksi/validate/" . $targetJenis . "?');";
                    $selectProcessor = array(
                        "items" => $this->config->item("heTransaksi_ui")[$this->jenisTr]["selectorProcessor"],
                        "itemsSrc" => $this->config->item("heTransaksi_ui")[$this->jenisTr]["selectorProcessor2"],
                    );

                }

            }
        }

        //endregion

        //region step distribution
        $arrayOnProgressView = array();
        $arrayOnProgressView = $this->viewIncompleteStepAntarCabang();
        if (sizeof($stepHistoryFields) > 0) {
            $stepHistoryFields['state'] = "status";
        }
        //endregion

        //region lookup histories
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        //session replacer
        if (sizeof($sesionReplacer) > 0) {
            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
            $tr->addFilter("gudang_id='" . $this->session->login['gudang_id'] . "'");
        }
        $tr->addFilter("jenis_master='" . $this->jenisTr . "'");
        if (sizeof($arrFilters) > 0) {
        }
        else {

            if ($this->session->login['employee_type'] == "employee_freelance") {
                $tr->addFilter("seller_id='" . $this->session->login['id'] . "'");
            }
            else {
                $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
            }
        }

        $tmpHist_0 = $tr->lookupAll()->result();
        // cekLime($this->db->last_query());
        $tr->setFilters(array());


        $arrayHistory = array();
        if (sizeof($tmpHist_0) > 0) {
            $master = "(";
            foreach ($tmpHist_0 as $row0) {
                $master .= "'$row0->id_master',";
            }
            $master = rtrim($master, ",");
            $master .= ")";
            //           // ambil dari id master
            $trHis = new MdlTransaksi();
            if (strlen($master) > 2) {
                $trHis->addFilter("id_master in $master");
            }

            $tmpHist = $trHis->lookupRecentHistories(5)->result();
            $arrTransID = array();
            $arrTransTopID = array();
            $arrIdsHist = array();
            $arrTransHist = array();
            $arrNextAction = array();
            foreach ($tmpHist as $row) {
                $arrTransID[] = $row->id;
                $arrTransTopID[] = $row->id_top;
                //                $arrNextAction[$row->id] = array(
                //                    "next_step_num" => $row->next_step_num,
                //                    "next_step_code" => $row->next_step_code,
                //                );
                if ($row->ids_his != "") {
                    $hist = blobDecode($row->ids_his);
                    foreach ($hist as $hisSpec) {
                        $arrIdsHist[$row->id][$hisSpec['step']] = array(
                            "step" => $hisSpec['step'],
                            "trID" => $hisSpec['trID'],
                            "nomer" => $hisSpec['nomer'],
                        );
                        $arrTransHist[] = $hisSpec['trID'];
                    }
                }
            }
            $tmpReg_result = array();
            $trReg = new MdlTransaksi();
            $trReg->setFilters(array());
            $trReg->addFilter("param='main'");
            $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
            $tmpReg = $trReg->lookupRegistries()->result();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $regRow) {
                    $param = $regRow->param;
                    $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                }
            }
            if (sizeof($arrIdsHist) > 0) {
                $tr = new MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id in ('" . implode("','", $arrTransHist) . "')");
                $tmpTransHist = $tr->lookupAll()->result();


                if (sizeof($tmpTransHist) > 0) {
                    foreach ($tmpTransHist as $histSpec) {
                        $tmpTransHist_result[$histSpec->id] = array(
                            "oleh_id" => $histSpec->oleh_id,
                            "oleh_nama" => $histSpec->oleh_nama,
                        );
                    }
                }

                foreach ($arrIdsHist as $trID => $histSpec) {
                    foreach ($histSpec as $step => $detailSpec) {
                        if (array_key_exists($detailSpec['trID'], $tmpTransHist_result)) {
                            $detailSpec['main'] = $tmpTransHist_result[$detailSpec['trID']];
                        }
                        $arrTransMainHist[$trID][$step] = $detailSpec;
                    }
                }
            }
            $numb = 0;

            foreach ($tmpHist as $row) {
                if (sizeof($pairRegistries) > 0) {
                    if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->id]))) {
                        foreach ($tmpReg_result[$row->id] as $param => $eReg) {
                            foreach ($eReg as $k => $v) {
                                if (!isset($row->$k)) {
                                    $row->$k = $v;
                                }
                            }
                        }
                    }
                }

                $numb++;


                $tmp = array();
                $tmp['dtime'] = $row->dtime;
                foreach ($historyFields as $fName => $fLabel) {
                    if (is_array($fLabel)) {
                        $hisStep = $fLabel['step'];
                        $hisKey = $fLabel['key'];

                        if (isset($row->ids_his)) {
                            $returnVal = showHistoriGlobalNumbers($row->ids_his, $hisStep, true);
                            if ($returnVal == "") {
                                $tmp[$fName] = "-";
                            }
                            else {
                                $tmp[$fName] = $returnVal;
                            }
                        }
                        else {
                            $tmp[$fName] = "-";
                        }
                    }
                    else {
                        $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                    }

                    if ($fName == "no") {
                        $tmp[$fName] = formatField($fName, $numb);
                    }
                }
                $tmp['next_pic'] = "-";


                $arrayHistory[] = $tmp;
            }
        }

        //endregion

        //region link to add new transaction

        //tambahin hak akses custom

        if (placeCanMakeTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr)) {
            //        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['userGroup'], $this->session->login['membership'])) {
            $createIndexes = (null != $this->config->item("transaksi_createIndex")) ? $this->config->item("transaksi_createIndex") : array();
            $isDisableMakeTrans = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['isDisableMakeTrans']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['isDisableMakeTrans'] : false;
            if (array_key_exists($this->jenisTr, $createIndexes)) {
                $targetUrl = base_url() . $createIndexes[$this->jenisTr] . "/" . $this->jenisTr;
            }
            else {
                $targetUrl = base_url() . "Transaksi/createForm/" . $this->jenisTr;
            }

            if ($isDisableMakeTrans) {
                $addLink = null;
                //                $_SESSION['errMsg'] = "test error dari 1982";
                //                arrPrint( $this->session->errMsg );
            }
            else {
                $addLink = array(
                    "link" => $targetUrl,
                    "label" => "<span class='glyphicon glyphicon-plus'></span> create new " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
                );
            }

        }
        else {
            $addLink = null;
        }
        //endregion

        //region generate activity reports
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("jenis_master='" . $this->jenisTr . "'");
        $tr->addFilter("month(dtime)='" . date("m") . "'");
        $tr->addFilter("year(dtime)='" . date("Y") . "'");
        $tr->addFilter("day(dtime)='" . date("d") . "'");
        if ($this->session->login['employee_type'] == "employee_freelance") {
            $tr->addFilter("seller_id='" . $this->session->login['id'] . "'");
        }
        if (sizeof($tmpHist_0) > 0) {
            if (strlen($master) > 2) {
                $tr->addFilter("id_master in $master");
            }
        }

        $tmpRecap = $tr->lookupAll()->result();

        $sumFields = isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['reportSumFields']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['reportSumFields'] : array();
        $arrayRecap = array();

        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $stepSpec) {
            $recapCodes[$stepSpec['target']] = "<a href='" . base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr . "/" . $stepSpec['target'] . "'>" . $stepSpec['label'] . "</a>";
        }
        $recapProp = array();
        $entities = array();
        if (sizeof($tmpRecap) > 0) {
            foreach ($tmpRecap as $row) {
                //cekHere($row->id);

                if (isset($sumFields) && sizeof($sumFields) > 0) {
                    foreach ($sumFields as $idField => $nameField) {
                        if (!array_key_exists($row->$idField, $entities)) {
                            $entities[$row->$idField] = $row->$nameField;
                        }
                        if (!isset($recapProp[$row->jenis][$row->$idField])) {
                            $recapProp[$row->jenis][$row->$idField] = array(
                                "freq" => 0,
                                "value" => 0,
                            );
                        }
                        $recapProp[$row->jenis][$row->$idField]['freq'] += 1;
                        $recapProp[$row->jenis][$row->$idField]['value'] += $row->transaksi_nilai;
                    }
                }
            }
        }


        if (sizeof($entities) > 0) {
            foreach ($entities as $eID => $eName) {
                $tmp = array();
                $tmp["name"] = $eName;
                foreach ($recapCodes as $cID => $cName) {
                    $fieldValue = isset($recapProp[$cID][$eID]['value']) ? $recapProp[$cID][$eID]['value'] : 0;
                    $tmp[$cID] = "<span class='btn-block text-right'>" . number_format($fieldValue) . "</span>";
                }
                $arrayRecap[] = $tmp;
            }
        }

        $recapLabels['name'] = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakLabel']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakLabel'] : "label";
        $recapLabels = $recapLabels + $recapCodes;
        //endregion

        //        $sumFooterResult = array();
        //        if (isset($sumFooter) && sizeof($sumFooter) > 0) {
        //            foreach ($sumFooter as $key => $val) {
        //                $sumFooterResult[$key] = formatField($key, $val);
        //            }
        //        }
        //        arrPrint($selectProcessor);
        //        matiHEre();

        $jenisTrsub = isset($_GET['step']) ? $_GET['step'] : 1;
        $historyFieldsDt = isset($this->config->item("heTransaksi_ui")[$jenisTr]['historyFields'][$jenisTrsub]) ? $this->config->item("heTransaksi_ui")[$jenisTr]['historyFields'][$jenisTrsub] : $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $availDbTable = $tr->getAvailTable($historyFieldsDt);

        //-----------------------------------------------------
        $arrJenisTrCek = array("587", "687", "1587", "1687");
        if (in_array($jenisTr, $arrJenisTrCek)) {
            $transaksiName = isset($this->config->item("heTransaksi_ui")[$jenisTr]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['label'] : NULL;
            $subplace = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['subplace']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['subplace'] : NULL;
            if ($subplace != NULL) {
                if (($subplace == "warehouse") && ($this->session->login['gudang_id'] < 0)) {
                    //                    cekPink("SESUAI");
                    $msg = NULL;
                }
                elseif (($subplace == "warehouse_ng") && ($this->session->login['gudang_id'] > 0)) {
                    //                    cekPink("SESUAI NOT GOOD");
                    $msg = NULL;
                }
                else {
                    $msg = "Anda tidak memiliki kewenangan untuk membuat request $transaksiName";
                    $addLink = array();
                }
            }
        }
        //        arrPrintWebs($this->session->login);
        //-----------------------------------------------------
        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;
        cekMerah("Grabing data " . $val . " Seconds");

        //region prepare params to viewer
        $data = array(
            "mode" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["mode"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["mode"] : $this->uri->segment(2),
            "isMobile" => $isMob,
            "errMsg" => $this->session->errMsg,
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            'addLink' => $addLink,
            "allSteps" => $this->allSteps,
            //            "historyTitle" => "<span class='glyphicon glyphicon-time'></span> " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " histories",
            "historyTitle" => "<span class='glyphicon glyphicon-time'></span> recent " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " histories",
            "arrayHistoryLabels" => array("dtime" => "time") + $historyFields,
            "arrayHistoryLabelsDt" => $historyFieldsDt,
            "availDbTable" => $availDbTable,
            "arrayHistory" => $arrayHistory,
            //            "onprogressTitle" => "<span class='glyphicon glyphicon-alert'></span> incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "onprogressTitle" => "<span class='glyphicon glyphicon-alert'></span> TRANSAKSI YANG PERLU ACTION ",
            "arrayProgressLabels" => $progressFields,
            "arrayOnProgressToPay" => $paymentConfig,
            "itemLabels" => isset($itemLabels) ? $itemLabels : "",
            "srcLabel" => isset($srcLabel) ? $srcLabel : "",
            //            "arrayOnProgress" => array_merge($arrayOnprogress, $arrayOnprePre, $arrayOnpreDistribution),
            "steps" => $steps,
            "arrayOnProgress" => (isset($arrayOnprogress) && sizeof($arrayOnprogress) > 0) ? $arrayOnprogress : array(),
            "arrayOnprogressGroup" => (isset($arrayOnprogressGroup) && (sizeof($arrayOnprogressGroup) > 0)) ? $arrayOnprogressGroup : array(),

            "arrayOnprePre" => $arrayOnprePre,
            "arrayOnprePreGroup" => $arrayOnprePreGroup,

            "arrayOnpreDistribution" => $arrayOnpreDistribution,
            "arrayOnpreDistributionGroup" => $arrayOnpreDistributionGroup,

            "entities" => $entities,
            //            "recapTitle" => "<span class='fa fa-newspaper-o'></span> today " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " reports (" . date("F Y") . ")",
            "recapTitle" => "<span class='fa fa-newspaper-o'></span> today " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " reports",
            "arrayRecapLabels" => $recapLabels,
            "arrayRecap" => $arrayRecap,

            "onprogressViewTitle" => "<span class='fa fa-eye'></span> show incomplete step " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "onprogressViewSubTitle" => "<span class='text-black'>(daftar transaksi yang masih stanby di cabang tujuan)</span>",
            "arrayOnProgressView" => $arrayOnProgressView,
            "stepHistoryFields" => $stepHistoryFields,
            //            "selectProcessor" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["mode"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["selectorProcessor"] : "",
            "selectProcessor" => $selectProcessor,
            "sumFooter" => (isset($sumFooterResult) && sizeof($sumFooterResult) > 0) ? $sumFooter : array(),
            //            "sumFooter" => $sumFooterResult,
            "scriptBottom" => $scriptBottom,
            "btnLabel" => $extData,
            "actionTarget" => $extact,
            "sumFooter" => isset($sumFooter) ? $sumFooter : "",

            "arrayOnprogressPartialMark" => (isset($arrayOnprogressPartialMark) && sizeof($arrayOnprogressPartialMark) > 0) ? $arrayOnprogressPartialMark : array(),
            "arrayOnprogressGroupPartialMark" => (isset($arrayOnprogressGroupPartialMark) && sizeof($arrayOnprogressGroupPartialMark) > 0) ? $arrayOnprogressGroupPartialMark : array(),

            "defaultItemTrgEditable" => isset($defaultItemTrgEditable) ? $defaultItemTrgEditable : array(),
            "editItemTrg" => base_url() . "_followupLiveEdit/editEfaktur/" . $this->jenisTr . "/",
        );
        //endregion
        $this->load->view("transaksi", $data);

    }

    public function createForm()
    {

        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }


        //===pageView options
        if (!isset($_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'])) {
            $viewModeConfig = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['defaultViewMode']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['defaultViewMode'] : "list";
            $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] = isset($_GET['viewMode']) ? $_GET['viewMode'] : $viewModeConfig;
        }
        $viewModeSpec = array(
            "icon" => "",
            "url" => "",
        );
        $thisPage = base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3);
        switch ($_SESSION["opt_" . $this->jenisTr]['opt']['viewMode']) {
            case "list":
                $viewModeSpec = array(
                    "icon" => "	glyphicon glyphicon-th-large",
                    "url" => $thisPage . "?viewMode=thumbnail",
                );
                break;
            case "thumbnail":
                $viewModeSpec = array(
                    "icon" => "glyphicon glyphicon-align-justify",
                    "url" => $thisPage . "?viewMode=list",
                );
                break;
        }
        $viewModeSwitch = "<a href='javascript:void(0)' onclick=\"location.href='" . $viewModeSpec['url'] . "';\"><span class='" . $viewModeSpec['icon'] . "'></span></a>";


        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        //        arrprint($this->uri->segment_array());
        //        arrprint($this->session->login);

        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        if (isset($_SESSION[$cCode]['mode']) && array_key_exists("edit", $_SESSION[$cCode]['mode'])) {
            $selectedID = $_SESSION[$cCode]['mode']['edit'];
            $title = "";
            $subTitle = "Edit " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'];
            //            cekHitam("biruuu");
        }
        elseif (isset($_SESSION[$cCode]['mode']) && array_key_exists("cancel", $_SESSION[$cCode]['mode'])) {
            $selectedID = $_SESSION[$cCode]['mode']['cancel'];
            $title = "" . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'];
            $subTitle = "" . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'];
        }
        else {
            $title = $this->config->item("heTransaksi_ui")[$jenisTr]["label"];
            $subTitle = $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'];
        }

        //-----------------------------------------------------
        $arrJenisTrCek = array("587", "687", "1587", "1687");
        if (in_array($jenisTr, $arrJenisTrCek)) {
            $transaksiName = isset($this->config->item("heTransaksi_ui")[$jenisTr]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['label'] : NULL;
            $subplace = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['subplace']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['subplace'] : NULL;
            if ($subplace != NULL) {
                if (($subplace == "warehouse") && ($this->session->login['gudang_id'] < 0)) {
                    //                    cekPink("SESUAI");
                }
                elseif (($subplace == "warehouse_ng") && ($this->session->login['gudang_id'] > 0)) {
                    //                    cekPink("SESUAI NOT GOOD");
                }
                else {
                    $msg = "Anda tidak memiliki kewenangan untuk membuat request $transaksiName";
                    $alerts = array(
                        "type" => "warning",
                        "html" => "$msg",
                    );
                    echo swalAlert($alerts);
                    //                    echo toAlert($msg);
                    redirecResult(base_url() . get_class($this) . "/index/" . $this->uri->segment(3));
                }
            }
        }

        //-----------------------------------------------------


        heInitGates($this->jenisTr);

        $globalTemplate = "";
        $globalTemplate .= "<span>";
        $globalTemplateUrl = base_url() . "Selectors/_globalTemplate/globalTemplate/$cCode";
        if (isset($_SESSION[$cCode]['globalTemplate']) && $_SESSION[$cCode]['globalTemplate'] == 1) {
            $globalTemplate .= "
                <label class='radio-inline'>
                  <input type='radio' onchange=\"console.log('$globalTemplateUrl/0');top.$('#result').load('$globalTemplateUrl/0');\" name='globalTemplate'>Default
                </label>
                <label class='radio-inline'>
                  <input type='radio' onchange=\"console.log('$globalTemplateUrl/1');top.$('#result').load('$globalTemplateUrl/1');\" name='globalTemplate' checked>WideView
                </label>
                ";
        }
        else {
            $globalTemplate .= "
                <label class='radio-inline'>
                  <input type='radio' onchange=\"console.log('$globalTemplateUrl/0');top.$('#result').load('$globalTemplateUrl/0');\" name='globalTemplate' checked>Default
                </label>
                <label class='radio-inline'>
                  <input type='radio' onchange=\"console.log('$globalTemplateUrl/1');top.$('#result').load('$globalTemplateUrl/1');\" name='globalTemplate'>WideView
                </label>
                ";
        }
        $globalTemplate .= "</span>";


        $connectTo = isset($this->config->item("heTransaksi_ui")[$jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['connectTo'] : "";
        $stepHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStepHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortStepHistoryFields'] : array();


        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $historyFields = $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $glanceHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields'] : array("nomer" => "receipt no");
        $itemAddConfig = isset($this->config->item("heTransaksi_ui")[$jenisTr]['itemAddConfig']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['itemAddConfig'] : true;
        $glanceHistoryFields2 = array("nomer" => "receipt no"); //init;
        $selectorProcessor = base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]['selectorProcessor'] . "/$jenisTr";
        $uploadConfig = isset($this->config->item("heTransaksi_ui")[$jenisTr]['uploadFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['uploadFields'] : array();
        //        arrPrint($uploadConfig);
        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }
        //
        //region lookup on-going transactions
        $arrayOnprogress = array();
        $progressFields = $historyFields;
        $progressFields['state'] = "status";
        $progressFields['action'] = "action";
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        //endregion

        //region menambah supplier/customer (kalau berwenang)
        $pihakModel = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakModel']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakModel'] : "";
        $pihakMainModel = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakModelMain']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakModelMain'] : "";
        $dataAccess = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel] : array(
            "viewers" => array(),
            "creators" => array(),
            "creatorAdmins" => array(),
            "updaters" => array(),
            "updaterAdmins" => array(),
            "deleters" => array(),
            "deleterAdmins" => array(),
            "historyViewers" => array(),
        );
        $dataLabel = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel]['label'] : $pihakModel;
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $addPihakStr = "";
        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $pihakModel);
        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $dataLabel . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        }
                                        );";
                $addPihakStr = "<span class='input-group-btn'>
                                        <a href='javascript:void(0)' title='add $dataLabel' data-toggle='tooltip' data-placement='right' class='btn btn-default' onclick=\"$addClick\">
                                            <span class='fa fa-user-plus'>                                            
                                             </span>
                                        </a>
                                </span>";
            }
        }
        //endregion

        //region menambah item/produk (kalau berwenang)
        $pihakModel = $this->config->item('heTransaksi_ui')[$this->jenisTr]['selectorModel'];
        $dataAccess = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel] : array(
            "viewers" => array(),
            "creators" => array(),
            "creatorAdmins" => array(),
            "updaters" => array(),
            "updaterAdmins" => array(),
            "deleters" => array(),
            "deleterAdmins" => array(),
            "historyViewers" => array(),
        );
        $dataLabel = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel]['label'] : $pihakModel;
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $addItemStr = "";
        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $pihakModel);
        //        arrprint($dataAccess['creators']);
        $relPihak = "?cCode=$cCode&pId=yes";
        // cekHere($relPihak);
        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $dataLabel . "',
                                        message: $('<div></div>').load('" . $addLink . $relPihak . "'),
                                        draggable:true,
                                        closable:true,
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        }
                                        );";
                $addItemStr = "<span class='input-group-btn'>
                                        <a href='javascript:void(0)' title='add $dataLabel' data-toggle='tooltip' data-placement='right' class='btn btn-default' onclick=\"$addClick\">
                                            <span class='fa fa-plus-circle'>                                            
                                             </span>
                                        </a>
                                </span>";
            }
        }
        //endregion


        //
        //region lookup on-going from connected requests
        $progress2Fields = array();
        $arrayOnprogress2 = array();
        $needToClear = false;
        //endregion


        //region incomplete step antar cabang
        $arrayOnProgressView = array();
        $arrayOnProgressView = $this->viewIncompleteStepAntarCabang();
        if (sizeof($stepHistoryFields) > 0) {
            $stepHistoryFields['state'] = "status";
        }
        //endregion


        //
        //region lookup histories
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("transaksi.gudang_id='" . $this->session->login['gudang_id'] . "'");
        $tr->addFilter("transaksi.jenis_master='" . $this->jenisTr . "'");
        if ($this->session->login['employee_type'] == "employee_freelance") {
            $tr->addFilter("seller_id='" . $this->session->login['id'] . "'");
        }
        //        $tr->addFilter("transaksi.next_step_code=''");
        $tmpHist = $tr->lookupRecentHistories(5)->result();

        $arrayHistory = array();
        if (sizeof($tmpHist) > 0) {
            $arrTransID = array();
            $arrTransTopID = array();
            $arrIdsHist = array();
            $arrTransHist = array();
            foreach ($tmpHist as $row) {
                $arrTransID[] = $row->id;
                $arrTransTopID[] = $row->id_top;

                if ($row->ids_his != "") {
                    $hist = blobDecode($row->ids_his);
                    foreach ($hist as $hisSpec) {
                        $arrIdsHist[$row->id][$hisSpec['step']] = array(
                            "step" => $hisSpec['step'],
                            "trID" => $hisSpec['trID'],
                            "nomer" => $hisSpec['nomer'],
                        );
                        $arrTransHist[] = $hisSpec['trID'];
                    }
                }
            }
            $tmpReg_result = array();
            $trReg = new MdlTransaksi();
            $trReg->setFilters(array());
            $trReg->addFilter("param='main'");
            $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
            $tmpReg = $trReg->lookupRegistries()->result();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $regRow) {
                    $param = $regRow->param;
                    $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                }
            }
            if (sizeof($arrIdsHist) > 0) {
                $tr = new MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id in ('" . implode("','", $arrTransHist) . "')");
                $tmpTransHist = $tr->lookupAll()->result();


                if (sizeof($tmpTransHist) > 0) {
                    foreach ($tmpTransHist as $histSpec) {
                        $tmpTransHist_result[$histSpec->id] = array(
                            "oleh_id" => $histSpec->oleh_id,
                            "oleh_nama" => $histSpec->oleh_nama,
                        );
                    }
                }

                foreach ($arrIdsHist as $trID => $histSpec) {
                    foreach ($histSpec as $step => $detailSpec) {
                        if (array_key_exists($detailSpec['trID'], $tmpTransHist_result)) {
                            $detailSpec['main'] = $tmpTransHist_result[$detailSpec['trID']];
                        }
                        $arrTransMainHist[$trID][$step] = $detailSpec;
                    }
                }
            }
            $numb = 0;
            foreach ($tmpHist as $row) {
                if (sizeof($pairRegistries) > 0) {
                    if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->id]))) {
                        foreach ($tmpReg_result[$row->id] as $param => $eReg) {
                            foreach ($eReg as $k => $v) {
                                if (!isset($row->$k)) {
                                    $row->$k = $v;
                                }
                            }
                        }
                    }
                }
                $tmp = array();
                $numb++;
                foreach ($historyFields as $fName => $fLabel) {
                    if (is_array($fLabel)) {
                        $hisStep = $fLabel['step'];
                        $hisKey = $fLabel['key'];

                        if (isset($row->ids_his)) {
                            $returnVal = showHistoriGlobalNumbers($row->ids_his, $hisStep, true);
                            if ($returnVal == "") {
                                $tmp[$fName] = "-";
                            }
                            else {
                                $tmp[$fName] = $returnVal;
                            }
                        }
                        else {
                            $tmp[$fName] = "-";
                        }
                    }
                    else {
                        $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                    }

                    if ($fName == "no") {
                        $tmp[$fName] = formatField($fName, $numb);
                    }
                }
                $arrayHistory[] = $tmp;
            }
        }
        //endregion


        //region lookup histories (swapJenis)
        $swapJenisTr = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['requestCode']['masterCode']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['requestCode']['masterCode'] : array();
        $arrayHistoryR = array();
        if (sizeof($swapJenisTr)) {

            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            //            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
            //            $tr->addFilter("transaksi.gudang_id='" . $this->session->login['gudang_id'] . "'");
            $tr->addFilter("transaksi.jenis_master='" . $swapJenisTr . "'");

            $tmpHist = $tr->lookupRecentHistories(5)->result();

            if (sizeof($tmpHist) > 0) {
                $arrTransID = array();
                $arrTransTopID = array();
                $arrIdsHist = array();
                $arrTransHist = array();
                foreach ($tmpHist as $row) {
                    $arrTransID[] = $row->id;
                    $arrTransTopID[] = $row->id_top;

                    if ($row->ids_his != "") {
                        $hist = blobDecode($row->ids_his);
                        foreach ($hist as $hisSpec) {
                            $arrIdsHist[$row->id][$hisSpec['step']] = array(
                                "step" => $hisSpec['step'],
                                "trID" => $hisSpec['trID'],
                                "nomer" => $hisSpec['nomer'],
                            );
                            $arrTransHist[] = $hisSpec['trID'];
                        }
                    }
                }
                $tmpReg_result = array();
                $trReg = new MdlTransaksi();
                $trReg->setFilters(array());
                $trReg->addFilter("param='main'");
                $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                $tmpReg = $trReg->lookupRegistries()->result();

                if (sizeof($tmpReg) > 0) {
                    foreach ($tmpReg as $regRow) {
                        $param = $regRow->param;
                        $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                    }
                }
                foreach ($tmpHist as $row) {
                    if (sizeof($pairRegistries) > 0) {
                        if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->id]))) {
                            foreach ($tmpReg_result[$row->id] as $param => $eReg) {
                                foreach ($eReg as $k => $v) {
                                    if (!isset($row->$k)) {
                                        $row->$k = $v;
                                    }
                                }
                            }
                        }
                    }
                    $tmp = array();
                    foreach ($historyFields as $fName => $fLabel) {
                        $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                    }
                    $arrayHistoryR[] = $tmp;
                }
            }
        }

        //endregion
        //

        //cekHitam();
        $barcodeSettings = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['barcodeSettings']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['barcodeSettings'] : array();

        //==mobile scan (if possible)
        $mobScanStr = sizeof($barcodeSettings) ? "<span class='input-group-btn'>
                                        <a href='javascript:void(0)' class='btn btn-default' onclick=\"getScan()\">
                                            <span class='glyphicon glyphicon-qrcode'>                                            
                                             </span>
                                        </a>
                                </span>" : "";


        //region external tool
        if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['extTool'])) {
            $extToolConfig = $this->config->item("heTransaksi_ui")[$jenisTr]['extTool'];
            $srcVar = $extToolConfig['sentParam'];
            $srcField = $extToolConfig['sentField'];
            $externSrc = $extToolConfig['externSrc'];
            $rawParam = array();
            $backUrl = base_url() . $extToolConfig['backUrl'];
            if (isset($_SESSION[$cCode][$srcVar]) && sizeof($_SESSION[$cCode][$srcVar]) > 0) {

                foreach ($_SESSION[$cCode][$srcVar] as $id => $rSpec) {
                    if (isset($rSpec[$srcField])) {
                        $rawParam[$id] = $rSpec[$srcField];
                    }
                }
            }
            //arrPrint($rawParam);die();
            if (sizeof($rawParam) > 0) {
                $param = base64_encode(serialize($rawParam));
                $backUrl = base64_encode(serialize($backUrl));
                $extTool = "<a class='btn btn-default' href='javascript:void(0)' onclick=\"window.open('" . $extToolConfig['url'] . "?param=$param&extern=" . $_SESSION[$cCode]['main'][$externSrc] . "&back=$backUrl','wTool');\" >" . $extToolConfig['label'] . "</a>";
            }
            else {
                $extTool = "<a class='btn btn-default' disabled>" . $extToolConfig['label'] . "</a>";
            }

        }
        else {
            //cekMerah("extTool doesnt exist");
            $extTool = "";
        }
        //endregion

        $allowTmpSave = isset($this->config->item("heTransaksi_ui")[$jenisTr]['allowTmpSave']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['allowTmpSave'] : false;

        //region prepare params to viewer


        $data = array(
            "mode" => $this->uri->segment(2),
            "modeedit" => isset($_SESSION[$cCode]['mode']) && array_key_exists("edit", $_SESSION[$cCode]['mode']) || isset($_SESSION[$cCode]['mode']) && array_key_exists("cancel", $_SESSION[$cCode]['mode']) ? "_off" : "",
            "modeeditopt" => isset($_SESSION[$cCode]['mode']) && array_key_exists("edit", $_SESSION[$cCode]['mode']) || isset($_SESSION[$cCode]['mode']) && array_key_exists("cancel", $_SESSION[$cCode]['mode']) ? "data-toggle='tooltip' data-placement='top' data-original-title='tidak bisa ganti CUSTOMER pada mode EDIT/CANCEL'" : "",
            "isMobile" => $isMob,
            "errMsg" => $this->session->errMsg,
            "globalTemplate" => isset($globalTemplate) ? $globalTemplate : "",
            "template" => isset($_SESSION[$cCode]['globalTemplate']) && $_SESSION[$cCode]['globalTemplate'] == 1 ? str_replace(".html", "_v2.html", $this->config->item("heTransaksi_ui")[$jenisTr]["template"]) : $this->config->item("heTransaksi_ui")[$jenisTr]["template"],

            //            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "title" => $title,
            //            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "subTitle" => $subTitle,
            "jenisTr" => $jenisTr,
            "jenisTransaksi" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            //            "selectorCaller" => base_url() . "_selectorItem/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],
            "selectorCaller" => isset($_SESSION[$cCode]['main']['pihakMdlName']) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $_SESSION[$cCode]['main']['pihakMdlName'] : base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],
            //            "selectorCaller" => base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],
            "selectorLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel"],
            "selectorCaller2" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller2"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller2"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel2"] : "",
            "selectorLabel2" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel2"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel2"] : "",
            "selectorExternLabel" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel2"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel2"] : "",
            "pihakCaller" => base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel"],
            "pihakCaller2" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller2"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller2"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel2"] : "",
            "pihakCaller3" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller3"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller3"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel3"] : "",
            "pihakExternCaller" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakExternCaller"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakExternCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModelExtern"] : "",
            "pihakCallerDelete" => base_url() . "Selectors/_processPihak/remove/$jenisTr",
            "pihakMainCallerDelete" => base_url() . "Selectors/_processPihakMain/remove/$jenisTr",
            "pihakMainCallerRulesDelete" => base_url() . "Selectors/_processPihakMainRules/remove/$jenisTr",
            //tambahan pihak rules misal ppn optional didepan
            "pihakMainCallerRules" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainCallerRules"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainCallerRules"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModelMainRules"] : "",
            "pihakMainLabelRules" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainLabelRules"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainLabelRules"] : "",
            //tambahan pihak main
            "pihakMainCaller" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainCaller"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModelMain"] : "",
            "pihakMainLabel" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainLabel"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["pihakMainLabel"] : "",
            "pihakLabel" => isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] . "(" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"] . ")" : $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "pihakLabel2" => isset($_SESSION[$cCode]['main']['pihak2Name']) ? $_SESSION[$cCode]['main']['pihak2Name'] . "(" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel2"] . ")" : (isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel2"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel2"] : ""),
            "pihakLabel3" => isset($_SESSION[$cCode]['main']['pihak3Name']) ? $_SESSION[$cCode]['main']['pihak3Name'] . "(" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel3"] . ")" : (isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel3"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel3"] : ""),
            "pihakExternLabel" => isset($_SESSION[$cCode]['main']['pihakExternLabel']) ? $_SESSION[$cCode]['main']['pihakExternName'] . "(" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakExternLabel"] . ")" : isset($this->config->item("heTransaksi_ui")[$jenisTr]["pihakExternLabel"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["pihakExternLabel"] : "",
            // history
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory + $arrayHistoryR,
            "arrayProgressLabels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progressFields : $glanceHistoryFields,
            "arrayProgress2Labels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progress2Fields : $glanceHistoryFields2,
            "arrayOnProgress" => $arrayOnprogress,
            "arrayOnProgress2" => $arrayOnprogress2,
            "reqFormTarget" => isset($reqFormTarget) ? $reqFormTarget : "",
            //            "strPaymentMethod" => $strPaymentMethod,
            "extTool" => $extTool,
            "columnRecorderTarget" => base_url() . "ValueGate/recordColumn/" . $this->jenisTr . "/",
            "defaultDescription" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            "allowJoin" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['allowJoin'] : false,
            "allowTmpSave" => $allowTmpSave,
            "needToClear" => $needToClear,
            "addPihakStr" => $addPihakStr,
            "addItemStr" => $addItemStr,
            "mobScanStr" => $mobScanStr,
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3),
            "viewMode" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'],
            "viewModeSwitch" => $viewModeSwitch,
            "barcodeSettings" => $barcodeSettings,
            "selectorProcessor" => $selectorProcessor,
            // ----------------------
            "onprogressViewTitle" => "<span class='fa fa-eye'></span> show incomplete step " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "onprogressViewSubTitle" => "<span class='text-black'>(daftar transaksi yang masih stanby di cabang tujuan)</span>",
            "arrayOnProgressView" => $arrayOnProgressView,
            "stepHistoryFields" => $stepHistoryFields,
            "uploadConfig" => $uploadConfig,
        );
        //endregion
        //arrPrint($data);
        $this->load->view("transaksi", $data);
        //        $this->session->errMsg = "";
    }


    public function clearContent()
    {
        $this->jenisTr = $this->uri->segment(3);
        $trID = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;
        //        mati_disini("== $cCode ==");


        //==================================================================================================
        //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
        if ($trID > 0) {

            $this->load->model("Mdls/MdlLockerTransaksi");
            $lt = New MdlLockerTransaksi();
            $lt->execLocker($_SESSION[$cCode]['main'], 0, $trID, NULL);

        }
        //==================================================================================================


        // pembersih session transaksi.....
        if ((isset($_SESSION[$cCode])) && (sizeof($_SESSION[$cCode]) > 0)) {
            foreach ($_SESSION[$cCode] as $key => $kk) {

                unset($_SESSION[$cCode][$key]);
            }
        }
        $_SESSION[$cCode] = null;
        unset($_SESSION[$cCode]);
        echo "<script>";
        echo "if(top.document.getElementById('shopping_cart')){";
        echo "top.getData('" . base_url() . "_shoppingCart/viewCart/" . $this->jenisTr . "?selID=0','shopping_cart');";
        echo "}";
        echo "</script>";
    }

    public function viewUndoneItems()
    {
        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $historyFields = $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $dueDateAllow = isset($this->config->item("heTransaksi_ui")[$jenisTr]['updateDueDate']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['updateDueDate'] : array();
        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }
        $glanceHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields'] : array("nomer" => "receipt no");
        $glanceHistoryFields2 = array("nomer" => "receipt no"); //init;
        $selectorProcessor = base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]['selectorProcessor'] . "/$jenisTr";

        //region lookup on-going transactions
        $arrayOnprogress = array();
        $progressFields = $historyFields;

        $progressFields['jenis_label'] = "activity";
        //        $progressFields['nomer'] = "receipt number";
        $progressFields['oleh_nama'] = "started by";
        $progressFields['state'] = "status";
        $progressFields['action'] = "action";

        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];

        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();

        if (sizeof($steps) > 1) {

            $stepCodes = array();
            $jmlStep = count($steps);
            if (isset($this->accessList[$jenisTr]) && sizeof($this->accessList) > 0) {
                $arrFilters = array();
                $indsteps = "(";
                foreach ($this->accessList[$jenisTr] as $stepNumber => $stepSpec) {
                    if ($stepNumber <= $jmlStep) {
                        foreach ($stepSpec as $targetCode => $filters) {
                            $indsteps .= "'$targetCode',";
                            $stepCodes[] = $targetCode;
                            if ($filters['allowFollowUp'] == "true") {
                                $arrFilters["allowFollowUp"][] = $targetCode;
                            }

                        }
                    }
                }
                $indsteps = rtrim($indsteps, ",");
                $indsteps .= ")";
                if (sizeof($arrFilters) > 0) {
                    $tr->addFilter("next_step_code in $indsteps");
                }
                else {
                    $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
                }
            }
            else {
                foreach ($steps as $stepNumber => $stepSpec) {
                    if ($stepNumber < $jmlStep) {
                        $stepCodes[] = $stepSpec['target'];
                    }

                }
            }

        }


        $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
        $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");
        $tr->addFilter("next_substep_code<>''");
        $tr->addFilter("sub_step_number>0");
        if (isset($this->accessList[$jenisTr]) && sizeof($this->accessList) > 0) {
        }
        else {
            if (sizeof($this->session->login['membership']) > 0) {
                $this->db->group_start();
                $mCtr = 0;
                foreach ($this->session->login['membership'] as $gID) {
                    if ($mCtr == 0) {
                        $this->db->where(array("next_subgroup_code" => $gID));

                    }
                    else {
                        $this->db->or_where(array("next_subgroup_code" => $gID));
                    }
                    $mCtr++;
                }
                $this->db->group_end();
            }
        }


        //        $tmpHist = $tr->lookupUndoneEntries_joined($this->session->login['cabang_id'], $this->session->login['gudang_id'])->result();
        $tmpHist = $tr->lookupUndoneEntries_joined(replaceSession())->result();
        //cekLime($this->db->last_query());

        //region due date
        $tr->setFilters(array());
        $listedDue = $tr->lookupAllDueDate()->result();
        $arrDue = array();
        $overDue = array();
        foreach ($listedDue as $dueData) {

            $due_date = strtotime($dueData->due_date);
            $date_now = strtotime(date("Y-m-d"));
            if ($due_date < $date_now) {
                $arrDue[$dueData->transaksi_id] = array(
                    "due_date" => $dueData->due_date,
                    "aging" => umurDay($dueData->due_date),
                );
            }

        }
        //arrPrint($arrDue);
        //arrPrint($tmpHist);
        //endregion
        $arrOver_due = array();


        if (sizeof($tmpHist) > 0) {
            $arrTransID = array();
            $arrTransTopID = array();
            $arrIdsHist = array();
            $arrTransHist = array();
            foreach ($tmpHist as $row) {
                $arrTransID[] = $row->transaksi_id;
                $arrTransTopID[] = $row->id_top;

                if ($row->ids_his != "") {
                    $hist = blobDecode($row->ids_his);
                    foreach ($hist as $hisSpec) {
                        $arrIdsHist[$row->id][$hisSpec['step']] = array(
                            "step" => $hisSpec['step'],
                            "trID" => $hisSpec['trID'],
                            "nomer" => $hisSpec['nomer'],
                        );
                        $arrTransHist[] = $hisSpec['trID'];
                    }
                }
            }
            $tmpReg_result = array();
            $trReg = new MdlTransaksi();
            $trReg->setFilters(array());
            $trReg->addFilter("param='main'");
            $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
            $tmpReg = $trReg->lookupRegistries()->result();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $regRow) {
                    $param = $regRow->param;
                    $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                }
            }
            if (sizeof($arrIdsHist) > 0) {
                $tr = new MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id in ('" . implode("','", $arrTransHist) . "')");
                $tmpTransHist = $tr->lookupAll()->result();


                if (sizeof($tmpTransHist) > 0) {
                    foreach ($tmpTransHist as $histSpec) {
                        $tmpTransHist_result[$histSpec->id] = array(
                            "oleh_id" => $histSpec->oleh_id,
                            "oleh_nama" => $histSpec->oleh_nama,
                        );
                    }
                }

                foreach ($arrIdsHist as $trID => $histSpec) {
                    foreach ($histSpec as $step => $detailSpec) {
                        if (array_key_exists($detailSpec['trID'], $tmpTransHist_result)) {
                            $detailSpec['main'] = $tmpTransHist_result[$detailSpec['trID']];
                        }
                        $arrTransMainHist[$trID][$step] = $detailSpec;
                    }
                }
            }
            $numb = 0;
            foreach ($tmpHist as $row) {
                $step_current = $row->step_current;
                if (sizeof($pairRegistries) > 0) {
                    if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->transaksi_id]))) {
                        foreach ($tmpReg_result[$row->transaksi_id] as $param => $eReg) {
                            foreach ($eReg as $k => $v) {
                                if (!isset($row->$k)) {
                                    $row->$k = $v;
                                }
                            }
                        }
                    }
                }

                $tmp = array();
                $numb++;

                foreach ($historyFields as $fName => $fLabel) {

                    if (isset($row->$fName)) {
                        if (is_numeric($row->$fName)) {
                            if (!isset($sumFooter[$fName])) {
                                $sumFooter[$fName] = 0;
                            }
                            $sumFooter[$fName] += $row->$fName;
                        }
                    }

                    if (is_array($fLabel)) {
                        $hisStep = $fLabel['step'];
                        $hisKey = $fLabel['key'];
                        //                                $tNomer = $id_hist[$hisStep][$hisKey];

                        if (isset($row->ids_his)) {
                            $returnVal = showHistoriGlobalNumbers($row->ids_his, $hisStep, true);
                            if ($returnVal == "") {
                                $tmp[$fName] = "-";
                            }
                            else {
                                $tmp[$fName] = $returnVal;
                            }
                        }
                        else {
                            $tmp[$fName] = "-";
                        }
                    }
                    else {
                        $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                    }

                    if ($fName == "no") {
                        $tmp[$fName] = formatField($fName, $numb);
                    }
                }

                if ($row->sub_step_number > 0) {
                    // $tmp['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
                    // $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail, $jenisTr);
                    $tmp['state'] = createStateHorizontal($row->sub_step_number, $row->step_avail, $jenisTr);
                }
                else {
                    $tmp['state'] = "<span style='color:#777777'>canceled</span>";
                }


                $tmp['action'] = "";
                $nextStepNum = ($row->next_substep_num);
                $currentStepNum = ($row->sub_step_number);
                $nextStepCode = ($row->next_step_code);
                $allowJoin = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;


                $allowFollowup = false;
                if ($row->sub_step_number > 0) {
                    //                    if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
                    //                        //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
                    //                        $allowFollowup = true;
                    //                        $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                    //                    }
                    $allowFollowup = true;
                    $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                }

                if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum])) {
                    if (isset($this->accessList[$jenisTr])) {
                        if (isset($this->accessList[$jenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"])) {
                            $allowFollowup = $this->accessList[$jenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"];
                            $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];
                        }


                    }
                    else {
                        if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $nextStepNum)) {
                            //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
                            $allowFollowup = true;
                            $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];

                        }
                    }

                }

                if ($allowFollowup) {
                    $stepLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['label'];
                    $isCancelPacking = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['isCancelPacking']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['isCancelPacking'] : false;
                    $allowCancel = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['allowCancel'] : false;

                    $targetFollowupLink = $isCancelPacking == true ? "followupCancelPackingPrePreview" : "followupPrePreview";
                    //                    $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/followupPrePreview/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";
                    $followupLink = "disableShopCart();top.$('#result').load('" . base_url() . "Transaksi/$targetFollowupLink/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";
                    //                        $tmp['action'] = "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"$followupLink\">" . $actionLabel . "</a>";
                    $tmp['action'] = "<div class='input-group'>";
                    $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' data-toggle='tooltip' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\"><span class='glyphicon glyphicon-ok'></span> " . $actionLabel . "</a>";
                    if ($allowJoin) {
                        $tmp['action'] .= "<span class='input-group-addon'>";
                        $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                        $tmp['action'] .= "</span class='input-group-addon'>";
                    }
                }
                //                $arrayOnprogress[] = $tmp;
                //                if (isset($arrDue[$row->transaksi_id]) && $arrDue[$row->transaksi_id]['aging'] > 0) {
                //                    cekhere($row->transaksi_id);
                //                    $arrOver_due[] = $tmp;
                //                } else {
                $arrayOnprogress[] = $tmp;
                //                }
            }
        }


        //endregion

        //region lookup on-going from connected requests

        if (!isset($_SESSION['undoneQty'])) {
            $_SESSION['undoneQty'] = array();
        }
        if (!isset($_SESSION['undoneQty'][$this->jenisTr])) {
            $_SESSION['undoneQty'][$this->jenisTr] = 0;
        }
        $progress2Fields = array();
        $arrayOnprogress2 = array();
        $reqFormTarget = "";
        $needToClear = false;
        $allowMultiSelect = false;
        if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['requestCode'])) {
            $masterRefCode = $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['masterCode'];
            $stateRefCode = $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['stateCode'];
            $stateRefNum = $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['stepNumber'];
            $progress2Fields = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['shortHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['shortHistoryFields'] : "";
            //            $glanceHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields'] + array("select" => "select") : array("nomer" => "receipt no");
            $glanceHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields'] : array("nomer" => "receipt no");
            $reqFormTarget = base_url() . get_class($this) . "/swapFrom/$jenisTr";


            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
            $tr->addFilter("transaksi.jenis_master='" . $masterRefCode . "'");
            $tr->addFilter("transaksi.jenis='" . $stateRefCode . "'");
            //            $tr->addFilter("transaksi.step_number='" . $stateRefNum . "'");
            $tr->addFilter("transaksi.step_current='" . $stateRefNum . "'");
            $tmpByReq = $tr->lookupRecentHistories()->result();

            $needToClear = false;
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $needToClear = true;
            }
            $_SESSION['undoneQty'][$this->jenisTr] = sizeof($tmpByReq);

            if (sizeof($tmpByReq) > 0) {

                $allowMultiSelect = isset($this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['allowMultiSelect']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['allowMultiSelect'] : false;

                $reqCtr = 0;
                foreach ($tmpByReq as $row) {
                    $reqCtr++;
                    $tmp = array();
                    $inputType = $allowMultiSelect == true ? "checkbox" : "radio";
                    //                    $clickEvent = "onclick=\"return false;\"";
                    $clickEvent = "";
                    if ($inputType == "radio" && !$needToClear) {
                        //                        $clickEvent="onclick=\"document.getElementById('btnConnect').innerHTML='Clear the list to process one of entries above';document.getElementById('btnConnect').disabled=true;document.getElementById('fAsNew').submit()\"";
                        $clickEvent = "onclick=\"document.getElementById('fAsNew').submit()\"";
                    }
                    $tmp['select'] = "<input type=$inputType name='trID[]' value='" . $row->id . "' id='select_" . $reqCtr . "' $clickEvent>";
                    foreach ($historyFields as $fName => $fLabel) {
                        //                        $tmp[$fName] = formatField($fName, $row->$fName);
                        $tmp[$fName] = isset($row->$fName) ? $row->$fName : "";
                    }


                    $arrayOnprogress2[] = $tmp;
                }
            }
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $needToClear = true;
            }

        }


        //endregion


        $sumFooterResult = array();
        if (isset($sumFooter) && sizeof($sumFooter) > 0) {
            foreach ($sumFooter as $key => $val) {

                $sumFooterResult[$key] = formatField($key, $val);
            }
        }

        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,

            //            "arrayProgressLabels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progressFields : $glanceHistoryFields,
            //            "arrayProgress2Labels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progress2Fields : $glanceHistoryFields2,
            "arrayProgressLabels" => $progressFields,
            "arrayProgress2Labels" => $glanceHistoryFields2,
            "arrayOnProgress" => $arrayOnprogress,
            "arrayOnProgress2" => $arrayOnprogress2,
            "needToClear" => $needToClear,
            "reqFormTarget" => $reqFormTarget,
            "allowMultiSelect" => $allowMultiSelect,
            "overDue" => $arrOver_due,
            "clearCartTarget" => base_url() . "_shoppingCart/reset/" . $this->jenisTr,

            "sumFooter" => $sumFooterResult,
        );

        $this->load->view("transaksi", $data);

    }

    public function viewRequestItems()
    {


        $origJenisTr = $this->uri->segment(3);
        $jenisTr = isset($this->config->item("heTransaksi_ui")[$origJenisTr]['aliasMainTrans']) ? $this->config->item("heTransaksi_ui")[$origJenisTr]['aliasMainTrans'] : $origJenisTr;

        $this->jenisTr = $jenisTr;

        $cCode = "_TR_" . $this->jenisTr;

        $cCodeOrig = "_TR_" . $origJenisTr;

        //        cekHere($origJenisTr);
        //        cekHere($jenisTr);

        $historyFields = $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $tabHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['tabHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['tabHistoryFields'] : array();
        $tabFieldsItems = isset($this->config->item("heTransaksi_ui")[$jenisTr]['tabFieldsItems']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['tabFieldsItems'] : array();
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $dueDateAllow = isset($this->config->item("heTransaksi_ui")[$jenisTr]['updateDueDate']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['updateDueDate'] : array();

        //        arrPrint($tabHistoryFields);

        $mb = New MobileDetect();
        $isMob = $mb->isMobile();

        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }
        $glanceHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields'] : array("nomer" => "receipt no");
        $glanceHistoryFields2 = array("nomer" => "receipt no"); //init;

        //region lookup on-going transactions
        $arrayOnprogress = array();
        $arrOver_due = array();
        $progressFields = $historyFields;


        //region lookup on-going from connected requests
        if (!isset($_SESSION['undoneQty'])) {
            $_SESSION['undoneQty'] = array();
        }
        if (!isset($_SESSION['undoneQty'][$this->jenisTr])) {
            $_SESSION['undoneQty'][$this->jenisTr] = 0;
        }

        $progress2Fields = array();
        $arrayOnprogress2 = array();
        $tmpTabData = array();
        $reqFormTarget = "";
        $allowMultiSelect = false;
        $needToClear = false;
        $allowMultiSelect = isset($this->config->item("heTransaksi_ui")[$origJenisTr]['tabRequestCode']['allowMultiSelect']) ? $this->config->item("heTransaksi_ui")[$origJenisTr]['tabRequestCode']['allowMultiSelect'] : false;


        if (isset($this->config->item("heTransaksi_ui")[$this->uri->segment(3)]['tabRequestCode'])) {
            //cekBiru("masuk sini");
            $masterRefCode = $this->config->item("heTransaksi_ui")[$this->uri->segment(3)]['tabRequestCode']['masterCode'];
            $stateRefCode = $this->config->item("heTransaksi_ui")[$this->uri->segment(3)]['tabRequestCode']['stateCode'];
            $stateRefNum = $this->config->item("heTransaksi_ui")[$this->uri->segment(3)]['tabRequestCode']['stepNumber'];

            $progress2Fields = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['shortHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['shortHistoryFields'] : "";
            $glanceHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields'] : array("nomer" => "receipt no");

            $reqFormTarget = base_url() . get_class($this) . "/swapFrom/" . $this->uri->segment(3);

            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
            $tr->addFilter("transaksi.jenis_master='" . $masterRefCode . "'");
            $tr->addFilter("transaksi.jenis='" . $stateRefCode . "'");
            $tr->addFilter("transaksi.step_current='" . $stateRefNum . "'");
            $tmpByReq = $tr->lookupRecentHistories()->result();
            cekHijau(__LINE__ . " -/- " . $this->db->last_query());
            //            arrPrint( $tmpByReq );
            $needToClear = false;
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $needToClear = true;
            }

            $_SESSION['undoneQty'][$this->jenisTr] = sizeof($tmpByReq);

            //arrPrint($tmpByReq);
            if (sizeof($tmpByReq) > 0) {

                $arrIds = array();
                foreach ($tmpByReq as $row) {
                    $arrIds[] = $row->id;
                }
                //arrPrint($arrIds);
                $tr->setFilters(array());
                $tr->addFilter("transaksi_data.transaksi_id IN ('" . implode("','", $arrIds) . "')");
                $tr->addFilter("transaksi_data.next_substep_code='" . $masterRefCode . "'");
                $tr->addFilter("transaksi.link_id=0");
                $tr->addFilter("transaksi_data.produk_jenis='supplies'");
                $tr->addFilter("transaksi_data.valid_qty>0");
                $trTr = $tr->lookupJoined()->result();
                cekMerah(__LINE__ . " -/- " . $this->db->last_query());
                //arrPrint($trTr);
                $arrayTabHistory = array();
                if (sizeof($trTr) > 0) {

                    $tmpItems = array();
                    $sumValidQty = array();
                    $sumPrdOrdJml = array();
                    $listTrxByProd = array();
                    $reqCtr = 0;

                    foreach ($trTr as $ky => $rows) {

                        $reqCtr++;
                        $totalSumPrdOrdJmlTR = 0;
                        if (!isset($sumValidQtyID[$rows->produk_id])) {
                            $sumValidQtyID[$rows->produk_id] = 0;
                        }
                        if (!isset($sumPrdOrdJmlID[$rows->produk_id])) {
                            $sumPrdOrdJmlID[$rows->produk_id] = 0;
                        }
                        if (!isset($sumValidQtyTR[$rows->transaksi_id][$rows->produk_id])) {
                            $sumValidQtyTR[$rows->transaksi_id][$rows->produk_id] = 0;
                        }
                        if (!isset($sumPrdOrdJmlTR[$rows->transaksi_id][$rows->produk_id])) {
                            $sumPrdOrdJmlTR[$rows->transaksi_id][$rows->produk_id] = 0;
                        }
                        $sumValidQtyID[$rows->produk_id] += $rows->valid_qty;
                        $sumValidQtyTR[$rows->transaksi_id][$rows->produk_id] += $rows->valid_qty;
                        $listTrxByProd[$rows->produk_id][] = $rows->nomer_top;
                        $sumPrdOrdJmlID[$rows->produk_id] += $rows->valid_qty;
                        $sumPrdOrdJmlTR[$rows->transaksi_id][$rows->produk_id] += $rows->valid_qty;
                        $arrProduk[$rows->transaksi_id][$rows->produk_id] = "<div>" . $rows->produk_nama . "</div>";
                        $needToClear = false;
                        if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                            $needToClear = true;
                        }
                        //arrPrint($tabHistoryFields);

                        foreach ($tabHistoryFields as $key => $row) {


                            //cekHere($key);
                            switch ($key) {
                                case "vendor_id":
                                    break;
                                case "transaksi_id":
                                    $totalSumPrdOrdJmlTR = 0;
                                    $inputType = $allowMultiSelect == true ? "checkbox" : "radio";
                                    foreach ($sumPrdOrdJmlTR[$rows->transaksi_id] as $pid => $val) {
                                        $totalSumPrdOrdJmlTR += $val;
                                    };
                                    $produk_btn = "<span href='" . base_url() . "Addons/ViewDetails/index/" . $rows->transaksi_id . "' name='qtips' class='btn btn-sm'> berisi " . sizeof($sumPrdOrdJmlTR[$rows->transaksi_id]) . " item, Total " . $totalSumPrdOrdJmlTR . " unit  </span>";
                                    $clickEvent = "";
                                    if ($inputType == "radio" && !$needToClear) {
                                        $clickEvent = "onclick=\"document.getElementById('$key').submit()\"";
                                    }

                                    //arrPrint($rows);
                                    //                                cekLime($inputType);
                                    $transaksi_id = array(
                                        "select" => "<input type=$inputType name='trID[]' value='" . $rows->transaksi_id . "' id='select_" . $key . "_" . $reqCtr . "' $clickEvent>",
                                        "nomer" => formatField('nomer', $rows->nomer),
                                        "nomer_top" => formatField('nomer_top', $rows->nomer_top),
                                        "produk_id" => $rows->transaksi_id,
                                        "dtime" => formatField('dtime', $rows->dtime) . "<br><span class='meta'>" . timeSince(strtotime($rows->dtime)) . "</span>",
                                        "oleh_nama" => $rows->oleh_nama,
                                        "cabang2_nama" => $rows->cabang2_nama,
                                        "purchased" => 0,
                                        "arrProduk" => $produk_btn,
                                        "produk_nama" => $rows->produk_nama,
                                        "valid_qty" => $sumValidQtyTR[$rows->transaksi_id][$rows->produk_id],
                                        "produk_ord_jml" => $sumPrdOrdJmlTR[$rows->transaksi_id][$rows->produk_id],
                                    );
                                    $nextStepNum = $rows->next_step_num;
                                    $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/followupPrePreview/" . $rows->transaksi_id . "/$nextStepNum/" . $rows->sub_step_number . "');";

                                    $actionLabel = "reject";
                                    $tmp = "<div class='input-group'>";
                                    $tmp .= "<a class='btn btn-danger btn-block' title='' href='javascript:void(0)' 
                                        onClick =\"$followupLink\">" . $actionLabel . "</a>";
                                    //                                    if ($allowJoin) {
                                    //                                        $tmp['action'] .= "<span class='input-group-addon'>";
                                    //                                        $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                                    //                                        $tmp['action'] .= "</span class='input-group-addon'>";
                                    //                                    }
                                    $tmp .= "</div class='input-group'>";
                                    $transaksi_id['action'] = $tmp;
                                    //                                    arrPrint($transaksi_id);
                                    $tmpTabData[$key][$rows->transaksi_id] = $transaksi_id;
                                    break;
                                case "produk_id":

                                    //                                    cekHere($key);

                                    $inputType = $allowMultiSelect == true ? "checkbox" : "radio";
                                    $arrTrxId = $listTrxByProd[$rows->produk_id];
                                    $listingTrx = array();
                                    foreach ($arrTrxId as $pid => $nomer) {
                                        $listingTrx[] = formatField('nomer_top', $nomer);
                                    }
                                    $clickEvent = "";
                                    if ($inputType == "radio" && !$needToClear) {
                                        $clickEvent = "onclick=\"document.getElementById('$key').submit()\"";
                                    }

                                    $produk_id = array(
                                        "select" => "<input type=$inputType name='prdID[]' value='" . $rows->produk_id . "' id='select_" . $key . "_" . $reqCtr . "' $clickEvent>",
                                        "produk_id" => $rows->produk_id,
                                        "dtime" => formatField('dtime', $rows->dtime) . "<br><span class='meta'>" . timeSince(strtotime($rows->dtime)) . "</span>",
                                        "produk_nama" => $rows->produk_nama,
                                        "nomer_top" => implode("<br>", $listingTrx),
                                        //                                        "valid_qty"      => $sumValidQtyID[$rows->produk_id],
                                        "produk_ord_jml" => $sumPrdOrdJmlID[$rows->produk_id],
                                        //                                        "purchased"      => 0,
                                    );

                                    $tmpTabData[$key][$rows->produk_id] = $produk_id;
                                    break;
                            }

                            //                            cekHere($key);
                            //                            matiHere();
                        }
                        //                        matiHere();
                    }

                    //                    matiHere();

                    $arrayOnprogress2 = $tmpTabData;
                }
            }
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $needToClear = true;
            }
        }
        //endregion

        //cekBiru($this->uri->segment(2));
        //        arrprint($tabFieldsItems);
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "arrayProgressLabels" => $progressFields,
            "arrayProgress2Labels" => $glanceHistoryFields2,
            "arrayOnProgress" => $arrayOnprogress,
            "arrayOnProgress2" => $arrayOnprogress2,
            "needToClear" => $needToClear,
            "reqFormTarget" => $reqFormTarget,
            "allowMultiSelect" => $allowMultiSelect,
            "overDue" => $arrOver_due,
            "tabFieldsItems" => $tabFieldsItems,
            "tabHistoryFields" => $tabHistoryFields,
            "clearCartTarget" => base_url() . "_shoppingCart/reset/" . $this->jenisTr,
            "scriptBottom" => "",
        );
        //        arrPrint($data);
        //        matiHere(__LINE__ . " - " . $cCodeOrig);
        $this->load->view("transaksi", $data);

    }

    public function viewCompactUndoneItems()
    {


        //region lookup on-going transactions


        $arrayOnprogress = array();
        //        $progressFields = $historyFields;
        $progressFields['state'] = "status";
        $progressFields['action'] = "action";
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        if (sizeof($steps) > 1) {
            $stepCodes = array();
            $jmlStep = count($steps);
            foreach ($steps as $stepNumber => $stepSpec) {
                if ($stepNumber < $jmlStep) {
                    $stepCodes[] = $stepSpec['target'];
                }

            }
        }

        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
        $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");
        $tr->addFilter("next_substep_code<>''");
        $tr->addFilter("sub_step_number>0");
        if (sizeof($this->session->login['membership']) > 0) {
            $this->db->group_start();
            $mCtr = 0;
            foreach ($this->session->login['membership'] as $gID) {
                if ($mCtr == 0) {
                    $this->db->where(array("next_subgroup_code" => $gID));

                }
                else {
                    $this->db->or_where(array("next_subgroup_code" => $gID));
                }
                $mCtr++;

            }
            $this->db->group_end();
        }

        $tmpHist = $tr->lookupUndoneEntries_joined($this->session->login['cabang_id'], $this->session->login['gudang_id'])->result();

        if (sizeof($tmpHist) > 0) {
            foreach ($tmpHist as $row) {
                $tmp = array();
                foreach ($historyFields as $fName => $fLabel) {
                    //$tmp[$fName] = $row->$fName;
                    $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : "";
                }
                if ($row->sub_step_number > 0) {
                    $tmp['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
                    $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail, $jenisTr);
                }
                else {
                    $tmp['state'] = "<span style='color:#777777'>canceled</span>";
                }

                $tmp['action'] = "";
                $nextStepNum = ($row->next_substep_num);
                $currentStepNum = ($row->sub_step_number);
                $allowJoin = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;


                $allowFollowup = false;
                if ($row->sub_step_number > 0) {
                    if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
                        //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
                        $allowFollowup = true;
                        $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                    }
                }

                if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum])) {
                    if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $nextStepNum)) {
                        //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
                        $allowFollowup = true;
                        $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];

                    }
                }

                if ($allowFollowup) {
                    $stepLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['label'];

                    $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/followupPrePreview/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";
                    //                        $tmp['action'] = "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"$followupLink\">" . $actionLabel . "</a>";
                    $tmp['action'] = "<div class='input-group'>";
                    $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' data-toggle='tooltip' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\"><span class='glyphicon glyphicon-ok'></span> " . $actionLabel . "</a>";
                    if ($allowJoin) {
                        $tmp['action'] .= "<span class='input-group-addon'>";
                        $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
                        $tmp['action'] .= "</span class='input-group-addon'>";
                    }
                }
                $arrayOnprogress[] = $tmp;
            }
        }

        //endregion

        //region lookup on-going from connected requests

        if (!isset($_SESSION['undoneQty'])) {
            $_SESSION['undoneQty'] = array();
        }
        if (!isset($_SESSION['undoneQty'][$this->jenisTr])) {
            $_SESSION['undoneQty'][$this->jenisTr] = 0;
        }
        $progress2Fields = array();
        $arrayOnprogress2 = array();
        $reqFormTarget = "";
        $needToClear = false;
        $allowMultiSelect = false;
        if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['requestCode'])) {
            $masterRefCode = $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['masterCode'];
            $stateRefCode = $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['stateCode'];
            $stateRefNum = $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['stepNumber'];
            $progress2Fields = $this->config->item("heTransaksi_ui")[$masterRefCode]['shortHistoryFields'];
            //            $glanceHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields'] + array("select" => "select") : array("nomer" => "receipt no");
            $glanceHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$masterRefCode]['glanceHistoryFields'] : array("nomer" => "receipt no");
            $reqFormTarget = base_url() . get_class($this) . "/swapFrom/$jenisTr";


            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
            $tr->addFilter("transaksi.jenis_master='" . $masterRefCode . "'");
            $tr->addFilter("transaksi.jenis='" . $stateRefCode . "'");
            //            $tr->addFilter("transaksi.step_number='" . $stateRefNum . "'");
            $tr->addFilter("transaksi.step_current='" . $stateRefNum . "'");
            $tmpByReq = $tr->lookupRecentHistories()->result();

            //            cekkuning($this->db->last_query());

            $needToClear = false;
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $needToClear = true;
            }
            $_SESSION['undoneQty'][$this->jenisTr] = sizeof($tmpByReq);

            if (sizeof($tmpByReq) > 0) {

                $allowMultiSelect = isset($this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['allowMultiSelect']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['allowMultiSelect'] : false;

                $reqCtr = 0;
                foreach ($tmpByReq as $row) {
                    $reqCtr++;
                    $tmp = array();
                    $inputType = $allowMultiSelect == true ? "checkbox" : "radio";
                    //                    $clickEvent = "onclick=\"return false;\"";
                    $clickEvent = "";
                    if ($inputType == "radio" && !$needToClear) {
                        //                        $clickEvent="onclick=\"document.getElementById('btnConnect').innerHTML='Clear the list to process one of entries above';document.getElementById('btnConnect').disabled=true;document.getElementById('fAsNew').submit()\"";
                        $clickEvent = "onclick=\"document.getElementById('fAsNew').submit()\"";
                    }
                    $tmp['select'] = "<input type=$inputType name='trID[]' value='" . $row->id . "' id='select_" . $reqCtr . "' $clickEvent>";
                    foreach ($historyFields as $fName => $fLabel) {
                        //                        $tmp[$fName] = formatField($fName, $row->$fName);
                        $tmp[$fName] = isset($row->$fName) ? $row->$fName : "";
                    }


                    $arrayOnprogress2[] = $tmp;
                }
            }
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $needToClear = true;
            }

        }


        //endregion


        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,

            //            "arrayProgressLabels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progressFields : $glanceHistoryFields,
            //            "arrayProgress2Labels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progress2Fields : $glanceHistoryFields2,
            "arrayProgressLabels" => $progressFields,
            "arrayProgress2Labels" => $glanceHistoryFields2,
            "arrayOnProgress" => $arrayOnprogress,
            "arrayOnProgress2" => $arrayOnprogress2,
            "needToClear" => $needToClear,
            "reqFormTarget" => $reqFormTarget,
            "allowMultiSelect" => $allowMultiSelect,
            "clearCartTarget" => base_url() . "_shoppingCart/reset/" . $this->jenisTr,

        );

        $this->load->view("transaksi", $data);

    }

    public function viewIncomplete()
    {


        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $historyFields = $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }

        //
        //region lookup on-going transactions
        $currentState = 99;
        $progressFields = $historyFields;
        $progressFields['items'] = "detail items";
        $progressFields['state'] = "status";
        $progressFields['action'] = "action";
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $stepLabels = array(
            "99" => "all",
            //            "0" => "canceled",
        );
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-01");
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $searchStr = isset($_GET['search']) ? $_GET['search'] : "";
        $stepLinks = array(
            "99" => base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/99?date1=$date1&date2=$date2",
            //            "0"  => base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/0?date1=$date1&date2=$date2",
            "0" => base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/0",
        );


        $arrayOnprogress = array();
        $arrayOnprogressbyState = array();


        if (sizeof($steps) > 1) {
            $stepCodes = array();
            //arrPrint($this->accessList);
            $jmlStep = count($steps);
            $indsteps = "(";
            $arrFilters = array();
            if (isset($this->accessList[$jenisTr]) && sizeof($this->accessList[$jenisTr]) > 0) {
                foreach ($this->accessList[$jenisTr] as $stepNumber => $stepSpec) {
                    if ($stepNumber <= $jmlStep) {
                        foreach ($stepSpec as $targetCode => $filters) {
                            $indsteps .= "'$targetCode',";
                            $stepCodes[] = $targetCode;
                            if ($filters['allowFollowUp'] == "true") {
                                $arrFilters["allowFollowUp"][] = $targetCode;
                            }

                        }
                    }
                }
            }

            $indsteps = rtrim($indsteps, ",");
            $indsteps .= ")";
            $stepLabels ["0"] = "canceled";

            if ($steps[1]['userGroup'] == $this->session->login['jenis']) {
                $stepLabels[-1] = "<span class='glyphicon glyphicon-plus'></span>";
                $stepLinks[-1] = base_url() . $this->uri->segment(1) . "/createForm/" . $this->uri->segment(3) . "?date1=$date1&date2=$date2";
            }


            //            $currentState = $this->uri->segment(4) > 0 ? $this->uri->segment(4) : 0;
            if (strlen($this->uri->segment(4)) > 0) {
                $currentState = $this->uri->segment(4);
            }


            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
            //            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
            //            $tr->addFilter("gudang_id='" . $this->session->login['gudang_id'] . "'");
            //            $tr->addFilter("jenis='" . $steps[1]['target'] . "'");
            $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
            $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");

            //region date filter
            //            $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-01");
            //            $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
            if (isset($_GET['date1'])) {
                $this->db->where("fulldate>='" . $_GET['date1'] . "'");
                $this->db->where("fulldate<='" . $_GET['date2'] . "'");
            }
            if (isset($_GET['search'])) {
                $tr->setKeyWord($searchStr);
            }

            //endregion

            //cekBiru($currentState);
            $tr->addFilter("next_substep_code<>''");
            if ($currentState < 99) {
                $tr->addFilter("sub_step_number='$currentState'");
                $tr->addFilter("valid_qty>0");
            }
            else {
                $tr->addFilter("sub_step_number>0");
                $tr->addFilter("valid_qty>0");
            }
            if (sizeof($arrFilters) > 0) {
                //                $tr->addFilter("next_step_code in $indsteps");
            }
            else {
                //                $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
            }

            //            $tmpHist = $tr->lookupUndoneEntries_joined($this->session->login['cabang_id'], $this->session->login['gudang_id'])->result();

            $tmpHist = $tr->lookupUndoneEntries_joined(replaceSession())->result();
            //            cekHere($this->db->last_query());
            //            arrPrintWebs($tmpHist);

            $selectedTopID = isset($_GET['topID']) ? $_GET['topID'] : 0;


            $rowCtr = 0;
            if (sizeof($tmpHist) > 0) {
                $arrTransID = array();
                $arrTransTopID = array();
                $arrIdsHist = array();
                $arrTransHist = array();
                $arrProduk = array();
                foreach ($tmpHist as $row) {
                    $arrTransID[] = $row->transaksi_id;
                    $arrTransTopID[] = $row->id_top;
                    if ($row->ids_his != "") {
                        $hist = blobDecode($row->ids_his);
                        foreach ($hist as $hisSpec) {
                            $arrIdsHist[$row->id][$hisSpec['step']] = array(
                                "step" => $hisSpec['step'],
                                "trID" => $hisSpec['trID'],
                                "nomer" => $hisSpec['nomer'],
                            );
                            $arrTransHist[] = $hisSpec['trID'];
                        }
                    }

                    $arrProduk[$row->transaksi_id] = array(
                        "id" => $row->produk_id,
                        "nama" => $row->produk_nama,
                        "label" => $row->produk_label,
                        "kode" => $row->produk_kode,
                        "valid_qty" => $row->valid_qty,
                        "master_id" => $row->id_master,
                    );
                }
                $tmpReg_result = array();
                $trReg = new MdlTransaksi();
                $trReg->setFilters(array());
                $trReg->addFilter("param='main'");
                $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                $tmpReg = $trReg->lookupRegistries()->result();
                if (sizeof($tmpReg) > 0) {
                    foreach ($tmpReg as $regRow) {
                        $param = $regRow->param;
                        $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                    }
                }


                // menambah pairingan dengan transaksi_data
                //                $trData = new MdlTransaksi();
                //                $trData->setFilters(array());
                //                $trData->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                //                $trData->addFilter("valid_qty>'0'");
                //                $tmpData = $trData->lookupAll()->result();
                //                if(sizeof($tmpData)>0){
                //                    foreach($tmpData as $dataSpec){
                //                        arrPrintWebs($dataSpec);
                //                    }
                //                }
                //arrPrintWebs($arrProduk);


                foreach ($tmpHist as $row) {
                    if (sizeof($pairRegistries) > 0) {
                        if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->transaksi_id]))) {
                            foreach ($tmpReg_result[$row->transaksi_id] as $param => $eReg) {
                                foreach ($eReg as $k => $v) {
                                    if (!isset($row->$k)) {
                                        $row->$k = $v;
                                    }
                                }
                            }
                        }
                    }

                    $rowCtr++;
                    $tmp = array();
                    foreach ($historyFields as $fName => $fLabel) {

                        $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);

                        if ($fName == "no") {
                            $tmp[$fName] = formatField($fName, $rowCtr);
                        }
                    }
                    // menambah manual detail/items barang
                    if (isset($arrProduk[$row->transaksi_id])) {
                        $tmp['items'] = $arrProduk[$row->transaksi_id]["valid_qty"] . "x ";
                        $tmp['items'] .= $arrProduk[$row->transaksi_id]["label"] . " ";
                        $tmp['items'] .= $arrProduk[$row->transaksi_id]["kode"];

                        $linkOutstanding = base_url() . "Transaksi/viewOutstanding/$jenisTr/transaksi/$jenisTr?trID=" . $arrProduk[$row->transaksi_id]["master_id"];
                        $tmp['items'] .= "<br><br> <a class='btn btn-primary btn-block' title='lihat selengkapnya' target='_blank'
                            href='$linkOutstanding'>
                            <span class=''>click to view complete...</span></a>";
                    }
                    else {
                        $tmp['items'] = "-";
                    }


                    if ($row->sub_step_number > 0) {
                        $tmp['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
                        $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail, $jenisTr);
                    }
                    else {
                        $tmp['state'] = "<span style='color:#777777'>canceled</span>";
                    }

                    $tmp['action'] = "";
                    $nextStepNum = ($row->next_substep_num);
                    $currentStepNum = ($row->sub_step_number);
                    $nextStepCode = $row->next_step_code;
                    $allowJoin = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;
                    $allowFollowup = false;
                    if ($row->sub_step_number > 0) {

                        if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
                            //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
                            $allowFollowup = true;
                            $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];

                        }
                    }

                    if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum])) {
                        //                        cekHitam("masooox $nextStepNum ".$row->sub_step_number);
                        if (isset($this->accessList[$jenisTr])) {
                            if (isset($this->accessList[$jenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"])) {
                                $allowFollowup = $this->accessList[$jenisTr][$nextStepNum][$nextStepCode]["allowFollowUp"];
                                $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];
                            }


                        }
                        else {
                            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $nextStepNum)) {
                                //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
                                $allowFollowup = true;
                                $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];

                            }
                        }

                    }

                    if ($allowFollowup) {
                        $stepLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['label'];

                        $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/followupPrePreview/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";
                        $tmp['action'] = "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"top.open_holdon();$followupLink\">" . $actionLabel . "</a>";
                    }


                    if ($currentState > 0) {
                        if (isset($tmp['jenis_label'])) {
                            $clickEvent = "";
                            if ($row->id_top == $selectedTopID) {
                                $checked = "checked";
                            }
                            else {
                                $clickEvent = "location.href='" . base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "?topID=" . $row->id_top . "';";
                                $checked = "";
                            }

                            $tmp['jenis_label'] = "<label><input type='checkbox' name='oID[]' $checked onclick=\"$clickEvent\" value='" . $row->transaksi_id . "'>" . $tmp['jenis_label'] . "</label>";
                            //                                echo "topID:".$row->id_top."<br>";
                        }
                    }

                    $arrayOnprogress[] = $tmp;
                    $arrayOnprogressbyState[$row->sub_step_number][] = $tmp;


                }
            }
        }
        else {
            $arrayOnprogress = array();
        }

        //arrPrint($arrayOnprogress);

        //endregion

        //region link to add new transaction
        if (placeCanMakeTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr)) {
            //        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['userGroup'], $this->session->login['membership'])) {
            $createIndexes = (null != $this->config->item("transaksi_createIndex")) ? $this->config->item("transaksi_createIndex") : array();
            if (array_key_exists($this->jenisTr, $createIndexes)) {
                $targetUrl = base_url() . $createIndexes[$this->jenisTr] . "/" . $this->jenisTr;
            }
            else {
                $targetUrl = base_url() . "Transaksi/createForm/" . $this->jenisTr;
            }
            $addLink = array(
                "link" => $targetUrl,
                "label" => "<span class='glyphicon glyphicon-plus'></span> create new " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            );
        }
        else {
            $addLink = null;
        }
        //endregion
        //arrPrint($addLink);
        //
        //region prepare params for viewer
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "errMsg" => $this->session->errMsg,
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            //            "subTitle"          => $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " with status '" . $stepLabels[$currentState] . "'",
            "subTitle" => $stepLabels[$currentState] . "'",
            "jenisTr" => $jenisTr,
            "jenisTransaksi" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            //            "selectorCaller" => base_url() . "_selectorItem/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],
            "selectorCaller" => base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],
            "selectorLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel"],
            //            "pihakCaller" => base_url() . "_selectorPihak/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel"],
            "pihakCaller" => base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel"],
            "pihakCallerDelete" => base_url() . "_processPihak/remove/$jenisTr",
            // "pihakLabel"=>$this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "pihakLabel" => isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],

            "arrayProgressLabels" => $progressFields,
            "arrayOnProgress" => $arrayOnprogress,
            "arrayOnProgressByState" => $arrayOnprogressbyState,
            "stepLabels" => $stepLabels,
            "stepLinks" => $stepLinks,
            "currentState" => $currentState,
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewHistory/" . $this->uri->segment(3),
            "alternateLinkCaption" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " histories " . "<span class='glyphicon glyphicon-arrow-right'></span>",
            //==untuk keperluan followup many-to-one
            "allowJoin" => isset($allowJoin) ? $allowJoin : false,
            "actionLabel" => isset($actionLabel) ? $actionLabel : "",
            "_nextStepNum" => isset($nextStepNum) ? $nextStepNum : "",
            "_currentStepNum" => $currentState,
            "followupBase" => base_url() . "Transaksi/followupPrePreview/",
            "addLink" => $addLink,
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),
        );
        //        $data= array();
        //endregion


        $this->load->view("history", $data);
    }

    public function viewIncompleteStepAntarCabang()
    {

        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'] : array();
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $connectTo = isset($this->config->item("heTransaksi_ui")[$jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['connectTo'] : "";
        $stepHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStepHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortStepHistoryFields'] : array();
        $arrExtHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"] : array();


        $tmpMasterIDExt = array();
        $arrJenisStepRslt = array();
        $arrayOnProgressView = array();
        if (sizeof($stepHistoryFields) > 0) {
            if (strlen($connectTo) > 0) {
                $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
                $transaksiConfig = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'] : array();
                $transaksiConnectConfig = isset($this->config->item("heTransaksi_ui")[$connectTo]['steps']) ? $this->config->item("heTransaksi_ui")[$connectTo]['steps'] : array();
                $transaksiStepConfig = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1] : array();
                $jenisTrTop = isset($transaksiStepConfig['target']) ? $transaksiStepConfig['target'] : "";


                $transaksiExtendConnect = isset($this->config->item("heTransaksi_ui")[$jenisTr]['extConnectTo']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['extConnectTo'] : array();
                $transaksiExtendConnectMain = isset($this->config->item("heTransaksi_ui")[$jenisTr]['extConnectToMain']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['extConnectToMain'] : array();
                $transaksiExtendConnectPair = isset($this->config->item("heTransaksi_ui")[$jenisTr]['extConnectToPair']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['extConnectToPair'] : array();


                if (sizeof($transaksiExtendConnect) > 0) {
                    foreach ($transaksiExtendConnect as $key_jenis) {
                        $arrJenisStep = array(
                            "next_step_num" => 1,
                            "next_step_code" => $key_jenis,
                        );

                        $arrJenisStepRslt[$key_jenis] = callNextPICDetail($arrJenisStep);

                    }
                }


                $tr2 = new MdlTransaksi();
                $tr2->setFilters(array());

                if (isset($connectTo)) {
                    $tr2->addFilter("jenis_master='$connectTo'");
                    $tr2->addFilter("link_id='0'");
                    $tr2->addFilter("next_step_code>'0'");
                    $tr2->addFilter("sub_step_number>'0'");
                    $tr2->addFilter("gudang_id<>'0'");
                    if ($this->session->login['cabang_id'] == CB_ID_PUSAT) {
                    }
                    else {
                        $tr2->addFilter("transaksi.cabang2_id='" . $this->session->login['cabang_id'] . "'");
                    }
                    $tmpSrc2 = $tr2->lookupJoined()->result();
                    //                    cekHere($this->db->last_query() . " --- " . count($tmpSrc2));

                    $tmp2 = array();
                    $tmpMasterIDResult = array();
                    $tmpMasterID = array();
                    $tmpResult = array();
                    $arrNextAction = array();
                    if (sizeof($tmpSrc2) > 0) {

                        foreach ($tmpSrc2 as $src2sSpec) {
                            $tmpMasterID[$src2sSpec->id_master] = $src2sSpec->id_master;
                            $arrNextAction[$src2sSpec->transaksi_id] = array(
                                "next_step_num" => $src2sSpec->next_substep_num,
                                "next_step_code" => $src2sSpec->next_substep_code,
                            );

                            $arrTransID[] = $src2sSpec->transaksi_id;
                        }
                        //arrPrint($tmpMasterID);
                        //arrPrint($transaksiExtendConnectMain);
                        //arrPrint($transaksiExtendConnect);

                        //--------------------------------
                        if (sizeof($transaksiExtendConnect) > 0) {
                            $tr12 = new MdlTransaksi();
                            $tr12->setFilters(array());
                            $tr12->addFilter("link_id=0");
                            $this->db->where_in("jenis", $transaksiExtendConnectMain);
                            $tr12->addFilter("id_master in ('" . implode("','", $tmpMasterID) . "')");
                            $tr12->addFilter("valid_qty>'0'");
                            //                            $trTmpExt = $tr12->lookupAll()->result();
                            $trTmpExt = $tr12->lookupJoined()->result();
                            //                            showLast_query("biru");
                            //                            cekHere(sizeof($trTmpExt));
                            //                            arrPrintWebs($trTmpExt);
                            if (sizeof($trTmpExt) > 0) {
                                foreach ($trTmpExt as $trTmpExtSpec) {
                                    //arrprint($trTmpExtSpec);
                                    $pairCode = $transaksiExtendConnectPair[$trTmpExtSpec->jenis];
                                    //                                    cekhere($pairCode);
                                    $tmpMasterIDExt[$trTmpExtSpec->id_master][$trTmpExtSpec->jenis] = $arrJenisStepRslt[$pairCode];
                                }
                            }
                        }
                        //                        arrPrint($tmpMasterIDExt);
                        //--------------------------------


                        $tr3 = new MdlTransaksi();
                        $tr3->setFilters(array());
                        $tr3->addFilter("link_id='0'");
                        $tr3->addFilter("id_master in ('" . implode("','", $tmpMasterID) . "')");
                        $tmpSrc3 = $tr3->lookupAll()->result();
                        //                    cekHijau($this->db->last_query() . " --- " . count($tmpSrc2));

                        //region membaca pairingan registries MAIN
                        $tmpReg_result = array();
                        if (sizeof($pairRegistries) > 0) {
                            foreach ($pairRegistries as $param) {

                                $trReg = new MdlTransaksi();
                                $trReg->setFilters(array());
                                $trReg->addFilter("param='$param'");
                                $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                                $tmpReg = $trReg->lookupRegistries()->result();
                                if (sizeof($tmpReg) > 0) {
                                    foreach ($tmpReg as $regRow) {
                                        $param = $regRow->param;
                                        $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);
                                    }
                                }
                            }
                        }
                        //endregion

                        foreach ($tmpSrc3 as $tmpSrc3Spec) {
                            $tmpMasterIDResult[$tmpSrc3Spec->id_master][$tmpSrc3Spec->jenis] = $tmpSrc3Spec->nomer;
                        }

                        foreach ($tmpSrc2 as $src2s) {
                            if (sizeof($tmpMasterIDResult[$src2s->id_master]) > 0) {
                                foreach ($tmpMasterIDResult[$src2s->id_master] as $key => $val) {

                                    $src2s->$key = $val;
                                }
                            }
                            $tmpResult[$src2s->id_master] = $src2s;
                        }

                        $arrNextPIC = callNextPIC($arrNextAction);


                        foreach ($tmpResult as $tmpSpec) {
//                            arrPrint($tmpSpec);
                            $extHistoryFields2 = isset($arrExtHistoryFields2[$tmpSpec->step_number]) ? $arrExtHistoryFields2[$tmpSpec->step_number] : array();

                            if (sizeof($pairRegistries) > 0) {
                                if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$tmpSpec->transaksi_id]))) {
                                    foreach ($tmpReg_result[$tmpSpec->transaksi_id] as $param => $eReg) {
                                        if ($param == "main") {
                                            foreach ($eReg as $k => $v) {
                                                if (!isset($tmpSpec->$k)) {
                                                    $tmpSpec->$k = $v;
                                                }
                                            }
                                        }
                                        elseif ($param == "items") {
                                            if (sizeof($extHistoryFields2) > 0) {
                                                foreach ($extHistoryFields2 as $k1 => $v1) {
                                                    if (is_array($v1)) {
                                                        $kolom = $v1['kolom'];
                                                        $format = $v1['format'];
//                                                cekHitam(":: $kolom :: $format ::");
                                                        if (!isset($tmpSpec->$k1)) {
                                                            $tmpDetail = "";
                                                            foreach ($eReg as $eeReg) {
                                                                $valDetail = formatField($format, $eeReg[$kolom]);
                                                                $tmpDetail .= "<span>$valDetail</span><br>";
                                                            }
                                                            $tmpSpec->$k1 = $tmpDetail;
                                                        }
                                                    }
                                                    else {
                                                        if (!isset($tmpSpec->$k1)) {
                                                            $tmpDetail = "";
                                                            foreach ($eReg as $eeReg) {
                                                                $valDetail = formatField("nomer", $eeReg[$v1]);
                                                                $tmpDetail .= "<span>$valDetail</span><br>";
                                                            }
                                                            $tmpSpec->$k1 = $tmpDetail;
                                                        }
                                                    }

                                                }
                                            }
                                        }
                                    }
                                }
                            }


                            foreach ($stepHistoryFields as $fName => $fLabel) {

                                $keyFormat = array_key_exists($fName, getTransaksiJenis()) ? "nomer" : $fName;
                                $tmp2Datas[$fName] = isset($tmpSpec->$fName) ? formatField($keyFormat, $tmpSpec->$fName) : "-";
                            }

                            if ($tmpSpec->sub_step_number > 0) {
                                $tmp2Datas['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$tmpSpec->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$tmpSpec->sub_step_number]['stateLabel'] . "</span>";
                                $tmp2Datas['state'] .= "<br>" . createStateSign($tmpSpec->sub_step_number, $tmpSpec->step_avail, $connectTo);
                            }
                            else {
                                $tmp2Datas['state'] = "<span style='color:#777777'>canceled</span>";
                            }


                            $tmp2Datas['next_pic'] = "-";
                            if (sizeof($arrNextPIC) > 0) {
                                if (isset($arrNextPIC[$tmpSpec->next_substep_code][$tmpSpec->next_substep_num])) {
                                    $next_pic = "";
                                    $nob = 1;
                                    foreach ($arrNextPIC[$tmpSpec->next_substep_code][$tmpSpec->next_substep_num] as $spec) {
                                        if ($tmpSpec->cabang_id == $spec['cabang_id']) {

                                            if ($next_pic == "") {
                                                $next_pic = "$nob. " . $spec['nama'];
                                            }
                                            else {
                                                $nob++;
                                                $next_pic = $next_pic . "<br>" . "$nob. " . $spec['nama'];
                                            }

                                        }
                                    }
                                    $tmp2Datas['next_pic'] = $next_pic;

                                }
                            }
                            //arrPrint($tmpMasterIDExt[$tmpSpec->id_master]);
                            //---------------------------------------------
                            //                            if(isset($tmpMasterIDExt[$tmpSpec->id_master])){
                            //                            if(isset($tmpMasterIDExt[$tmpSpec->id_master])){
                            if (sizeof($transaksiExtendConnectPair) > 0) {
                                foreach ($transaksiExtendConnectPair as $kk => $vv) {
                                    $next_picx = "";
                                    $nobx = 1;
                                    if (isset($tmpMasterIDExt[$tmpSpec->id_master][$kk])) {
                                        foreach ($tmpMasterIDExt[$tmpSpec->id_master][$kk] as $spec) {
                                            if ($next_picx == "") {
                                                $next_picx = "$nobx. " . $spec['nama'];
                                            }
                                            else {
                                                $nobx++;
                                                $next_picx .= "<br>" . "$nobx. " . $spec['nama'];
                                            }
                                        }
                                    }
                                    else {
                                        $next_picx = "done";
                                    }

                                    $tmp2Datas[$kk] = $next_picx;
                                }
                            }
                            //                            }
                            //---------------------------------------------


                            $tmp2[] = $tmp2Datas;

                            //                            break;
                        }
                    }
                }


                $arrayOnProgressView = $tmp2; // $tmp2
            }
        }

        return $arrayOnProgressView;
    }


    public function viewHistory()
    {
        if (!isset($this->session->login['id'])) {
            gotoLogin();
        }
        $starttime = microtime(true);
        $limit = 100;
        $maxPageNum = 20;
        $jenisTr = $this->uri->segment(3);
        $jenisTrsub = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;
        $allStep = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $availSteps = array();
        foreach ($allStep as $step => $tempStep) {
            $availSteps[$tempStep['target']] = $step;
        }
        $selectedSTep = isset($availSteps[$jenisTrsub]) ? $availSteps[$jenisTrsub] : 1;
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['historyFields'][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]['historyFields'][$selectedSTep] : $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $historyFieldsExt = isset($this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields"][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields"][$selectedSTep] : array();
        $extHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"][$selectedSTep] : array();
        $customButton = isset($this->config->item("heTransaksi_layout")[$jenisTr]["customButton"][$selectedSTep]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["customButton"][$selectedSTep] : array();
        $printValas = isset($this->config->item("heTransaksi_layout")[$jenisTr]["print_nvalas"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["print_nvalas"] : array();
        $pairTransaksi = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairTransaksi']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairTransaksi'] : array();
        $extHistoryKeterangan = isset($this->config->item("heTransaksi_ui")[$jenisTr]['extHistoryKeterangan'][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]['extHistoryKeterangan'][$selectedSTep] : array();
        //arrPrint($extHistoryKeterangan);

        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }

        $backdate_f = formatTanggal(backDate(30), 'Y-m-d');

        $date1 = isset($_GET['date1']) ? $_GET['date1'] : $backdate_f;
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");


        // cekHere($date1." ******* ".$date2);

        //region preparing ERP step labels for top link
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $stepLabels = array();
        $stepLinks = array();
        if (sizeof($steps) > 1) {
            $subCodes = array();
            $stepCodes = array();
            $jmlStep = count($steps);

            foreach ($steps as $stepNumber => $stepSpec) {
                if ($stepNumber <= $jmlStep) {
                    $subCodes[$stepSpec['target']] = $stepSpec['label'];
                    $stepCodes[] = $stepSpec['target'];
                    $stepLabels[$stepNumber] = $stepSpec['label'];
                    $stepLinks[$stepNumber] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $stepSpec['target'] . "?date1=$date1&date2=$date2";
                }
            }
            if (isset($_GET['stID'])) {
                $currentState = $_GET['stID'];
            }
            else {
                $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['target'];
            }
        }
        //endregion


        //region lookup histories

        $this->load->model("Mdls/MdlMongoMother");

        $tr = new MdlMongoMother();

        $searchStr = isset($_GET['search']) ? $_GET['search'] : "";
        if (my_cabang_id() == "-1") {
            $filters = array(
                // "cabang_id" => $this->placeId,
                "jenis_master" => $this->jenisTr,
                "link_id" => "0",
                "div_id" => $this->session->login['div_id'],
            );
        }
        else {
            if ($this->session->login['employee_type'] == "employee_freelance") {
                // $tr->addFilter("seller_id='" . $this->session->login['id'] . "'");
                $filters = array(
                    "cabang_id" => $this->placeId,
                    "jenis_master" => $this->jenisTr,
                    "link_id" => "0",
                    "div_id" => $this->session->login['div_id'],
                    "seller_id" => $this->session->login['id']

                );
            }
            else {

                $filters = array(
                    "cabang_id" => $this->placeId,
                    "jenis_master" => $this->jenisTr,
                    "link_id" => "0",
                    "div_id" => $this->session->login['div_id'],
                );
            }

        }

        //region date filter
        // $this->db->where("fulldate>='" . $date1 . "'");
        // $this->db->where("fulldate<='" . $date2 . "'");
        //endregion

        if (isset($currentState)) {
            $filters['jenis'] = $currentState;
            //            $tr->addFilter("jenis='" . $currentState . "'");
        }


        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        $addFilters = array();
        if ($addParams != null && sizeof($addParams) > 0) {
            foreach ($addParams as $fK => $fV) {
                if ($fK == "dtime") {
                    // $strDate = $addParams['dtime'];
                    $endDate = date('t', strtotime($fV));
                    $lastDate = str_replace("01", $endDate, $fV);

                    // $endDate ="";
                    cekBiru($lastDate);
                    // matiHEre($strDate);
                    $tr->setParam("fulldate");
                    $tr->addRange($fV, $lastDate);
                }
                else {
                    // cekHitam($fK."$fV");
                    $filters[$fK] = "$fV";
                    // $addFilters[$fK]="$fV";
                    // $tr->addFilter(array("$fK"=>"$fV"));
                }
            }


        }
        else {
            if (isset($_GET['date1'])) {
                $tr->setParam("fulldate");
                $tr->addRange($date1, $date2);
            }
            else {
                //            $tr->setLimit($limit);
                $tr->setParam("fulldate");
                $tr->addRange($date1, $date2);
            }
        }


        //        matiHEre();
        //        $jmlData = $tr->lookupDataCount();
        //        $page = (isset($_GET['page']) && $_GET['page'] > 0) ? ($_GET['page']) : 1;
        //        $offset = ($limit * ($page - 1));
        //
        //        $addParams = array();
        //        if (isset($_GET['addParams'])) {
        //            $addParams = unserialize(base64_decode($_GET['addParams']));
        //        }
        //        if ($addParams != null && sizeof($addParams) > 0) {
        //            foreach ($addParams as $f) {
        //                $tr->addFilter($f);
        //            }
        //        }

        $action = array(
            "viewDetails" => base_url() . get_class($this) . "/viewDetails",
        );

        //        if (isset($_GET['search'])) {
        //            $tr->setKeyWord($searchStr);
        //        }
        //        else {
        //            $this->db->where("fulldate>='" . $date1 . "'");
        //            $this->db->where("fulldate<='" . $date2 . "'");
        //        }
        //        if(sizeof($inParam)>0){
        //            $tr->setParam($param);
        //            $tr->setInParam($inParam);
        //
        //        }
        // arrPrint($addFilters);
        if (sizeof($addFilters) > 0) {
            $lastFilters = $filters + $addFilters;
        }
        else {
            $lastFilters = $filters;
        }
        // $tr->addFilter($addFilters);
        $tr->addFilter($lastFilters);
        $tmpHist = $tr->lookupHistories();

        // arrPrintWebs($tmpHist);
        //matiHEre();
        $arrCurrency = array();
        if (sizeof($printValas) > 0) {
            $trv = new MdlCurrency();
            $tmpCurrency = $trv->lookupAll()->result();
            if (sizeof($tmpCurrency) > 0) {
                foreach ($tmpCurrency as $key => $value) {
                    $arrCurrency[$key] = $value;
                }
            }
        }

        $cabang_id = $this->placeId;

        $arrayHistory = array();
        $arrayHistory_ids = array();
        $arrayHistory_canceled = array();
        $sumValue = array();
        if (sizeof($tmpHist) > 0) {
            if (sizeof($pairRegistries) > 0) {
                $arrSalesName = array();
                $arrTransID = array();
                $arrTransTopID = array();
                $arrIndexID = array();
                $arrIdsHist = array();
                $arrTransHist = array();
                $arrTransMainHist = array();
                foreach ($tmpHist as $row) {
                    $arrTransID[] = $row->id;
                    $arrTransTopID[] = $row->id_top;

                    if ($row->ids_his != "") {
                        $hist = blobDecode($row->ids_his);
                        foreach ($hist as $hisSpec) {
                            $arrIdsHist[$row->id][$hisSpec['step']] = array(
                                "step" => $hisSpec['step'],
                                "trID" => $hisSpec['trID'],
                                "nomer" => $hisSpec['nomer'],
                            );
                            $arrTransHist[] = $hisSpec['trID'];
                        }
                    }
                }

                $tmpReg_result = array();
                $trReg = new MdlMongoMother();

                $trReg->setFilters(array());
                foreach ($pairRegistries as $param) {
                    $trReg->setParam("transaksi_id");
                    $trReg->setInParam($arrTransID);
                    $trReg->setFilters(array("param" => $param));
                    $tmpReg = $trReg->lookupRegistryAll();

//                                        arrPrint($tmpReg);
                    if (sizeof($tmpReg) > 0) {
                        foreach ($tmpReg as $regRow) {
                            $tmpReg_result[$regRow->transaksi_id][$regRow->param] = blobDecode($regRow->values);
                        }
                    }
                }

                $tr->setFilters(array());
                $tr = new MdlMongoMother();
                $tr->setParam("id");
                $tr->setInParam($arrTransTopID);
                $tmpTrTop = $tr->lookUpMainTransaksi();
                if (sizeof($tmpTrTop) > 0) {
                    foreach ($tmpTrTop as $topSpec) {
                        $arrSalesName[$topSpec->id_top] = $topSpec->oleh_nama;
                    }
                }

                if (sizeof($arrIdsHist) > 0) {
                    $tr->setFilters(array());
                    $tr = new MdlMongoMother();
                    $tr->setParam("id");
                    $tr->setInParam($arrTransHist);
                    $tmpTransHist = $tr->lookUpMainTransaksi();

                    //                    $tr = new MdlTransaksi();
                    //                    $tr->setFilters(array());
                    //                    $tr->addFilter("id in ('" . implode("','", $arrTransHist) . "')");
                    //                    $tmpTransHist = $tr->lookupAll()->result();

                    $tmpTransHist_result = array();
                    if (sizeof($tmpTransHist) > 0) {
                        foreach ($tmpTransHist as $histSpec) {
                            $tmpTransHist_result[$histSpec->id] = array(
                                "oleh_id" => $histSpec->oleh_id,
                                "oleh_nama" => $histSpec->oleh_nama,
                            );
                        }
                    }
                    //                    arrPrint($tmpTransHist_result);
                    //                    matiHEre();
                    if (sizeof($arrIdsHist) > 0) {
                        foreach ($arrIdsHist as $trID => $histSpec) {
                            foreach ($histSpec as $step => $detailSpec) {
                                if (array_key_exists($detailSpec['trID'], $tmpTransHist_result)) {
                                    $detailSpec['main'] = $tmpTransHist_result[$detailSpec['trID']];
                                }
                                $arrTransMainHist[$trID][$step] = $detailSpec;
                            }
                        }
                    }

                }

            }

            //arrPrint($tmpReg_result);
            //            matiHere();
            $numb = 0;
            foreach ($tmpHist as $ii => $row) {

                $this->placeId = $cabang_id = $row->cabang_id;
                // region ids_his
                $id_hist = blobDecode($row->ids_his);
                // endregion ids_his

                //region memangil global counter
                $tNomer_top = $row->nomer_top;
                //                $tr = new MdlTransaksi();
                //                $tr->addFilter("param='main'");
                //                $tmpReg = $tr->lookupRegistriesByNumber($tNomer_top)->result();
                //
                //                $arrSalesName = "";
                //                foreach ($tmpReg as $tmpRowReg) {
                //                    $arrSalesName = $tmpRowReg->oleh_nama;
                //                }
                $salesName = isset($arrSalesName[$row->id_top]) ? $arrSalesName[$row->id_top] : "-";


                $tNomer = $row->nomer;
                $jenisTrtop = explode(".", $tNomer_top)[0];
                $jenisTrsub = explode(".", $tNomer)[0];
                $counterjenis = "$jenisTrsub|" . $this->placeId;
                // $counterjenis = my_cabang_id()=="-1"? "$jenisTrsub":"$jenisTrsub|" . $this->placeId;

                // matiHEre($jenisTrsub);
                $counterIds_his = blobDecode(blobDecode($row->ids_his)[1]['counters']);
                $counters = blobDecode($row->counters);
                // arrPrint($counters);
                // matiHere();

                $counterGlobal = $counters['stepCode|placeID'][$counterjenis];


                $counterIds_his_global = isset($counterIds_his['stepCode|placeID']["$jenisTrtop|$cabang_id"]) ? $counterIds_his['stepCode|placeID']["$jenisTrtop|$cabang_id"] : "";
                $cGlobals = digit_5($counterGlobal);
                $cGlobal_spo = digit_5($counterIds_his_global);

                //endregion

                if (sizeof($pairRegistries) > 0) {
                    if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->id]))) {
                        foreach ($tmpReg_result[$row->id] as $param => $eReg) {
//                                                        cekLime($param);
                            if ($param == "main") {
                                foreach ($eReg as $k => $v) {
                                    if (!isset($row->$k)) {
                                        $row->$k = $v;
                                    }
                                }
                            }
                            else {
                                if (sizeof($extHistoryFields2) > 0) {
                                    foreach ($extHistoryFields2 as $k1 => $v1) {
                                        if (is_array($v1)) {
                                            $kolom = $v1['kolom'];
                                            $format = $v1['format'];
//                                                cekHitam(":: $kolom :: $format ::");
                                            if (!isset($row->$k1)) {
                                                $tmpDetail = "";
                                                foreach ($eReg as $eeReg) {
                                                    $valDetail = formatField($format, $eeReg[$kolom]);
                                                    $tmpDetail .= "<span>$valDetail</span><br>";
                                                }
                                                $row->$k1 = $tmpDetail;
                                            }
                                        }
                                        else {

                                            if (!isset($row->$k1)) {
                                                $tmpDetail = "";
                                                foreach ($eReg as $eeReg) {
                                                    $valDetail = formatField("nomer", $eeReg[$v1]);
                                                    $tmpDetail .= "<span>$valDetail</span><br>";
                                                    //                                                arrPrint($eeReg);
                                                }
                                                $row->$k1 = $tmpDetail;
                                            }
                                        }
//                                        else{
//                                            mati_disini("sudah ada $k1");
//                                        }
//
                                    }
                                }
                            }
                        }
                    }
                    if (sizeof($pairTransaksi) > 0) {
                        if ($row->referenceID > 0) {
                            $trPair = new MdlTransaksi();
                            $trPair->addFilter("id='" . $row->referenceID . "'");
                            $trPairTmp = $trPair->lookupMainTransaksi()->result();
                            if (sizeof($trPairTmp) > 0) {
                                $hisTr = isset($trPairTmp[0]->ids_his) ? blobDecode($trPairTmp[0]->ids_his) : array();
                                foreach ($hisTr as $step => $hisTrSpec) {
                                    foreach ($pairTransaksi['kolom'] as $keyPair => $labelPair) {
                                        $keyPairs = $keyPair . "_" . $step;
                                        $row->$keyPairs = isset($hisTrSpec[$labelPair]) ? $hisTrSpec[$labelPair] : "--";
                                    }
                                }
                            }
                        }
                    }
                }

                //arrPrintWebs($row);
                if (sizeof($historyFieldsExt) > 0) {
                    foreach ($historyFieldsExt as $alias => $colom) {
                        $row->$alias = $row->$colom;
                    }
                }
                $tmp = array();
                $tmp1 = array();
//arrPrint($row);
//                 break;
                $numb++;
                foreach ($historyFields as $fName => $fLabel) {
//                    cekHitam($fName);
                    if (strpos($fName, '+') !== false) {//==mengandung penggabungan (+)
                        $chars = explode("+", $fName);
                        $colValue = "";
                        foreach ($chars as $key) {
                            if (is_numeric($row->$key)) {
                                if (!isset($sumValue[$key])) {
                                    $sumValue[$key] = 0;
                                }
                                $sumValue[$key] += $row->$key;
                            }
                            $colValue .= isset($row->$key) ? formatField($key, $row->$key) . "<br>" : "";
                        }
                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {

                        if (is_numeric(isset($row->$fName) ? $row->$fName : "")) {
                            if (!isset($sumValue[$fName])) {
                                $sumValue[$fName] = 0;
                            }
                            $sumValue[$fName] += $row->$fName;
                        }

                        //region nomer dengan global counter
                        if ($fName == "nomer") {
                            // switch ($jenisTr) {
                            switch ($jenisTrsub) {
                                case "582s":
                                    $kolomValues = $row->$fName . "&#x2011;$cGlobals";
                                    break;
                                // case "582spd":
                                default:
                                    $kolomValue_0s = formatField($fName, $row->$fName);
                                    $kolomValues = str_replace("</span>", "&#x2011;" . $cGlobals, $kolomValue_0s);
                                    break;
                            }
                        }
                        elseif ($fName == "nomer_top") {
                            $kolomValue_0s = formatField($fName, $row->$fName);
                            $kolomValues = str_replace("</span>", "&#x2011;" . $cGlobal_spo, $kolomValue_0s);
                        }
                        else {
//                            cekHitam(";; $fName");
                            $kolomValues = isset($row->$fName) ? formatField($fName, $row->$fName) : "-";
                        }
                        //endregion

                        // $colValue = isset($row->$fName) ? formatField($fName, $row->$fName) : "";

                        $colValue = isset($row->$fName) ? $kolomValues : "";
                        //                        cekLime("$colValue"." ".$fName);

                    }

                    //                    if ($fName == "ids_his") {
                    if (is_array($fLabel)) {

                        $hisStep = $fLabel['step'];
                        $hisKey = $fLabel['key'];
                        //                        $tNomer = $id_hist[$hisStep][$hisKey];


                        if ($hisKey == "nomer") {
                            $colValue = isset($row->ids_his) ? showHistoriGlobalNumbers($row->ids_his, $hisStep, true) : "";
                        }
                        else {
                            if (isset($fLabel['transaksi_jenis2'][$row->transaksi_jenis2])) {
                                $getKey = $fLabel['transaksi_jenis2'][$row->transaksi_jenis2];
                                //                                cekHere(":: $getKey ::");
                                $colValue = isset($row->$getKey) ? formatField($getKey, $row->$getKey) : "";
                            }
                            else {

                                $colValue = "-";
                            }
                        }


                        //                            $tr = new MdlTransaksi();
                        //                            $tr->setFilters(array());
                        //                            $tr->addFilter("param='main'");
                        //                            $tmpReg = $tr->lookupRegistriesByNumber($tNomer)->result();
                        ////                            cekHere($this->db->last_query());
                        //
                        //                            $logistic = $tmpReg[0]->oleh_nama;
                        $logistic = "";
                        if (isset($arrTransMainHist[$row->id][$hisStep]['main'])) {
                            $main = $arrTransMainHist[$row->id][$hisStep]['main'];
                            $logistic = $main['oleh_nama'];
                        }
                    }
                    //                    }

                    if ($fName == "no") {
                        $colValue = formatField($fName, $numb);
                    }

                    //                    cekHere($logistic);
                    $tmp['logistic'] = isset($logistic) && $logistic != null ? $logistic : 'undefined';
                    $tmp['sales_name'] = $salesName;
                    $tmp[$fName] = $colValue;
                    $tmp1["id"] = $row->id;
                }


                if (sizeof($arrCurrency) > 0) {
                    $valas = "";
                    $valas .= "<div class='btn-group'>";
                    $valas .= "<button type='button' class='btn btn-primary dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                    $valas .= "<i class='fa fa-print'></i>";
                    $valas .= "<span class='caret'></span>";
                    $valas .= "</button>";

                    $valas .= "<ul style='background:#cde8ff;' class='dropdown-menu dropdown-menu-right'>";
                    foreach ($arrCurrency as $arrV) {
                        $nama = $arrV->nama;
                        $nomer = $row->nomer;
                        $nilai = number_format($arrV->exchange, 0);
                        $valas .= " <li class='text-bold'><a class='dropdown-item' href='javascript:void(0);' onclick=\"top.popBig('" . base_url() . "Transaksi/viewReceipt/$nomer?type=" . blobEncode($nama) . "&f=" . blobEncode($arrV->exchange) . "')\"> <i class='fa fa-print'></i> in $nama - ($nilai) </a></li>";
                    }

                    $valas .= " <li><a class='btn btn-xs btn-warning' href='javascript:void(0);' onclick=\"top.location.href='" . base_url() . "data/view/Currency'\"> <i class='fa fa-plus'></i> tambah currency </a></li>";
                    $valas .= "</ul>";
                    $valas .= "</div>";
                    $tmp["print_nvalas"] = $valas;
                }

                $tmp['next_pic'] = "-";

                // menambah background-color karena dicancel/reject/undo, atau yang dibatalkan
                //                $tmp['keterangan'] = "-";
                $addKeterangan = "";
                if (isset($row->trash_4) && ($row->trash_4 == 1)) {
                    //                    $tmp['keterangan'] = "CANCELED";
                    $addKeterangan = "CANCELED";
//                    $addKeterangan .= $row->cancel_dtime != NULL ? "&nl2br; date: " . $row->cancel_dtime : "";
//                    $addKeterangan .= $row->cancel_name != NULL ? "&nl2br; by: " . $row->cancel_name : "";
                    $addKeterangan .= $row->cancel_dtime != NULL ? nl2br(" date: " . $row->cancel_dtime) : "";
                    $addKeterangan .= $row->cancel_name != NULL ? nl2br(" by: " . $row->cancel_name) : "";
                    $arrayHistory_canceled[$ii] = array(
                        "bgcolor" => "background-color:red;color:#cccccc;",
                    );
                }
                // menambah background-color karena diedit...
                if (sizeof($extHistoryKeterangan) > 0) {
                    foreach ($extHistoryKeterangan as $mode => $modeSpec) {
                        $mode_result = "";
                        if (sizeof($modeSpec) > 0) {
                            if (isset($row->$modeSpec['kolom']) && ($row->$modeSpec['kolom'] == $modeSpec['value'])) {
                                $addBr = $addKeterangan != NULL ? "<hr>" : "";
                                $l_result = "";
                                if (is_array($modeSpec['labels'])) {
                                    foreach ($modeSpec['labels'] as $l) {
                                        if ($l_result == "") {
                                            $l_result = "$addBr $mode by: " . formatField($l, $row->$l);
                                        }
                                        else {
                                            $l_result .= ", " . formatField($l, $row->$l);
                                        }
                                    }
                                }
                                else {
                                    $l_result = $modeSpec['labels'];
                                }
                                $mode_result .= $l_result;

                                //----------------------------------------
                                if (isset($modeSpec['style'])) {
                                    $color = $modeSpec['style']['color'];
                                    $bgcolor = $modeSpec['style']['bgcolor'];
                                    $arrayHistory_keterangan[$ii] = array(
                                        "bgcolor" => "background-color:$bgcolor;color:$color;",
                                    );
                                }
                            }

                        }
                        $addKeterangan .= $mode_result;


                    }
                }


                $tmp['keterangan'] = $addKeterangan;
                $arrayHistory[$ii] = $tmp;
                $arrayHistory_ids[$ii] = $tmp1;


            }
        }
        //endregion


        //region link to add new transaction
        if (placeCanMakeTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr)) {
            //        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['userGroup'], $this->session->login['membership'])) {
            $createIndexes = (null != $this->config->item("transaksi_createIndex")) ? $this->config->item("transaksi_createIndex") : array();
            if (array_key_exists($this->jenisTr, $createIndexes)) {
                $targetUrl = base_url() . $createIndexes[$this->jenisTr] . "/" . $this->jenisTr;
            }
            else {
                $targetUrl = base_url() . "Transaksi/createForm/" . $this->jenisTr;
            }
            $addLink = array(
                "link" => $targetUrl,
                "label" => "<span class='glyphicon glyphicon-plus'></span> create new " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            );
        }
        else {
            $addLink = null;
        }
        //endregion

        //region prepare params for viewer
        $data = array(
            "mode" => $this->uri->segment(2),
            //            "mode" => "viewHistory",
            "isMobile" => $isMob,
            "jenisTr" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "errMsg" => $this->session->errMsg,
            "title" => isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName,
            "subTitle" => "histories",
            "customButton" => $customButton,
            "customButtonTarget" => isset($currentState) ? "$currentState?date1=$date1&date2=$date2" : "",
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory,
            "arrayHistorySumField" => $sumValue,
            "arrayHistoryId" => $arrayHistory_ids,
            "action" => $action,
            "steps" => $steps,
            "stepLabels" => $stepLabels,
            "stepLinks" => $stepLinks,
            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
            "currentState" => isset($currentState) ? $currentState : "all states",
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
            "alternateLinkCaption" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " <span class='glyphicon glyphicon-arrow-right'></span>",
            "addLink" => $addLink,
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),

            "history_canceled" => isset($arrayHistory_canceled) ? $arrayHistory_canceled : array(),
            "history_keterangan" => isset($arrayHistory_keterangan) ? $arrayHistory_keterangan : array(),
        );
        //endregion
        $endtime = microtime(true); // Bottom of page
        $valTimeEnd = $endtime - $starttime;
//        cekBiru("load time start $starttime ||  end $endtime =>" . "$valTimeEnd");

        $this->load->view("history", $data);
    }

    public function viewStatusOLD()
    {
        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        $limit = 1000;
        //        $limit = 20;
        $maxPageNum = 20;
        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields'] : array();
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $pairStepCode = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'] : array();
        $addMainStep = isset($this->config->item("heTransaksi_ui")[$jenisTr]['addMainStep']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['addMainStep'] : array();

        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }
        $backdate_f = formatTanggal(backDate(30), 'Y-m-d');
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : $backdate_f;
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $tmpCode = array();
        if (sizeof($pairStepCode) > 0) {
            foreach ($pairStepCode as $t => $tSpec) {
                $tmpCode[$t] = $tSpec['target'];
            }
        }
        if (sizeof($addMainStep) > 0) {
            foreach ($addMainStep as $t => $tSpec) {
                $tmpCode[$t] = $tSpec['target'];
            }
        }

        //region preparing ERP step labels for top link
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $stepLabels = array(//            "0" => "all"
        );
        $stepLinks = array(//            "0" => base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3)
        );
        if (sizeof($steps) > 1) {
            $subCodes = array();
            $stepCodes = array();
            $jmlStep = count($steps);

            foreach ($steps as $stepNumber => $stepSpec) {
                if ($stepNumber <= $jmlStep) {
                    $subCodes[$stepSpec['target']] = $stepSpec['label'];
                    $stepCodes[] = $stepSpec['target'];
                    //                    $stepLabels[$stepNumber] = $stepSpec['stateLabel'];
                    $stepLabels[$stepNumber] = $stepSpec['label'];
                    $stepLinks[$stepNumber] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $stepSpec['target'] . "?date1=$date1&date2=$date2";
                }

            }


            //            $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->jenisTr;
            $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['target'];
        }
        //endregion

        //region lookup histories
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        //        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
        //        $tr->addFilter("gudang_id='" . $this->session->login['gudang_id'] . "'");
        $tr->addFilter("jenis_master='" . $this->jenisTr . "'");
        $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
        $searchStr = isset($_GET['search']) ? $_GET['search'] : "";

        //region date filter

        // $this->db->where("fulldate>='" . $date1 . "'");
        // $this->db->where("fulldate<='" . $date2 . "'");
        //endregion

        if (isset($currentState)) {
            //            $tr->addFilter("jenis='" . $currentState . "'");
            $tr->addFilter("jenis='" . $tmpCode[1] . "'");
        }

        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }

        if (isset($_GET['search'])) {
            $tr->setKeyWord($searchStr);
        }
        else {
            $this->db->where("fulldate>='" . $date1 . "'");
            $this->db->where("fulldate<='" . $date2 . "'");
        }

        $jmlData = $tr->lookupDataCount();
        $page = (isset($_GET['page']) && $_GET['page'] > 0) ? ($_GET['page']) : 1;
        $offset = ($limit * ($page - 1));

        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            //            arrprint($addParams);
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }

        $action = array(
            "viewDetails" => base_url() . get_class($this) . "/viewDetails",
        );
        if (isset($_GET['search'])) {
            $tr->setKeyWord($searchStr);
        }
        else {
            $this->db->where("fulldate>='" . $date1 . "'");
            $this->db->where("fulldate<='" . $date2 . "'");
        }
        $tmpHist = $tr->lookupHistories($jmlData, $limit, $page)->result();

        $arrayHistory = array();
        $arrayHistory_ids = array();
        $arrayHistory_topID = array();
        $arrayHistoryCanceled = array();
        $arrayHistoryDone = array();
        if (sizeof($tmpHist) > 0) {
            foreach ($tmpHist as $row) {
                if (sizeof($pairRegistries) > 0) {
                    $trReg = new MdlTransaksi();
                    $trReg->setFilters(array());
                    $trReg->addFilter("param in ('" . implode("','", $pairRegistries) . "')");
                    $trReg->addFilter("transaksi_id='" . $row->id . "'");
                    $tmpReg = $trReg->lookupRegistries()->result();
                    if (sizeof($tmpReg) > 0) {
                        foreach ($tmpReg as $regRow) {
                            $param = $regRow->param;
                            $$param = blobDecode($regRow->values);
                        }
                        foreach ($pairRegistries as $eReg) {
                            foreach ($$eReg as $k => $v) {
                                if (!isset($row->$k)) {
                                    $row->$k = $v;
                                }
                            }
                        }
                    }
                }

                $tmp = array();
                $tmp1 = array();
                foreach ($historyFields as $fName => $fLabel) {
                    if (strpos($fName, '+') !== false) {
                        //==mengandung penggabungan (+)
                        $chars = explode("+", $fName);
                        $colValue = "";
                        foreach ($chars as $key) {
                            $colValue .= isset($row->$key) ? formatField($key, $row->$key) . "<br>" : "";
                        }
                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {
                        $colValue = isset($row->$fName) ? formatField($fName, $row->$fName) : "";
                    }
                    $tmp[$fName] = $colValue;
                    $tmp1["id"] = $row->id;
                }

                $arrayHistory[$row->id] = $tmp;
                $arrayHistory_ids[] = $tmp1;
                $arrayHistory_topID[$row->id] = $row->id_top;

                if ($row->trash_4 == 1) {
                    $arrayHistoryCanceled[] = $row->id;
                }

            }
            //arrPrint($arrayHistory_topID);
            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("link_id='0'");
            $tr->addFilter("id_top in (" . implode(",", $arrayHistory_topID) . ")");
            $tr->setSortBy(array(
                "kolom" => "id",
                "mode" => "ASC",
            ));
            $arrTmp = $tr->lookupAll()->result();


            $arrayNext = array();
            $arrayNextData = array();
            if (sizeof($arrTmp) > 0) {
                foreach ($arrTmp as $tSpec) {
                    $arrayNext[$tSpec->id_top][$tSpec->jenis] = $tSpec->jenis;
                    //                    $arrayNext[$tSpec->id_top][$tSpec->jenis] = $tSpec->jenis;
                    //                    cekHere("$tSpec->id :: $tSpec->jenis :: $tSpec->status_4");
                    if ($tSpec->status_4 == 1) {
                        //                        $arrayHistoryDone[$tSpec->id_top] = $tSpec->id;
                        $arrayHistoryDone[$tSpec->id] = $tSpec->id;
                    }
                }
            }
            //arrPrint($arrayHistory);
            //            arrPrint($arrayNext);
            //arrPrint($arrayNextData);
            //            arrPrint($arrayHistoryDone);
            if (sizeof($arrayHistory_topID) > 0) {
                foreach ($arrayHistory_topID as $tID => $topID) {
                    if (array_key_exists($topID, $arrayNext)) {
                        $del = "";
                        $st = "";
                        foreach ($tmpCode as $tJenis_code) {
                            $class = "";
                            $class = "disabled";

                            $tJenis = isset(arrConfName()[$tJenis_code]) ? arrConfName()[$tJenis_code] : $tJenis_code;
                            if (array_key_exists($tJenis_code, $arrayNext[$topID])) {
                                $class = "btn-success";
                            }
                            //                            elseif (array_key_exists($tID, $arrayHistoryDone)) {
                            //                                //                            elseif(in_array($tID, $arrayHistoryDone)){
                            //                                $class = "btn-success";
                            //                            }

                            if (array_key_exists($tJenis_code, $arrayNext[$topID])) {
                                $disabled = "";
                            }
                            elseif (array_key_exists($tID, $arrayHistoryDone)) {
                                //                            elseif(in_array($tID, $arrayHistoryDone)){
                                $disabled = "";
                            }


                            if ($st == "") {
                                $st = "<input type='button' class='btn btn-xs $class' $disabled value='$tJenis'>";
                            }
                            else {
                                $st = $st . "  <input type='button' class='btn btn-xs $class' $disabled value='$tJenis'>";
                            }
                        }
                        if (in_array($tID, $arrayHistoryCanceled)) {
                            $del = "<br><input type='button' class='btn btn-xs btn-block btn-danger' disabled value='CANCELED'>";
                        }
                        if (array_key_exists($tID, $arrayHistory)) {
                            $arrayHistory[$tID]['status_next'] = $st . $del;
                        }
                    }
                }
            }
        }
        //endregion
        //        arrPrint($arrayHistory);

        //region prepare params for viewer
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "jenisTr" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "errMsg" => $this->session->errMsg,
            "title" => isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName,
            "subTitle" => "status",
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory,
            "arrayHistoryId" => $arrayHistory_ids,
            "arrayHistoryCanceled" => $arrayHistoryCanceled,
            "action" => $action,
            "steps" => $steps,
            "stepLabels" => $stepLabels,
            "stepLinks" => $stepLinks,
            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
            "currentState" => isset($currentState) ? $currentState : "all states",
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
            "alternateLinkCaption" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " <span class='glyphicon glyphicon-arrow-right'></span>",
            "addLink" => isset($addLink) ? $addLink : "",
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),

        );
        //endregion


        $this->load->view("history", $data);
    }

    public function viewHistoryApi()
    {
        if (!isset($this->session->login['id'])) {
            gotoLogin();
        }

        $limit = $_GET['start'];
        $length = $_GET['length'];
        $maxPageNum = 20;
        $jenisTr = $this->uri->segment(3);
        $jenisTrsub = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;
        $allStep = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $availSteps = array();
        foreach ($allStep as $step => $tempStep) {
            $availSteps[$tempStep['target']] = $step;
        }
        $selectedSTep = isset($availSteps[$jenisTrsub]) ? $availSteps[$jenisTrsub] : 1;
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['historyFields'][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]['historyFields'][$selectedSTep] : $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];

        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $historyFieldsExt = isset($this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields"][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields"][$selectedSTep] : array();
        $extHistoryFields2 = isset($this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"][$selectedSTep]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["extHistoryFields2"][$selectedSTep] : array();
        $customButton = isset($this->config->item("heTransaksi_layout")[$jenisTr]["customButton"][$selectedSTep]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["customButton"][$selectedSTep] : array();
        $printValas = isset($this->config->item("heTransaksi_layout")[$jenisTr]["print_nvalas"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["print_nvalas"] : array();
        $pairTransaksi = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairTransaksi']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairTransaksi'] : array();


        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }

        $backdate_f = formatTanggal(backDate(30), 'Y-m-d');

        $date1 = isset($_GET['date1']) ? $_GET['date1'] : $backdate_f;
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");

        //region preparing ERP step labels for top link
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $stepLabels = array();
        $stepLinks = array();
        if (sizeof($steps) > 1) {
            $subCodes = array();
            $stepCodes = array();
            $jmlStep = count($steps);

            foreach ($steps as $stepNumber => $stepSpec) {
                if ($stepNumber <= $jmlStep) {
                    $subCodes[$stepSpec['target']] = $stepSpec['label'];
                    $stepCodes[] = $stepSpec['target'];
                    $stepLabels[$stepNumber] = $stepSpec['label'];
                    $stepLinks[$stepNumber] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $stepSpec['target'] . "?date1=$date1&date2=$date2";
                }
            }
            if (isset($_GET['stID'])) {
                $currentState = $_GET['stID'];
            }
            else {
                $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['target'];
            }
        }
        //endregion

        //region lookup histories
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("cabang_id='" . $this->placeId . "'");
        $tr->addFilter("jenis_master='" . $this->jenisTr . "'");
        $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");

        $searchStr = isset($_GET['search']) && $_GET['search']['value'] != '' ? $_GET['search']['value'] : "";

        if (isset($currentState)) {
            $tr->addFilter("jenis='" . $currentState . "'");
        }

        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }

        $action = array(
            "viewDetails" => base_url() . get_class($this) . "/viewDetails",
        );

        $jmlData = $tr->lookupHistoriesDtAll();

        $page = (isset($_GET['page']) && $_GET['page'] > 0) ? ($_GET['page']) : 1;
        $offset = ($limit * ($page - 1));

        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }

        $action = array(
            "viewDetails" => base_url() . get_class($this) . "/viewDetails",
        );

        if (isset($_GET['search']) && $_GET['search']['value'] != '') {
            $tr->setKeyWord($searchStr);
        }

        if (!isset($_GET['xxx'])) {
            $this->db->where("fulldate>='" . $date1 . "'");
            $this->db->where("fulldate<='" . $date2 . "'");
        }
        else {
            if (
                (!isset($_GET['startDate']) OR isset($_GET['startDate']) && $_GET['startDate'] == '') &&
                (isset($_GET['endDate']) OR isset($_GET['endDate']) && $_GET['endDate'] != '')
            ) {
                //                    cekmerah('#1');
            }
            elseif (
                (!isset($_GET['endDate']) OR isset($_GET['endDate']) && $_GET['endDate'] == '') &&
                (isset($_GET['startDate']) OR isset($_GET['startDate']) && $_GET['startDate'] != '')
            ) {
                //                cekmerah('#2');
            }
            elseif (!isset($_GET['endDate']) && !isset($_GET['startDate'])) {
                //                cekmerah('#3');
            }
            else {
                $this->db->where("fulldate>='" . date('Y-m-d', strtotime($_GET['startDate'])) . "'");
                $this->db->where("fulldate<='" . date('Y-m-d', strtotime($_GET['endDate'])) . "'");
                //                cekmerah('#4');
                //                cekMerah("fulldate>='" . date('Y-m-d', strtotime($_GET['startDate'])) . "'");
                //                cekMerah("fulldate>='" . date('Y-m-d', strtotime($_GET['endDate'])) . "'");
            }
        }


        $tmpHist = $tr->lookupHistoriesDt($jmlData, $limit, $length, $historyFields)->result();
        $jmlFiltered = $tr->lookupHistoriesDtFil($jmlData, $limit, $length, $historyFields);

        $arrCurrency = array();
        if (sizeof($printValas) > 0) {
            $trv = new MdlCurrency();
            $tmpCurrency = $trv->lookupAll()->result();
            if (sizeof($tmpCurrency) > 0) {
                foreach ($tmpCurrency as $key => $value) {
                    $arrCurrency[$key] = $value;
                }
            }
        }

        $cabang_id = $this->placeId;

        $arrayHistory = array();
        $arrayHistory_ids = array();
        $arrayHistory_canceled = array();
        $sumValue = array();
        if (sizeof($tmpHist) > 0) {
            if (sizeof($pairRegistries) > 0) {
                $arrSalesName = array();
                $arrTransID = array();
                $arrTransTopID = array();
                $arrIndexID = array();
                $arrIdsHist = array();
                $arrTransHist = array();
                $arrTransMainHist = array();
                foreach ($tmpHist as $row) {
                    $arrTransID[] = $row->id;
                    $arrTransTopID[] = $row->id_top;

                    if ($row->ids_his != "") {
                        $hist = blobDecode($row->ids_his);
                        foreach ($hist as $hisSpec) {
                            $arrIdsHist[$row->id][$hisSpec['step']] = array(
                                "step" => $hisSpec['step'],
                                "trID" => $hisSpec['trID'],
                                "nomer" => $hisSpec['nomer'],
                            );
                            $arrTransHist[] = $hisSpec['trID'];
                        }
                    }
                }

                $tmpReg_result = array();
                $trReg = new MdlTransaksi();
                $trReg->setFilters(array());
                //                $trReg->addFilter("param='main'");
                //                $trReg->addFilter("param='items'");
                //                $trReg->addFilter("param in ('main','items')");
                $trReg->addFilter("transaksi_id in ('" . implode("','", $arrTransID) . "')");
                $this->db->where("param in ('main','items')");
                $tmpReg = $trReg->lookupRegistries()->result();
                //                cekHere($this->db->last_query());
                if (sizeof($tmpReg) > 0) {
                    foreach ($tmpReg as $regRow) {
                        $param = $regRow->param;
                        $tmpReg_result[$regRow->transaksi_id][$param] = blobDecode($regRow->values);


                    }
                }
                //                arrPrint($tmpReg_result);


                $tr = new MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("id in ('" . implode("','", $arrTransTopID) . "')");
                $tmpTrTop = $tr->lookupAll()->result();
                if (sizeof($tmpTrTop) > 0) {
                    foreach ($tmpTrTop as $topSpec) {
                        $arrSalesName[$topSpec->id_top] = $topSpec->oleh_nama;
                    }
                }

                //arrPrint($arrTransHist);
                //mati_disini();
                if (sizeof($arrIdsHist) > 0) {
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("id in ('" . implode("','", $arrTransHist) . "')");
                    $tmpTransHist = $tr->lookupAll()->result();


                    if (sizeof($tmpTransHist) > 0) {
                        foreach ($tmpTransHist as $histSpec) {
                            $tmpTransHist_result[$histSpec->id] = array(
                                "oleh_id" => $histSpec->oleh_id,
                                "oleh_nama" => $histSpec->oleh_nama,
                            );
                        }
                    }
                    //                    mati_disini();
                    foreach ($arrIdsHist as $trID => $histSpec) {
                        foreach ($histSpec as $step => $detailSpec) {
                            if (array_key_exists($detailSpec['trID'], $tmpTransHist_result)) {
                                $detailSpec['main'] = $tmpTransHist_result[$detailSpec['trID']];
                            }
                            $arrTransMainHist[$trID][$step] = $detailSpec;
                        }
                    }
                }

            }
            $numb = $limit;
            foreach ($tmpHist as $ii => $row) {
                $id_hist = blobDecode($row->ids_his);
                $tNomer_top = $row->nomer_top;
                $salesName = isset($arrSalesName[$row->id_top]) ? $arrSalesName[$row->id_top] : "-";
                $tNomer = $row->nomer;
                $jenisTrtop = explode(".", $tNomer_top)[0];
                $jenisTrsub = explode(".", $tNomer)[0];
                $counterjenis = "$jenisTrsub|" . $this->placeId;
                $counterIds_his = blobDecode(blobDecode($row->ids_his)[1]['counters']);
                $counters = blobDecode($row->counters);
                $counterGlobal = $counters['stepCode|placeID'][$counterjenis];
                $counterIds_his_global = isset($counterIds_his['stepCode|placeID']["$jenisTrtop|$cabang_id"]) ? $counterIds_his['stepCode|placeID']["$jenisTrtop|$cabang_id"] : "";
                $cGlobals = digit_5($counterGlobal);
                $cGlobal_spo = digit_5($counterIds_his_global);
                //endregion

                if (sizeof($pairRegistries) > 0) {
                    if ((sizeof($tmpReg_result) > 0) && (isset($tmpReg_result[$row->id]))) {
                        foreach ($tmpReg_result[$row->id] as $param => $eReg) {
                            if ($param == "main") {
                                foreach ($eReg as $k => $v) {
                                    if (!isset($row->$k)) {
                                        $row->$k = $v;
                                    }
                                }
                            }
                            else {
                                if (sizeof($extHistoryFields2) > 0) {
                                    foreach ($extHistoryFields2 as $k1 => $v1) {
                                        if (!isset($row->$k1)) {
                                            $tmpDetail = "";
                                            foreach ($eReg as $eeReg) {
                                                $valDetail = formatField("nomer", $eeReg[$v1]);
                                                $tmpDetail .= "<span>$valDetail</span><br>";
                                            }
                                            $row->$k1 = $tmpDetail;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (sizeof($pairTransaksi) > 0) {
                        if ($row->referenceID > 0) {
                            $trPair = new MdlTransaksi();
                            $trPair->addFilter("id='" . $row->referenceID . "'");
                            $trPairTmp = $trPair->lookupMainTransaksi()->result();
                            if (sizeof($trPairTmp) > 0) {
                                $hisTr = isset($trPairTmp[0]->ids_his) ? blobDecode($trPairTmp[0]->ids_his) : array();
                                foreach ($hisTr as $step => $hisTrSpec) {
                                    foreach ($pairTransaksi['kolom'] as $keyPair => $labelPair) {
                                        $keyPairs = $keyPair . "_" . $step;
                                        $row->$keyPairs = isset($hisTrSpec[$labelPair]) ? $hisTrSpec[$labelPair] : "--";
                                    }
                                }
                            }
                        }
                    }
                }

                if (sizeof($historyFieldsExt) > 0) {
                    foreach ($historyFieldsExt as $alias => $colom) {
                        $row->$alias = $row->$colom;
                    }
                }
                $tmp = array();
                $tmp1 = array();
                $numb++;
                foreach ($historyFields as $fName => $fLabel) {
                    if (strpos($fName, '+') !== false) {//==mengandung penggabungan (+)
                        $chars = explode("+", $fName);
                        $colValue = "";
                        foreach ($chars as $key) {
                            if (is_numeric($row->$key)) {
                                if (!isset($sumValue[$key])) {
                                    $sumValue[$key] = 0;
                                }
                                $sumValue[$key] += $row->$key;
                            }
                            $colValue .= isset($row->$key) ? formatField($key, $row->$key) . "<br>" : "";
                        }
                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {

                        if (is_numeric(isset($row->$fName) ? $row->$fName : "")) {
                            if (!isset($sumValue[$fName])) {
                                $sumValue[$fName] = 0;
                            }
                            $sumValue[$fName] += $row->$fName;
                        }
                        if ($fName == "nomer") {
                            switch ($jenisTrsub) {
                                case "582s":
                                    $kolomValues = $row->$fName . "&#x2011;$cGlobals";
                                    break;
                                default:
                                    $kolomValue_0s = formatField($fName, $row->$fName);
                                    $kolomValues = str_replace("</span>", "&#x2011;" . $cGlobals, $kolomValue_0s);
                                    break;
                            }
                        }
                        elseif ($fName == "nomer_top") {
                            $kolomValue_0s = formatField($fName, $row->$fName);
                            $kolomValues = str_replace("</span>", "&#x2011;" . $cGlobal_spo, $kolomValue_0s);
                        }
                        else {
                            $kolomValues = isset($row->$fName) ? formatField($fName, $row->$fName) : "-";
                        }
                        $colValue = isset($row->$fName) ? $kolomValues : "";
                    }

                    if (is_array($fLabel)) {
                        $hisStep = $fLabel['step'];
                        $hisKey = $fLabel['key'];
                        $tNomer = $id_hist[$hisStep][$hisKey];

                        $colValue = isset($row->ids_his) ? showHistoriGlobalNumbers($row->ids_his, $hisStep, true) : "";

                        $logistic = "";
                        if (isset($arrTransMainHist[$row->id][$hisStep]['main'])) {
                            $main = $arrTransMainHist[$row->id][$hisStep]['main'];
                            $logistic = $main['oleh_nama'];
                        }
                    }


                    if ($fName == "no") {
                        $colValue = formatField($fName, $numb);
                    }

                    $tmp['logistic'] = isset($logistic) && $logistic != null ? $logistic : 'undefined';
                    $tmp['sales_name'] = $salesName;

                    //                    $tmp['jenis_label'] = "jenis_label di isi apaan ya";
                    //                    $tmp['nomer_po'] = "nomer_po di isi apaan ya";
                    //                    $tmp['nomer_ppn'] = "nomer_ppn di isi apaan ya";
                    //                    $tmp['harga'] = "nomer_ppn di isi apaan ya";
                    //                    $tmp['disc'] = "disc di isi apaan ya";
                    //                    $tmp['nett'] = "nett di isi apaan ya";

                    $tmp[$fName] = $colValue;
                    $tmp1["id"] = $row->id;
                }


                if (sizeof($arrCurrency) > 0) {
                    $valas = "";
                    $valas .= "<div class='btn-group'>";
                    $valas .= "<button type='button' class='btn btn-primary dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>";
                    $valas .= "<i class='fa fa-print'></i>";
                    $valas .= "<span class='caret'></span>";
                    $valas .= "</button>";

                    $valas .= "<ul style='background:#cde8ff;' class='dropdown-menu dropdown-menu-right'>";
                    foreach ($arrCurrency as $arrV) {
                        $nama = $arrV->nama;
                        $nomer = $row->nomer;
                        $nilai = number_format($arrV->exchange, 0);
                        $valas .= " <li class='text-bold'><a class='dropdown-item' href='javascript:void(0);' onclick='top.popBig(\'" . base_url() . "Transaksi/viewReceipt/$nomer?type=" . blobEncode($nama) . "&f=" . blobEncode($arrV->exchange) . "\')'> <i class='fa fa-print'></i> in $nama - ($nilai) </a></li>";
                    }

                    $valas .= "<li><a class='btn btn-xs btn-warning' href='javascript:void(0);' onclick='top.location.href=\'" . base_url() . "data/view/Currency\''> <i class='fa fa-plus'></i> tambah currency </a></li>";
                    $valas .= "</ul>";
                    $valas .= "</div>";
                    //                    $tmp["print_nvalas"] = base64_encode($valas);
                    $tmp["print_nvalas"] = $valas;
                }

                $tmp['next_pic'] = "-";

                // menambah background-color karena dicancel/reject/undo, atau yang dibatalkan
                $tmp['keterangan'] = "-";
                if (isset($row->trash_4) && ($row->trash_4 == 1)) {
                    $tmp['keterangan'] = "CANCELED";
                    $arrayHistory_canceled[$ii] = array(
                        "bgcolor" => "background-color:red;color:#cccccc;",
                    );
                }

                $arrayHistory[$ii] = $tmp;
                $arrayHistory_ids[$ii] = $tmp1;


            }
        }
        //endregion

        //        arrPrint($arrayHistory);

        //region link to add new transaction
        if (placeCanMakeTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr)) {
            //        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['userGroup'], $this->session->login['membership'])) {
            $createIndexes = (null != $this->config->item("transaksi_createIndex")) ? $this->config->item("transaksi_createIndex") : array();
            if (array_key_exists($this->jenisTr, $createIndexes)) {
                $targetUrl = base_url() . $createIndexes[$this->jenisTr] . "/" . $this->jenisTr;
            }
            else {
                $targetUrl = base_url() . "Transaksi/createForm/" . $this->jenisTr;
            }
            $addLink = array(
                "link" => $targetUrl,
                "label" => "<span class='glyphicon glyphicon-plus'></span> create new " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            );
        }
        else {
            $addLink = null;
        }
        //endregion

        //region prepare params for viewer
        //        $data = array(
        //            "mode" => $this->uri->segment(2),
        //            "isMobile" => $isMob,
        //            "jenisTr" => $jenisTr,
        //            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
        //            "errMsg" => $this->session->errMsg,
        //            "title" => isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName,
        //            "subTitle" => "histories",
        //            "customButton" => $customButton,
        //            "customButtonTarget" => isset($currentState) ? "$currentState?date1=$date1&date2=$date2" : "",
        //            "arrayHistoryLabels" => $historyFields,
        //            "arrayHistory" => $arrayHistory,
        //            "arrayHistorySumField" => $sumValue,
        //            "arrayHistoryId" => $arrayHistory_ids,
        //            "action" => $action,
        //            "steps" => $steps,
        //            "stepLabels" => $stepLabels,
        //            "stepLinks" => $stepLinks,
        //            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
        //            "currentState" => isset($currentState) ? $currentState : "all states",
        //            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
        //            "alternateLinkCaption" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " <span class='glyphicon glyphicon-arrow-right'></span>",
        //            "addLink" => $addLink,
        //            "filters" => array(
        //                "dates" => $this->dates,
        //                "date1" => $date1,
        //                "date2" => $date2,
        //            ),
        //            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),
        //            "history_canceled" => isset($arrayHistory_canceled) ? $arrayHistory_canceled : array(),
        //        );
        //endregion

        $output = array(
            "draw" => $_GET['draw'],
            "recordsTotal" => intval($jmlData),
            "recordsFiltered" => intval($jmlFiltered),
            "data" => $arrayHistory,
        );
        //output to json format
        echo json_encode($output);

    }

    // ============================================================
    public function viewStatus()
    {
        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        $limit = 20;
        $maxPageNum = 20;
        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields'] : array();
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $pairStepCode = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'] : array();
        $addMainStep = isset($this->config->item("heTransaksi_ui")[$jenisTr]['addMainStep']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['addMainStep'] : array();
        $regulerRoutesConfig = $this->config->item("heTransaksi_regulerRoutes") != NULL ? $this->config->item("heTransaksi_regulerRoutes") : array();
        $sourceInternalConnectConfig = $this->config->item("heTransaksi_source_internal_connect") != NULL ? $this->config->item("heTransaksi_source_internal_connect") : array();
        $sourceCenterConnectConfig = $this->config->item("heTransaksi_center_connect") != NULL ? $this->config->item("heTransaksi_center_connect") : array();


        $jenisTrConnect = heGetOriginConnectTCode($jenisTr);
        $jenisTrOriginConnect = heGetOriginTCode($jenisTr);
        $arrJenisTrMain = array($jenisTr);
        // ini mencari target koneknya
        if ($jenisTrConnect != NULL) {
            $arrJenisTrMain[] = $jenisTrConnect;
        }
        // ini mencari sumber koneknya
        if ($jenisTrOriginConnect != NULL) {
            if (!in_array($jenisTrOriginConnect, $sourceInternalConnectConfig)) {
                $arrJenisTrMain[] = $jenisTrOriginConnect;
            }
        }


        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }


        $backdate_f = formatTanggal(backDate(30), 'Y-m-d');
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : $backdate_f;
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $tmpCode = array();
        if (sizeof($pairStepCode) > 0) {
            foreach ($pairStepCode as $t => $tSpec) {
                $tmpCode[$t] = $tSpec['target'];
            }
        }
        if (sizeof($addMainStep) > 0) {
            foreach ($addMainStep as $t => $tSpec) {
                $tmpCode[$t] = $tSpec['target'];
            }
        }

        //region preparing ERP step labels for top link
        //        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        //        $stepLabels = array();
        //        $stepLinks = array();
        //        if (sizeof($steps) > 1) {
        //            $subCodes = array();
        //            $stepCodes = array();
        //            $jmlStep = count($steps);
        //
        //            foreach ($steps as $stepNumber => $stepSpec) {
        //                if ($stepNumber <= $jmlStep) {
        //                    $subCodes[$stepSpec['target']] = $stepSpec['label'];
        //                    $stepCodes[] = $stepSpec['target'];
        //                    //                    $stepLabels[$stepNumber] = $stepSpec['stateLabel'];
        //                    $stepLabels[$stepNumber] = $stepSpec['label'];
        //                    $stepLinks[$stepNumber] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $stepSpec['target'] . "?date1=$date1&date2=$date2";
        //                }
        //
        //            }
        //
        //            $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['target'];
        //        }
        //endregion

        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComJurnal_activityMain");


        //region lookup histories
        $tr = new MdlTransaksi();
        $searchStr = isset($_GET['search']) ? $_GET['search'] : "";


        // kolom yang diambil dari tabel transaksi...
        $arrKolomTr = array(
            "id",
            "dtime",
            "nomer_top",
            "nomer",
            "jenis",
            "jenis_master",
            "jenis_top",
            "jenis_label",
            "oleh_id",
            "oleh_nama",
            "customers_id",
            "customers_nama",
            "suppliers_id",
            "suppliers_nama",
            "cabang_id",
            "cabang_nama",
            "cabang2_id",
            "cabang2_nama",
        );
        $arrJurnalStep = array();
        if (sizeof($regulerRoutesConfig) > 0) {
            foreach ($regulerRoutesConfig as $jenisMaster => $jSpec) {
                foreach ($jSpec as $step => $sSpec) {
                    $arrJurnalStep[$jenisMaster][$step] = $sSpec["debet"];
                }
            }
        }


        $cj = New ComJurnal_activityMain();
        $cj->setFilters(array());
        if ($this->session->login['cabang_id'] == CB_ID_PUSAT) {
        }
        else {
            $cabang_id = $this->session->login['cabang_id'];
            $cabang_pusat = CB_ID_PUSAT;
            //            cekPink("origin konek $jenisTrOriginConnect");
            //            arrPrint($sourceCenterConnectConfig);
            if (in_array($jenisTrOriginConnect, $sourceCenterConnectConfig)) {
                //                cekPink("transaksi yang ada koneksi dengan PUSAT");
                $where = "((cabang_id='$cabang_id' AND cabang2_id='$cabang_pusat') OR (cabang_id='$cabang_pusat' AND cabang2_id='$cabang_id'))";
            }
            elseif (in_array($jenisTr, $sourceCenterConnectConfig)) {
                //                cekPink("transaksi yang ada koneksi dengan PUSAT");
                $where = "((cabang_id='$cabang_id' AND cabang2_id='$cabang_pusat') OR (cabang_id='$cabang_pusat' AND cabang2_id='$cabang_id'))";
            }
            else {
                //                cekPink("transaksi yang TIDAK ada koneksi dengan PUSAT");
                $where = "((cabang_id='$cabang_id' AND cabang2_id='$cabang_id') OR (cabang_id='$cabang_id' AND cabang2_id='$cabang_id'))";
            }

            $this->db->where($where);
        }

        if (!isset($_GET['date1']) && !isset($_GET['date2'])) {

            $subTitle_date = "";
            $subSubTitle_date = "";
        }
        else {
            $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-01");
            $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");

            $this->db->where("fulldate>='" . $date1 . "'");
            $this->db->where("fulldate<='" . $date2 . "'");

            $subTitle_date = lgTranslateTime($date1) . " - " . lgTranslateTime($date2);
            $subSubTitle_date = "";
        }

        //        arrprint($arrJenisTrMain);
        $cj->addFilter("jenis_master in ('" . implode("','", $arrJenisTrMain) . "')");
        $tmp = $cj->lookupAll()->result();
        //        showLast_query("biru");
        //        cekHitam(sizeof($tmp));

        $tmpHistory = array();
        $tmpHistory_0 = array();
        $tmpHistory_waiting = array();
        $tmpHistory_activity = array();
        $tmpHistory_activityData = array();
        $trIDs = array();
        if (sizeof($tmp) > 0) {
            foreach ($tmp as $tmpSpec) {


                $tmpHistory_0[$tmpSpec->master_id][] = $tmpSpec;
                $tmpHistory_activity[$tmpSpec->master_id][] = $tmpSpec->activity;
                $tmpHistory_activityData[$tmpSpec->master_id][$tmpSpec->activity] = array(
                    "activity" => $tmpSpec->activity,
                    "master_id" => $tmpSpec->master_id,
                    "transaksi_no" => isset($tmpSpec->transaksi_no) ? $tmpSpec->transaksi_no : "",
                    "dtime" => $tmpSpec->dtime,
                    "fulldate" => $tmpSpec->fulldate,
                    "oleh_nama" => isset($tmpSpec->oleh_nama) ? $tmpSpec->oleh_nama : "",
                );

                $trIDs[$tmpSpec->master_id] = $tmpSpec->master_id;
                if ($tmpSpec->kredit > 0) {
                    if ($tmpSpec->activity != "request") {

                        $tmpHistory_waiting[$tmpSpec->master_id][] = $tmpSpec->activity;
                    }
                }
            }


            // pair dengan transaksi
            $tr = New MdlTransaksi();
            $tr->addFilter("id in ('" . implode("','", $trIDs) . "')");
            $tmpTr = $tr->lookupAll()->result();
            //            showLast_query("kuning");
            foreach ($tmpTr as $trSpec) {
                foreach ($arrKolomTr as $key) {
                    $subTr[$key] = isset($trSpec->$key) ? $trSpec->$key : "";
                }
                $tmpHistory[$trSpec->id] = (object)$subTr;
            }

            // pair dengan registry main
            $treg = New MdlTransaksi();
            $treg->setFilters(array());
            $treg->addFilter("trash='0'");
            $treg->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
            $treg->addFilter("param='main'");
            $tmpReg = $treg->lookupRegistries()->result();
            $pairRegistriesResult = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $regRow) {
                    $param = $regRow->param;
                    $pairRegistriesResult[$regRow->transaksi_id] = blobDecode($regRow->values);
                }
            }
        }


        $tmpHist = $tmpHistory;
        $arrayHistory = array();
        $arrayHistory_ids = array();
        $arrayHistory_topID = array();
        $arrayHistoryCanceled = array();
        $arrayHistoryDone = array();
        $arrayHistoryStatus = array();
        if (sizeof($tmpHist) > 0) {
            krsort($tmpHist);
            foreach ($tmpHist as $row) {
                if ($pairRegistriesResult[$row->id]) {
                    foreach ($pairRegistriesResult[$row->id] as $k => $v) {
                        if (!isset($row->$k)) {
                            $row->$k = $v;
                        }
                    }
                }

                $tmp = array();
                foreach ($historyFields as $fName => $fLabel) {
                    if (strpos($fName, '+') !== false) {
                        //==mengandung penggabungan (+)
                        $chars = explode("+", $fName);
                        $colValue = "";
                        foreach ($chars as $key) {
                            $colValue .= isset($row->$key) ? formatField($key, $row->$key) . "<br>" : "";
                        }
                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {
                        $colValue = isset($row->$fName) ? formatField($fName, $row->$fName) : "";
                    }
                    $tmp[$fName] = $colValue;
                    //                    $tmp1["id"] = $row->id;
                }

                $disabled = "";
                $arrActivity = array();
                $arrWaiting = array();

                if (isset($tmpHistory_activity[$row->id])) {
                    $arrActivity = $tmpHistory_activity[$row->id];
                }
                if (isset($tmpHistory_waiting[$row->id])) {
                    $arrWaiting = $tmpHistory_waiting[$row->id];
                }


                $status_next = "";
                if (isset($arrJurnalStep[$row->jenis_master])) {
                    foreach ($arrJurnalStep[$row->jenis_master] as $number => $value) {
                        $value_add = "";
                        $onclick = "";

                        if (in_array($value, $arrActivity)) {
                            if (in_array($value, $arrWaiting)) {
                                $disabled = "";
                                $class = "btn-warning";
                            }
                            else {

                                $dtime = $tmpHistory_activityData[$row->id][$value]['dtime'];
                                $oleh_nama = $tmpHistory_activityData[$row->id][$value]['oleh_nama'];
                                $transaksi_no = $tmpHistory_activityData[$row->id][$value]['transaksi_no'];
                                $transaksi_no_f = formatNota("nomer", $transaksi_no);

                                $disabled = "";
                                $class = "btn-success";
                                $value_add = " (by $oleh_nama, $transaksi_no_f, $dtime)";
                                $onclick = "onclick=\"showModal('" . base_url() . "Transaksi/viewResume/$transaksi_no','view resume for $transaksi_no_f')\"";
                            }
                        }
                        else {
                            $disabled = "";
                            $class = "btn-default";
                        }

                        $value_add = "";
                        if ($status_next == "") {
                            $status_next = "<input type='button' class='btn btn-sm $class' $disabled value='$value $value_add'
                                    $onclick
                                    >";
                            $status_next .= "<br>";
                        }
                        else {
                            $status_next = $status_next;
                            $status_next .= "<input type='button' class='btn btn-sm $class' $disabled value='$value $value_add'
                                    $onclick
                                    >";
                            $status_next .= "<br>";
                        }
                    }
                }
                $tmp['status_next'] = $status_next;


                $arrayHistory[$row->id] = $tmp;
                $arrayHistoryStatus[$row->id] = str_replace("<br>", "&nbsp;", $status_next);


            }

        }
        //endregion


        //region prepare params for viewer
        $trName = isset($this->config->item("heTransaksi_ui")[$jenisTr]["label"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["label"] : "";
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "jenisTr" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "errMsg" => $this->session->errMsg,
            "title" => isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName,
            "subTitle" => "transaction status ",
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory,
            "arrayHistoryId" => $arrayHistory_ids,
            "arrayHistoryCanceled" => $arrayHistoryCanceled,
            "action" => isset($action) && sizeof($action) > 0 ? $action : array(),
            "steps" => isset($steps) && sizeof($steps) > 0 ? $steps : array(),
            "stepLabels" => isset($stepLabels) && sizeof($stepLabels) > 0 ? $stepLabels : array(),
            "stepLinks" => isset($stepLinks) && sizeof($stepLinks) > 0 ? $stepLinks : array(),
            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
            "currentState" => isset($currentState) ? $currentState : "all states",
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
            "alternateLinkCaption" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " <span class='glyphicon glyphicon-arrow-right'></span>",
            "addLink" => isset($addLink) ? $addLink : "",
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),
            "arrayHistoryStatus" => $arrayHistoryStatus,
            "customStatusLayout" => true,
            //            "customStatusLayout" => false,
        );
        //endregion


        $this->load->view("history", $data);
    }

    public function viewStatusGlobal()
    {
        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        $limit = 20;
        $maxPageNum = 20;
        $jenisTr = ($this->uri->segment(3) != NULL) ? $this->uri->segment(3) : NULL;
        $cCode = "_TR_" . $this->jenisTr;


        $historyFieldsDefault = ($this->config->item("heTransaksi_headerStatus_fields") != NULL) ? $this->config->item("heTransaksi_headerStatus_fields") : array();
        $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields'] : $historyFieldsDefault;

        //        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $pairStepCode = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'] : array();
        $addMainStep = isset($this->config->item("heTransaksi_ui")[$jenisTr]['addMainStep']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['addMainStep'] : array();
        $regulerRoutesConfig = $this->config->item("heTransaksi_regulerRoutes") != NULL ? $this->config->item("heTransaksi_regulerRoutes") : array();


        $jenisTrConnect = heGetOriginConnectTCode($jenisTr);
        $jenisTrOriginConnect = heGetOriginTCode($jenisTr);
        $arrJenisTrMain = $jenisTr != NULL ? array($jenisTr) : array();
        // ini mencari target koneknya
        if ($jenisTrConnect != NULL) {
            $arrJenisTrMain[] = $jenisTrConnect;
        }
        // ini mencari sumber koneknya
        if ($jenisTrOriginConnect != NULL) {
            $arrJenisTrMain[] = $jenisTrOriginConnect;
        }


        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['shortStatusFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }


        $backdate_f = formatTanggal(backDate(30), 'Y-m-d');
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : $backdate_f;
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $tmpCode = array();
        if (sizeof($pairStepCode) > 0) {
            foreach ($pairStepCode as $t => $tSpec) {
                $tmpCode[$t] = $tSpec['target'];
            }
        }
        if (sizeof($addMainStep) > 0) {
            foreach ($addMainStep as $t => $tSpec) {
                $tmpCode[$t] = $tSpec['target'];
            }
        }


        //region preparing ERP step labels for top link
        $steps = $this->config->item("heTransaksi_regulerRoutes") != NULL ? ($this->config->item("heTransaksi_regulerRoutes")) : array();
        $stepLabels = array();
        $stepLinks = array();

        $stepLabels[0] = "All Transaction";
        $stepLinks[0] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/?date1=$date1&date2=$date2";

        if (sizeof($steps) > 1) {
            $subCodes = array();
            $stepCodes = array();
            $jmlStep = count($steps);
            foreach ($steps as $jenisTr_key => $spec_val) {
                //                if ($stepNumber <= $jmlStep) {
                //                    $subCodes[$stepSpec['target']] = $stepSpec['label'];
                $stepCodes[] = $jenisTr_key;
                $stepLabels[$jenisTr_key] = isset($this->config->item("heTransaksi_ui")[$jenisTr_key]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr_key]['label'] : "";
                $stepLinks[$jenisTr_key] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $jenisTr_key . "?date1=$date1&date2=$date2";
                //                }
            }

            $currentState = strlen($this->uri->segment(3)) > 0 ? $this->uri->segment(3) : 0;
        }
        //endregion


        $this->load->model("MdlTransaksi");
        $this->load->model("Coms/ComJurnal_activityMain");


        //region lookup histories
        $tr = new MdlTransaksi();
        $searchStr = isset($_GET['search']) ? $_GET['search'] : "";


        // kolom yang diambil dari tabel transaksi...
        $arrKolomTr = array(
            "id",
            "dtime",
            "nomer_top",
            "nomer",
            "jenis",
            "jenis_master",
            "jenis_top",
            "jenis_label",
            "oleh_id",
            "oleh_nama",
            "customers_id",
            "customers_nama",
            "suppliers_id",
            "suppliers_nama",
            "cabang_id",
            "cabang_nama",
            "cabang2_id",
            "cabang2_nama",
        );
        $arrJurnalStep = array();
        if (sizeof($regulerRoutesConfig) > 0) {
            foreach ($regulerRoutesConfig as $jenisMaster => $jSpec) {
                foreach ($jSpec as $step => $sSpec) {
                    $arrJurnalStep[$jenisMaster][$step] = $sSpec["debet"];
                }
            }
        }
        //arrPrint($arrJurnalStep);

        $cj = New ComJurnal_activityMain();
        $cj->setFilters(array());
        if ($this->session->login['cabang_id'] == CB_ID_PUSAT) {
        }
        else {
            $cabang_id = $this->session->login['cabang_id'];
            $cabang_pusat = CB_ID_PUSAT;
            $where = "(cabang_id='$cabang_id' AND cabang2_id='$cabang_pusat') OR (cabang_id='$cabang_pusat' AND cabang2_id='$cabang_id')";
            $this->db->where($where);
        }

        if (!isset($_GET['date1']) && !isset($_GET['date2'])) {

            $subTitle_date = "";
            $subSubTitle_date = "";
        }
        else {
            $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-01");
            $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");

            $this->db->where("fulldate>='" . $date1 . "'");
            $this->db->where("fulldate<='" . $date2 . "'");

            $subTitle_date = lgTranslateTime($date1) . " - " . lgTranslateTime($date2);
            $subSubTitle_date = "";
        }

        if (sizeof($arrJenisTrMain) > 0) {
            $cj->addFilter("jenis_master in ('" . implode("','", $arrJenisTrMain) . "')");
        }
        $tmp = $cj->lookupAll()->result();
        //        showLast_query("biru");

        $tmpHistory = array();
        $tmpHistory_0 = array();
        $tmpHistory_waiting = array();
        $tmpHistory_activity = array();
        $tmpHistory_activityData = array();
        $trIDs = array();
        if (sizeof($tmp) > 0) {
            foreach ($tmp as $tmpSpec) {


                $tmpHistory_0[$tmpSpec->master_id][] = $tmpSpec;
                $tmpHistory_activity[$tmpSpec->master_id][] = $tmpSpec->activity;
                $tmpHistory_activityData[$tmpSpec->master_id][$tmpSpec->activity] = array(
                    "activity" => $tmpSpec->activity,
                    "master_id" => $tmpSpec->master_id,
                    "transaksi_no" => isset($tmpSpec->transaksi_no) ? $tmpSpec->transaksi_no : "",
                    "dtime" => $tmpSpec->dtime,
                    "fulldate" => $tmpSpec->fulldate,
                    "oleh_nama" => isset($tmpSpec->oleh_nama) ? $tmpSpec->oleh_nama : "",
                );

                $trIDs[$tmpSpec->master_id] = $tmpSpec->master_id;
                if ($tmpSpec->kredit > 0) {
                    if ($tmpSpec->activity != "request") {

                        $tmpHistory_waiting[$tmpSpec->master_id][] = $tmpSpec->activity;
                    }
                }
            }


            // pair dengan transaksi
            $tr = New MdlTransaksi();
            $tr->addFilter("id in ('" . implode("','", $trIDs) . "')");
            $tmpTr = $tr->lookupAll()->result();
            foreach ($tmpTr as $trSpec) {
                foreach ($arrKolomTr as $key) {
                    $subTr[$key] = isset($trSpec->$key) ? $trSpec->$key : "";
                }
                $tmpHistory[$trSpec->id] = (object)$subTr;
            }

            // pair dengan registry main
            $treg = New MdlTransaksi();
            $treg->setFilters(array());
            $treg->addFilter("trash='0'");
            $treg->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
            $treg->addFilter("param='main'");
            $tmpReg = $treg->lookupRegistries()->result();
            $pairRegistriesResult = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $regRow) {
                    $param = $regRow->param;
                    $pairRegistriesResult[$regRow->transaksi_id] = blobDecode($regRow->values);
                }
            }
        }


        $tmpHist = $tmpHistory;
        $arrayHistory = array();
        $arrayHistory_ids = array();
        $arrayHistory_topID = array();
        $arrayHistoryCanceled = array();
        $arrayHistoryDone = array();
        $arrayHistoryStatus = array();
        if (sizeof($tmpHist) > 0) {
            foreach ($tmpHist as $row) {
                if ($pairRegistriesResult[$row->id]) {
                    foreach ($pairRegistriesResult[$row->id] as $k => $v) {
                        if (!isset($row->$k)) {
                            $row->$k = $v;
                        }
                    }
                }

                $tmp = array();
                foreach ($historyFields as $fName => $fLabel) {
                    if (strpos($fName, '+') !== false) {
                        //==mengandung penggabungan (+)
                        $chars = explode("+", $fName);
                        $colValue = "";
                        foreach ($chars as $key) {
                            $colValue .= isset($row->$key) ? formatField($key, $row->$key) . "<br>" : "";
                        }
                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {
                        $colValue = isset($row->$fName) ? formatField($fName, $row->$fName) : "";
                    }
                    $tmp[$fName] = $colValue;
                    //                    $tmp1["id"] = $row->id;
                }

                $disabled = "";
                $arrActivity = array();
                $arrWaiting = array();

                if (isset($tmpHistory_activity[$row->id])) {
                    $arrActivity = $tmpHistory_activity[$row->id];
                }
                if (isset($tmpHistory_waiting[$row->id])) {
                    $arrWaiting = $tmpHistory_waiting[$row->id];
                }


                $status_next = "";
                if (isset($arrJurnalStep[$row->jenis_master])) {
                    foreach ($arrJurnalStep[$row->jenis_master] as $number => $value) {
                        $value_add = "";
                        $onclick = "";

                        if (in_array($value, $arrActivity)) {
                            if (in_array($value, $arrWaiting)) {
                                $disabled = "";
                                $class = "btn-warning";
                            }
                            else {

                                $dtime = $tmpHistory_activityData[$row->id][$value]['dtime'];
                                $oleh_nama = $tmpHistory_activityData[$row->id][$value]['oleh_nama'];
                                $transaksi_no = $tmpHistory_activityData[$row->id][$value]['transaksi_no'];
                                $transaksi_no_f = formatNota("nomer", $transaksi_no);

                                $disabled = "";
                                $class = "btn-success";
                                $value_add = " (by $oleh_nama, $transaksi_no_f, $dtime)";
                                $onclick = "onclick=\"showModal('" . base_url() . "Transaksi/viewResume/$transaksi_no','view resume for $transaksi_no_f')\"";
                            }
                        }
                        else {
                            $disabled = "";
                            $class = "btn-default";
                        }

                        $value_add = "";
                        if ($status_next == "") {
                            $status_next = "<input type='button' class='btn btn-sm $class' $disabled value='$value $value_add'
                                    $onclick
                                    >";
                            $status_next .= "<br>";
                        }
                        else {
                            $status_next = $status_next;
                            $status_next .= "<input type='button' class='btn btn-sm $class' $disabled value='$value $value_add'
                                    $onclick
                                    >";
                            $status_next .= "<br>";
                        }
                    }
                }
                $tmp['status_next'] = $status_next;


                $arrayHistory[$row->id] = $tmp;
                $arrayHistoryStatus[$row->id] = str_replace("<br>", "&nbsp;", $status_next);


            }

        }
        //endregion


        //region prepare params for viewer
        $trName = isset($this->config->item("heTransaksi_ui")[$jenisTr]["label"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["label"] : "";
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "jenisTr" => $jenisTr,
            "trName" => $trName,
            "errMsg" => $this->session->errMsg,
            //            "title" => isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName,
            "title" => "$trName &nbsp;",
            "subTitle" => "transaction status ",
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory,
            "arrayHistoryId" => $arrayHistory_ids,
            "arrayHistoryCanceled" => $arrayHistoryCanceled,
            "action" => isset($action) && sizeof($action) > 0 ? $action : array(),
            "steps" => isset($steps) && sizeof($steps) > 0 ? $steps : array(),
            "stepLabels" => isset($stepLabels) && sizeof($stepLabels) > 0 ? $stepLabels : array(),
            "stepLinks" => isset($stepLinks) && sizeof($stepLinks) > 0 ? $stepLinks : array(),
            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
            "currentState" => isset($currentState) ? $currentState : "all states",
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
            "alternateLinkCaption" => "incomplete " . $trName . " <span class='glyphicon glyphicon-arrow-right'></span>",
            "addLink" => isset($addLink) ? $addLink : "",
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),
            "arrayHistoryStatus" => $arrayHistoryStatus,
            "customStatusLayout" => true,
            //            "customStatusLayout" => false,
        );
        //endregion


        $this->load->view("history", $data);
    }

    // ============================================================

    public function viewMyActs()
    {

        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }

        $uID = isset($_GET['u']) && $_GET['u'] > 0 ? $_GET['u'] : $this->session->login['id'];
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        $limit = 18;
        $maxPageNum = 20;
        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        //        $historyFields = $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $historyFields = isset($this->config->item("heTransaksi_report")[$jenisTr]['longHistoryFields']) ? $this->config->item("heTransaksi_report")[$jenisTr]['longHistoryFields'] : array(
            "produk_nama" => "item name",
            "produk_ord_jml" => "qty",
            "produk_ord_hrg" => "@price",

            "nomer_top+nomer" => "receipt number",
            "oleh_nama+dtime" => "person",
        );
        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }

        //        arrprint($historyFields);
        //
        //region preparing ERP step labels for top link
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        $stepLabels = array(//            "0" => "all"
        );
        $stepLinks = array(//            "0" => base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3)
        );
        if (sizeof($steps) > 1) {
            $subCodes = array();
            $stepCodes = array();
            $jmlStep = count($steps);

            foreach ($steps as $stepNumber => $stepSpec) {
                if ($stepNumber <= $jmlStep) {
                    $subCodes[$stepSpec['target']] = $stepSpec['label'];
                    $stepCodes[] = $stepSpec['target'];
                    //                    $stepLabels[$stepNumber] = $stepSpec['stateLabel'];
                    $stepLabels[$stepNumber] = $stepSpec['label'];
                    $stepLinks[$stepNumber] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $stepSpec['target'];
                }

            }


            //            $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->jenisTr;
            $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][1]['target'];
        }
        //endregion

        //
        //region lookup histories


        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();

        $identifiers = $tr->fetchIdentifiers();
        $recaps = array();
        $names = array();

        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("gudang_id='" . $this->session->login['gudang_id'] . "'");
        $tr->addFilter("jenis_master='" . $this->jenisTr . "'");
        //        $tr->addFilter("transaksi.oleh_id='" . $this->session->login['id'] . "'");
        $tr->addFilter("transaksi.oleh_id='" . $uID . "'");

        //region date filter
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-d");
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $this->db->where("fulldate>='" . $date1 . "'");
        $this->db->where("fulldate<='" . $date2 . "'");
        //endregion

        if (isset($currentState)) {
            $tr->addFilter("jenis='" . $currentState . "'");
        }

        //        $tr->addFilter("next_substep_code=''");


        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            //            arrprint($addParams);
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }
        //
        //        $page = isset($_GET['page']) ? $_GET['page'] : 1;
        //        $jmlData = $tr->lookupHistoryCount_joined();
        ////        cekHijau($this->db->last_query());
        //
        //        $numPages = ceil($jmlData / $limit);
        //        $pages = array();
        //
        //        if ($jmlData > 0) {
        //            $factor = ($maxPageNum / 2);
        //            $selisihDepan = ($page - $factor);
        //            $selisihBelakang = ($page + $factor);
        //
        //            $firstNum = 0;
        //            $lastNum = 0;
        //
        //            if ($selisihDepan >= 0) {
        //                $pages["<span class='glyphicon glyphicon-home'></span> "] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "?page=1";
        //                $firstNum = $selisihDepan;
        //                $lastNum = $selisihBelakang;
        //            } else {
        //                $firstNum = 1;
        //                $lastNum = abs($selisihDepan) + $selisihBelakang;
        //            }
        //            if ($lastNum > $numPages) {
        //                $lastNum = $numPages;
        //            }
        //
        //            for ($i = $firstNum; $i <= $lastNum; $i++) {
        //                $pages[$i] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "?page=$i";
        //            }
        //            if ($lastNum <= $numPages) {
        //                $pages[" <span class='glyphicon glyphicon-fire'></span>"] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "?page=$numPages";
        //            }
        //        }


        $action = array(
            "viewDetails" => base_url() . get_class($this) . "/viewDetails",
        );


        //region date filter
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-d");
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $this->db->where("fulldate>='" . $date1 . "'");
        $this->db->where("fulldate<='" . $date2 . "'");
        //endregion


        $arrayHistory = array();
        $arrayHistory_ids = array();

        //region ngumpulin ID transaksi
        $trIDs = array();
        $tr0 = $tr;
        //        $tmpHist0 = $tr0->lookupHistories_joined_all($jmlData, $limit, $page)->result();
        $tmpHist0 = $tr0->lookupAll()->result();

        if (sizeof($tmpHist0) > 0) {
            foreach ($tmpHist0 as $row) {
                if (!in_array($row->id, $trIDs)) {
                    $trIDs[] = $row->id;
                }
            }
        }
        //endregion


        //pairingan dari elements
        //region pairing dari elements


        if (isset($this->config->item("heTransaksi_elementPairs")[$this->jenisTr])) {
            $pairConfig = $this->config->item("heTransaksi_elementPairs")[$this->jenisTr];

        }
        if (sizeof($trIDs) > 0) {
            $trReg = new MdlTransaksi();
            $trReg->setFilters(array());
            $trReg->addFilter("param='main_elements'");
            $trReg->addFilter("transaksi_id in (" . implode(",", $trIDs) . ")");
            $tmpReg = $trReg->lookupRegistries()->result();
            //            cekkuning($this->db->last_query());
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    $els = blobDecode($row->values);
                    $trID = $row->transaksi_id;
                    if (!isset($identPairs[$trID])) {
                        $identPairs[$trID] = array();
                        $namePairs[$trID] = array();
                        $fieldPairs[$trID] = array();
                    }
                    if (sizeof($els) > 0) {
                        foreach ($els as $elName => $elSpec) {
                            if (isset($pairConfig[$elName])) {

                                //                            arrprint($elSpec);
                                $elPairs = hePairFromElement($this->jenisTr, $elName, $elSpec);
                                //                            arrprint($elPairs['content']);
                                $identifiers = $identifiers + $elPairs['identifiers'];
                                $identPairs[$trID] = $identPairs[$trID] + $elPairs['identifiers'];
                                $names[$elName . "_id"][$elPairs['content'][$elName . "_id"]] = $elName . "_" . $elPairs['content'][$elName . "_nama"];
                                //                                $namePairs[$trID][$elName."_id"][$elPairs['content'][$elName."_id"]]=$elPairs['content'][$elName."_nama"];
                                $namePairs[$trID][$elName . "_id"]["id"] = $elPairs['content'][$elName . "_id"];
                                $namePairs[$trID][$elName . "_id"]["name"] = $elPairs['content'][$elName . "_nama"];
                                //                                if (!isset($arrayHistory[$trID][$elName . "_id"])) {
                                //                                    $arrayHistory[$trID][$elName . "_id"] = "";
                                //                                }

                                if (!isset($fieldPairs[$trID][$elName . "_id"])) {
                                    $fieldPairs[$trID][$elName . "_id"] = "";
                                    $fieldPairs[$trID][$elName . "_nama"] = "";
                                }
                                //                                print_r($arrayHistory[$trID][$elName."_id"]);
                                //                                print_r($elPairs['content'][$elName."_id"]);

                                $fieldPairs[$trID][$elName . "_id"] = $elPairs['content'][$elName . "_id"];
                                $fieldPairs[$trID][$elName . "_nama"] = $elPairs['content'][$elName . "_nama"];
                                //                                cekhijau("pairResult");
                                //                                arrprint($elPairs);
                            }
                        }
                    }
                }
            }
        }
        //endregion
        //        arrprint($namePairs);
        //        arrprint($identPairs);die();

        //        arrprint($fieldPairs);
        //region date filter
        $date1 = isset($_GET['date1']) ? $_GET['date1'] : date("Y-m-d");
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");
        $this->db->where("fulldate>='" . $date1 . "'");
        $this->db->where("fulldate<='" . $date2 . "'");
        //endregion
        $tmpHist = $tr->lookupHistories_joined_all()->result();
        //        cekbiru($this->db->last_query());

        //        cekMerah($this->db->last_query());


        if (sizeof($tmpHist) > 0) {
            foreach ($tmpHist as $row) {
                $trID = $row->transaksi_id;
                $tmp = array();
                $tmp1 = array();
                foreach ($historyFields as $fName => $fLabel) {
                    if (strpos($fName, '+') !== false) {//==mengandung penggabungan (+)
                        $chars = explode("+", $fName);
                        $colValue = "";
                        foreach ($chars as $key) {
                            $colValue .= isset($row->$key) ? formatField($key, $row->$key) . "<br>" : "";
                        }
                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {
                        $colValue = isset($row->$fName) ? formatField($fName, $row->$fName) : "";
                    }

                    //                    $tmp[$fName] = formatField($fName, $row->$fName);
                    $tmp[$fName] = $colValue;
                    $tmp1["id"] = $row->id;
                    //                    $arrayHistory[$row->transaksi_id][$fName] = $colValue;
                }
                if (isset($fieldPairs[$trID]) && sizeof($fieldPairs[$trID]) > 0) {
                    foreach ($fieldPairs[$trID] as $k => $v) {
                        $tmp[$k] = $v;
                    }
                }
                $arrayHistory[] = $tmp;
                $arrayHistory_ids[] = $tmp1;

                $jenis = $row->jenis;
                foreach ($identifiers as $iID => $iName) {
                    //                    cekbiru("checking $iID");
                    if ((isset($row->$iID) > 0 && strlen($row->$iID) > 0 && isset($row->$iName) > 0 && strlen($row->$iName) > 0) || (isset($namePairs[$trID][$iID]["id"]) && strlen($namePairs[$trID][$iID]["id"]) > 0)) {
                        //                            cekkuning("$iID/$iName");

                        //                        cekmerah("$iID being processed");
                        if (!isset($names[$iID])) {
                            $names[$iID] = array();
                        }
                        //                        $srcName = "";
                        if (isset($identPairs[$trID]) && array_key_exists($iID, $identPairs[$trID])) {
                            $srcID = $namePairs[$trID][$iID]["id"];
                            $srcName = $namePairs[$trID][$iID]["name"];
                            //                            cekbiru("$trID $srcID reading from element value: $srcID/$srcName");

                        }
                        else {
                            $srcID = $row->$iID;
                            $srcName = $row->$iName;
                            //                            cekbiru("$trID $srcID reading from table row: $srcID/$srcName");
                        }
                        //                        cekkuning("$iID/$iName/$srcID");
                        $names[$iID][$srcID] = $srcName;
                        if (!isset($recaps[$jenis][$iID][$srcID])) {
                            $recaps[$jenis][$iID][$srcID] = array(
                                "qty" => 0,
                                "value" => 0,
                            );
                        }

                        $recaps[$jenis][$iID][$srcID]['qty'] += $row->produk_ord_jml;
                        $recaps[$jenis][$iID][$srcID]['value'] += ($row->produk_ord_jml * $row->produk_ord_hrg);
                    }
                    else {
                        //                        cekmerah("$iID NOT being processed");
                    }
                }

            }
        }


        //        arrprint($arrayHistory);die();
        //        arrprint($identifiers);
        //        arrprint($trIDs);
        //        arrprint($names);
        //        arrprint($recaps[$this->jenisTr]);
        //        die();
        //endregion

        //region link to add new transaction
        if (placeCanMakeTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr)) {
            //        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['userGroup'], $this->session->login['membership'])) {
            $createIndexes = (null != $this->config->item("transaksi_createIndex")) ? $this->config->item("transaksi_createIndex") : array();
            if (array_key_exists($this->jenisTr, $createIndexes)) {
                $targetUrl = base_url() . $createIndexes[$this->jenisTr] . "/" . $this->jenisTr;
            }
            else {
                $targetUrl = base_url() . "Transaksi/createForm/" . $this->jenisTr;
            }
            $addLink = array(
                "link" => $targetUrl,
                "label" => "<span class='glyphicon glyphicon-plus'></span> create new " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            );
        }
        else {
            $addLink = null;
        }
        //endregion

        //
        //region prepare params for viewer
        $subTitle = lgTranslateTime($date1) . " to " . lgTranslateTime($date2);
        if ($date1 == $date2) {
            $subTitle = lgTranslateTime($date1);
        }

        $availFilters = array();
        if (sizeof($mems) > 0) {
            foreach ($mems as $gID) {
                if (isset($this->config->item("heTransaksi_identifierGroups")[$gID]) && sizeof($this->config->item("heTransaksi_identifierGroups")[$gID]) > 0) {
                    foreach ($this->config->item("heTransaksi_identifierGroups")[$gID] as $fID => $fLabel) {
                        if (!array_key_exists($fID, $availFilters)) {
                            $availFilters[$fID] = $fLabel;
                        }
                    }

                }
            }
        }

        //        arrprint($availFilters);die();


        //arrprint($names);die();

        //arrprint($arrayHistory);
        $thisTr = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : $this->jenisTr;
        $thisTrName = isset($row->jenis_label) ? $row->jenis_label : $this->config->item("heTransaksi_ui")[$jenisTr]["label"];
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "jenisTr" => $jenisTr,
            //            "trName"               => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "trName" => $thisTrName,
            "errMsg" => $this->session->errMsg,
            "title" => (isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName) . " (" . $this->session->login['nama'] . ")",
            "subTitle" => $subTitle,
            //            "pageCount"            => $numPages,
            //            "page"                 => $page,
            //            "pages"                => $pages,
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory,
            "arrayHistoryId" => $arrayHistory_ids,
            "action" => $action,
            "steps" => $steps,
            "stepLabels" => $stepLabels,
            "stepLinks" => $stepLinks,
            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
            "currentState" => isset($currentState) ? $currentState : "all states",
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
            "alternateLinkCaption" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " <span class='glyphicon glyphicon-arrow-right'></span>",
            "addLink" => $addLink,
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4),
            //
            //            "availFilters"=>isset($this->config->item("heTransaksi_report")[$jenisTr]["availFilters"])?$this->config->item("heTransaksi_report")[$jenisTr]["availFilters"]:array(),"availFilters"=>isset($this->config->item("heTransaksi_report")[$jenisTr]["availFilters"])?$this->config->item("heTransaksi_report")[$jenisTr]["availFilters"]:array(),
            "availFilters" => isset($availFilters) ? $availFilters : array("oleh_id" => "person"),

            "names" => $names,
            "recaps" => isset($recaps[$thisTr]) ? $recaps[$thisTr] : array(),

        );
        //endregion


        $this->load->view("history", $data);
    }

    public function viewOutstanding()
    {
        if (!isset($this->session->login['id'])) {
            gotoLogin();
            // redirect(base_url() . "Login");
        }

        $limit = 1000;
        //        $limit = 18;
        $maxPageNum = 20;
        $jenisTr = $this->uri->segment(3);
        $jenisTrsub = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;
        $currentState = strlen($this->uri->segment(4)) > 0 ? $this->uri->segment(4) : "transaksi";
        $selecetedCode = isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps']['2']['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps']['2']['target'] : "";
        $historyFields = isset($this->config->item("heTransaksi_layout")[$jenisTr]['fixedFieldHold']) ? $this->config->item("heTransaksi_layout")[$jenisTr]['fixedFieldHold'] : array();
        $detailsFields = isset($this->config->item("heTransaksi_layout")[$jenisTr]['fixedFieldHold'][$currentState]['loop']) ? $this->config->item("heTransaksi_layout")[$jenisTr]['fixedFieldHold'][$currentState]['loop'] : array();
        $arrayValid = isset($this->config->item("heTransaksi_layout")[$jenisTr]['fixedFieldHold'][$currentState]['array_flip']) ? $this->config->item("heTransaksi_layout")[$jenisTr]['fixedFieldHold'][$currentState]['array_flip'] : array();
        $lockerStock = isset($this->config->item("heTransaksi_layout")[$jenisTr]['lockerStock']) ? $this->config->item("heTransaksi_layout")[$jenisTr]['lockerStock'] : "MdlLockerStock";

        $menuLabel = isset($this->config->item("heTransaksi_ui")[$jenisTr]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['label'] : "";

        if (isset($_SESSION[$cCode])) {
            $_SESSION[$cCode] = null;
            unset($_SESSION[$cCode]);
        }


        //            $stepNumber = isset($_SESSION[$cCode]['tableIn_master']['step_number']) ? $_SESSION[$cCode]['tableIn_master']['step_number'] : 1;
        //region session init
        if (!isset($_SESSION[$cCode])) {
            $_SESSION[$cCode] = array(
                "items" => array(),
                "main" => array(),
            );
        }
        if (!isset($_SESSION[$cCode]['main'])) {
            $_SESSION[$cCode]['main'] = array();
        }
        if (!isset($_SESSION[$cCode]['items'])) {
            $_SESSION[$cCode]['items'] = array();
        }
        //endregion

        //       arrPrint($arrayFlip);
        $mb = New MobileDetect();
        $this->load->model("Mdls/$lockerStock");
        $st = new $lockerStock();
        //        $st->addFilter("jenis='produk'");
        //        $st->addFilter("jenis_locker='stock'");
        $st->addFilter("state='active'");

        $tmpStock = $st->lookupAll()->result();

        $cabangID = (isset($_GET['o']) && $_GET['o'] <> 0) ? $_GET['o'] : $this->session->login['cabang_id'];
        $gudangID = (isset($_GET['o']) && $_GET['o'] <> 0) ? $_GET['o'] : $this->session->login['gudang_id'];

        $marking_style = array();
        if (isset($_GET['trID']) && ($_GET['trID'] > 0)) {
            $marking_style[$_GET['trID']] = "background-color:yellow;font-size:20px;";
        }


        //        arrPrint($tmpStock);

        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }

        $backdate_f = formatTanggal(backDate(30), 'Y-m-d');

        $date1 = isset($_GET['date1']) ? $_GET['date1'] : $backdate_f;
        $date2 = isset($_GET['date2']) ? $_GET['date2'] : date("Y-m-d");

        //region prepare ERP
        $stepLabels = array(//            "0" => "all"
        );
        $stepLinks = array(//            "0" => base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3)
        );
        if (sizeof($historyFields) > 1) {
            $subCodes = array();
            $stepCodes = array();
            $jmlStep = count($historyFields);

            foreach ($historyFields as $stepNumber => $stepSpec) {
                $subCodes[$stepNumber] = $stepNumber;
                $stepCodes[] = $stepNumber;
                $stepLabels[$stepNumber] = $stepSpec['label'];
                $stepLinks[$stepNumber] = base_url() . $this->uri->segment(1) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $stepNumber . "/" . $this->uri->segment(3) . "?date1=$date1&date2=$date2";
            }
        }
        //endregion


        //region prepare data outstanding
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr1 = new MdlTransaksi();

        $tr->addFilter("jenis_master='" . $this->jenisTr . "'");
        $tr->addFilter("div_id='" . $this->session->login['div_id'] . "'");
        $tr->addFilter("jenis='$selecetedCode'");
        $tr->addFilter("transaksi.cabang_id='$cabangID'");

        //        $tr->addFilter("id_master='14005'");
        $searchStr = isset($_GET['search']) ? $_GET['search'] : "";

        //region date filter
        //         $this->db->where("fulldate>='" . $date1 . "'");
        //         $this->db->where("fulldate<='" . $date2 . "'");
        //endregion


        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            //            arrprint($addParams);
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }

        if (isset($_GET['search'])) {
            $tr->setKeyWord($searchStr);
        }
        else {
            // $this->db->where("fulldate>='" . $_GET['date1'] . "'");
            // $this->db->where("fulldate<='" . $_GET['date2'] . "'");
            //            $this->db->where("fulldate>='$date1'");
            //            $this->db->where("fulldate<='$date2'");
        }
        $jmlData = $tr->lookupDataCount();
        //        $limit=10;
        $page = (isset($_GET['page']) && $_GET['page'] > 0) ? ($_GET['page']) : 1;
        $offset = ($limit * ($page - 1));

        $addParams = array();
        if (isset($_GET['addParams'])) {
            $addParams = unserialize(base64_decode($_GET['addParams']));
        }
        if ($addParams != null && sizeof($addParams) > 0) {
            //            arrprint($addParams);
            foreach ($addParams as $f) {
                $tr->addFilter($f);
            }
        }


        if (isset($_GET['search'])) {
            $tr->setKeyWord($searchStr);
        }
        else {
            //            if (isset($_GET['date1'])) {
            //                $this->db->where("fulldate>='" . $_GET['date1'] . "'");
            //                $this->db->where("fulldate<='" . $_GET['date2'] . "'");
            //            }
            //            $this->db->where("fulldate>='" . $date1 . "'");
            //            $this->db->where("fulldate<='" . $date2 . "'");
        }

        $tr->addFilter("sub_step_number>0");
        $tr->addFilter("valid_qty>0");
        $tmpTr = $tr->lookupJoined_OLD()->result();
        //        $tmpTr = $tr->lookupRegistries_joined()->result();
        // showLast_query("biru");
        //cekHere(sizeof($tmpTr));
        //arrPrintWebs($tmpTr);
        //        endregion

        $extractedItems = array();//==untuk urusan update transaksi referer
        $validItems = array();
        $validItemSends = array();
        $mainData = array();
        $itemsVal = array();
        $itemData = array();
        $mainDataOutstandingItems = array();

        $kolom_2s = array(
            "cabang_id",
            "produk_id",
            "jumlah",
            "gudang_id",
        );

        $stocks = array();
        foreach ($tmpStock as $temps) {
            $tempDatas = array();
            foreach ($kolom_2s as $kolom) {
                $$kolom = $temps->$kolom;
                $tempDatas[$kolom] = $temps->$kolom;
            }
            $stocks[$cabang_id][$produk_id] = $tempDatas;
        }

        $summary = array();
        $arrayAction = array();
        $arrayItemsMasterToID = array();
        $arrayItemsReg = array();
        $arrayItemsRegPair = array();
        $arrayItemsOutstandingPair = array();
        if (sizeof($tmpTr) > 0) {
            cekHere(sizeof($tmpTr));
            //            arrprint($historyFields[$currentState]);
            if (isset($historyFields[$currentState]['items'])) {
                foreach ($tmpTr as $row) {
                    $ind_reg = $row->indexing_registry != NULL ? blobDecode($row->indexing_registry) : array();
                    $arrayItemsReg[$row->id_master] = isset($ind_reg['items']) ? $ind_reg['items'] : 0;
                    $arrayItemsMasterToID[$row->id_master] = $row->transaksi_id;
                }
                //                arrPrint($arrayItemsReg);
                // membaca registry items
                $tr->setFilters(array());
                $tr->addFilter("id in ('" . implode("','", $arrayItemsReg) . "')");
                $tmpReg = $tr->lookupRegistries()->result();
                //                showLast_query("kuning");
                //                arrPrint($tmpReg);
                foreach ($tmpReg as $rSpec) {
                    //                    cekPink2($rSpec->transaksi_id);
                    $arrayItemsRegPair[$rSpec->transaksi_id] = blobDecode($rSpec->values);
                }
                foreach ($arrayItemsRegPair as $trID => $tmp) {
                    foreach ($tmp as $pID => $etmp) {
                        if (isset($historyFields[$currentState]['items']['outstanding_items'])) {
                            foreach ($historyFields[$currentState]['items']['outstanding_items'] as $val) {
                                $arrayItemsOutstandingPair[$trID][$pID] = $etmp[$val];
                            }
                        }
                    }
                }
            }
            //            arrPrint($arrayItemsMasterToID);
            //            arrPrint($arrayItemsOutstandingPair);
            foreach ($tmpTr as $row) {
                if (!isset($validItems[$row->produk_id])) {
                    $validItems[$row->id_master][$row->produk_id] = 0;
                }
                if (!isset($validItemSends[$row->produk_id])) {
                    $validItemSends[$row->id_master][$row->produk_id] = 0;
                }

                $validItems[$row->id_master][$row->produk_id] += $row->valid_qty;
                $validItemSends[$row->id_master][$row->produk_id] += $row->produk_ord_jml - $row->valid_qty;

                if (!isset($extractedItems[$row->produk_id])) {
                    $extractedItems[$row->id_master][$row->produk_id] = array();
                }

                $no = 0;
                $srcKey = isset($historyFields[$currentState]['srcKey']) ? $historyFields[$currentState]['srcKey'] : array();

                if (isset($historyFields[$currentState]['fields'])) {
                    foreach ($historyFields[$currentState]['fields'] as $srcKey_0 => $srcAlias) {
                        $no++;
                        $val_main = isset($row->$srcKey_0) ? makeValue($srcKey_0, json_decode(json_encode($row), true), json_decode(json_encode($row), true)) : "";
                        //                        $mainData[$row->$srcKey][$srcKey_0] = formatField($srcKey_0, $val_main);

                        if (is_array($srcAlias)) {
                            $hisStep = $srcAlias['step'];
                            $hisKey = $srcAlias['key'];
                            if (isset($row->ids_his)) {
                                if ($hisKey == "nomer") {
                                    $returnVal = showHistoriGlobalNumbers($row->ids_his, $hisStep, true);
                                    if ($returnVal == "") {
                                        $mainData[$row->$srcKey][$srcKey_0] = "-";
                                    }
                                    else {
                                        $mainData[$row->$srcKey][$srcKey_0] = $returnVal;
                                    }
                                }
                                else {
                                    $ids_his_decode = blobDecode($row->ids_his);
                                    if (isset($ids_his_decode[$hisStep][$hisKey])) {
                                        $mainData[$row->$srcKey][$srcKey_0] = $ids_his_decode[$hisStep][$hisKey];
                                    }
                                    else {
                                        $mainData[$row->$srcKey][$srcKey_0] = "-";
                                    }
                                }
                            }
                            else {
                                $mainData[$row->$srcKey][$srcKey_0] = "-";
                            }
                        }
                        else {
                            $mainData[$row->$srcKey][$srcKey_0] = formatField($srcKey_0, $val_main);
                        }
                    }

                    // mereplace manual aoutstanding items...
                    $mainDataOutstandingItems[$row->$srcKey][] = array(
                        "valid_qty" => $row->valid_qty,
                        "label" => $row->produk_label,
                        "kode" => $row->produk_kode,
                        "produk_id" => $row->produk_id,
                    );

                }

                $arrAsem[$row->produk_id][] = $row->produk_kode;

                if (sizeof($detailsFields) > 0) {
                    foreach ($detailsFields as $fieldKey => $key) {
                        $val = makeValue($key, json_decode(json_encode($row), true), json_decode(json_encode($row), true));
                        $itemData[$row->$srcKey][$fieldKey][] = formatField($fieldKey, $val);
                        //                        foreach ($tmpStock as $temps) {
                        //                            if($row->produk_id==$temps->produk_id && $temps->cabang_id==$cabangID){
                        //                                $stocks[$cabangID][$row->produk_id] = $temps->jumlah;
                        //                            }
                        //                        }
                        //                        $itemData[$row->$srcKey]['stok'][] = $row->produk_id;
                        $itemData[$row->$srcKey]['stok'][] = isset($stocks[$cabangID][$row->produk_id]['jumlah']) ? $stocks[$cabangID][$row->produk_id]['jumlah'] : 0;
                    }
                }

            }
            //            arrPrintWebs($arrayItemsOutstandingPair);
            // ======================================================================
            // memairingkan qty outstanding dengan masterID masing-masing.
            if (sizeof($mainData) > 0) {
                if (sizeof($mainDataOutstandingItems) > 0) {
                    foreach ($mainDataOutstandingItems as $masterID => $spec) {
                        if (array_key_exists($masterID, $mainData)) {

                            $hasil = "";
                            $sub_tmpOutstandingPair = 0;
                            foreach ($spec as $dSpec) {
                                $addSpec = "";
                                if (isset($arrayItemsMasterToID[$masterID])) {
                                    $pairTrID = $arrayItemsMasterToID[$masterID];
                                    $tmpOutstandingPair = isset($arrayItemsOutstandingPair[$pairTrID][$dSpec['produk_id']]) ? $arrayItemsOutstandingPair[$pairTrID][$dSpec['produk_id']] : "0";
                                    $sub_tmpOutstandingPair += ($tmpOutstandingPair * $dSpec['valid_qty']);

                                    $price = number_format($tmpOutstandingPair);
                                    $sum_price = number_format($tmpOutstandingPair * $dSpec['valid_qty']);
                                    $addSpec = "<span style='width:200px;' class='pull-right text-right'>@ $price  |  $sum_price</span>";
                                }

                                if ($hasil == "") {
                                    $hasil = $dSpec['valid_qty'] . "x " . $dSpec['label'] . " " . $dSpec['kode'] . $addSpec;
                                }
                                else {
                                    $hasil .= "<br>" . $dSpec['valid_qty'] . "x " . $dSpec['label'] . " " . $dSpec['kode'] . $addSpec;
                                }
                            }
                            //                            cekHere($hasil);
                            $mainData[$masterID]['outstanding_items'] = $hasil;
                            $mainData[$masterID]['sub_outstanding_items'] = formatField("debet", $sub_tmpOutstandingPair);
                            $summary['sub_outstanding_items'] += $sub_tmpOutstandingPair;
                        }
                    }
                }
            }
        }
        else {
            cekmerah("TIDAK ada yang mau diekstrak");
        }
        //endregion
arrPrintPink($mainData);
//cekKuning(":: $currentState ::");
        //region header label
        $headerFieldLabel = array();
        if (isset($historyFields[$currentState]['fields'])) {
            foreach ($historyFields[$currentState]['fields'] as $srcKey => $alias) {
                if (is_array($alias)) {
                    $headerFieldLabel[$srcKey] = isset($alias['label']) ? $alias['label'] : "-";
                }
                else {
                    $headerFieldLabel[$srcKey] = $alias;
                }
            }
        }

        //endregion
        $addLink = null;
        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "jenisTr" => $jenisTr,
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "errMsg" => $this->session->errMsg,
            "title" => isset($subCodes) && isset($currentState) ? $subCodes[$currentState] : $this->jenisTrName,
            //            "subTitle" => "<b> Out Standing $menuLabel <r>( periode " . (isset($date1) && isset($date2) ? date("d-M-Y", strtotime($date1)) . " s/d " . date("d-M-Y", strtotime($date2)) : "HINGGA HARI INI") . " )</r></b> ",
            "subTitle" => "<b> Out Standing $menuLabel",
            "arrayHistoryLabels" => $headerFieldLabel,
            "arrayHistory" => $mainData,
            "arrayAction" => $arrayAction,
            "arrayHistorySumField" => array(),
            "detailsFields" => $itemData,
            "arrayHistoryId" => array(),
            "action" => array(),
            "steps" => $historyFields,
            "arrayValid" => $arrayValid,
            "stepLabels" => $stepLabels,
            "stepLinks" => $stepLinks,
            "addParams" => isset($_GET['addParams']) ? $_GET['addParams'] : null,
            "currentState" => isset($currentState) ? $currentState : "all states",
            "alternateLink" => base_url() . $this->uri->segment(1) . "/viewIncomplete/" . $this->uri->segment(3),
            "alternateLinkCaption" => "incomplete " . $this->config->item("heTransaksi_ui")[$jenisTr]["label"] . " <span class='glyphicon glyphicon-arrow-right'></span>",
            "addLink" => $addLink,
            "filters" => array(
                "dates" => $this->dates,
                "date1" => $date1,
                "date2" => $date2,
            ),
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5),
            "marking_style" => $marking_style,
            "summary" => $summary,
        );

        $this->load->view("history", $data);
    }

    public function debug() //print values from sessions
    {
        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        if (isset($_SESSION[$cCode])) {
            cekKuning("shopping-cart (creator)");
            arrprint($_SESSION[$cCode]);
        }
        else {
            die("the gate index you want to debug has not been formed yet!");
        }

    }


    public function viewResume()
    {
        $globalVars = array();
        $no = $this->uri->segment(3);
        $this->jenisTr = explode(".", $no)[0];
        $cCode = "_TR_" . $this->jenisTr;
        $this->load->config("heAccounting");
        $accountChildsLinks = $this->config->item("accountChildsLinks");


        $tr = new MdlMongoMother();
        //        $tr->addFilter("nomer='$no'");
        $tr->addFilter(array("nomer" => "$no"));
        $tmp1 = $tr->lookupOne("transaksi");

        $jenisMasterTrans = $tmp1->jenis_master;
        $transaksiID = $tmp1->id;
        $transaksiTopID = $tmp1->id_top;

        // membaca status edit di TOPID
        $tr = new MdlMongoMother();
        //        $tr->addFilter("id='$transaksiTopID'");
        $tr->addFilter(array("id" => "$transaksiTopID"));
        $tmpTop = $tr->lookupOne("transaksi");
        $arrTopEdit = array();
        if (sizeof($tmpTop) > 0) {
            if ((isset($tmpTop->status_edit)) && ($tmpTop->status_edit == 1)) {
                $arrTopEdit[$transaksiTopID] = array(
                    "status_edit" => $tmpTop->status_edit,
                    "edit_dtime" => $tmpTop->edit_dtime,
                    "edit_id" => $tmpTop->edit_id,
                    "edit_name" => $tmpTop->edit_name,
                );
            }
        }


        //region swap from registry
        $tr = new MdlMongoMother();
        $tr->addFilter(array("param" => "main", "transaksi_id" => "$transaksiID"));
        //        $tmpReg = $tr->lookupRegistriesByNumber($no)->result();
        $tmpReg = $tr->lookupOne("transaksi_registry");
        //        arrPrint($tmpReg);
        if (sizeof($tmpReg) > 0) {
            $var = $tmpReg->param;
            $$var = blobDecode($tmpReg->values);

        }
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlMongoMother();
        $trs->setFilters(array());
        $masterID = isset($tmp1->id_master) ? $tmp1->id_master : 0;
        $tmpSign = $trs->lookupSignaturesByMasterID($masterID);

        $arrCounters = blobDecode($tmp1->counters);
        $urutCounters = NULL;
        if (sizeof($arrCounters) > 0) {
            $key2 = $tmp1->jenis . "|" . $tmp1->cabang_id;
            $urutCounters = digit_5($arrCounters["stepCode|placeID"][$key2]);
        }
        if ($urutCounters != NULL) {
            $urutCounters = "-$urutCounters";
        }

        if (isset($this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['resumeFieldNames'])) {
            $resumeFields = $this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['resumeFieldNames']['selectFields'];
            $resumeTitle = $this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['resumeFieldNames']['title'];
            $resumeName = isset($tmp1->$resumeFields) ? $tmp1->$resumeFields : "";
        }
        else {
            $resumeTitle = "";
            $resumeName = "";
        }

        $arrSignName = array();
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $ii => $row) {
                $signValues['sign_' . $row->transaksi_id . '_' . $row->step_number] = array(
                    "title" => isset($this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['steps'][$row->step_number]['label']) ? $this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['steps'][$row->step_number]['label'] : "",
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmp1->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "dtime" => $row->dtime,

                    "nomer" => formatField("nomer_nolink", $row->nomer),
                    "nomer_orig" => $row->nomer,

                    "oleh" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                    "prev_id" => isset($row->prev_id) ? $row->prev_id : 0,
                    "link_id" => isset($row->transaksi_id) ? $row->transaksi_id : 0,
                );
                $arrSignName[$ii] = array(
                    "nama" => $row->oleh_nama,
                    "dtime" => $row->dtime,
                );
            }
        }
        $signStr = "";
        //endregion

        //entry points
        $trep = new MdlTransaksi();
        //        $tmpEP = $trep->lookupEntryPoints_joined($masterID)->result();
        $tmpEP = $trep->lookupEntryPoints($masterID)->result();
        showLast_query("biru");

        $epValues = array();
        if (sizeof($tmpEP) > 0) {
            foreach ($tmpEP as $ii => $row) {
                $jenisEx = explode("_", $row->jenis);
                $jenis = $jenisEx[0];
                $counterDecode = blobDecode($row->counters);
                $counterjenis = $jenis . "|" . $row->cabang_id;
                $counterGlobal = $counterDecode['stepCode|placeID'][$counterjenis];
                $cGlobals = digit_5($counterGlobal);


                //                $epValues['sign_' . $row->transaksi_id . '_' . $row->step_number] = array(
                $epValues['sign_' . $row->id . '_' . $row->step_number] = array(
                    "title" => isset($this->config->item("heTransaksi_ui")[$row->jenis_master]['steps'][$row->step_number]['label']) ? $this->config->item("heTransaksi_ui")[$row->jenis_master]['steps'][$row->step_number]['label'] : "",
                    "cabang_nama" => $row->cabang_nama,
                    "label" => $row->jenis_label,
                    //                    "dtime" => $row->dtime,
                    "dtime" => isset($arrSignName[$ii]['dtime']) ? $arrSignName[$ii]['dtime'] : $row->dtime,
                    "nomer" => formatField("nomer_nolink", $row->nomer),
                    "nomer_orig" => $row->nomer,
                    // "oleh"               => $row->oleh_nama,
                    "oleh" => isset($arrSignName[$ii]['nama']) ? $arrSignName[$ii]['nama'] : $row->oleh_nama,
                    "caption_department" => "text",
                    "deskripsi" => $row->deskripsi,
                    "link_id" => $row->link_id,
                    "global_counter" => $cGlobals,
                );
            }
        }


        $signArray = sizeof($epValues) > 0 ? $epValues : $signValues;
        //arrPrint($signArray);

        if (sizeof($signArray) > 0) {
            $signStr .= "<div class='panel'>";
            $signStr .= "<h4 class='text-blue'><span class='fa fa-sign-in'></span> entry points </h4>";
            $signStr .= "<h5 class='text-blue'><span class='fa fa-tasks'></span> $resumeTitle  $resumeName</h5>";
            $signStr .= "<table class='table table-condensed'>";
            $signStr .= "<tr bgcolor='#f0f0f0'>";
            $signStr .= "<td class='text-muted'>date</td>";
            $signStr .= "<td class='text-muted'>title</td>";
            $signStr .= "<td class='text-muted'>branch</td>";
            $signStr .= "<td class='text-muted'>transaction number</td>";
            $signStr .= "<td class='text-muted'>person</td>";
            $signStr .= "<td class='text-muted'>tool</td>";
            foreach ($signArray as $k => $sSpec) {

                $signDeskripsi = isset($sSpec['deskripsi']) ? " (" . $sSpec['deskripsi'] . ")" : "";
                $nomerOrig = $sSpec['nomer_orig'];
                $nomerOrigEx = explode("_", $nomerOrig);
                $nomerOrigNota = $nomerOrigEx[0];
                $nomerView = $nomerOrigNota . "-" . $sSpec['global_counter'];

                $oleh_nama = isset($arrSignName[$k]) ? $arrSignName[$k] : $sSpec['oleh'];


                $edit_description = "";
                if (isset($arrTopEdit[$sSpec['link_id']])) {
                    $edit_dtime = formatField("date_time", $arrTopEdit[$sSpec['link_id']]['edit_dtime']);
                    $edit_nama = $arrTopEdit[$sSpec['link_id']]['edit_name'];
                    $edit_description = "<span style='color:red;'>Edited by $edit_nama, $edit_dtime</span>";
                }


                $signStr .= "<tr>";
                $signStr .= "<td>" . formatField("date_time", $sSpec['dtime']);
                $signStr .= "</td>";
                $signStr .= "<td>" . ($sSpec['title']);
                $signStr .= "</td>";
                $signStr .= "<td>" . (isset($sSpec['cabang_nama']) ? $sSpec['cabang_nama'] : "-");
                $signStr .= "</td>";
                //                $signStr .= "<td>" . ($sSpec['nomer']) . $signDeskripsi . "<br>$edit_description";
                $signStr .= "<td>" . (formatField("nomer_nolink", $nomerView)) . $signDeskripsi . "<br>$edit_description";
                $signStr .= "</td>";
                $signStr .= "<td>";
                $signStr .= ("<span class='fa fa-user'></span> " . $oleh_nama . "");
                $signStr .= "</td>";

                $signStr .= "<td>";
                $signStr .= formatField("print_label", $nomerOrigNota);
                $signStr .= "</td>";

                $signStr .= "</tr>";
            }
            $signStr .= "</table class='table table-condensed'>";
            $signStr .= "</div class='panel'>";
        }

        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $allowedView = $this->config->item('userGroup_jurnal') != null ? $this->config->item('userGroup_jurnal') : array();
        $rekeningAlias = $this->config->item('accountAlias') != null ? $this->config->item('accountAlias') : array();

        $lItems = array();
        $headers = array();
        $arrCabang = array();
        if (array_intersect($allowedView, $mems)) {
            $this->load->model("Coms/ComJurnal");
            $this->load->model("Mdls/MdlCabang");

            $cb = New MdlCabang();
            $tmpCb = $cb->lookupAll()->result();
            $arrCabang = array();
            if (sizeof($tmpCb) > 0) {
                foreach ($tmpCb as $spec) {
                    $arrCabang[$spec->id] = $spec->nama;
                }
            }

            $j = new ComJurnal();
            $j->addFilter("transaksi_no='$no'");
            if ($this->session->login['cabang_id'] == CB_ID_PUSAT) {

            }
            else {
                // dimatikan dulu untuk checking jurnal lengkapnya...........
                //                $j->addFilter("cabang_id='" . $this->session->login['cabang_id'] . "'");
            }
            //            $j->setSortBy(array("kolom" => "urut", "mode" => "ASC"));
            $tmp = $j->lookupAll()->result();
            $headers = array(
                "dtime" => "date",
                "rekening" => "account",
                "debet" => "debet",
                "kredit" => "kredit",
            );
            $lItems = array();
            if (sizeof($tmp) > 0) {
                /* ---------------------------------------
                 * array link untuk mengarahkan ke halaman mutasi yg dikendaki
                 * -----------------------------------*/

                //region Description
                $mutasiLinks = array();
                foreach ($accountChildsLinks as $rekNama => $rekLink) {
                    $mutasiLinks[$rekNama] = $rekLink . "/" . $main['pihakID'] . "?o=" . $main['cabangID'] . "&trID=$transaksiID";
                }
                //endregion

                foreach ($tmp as $row) {
                    $d_start = backCustomDate("30", $row->dtime);
                    $d_stop = $row->dtime;
                    if ($row->j_jenis == "items") {
                        $blob_ext = blobEncode($row->rekening);
//                        Ledger/viewMoveDetails/RekeningPembantuProduk/persediaan%20produk/1076?o=-1&ext2_id=&main_ext2_id=
                        $defLink = "Ledger/viewMoveDetails/RekeningPembantuProduk/" . $row->rekening_main . "/" . $row->extern_id . "?o=" . $row->cabang_id . "&trID=$transaksiID&date1=$d_start&date2=$d_stop&blob_ext=$blob_ext";
                    }
                    else {
                        $defLink = "Ledger/viewMoveDetails_1/Rekening/" . $row->rekening . "?o=" . $row->cabang_id . "&trID=$transaksiID&date1=$d_start&date2=$d_stop";
                        //                    $defLink = "Ledger/viewMoves_l1/Rekening/" . $row->rekening . "?o=" . $row->cabang_id . "&trID=$transaksiID&date1=$d_start&date2=$d_stop";
                    }

                    $rekening_alias = isset($rekeningAlias[$row->rekening]) ? $rekeningAlias[$row->rekening] : $row->rekening;
                    if ($row->debet > 0 || $row->kredit > 0) {
                        //$strLink = key_exists($row->rekening, $mutasiLinks) ? $mutasiLinks[$row->rekening] : $defLink;
                        $strLink = $defLink;
                        $lItems[$row->cabang_id][$row->urut][] = array(
                            "dtime" => $row->dtime,
                            "rekening" => $row->debet > 0 ? $rekening_alias : "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . $rekening_alias,
                            "debet" => $row->debet > 0 ? $row->debet : "",
                            "kredit" => $row->kredit > 0 ? $row->kredit : "",
                            "link" => base_url() . $strLink,
                        );
                    }
                }
                //                arrPrint($lItems);
                ksort($lItems);
            }


        }


        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        $mobMode = $isMob == true ? "1" : "0";


        $printSettings = isset($this->config->item('heTransaksi_layout')[$jenisMasterTrans]['allowPrint']['1']) ? $this->config->item('heTransaksi_layout')[$jenisMasterTrans]['allowPrint']['1'] : array();
        $printLocation = isset($this->config->item('heTransaksi_layout')[$jenisMasterTrans]['printLocation']) ? $this->config->item('heTransaksi_layout')[$jenisMasterTrans]['printLocation'] : "Transaksi/viewReceipt/";

        $valasType = (isset($main['currencyDetails__label'])) ? "&type=" . blobEncode($main['currencyDetails__label']) : "";
        $valasFKali = "&f=" . blobEncode(1);

        if (sizeof($tmpSign) > 0) {
            if (isset($printSettings['size'])) {
                switch ($printSettings['size']) {
                    case "normal":
                        $receiptLink = "top.popBig('" . base_url() . $printLocation . "$no?mobMode=$mobMode&st=1$valasType$valasFKali');";
                        break;
                    case "small":
                        $receiptLink = "top.popSmall('" . base_url() . $printLocation . "$no?mobMode=$mobMode&st=2');";
                        break;
                    default:
                        //                                cekkuning("size: UNKNOWN");
                        break;
                }
            }
            else {
                $receiptLink = "top.popBig('" . base_url() . $printLocation . "$no?mobMode=$mobMode&st=3$valasType$valasFKali');";
            }
        }
        else {
            $receiptLink = "top.popBig('" . url_sanhistory() . "public/pembelian/printnable_ci.php?Mode=" . $this->jenisTr . "&no=$no&st=4');";
        }


        // ============== TAMBAHAN ============== ============== ==============
        $itemLabels = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartFields'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartFields'][1] : array();
        $itemLabels2 = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartFields2'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartFields2'][1] : array();
        $itemLabels3 = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartFields3'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartFields3'][1] : array();
        $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartNumFields'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartNumFields'][1] : array();
        $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartNumFields2'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartNumFields2'][1] : array();
        $itemNumLabels3 = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartNumFields3'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['shoppingCartNumFields3'][1] : array();
        $sumRows = isset($this->config->item("heTransaksi_ui")[$jenisMasterTrans]['shoppingCartSumFields'][1]) ? $this->config->item("heTransaksi_ui")[$jenisMasterTrans]['shoppingCartSumFields'][1] : $this->config->item("heTransaksi_layout")[$jenisMasterTrans]['receiptSumFields'][1];
        $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;

        $showScheme = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartShowScheme']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartShowScheme'] : false;


        $arrCons = array();
        $headerScheme = array();

        if ($showScheme) {

            $awal_pinjaman = isset($main['awal_pinjaman']) ? $main['awal_pinjaman'] : date('Y-m-d');
            $jatuh_tempo = isset($main['jatuh_tempo']) ? $main['jatuh_tempo'] : date('Y-m-d');
            $nilai_pinjaman = isset($main['harga']) ? $main['harga'] : 0;
            $rate_bunga = isset($main['persen_bunga']) ? $main['persen_bunga'] : 0;

            $npwp = "";
            $pph_nilai = strlen($npwp) > 10 && $pph_nilai == 15 ? 15 : 15; //dipaksa 15% untuk pemegang saham
            $valid_bunga = ($nilai_pinjaman / 12);
            $nilai_bunga = ($valid_bunga * $rate_bunga) / 100;
            $nilai_pph23 = ($nilai_bunga * $pph_nilai) / 100;

            $period = new DatePeriod(
                new DateTime($awal_pinjaman),
                new DateInterval('P1D'),
                new DateTime($jatuh_tempo)
            );

            $periodNow = new DatePeriod(
                new DateTime($awal_pinjaman),
                new DateInterval('P1D'),
                new DateTime(date('Y-m-d'))
            );

            $arrBulan = array();
            $arrBulanNow = array();
            $arrHarian = array();
            $arrWaktu = array();

            foreach ($period as $key => $value) {
                if (!isset($arrBulan[$value->format('Y-m')])) {
                    $arrBulan[$value->format('Y-m')] = array();
                }
                $arrBulan[$value->format('Y-m')][] = $value->format('Y-m-d');
            }

            foreach ($periodNow as $key => $value) {
                if (!isset($arrBulanNow[$value->format('Y-m')])) {
                    $arrBulanNow[$value->format('Y-m')] = array();
                }
                $arrBulanNow[$value->format('Y-m')][] = $value->format('Y-m-d');
            }

            $hariPadaBulanJatuhTempo = isset($arrBulan[date('Y-m', strtotime($jatuh_tempo))]) ? count($arrBulan[date('Y-m', strtotime($jatuh_tempo))]) : 0;
            $arrBulan[date('Y-m', strtotime($jatuh_tempo))][$hariPadaBulanJatuhTempo] = date('Y-m-d', strtotime($jatuh_tempo));


            $total_hari = 0;
            $total_bulan = 0;
            foreach ($arrBulan as $thnbln => $thblntgl) {
                $tmp = array(
                    "thnbln" => $thnbln,
                    "jml_hari_dbln" => count($arrBulan[$thnbln]),
                    "nilai_pinjaman" => $nilai_pinjaman,
                    "rate_bunga" => $rate_bunga,
                    "valid_bunga" => $valid_bunga * (count($arrBulan[$thnbln]) / 30),
                    "nilai_bunga" => $nilai_bunga * (count($arrBulan[$thnbln]) / 30),
                    "nilai_pph23" => $nilai_pph23 * (count($arrBulan[$thnbln]) / 30),
                    "nett_bunga" => $nilai_bunga * (count($arrBulan[$thnbln]) / 30) - ($nilai_pph23 * (count($arrBulan[$thnbln]) / 30)),
                    "silangan" => isset($arrBulanNow[$thnbln]) ? ($thnbln != date('Y-m') ? "hijau" : "berjalan") : "merah",
                );
                if (!isset($arrCons[$thnbln])) {
                    $arrCons[$thnbln] = array();
                }
                $arrCons[$thnbln] = $tmp;
                $total_bulan++;
                $total_hari += count($arrBulan[$thnbln]);
            }

            $nmPemengangSaham = "belum memilih kreditur";
            foreach ($items as $ids => $data) {
                $nmPemengangSaham = isset($data['nama']) ? $data['nama'] : "<span class='text-bol text-red'>belum ditentunkan</span>";
            }

            $headerScheme = array(
                "nama" => "$nmPemengangSaham",
                "jml_pinjaman" => "$nilai_pinjaman",
                "bunga_tahunan" => "$rate_bunga",
                "awal_meminjam" => date('d F Y', strtotime($awal_pinjaman)),
                "pelunasan_pinjaman" => date('d F Y', strtotime($jatuh_tempo)),
                "lama_pinjaman" => "$total_hari hari ($total_bulan bln)",
            );

        }

        $itemLabelsTop = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $item2LabelsTop = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        $item3LabelsTop = $itemLabels3 + $itemNumLabels3 + array("subtotal" => "sub-amount");
        $itemLabelBlacklist = array(
            "stok_center",
            "stok",
        );

        foreach ($itemLabelsTop as $key => $val) {
            if (in_array($key, $itemLabelBlacklist)) {
                unset($itemLabelsTop[$key]);
            }
        }
        if (isset($this->config->item("heTransaksi_ui")[$jenisMasterTrans]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$jenisMasterTrans]['shoppingCartHideSubamount'][1] == true) {
            unset($itemLabelsTop['subtotal']);
            unset($item2LabelsTop['subtotal']);
            unset($item3LabelsTop['subtotal']);
        }
        $blacklistView = $this->config->item('userGroup_blacklist') != null ? $this->config->item('userGroup_blacklist') : array();
        $addFildRowFields = array();


        $allowedViewTop = false;
        foreach ($mems as $memsVal) {
            if (!in_array($memsVal, $blacklistView)) {
                $allowedViewTop = true;
            }
        }

        if ($allowedViewTop == true) {


            $m = new MdlMongoMother();
            $m->setFilters(array());
            $tmpReg = $m->lookupRegistriesByMasterID($transaksiTopID);
            $addRow = isset($this->config->item("heTransaksi_ui")[$jenisMasterTrans]['additionalRows']['dummyElement']['yes']) ? $this->config->item("heTransaksi_ui")[$jenisMasterTrans]['additionalRows']['dummyElement']['yes'] : array();
            $itemNotApprove = isset($this->config->item('heTransaksi_ui')[$jenisMasterTrans]['closedRequest'][1]) ? $this->config->item('heTransaksi_ui')[$jenisMasterTrans]['closedRequest'][1] : true;
            $detailCore = isset($this->config->item('heTransaksi_core')[$jenisMasterTrans]['valueGates']['detail']) ? $this->config->item('heTransaksi_core')[$jenisMasterTrans]['valueGates']['detail'] : array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    $var = $row->param . "_reg";
                    $$var = unserialize(base64_decode($row->values));
                }
                if (sizeof($addRow) > 0) {
                    foreach ($addRow as $gateKey => $mpFields) {

                        if (isset($mpFields['hideRow']) && $mpFields['hideRow'] == true) {

                        }
                        else {
                            $addFildRowFields[$gateKey] = $mpFields['label'];
                        }
                    }
                }

                //----------------------------------
                if ($itemNotApprove == true) {
                    $dTmp = $m->lookUpDetilTransaksi($transaksiTopID);

                    $notApprove = array();
                    foreach ($dTmp as $spec) {
                        if ((isset($spec->valid_qty_no_approve)) && ($spec->valid_qty_no_approve > 0)) {
                            $notApprove[$spec->produk_id] = $spec->valid_qty_no_approve;
                        }
                    }
                    $mainNotApprove = array();
                    $itemsNotApprove = array();
                    if (sizeof($notApprove) > 0) {
                        $itemsNotApprove = $items_reg;
                        foreach ($notApprove as $pid => $pqty_not_approve) {
                            $itemsNotApprove[$pid]['qty'] = $pqty_not_approve;
                            $itemsNotApprove[$pid]['jml'] = $pqty_not_approve;
                            $itemsNotApprove[$pid]['subtotal'] = $pqty_not_approve * $itemsNotApprove[$pid]['harga'];
                            if (sizeof($detailCore) > 0) {
                                foreach ($detailCore as $key_c => $val_c) {
                                    $itemsNotApprove[$pid]['sub_' . $key_c] = $pqty_not_approve * $itemsNotApprove[$pid][$key_c];
                                    if (!isset($mainNotApprove[$key_c])) {
                                        $mainNotApprove[$key_c] = 0;
                                    }
                                    $mainNotApprove[$key_c] += ($pqty_not_approve * $itemsNotApprove[$pid][$key_c]);
                                }
                            }
                            if (!isset($mainNotApprove['harga'])) {
                                $mainNotApprove['harga'] = 0;
                            }
                            $mainNotApprove['harga'] += ($pqty_not_approve * $itemsNotApprove[$pid]['harga']);
                        }
                    }
                }
            }

            //tambahan jika ada result item
            // arrPrint($main_reg);
            if (sizeof($rsltItems_reg) > 0) {
                //region reference detil
                $m->setFilters(array());
                $tmpRegRef = $m->lookupRegistriesByMasterID($main_reg['referenceID']);
                foreach ($tmpRegRef as $refRow) {
                    $varR = $refRow->param . "_ref";
                    // cekMerah($varR);
                    $$varR = unserialize(base64_decode($refRow->values));
                }

                $tmpRowRslts_ref = array();
                $totalNilaiRef = 0;
                if (sizeof($rsltItems_ref) > 0) {
                    foreach ($rsltItems_ref as $rowRefID => $rowref_data) {
                        // $hpp = number_format($rowref_data['hpp'],0);
                        $hpp = $rowref_data['hpp'];
                        if (!isset($tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['qty'])) {
                            $tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['qty'] = 0;

                        }
                        if (!isset($tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['subtotal'])) {
                            $tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['subtotal'] = 0;
                        }

                        $tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['qty'] += $rowref_data['qty'];
                        $tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['subtotal'] += $rowref_data['sub_hpp'];
                        $tmpRowRslts_ref[$rowref_data['id']][$main_reg['pihakExternID']][$hpp]['harga'] = $rowref_data['hpp'];
                        $totalNilaiRef += $rowref_data['sub_hpp'];
                    }
                    $rowDetilRslt_label[$main_reg['pihakExternID']] = array(
                        "harga" => "harga",
                        "qty" => "qty",
                        "subtotal" => "subtotal",
                    );
                }
                //endregion

                //region current detil
                $tmpRowRslts = array();
                $tmpRowRsltsnilai = 0;
                foreach ($rsltItems_reg as $rowFifo => $fifoData) {
                    // $hpp_0 = number_format($fifoData['hpp'],0);
                    $hpp_0 = $fifoData['hpp'];
                    if (!isset($tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['qty'])) {
                        $tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['qty'] = 0;
                    }
                    if (!isset($tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['subtotal'])) {
                        $tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['subtotal'] = 0;
                    }
                    $tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['qty'] += $fifoData['qty'];
                    $tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['subtotal'] += $fifoData['sub_hpp'];
                    $tmpRowRslts_ref[$fifoData['id']][$main_reg['jenisTr']][$hpp_0]['harga'] = $fifoData['hpp'];
                    $tmpRowRsltsnilai += $fifoData['sub_hpp'];
                }
                $tmpRowRslts_label = array(
                    "nama" => "produk",
                    "qty" => "qty",
                    $main_reg['pihakExternID'] => $main_reg['pihakExternName'],
                    $main_reg['jenisTr'] => $main_reg['jenisTrName'],
                );
                $rowDetilRslt_label[$main_reg['jenisTr']] = array(
                    "harga" => "harga",
                    "qty" => "qty",
                    "subtotal" => "subtotal",
                );

                //endregion
            }
        }

        //-------------------
        // arrPrint($rsltItems_reg)
        //-------------------

        $transaksiJenisTopLabel = isset($main_reg['jenisTrName']) ? $main_reg['jenisTrName'] : "";
        $data = array(
            "mode" => $this->uri->segment(2),
            "title" => $no,
            "showScheme" => $arrCons,
            "headerScheme" => $headerScheme,
            "headers" => $headers,
            "main" => isset($main) ? $main : array(),
            "items" => $lItems,
            "receiptLink" => $receiptLink,
            "signStr" => $signStr,
            "cabangData" => $arrCabang,

            "urutCounter" => $urutCounters,
            "underMaintenance" => underConstruction(),

            // ===== ======
            "detail_title" => "Pengajuan $transaksiJenisTopLabel",

            "itemLabels" => isset($itemLabelsTop) ? $itemLabelsTop : array(),
            "item2Labels" => isset($item2LabelsTop) ? $item2LabelsTop : array(),
            "item3Labels" => isset($item3LabelsTop) ? $item3LabelsTop : array(),

            "detail_main" => isset($main_reg) ? $main_reg : array(),
            "detail_items" => isset($items_reg) ? $items_reg : array(),
            "detil_item_rslt" => isset($tmpRowRslts_ref) ? $tmpRowRslts_ref : array(),
            // "detil_item_rslt_ref" => isset($tmpRowRslts_ref) ? $tmpRowRslts_ref : array(),
            "detil_item_rslt_label" => isset($tmpRowRslts_label) ? $tmpRowRslts_label : array(),
            "detil_item_rslt_label2" => isset($rowDetilRslt_label) ? $rowDetilRslt_label : array(),
            "detail2_items" => isset($items2_sum_reg) ? $items2_sum_reg : array(),
            "detail3_items" => isset($items3_sum_reg) ? $items3_sum_reg : array(),

            "detail_sumRows" => $sumRows,
            "detail2_sumRows" => isset($sumRows2) ? $sumRows2 : array(),
            "detail3_sumRows" => isset($sumRows3) ? $sumRows3 : array(),
            "noteEnabled" => $noteEnabled,
            "addRows" => $addFildRowFields,
            //--------------------
            "mainNotApprove" => isset($mainNotApprove) ? $mainNotApprove : array(),
            "itemsNotApprove" => isset($itemsNotApprove) ? $itemsNotApprove : array(),
            "detail_not_approve_title" => "Pengajuan $transaksiJenisTopLabel (tidak diapprove)",
        );
        $this->load->view("transaksi", $data);
    }

    public function viewResumeDetails()
    {

        $selectedID = $this->uri->segment(3);

        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("transaksi_data.trash='0'");
        $joinedTrans = $tr->lookupJoinedByID($selectedID)->result()[0];

        $jenisTr = $joinedTrans->jenis_master;
        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $receiptElemets = isset($this->config->item("heTransaksi_ui")[$jenisTr]["receiptElements"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["receiptElements"] : array();
        $receiptDetailCompactListlabel = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewDetailCompactListsLabel"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewDetailCompactListsLabel"] : array();
        $receiptDetailCompactListlabel2 = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewDetailCompactListsLabel2"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewDetailCompactListsLabel2"] : array();
        $receiptCompactDetailsSum = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewCompactListDetailSum"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewCompactListDetailSum"] : array();
        $receiptCompactDetailsSum2 = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewCompactListDetailSum2"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewCompactListDetailSum2"] : array();
        $receiptMainLabel = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewMainCompactListsLabel"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewMainCompactListsLabel"] : array();
        $reviewCompactListSum = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewCompactListSum"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewCompactListSum"] : array();
        $reviewAddRows = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewAddRows"]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewAddRows"] : array();
        $reviewSign = isset($this->config->item("heTransaksi_layout")[$jenisTr]["reviewSign"][$joinedTrans->step_number]) ? $this->config->item("heTransaksi_layout")[$jenisTr]["reviewSign"][$joinedTrans->step_number] : array();

        $d_start = backCustomDate(30, $joinedTrans->fulldate);
        $d_stop = $joinedTrans->fulldate;

        $tr->setFilters(array());
        $tr->addFilter("transaksi_id='$selectedID'");
        $tmpReg = $tr->lookupRegistries()->result();

        $mainElements = array();

        $mainData = array();
        $receiptDetailFields = array();
        $receiptSumFields = array();
        $masterItems = array();
        $masterItems2_sum = array();
        foreach ($tmpReg as $regData) {

            switch ($regData->param) {
                case "main":
                    $mainData = blobDecode($regData->values);
                    break;
                case "items":
                    $masterItems_0 = blobDecode($regData->values);
                    foreach ($masterItems_0 as $pId => $masterItem) {
                        if (isset($masterItem['nett1']) && ($masterItem['nett1'] > 0)) {

                            $ppn_key = $masterItem['ppn'] / $masterItem['nett1'];
                        }
                        else {
                            $ppn_key = 0;
                        }
                        $addItem['harganppn'] = $masterItem['harga'] + ($masterItem['harga'] * $ppn_key);
                        $masterItems[$pId] = $masterItem + $addItem;
                    }
                    break;
                case "items2_sum":
                    $masterItems2_sum = blobDecode($regData->values);
                    //                    foreach ($masterItems_0 as $pId => $masterItem) {
                    //                        $ppn_key = $masterItem['ppn'] / $masterItem['nett1'];
                    //                        $addItem['harganppn'] = $masterItem['harga'] + ($masterItem['harga'] * $ppn_key);
                    //                        $masterItems[$pId] = $masterItem + $addItem;
                    //                    }
                    break;
                case "main_elements"://
                    $mainElements = blobDecode($regData->values);
                    break;
                case "receiptDetailFields"://
                    $receiptDetailFields = blobDecode($regData->values);
                    break;
                case "receiptSumFields"://
                    $receiptSumFields = blobDecode($regData->values);
                    break;
            }

        }
        //        $tmpTr->$linkKolomConfig[$hField] . "?o=$cabangID&trID=" . $tmpTr->id
        switch ($joinedTrans->produk_jenis) {
            case "produk":
                $link = base_url() . "Ledger/viewMoveDetails/RekeningPembantuProduk/persediaan produk/";
                break;
            case "supplies":
                $link = base_url() . "Ledger/viewMoveDetails/RekeningPembantuSupplies/persediaan supplies/";
                break;
            default:
                $link = NULL;
                break;
        }


        $sumQty = array();
        $arrItemsLink = array();
        if (sizeof($masterItems) > 0) {
            $qty_sum = 0;
            foreach ($masterItems as $data) {
                $qty_sum += $data["qty"];

                if ($link != NULL) {
                    $arrItemsLink[$data['id']] = $link . $data['id'] . "?o=" . $data['cabangID'] . "&trID=" . $joinedTrans->transaksi_id . "&date1=$d_start&date2=$d_stop";
                }
            }
            $sumQty["qty"] = $qty_sum;
        }
        $mainData = $mainData + $sumQty + (array)$joinedTrans;

        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($joinedTrans->id_master)->result();

        $signHeader = array();
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$joinedTrans->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$joinedTrans->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion


        $data = array(
            "mode" => $this->uri->segment(2),
            "mainFields" => $mainData,
            "items" => $masterItems,
            "items2_sum" => $masterItems2_sum,
            "itemsLabel" => $receiptDetailCompactListlabel,
            "itemsLabel2" => $receiptDetailCompactListlabel2,
            "mainSumDetailsFieldsLabel" => $receiptCompactDetailsSum,
            "mainSumDetailsFieldsLabel2" => $receiptCompactDetailsSum2,
            "mainSumFieldsLabel" => $reviewCompactListSum,
            "mainFieldsLabel" => $receiptMainLabel,
            "mainElements" => $mainElements,
            "receiptSumFields" => $receiptSumFields,
            "reviewAddRows" => $reviewAddRows,
            "sign" => $signValues,
            "reviewSign" => $reviewSign,

            "itemsLink" => $arrItemsLink,
            "itemsKolomLink" => array("nama", "produk_kode"),
            "underMaintenance" => underConstruction(),
        );

        $this->load->view("transaksi", $data);

    }

    public function viewProformaReceipt()
    {

        //        die();
        $globalVars = array();
        $transaksi_jenis = $this->uri->segment(3);
        $transaksi_id = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi.id='" . $transaksi_id . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview
        //        cekHitam("cetak TMPR");
        //                        arrPrint($tmpTr);
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number == 0 ? 1 : $tmpTr[0]->step_number;

            // $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            //            cekHitam($currentStepNum);
            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];
            //            $itemNumLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            // $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();

            //            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;


            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion

            //            cekHijau($receiptDetailFieldsReplacerConfig);


            //  take from transaksi top
            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("id='$topID'");
            $tmpTop = $tr->lookupMainTransaksi()->result();

            // $arrKey = array(
            //   $this->jenisTr
            // );
            // $cb = customCounters($tmpTr,$arrKey);
            // $cc = customCounters($tmpTop,"582pkd");
            // arrPrint($cc);
            // arrPrint($cb);
            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }
            // arrPrint($globalVars);
            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }
            //region take from registries

            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;

                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion


            $itemLabels = $receiptDetailFields;
            $itemLabels2 = $receiptDetailFields2;
            foreach ($tmpTr as $row) {

                $id = $row->produk_id;
                $tmp = array();

                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row->$key) ? $row->$key : "";
                        }
                        $tmp[$key] = $colValue;
                        if (!isset($childTableInValueParams[$id][$key])) {
                            $childTableInValueParams[$id][$key] = $colValue;
                        }


                    }
                }

                //                arrPrint($subAmountConfig);
                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }

                //                arrPrint($rawItems);
                //                arrPrint($childTableInValueParams[$row->produk_id]);
                $tmp["subtotal"] = $subtotal;
                //                arrPrint($tmp);
                //                arrPrint($childTableInValueParams[$id]);
                //                arrPrint($childTableInValueParams);
                $rawItems[$row->produk_id] = $tmp;
                //                arrPrint($rawItems);

                //                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));
                $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));
                //                arrPrint($rawItems);

                //arrPrint($receiptDetailFieldsReplacerConfig);
                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        if (array_key_exists($key, $rawItems[$row->produk_id])) {
                            $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                        }
                    }
                }

                //                arrprint($rawItems[$row->produk_id]);
                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }
        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;
        //        $items=array_merge($items,$childTableInValueParams);
        //        arrprint($items);

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //                arrPrint($mainProp);
        //                die("0000");
        //        $globalVars = $globalVars + (array)$mainProp;

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //         arrPrint($globalVars);
        //endregion
        //        arrPrint($masterTableInParams);
        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                // cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHijau($relElementType);
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    // arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key ");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        //                                        cekKuning($key."||".$val);
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    // cekHitam($vTmp);
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }


        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);
        //        arrPrint($globalVars);
        //        arrPrint($masterTableInParams);
        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        if (isset($globalVars['nomer_top'])) {
            //            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
        }
        //arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        //        arrPrint($masterTableInValueParams);
        $dpValueDetails = array();
        $dpFieldName = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                "due_amount" => $masterTableInValueParams['tagihan'],
            );

            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "vat Dp",
                "dp" => "Downpayment",
                "due_amount" => "Due amount",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        // arrPrint($elementFixedConfig);

        //        arrPrint($globalVars);
        //        die();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                //                cekHere($key);
                //                cekHere($globalVars[$key]);
            }
        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion


        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }
        else {
            $in_word = "";
        }

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : "";

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";
        $fixedElements['noteDetails']['label'] = "NOTES" . " <span class='text-white'>$trID</span>";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }


        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();


        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        //        arrPrint($itemSubTotal);
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");

        //        echo $row->step_number;

        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }

        //        arrprint($itemLabels);
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number] : array();

        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";
        $tempData = array(

            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels,
            "items" => $items,
            "items2" => $items2,
            "itemsRegistries" => $itemsRegistries,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,

        );

        $data = array(
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_layout")[$jenisTr]["print_lable"]["steps"][$currentStepNum]["labelPre"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $main,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "noteEnabled" => $noteEnabled,
            "items" => $items,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "itemsRegistries" => $itemsRegistries,
            "inWord" => $in_word,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "tempData" => $tempData,
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
        );
        //endregion

        //        arrPrint($data);
        $this->load->view("transaksi", $data);

    }

    public function viewReceipt()
    {
        $userGroupCenter = $this->config->item("userGroup");
        $userGroupBranch = array_merge($this->config->item("userGroup_cabang"), $this->config->item("userGroup_gudang"));

        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        $tr = new MdlMongoMother();
        $tr->addFilter(array("nomer" => $no));
        $tmp1 = $tr->lookUpMainTransaksi();
        $indTransksiID = $tmp1[0]->id;
        $masterID = isset($tmp1[0]->id_master) ? $tmp1[0]->id_master : 0;

        $trep = new MdlMongoMother();

        $tmpTr = $trep->LookUpJoined($indTransksiID, $tmp1[0]);
        //        showLast_query("hitam");
        //        arrPrintWebs($tmpTr);
        $cabang_id_transaksi = $tmpTr[0]->cabang_id;
        //        cekMerah($cabang_id_transaksi);
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlMongoMother();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master);
        //arrPrint($tmpSign);
        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                if ($cabang_id_transaksi == CB_ID_PUSAT) {
                    if (array_key_exists($row->group_code, $userGroupCenter)) {
                        $signValues['sign_' . $row->step_number] = array(
                            "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                            "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                            "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                        );
                    }
                }
                else {
                    cekHitam("BAWAH");
                    if (array_key_exists($row->group_code, $userGroupBranch)) {
                        $signValues['sign_' . $row->step_number] = array(
                            "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                            "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                            "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                        );
                    }
                }

            }
        }
        //        arrPrintWebs($signValues);
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview

        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number <= 0 ? 1 : $tmpTr[0]->step_number;
            $mainJenis = $tmpTr[0]->transaksi_jenis2;
            //cekHitam($currentStepNum);
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            //            cekHitam($currentStepNum);
            //            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]; //imi di of kan karena suapya gak ke overwrite dari he_transksi_ui. jika ada fields yang diperlukan untuk nota silahkan tambahi config di layout
            //            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptNumFields'][$currentStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptNumFields'][$currentStepNum];
            //            $itemNumLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            // $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();

            //            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();

            $printHitungConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung'][$currentStepNum] : false;
            $printItemRecapConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_itemRecap'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_itemRecap'][$currentStepNum] : array();
            $printMainReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_mainReplacer'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_mainReplacer'][$currentStepNum] : array();
            $printUnsetSumFieldsConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_unsetSumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_unsetSumFields'][$currentStepNum] : array();
            $printRoundDownConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_roundDown'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['print_hitung_roundDown'][$currentStepNum] : array();

            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $pairReceiptItemRegistries = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries'] : array();
            $receiptInWordConfig2 = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword2'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword2'][$currentStepNum]['in_word'] : array();
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID);
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID);
            //endregion

            //            cekHijau($receiptDetailFieldsReplacerConfig);


            //  take from transaksi top
            $tr = new MdlMongoMother();
            $tr->setFilters(array());
            $tr->addFilter(array("id" => "$topID"));
            //            $tr->addFilter("id='$topID'");
            $tmpTop = $tr->lookupMainTransaksi();

            // $arrKey = array(
            //   $this->jenisTr
            // );
            // $cb = customCounters($tmpTr,$arrKey);
            // $cc = customCounters($tmpTop,"582pkd");
            // arrPrint($cc);
            // arrPrint($cb);
            // arrPrint($tmpTr);
            $id_prevs = isset($tmpTr->ids_prev) ? $tmpTr->ids_prev : "";
            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }
            // arrPrint($globalVars);
            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }

            //region take from registries
            $tmpReg = $tr->lookupRegistriesByMasterID($trID);
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;

                    }
                }

                if ($printHitungConfig == true) {
                    $rslt = array();
                    if (sizeof($childTableInValueParams) > 0) {
                        foreach ($childTableInValueParams as $pKey => $pVal) {
                            foreach ($pVal as $key => $val) {
                                if (is_numeric($val)) {
                                    $childTableInValueParams[$pKey][$key] = round($val);
                                    if (sizeof($printItemRecapConfig) > 0) {
                                        if (array_key_exists($key, $printItemRecapConfig)) {
                                            if (!isset($rslt[$key])) {
                                                $rslt[$key] = 0;
                                            }
                                            $anu = makeValue($printItemRecapConfig[$key], $childTableInValueParams[$pKey], $childTableInValueParams[$pKey], 0);
                                            $rslt[$key] += $anu;
                                        }
                                    }
                                }
                                else {
                                    $childTableInValueParams[$pKey][$key] = $val;
                                }
                            }
                        }
                        if (sizeof($rslt) > 0) {
                            foreach ($rslt as $key => $val) {
                                $main[$key] = $val;
                            }
                        }
                    }
                    if (sizeof($main) > 0) {
                        foreach ($main as $pKey => $pVal) {

                            if (is_numeric($pVal)) {
                                $main[$pKey] = round($pVal);
                            }
                            else {
                                $main[$pKey] = $pVal;
                            }

                            if ((sizeof($printMainReplacerConfig) > 0) && array_key_exists($pKey, $printMainReplacerConfig)) {
                                foreach ($printMainReplacerConfig as $key => $val) {
                                    $main[$key] = makeValue($val, $main, $main, 0);
                                    $masterTableInValueParams[$key] = makeValue($val, $main, $main, 0);
                                    //                                    cekHere($key . " rumus $val :: dihitung ulang " . $main[$key]);
                                }
                            }

                            //                            if ((sizeof($printRoundDownConfig) > 0) && in_array($pKey, $printRoundDownConfig)) {
                            //                                $main[$pKey] = floor($main[$pKey]);
                            //                                $masterTableInValueParams[$pKey] = floor($masterTableInValueParams[$pKey]);
                            //                                cekHere(":: $pKey -> " . $main[$pKey]);
                            //                            }
                        }
                        if ((sizeof($printRoundDownConfig) > 0)) {
                            foreach ($printRoundDownConfig as $rSpec) {
                                $main[$rSpec] = floor($main[$rSpec]);
                                $masterTableInValueParams[$rSpec] = floor($masterTableInValueParams[$rSpec]);
                                //                                cekHere(":: $rSpec -> " . $main[$rSpec]);
                            }
                        }
                    }
                    if (sizeof($printUnsetSumFieldsConfig) > 0) {

                        foreach ($printUnsetSumFieldsConfig as $val) {

                            if (isset($receiptSumFields[$val])) {
                                unset($receiptSumFields[$val]);
                            }
                        }
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion
            //cekBiru(count($tmpTr));
            //arrPrint($itemsRegistries);
            //arrPrint($main);
            //arrPrint($masterTableInValueParams);

            $itemLabels = sizeof($receiptDetailFields) > 0 ? $receiptDetailFields : $itemLabels;
            $itemLabels2 = $receiptDetailFields2;
            if ($mainJenis == "paket") {
                //                arrPrint($itemLabels);
                $rawItems[] = array(
                    "produk_kode" => "",
                    "produk_nama" => $tmpTr[0]->transaksi_jenis2_label,
                    "nett1" => $main['new_net1'],
                    "subtotal" => $main['grand_total_ui'],
                );
            }
            else {
                foreach ($tmpTr as $row) {

                    $id = $row->produk_id;
                    $tmp = array();

                    if (sizeof($itemLabels) > 0) {
                        foreach ($itemLabels as $key => $val) {
                            if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                                $chars = explode("+", $key);
                                $colValue = "";
                                foreach ($chars as $key2) {
                                    $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                                }
                            }
                            else {
                                $colValue = isset($row->$key) ? $row->$key : "";
                            }
                            $colValue = ($printHitungConfig == true && is_numeric($colValue)) ? round($colValue) : $colValue;
                            $tmp[$key] = $colValue;
                            if (!isset($childTableInValueParams[$id][$key])) {
                                $childTableInValueParams[$id][$key] = $colValue;
                            }
                        }
                    }

                    //                arrPrint($subAmountConfig);
                    if ($subAmountConfig != null) {
                        $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                        $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                        $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                    }
                    else {
                        $subtotal = 0;
                    }

                    $tmp["subtotal"] = $subtotal;

                    $rawItems[$row->produk_id] = $tmp;

                    //                arrPrint($rawItems);
                    //                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));

                    $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));
                    //                arrPrint($rawItems);

                    //arrPrint($receiptDetailFieldsReplacerConfig);
                    if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                        foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                            if (array_key_exists($key, $rawItems[$row->produk_id])) {
                                $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                            }
                        }
                    }

                    //                arrprint($rawItems[$row->produk_id]);
                    foreach ($availValueKeys as $ak) {
                        //                        echo "checking $ak: ";
                        if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                            //                        echo "ada ";
                            $valueKey = $ak;
                        }
                        else {
                            //                        echo "none ";
                        }
                    }

                }
            }

        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;


        //        $items=array_merge($items,$childTableInValueParams);
        //arrPrint($items);
        //cekHere(count($items));

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //                arrPrint($mainProp);
        //                die("0000");
        //        $globalVars = $globalVars + (array)$mainProp;

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //         arrPrint($globalVars);
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $elementInjectorConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptElementInjector']) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptElementInjector'] : array();
        $elementInjectorUsedFieldsConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptElementInjector']['source']['usedFields']) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptElementInjector']['source']['usedFields'] : array();
        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {

                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHitam(":: $eKey :: $elementType ::");
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    //                                    arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);
                                        //                                        cekMerah("hapuslah nik");
                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                        //                                        cekMerah("hapuslah nik");
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }

                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }
                $elements[$eKey] = $eTmp;
            }

            if (sizeof($elementInjectorConfig) > 0) {
                if (isset($elementInjectorConfig['source'])) {
                    $srcElement = $elementInjectorConfig['source']['element'];
                    $srcFields = $elementInjectorConfig['source']['fields'];
                    $arrSource = array();
                    if (array_key_exists($srcElement, $elements)) {
                        foreach ($srcFields as $key => $label) {
                            $arrSource[$label] = $elements[$srcElement]['contents'][$key];
                        }
                    }
                }
            }
            if (isset($elementInjectorConfig['target'])) {
                $targetElement = $elementInjectorConfig['target']['element'];
                if (array_key_exists($targetElement, $elements)) {
                    foreach ($elements[$targetElement] as $ii => $eSpec) {
                        if ($ii == "contents") {
                            $addContens = array();
                            foreach ($arrSource as $key => $val) {
                                $addContens[$key] = $val;
                            }
                            $elements[$targetElement][$ii] = $addContens + $eSpec;
                        }
                    }
                }
            }

        }


        $blacklist_key = array("dtime");
        foreach ($blacklist_key as $list) {
            if (isset($main[$list])) {
                unset($main[$list]);
            }
        }
        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams, $main);


        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        if (isset($globalVars['nomer_top'])) {
            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
            // $num_top = showHistoriGlobalNumbers($globalVars["ids_his"],1);
            // $globalVars['nomer_top'] = $num_top."**";
        }
        else {
            $globalVars['nomer_top'] = "-";
        }


        if (isset($globalVars["ids_his"])) {
            $stepPrev = $globalVars["step_number"] - 1;
            if ($stepPrev > 0) {
                // $cHist = blobDecode($globalVars["ids_his"])[$stepPrev];
                // $counterhists = blobDecode($cHist["counters"]);
                // $cNomer = $cHist["nomer"];
                // $cNomerExpl = explode(".", $cNomer);
                // $cTrcode = $cNomerExpl[0];
                // $cTrplace = $cNomerExpl[1];
                // $cgJenis = "$cTrcode|$cTrplace";
                //
                // $cgHist = digit_5($counterhists["stepCode|placeID"]["$cgJenis"]);
                //
                // $nomer_prev = $cNomer . "-" . $cgHist;

                // $globalVars['nomers_prev'] = formatField("nomer", $nomer_prev);

                //                arrPrint($stepPrev);
                $globalVars['nomers_prev'] = showHistoriGlobalNumbers($globalVars["ids_his"], $stepPrev, true);
            }
            else {
                $globalVars['nomers_prev'] = "-";
            }
        }
        else {
            $ids_prev = blobDecode($tmpTr[0]->ids_prev);
            // arrPrint($tmpTr[0]->ids_prev);
            $trx = new MdlTransaksi();
            $trx->setFilters(array());
            $trx->addFilter("id='" . $ids_prev[0] . "'");
            $tmpTrx = $trx->lookupMainTransaksi()->result();
            $counterTrID = blobDecode($tmpTrx[0]->counters);
            foreach ($counterTrID as $key_d => $val_d) {
                foreach ($val_d as $val_dd) {
                    $tmpTrx['countersTrID'][$key_d] = $val_dd;
                }
            }
            //            arrPrint($tmpTrx);
            $addTrIdCounter = isset($tmpTrx['countersTrID']['stepCode|placeID']) ? "-" . digit_5($tmpTrx['countersTrID']['stepCode|placeID']) : "";
            //            cekHere($addTrIdCounter);
            $globalVars['nomers_prev'] = isset($tmpTrx[0]->nomer) ? formatField("nomer", $tmpTrx[0]->nomer . $addTrIdCounter) : "-";
        }


        // arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        //        arrPrint($masterTableInValueParams);
        $dpValueDetails = array();
        $dpFieldName = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                "due_amount" => $masterTableInValueParams['tagihan'],
            );

            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "vat Dp",
                "dp" => "Downpayment",
                "due_amount" => "Due amount",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        // arrPrint($elementFixedConfig);

        //        arrPrint($globalVars);
        //        die();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                if (is_array($label)) {
                    $dataHist = blobDecode($globalVars[$label['source']]);
                    $counters = blobDecode($dataHist[$label['step']]['counters']);
                    $countersUrut = array_values($counters['stepCode|placeID'])[0];
                    $countersUrut = "-" . digit_5($countersUrut);
                    $fixedElements['fixedElements']['contents'][$label['label']] = isset($dataHist[$label['step']][$label['target']]) ? formatField($label['target'], $dataHist[$label['step']][$label['target']]) . $countersUrut : "";
                    $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                }
                else {

                    //                    $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                    if (isset($globalVars[$key])) {
                        if (is_array($globalVars[$key])) {
                            if (sizeof($globalVars[$key])) {
                                //                                arrPrint($globalVars[$key]);
                                $ii_result = "";
                                foreach ($globalVars[$key] as $ii => $ii_val) {
                                    if ($ii_result == "") {
                                        $ii_result = formatField($key, $ii_val);
                                    }
                                    else {
                                        $ii_result .= "<br>" . formatField($key, $ii_val);
                                    }
                                }
                                $fixedElements['fixedElements']['contents'][$label] = $ii_result;
                            }
                            else {
                                $fixedElements['fixedElements']['contents'][$label] = "";
                            }
                        }
                        else {
                            $fixedElements['fixedElements']['contents'][$label] = formatField($key, $globalVars[$key]);
                        }
                    }
                    else {
                        $fixedElements['fixedElements']['contents'][$label] = "";
                    }
                    $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                }


            }
        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion

        //region add fields2 main
        $addMainData2Fields = isset($this->config->item("heTransaksi_layout")[$this->jenisTr]["receiptAddMain"][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]["receiptAddMain"][$row->step_number] : array();
        $addMainData2 = array();
        if (sizeof($addMainData2Fields) > 0) {
            foreach ($addMainData2Fields as $keys => $keysLabel) {
                $addMainData2[$keys] = isset($globalVars[$keys]) ? $globalVars[$keys] : "";
            }
        }
        //endregion


        $in_word = "";
        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            //            cekHitam();
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        matiHere($val_convert);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }

        $in_word2 = "";
        if (sizeof($receiptInWordConfig2) > 0) {
            $this->load->helper("he_inword");
            foreach ($receiptInWordConfig2 as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {
                    $val_convert = $masterTableInValueParams[$fieldsSelected];
                    $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                    //                        $val_convert1=formatField("tagihan",$val_convert);
                    $val_convert1 = number_format(0 + $val_convert);

                    //                        echo $val_convert1;
                    $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                    //                        cekHitam($val_convert. " ||". $val_convert1);
                    $he_word2 = $he_loader($val_convert2, $currency);
                    //                        $he_word = $he_loader($val_convert, $currency);
                    $in_word2 .= "$he_word2";


                }
            }
        }
        else {
            $in_word2 = "";
        }

        //region load Mdl static note
        //        arrPrint($globalVars);
        $this->load->model("Mdls/MdlStaticNotes");
        $sn = new MdlStaticNotes();
        $cbSelected = $globalVars['cabang_id'];
        $sn->addFilter("cabang_id=$cbSelected");
        $availNotes = $sn->lookupAll()->result();
        //        cekLime($this->db->last_query());
        //        matiHere();
        $temNotes = array();
        if (sizeof($availNotes) > 0) {
            foreach ($availNotes as $tempNotes) {
                $jn = $tempNotes->jenis;
                $val = $tempNotes->nilai;
                $temNotes[$jn] = $val;

            }
        }
        //        arrPrint($temNotes);

        //endregion

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : false;
        $listedDif = array("584");


        //region notes element
        if ($staticNotes) {
            if ($tmpTr[0]->jenis_master == "382") {
                $notesfill = $temNotes["382"];
            }
            else {
                $notesfill = $temNotes["582"];
            }

        }
        else {
            $notesfill = "";
        }

        $fixedElements['noteDetails'] = array();

        if (isset($globalVars['description'])) {
            $catatan = $globalVars['description'];
            $fixedElements['noteDetails']['contents'][] = $catatan;
        }
        if (isset($globalVars['description_additional']) && (sizeof($globalVars['description_additional']) > 0)) {
            $ii_rslt = "";
            foreach ($globalVars['description_additional'] as $ii => $iiVal) {
                if ($ii_rslt == "") {
                    $ii_rslt = "<br />" . $iiVal;
                }
                else {
                    $ii_rslt .= "<br />" . $iiVal;
                }
            }
            $catatan = $ii_rslt;
            $fixedElements['noteDetails']['contents'][] = $catatan;
        }


        $fixedElements['noteDetails']['contents'][] = "<br><br>" . $notesfill;

        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");

        //        cekMerah("cetak items label [$currentStepNum]");
        //        arrPrint($itemLabels);
        //        cekMerah("cetak items num label");
        //        arrPrint($itemNumLabels);
        //        cekMerah("cetak sub total");
        //        arrPrint($itemSubTotal);

        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number] : array();
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";


        $receiptSumFieldsReplacer = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumFieldsReplacer'] : array();
        if (sizeof($receiptSumFieldsReplacer) > 0) {
            foreach ($receiptSumFields as $key => $val) {
                $receiptSumFields[$key] = (isset($receiptSumFieldsReplacer[$val]) && isset($main[$receiptSumFieldsReplacer[$val]])) ? $main[$receiptSumFieldsReplacer[$val]] : $val;
            }
        }


        $data = array(
            //            "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            //            "mainValues" => $mainValues,
            //            "detailValues" => $detailValues,
            "mainValues" => $main,
            //            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,
            //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            //            "itemLabels" => $itemLabels + $itemNumLabels,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "noteEnabled" => $noteEnabled,
            "items" => $items,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "itemsRegistries" => $itemsRegistries,
            "inWord" => $in_word,
            "inWord2" => $in_word2,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "elementUsedFieldsConfigs" => $elementInjectorUsedFieldsConfig,
            "signHeader" => $signHeader,
            //            "dataTemp" => $dataTemp,
            //            "fixedElements" => $fixedElements,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            //            "tempData" => $tempData,
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
            "mainData2Fields" => $addMainData2Fields,
            "mainData2" => $addMainData2,
        );
        //endregion

        //        arrPrint($globalVars);
        $this->load->view("transaksi", $data);

    }

    public function viewReceiptReg()
    {
        $userGroupCenter = $this->config->item("userGroup");
        $userGroupBranch = array_merge($this->config->item("userGroup_cabang"), $this->config->item("userGroup_gudang"));


        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        //        $this->load->model("MdlTransaksi");
        //        $tr = new MdlMongoMother();
        //        $tr->addFilter("nomer='" . $no . "'");
        //        $tr->addFilter("transaksi_data.trash='0'");


        $tr = new MdlMongoMother();
        $tr->addFilter(array("nomer" => $no));
        //        $tmp1 = $tr->lookupAll()->result();
        $tmp1 = $tr->lookUpOne("transaksi");
        $indTransksiID = $tmp1->id;
        $masterID = isset($tmp1->id_master) ? $tmp1->id_master : 0;
        // cekLime($masterID);
        // arrPrint($tmp1);
        //        cekMerah($indTransksiID);
        $tmpTr = $tr->lookupJoined($indTransksiID, $tmp1);
        //        arrPrint($tmpTr);
        $cabang_id_transaksi = $tmpTr[0]->cabang_id;
        //        cekHitam($this->db->last_query());
        $replaceStepPic[$tmpTr[0]->step_number] = array(
            "olehID" => $tmpTr[0]->oleh_id,
            "olehNama" => $tmpTr[0]->oleh_nama,
        );
        //        arrPrint($replaceStepPic);
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlMongoMother();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master);
        //arrPrint($tmpSign);
        //matiHEre();
        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                if ($cabang_id_transaksi == CB_ID_PUSAT) {
                    if (array_key_exists($row->group_code, $userGroupCenter)) {
                        $signValues['sign_' . $row->step_number] = array(
                            "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                            "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                            "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                        );
                    }
                    else {
                        $signValues['sign_' . $row->step_number] = array(
                            "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                            "contents" => "",
                            "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                        );
                    }
                }
                else {
                    // cekHitam("BAWAH");
                    if (array_key_exists($row->group_code, $userGroupBranch)) {
                        $signValues['sign_' . $row->step_number] = array(
                            "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                            "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                            "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                        );
                    }
                    else {
                        $signValues['sign_' . $row->step_number] = array(
                            "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                            "contents" => "",
                            "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                        );
                    }
                }
            }
            //            arrPrint($signValues);
            foreach ($replaceStepPic as $stepTr => $replaceStepTmp) {
                if (isset($signValues['sign_' . $stepTr])) {
                    $signValues['sign_' . $stepTr]['contents'] = $replaceStepTmp['olehNama'];
                }
            }
        }
        //endregion
        //        arrPrint($signValues);
        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview
        //        cekBiru("66 Line " . __LINE__);
        if (sizeof($tmpTr) > 0) {
            //            cekBiru("66 Line " . __LINE__);
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number <= 0 ? 1 : $tmpTr[0]->step_number;
            $mainJenis = $tmpTr[0]->transaksi_jenis2;
            //            cekHitam($this->jenisTr);
            // $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            //            cekHitam($currentStepNum);
            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];
            //            $itemNumLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            // $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();

            //            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $pairReceiptItemRegistries = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries'] : array();
            $receiptInWordConfig2 = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword2'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword2'][$currentStepNum]['in_word'] : array();
            $receiptDetailSrcFields = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailSrcFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailSrcFields'][$currentStepNum] : array();
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID);
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID);
            //endregion

            //            cekHijau($receiptDetailFieldsReplacerConfig);


            //  take from transaksi top
            $tr = new MdlMongoMother();
            $tr->setFilters(array());
            //<!--            $tr->addFilter("id='$topID'");-->
            $tr->addFilter(array("id" => "$topID"));
            //            $tr->addFilter(array("id" => "$topID"));
            $tmpTop = $tr->lookupMainTransaksi();

            // $arrKey = array(
            //   $this->jenisTr
            // );
            // $cb = customCounters($tmpTr,$arrKey);
            // $cc = customCounters($tmpTop,"582pkd");
            // arrPrint($cc);
            // arrPrint($cb);
            // arrPrint($tmpTr);
            $id_prevs = $tmpTr[0]->ids_prev;
            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }
            // arrPrint($globalVars);
            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }
            //region switcher noyta pembatalan
            if (in_array($this->jenisTr, $this->jenisException)) {
                $injectedFields = $this->config->item("heTransaksi_layout")[$this->jenisTr]["receiptNumFields"][$currentStepNum];
                // arrPrint($injectedFields);
                // matiHEre($this->jenisTr);
            }
            else {
                $injectedFields = array();
            }


            //endregion
            //region take from registries


            $tmpReg = $tr->lookupRegistriesByMasterID($trID);
            // arrPrint($trID);
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();
            $itemSrc = array();
            $receiptRsltItems = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            unset($masterTableInParams['dtime']);
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));

                            unset($main['dtime']);
                            break;
                        case "itemSrc"://
                            $itemSrc = unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems":
                            $receiptRsltItems = unserialize(base64_decode($row->values));
                            break;

                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion
            //cekBiru(count($tmpTr));
            //arrPrint($receiptDetailSrcFields);
            // arrPrint();
            if (sizeof($injectedFields) > 0) {
                $sumItemsRslt = array();
                $valMainInject = 0;
                foreach ($receiptRsltItems as $receiptRsltItems_0) {
                    if (!isset($sumItemsRslt[$receiptRsltItems_0['id']]['sisa'])) {
                        $sumItemsRslt[$receiptRsltItems_0['id']]['sisa'] = 0;
                    }
                    if (!isset($sumItemsRslt[$receiptRsltItems_0['id']]['subtotal'])) {
                        $sumItemsRslt[$receiptRsltItems_0['id']]['subtotal'] = 0;
                    }
                    $sumItemsRslt[$receiptRsltItems_0['id']]['sisa'] += $receiptRsltItems_0['sub_hpp'];
                    $sumItemsRslt[$receiptRsltItems_0['id']]['subtotal'] += $receiptRsltItems_0['sub_hpp'];
                    $valMainInject += $receiptRsltItems_0['sub_hpp'];
                }

                $main['tagihan'] = $valMainInject;
                // arrPrint($valMainInject);
                // matiHere();
            }
            //matiHere();
            //            cekKuning($tmpTr[0]->jenis_master);
            //            cekKuning($mainJenis);

            //            matiHEre();
            $itemLabels = $receiptDetailFields;
            $itemLabels2 = $receiptDetailFields2;
            $itemSrcLabel = $receiptDetailSrcFields;
            if (($mainJenis == "paket") && ($tmpTr[0]->jenis_master == "1582")) {
                // cekBiru("MASUK ATAS");
                //                arrPrint($itemsRegistries);
                $rawItems = array();
                foreach ($itemsRegistries as $tmpItem) {
                    $tmpItemList = array();
                    //                    arrPrint($tmpItem);
                    //                    die();
                    foreach ($itemLabels as $key => $alias) {
                        $tmpItemList[$key] = $tmpItem[$key];
                    }
                    $injectParam = array(
                        "nett1_bulat" => $tmpItem['harga'],
                        "subtotal" => $tmpItem['subtotal'],
                    );
                    //                    cekMerah("ctak injector");
                    //                    arrPrint($injectParam);
                    $rawItems[] = $tmpItemList + $injectParam;
                }
                //                arrPrint($itemNumLabels);
                //                arrPrint($rawItems);
                //                arrPrint($rawItems);
                //                die();
                //                $rawItems[] = array(
                //                    "produk_kode" => "",
                //                    "produk_nama" => $tmpTr[0]->transaksi_jenis2_label,
                //                    "nett1_bulat"       => $main['nett1_bulat'],
                ////                    "nett1"       => $main['new_net1'],
                //                    "subtotal"    => $main['grand_total_ui'],
                //                );
            }
            else {
                //                cekBiru("MASUK BAWAH");
                //                foreach ($tmpTr as $row) {
                //            arrPrint($tmpTr);
                foreach ($tmpTr as $row) {
                    $id = $row->produk_id;
                    //                    cekBiru($id);
                    $tmp = array();

                    if (sizeof($itemLabels) > 0) {
                        foreach ($itemLabels as $key => $val) {
                            if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                                $chars = explode("+", $key);
                                $colValue = "";
                                foreach ($chars as $key2) {
                                    $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                                }
                            }
                            else {
                                $colValue = isset($row->$key) ? $row->$key : "";
                            }
                            $tmp[$key] = $colValue;
                            if (!isset($childTableInValueParams[$id][$key])) {
                                $childTableInValueParams[$id][$key] = $colValue;
                            }
                        }
                    }


                    //                    arrPrint($childTableInValueParams[$id]);
                    //                    arrPrint($subAmountConfig);
                    if ($subAmountConfig != null) {
                        // cekLime("masukk" . $id);
                        $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                        $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                        //                         arrPrint($subAmountConfig);
                        $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                        //                        cekBiru($subtotal);
                    }
                    else {
                        $subtotal = 0;
                    }
                    // cekHere($subtotal . " --- " . $id);
                    //                    matiHEre();
                    if (isset($itemsRegistries[$id])) {
                        foreach ($itemLabels as $key => $labels) {
                            if (isset($itemsRegistries[$id][$key])) {
                                $tmp[$key] = $itemsRegistries[$id][$key];
                            }
                        }
                    }
                    //                    arrPrint($tmp);

                    $tmp["subtotal"] = $subtotal;

                    $rawItems[$row->produk_id] = $tmp;

                    //                     arrPrint($childTableInValueParams);
                    //                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));

                    $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));
                    //                                    arrPrint($rawItems);

                    //arrPrint($receiptDetailFieldsReplacerConfig);
                    //                    matiHEre();
                    if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                        foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                            if (array_key_exists($key, $rawItems[$row->produk_id])) {
                                $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                            }
                        }
                    }

                    //                                    arrprint($rawItems);
                    foreach ($availValueKeys as $ak) {
                        //                        echo "checking $ak: ";
                        if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                            //                        echo "ada ";
                            $valueKey = $ak;
                        }
                        else {
                            //                        echo "none ";
                        }
                    }

                }
            }

        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion
        //        cekBiru("66 Line " . __LINE__);

        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;
        //region injector jika pembatalan melibatkan fifo
        if (sizeof($sumItemsRslt) > 0) {
            $valMainInject = 0;
            foreach ($rawItems as $pid => $pidData) {
                if (isset($sumItemsRslt[$pid])) {
                    foreach ($sumItemsRslt[$pid] as $kKey => $value_rslt) {
                        // cekMerah($pidData['produk_nama']."".$kKey."---".$value_rslt);
                        $items[$pid][$kKey] = $value_rslt;
                        $itemsRegistries[$pid][$kKey] = $value_rslt;
                        // if(!isset($main['tagihan'])){
                        //     $main['tagihan'] =0;
                        // }

                    }
                }
                // arrPrint($pidData);
            }
            // arrPrint($sumItemsRslt);
            // matiHEre($valMainInject);
        }
        // arrPrint($itemsRegistries);
        //         matiHEre();
        //endregion
        // cekMerah($this->jenisTr);
        //region replace main labels with properties from future/next step
        //        arrPrintwebs($main);
        //        arrPrintwebs($globalVars);
        $mainProp = $tmpTr[0];
        $globalVars = array_merge($globalVars, (array)$mainProp, $main);
        //        arrPrint((array)$mainProp);
        //        arrPrintWebs($globalVars);
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                // cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHijau($relElementType);
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    // arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key ");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        //                                        cekKuning($key."||".$val);
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    // cekHitam($vTmp);
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }


        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);

        //        arrPrint($globalVars);
        //        arrPrint($masterTableInParams);
        //        arrPrint();


        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        if (isset($globalVars['nomer_top'])) {
            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
            // $num_top = showHistoriGlobalNumbers($globalVars["ids_his"],1);
            // $globalVars['nomer_top'] = $num_top."**";
        }
        else {
            $globalVars['nomer_top'] = "-";
        }


        if (isset($globalVars["ids_his"])) {
            $stepPrev = $globalVars["step_number"] - 1;
            if ($stepPrev > 0) {
                // $cHist = blobDecode($globalVars["ids_his"])[$stepPrev];
                // $counterhists = blobDecode($cHist["counters"]);
                // $cNomer = $cHist["nomer"];
                // $cNomerExpl = explode(".", $cNomer);
                // $cTrcode = $cNomerExpl[0];
                // $cTrplace = $cNomerExpl[1];
                // $cgJenis = "$cTrcode|$cTrplace";
                //
                // $cgHist = digit_5($counterhists["stepCode|placeID"]["$cgJenis"]);
                //
                // $nomer_prev = $cNomer . "-" . $cgHist;

                // $globalVars['nomers_prev'] = formatField("nomer", $nomer_prev);

                //                arrPrint($stepPrev);
                $globalVars['nomers_prev'] = showHistoriGlobalNumbers($globalVars["ids_his"], $stepPrev, true);
            }
            else {
                $globalVars['nomers_prev'] = "-";
            }
        }
        else {
            $ids_prev = blobDecode($tmpTr[0]->ids_prev);
            // arrPrint($tmpTr[0]->ids_prev);
            $trx = new MdlTransaksi();
            $trx->setFilters(array());
            $trx->addFilter("id='" . $ids_prev[0] . "'");
            $tmpTrx = $trx->lookupMainTransaksi()->result();
            $counterTrID = blobDecode($tmpTrx[0]->counters);
            foreach ($counterTrID as $key_d => $val_d) {
                foreach ($val_d as $val_dd) {
                    $tmpTrx['countersTrID'][$key_d] = $val_dd;
                }
            }
            //            arrPrint($tmpTrx);
            $addTrIdCounter = isset($tmpTrx['countersTrID']['stepCode|placeID']) ? "-" . digit_5($tmpTrx['countersTrID']['stepCode|placeID']) : "";
            //            cekHere($addTrIdCounter);
            $globalVars['nomers_prev'] = isset($tmpTrx[0]->nomer) ? formatField("nomer", $tmpTrx[0]->nomer . $addTrIdCounter) : "-";
        }


        // arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        $dpValueDetails = array();
        $dpFieldName = array();
        $dpValueDetailsINV = array();
        $dpFieldNameINV = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                "due_amount" => $masterTableInValueParams['tagihan'],
            );
            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "vat Dp",
                "dp" => "Downpayment",
                "due_amount" => "Due amount",
            );

            $dpValueDetailsINV = array(
                "dp_saldo_awal" => $masterTableInValueParams['dp_saldo_awal'],
                "dp_dipakai" => $masterTableInValueParams['dp_dipakai'],
                //                "dp" => $masterTableInValueParams['dp'],
                "dp_saldo_akhir" => $masterTableInValueParams['dp_saldo_akhir'],
            );
            $dpFieldNameINV = array(
                "dp_saldo_awal" => "Saldo DP",
                "dp_dipakai" => "DP dipakai",
                //                "dp" => "Downpayment",
                "dp_saldo_akhir" => "Sisa DP",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementHideFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['hideFixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['hideFixedElements'][$currentStepNum] : array();
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        //         arrPrint($elementFixedConfig);
        //
        //                arrPrint($globalVars);
        //        die();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                if (is_array($label)) {
                    //                    cekHitam("masuk atas $label");
                    $dataHist = blobDecode($globalVars[$label['source']]);
                    $counters = blobDecode($dataHist[$label['step']]['counters']);
                    $countersUrut = array_values($counters['stepCode|placeID'])[0];
                    $countersUrut = "-" . digit_5($countersUrut);
                    $fixedElements['fixedElements']['contents'][$label['label']] = isset($dataHist[$label['step']][$label['target']]) ? formatField($label['target'], $dataHist[$label['step']][$label['target']]) . $countersUrut : "";
                    $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                }
                else {
                    //                    $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                    if (isset($globalVars[$key])) {
                        if (is_array($globalVars[$key])) {
                            if (sizeof($globalVars[$key])) {
                                $ii_result = "";
                                foreach ($globalVars[$key] as $ii => $ii_val) {
                                    if ($ii_result == "") {
                                        $ii_result = formatField($key, $ii_val);
                                    }
                                    else {
                                        $ii_result .= "<br>" . formatField($key, $ii_val);
                                    }
                                }
                                $fixedElements['fixedElements']['contents'][$label] = $ii_result;
                            }
                            else {
                                $fixedElements['fixedElements']['contents'][$label] = "";
                            }
                        }
                        else {
                            $fixedElements['fixedElements']['contents'][$label] = formatField($key, $globalVars[$key]);
                        }
                    }
                    else {
                        $fixedElements['fixedElements']['contents'][$label] = "";
                    }
                    $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                }
            }
//            cekKuning($elementHideFixedConfig);
            if (sizeof($elementHideFixedConfig) > 0) {
                foreach ($elementHideFixedConfig as $hideSpec) {
                    $keyResult = isset($globalVars[$hideSpec['key']]) ? $globalVars[$hideSpec['key']] : "";
                    if (in_array($keyResult, $hideSpec['keyResult'])) {
//                        cekBiru("HILANGKAN/HIDE kan");
                        if (isset($hideSpec['label']) && (sizeof($hideSpec['label']) > 0)) {
                            foreach ($hideSpec['label'] as $kk => $vv) {
                                if (isset($fixedElements['fixedElements']['contents'][$vv])) {
                                    $fixedElements['fixedElements']['contents'][$vv] = NULL;
                                    unset($fixedElements['fixedElements']['contents'][$vv]);
                                }
                            }
                        }
                    }
                }
            }

        }
        else {
            $fixedElements = array();
        }

//        arrPrint($fixedElements['fixedElements']);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion

        //region add fields2 main
        $addMainData2Fields = isset($this->config->item("heTransaksi_layout")[$this->jenisTr]["receiptAddMain"][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]["receiptAddMain"][$row->step_number] : array();
        $addMainData2 = array();
        if (sizeof($addMainData2Fields) > 0) {
            foreach ($addMainData2Fields as $keys => $keysLabel) {
                $addMainData2[$keys] = isset($globalVars[$keys]) ? $globalVars[$keys] : "";
            }
        }
        //endregion

        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }
        else {
            $in_word = "";
        }

        $in_word2 = "";

        if (sizeof($receiptInWordConfig2) > 0) {
            $this->load->helper("he_inword");

            foreach ($receiptInWordConfig2 as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {
                    $val_convert = $masterTableInValueParams[$fieldsSelected];
                    $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                    //                        $val_convert1=formatField("tagihan",$val_convert);
                    $val_convert1 = number_format(0 + $val_convert);

                    //                        echo $val_convert1;
                    $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                    //                        cekHitam($val_convert. " ||". $val_convert1);
                    $he_word2 = $he_loader($val_convert2, $currency);
                    //                        $he_word = $he_loader($val_convert, $currency);
                    $in_word2 .= "$he_word2";


                }
            }
        }
        else {
            $in_word = "";
        }


        //region load Mdl static note
        $this->load->model("Mdls/MdlStaticNotes");
        $sn = new MdlStaticNotes();
        $cbSelected = $globalVars['cabang_id'];
        $sn->addFilter("cabang_id=$cbSelected");
        $availNotes = $sn->lookupAll()->result();
        //        cekLime($this->db->last_query());
        $temNotes = array();
        if (sizeof($availNotes) > 0) {
            foreach ($availNotes as $tempNotes) {
                $jn = $tempNotes->jenis;
                $val = $tempNotes->nilai;
                $temNotes[$jn] = $val;

            }
        }
        //endregion

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : false;
        $listedDif = array("584");

        //region notes element
        //        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : "";
        if ($staticNotes) {
            if ($tmpTr[0]->jenis_master == "382") {
                $notesfill = $temNotes["382"];
            }
            else {
                $notesfill = $temNotes["582"];
            }

        }
        else {
            $notesfill = "";
        }

        $fixedElements['noteDetails'] = array();
        //        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";

        if (isset($globalVars['description'])) {
            $catatan = $globalVars['description'];
            $fixedElements['noteDetails']['contents'][] = $catatan;
        }
        if (isset($globalVars['description_additional']) && (sizeof($globalVars['description_additional']) > 0)) {
            $ii_rslt = "";
            foreach ($globalVars['description_additional'] as $ii => $iiVal) {
                if ($ii_rslt == "") {
                    $ii_rslt = "<br />" . $iiVal;
                }
                else {
                    $ii_rslt .= "<br />" . $iiVal;
                }
            }
            $catatan = $ii_rslt;
            $fixedElements['noteDetails']['contents'][] = $catatan;
        }

        $fixedElements['noteDetails']['contents'][] = "<br /><br />" . $notesfill;
        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number] : array();
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";

        //--------------------
        $receiptSumFieldsLayout = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receipSumFields'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receipSumFields'][$row->step_number] : array();
        $receiptSumFieldsLayoutReplacer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumReplacer']) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumReplacer'] : array();
        if (sizeof($receiptSumFieldsLayoutReplacer) > 0) {

        }
        //--------------------

        $data = array(
            //            "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $main,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "noteEnabled" => $noteEnabled,
            "items" => $items,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "itemsRegistries" => $itemsRegistries,
            "itemSrcLabel" => $itemSrcLabel,
            "itemSrc" => $itemSrc,
            "inWord" => $in_word,
            "inWord2" => $in_word2,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            "sumRows" => sizeof($receiptSumFieldsLayout) > 0 ? $receiptSumFieldsLayout : $receiptSumFields,
            "sumRows2" => $receiptSumFields2,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
            "mainData2Fields" => $addMainData2Fields,
            "mainData2" => $addMainData2,
        );
        //endregion


        $this->load->view("transaksi", $data);
    }

    public function viewReceiptCashIn()
    {

        //        die();
        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tr->addFilter("transaksi_data.trash='0'");
        $tmpTr = $tr->lookupJoined()->result();
        //        cekHitam($this->db->last_query());
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview

        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number <= 0 ? 1 : $tmpTr[0]->step_number;
            //cekHitam($currentStepNum);
            // $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            //            cekHitam($currentStepNum);
            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];
            //            $itemNumLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            // $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();

            //            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $pairReceiptItemRegistries = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries'] : array();
            $receiptDetailFields = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFields'][$currentStepNum] : array();
            $receiptDetailFields2 = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFields2'][$currentStepNum] : array();
            $receiptSumFields2 = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptOverWriteSum'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptOverWriteSum'][$currentStepNum] : $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptSumFields'][$currentStepNum];
            //           cekBiru($tmpTr[0]->jenis_master." ".$currentStepNum);
            //           arrPrint($receiptDetailFields);
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion

            //            cekHijau($receiptDetailFieldsReplacerConfig);


            //  take from transaksi top
            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("id='$topID'");
            $tmpTop = $tr->lookupMainTransaksi()->result();
            //            cekHere($this->db->last_query());


            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }

            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }

            //region take from registries
            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();

            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptSumFields = array();
            $itemsRegistries = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;

                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            $refIDs = implode("", $main['refIDs']);
            $itemsRegistries2 = array();
            $childTableInValueParams2 = array();
            $main2 = array();
            $tmpTri = array();
            if (strlen($refIDs) > 0) {
                $this->load->model("MdlTransaksi");
                $tri = new MdlTransaksi();
                $tri->addFilter("transaksi.id='" . $refIDs . "'");
                $tri->addFilter("transaksi_data.trash='0'");
                $tmpTri = $tri->lookupJoined()->result();

                if (isset($tmpTri[0]->counters)) {
                    $counterTrIDS = blobDecode($tmpTri[0]->counters);
                    foreach ($counterTrIDS as $key_d => $val_d) {
                        foreach ($val_d as $val_dd) {
                            $globalVars['countersTrIDS'][$key_d] = $val_dd;
                        }
                    }
                }

                $tmpReg2 = $tr->lookupRegistriesByMasterID($refIDs)->result();

                foreach ($tmpReg2 as $row2) {
                    switch ($row2->param) {
                        //                        case "receiptSumFields"://
                        //                            $receiptSumFields2 = unserialize(base64_decode($row2->values));
                        //                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams2 = unserialize(base64_decode($row2->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams2 = unserialize(base64_decode($row2->values));
                            break;
                        case "items"://
                            $itemsRegistries2 = unserialize(base64_decode($row2->values));
                            break;
                        case "main"://
                            $main2 = unserialize(base64_decode($row2->values));
                            break;

                    }
                }

            }
            //            arrPrint($main2);
            //            matiHere();
            $itemLabels = $receiptDetailFields;
            $itemLabels2 = $receiptDetailFields2;
            //            arrPrint($itemLabels2);
            foreach ($tmpTr as $row) {

                $id = $row->produk_id;
                $tmp = array();

                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row->$key) ? $row->$key : "";
                        }
                        $tmp[$key] = $colValue;
                        if (!isset($childTableInValueParams[$id][$key])) {
                            $childTableInValueParams[$id][$key] = $colValue;
                        }


                    }
                }

                //                if ($subAmountConfig != null) {
                //                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                //                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                //                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                //                } else {
                //                    $subtotal = 0;
                //                }
                //                $tmp["subtotal"] = $subtotal;
                //                arrPrint($tmp);
                //                arrPrint($childTableInValueParams[$id]);
                //                arrPrint($childTableInValueParams);
                //                arrPrint($tmp);
                $rawItems[$row->produk_id] = $tmp;
                $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));

                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        if (array_key_exists($key, $rawItems[$row->produk_id])) {
                            $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                        }
                    }
                }

                if (sizeof($pairReceiptItemRegistries) > 0) {
                    foreach ($pairReceiptItemRegistries as $k) {
                        $rawItems[$row->produk_id][$key] = isset($itemsRegistries[$row->produk_id][$k]) ? $itemsRegistries[$row->produk_id][$k] : "";
                    }
                }

                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }

            foreach ($tmpTri as $row2) {

                $id = $row2->produk_id;
                $tmp2 = array();

                if (sizeof($itemLabels2) > 0) {
                    foreach ($itemLabels2 as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row2->$key2) ? $row2->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row2->$key) ? $row2->$key : "";
                        }
                        $tmp2[$key] = $colValue;
                        if (!isset($childTableInValueParams2[$id][$key])) {
                            $childTableInValueParams2[$id][$key] = $colValue;
                        }


                    }
                }

                //                arrPrint($childTableInValueParams2[$id]);
                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams2[$id], $childTableInValueParams2[$id], 0);
                    //                    cekHere($subtotal);
                }
                else {
                    $subtotal = 0;
                }
                //                matiHere($subtotal);
                $tmp2["subtotal"] = $subtotal;
                //                arrPrint($tmp);
                //                arrPrint($childTableInValueParams[$id]);
                //                arrPrint($childTableInValueParams);
                //                arrPrint($tmp);
                $rawItems2[$row2->produk_id] = $tmp2;
                $rawItems2[$row2->produk_id] = array_replace(array_filter($childTableInValueParams2[$row2->produk_id]), array_filter($rawItems2[$row2->produk_id]));

                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        if (array_key_exists($key, $rawItems2[$row2->produk_id])) {
                            $rawItems2[$row->produk_id][$key] = isset($vSpec[$rawItems2[$row2->produk_id][$key]]) ? $vSpec[$rawItems2[$row2->produk_id][$key]] : "";
                        }
                    }
                }

                if (sizeof($pairReceiptItemRegistries) > 0) {
                    foreach ($pairReceiptItemRegistries as $k) {
                        $rawItems2[$row2->produk_id][$key] = isset($itemsRegistries2[$row2->produk_id][$k]) ? $itemsRegistries2[$row2->produk_id][$k] : "";
                    }
                }

                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems2[$row2->produk_id][$ak]) && is_numeric($rawItems2[$row2->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }

        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();

        $jenisTr = $this->jenisTr;
        $items = $rawItems;
        $items2 = $rawItems2;

        //        arrPrint($items2);
        //        die();
        //        $items=array_merge($items,$childTableInValueParams);


        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //         arrPrint($globalVars);
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                // cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHijau($relElementType);
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    // arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key ");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        //                                        cekKuning($key."||".$val);
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    // cekHitam($vTmp);
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }


        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);


        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        //        arrPrint($main2);
        if (isset($globalVars['nomer_top'])) {
            if (isset($globalVars['nomer_top'])) {
                $globalVars['nomer_top'] = $main2['nomer'];
                $globalVars['payment_method'] = $main2['paymentMethod__name'];
                //                $globalVars['nomer_top']= $main2['nomer'];
            }
            //            arrPrint($globalVars['countersTrIDS']);
            //            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            // $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            // $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
            $num_top = showHistoriGlobalNumbers($globalVars["ids_his"], 1);//tak matiin
            $addTrIdCounter = isset($globalVars['countersTrIDS']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrIDS']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTrIdCounter;
        }


        if (isset($globalVars["ids_his"])) {
            $stepPrev = $globalVars["step_number"] - 1;
            if ($stepPrev > 0) {
                // $cHist = blobDecode($globalVars["ids_his"])[$stepPrev];
                // $counterhists = blobDecode($cHist["counters"]);
                // $cNomer = $cHist["nomer"];
                // $cNomerExpl = explode(".", $cNomer);
                // $cTrcode = $cNomerExpl[0];
                // $cTrplace = $cNomerExpl[1];
                // $cgJenis = "$cTrcode|$cTrplace";
                //
                // $cgHist = digit_5($counterhists["stepCode|placeID"]["$cgJenis"]);
                //
                // $nomer_prev = $cNomer . "-" . $cgHist;

                // $globalVars['nomers_prev'] = formatField("nomer", $nomer_prev);
                $globalVars['nomers_prev'] = showHistoriGlobalNumbers($globalVars["ids_his"], $stepPrev, true);
            }
        }


        // arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        //        arrPrint($masterTableInValueParams);
        //        arrPrint($masterTableInValueParams);
        $dpValueDetails = array();
        $dpFieldName = array();
        if (isset($masterTableInValueParams2['dp_value']) && $masterTableInValueParams2['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams2['dp_value'],
                "ppn_dp" => $masterTableInValueParams2['dp_ppn_value'],
                "dp" => $masterTableInValueParams2['dp'],
                //                "due_amount" => $masterTableInValueParams2['tagihan'],
            );

            $dpFieldName = array(
                "dpp_dp" => "Downpayment",
                "ppn_dp" => "vat (10%)",
                "dp" => "Total Downpayment",
                //                "due_amount" => "Due amount",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        //       arrPrint($fixedSignConfig);
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();

        if (sizeof($elementFixedConfig) > 0) {


            foreach ($elementFixedConfig as $key => $label) {
                //                cekHitam($key);
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];

            }


        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion


        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }
        else {
            $in_word = "";
        }

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : "";

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";
        //        $fixedElements['noteDetails']['label'] = "NOTES" . " <span class='text-white'>$trID</span>";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        $itemLabels2 = $itemLabels2 + array("sub_nett1" => "Total Price");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number] : array();
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : $this->uri->segment(2);


        $data = array(
            //            "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            //            "mainValues" => $mainValues,
            //            "detailValues" => $detailValues,
            "mainValues" => $main,
            "mainValues2" => $main2,
            //            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,
            //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            //            "itemLabels" => $itemLabels + $itemNumLabels,
            "itemLabels" => $itemLabels2,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "noteEnabled" => $noteEnabled,
            "items" => $items2,
            "items2" => $items2,
            "itemsRegistries" => $itemsRegistries,
            "inWord" => $in_word,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            //            "sumRows" => $receiptSumFields,
            "sumRows" => $receiptSumFields2,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            //            "dataTemp" => $dataTemp,
            //            "fixedElements" => $fixedElements,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
        );
        //endregion

        //        arrPrint($globalVars);
        $this->load->view("transaksi", $data);

    }

    public function viewReceiptProduksi__()
    {

        //        die();
        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview

        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number <= 0 ? 1 : $tmpTr[0]->step_number;


            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];
            $itemLabelsConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$currentStepNum];
            $itemLabelsConfig2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$currentStepNum];
            $itemLabelsConfig3 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$currentStepNum];

            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields3'][$currentStepNum])) {
                $itemNumLabels3 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields3'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$currentStepNum])) {
                $itemNumLabels3 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$currentStepNum];
            }
            else {
                $itemNumLabels3 = array();
            }

            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $pairReceiptItemRegistries = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries'] : array();

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion


            //  take from transaksi top
            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("id='$topID'");
            $tmpTop = $tr->lookupMainTransaksi()->result();


            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }
            // arrPrint($globalVars);
            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }
            //region take from registries

            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();


            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items3_sum"://
                            $items3_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;

                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion


            //            $itemLabels = $receiptDetailFields;
            //            $itemLabels2 = $receiptDetailFields2;
            $itemLabels = $itemLabelsConfig;
            $itemLabels2 = $itemLabelsConfig2;
            $itemLabels3 = $itemLabelsConfig3;
            foreach ($tmpTr as $row) {

                $id = $row->produk_id;
                $tmp = array();

                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row->$key) ? $row->$key : "";
                        }
                        $tmp[$key] = $colValue;
                        if (!isset($childTableInValueParams[$id][$key])) {
                            $childTableInValueParams[$id][$key] = $colValue;
                        }


                    }
                }


                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }

                $tmp["subtotal"] = $subtotal;

                $rawItems[$row->produk_id] = $tmp;


                $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));


                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        if (array_key_exists($key, $rawItems[$row->produk_id])) {
                            $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                        }
                    }
                }

                if (sizeof($pairReceiptItemRegistries) > 0) {
                    foreach ($pairReceiptItemRegistries as $k) {
                        $rawItems[$row->produk_id][$key] = isset($itemsRegistries[$row->produk_id][$k]) ? $itemsRegistries[$row->produk_id][$k] : "";
                    }
                }

                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }
        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //                arrPrint($mainProp);
        //                die("0000");
        //        $globalVars = $globalVars + (array)$mainProp;

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //         arrPrint($globalVars);
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                // cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHijau($relElementType);
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    // arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key ");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        //                                        cekKuning($key."||".$val);
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    // cekHitam($vTmp);
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }


        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);


        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        if (isset($globalVars['nomer_top'])) {
            //            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
        }


        if (isset($globalVars["ids_his"])) {
            $stepPrev = $globalVars["step_number"] - 1;
            if ($stepPrev > 0) {
                $cHist = blobDecode($globalVars["ids_his"])[$stepPrev];
                $counterhists = blobDecode($cHist["counters"]);
                $cNomer = $cHist["nomer"];
                $cNomerExpl = explode(".", $cNomer);
                $cTrcode = $cNomerExpl[0];
                $cTrplace = $cNomerExpl[1];
                $cgJenis = "$cTrcode|$cTrplace";

                $cgHist = digit_5($counterhists["stepCode|placeID"]["$cgJenis"]);

                $nomer_prev = $cNomer . "-" . $cgHist;

                $globalVars['nomers_prev'] = formatField("nomer", $nomer_prev);
            }
        }


        // arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        //        arrPrint($masterTableInValueParams);
        $dpValueDetails = array();
        $dpFieldName = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                "due_amount" => $masterTableInValueParams['tagihan'],
            );

            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "vat Dp",
                "dp" => "Downpayment",
                "due_amount" => "Due amount",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        // arrPrint($elementFixedConfig);

        //        arrPrint($globalVars);
        //        die();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                //                cekHere($key);
                //                cekHere($globalVars[$key]);
            }
        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion


        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }
        else {
            $in_word = "";
        }

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : "";

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";
        //        $fixedElements['noteDetails']['label'] = "NOTES" . " <span class='text-white'>$trID</span>";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");
        $itemLabels3 = $itemLabels3 + $itemNumLabels3 + array("subtotal" => "Total Price");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
            unset($itemLabels3['subtotal']);
        }
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number] : array();
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";

        $data = array(
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $main,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "itemLabels3" => isset($itemLabels3) ? $itemLabels3 : array(),
            "noteEnabled" => $noteEnabled,
            //            "items" => $items,
            "items" => $itemsRegistries,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "items3" => isset($items3_sumRegistries) ? $items3_sumRegistries : array(),
            "itemsRegistries" => $itemsRegistries,
            "items3Registries" => $items3_sumRegistries,
            "inWord" => $in_word,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,

            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",

            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,

            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "tempData" => isset($tempData) ? $tempData : array(),
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
        );
        //endregion

        //        arrPrint($itemsRegistries);
        $this->load->view("transaksi", $data);

    }

    public function viewReceiptOpname()
    {


        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tr->addFilter("transaksi_data.trash='0'");
        $tmpTr = $tr->lookupJoined()->result();
        //        cekHitam($this->db->last_query());
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview

        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number <= 0 ? 1 : $tmpTr[0]->step_number;
            $mainJenis = $tmpTr[0]->transaksi_jenis2;


            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];

            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }


            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $pairReceiptItemRegistries = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries'] : array();

            $itemLabelsConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$currentStepNum];
            $itemLabelsConfig2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum] : isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$currentStepNum] : array();
            $itemLabelsConfig3 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum] : isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$currentStepNum] : array();

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion


            //  take from transaksi top
            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("id='$topID'");
            $tmpTop = $tr->lookupMainTransaksi()->result();


            $id_prevs = $tmpTr[0]->ids_prev;
            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }

            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }
            //region take from registries


            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();
            $rsltItemsRegistries = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems"://
                            $rsltItemsRegistries = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            //arrPrint($itemNumLabels);
            //arrPrint($itemsRegistries);
            //            $itemLabels = $receiptDetailFields;
            //            $itemLabels2 = $receiptDetailFields2;
            $itemLabels = $itemLabelsConfig;
            $itemLabels2 = $itemLabelsConfig2;
            $itemsReg = sizeof($rsltItemsRegistries) > 0 ? $rsltItemsRegistries : $itemsRegistries;
            $itemsRegs = sizeof($rsltItemsRegistries) > 0 ? true : false;

            if ($mainJenis == "paket") {
                //                arrPrint($itemLabels);
                $rawItems[] = array(
                    "produk_kode" => "",
                    "produk_nama" => $tmpTr[0]->transaksi_jenis2_label,
                    "nett1" => $main['new_net1'],
                    "subtotal" => $main['grand_total_ui'],
                );
            }
            else {
                //                foreach ($tmpTr as $row) {
                foreach ($itemsReg as $ctr => $row) {
                    //                    $id = $row->produk_id;
                    $id = $row['id'];
                    $row['produk_id'] = $id;
                    //                    $rowCtr = $id;
                    $rowCtr = $ctr;
                    //                    arrPrint($itemsRegistries[$id]);
                    if ($itemsRegs == true) {
                        $row['qty_kredit'] = $row['qty'];
                    }
                    //                    arrPrint($row);
                    $tmp = array();
                    if (sizeof($itemsRegistries[$id]) > 0) {
                        foreach ($itemsRegistries[$id] as $k_items => $v_items) {
                            if (!isset($row[$k_items])) {
                                //                                cekHere(" mengisi $k_items dengan $v_items");
                                $row[$k_items] = $v_items;
                            }
                        }
                    }

                    if (sizeof($itemLabels) > 0) {
                        foreach ($itemLabels as $key => $val) {
                            if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                                $chars = explode("+", $key);
                                $colValue = "";
                                foreach ($chars as $key2) {
                                    $colValue .= isset($row[$key2]) ? $row[$key2] . "<br>" : "";
                                }
                            }
                            else {
                                $colValue = isset($row[$key]) ? $row[$key] : "";
                                //                                $colValue = isset($row->$key) ? makeValue($key, (array)$row, (array)$row, 0) : "";
                            }
                            $tmp[$key] = $colValue;
                            if (!isset($childTableInValueParams[$id][$key])) {
                                $childTableInValueParams[$id][$key] = $colValue;
                            }
                        }
                    }
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $val) {
                            $tmp[$key] = makeValue($key, $row, $row, 0);
                        }
                    }

                    if ($subAmountConfig != null) {
                        //                        $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                        //                        $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                        //                        $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                        $subtotal = makeValue($subAmountConfig, $row, $row, 0);
                    }
                    else {
                        $subtotal = 0;
                    }

                    $tmp["subtotal"] = $subtotal;
                    //arrPrint($tmp);
                    //                    $rawItems[$row['produk_id']] = $tmp;
                    //                    $rawItems[$row['produk_id']] = array_replace(array_filter($childTableInValueParams[$row['produk_id']]), array_filter($rawItems[$row['produk_id']]));
                    $rawItems[$rowCtr] = $tmp;
                    //                    $rawItems[$rowCtr] = array_replace(array_filter($childTableInValueParams[$row['produk_id']]), array_filter($rawItems[$row['produk_id']]));
                    //                    $rawItems[$rowCtr] = array_replace(array_filter($childTableInValueParams[$row['produk_id']]), array_filter($rawItems[$row['produk_id']]));

                    if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                        foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                            if (array_key_exists($key, $rawItems[$row['produk_id']])) {
                                $rawItems[$rowCtr][$key] = isset($vSpec[$rawItems[$row['produk_id']][$key]]) ? $vSpec[$rawItems[$row['produk_id']][$key]] : "";
                            }
                        }
                    }

                    foreach ($availValueKeys as $ak) {

                        if (isset($rawItems[$rowCtr][$ak]) && is_numeric($rawItem[$rowCtr][$ak])) {
                            $valueKey = $ak;
                        }
                        else {
                        }
                    }
                }
            }
        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;

        foreach ($rawItems as $pid => $specs) {
            if (($specs['qty_debet'] > 0) || ($specs['qty_kredit'] > 0)) {
                $items[$pid] = $specs;
            }
        }
        //arrPrint($items);


        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //                arrPrint($mainProp);
        //                die("0000");
        //        $globalVars = $globalVars + (array)$mainProp;

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //         arrPrint($globalVars);
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                // cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHijau($relElementType);
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    // arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key ");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        //                                        cekKuning($key."||".$val);
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    // cekHitam($vTmp);
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }


        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);


        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        if (isset($globalVars['nomer_top'])) {
            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
            // $num_top = showHistoriGlobalNumbers($globalVars["ids_his"],1);
            // $globalVars['nomer_top'] = $num_top."**";
        }
        else {
            $globalVars['nomer_top'] = "-";
        }


        if (isset($globalVars["ids_his"])) {
            $stepPrev = $globalVars["step_number"] - 1;
            if ($stepPrev > 0) {
                // $cHist = blobDecode($globalVars["ids_his"])[$stepPrev];
                // $counterhists = blobDecode($cHist["counters"]);
                // $cNomer = $cHist["nomer"];
                // $cNomerExpl = explode(".", $cNomer);
                // $cTrcode = $cNomerExpl[0];
                // $cTrplace = $cNomerExpl[1];
                // $cgJenis = "$cTrcode|$cTrplace";
                //
                // $cgHist = digit_5($counterhists["stepCode|placeID"]["$cgJenis"]);
                //
                // $nomer_prev = $cNomer . "-" . $cgHist;

                // $globalVars['nomers_prev'] = formatField("nomer", $nomer_prev);

                //                arrPrint($stepPrev);
                $globalVars['nomers_prev'] = showHistoriGlobalNumbers($globalVars["ids_his"], $stepPrev, true);
            }
            else {
                $globalVars['nomers_prev'] = "-";
            }
        }
        else {
            $ids_prev = blobDecode($tmpTr[0]->ids_prev);
            // arrPrint($tmpTr[0]->ids_prev);
            $trx = new MdlTransaksi();
            $trx->setFilters(array());
            $trx->addFilter("id='" . $ids_prev[0] . "'");
            $tmpTrx = $trx->lookupMainTransaksi()->result();
            $counterTrID = blobDecode($tmpTrx[0]->counters);
            foreach ($counterTrID as $key_d => $val_d) {
                foreach ($val_d as $val_dd) {
                    $tmpTrx['countersTrID'][$key_d] = $val_dd;
                }
            }
            //            arrPrint($tmpTrx);
            $addTrIdCounter = isset($tmpTrx['countersTrID']['stepCode|placeID']) ? "-" . digit_5($tmpTrx['countersTrID']['stepCode|placeID']) : "";
            //            cekHere($addTrIdCounter);
            $globalVars['nomers_prev'] = isset($tmpTrx[0]->nomer) ? formatField("nomer", $tmpTrx[0]->nomer . $addTrIdCounter) : "-";
        }


        // arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        //        arrPrint($masterTableInValueParams);
        $dpValueDetails = array();
        $dpFieldName = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                "due_amount" => $masterTableInValueParams['tagihan'],
            );

            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "vat Dp",
                "dp" => "Downpayment",
                "due_amount" => "Due amount",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        // arrPrint($elementFixedConfig);

        //        arrPrint($globalVars);
        //        die();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                //                cekHere($key);
                //                cekHere($globalVars[$key]);
            }
        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion


        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }
        else {
            $in_word = "";
        }

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$tmpTr[0]->step_number] : "";

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";
        //        $fixedElements['noteDetails']['label'] = "NOTES" . " <span class='text-white'>$trID</span>";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$tmpTr[0]->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$tmpTr[0]->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$tmpTr[0]->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
            //            cekHere(":: buang subtotal");
        }
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$tmpTr[0]->step_number] : array();
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";
        //arrPrint($itemLabels);

        $data = array(
            "mode" => "viewReceiptOpname",
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $main,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "noteEnabled" => $noteEnabled,
            "items" => $items,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "itemsRegistries" => $itemsRegistries,
            "inWord" => $in_word,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "tempData" => $tempData,
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
        );
        //endregion

        //        arrPrint($items);

        $this->load->view("transaksi", $data);

    }

    public function viewReceipt__()
    {

        //        die();
        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview
        //        cekHitam("cetak TMPR");
        //                arrPrint($tmpTr);
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number == 0 ? 1 : $tmpTr[0]->step_number;

            // $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            //            cekHitam($currentStepNum);
            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];
            //            $itemNumLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            // $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();

            //            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;


            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion

            //            cekHijau($receiptDetailFieldsReplacerConfig);

            //region take from registries
            //==ambil value-gate
            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;

                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            //die();
            $itemLabels = $receiptDetailFields;
            $itemLabels2 = $receiptDetailFields2;
            foreach ($tmpTr as $row) {

                $id = $row->produk_id;
                $tmp = array();

                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row->$key) ? $row->$key : "";
                        }
                        $tmp[$key] = $colValue;
                        if (!isset($childTableInValueParams[$id][$key])) {
                            $childTableInValueParams[$id][$key] = $colValue;
                        }


                    }
                }

                //                arrPrint($subAmountConfig);
                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }


                $tmp["subtotal"] = $subtotal;


                $rawItems[$row->produk_id] = $tmp;

                //                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));
                $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));
                // arrPrint($rawItems);

                //arrPrint($receiptDetailFieldsReplacerConfig);
                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        if (array_key_exists($key, $rawItems[$row->produk_id])) {
                            $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                        }
                    }
                }

                //                arrprint($rawItems[$row->produk_id]);
                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }
        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;
        //        $items=array_merge($items,$childTableInValueParams);
        //        arrprint($items);

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //                arrPrint($mainProp);
        //        $globalVars = $globalVars + (array)$mainProp;

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //endregion
        //        arrPrint($masterTableInParams);
        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion

        //        arrPrint($mainElements);

        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                //                cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? unserialize(base64_decode($val)) : "-";
                                    //                                   arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? unserialize(base64_decode($val)) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }
        //arrPrint($elementsGate);
        //        $globalVars = $globalVars + $arrCompanyProfile + $masterTableInParams;
        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);

        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        //       arrPrint($elementFixedConfig);
        // arrPrint($globalVars);
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                //                cekHere($key);
                //                cekHere($globalVars[$key]);
            }
        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion
        //                arrPrint($receiptGlobalConfig);
        //        arrPrint($receiptSumFields);
        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    $val_convert = $masterTableInValueParams[$fieldsSelected];
                    //                arrPrint($masterTableInValueParams);
                    $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "un-define";
                    $he_word = $he_loader($val_convert, $currency);
                    $in_word .= "$he_word";
                }
            }
            //            $inword['inWord'] =$in_word;
        }
        else {
            $in_word = "";
        }
        //arrPrint($globalVars);
        //        arrPrint($masterTableInParams);

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : "";

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";
        $fixedElements['noteDetails']['label'] = "NOTES" . " <span class='hidden'>#$trID</span>";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";
        //arrPrint($globalVars);
        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }
        // arrprint($elements);die();

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        //        $temp = array(
        //            "mode" => $this->uri->segment(2),
        //            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
        //            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
        //            "jenisTr" => $jenisTr,
        //            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
        //            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
        //            "main" => $mainProp,
        //            "mainValues" => $mainValues,
        //            "detailValues" => $detailValues,
        //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
        //            "items" => $items,
        //            "items2" => $items2,
        //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
        //            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
        //            "mainAddValues" => $masterAddValues,
        //            "mainAddFields" => $masterAddFields,
        //            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
        //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
        //            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
        //            "signature" => $signValues,
        //            "companyProfile" => $arrCompanyProfile,
        //            "mainElements" => $elements,
        //            "footer" => $footer,
        //            "fixedElements" => $fixedElements,
        //        );

        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        //        arrPrint($itemSubTotal);
        // $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "Total Price");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");

        //        echo $row->step_number;

        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }

        //        arrprint($itemLabels);


        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";
        $tempData = array(
            //            "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            //            "mainValues" => $mainValues,
            //            "detailValues" => $detailValues,

            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,


            //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            //            "itemLabels" => $itemLabels + $itemNumLabels,
            "itemLabels" => $itemLabels,
            "items" => $items,
            "items2" => $items2,
            "itemsRegistries" => $itemsRegistries,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            //            "dataTemp" => $dataTemp,
            //            "fixedElements" => $fixedElements,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
        );
        //        arrPrint($receiptSumFields);
        //        arrPrint($main);
        //        arrPrint($this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"]);


        $data = array(
            //            "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            //            "mainValues" => $mainValues,
            //            "detailValues" => $detailValues,

            "mainValues" => $main,
            //            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,


            //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            //            "itemLabels" => $itemLabels + $itemNumLabels,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "noteEnabled" => $noteEnabled,
            "items" => $items,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "itemsRegistries" => $itemsRegistries,
            "inWord" => $in_word,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            //            "dataTemp" => $dataTemp,
            //            "fixedElements" => $fixedElements,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "tempData" => $tempData,
        );


        //endregion

        //        arrPrint($data);
        $this->load->view("transaksi", $data);

    }

    public function viewReceiptBT()
    {
        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;

            //            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;


            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion

            //region take from registries
            //==ambil value-gate
            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            //arrPrint($tmpTr);


            $itemLabels = $receiptDetailFields;
            foreach ($tmpTr as $row) {

                $id = $row->produk_id;
                $tmp = array();

                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row->$key) ? $row->$key : "";
                        }
                        $tmp[$key] = $colValue;
                        if (!isset($childTableInValueParams[$id][$key])) {
                            $childTableInValueParams[$id][$key] = $colValue;
                        }


                    }
                }

                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }


                $tmp["subtotal"] = $subtotal;


                $rawItems[$row->produk_id] = $tmp;

                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));

                //arrPrint($receiptDetailFieldsReplacerConfig);
                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        //                        cekHere(":: siap siap...");
                        if (array_key_exists($key, $rawItems[$row->produk_id])) {
                            $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                        }
                    }
                }

                //                arrprint($rawItems[$row->produk_id]);
                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }
        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion

        //        arrprint($availValueKeys);
        //        echo($valueKey);

        //arrprint($childTableInValueParams);
        //        arrprint($rawItems);

        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;
        //        $items=array_merge($items,$childTableInValueParams);
        //        arrprint($items);

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        $globalVars = $globalVars + (array)$mainProp;
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion

        //        arrprint($itemLabels);
        //        arrprint($items);
        //        arrprint($rawItems);
        //        die();
        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                switch ($elementType) {
                    case "dataModel":
                        foreach ($eSpec as $key => $val) {
                            if ($key == "contents") {
                                $vTmp = $val != null ? unserialize(base64_decode($val)) : "-";
                            }
                            else {
                                $vTmp = $val != null ? $val : "-";
                            }
                            $eTmp[$key] = $vTmp;
                            if (is_array($vTmp)) {
                                foreach ($vTmp as $key => $val) {
                                    $elementsGate[$eKey . "_$key"] = $val;
                                }
                            }
                            else {
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                        }

                        break;
                    case "dataField":
                        $eTmp = array();
                        foreach ($eSpec as $key => $val) {
                            $vTmp = $val != null ? $val : "-";
                            $eTmp[$key] = $vTmp;
                            $eTmp['contents']['nama'] = $eSpec['value'];
                            $elementsGate[$eKey . "_$key"] = $vTmp;
                        }
                        break;
                }
                $elements[$eKey] = $eTmp;
            }
        }

        $globalVars = $globalVars + $arrCompanyProfile;
        if (isset($elementsGate)) {
            $globalVars = $globalVars + $elementsGate;
        }

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? $globalVars[$key] : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
            }
        }
        else {
            $fixedElements = array();
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();
        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];
            foreach ($globalVars as $key => $val) {
                $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
            }
            $companyProfile['companyProfile']['contents'][] = $companyStr;
        }
        //endregion

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] : "-";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }
        // arrprint($elements);die();

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        //        $temp = array(
        //            "mode" => $this->uri->segment(2),
        //            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
        //            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
        //            "jenisTr" => $jenisTr,
        //            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
        //            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
        //            "main" => $mainProp,
        //            "mainValues" => $mainValues,
        //            "detailValues" => $detailValues,
        //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
        //            "items" => $items,
        //            "items2" => $items2,
        //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
        //            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
        //            "mainAddValues" => $masterAddValues,
        //            "mainAddFields" => $masterAddFields,
        //            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
        //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
        //            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
        //            "signature" => $signValues,
        //            "companyProfile" => $arrCompanyProfile,
        //            "mainElements" => $elements,
        //            "footer" => $footer,
        //            "fixedElements" => $fixedElements,
        //        );


        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        //        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][[$row->step_number]] == true) {
            unset($itemLabels['subtotal']);
            //            unset($itemLabels2['subtotal']);
        }

        //        arrprint($itemLabels);


        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";

        $data = array(
            //            "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            //            "mainValues" => $mainValues,
            //            "detailValues" => $detailValues,

            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,


            //            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            //            "itemLabels" => $itemLabels + $itemNumLabels,
            "itemLabels" => $itemLabels,
            "items" => $items,
            "items2" => $items2,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            //            "grandTotal"     => isset($masterGates['grand_total']) ? $masterGates['grand_total'] : 0,
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,
            //            "dataTemp" => $dataTemp,
            //            "fixedElements" => $fixedElements,
            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
        );


        //endregion


        $this->load->view("transaksi", $data);

    }

    public function viewSmallReceipt()
    {

        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion

        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion
        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {

            //            arrPrint($tmpTr);

            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $paymentMethod = $tmpTr[0]->pembayaran_sys;

            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();

            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }

            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //endregion

            //region take from registries
            //==ambil value-gate
            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }


            //            arrPrint($masterGates);

            //endregion
            foreach ($tmpTr as $row) {
                $id = $row->produk_id;
                $tmp = array();
                foreach ($itemLabels as $key => $val) {

                    if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                        $chars = explode("+", $key);
                        $colValue = "";
                        foreach ($chars as $key2) {
                            //                            $colValue .= isset($row->$key2) ? formatField($key, $row->$key2) . "<br>" : "";
                        }
                        //                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {
                        //                        $colValue = isset($row->$key) ? formatField($key, $row->$key) : "";
                        $colValue = isset($row->$key) ? $row->$key : "";
                    }

                    //                            $tmp[$key]=isset($iSpec[$val])?$iSpec[$val]:0;
                    //                        if (isset($detailValues[$row->produk_id][$key])) {
                    //                            $fieldValue = $detailValues[$row->produk_id][$key];
                    //                        } else {
                    //                            if (isset($row->$key)) {
                    //                                $fieldValue = $row->$key;
                    //                            }
                    //                        }

                    //                        $tmp[$key] = formatField($key, $fieldValue);
                    //                        $tmp[$key] = $fieldValue;
                    $tmp[$key] = $colValue;
                    if (!isset($childTableInValueParams[$id][$key])) {
                        $childTableInValueParams[$id][$key] = $colValue;
                    }
                }

                //region calculate subtotal
                //===perhitungan subtotal


                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }
                $tmp["subtotal"] = $subtotal;
                //endregion
                $rawItems[$row->produk_id] = $tmp;
                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));

                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }

        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }
        //endregion

        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        $globalVars = $globalVars + (array)$mainProp;
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion

        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                switch ($elementType) {
                    case "dataModel":
                        foreach ($eSpec as $key => $val) {
                            if ($key == "contents") {
                                $vTmp = $val != null ? unserialize(base64_decode($val)) : "-";
                            }
                            else {
                                $vTmp = $val != null ? $val : "-";
                            }
                            $eTmp[$key] = $vTmp;


                            if (is_array($vTmp)) {
                                foreach ($vTmp as $key => $val) {
                                    $elementsGate[$eKey . "_$key"] = $val;
                                }
                            }
                            else {
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                        }

                        break;
                    case "dataField":
                        $eTmp = array();
                        foreach ($eSpec as $key => $val) {
                            $vTmp = $val != null ? $val : "-";

                            $eTmp[$key] = $vTmp;
                            $eTmp['contents']['nama'] = $eSpec['value'];

                            $elementsGate[$eKey . "_$key"] = $vTmp;
                        }
                        break;
                }
                $elements[$eKey] = $eTmp;
            }
        }

        $globalVars = $globalVars + $elementsGate + $arrCompanyProfile;
        $globalVars = $globalVars + $arrCompanyProfile;
        if (isset($elementsGate)) {
            $globalVars = $globalVars + $elementsGate;
        }

        //        region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //        //endregion

        //        region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? $globalVars[$key] : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
            }
        }
        else {
            $fixedElements = array();
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();
        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];
            foreach ($globalVars as $key => $val) {
                $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
            }
            $companyProfile['companyProfile']['contents'][] = $companyStr;
        }
        //        endregion

        //        region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] : "-";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //        endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['staticFooter']) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['staticFooter'] : "";

        //region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();


        //$main = array_merge(array_filter((array)$mainProp), array_filter($masterTableInParams), array_filter($masterTableInValueParams), array_filter($main));

        $temp = array(
            "mode" => $this->uri->segment(2),
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $mainValues,
            "detailValues" => $detailValues,
            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            "items" => $items,
            "items2" => $items2,
            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "footer" => $footer,
        );
        //        arrPrint($mainProp);
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceiptBT";
        $data = array(
            //                        "mode"       => $this->uri->segment(2),
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            "items" => $items,
            "items2" => $items2,
            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumBottom" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumBottom']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumBottom'] : array(),
            "headerTablesSmall" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['headerTablesSmall']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['headerTablesSmall'] : array(),
            "receiptNonTunai" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptNonTunai']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptNonTunai'] : array(),
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "masterGates" => $masterGates,
            "signHeader" => $signHeader,
            "valueKey" => $valueKey,
            "temp" => $temp,
        );
        //endregion
        $this->load->view("transaksi", $data);

    }

    // viewReceipt ini dipakai untuk produksi/convertion, semua yang ditampilkan diambil dari registry...
    public function viewReceiptProduksi()
    {

        //        die();
        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $valas = array();

        if (isset($_GET['type'])) {

        }

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion


        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $availValueKeys = array(
            "harga_nppn",
            "harga_nett3",
            "harga",
            "harga_nett1",
            "harga_nett2",
            "harga_nett",
            "nett",
            "nett1",
            "nett2",
        );
        $valueKey = "";
        $rawItems = array();
        //region detail elements of preview

        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number <= 0 ? 1 : $tmpTr[0]->step_number;


            $itemNumLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipNumFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum];
            $itemLabelsConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$currentStepNum];
            $itemLabelsConfig2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum] : isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$currentStepNum] : array();
            $itemLabelsConfig3 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum] : isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$currentStepNum] : array();

            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields2'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum])) {
                $itemNumLabels2 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum];
            }
            else {
                $itemNumLabels2 = array();
            }
            if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields3'][$currentStepNum])) {
                $itemNumLabels3 = $this->config->item('heTransaksi_layout')[$this->jenisTr]['receipCartNumFields3'][$currentStepNum];
            }
            elseif (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$currentStepNum])) {
                $itemNumLabels3 = $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$currentStepNum];
            }
            else {
                $itemNumLabels3 = array();
            }

            $subAmountConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['subAmountValue'][$currentStepNum] : null;
            $receiptDetailFieldsReplacerConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptDetailFieldsReplacer'] : null;
            $receiptInWordConfig = isset($this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word']) ? $this->config->item('heTransaksi_layout')[$tmpTr[0]->jenis_master]['receiptInword'][$currentStepNum]['in_word'] : array();
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $pairReceiptItemRegistries = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['pairReceiptItemRegistries'] : array();

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //endregion


            //  take from transaksi top
            $tr = new MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("id='$topID'");
            $tmpTop = $tr->lookupMainTransaksi()->result();


            if (sizeof($tmpTop)) {
                if (isset($tmpTop[0]->counters)) {
                    $counterTop = blobDecode($tmpTop[0]->counters);
                    foreach ($counterTop as $c_key => $c_val) {
                        foreach ($c_val as $cc_val) {
                            $globalVars['countersTop'][$c_key] = $cc_val;
                        }
                    }
                }
            }
            // arrPrint($globalVars);
            if (isset($tmpTr[0]->counters)) {
                $counterTrID = blobDecode($tmpTr[0]->counters);
                foreach ($counterTrID as $key_d => $val_d) {
                    foreach ($val_d as $val_dd) {
                        $globalVars['countersTrID'][$key_d] = $val_dd;
                    }
                }
            }
            //region take from registries

            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            $receiptDetailFields = array();
            $receiptSumFields = array();
            $receiptDetailFields2 = array();
            $receiptSumFields2 = array();
            $itemsRegistries = array();


            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields2"://
                            $receiptDetailFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields2"://
                            $receiptSumFields2 = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $itemsRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2Registries = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "items3_sum"://
                            $items3_sumRegistries = unserialize(base64_decode($row->values));
                            break;
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;

                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion


            //            $itemLabels = $receiptDetailFields;
            //            $itemLabels2 = $receiptDetailFields2;
            //            $itemLabels3 = $receiptDetailFields3;
            $itemLabels = $itemLabelsConfig;
            $itemLabels2 = $itemLabelsConfig2;
            $itemLabels3 = $itemLabelsConfig3;
            foreach ($tmpTr as $row) {

                $id = $row->produk_id;
                $tmp = array();

                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                            $chars = explode("+", $key);
                            $colValue = "";
                            foreach ($chars as $key2) {
                                $colValue .= isset($row->$key2) ? $row->$key2 . "<br>" : "";
                            }
                        }
                        else {
                            $colValue = isset($row->$key) ? $row->$key : "";
                        }
                        $tmp[$key] = $colValue;
                        if (!isset($childTableInValueParams[$id][$key])) {
                            $childTableInValueParams[$id][$key] = $colValue;
                        }


                    }
                }


                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }

                $tmp["subtotal"] = $subtotal;

                $rawItems[$row->produk_id] = $tmp;


                $rawItems[$row->produk_id] = array_replace(array_filter($childTableInValueParams[$row->produk_id]), array_filter($rawItems[$row->produk_id]));


                if ((is_array($receiptDetailFieldsReplacerConfig) && (sizeof($receiptDetailFieldsReplacerConfig) > 0))) {
                    foreach ($receiptDetailFieldsReplacerConfig as $key => $vSpec) {
                        if (array_key_exists($key, $rawItems[$row->produk_id])) {
                            $rawItems[$row->produk_id][$key] = isset($vSpec[$rawItems[$row->produk_id][$key]]) ? $vSpec[$rawItems[$row->produk_id][$key]] : "";
                        }
                    }
                }

                if (sizeof($pairReceiptItemRegistries) > 0) {
                    foreach ($pairReceiptItemRegistries as $k) {
                        $rawItems[$row->produk_id][$key] = isset($itemsRegistries[$row->produk_id][$k]) ? $itemsRegistries[$row->produk_id][$k] : "";
                    }
                }

                foreach ($availValueKeys as $ak) {
                    //                        echo "checking $ak: ";
                    if (isset($rawItems[$row->produk_id][$ak]) && is_numeric($rawItems[$row->produk_id][$ak])) {
                        //                        echo "ada ";
                        $valueKey = $ak;
                    }
                    else {
                        //                        echo "none ";
                    }
                }

            }
        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }

        //endregion


        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //                arrPrint($mainProp);
        //                die("0000");
        //        $globalVars = $globalVars + (array)$mainProp;

        $globalVars = array_merge($globalVars, (array)$mainProp);
        //         arrPrint($globalVars);
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion


        $relElementConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relElementData = array();
        if (sizeof($relElementConfig) > 0) {
            foreach ($relElementConfig as $tempRel) {
                foreach ($tempRel as $relKey => $relTemp) {
                    //                    cekHitam($relKey);
                    //                    $relElemenType=$relTemp;
                    foreach ($relTemp as $rKey => $rTemp) {
                        //                        $relElemenType[$relKey][$rKey]=$rTemp;
                        $relElementData[$rKey] = $rTemp;
                        //                        arrPrint($relTemp);
                    }
                    //
                }
            }
        }


        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                // cekHitam($eKey);
                //                arrPrint($eSpec);
                //                                cekHitam($eKey);
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                $relElementType = isset($relElementData[$eKey]['elementType']) ? $relElementData[$eKey]['elementType'] : array();
                //cekHijau($relElementType);
                if ($eKey == "billingDetails") {

                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key || $val");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";

                                    // arrPrint($vTmp);
                                    //                                    die();
                                    if (isset($vTmp['npwp']) && sizeof($vTmp['npwp']) > 0) {
                                        unset($vTmp["nik"]);

                                    }
                                    else {
                                        unset($vTmp["npwp"]);
                                    }

                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                // arrPrint($vTmp);
                                if (is_array($vTmp)) {

                                    foreach ($vTmp as $vTmpKey => $vTmpVal) {
                                        $vTmp[$vTmpKey] = formatField($vTmpKey, $vTmpVal);
                                    }
                                }
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }
                }
                else {
                    switch ($elementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {
                                //                            cekHitam("$key ");
                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                    //                                $vTmp["nik"]="45245829";
                                    //                                    arrPrint($val);
                                    //                                                                arrPrint($vTmp);
                                    //                                                                cekBiru($key);
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        //                                        cekKuning($key."||".$val);
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    // cekHitam($vTmp);
                                    if (isset($relElementType[$vTmp])) {
                                        // arrPrint($relElementType[$vTmp]);
                                        //                                        foreach($relElementType[$vTmp] as $relKey =>$relTemp){
                                        //arrPrint($relTemp);
                                        //                                        }
                                        //                                        $relType = isset($relElementType[$vTmp][$eKey]['elementType']) ? $relElementType[$vTmp][$eKey]['elementType']: "";
                                        //                                        cekLime("$eKey hooo ." .$relType);
                                    }
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                    switch ($relElementType) {
                        case "dataModel":
                            foreach ($eSpec as $key => $val) {

                                if ($key == "contents") {
                                    $vTmp = $val != null ? blobDecode($val) : "-";
                                }
                                else {
                                    $vTmp = $val != null ? $val : "-";
                                }
                                //                                cekHitam($key);
                                //                                                            arrPrint($vTmp);
                                $eTmp[$key] = $vTmp;
                                if (is_array($vTmp)) {
                                    foreach ($vTmp as $key => $val) {
                                        $elementsGate[$eKey . "_$key"] = $val;
                                    }
                                }
                                else {
                                    $elementsGate[$eKey . "_$key"] = $vTmp;
                                }
                            }

                            break;
                        case "dataField":
                            $eTmp = array();
                            foreach ($eSpec as $key => $val) {
                                $vTmp = $val != null ? $val : "-";
                                $eTmp[$key] = $vTmp;
                                $eTmp['contents']['nama'] = $eSpec['value'];
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                            break;
                    }

                }


                $elements[$eKey] = $eTmp;
            }
            //            arrPrint($elements);
        }


        $globalVars = array_merge($globalVars, $arrCompanyProfile, $masterTableInParams);


        if (isset($globalVars['nomer'])) {
            //            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode']) ? "-" . digit_5($globalVars['countersTrID']['stepCode']) : "";
            $addTrIdCounter = isset($globalVars['countersTrID']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTrID']['stepCode|placeID']) : "";
            $globalVars['nomer'] = $globalVars['nomer'] . $addTrIdCounter;
        }
        if (isset($globalVars['nomer_top'])) {
            //            $addTopCounter = isset($globalVars['countersTop']['stepCode']) ? "-" . digit_5($globalVars['countersTop']['stepCode']) : "";
            $addTopCounter = isset($globalVars['countersTop']['stepCode|placeID']) ? "-" . digit_5($globalVars['countersTop']['stepCode|placeID']) : "";
            $globalVars['nomer_top'] = $globalVars['nomer_top'] . $addTopCounter;
        }


        if (isset($globalVars["ids_his"])) {
            $stepPrev = $globalVars["step_number"] - 1;
            if ($stepPrev > 0) {
                $cHist = blobDecode($globalVars["ids_his"])[$stepPrev];
                $counterhists = blobDecode($cHist["counters"]);
                $cNomer = $cHist["nomer"];
                $cNomerExpl = explode(".", $cNomer);
                $cTrcode = $cNomerExpl[0];
                $cTrplace = $cNomerExpl[1];
                $cgJenis = "$cTrcode|$cTrplace";

                $cgHist = digit_5($counterhists["stepCode|placeID"]["$cgJenis"]);

                $nomer_prev = $cNomer . "-" . $cgHist;

                $globalVars['nomers_prev'] = formatField("nomer", $nomer_prev);
            }
        }


        // arrPrint($globalVars);
        if (isset($elementsGate)) {
            //            $globalVars = $globalVars + $elementsGate;
            $globalVars = array_merge($globalVars, $elementsGate);
        }


        //region downpayment
        //        arrPrint($masterTableInValueParams);
        $dpValueDetails = array();
        $dpFieldName = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                "due_amount" => $masterTableInValueParams['tagihan'],
            );

            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "vat Dp",
                "dp" => "Downpayment",
                "due_amount" => "Due amount",
            );
        }


        //endregion

        //region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //arrPrint($signValues);
        //endregion

        //region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        $elementFixedNumberSO = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['elementFixedNumberSO'][$currentStepNum] : array();
        // arrPrint($elementFixedConfig);

        //        arrPrint($globalVars);
        //        die();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
                //                cekHere($key);
                //                cekHere($globalVars[$key]);
            }
        }
        else {
            $fixedElements = array();
        }

        //        arrPrint($globalVars);

        if (sizeof($elementFixedNumberSO) > 0) {
            foreach ($elementFixedNumberSO as $key => $label) {
                $fixedElements['so_number']['contents'][$label] = isset($globalVars[$key]) ? formatField($key, $globalVars[$key]) : "";
            }
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();

        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];

            foreach ($globalVars as $key => $val) {
                if (!is_array($val)) {

                    $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
                }
                //                cekHere($key);
                //                arrPrint($companyStr);
            }
            //            arrPrint($globalVars);
            $companyProfile['companyProfile']['contents'][] = $companyStr . " <span class='text-white no-print'>$trID</span>";
        }

        //endregion


        if (sizeof($receiptInWordConfig) > 0) {
            $this->load->helper("he_inword");
            $in_word = "";
            foreach ($receiptInWordConfig as $he_loader => $fieldsSelected) {
                if (isset($masterTableInValueParams[$fieldsSelected])) {

                    if (isset($_GET['type']) && blobDecode($_GET['type']) != 'IDR' && isset($_GET['f'])) {
                        $type = blobDecode($_GET['type']);
                        $fkali = blobDecode($_GET['f']);
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "";
                        if ($currency != '') {
                            $val_convert = $masterTableInValueParams[$fieldsSelected];
                        }
                        else {
                            $val_convert = $fkali > 0 ? ($masterTableInValueParams[$fieldsSelected] / $fkali) : $masterTableInValueParams[$fieldsSelected];
                        }
                        $he_word = inWordEng($val_convert, $type);
                        $in_word .= "$he_word";
                    }
                    else {
                        $val_convert = $masterTableInValueParams[$fieldsSelected];
                        $currency = isset($masterTableInValueParams['valasDetails']) ? $masterTableInValueParams['valasDetails'] : "IDR";
                        //                        $val_convert1=formatField("tagihan",$val_convert);
                        $val_convert1 = number_format(0 + $val_convert);

                        //                        echo $val_convert1;
                        $val_convert2 = preg_replace('/[$\,\.]/', '', $val_convert1);
                        //                        cekHitam($val_convert. " ||". $val_convert1);
                        $he_word = $he_loader($val_convert2, $currency);
                        //                        $he_word = $he_loader($val_convert, $currency);
                        $in_word .= "$he_word";
                    }

                }
            }
        }
        else {
            $in_word = "";
        }

        $staticNotes = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticNotes'][$row->step_number] : "";

        //region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] . $staticNotes : "$staticNotes";
        //        $fixedElements['noteDetails']['label'] = "NOTES" . " <span class='text-white'>$trID</span>";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['staticFooter'][$row->step_number] : "";

        // region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $itemSubTotal = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptSumDetailFields'][$currentStepNum] : array("subtotal" => "Total Price");
        $itemLabels = $itemLabels + $itemNumLabels + $itemSubTotal;
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "Total Price");
        $itemLabels3 = $itemLabels3 + $itemNumLabels3 + array("subtotal" => "Total Price");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number]) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$row->step_number] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
            unset($itemLabels3['subtotal']);
        }
        $zeroAllowed = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['receiptSumFieldsZeroAllowed'][$row->step_number] : array();
        $mode = isset($_GET['mobMode']) && $_GET['mobMode'] == "1" ? "viewReceiptBT" : "viewReceipt";

        $data = array(
            "mode" => $mode,
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $main,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels,
            "itemLabels2" => isset($itemLabels2) ? $itemLabels2 : array(),
            "itemLabels3" => isset($itemLabels3) ? $itemLabels3 : array(),
            "noteEnabled" => $noteEnabled,
            //            "items" => $items,
            "items" => $itemsRegistries,
            "items2" => isset($items2_sumRegistries) ? $items2_sumRegistries : $items2,
            "items3" => isset($items3_sumRegistries) ? $items3_sumRegistries : array(),
            "itemsRegistries" => $itemsRegistries,
            "items3Registries" => $items3_sumRegistries,
            "inWord" => $in_word,
            "childTableInValueParams" => $childTableInValueParams,
            "masterTableInValueParams" => $masterTableInValueParams,

            "sumRows" => $receiptSumFields,
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",

            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "signHeader" => $signHeader,

            "footer" => $footer,
            "availValueKeys" => $availValueKeys,
            "valueKey" => $valueKey,
            "tempData" => isset($tempData) ? $tempData : array(),
            "zeroAllowed" => $zeroAllowed,
            "dpFieldName" => $dpFieldName,
            "dpValueDetils" => $dpValueDetails,
        );
        //endregion

        //        arrPrint($itemsRegistries);
        $this->load->view("transaksi", $data);

    }

    public function viewSmallReceiptBT()
    {

        $globalVars = array();
        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='" . $no . "'");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion

        //region signatures
        $signNumbers = array();
        $signValues = array();
        $signExtValues = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($tmpTr[0]->id_master)->result();
        if (sizeof($tmpSign) > 0) {
            foreach ($tmpSign as $row) {
                $signValues['sign_' . $row->step_number] = array(
                    "label" => isset($this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption']) ? $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['stateCaption'] : "",
                    "contents" => isset($row->oleh_nama) ? $row->oleh_nama : "",
                    "caption_department" => isset($this->config->item("userGroup")[$row->group_code]) ? $this->config->item("userGroup")[$row->group_code] : "",
                );
            }
        }
        //endregion

        $rawItems = array();
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {

            //            arrPrint($tmpTr);

            $this->jenisTr = $tmpTr[0]->jenis_master;
            $trID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $paymentMethod = $tmpTr[0]->pembayaran_sys;

            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();

            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }

            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //endregion

            //region take from registries
            //==ambil value-gate
            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();

            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "receiptDetailFields"://
                            $receiptDetailFields = unserialize(base64_decode($row->values));
                            break;
                        case "receiptSumFields"://
                            $receiptSumFields = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }


            //            arrPrint($masterGates);

            //endregion
            foreach ($tmpTr as $row) {
                $id = $row->produk_id;
                $tmp = array();
                foreach ($itemLabels as $key => $val) {

                    if (strpos($key, '+') !== false) {//==mengandung penggabungan (+)
                        $chars = explode("+", $key);
                        $colValue = "";
                        foreach ($chars as $key2) {
                            //                            $colValue .= isset($row->$key2) ? formatField($key, $row->$key2) . "<br>" : "";
                        }
                        //                        $colValue = rtrim($colValue, "<br>");
                    }
                    else {
                        //                        $colValue = isset($row->$key) ? formatField($key, $row->$key) : "";
                        $colValue = isset($row->$key) ? $row->$key : "";
                    }

                    //                            $tmp[$key]=isset($iSpec[$val])?$iSpec[$val]:0;
                    //                        if (isset($detailValues[$row->produk_id][$key])) {
                    //                            $fieldValue = $detailValues[$row->produk_id][$key];
                    //                        } else {
                    //                            if (isset($row->$key)) {
                    //                                $fieldValue = $row->$key;
                    //                            }
                    //                        }

                    //                        $tmp[$key] = formatField($key, $fieldValue);
                    //                        $tmp[$key] = $fieldValue;
                    $tmp[$key] = $colValue;
                    if (!isset($childTableInValueParams[$id][$key])) {
                        $childTableInValueParams[$id][$key] = $colValue;
                    }
                }

                //region calculate subtotal
                //===perhitungan subtotal


                if ($subAmountConfig != null) {
                    $subAmountConfig = str_replace("jml", "produk_ord_jml", $subAmountConfig);
                    $subAmountConfig = str_replace("produk_ord_produk_ord_jml", "produk_ord_jml", $subAmountConfig);
                    $subtotal = makeValue($subAmountConfig, $childTableInValueParams[$id], $childTableInValueParams[$id], 0);
                }
                else {
                    $subtotal = 0;
                }
                $tmp["subtotal"] = $subtotal;
                //endregion
                $rawItems[$row->produk_id] = $tmp;
                $rawItems[$row->produk_id] = array_merge(array_filter($rawItems[$row->produk_id]), array_filter($childTableInValueParams[$row->produk_id]));
            }

        }
        else {
            echo "<div class='alert alert-warning text-center'>";
            echo "the entry you are trying to access does not exist.<br>";
            echo "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            echo "if this error re-occurs, please contact system developer.<br>";
            echo "<a class='btn' data-dismiss='modal'>okay, got it</a>";
            echo "</div class='alert alert-danger'>";
            die();
        }
        //endregion

        $items = array();
        $items2 = array();
        $jenisTr = $this->jenisTr;
        $items = $rawItems;

        //region header small nota
        $smallPrint = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['smallPrint'][$tmpTr[0]->step_number] : array();
        $signHeader = array();
        if (sizeof($smallPrint) > 0) {
            $tempSign0 = $tmpSign[0];
            foreach ($smallPrint as $kolom => $label) {
                if (array_key_exists($kolom, $tempSign0)) {
                    $signHeader['smallPrint'][$label] = $tempSign0->$kolom;
                }
            }
        }
        //endregion

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        $globalVars = $globalVars + (array)$mainProp;
        //endregion

        //  region company profile
        $this->load->model("Mdls/MdlCompany");
        $mc = New MdlCompany();
        $arrTmpCompany = $mc->lookupAll()->result();
        $arrCompanyProfile = array();
        if (sizeof($arrTmpCompany) > 0) {
            foreach ($arrTmpCompany as $cSpec) {
                foreach ($cSpec as $key => $val) {
                    $arrCompanyProfile['companyProfile_' . $key] = $val;
                }
            }
        }
        //  endregion

        $elements = array();
        if (sizeof($mainElements) > 0) {
            foreach ($mainElements as $eKey => $eSpec) {
                $elementType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'][$eKey]['elementType'] : array();
                switch ($elementType) {
                    case "dataModel":
                        foreach ($eSpec as $key => $val) {
                            if ($key == "contents") {
                                $vTmp = $val != null ? unserialize(base64_decode($val)) : "-";
                            }
                            else {
                                $vTmp = $val != null ? $val : "-";
                            }
                            $eTmp[$key] = $vTmp;


                            if (is_array($vTmp)) {
                                foreach ($vTmp as $key => $val) {
                                    $elementsGate[$eKey . "_$key"] = $val;
                                }
                            }
                            else {
                                $elementsGate[$eKey . "_$key"] = $vTmp;
                            }
                        }

                        break;
                    case "dataField":
                        $eTmp = array();
                        foreach ($eSpec as $key => $val) {
                            $vTmp = $val != null ? $val : "-";

                            $eTmp[$key] = $vTmp;
                            $eTmp['contents']['nama'] = $eSpec['value'];

                            $elementsGate[$eKey . "_$key"] = $vTmp;
                        }
                        break;
                }
                $elements[$eKey] = $eTmp;
            }
        }

        $globalVars = $globalVars + $elementsGate + $arrCompanyProfile;
        $globalVars = $globalVars + $arrCompanyProfile;
        if (isset($elementsGate)) {
            $globalVars = $globalVars + $elementsGate;
        }

        //        region fixed signature
        $fixedSignConfig = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['fixedSignatures'][$currentStepNum] : array();
        if (sizeof($fixedSignConfig) > 0) {
            foreach ($fixedSignConfig as $key => $eSpec) {
                if (substr($eSpec['label'], 0, 1) == ".") {
                    $label = str_replace(".", "", $eSpec['label']);
                }
                else {
                    $label = "";
                }
                $signValues[$key . 'Signitures']['label'] = $label;
                $signValues[$key . 'Signitures']['contents'] = isset($globalVars[$eSpec['contents']]) ? $globalVars[$eSpec['contents']] : "";
                $signValues[$key . 'Signitures']['caption_department'] = "";
            }
        }
        //        //endregion

        //        region fixed element
        $elementFixedConfig = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['fixedElements'][$currentStepNum] : array();
        if (sizeof($elementFixedConfig) > 0) {
            foreach ($elementFixedConfig as $key => $label) {
                $fixedElements['fixedElements']['contents'][$label] = isset($globalVars[$key]) ? $globalVars[$key] : "";
                $fixedElements['fixedElements']['label'] = $globalVars['jenis_label'];
            }
        }
        else {
            $fixedElements = array();
        }

        $receiptGlobalConfig = $this->config->item('receiptGlobal_config') != null ? $this->config->item('receiptGlobal_config') : array();
        $companyProfile = array();
        if (sizeof($receiptGlobalConfig) > 0) {
            $companyStr = $receiptGlobalConfig['companyProfile'];
            foreach ($globalVars as $key => $val) {
                $companyStr = str_replace("{" . $key . "}", $val, $companyStr);
            }
            $companyProfile['companyProfile']['contents'][] = $companyStr;
        }
        //        endregion

        //        region notes element
        $fixedElements['noteDetails'] = array();
        $fixedElements['noteDetails']['contents'][] = isset($globalVars['keterangan']) ? $globalVars['keterangan'] : "-";
        $fixedElements['noteDetails']['label'] = "NOTES";
        //        endregion notes element

        $elements = $elements + $fixedElements + $companyProfile;
        $footer = isset($this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['staticFooter']) ? $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]['steps'][$row->step_number]['staticFooter'] : "";

        //region prepare params for viewer
        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $temp = array(
            "mode" => $this->uri->segment(2),
            //"template"       => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $mainValues,
            "detailValues" => $detailValues,
            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            "items" => $items,
            "items2" => $items2,
            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "footer" => $footer,
        );
        //arrPrint($mainProp);
        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptTemplate"][$currentStepNum],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]["label"],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $masterTableInValueParams,
            "detailValues" => $childTableInValueParams,
            "itemLabels" => $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount"),
            "items" => $items,
            "items2" => $items2,
            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumBottom" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumBottom']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumBottom'] : array(),
            "headerTablesSmall" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['headerTablesSmall']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['headerTablesSmall'] : array(),
            "receiptNonTunai" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptNonTunai']) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptNonTunai'] : array(),
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $masterAddValues,
            "mainAddFields" => $masterAddFields,
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "description" => isset($masterGates['description']) ? $masterGates['description'] : "",
            "signature" => $signValues,
            "companyProfile" => $arrCompanyProfile,
            "mainElements" => $elements,
            "elementConfigs" => $elementConfigs,
            "masterGates" => $masterGates,
            "signHeader" => $signHeader,
            "temp" => $temp,
        );
        //endregion
        $this->load->view("transaksi", $data);

    }

    public function viewJembreng()
    {

        $no = $this->uri->segment(3);

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("nomer='$no'");
        $tmp = $tr->lookupAll()->result();

        $tr->setFilters(array());
        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("transaksi.id_master='" . $tmp[0]->id_master . "'");
        $tmpTr = $tr->lookupJoined()->result();
        cekKuning($this->db->last_query());
        //endregion

        //region re-arrange array...
        $trans = array();
        if (sizeof($tmpTr) > 0) {
            foreach ($tmpTr as $iSpec) {
                if (!isset($trans['main'][$iSpec->step_number])) {
                    $trans['main'][$iSpec->step_number] = array();
                }
                if (!isset($trans['items'][$iSpec->step_number])) {
                    $trans['items'][$iSpec->step_number] = array();
                }

                $trans['main'][$iSpec->step_number] = array(
                    "nomer" => $iSpec->nomer,
                    "jenis_label" => $iSpec->jenis_label,
                    "nama" => $iSpec->oleh_nama,
                );

                $trans['items'][$iSpec->step_number][] = array(
                    "nama" => $iSpec->produk_nama,
                    "jml" => $iSpec->produk_ord_jml,
                );
            }
        }
        //endregion

        //        arrprint($trans);
        die();
        //region prepare params for viewer
        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_layout")[$tmpTr[0]->jenis_master]["receiptTemplate"][$tmpTr[0]->step_number],
            "title" => $this->config->item("heTransaksi_ui")[$tmpTr[0]->jenis_master]["steps"][$tmpTr[0]->step_number]["label"],
            "main" => $trans['main'],
            "items" => $trans['items'],
        );

        //endregion

        $this->load->view("transaksi", $data);

    }

    public function validate()
    {

        $fieldOpnameEntryValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldOpnameEntryValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldOpnameEntryValidators"] : array();
        $fieldOpnameValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldOpnameValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldOpnameValidators"] : array();

        $fieldValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldValidators"] : array();
        $rowValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowValidators"] : array();
        $rowNumValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowNumValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowNumValidators"] : array();
        $rowOptValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowOptionalValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowOptionalValidators"] : array();
        $validateReceiveElement = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["validateReceiveElement"][1]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["validateReceiveElement"][1] : array();
        $appletConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['applets']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['applets'] : array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $availPayments = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['availPayments']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['availPayments'] : array();
        $validateAdditional = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shopingCartAddValidator']['additional']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shopingCartAddValidator']['additional'] : array();
        $fieldValidatorsComparison = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartFieldValidatorsComparison']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartFieldValidatorsComparison'] : array();

        $fieldValidatorPairedItem = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartValidatorsPairedItem"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartValidatorsPairedItem"] : array();
        $unionValidateComparison = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartUnionComparison"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartUnionComparison"] : array();
        $unionValidate = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartUnionValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartUnionValidators"] : array();
        //----------------------------------
        $shoppingCartPaymentValidator = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartPaymentValidator"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartPaymentValidator"] : array();
        $shoppingCartPaymentValueValidator = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartPaymentValueValidator"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartPaymentValueValidator"] : array();
        $shoppingCartPaymentNilaiValidator = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartPaymentNilaiValidator"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartPaymentNilaiValidator"] : array();

        $checkOpnameValidate = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["checkOpnameValidate"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["checkOpnameValidate"] : array();


        $cCode = "_TR_" . $this->jenisTr;


        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";

        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            //            //cekBiru("hendak memeriksa relative impacts");
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                //                //cekBiru("memeriksa $eName:");
                if (array_key_exists($eName, $relElementConfigs)) {
                    //                    //cekHijau("$eName memiliki relative impacts");
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //                        //cekHijau("memenuhi syarat");
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            //                            //cekMerah("memeriksa $eName, $currentValue");
                            //                            $rcCtr = 0;
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                //                                $elKey = $eName . "_" . $currentValue . "_" . $rcID;
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                                //                                $rcCtr++;
                            }
                        }

                    }
                    else {
                        //                        //cekMerah("TIDAK memenuhi syarat");
                    }
                }
            }
        }

        $arrySegment = $this->uri->segment_array();
        if (isset($_SESSION[$cCode]['mode']['edit']) && sizeof($_SESSION[$cCode]['mode']['edit']) > 0) {
            $prevAction = "Transaksi/editPreview";
            $main_id = "/" . $_SESSION[$cCode]['mode']['edit'];
        }
        else {
            if (isset($_SESSION[$cCode]['mode']['cancel']) && sizeof($_SESSION[$cCode]['mode']['cancel']) > 0) {
                $prevAction = "Transaksi/preCancelPackingPreview";
                $main_id = "/" . $_SESSION[$cCode]['mode']['cancel'];
            }
            else {
                $prevAction = "Transaksi/preview";
                $main_id = "";
            }
        }

        $errMsgs = array();
        $errLines = array();
        $errFields = array();
        $errRows = array();
        $errErrorException = array();
        if (sizeof($rowValidatorRules) > 0) {

            foreach ($rowValidatorRules as $field => $label) {
                if (!isset($_SESSION[$cCode]['main'][$field])) {
                    $errMsgs[] = "$label is required";

                    $errRows[] = $field;
                }

            }

        }
        if (sizeof($rowNumValidatorRules) > 0) {

            foreach ($rowNumValidatorRules as $field => $label) {
                if (!isset($_SESSION[$cCode]['main'][$field])) {
                    $errMsgs[] = "$label is required";

                    $errRows[] = $field;
                }
                else {
                    if (0 + ($_SESSION[$cCode]['main'][$field]) < 0.1) {
                        $errMsgs[] = "$label should be a number";

                        $errRows[] = $field;
                    }
                }

            }

        }
        if (sizeof($rowOptValidatorRules) > 0) {
            foreach ($rowOptValidatorRules as $srcName => $srcSpec) {
                foreach ($srcSpec as $value => $pair) {
                    if (isset($_SESSION[$cCode]['main'][$srcName]) && $_SESSION[$cCode]['main'][$srcName] == $value) {
                        foreach ($pair as $k => $v) {
                            if (!isset($_SESSION[$cCode]['main'][$k])) {
                                $errMsgs[] = "$k is required";

                                $errRows[] = $k;
                            }
                        }
                    }
                }
            }
        }
        if (sizeof($fieldValidatorRules) > 0) {

            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $nama = htmlspecialchars($iSpec['name']);
                    if ((isset($iSpec['disabled']) && $iSpec['disabled'] == "0") || !isset($iSpec['disabled'])) {
                        if (!isset($errFields[$id])) {
                            $errFields[$id] = array();
                        }
                        foreach ($fieldValidatorRules as $field => $label) {
                            if (!isset($iSpec[$field])) {
                                $errMsgs[] = "$label is required";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                            if (!is_numeric($iSpec[$field])) {
                                $errMsgs[] = "$label must be a valid number";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                            if ((int)$iSpec[$field] < 0.5) {
                                $errMsgs[] = "$label must be > 0";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                        }
                    }

                }
            }

        }

        if (sizeof($elementConfigs) > 0) {
            foreach ($elementConfigs as $eName => $aSpec) {
                if (!isset($_SESSION[$cCode]['main_elements'][$eName])) {
                    if ((isset($aSpec['noValidate'])) && ($aSpec['noValidate'] == true)) {
                    }
                    else {
                        $errMsgs[] = ($aSpec['label'] . " must be filled first!");
                        echo "<script>";
                        echo "if(top.document.getElementById('elTitle_$eName')){top.document.getElementById('elTitle_$eName').className='box-headers text-red text-left'};";
                        echo "</script>\n";
                    }
                }
                else {
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            if (isset($validateReceiveElement[$eName]) && sizeof($validateReceiveElement[$eName])) {
                                $valid = 0;
                                $check = array();
                                foreach ($validateReceiveElement[$eName] as $tLabel => $textWarning) {
                                    if (strlen($_SESSION[$cCode]['main'][$eName . '__' . $tLabel]) > 10) {
                                    }
                                    else {
                                        $check[] = $tLabel;
                                    }
                                }
                                if (sizeof($check) > 1) {
                                    $errMsgs[] = ("Harap lengkapi salah satu NPWP/KTP diBillingDetails customer");
                                    foreach ($check as $nLabel) {
                                        $errMsgs[] = ("lengkapi $nLabel!");
                                    }
                                }
                            }

                            if (strlen($_SESSION[$cCode]['main_elements'][$eName]['key']) < 0.5) {
                                $errMsgs[] = ("element " . $aSpec['label'] . " must be filled with one entry!");
                                echo "<script>";
                                echo "if(top.document.getElementById('elTitle_$eName')){top.document.getElementById('elTitle_$eName').className='box-headers text-red text-left'};";
                                echo "</script>\n";
                            }
                            else {
                                echo "<script>";
                                echo "if(top.document.getElementById('elTitle_$eName')){top.document.getElementById('elTitle_$eName').className='box-headers bg-grey text-left'};";
                                echo "</script>\n";
                            }
                            break;
                        case "dataField":
                            if (strlen($_SESSION[$cCode]['main_elements'][$eName]['value']) < 0.5) {
                                if ((isset($aSpec['noValidate'])) && ($aSpec['noValidate'] == true)) {
                                }
                                else {
                                    $errMsgs[] = ($aSpec['label'] . " must be filled with one entry!***");
                                    echo "<script>";
                                    echo "if(top.document.getElementById('elTitle_$eName')){top.document.getElementById('elTitle_$eName').className='box-headers text-red text-left'};";
                                    echo "</script>\n";
                                }

                            }
                            else {
                                echo "<script>";
                                echo "if(top.document.getElementById('elTitle_$eName')){top.document.getElementById('elTitle_$eName').className='box-headers bg-grey text-left'};";
                                echo "</script>\n";
                            }
                            break;
                    }

                }
            }
        }

        if (sizeof($fieldValidatorsComparison) > 0) {
            $result = array();
            $labels = array();
            foreach ($fieldValidatorsComparison as $field => $label) {
                $labels[$label] = $field;
                $result[$label] = isset($_SESSION[$cCode]['main'][$field]) ? $_SESSION[$cCode]['main'][$field] : 0;
            }

            if (round($result["sumber"], 2) != round($result["target"], 2)) {
                $labelSrc = isset($labels["sumber"]) ? $labels["sumber"] : "";
                $labelTarget = isset($labels["target"]) ? $labels["target"] : "";
                $errMsgs[] = "Nilai total tidak sama dari nilai akumulasi nota yang dipilih.";
                $errRows[] = "test";
            }


        }

        if (sizeof($unionValidateComparison) > 0) {
            $result = array();
            $labels = array();
            $validate = 0;
            $val = array();
            $valsValidate = array();

            foreach ($unionValidateComparison as $fieldData) {

                if (isset($_SESSION[$cCode]['main']["nilai_entry"])) {
                    if ($_SESSION[$cCode]['main']["nilai_entry"] > 0) {
                    }
                    else {
                        cekhitam("masuk sini " . __LINE__);
                        if ($_SESSION[$cCode]['main']["nilai_entry"] == 0) {
                            unset($_SESSION[$cCode]['main']["nilai_entry"]);
                        }
                        else {
                            if (sizeof($unionValidate) > 0) {
                                foreach ($unionValidate as $fieldUnion) {
                                    $validateUnion = 0;
                                    foreach ($fieldUnion as $field => $fieldLabel) {
                                        if (isset($_SESSION[$cCode]['main'][$field]) && $_SESSION[$cCode]['main'][$field] > 0) {
                                        }
                                        else {
                                            $validateUnion++;
                                        }
                                    }
                                    if (sizeof($fieldUnion) == $validateUnion) {
                                        $errMsgs[] = $fieldData["nilai_entry"];
                                    }
                                }
                            }
                            else {
                                $errMsgs[] = $fieldData["nilai_entry"];
                            }
                        }
                    }
                }
                else {
//                    cekhitam("masuk sini " . __LINE__);
                    if (sizeof($unionValidate) > 0) {
                        foreach ($unionValidate as $fieldUnion) {
                            $validateUnion = 0;
                            $err = array();
                            foreach ($fieldUnion as $field => $fieldLabel) {
//                                cekKuning(":: $field ::");
                                if (isset($_SESSION[$cCode]['main'][$field]) && $_SESSION[$cCode]['main'][$field] > 0) {

                                }
                                else {
                                    cekPink(":: $field tidak ada di main ::");
                                    $validateUnion++;
                                    $err[] = $fieldLabel;

                                }
                            }
                            if ($this->jenisTr != "749") {
                                if (sizeof($err) == sizeof($fieldUnion)) {
                                    $errMsgs[] = "metode pembayaran tidak ada yang dipilih, silahkan periksa kembali";
                                }
                            }

                        }
                    }
                    else {
                        $errMsgs[] = $fieldData["nilai_entry"];
                    }
                }

                foreach ($fieldData as $field => $label) {

                    //                    if (isset($_SESSION[$cCode]['main'][$field]) && ($_SESSION[$cCode]['main'][$field] > 0)) {
                    if (isset($_SESSION[$cCode]['main'][$field])) {
                        //cekHere("ada $field dan nilai $field tidak sama dengan nol ");
                        $validate++;
                        $val["source"] = $field;
                        $valsValidate["source"][] = $field;
                    }
                    else {
                        //cekHere("TIDAK ada $field  ");
                        $val["target"] = $field;
                        $valsValidate["target"][] = $field;
                    }
                }

            }
//            arrPrint($unionValidateComparison);
//            arrPrint($valsValidate);
//            arrPrint($val);
//

            if (array_key_exists("source", $val)) {
                $cekval = $val["target"];
                if (!isset($_SESSION[$cCode]['main'][$cekval])) {
                    foreach ($unionValidateComparison as $data) {

                        if (isset($data[$cekval])) {
                            if ($this->jenisTr == "749") {
                                if ($cekval == "kelebihanBayar") {
                                    if ($_SESSION[$cCode]['main']['lebih_bayar'] > 0) {
                                        $errMsgs[] = $data[$cekval] . " ";
                                        cekHere("ngisi disini " . __LINE__);
                                        $errErrorException[] = $data[$cekval];
                                    }
                                }
                            }
                            else {
                                $errMsgs[] = $data[$cekval] . " ";
                                cekHere("ngisi disini " . __LINE__);
                                $errErrorException[] = $data[$cekval];
                            }
                        }
                        else {
                            cekHitam("== $cekval ==");

                        }
                    }
                }
//                arrPrint($errMsgs);
            }
//            arrPrint($errErrorException);
            if (!isset($valsValidate["source"]) || (sizeof($valsValidate["source"]) == 0)) {
                // mati_disini("tidak memilih cash account, credit note, uang muka");
                //  $errMsgs[] = "cash account, credit note, uang muka tidak ada yang dipilih.";
            }

        }

        if (sizeof($fieldValidatorPairedItem) > 0) {
            $label = $this->config->item("heTransaksi_ui")[$this->jenisTr]["label"];
            $source = isset($_SESSION[$cCode][$fieldValidatorPairedItem['sumber']]) ? $_SESSION[$cCode][$fieldValidatorPairedItem['sumber']] : "";
            $target = isset($_SESSION[$cCode][$fieldValidatorPairedItem['target']]) ? $_SESSION[$cCode][$fieldValidatorPairedItem['target']] : "";
            if (sizeof($source) > 0) {
                foreach ($source as $pID => $pSpec) {
                    $pTarget = isset($target[$pID]) ? $target[$pID] : array();

                    if (!array_key_exists($pID, $target)) {
                        //                        $errMsgs[] = "$label " . $pSpec['name'] . " belum ditentukan.";
                        $errMsgs[] = "target konversi " . $pSpec['name'] . " belum ditentukan.";
                    }
                    if (isset($pTarget['jml']) && isset($pSpec['jml'])) {
                        if ($pTarget['jml'] < $pSpec['jml']) {
                            $errMsgs[] = "konversi " . $pSpec['name'] . " salah. silahkan cek ulang jumlah konversinya.";
                        }
                        $jml_satuan = $pTarget['jml'] / $pSpec['jml'];
                        $jml_satuan_ex = explode(".", $jml_satuan);
                        if (sizeof($jml_satuan_ex) > 1) {
                            $errMsgs[] = "konversi " . $pSpec['name'] . " salah. silahkan cek ulang jumlah konversinya.";
                        }
                    }
                }
            }
        }


        if (sizeof($fieldOpnameValidatorRules) > 0) {
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $name = htmlspecialchars($iSpec['nama']);
                    if ((isset($iSpec['disabled']) && $iSpec['disabled'] == "0") || !isset($iSpec['disabled'])) {
                        foreach ($fieldOpnameValidatorRules as $field => $label) {
                            if (isset($iSpec['qty_selisih']) && ($iSpec['qty_selisih'] > 0)) {
                                if ((int)$iSpec[$field] <= 0) {
                                    $errMsgs[] = "$label $name must be > 0";
                                    $errLines[] = $id;
                                    $errFields[$id][] = $field;
                                }
                            }
                        }
                    }
                }
            }
        }
        if (sizeof($fieldOpnameEntryValidatorRules) > 0) {
            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                $no = 0;
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $no++;
                    $id = $iSpec['id'];
                    $kode = $iSpec['produk_kode'];
                    $label = $iSpec['label'];

                    $name = htmlspecialchars($iSpec['nama']);
                    if ((isset($iSpec['disabled']) && $iSpec['disabled'] == "0") || !isset($iSpec['disabled'])) {
                        foreach ($fieldOpnameEntryValidatorRules as $field => $label) {
                            if (!isset($iSpec[$field]) && ($iSpec['stok'] > 0)) {
                                $errMsgs[] = "$label $name harus diketik ulang, baris nomer $no.";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;

                            }
                        }
                    }

                    $stokBuku = isset($iSpec->stok) ? $iSpec->stok : 0;
                    $stokOpname = $iSpec->qty_opname;
                    $selisih = $stokOpname - $stokBuku;
                    $stokBukuHitung = $iSpec->qty_opname - $iSpec->qty_debet + $iSpec->qty_kredit;
                    if ($selisih < 0) {
                        if ($selisih != $iSpec->qty_kredit) {
                            $msg = "Produk $label $kode SALAH. Silahkan diperiksa baris nomer $no.";
                            $errMsgs[] = $msg;
                        }
                    }
                    elseif ($selisih > 0) {
                        if ($selisih != $iSpec->qty_debet) {
                            $msg = "Produk $label $kode SALAH. Silahkan diperiksa baris nomer $no.";
                            $errMsgs[] = $msg;
                        }
                    }
                    elseif ($stokBukuHitung != $stokBuku) {
                        $msg = "Produk $label $kode SALAH. Silahkan diperiksa baris nomer $no.";
                        $errMsgs[] = $msg;
                    }
                    //                    else{
                    //                        mati_disini("Produk $label $kode SALAH. Silahkan diperiksa baris nomer $no.");
                    //                    }
                }
            }
        }

        //region validate additional
        if (sizeof($validateAdditional) > 0) {
            $selectedAdd = $_SESSION[$cCode]["main"]["additional"];
            if (isset($validateAdditional[$selectedAdd])) {
                $valKey = $validateAdditional[$selectedAdd];
                if ($_SESSION[$cCode]["main"][$valKey] == 0) {
                    $errMsgs[] = "additional kurs must be filled or select none on additional for additional kurs 0 ";
                }
            }

        }
        //        matiHEre();

        //endregion


        // shoppingCart Payment Validator
        if (sizeof($shoppingCartPaymentValidator) > 0) {
            if (isset($shoppingCartPaymentValidator['validate']) && sizeof($shoppingCartPaymentValidator['validate']) > 0) {
                foreach ($shoppingCartPaymentValidator['validate'] as $key => $val) {
                    if (isset($_SESSION[$cCode]['main'][$key]) && ($_SESSION[$cCode]['main'][$key] > 0)) {
                        if (!isset($_SESSION[$cCode]['main'][$val]) || ($_SESSION[$cCode]['main'][$val] == 0)) {
                            $errMsgs[] = $shoppingCartPaymentValidator['label'][$key];

                        }
                    }
                }
            }
        }
        if (sizeof($shoppingCartPaymentValueValidator) > 0) {
            if (isset($shoppingCartPaymentValueValidator['validate']) && sizeof($shoppingCartPaymentValueValidator['validate']) > 0) {
                foreach ($shoppingCartPaymentValueValidator['validate'] as $key => $val) {
                    if ($_SESSION[$cCode]['main'][$key] > $_SESSION[$cCode]['main'][$val]) {
                        $errMsgs[] = $shoppingCartPaymentValueValidator['label'][$key];

                    }
                }
            }
        }
        if (sizeof($shoppingCartPaymentNilaiValidator) > 0) {
            foreach ($shoppingCartPaymentNilaiValidator['validate'] as $key => $spec) {
                //                cekHere($key);
                //                arrprint($spec);
                foreach ($spec as $key_target) {
                    $source = isset($_SESSION[$cCode]['main'][$key]) ? $_SESSION[$cCode]['main'][$key] : 0;
                    $target = isset($_SESSION[$cCode]['main'][$key_target]) ? $_SESSION[$cCode]['main'][$key_target] : 0;

                    if ($source > $target) {
                        $label = $shoppingCartPaymentNilaiValidator['label'][$key][$key_target];
                        $errMsgs[] = $label;
                        //                        cekHere(":: $label ::");
                    }
                }
            }
        }

        // always validation active
        $gateNameDetail = "tableIn_detail";
        if (!isset($_SESSION[$cCode][$gateNameDetail]) || sizeof($_SESSION[$cCode][$gateNameDetail]) == 0) {

            $msg = "Transaksi gagal dilanjutkan karena rincian transaksi kosong.<br>Silahkan merubah qty/unit price dahulu dan masukkan data yang benar supaya transaksi bisa dilanjutkan.";
            mati_disini($msg);
        }
        else {
            foreach ($_SESSION[$cCode][$gateNameDetail] as $spec) {
                if (!isset($spec['valid_qty'])) {
                    $hidden_msg = "<br><span style='color:#ffffff;'>gerbang valid_qty tidak ada</span>";
                    $msg = "Transaksi gagal dilanjutkan karena rincian transaksi kosong.<br>Silahkan merubah qty/unit price dahulu dan masukkan data yang benar supaya transaksi bisa dilanjutkan. $hidden_msg";
                    mati_disini($msg);
                }
                else {
                    if ($spec['valid_qty'] == 0) {
                        $hidden_msg = "<br><span style='color:#ffffff;'>gerbang valid_qty bernilai 0</span>";
                        $msg = "Transaksi gagal dilanjutkan karena rincian transaksi kosong.<br>Silahkan merubah qty/unit price dahulu dan masukkan data yang benar supaya transaksi bisa dilanjutkan. $hidden_msg";
                        mati_disini($msg);
                    }
                }
            }
        }

        //-------
        if (sizeof($checkOpnameValidate) > 0) {
            if (isset($_SESSION[$cCode]['items']) && (sizeof($_SESSION[$cCode]['items']) > 0)) {
                $noi = 0;
                foreach ($_SESSION[$cCode]['items'] as $ii => $iSpec) {
                    if (!isset($iSpec['ceklist_opname'])) {
                        $noi++;
                        $nama = $iSpec['name'];
                        $kode = $iSpec['produk_kode'];
                        $msg = "$noi. $kode $nama pastikan sudah diceklis.";
                        $errMsgs[] = $msg;
                    }
                }

                if (isset($_SESSION[$cCode]['main']['opnameNoteCeklist_1']) && ($_SESSION[$cCode]['main']['opnameNoteCeklist_1'] == 1)) {

                }
                else {
                    $msg = "Serahterima total items/barang belum diceklis.";
                    $errMsgs[] = $msg;
                }
                if (isset($_SESSION[$cCode]['main']['opnameNoteCeklist_2']) && ($_SESSION[$cCode]['main']['opnameNoteCeklist_2'] == 1)) {

                }
                else {
                    $msg = "Serahterima total quantity belum diceklis.";
                    $errMsgs[] = $msg;
                }
            }
        }
        //-------


        /* ------------------------------
         * validasi stok saat mau produksi
         * ------------------------------*/
        $mains = $_SESSION[$cCode];
//arrPrint($errErrorException);
//arrPrint($errMsgs);

        $items2_sum = $mains['items2_sum'];
        switch ($this->jenisTr) {
            case "776":

                $kurangStoks = array();
                $hasil = "";
                $no = 0;
                foreach ($items2_sum as $pId => $item) {

                    $nama = $item['nama'];
                    $sisa = $item['stok'] - $item['jml'];

                    if ($sisa < 0) {
                        $no++;
                        $kurangStoks[$pId] = $sisa;
                        //
                        $sisa_f = $sisa * -1;
                        $nama_f = htmlspecialchars($nama);
                        $var = "<span class='font-size-0-7'>$no. $nama_f: <span class='text-bold'>$sisa_f</span></span>";
                        if ($hasil == "") {
                            $hasil = "$var";
                        }
                        else {
                            $hasil = "$hasil<br>$var";
                        }
                    }
                }


                if (sizeof($kurangStoks) > 0) {
                    // //cekhitam(sizeof($kurangStoks));
                    $alerts = array(
                        "type" => "warning",
                        "title" => "Insufficient stock",
                        "html" => $hasil,
                    );
                    echo swalAlert($alerts);
                    die();
                }

                break;
            case "1982":
                break;
            case "961":
            case "967":
                $items = $mains['items'];
                $kurangStoks = array();
                $hasil = "";
                $no = 0;
                foreach ($items as $pId => $item) {
                    if (isset($item['stok'])) {
                        $nama = $item['nama'];
                        $sisa = $item['stok'] - $item['jml'];

                        if ($sisa < 0) {
                            $no++;
                            $kurangStoks[$pId] = $sisa;

                            $sisa_f = $sisa * -1;
                            $stok_f = $item['stok'];
                            $jml_f = $item['jml'];
                            $nama_f = htmlspecialchars($nama);
                            $var = "<span class='font-size-0-7'>$no. <span style='font-weight:bold;'>$nama_f</span>, stok tersedia $stok_f, jumlah input <span style='font-weight:bold;'>$jml_f</span> melebihi stok yang tersedia. Silahkan dikoreksi lagi.</span>";
                            if ($hasil == "") {
                                $hasil = "$var";
                            }
                            else {
                                $hasil = "$hasil<br>$var";
                            }
                        }
                    }
                }
                if (sizeof($kurangStoks) > 0) {

                    $alerts = array(
                        "type" => "warning",
                        "title" => "Insufficient stock",
                        "html" => $hasil,
                    );
                    echo swalAlert($alerts);
                    die();
                }

                break;
            case "749":
                if ($_SESSION[$cCode]['main']['lebih_bayar'] <= 0) {
                    $_SESSION[$cCode]['main']['nilai_cash'] = $_SESSION[$cCode]['main']['nilai_entry'];

                    if (sizeof($errErrorException) > 0) {
                        foreach ($errErrorException as $errKey => $errVal) {
                            if (array_key_exists($errKey, $errMsgs)) {
                                unset($errMsgs[$errKey]);
                            }
                        }
                    }

                }

                break;
            case "487":
            case "489":
                if (sizeof($errErrorException) > 0) {
                    foreach ($errErrorException as $errKey => $errVal) {
                        if (array_key_exists($errKey, $errMsgs)) {
                            unset($errMsgs[$errKey]);
                        }
                    }
                }
                break;
        }

        if (sizeof($errMsgs) > 0) {
            $_SESSION['errMsg'] = implode("<br>", $errMsgs);

            if (sizeof($errLines) > 0) {
                $_SESSION['errLines'] = $errLines;
            }

            if (sizeof($errFields) > 0) {
                $_SESSION['errFields'] = $errFields;
            }

            //            arrPrint($_SESSION['errMsg']);
            echo lgShowAlert($_SESSION['errMsg']);
        }
        else {

            //            mati_disini("LOLOS, tidak kena VALIDTAE");


            $actionTarget = "top.BootstrapDialog.show(                                   {
                                       title:'preview',
                                        message: " . 'top.$' . "('<div></div>').load('" . base_url() . "/" . $prevAction . "/" . $this->jenisTr . "?rawPrev=$rawPrevURL'),
                                        draggable:false,
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        type:top.BootstrapDialog.TYPE_DEFAULT,
                                        closable:true,
                                        }
                                        );";

            //            echo "<html>";
            //            echo "<head>";
            //            echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
            //            echo "</head>";
            echo "<script>top.close_holdon();$actionTarget</script>";
            //            echo "</body>";

        }
    }

    public function validate2()
    {
        $cCode = "_TR_" . $this->jenisTr;

        $validationRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['validationRules']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['validationRules'] : array();


        $msgWarning = array();
        if (isset($validationRules)) {
            foreach ($validationRules as $gateName => $gSpec) {
                if (isset($_SESSION[$cCode][$gateName])) {
                    foreach ($_SESSION[$cCode][$gateName] as $eKey => $eSpec) {
                        if (isset($gSpec['target']) && isset($eSpec[$gSpec['target']]) && $eSpec[$gSpec['target']] > 0) {
                            if ($eSpec[$gSpec['source']] > $eSpec[$gSpec['target']]) {

                                $msg = $gSpec['target'] . " " . $eSpec['nama'] . " tidak cukup.";
                                $msgWarning[$eSpec['id']] = array(
                                    "id" => "trItems_" . $eSpec['id'],
                                    "label" => $msg,
                                );
                            }
                        }
                        else {
                            $msg = $gSpec['target'] . " " . $eSpec['nama'] . " tidak cukup.";
                            $msgWarning[$eSpec['id']] = array(
                                "id" => "trItems_" . $eSpec['id'],
                                "label" => $msg,
                            );
                        }
                    }
                }
            }
        }

        return $msgWarning;
    }

    public function midValidate()
    {
        $fieldMidValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldMidValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldMidValidators"] : array();
        $fieldMidPairedItemValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldMidValidatorsPairedItem"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldMidValidatorsPairedItem"] : array();
        $rowMidValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowMidValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartRowMidValidators"] : array();
        $fieldMidComparisonValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldMidValidatorsComparison"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartFieldMidValidatorsComparison"] : array();

        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();


        $cCode = "_TR_" . $this->jenisTr;

        $step = $_SESSION[$cCode]['main']['step_number'];
        $efakturValidatorConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['efakturValidator'][$step]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['efakturValidator'][$step] : array();
        $followupMainNoteValidatorConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainNoteValidator'][$step]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainNoteValidator'][$step] : array();
        $paidValidatorConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPaidValidators']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPaidValidators'] : array();
        $paidValidatorComparisonConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartPaymentComparisonValidator']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartPaymentComparisonValidator'] : array();


        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";

        $errMsgs = array();
        $errLines = array();
        $errFields = array();
        $errRows = array();
        if (sizeof($rowMidValidatorRules) > 0) {

            foreach ($rowMidValidatorRules as $field => $label) {
                if (!isset($_SESSION[$cCode]['main'][$field])) {
                    $errMsgs[] = "$label is required";

                    $errRows[] = $field;
                }
            }
        }

        if (sizeof($fieldMidPairedItemValidatorRules) > 0) {
            $result = array();
            foreach ($fieldMidPairedItemValidatorRules as $field => $label) {
                if (!isset($_SESSION[$cCode]['main'][$field])) {
                    $errMsgs[] = "$field value is required";
                    $errRows[] = $field;
                }
                $result[$field] = isset($_SESSION[$cCode]['main'][$field]) ? $_SESSION[$cCode]['main'][$field] : 0;
            }

            if (($result['hpp_sumber'] - $result['hpp_target']) > 0.0000000100) {
                $selisih = $result['hpp_sumber'] - $result['hpp_target'];

                $errMsgs[] = "Nilai konversi tidak sama, silahkan cek harga per-unitnya.<br>$selisih";
                $errRows[] = "test";
            }
            elseif (($result['hpp_sumber'] - $result['hpp_target']) < -0.0000000100) {
                $selisih = $result['hpp_sumber'] - $result['hpp_target'];

                $errMsgs[] = "Nilai konversi tidak sama, silahkan cek harga per-unitnya.<br>$selisih";
                $errRows[] = "test";
            }
        }

        //        if (sizeof($rowOptValidatorRules) > 0) {
        //            foreach ($rowOptValidatorRules as $srcName => $srcSpec) {
        //                foreach ($srcSpec as $value => $pair) {
        //                    if (isset($_SESSION[$cCode]['main'][$srcName]) && $_SESSION[$cCode]['main'][$srcName] == $value) {
        //                        foreach ($pair as $k => $v) {
        //                            if (!isset($_SESSION[$cCode]['main'][$k])) {
        //                                $errMsgs[] = "$k is required";
        //
        //                                $errRows[] = $k;
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //        }
        if (sizeof($fieldMidValidatorRules) > 0) {

            if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    if ((isset($iSpec['disabled']) && $iSpec['disabled'] == "0") || !isset($iSpec['disabled'])) {
                        if (!isset($errFields[$id])) {
                            $errFields[$id] = array();
                        }
                        foreach ($fieldMidValidatorRules as $field => $label) {
                            if (!isset($iSpec[$field])) {
                                $errMsgs[] = "item $label is required";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                            if (!is_numeric($iSpec[$field])) {
                                $errMsgs[] = "item $label must be a valid number";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                            if ($iSpec[$field] < 0.5) {
                                $errMsgs[] = "item $label must be > 0";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                        }
                    }

                }
            }
            if (isset($_SESSION[$cCode]['rsltItems']) && sizeof($_SESSION[$cCode]['rsltItems']) > 0) {
                foreach ($_SESSION[$cCode]['rsltItems'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $name = $iSpec['nama'];
                    if ((isset($iSpec['disabled']) && $iSpec['disabled'] == "0") || !isset($iSpec['disabled'])) {
                        if (!isset($errFields[$id])) {
                            $errFields[$id] = array();
                        }
                        foreach ($fieldMidValidatorRules as $field => $label) {
                            if (!isset($iSpec[$field])) {
                                $errMsgs[] = "item $label $name is required";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                            if (!is_numeric($iSpec[$field])) {
                                $errMsgs[] = "item $label $name must be a valid number";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                            if ($iSpec[$field] < 0.5) {
                                $errMsgs[] = "item $label $name must be > 0";
                                $errLines[] = $id;
                                $errFields[$id][] = $field;
                            }
                        }
                    }

                }
            }

        }

        if (sizeof($fieldMidComparisonValidatorRules) > 0) {
            $result = array();
            $labels = array();
            foreach ($fieldMidComparisonValidatorRules as $field => $label) {
                if (!isset($_SESSION[$cCode]['main'][$field])) {
                    $errMsgs[] = "$field value is required";
                    $errRows[] = $field;
                }
                if ($_SESSION[$cCode]['main'][$field] < 0) {
                    $errMsgs[] = "$field must be >= 0";
                    $errRows[] = $field;
                }
                $labels[$label] = $field;
                $result[$label] = isset($_SESSION[$cCode]['main'][$field]) ? $_SESSION[$cCode]['main'][$field] : 0;
            }

            if ($result["sumber"] > $result["target"]) {
                $labelSrc = isset($labels["sumber"]) ? $labels["sumber"] : "";
                $labelTarget = isset($labels["target"]) ? $labels["target"] : "";
                $errMsgs[] = "Nilai $labelSrc lebih besar dari nilai $labelTarget.";
                $errRows[] = "test";
            }

        }

        if (sizeof($elementConfigs) > 0) {
            $hiddenMsg = "<br><span style='color:white;font-size:15px;'>" . get_class($this) . "/" . __FUNCTION__ . "</span>";
            foreach ($elementConfigs as $eName => $aSpec) {
                if (!isset($_SESSION[$cCode]['main_elements'][$eName])) {
                    if ((isset($aSpec['noValidate'])) && ($aSpec['noValidate'] == true)) {

                    }
                    else {
                        $errMsgs[] = ($aSpec['label'] . " must be filled first!");
                        echo "<script>";
                        echo "top.document.getElementById('elTitle_$eName').className='box-headers text-red text-left';";
                        echo "</script>";
                    }
                }
                else {
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            if (isset($validateReceiveElement[$eName]) && sizeof($validateReceiveElement[$eName])) {
                                $valid = 0;
                                $check = array();
                                foreach ($validateReceiveElement[$eName] as $tLabel => $textWarning) {
                                    if (strlen($_SESSION[$cCode]['main'][$eName . '__' . $tLabel]) > 10) {
                                    }
                                    else {
                                        $check[] = $tLabel;
                                    }
                                }
                                if (sizeof($check) > 1) {
                                    $errMsgs[] = ("Harap lengkapi salah satu NPWP/KTP diBillingDetails customer");
                                    foreach ($check as $nLabel) {
                                        $errMsgs[] = ("lengkapi $nLabel!");
                                    }
                                }
                            }


                            if (strlen($_SESSION[$cCode]['main_elements'][$eName]['key']) < 0.5) {
                                $errMsgs[] = ("element " . $aSpec['label'] . " must be filled with one entry!");
                                echo "<script>";
                                //                                echo "top.document.getElementById('divel_$eName').style.backgroundColor='#ffff00';";
                                echo "top.document.getElementById('elTitle_$eName').className='box-headers text-red text-left';";
                                echo "</script>";
                            }
                            else {
                                echo "<script>";
                                echo "top.document.getElementById('elTitle_$eName').className='box-headers bg-grey text-left';";
                                echo "</script>";
                            }
                            break;
                        case "dataField":
                            if (strlen($_SESSION[$cCode]['main_elements'][$eName]['value']) < 0.5) {
                                if ((isset($aSpec['noValidate'])) && ($aSpec['noValidate'] == true)) {
                                }
                                else {
                                    $errMsgs[] = ($aSpec['label'] . " must be filled with one entry!***");
                                    echo "<script>";
                                    //                                echo "top.document.getElementById('divel_$eName').style.backgroundColor='#ffff00';";
                                    echo "top.document.getElementById('elTitle_$eName').className='box-headers text-red text-left';";
                                    echo "</script>";
                                }

                            }
                            else {
                                echo "<script>";
                                echo "top.document.getElementById('elTitle_$eName').className='box-headers bg-grey text-left';";
                                echo "</script>";
                            }
                            break;
                    }

                }
            }
            foreach ($_SESSION[$cCode]['main_elements'] as $elName => $elSpec) {
                //                if(isset($elSpec['noValidate']) && ($elSpec['noValidate']==true)){
                switch ($elSpec['elementType']) {
                    case "dataField":

                        if (isset($elSpec['value'])) {
                            if (sizeof(blobDecode($elSpec['value'])) == 0) {
                                $errMsgs[] = ("Baris " . $elSpec['label'] . " belum dipilih. Silahkan dipilih dahulu. (code " . __LINE__ . ") $hiddenMsg");
                            }
                        }
                        else {
                            $errMsgs[] = ("Baris " . $elSpec['label'] . " belum dipilih. Silahkan dipilih dahulu. (code " . __LINE__ . ") $hiddenMsg");
                        }
                        break;

                    case "dataModel":

                        if (isset($elSpec['contents'])) {
                            if (sizeof(blobDecode($elSpec['contents'])) == 0) {
                                $errMsgs[] = ("Baris " . $elSpec['label'] . " belum dipilih. Silahkan dipilih dahulu. (code " . __LINE__ . ") $hiddenMsg");
                            }
                        }
                        else {
                            $errMsgs[] = ("Baris " . $elSpec['label'] . " belum dipilih. Silahkan dipilih dahulu. (code " . __LINE__ . ") $hiddenMsg");
                        }
                        break;
                }
                //                }

            }
        }

        if (sizeof($efakturValidatorConfig) > 0) {
            $enabled = isset($efakturValidatorConfig['enabled']) ? $efakturValidatorConfig['enabled'] : false;
            if ($enabled == true) {
                $kolom = isset($efakturValidatorConfig['kolom']) ? $efakturValidatorConfig['kolom'] : array();
                $source = isset($efakturValidatorConfig['source']) ? $efakturValidatorConfig['source'] : array();
                if (sizeof($kolom) > 0) {
                    foreach ($source as $vSrc) {
                        if ($_SESSION[$cCode]['main'][$vSrc] > 0) {

                            foreach ($kolom as $key => $label) {
                                if (!isset($_SESSION[$cCode]['main'][$key])) {
                                    $errMsgs[] = $label;
                                }
                            }
                        }
                    }
                }
            }
        }

        if (sizeof($followupMainNoteValidatorConfig) > 0) {
            $enabled = isset($followupMainNoteValidatorConfig['enabled']) ? $followupMainNoteValidatorConfig['enabled'] : false;
            if ($enabled == true) {
                $kolom = isset($followupMainNoteValidatorConfig['kolom']) ? $followupMainNoteValidatorConfig['kolom'] : array();
                $source = isset($followupMainNoteValidatorConfig['source']) ? $followupMainNoteValidatorConfig['source'] : array();
                if (sizeof($kolom) > 0) {
                    foreach ($source as $vSrc) {
                        //                        if ($_SESSION[$cCode]['main'][$vSrc] > 0) {

                        foreach ($kolom as $key => $label) {
                            if (!isset($_SESSION[$cCode]['main'][$key])) {
                                $errMsgs[] = $label;
                            }
                        }
                        //                        }
                    }
                }
            }
        }

        if (sizeof($paidValidatorConfig) > 0) {
            foreach ($paidValidatorConfig as $pKey => $pVal) {
                if ($_SESSION[$cCode]['main'][$pKey] <= 0) {
                    $errMsgs[] = $pVal;
                }
            }
        }

        if (sizeof($paidValidatorComparisonConfig) > 0) {
            foreach ($paidValidatorComparisonConfig as $specValidator) {
                $source = $specValidator['source'];
                $target = $specValidator['target'];
                $label = $specValidator['label'];
                $sourceValue = isset($_SESSION[$cCode]['main'][$source]) ? $_SESSION[$cCode]['main'][$source] : 0;
                $targetValue = isset($_SESSION[$cCode]['main'][$target]) ? $_SESSION[$cCode]['main'][$target] : 0;
                if (round($sourceValue, 2) != round($targetValue, 2)) {
                    $errMsgs[] = $label;
                }
            }
        }

        //----------------------------------
        cekHijau(":: VALIDATE REQUEST vs PREPROCC FIFO...");
        $preprocc = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$step]) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$step] : array();
        $preproccValidate = ($this->config->item('heTransaksi_midValidatePreProcc') != NULL) ? $this->config->item('heTransaksi_midValidatePreProcc') : array();
        if (sizeof($preprocc) > 0) {
            if (isset($preprocc['detail'])) {
                if ($preproccValidate['enabled'] == true) {
                    $jenisTrException = $preproccValidate['jenisTrException'];
                    if (!in_array($this->jenisTr, $jenisTrException)) {

                        $arrPreProcc = array();
                        foreach ($preprocc['detail'] as $preSpec) {
                            $arrPreProcc[$preSpec['comName']] = array(
                                "comName" => $preSpec['comName'],
                                "srcGateName" => $preSpec['srcGateName'],
                                "resultParams" => $preSpec['resultParams'],
                            );
                        }
                        //                    cekBiru($arrPreProcc);
                        $preproccDetail = isset($preproccValidate['preProcc']['detail']) ? $preproccValidate['preProcc']['detail'] : array();
                        if (sizeof($preproccDetail) > 0) {
                            //                        cekKuning($preproccDetail);
                            foreach ($preproccDetail as $preName => $preSpec) {
                                if (array_key_exists($preName, $arrPreProcc)) {
                                    $gateSrc = $arrPreProcc[$preName][$preSpec['sourceGate']];
                                    $gateTargets = array_keys($arrPreProcc[$preName][$preSpec['targetGate']]);
                                    $gateTarget = $gateTargets[0];
                                    //                                cekMerah("$preName == $gateSrc");
                                    //                                cekPink($gateTarget);

                                    //------akumulasi src
                                    $totalSrc = 0;
                                    $arrSrc = array();
                                    if (isset($_SESSION[$cCode][$gateSrc])) {
                                        foreach ($_SESSION[$cCode][$gateSrc] as $xx => $srcSpec) {
                                            $arrSrc[$srcSpec['id']]['name'] = $srcSpec['name'];
                                            if (!isset($arrSrc[$srcSpec['id']]['qty'])) {
                                                $arrSrc[$srcSpec['id']]['qty'] = 0;
                                            }
                                            $arrSrc[$srcSpec['id']]['qty'] += $srcSpec['qty'];
                                            $totalSrc += $srcSpec['qty'];
                                        }
                                    }

                                    //------akumulasi target
                                    $totalTarget = 0;
                                    $arrTarget = array();
                                    if (isset($_SESSION[$cCode][$gateTarget])) {
                                        foreach ($_SESSION[$cCode][$gateTarget] as $xx => $targetSpec) {
                                            $arrTarget[$targetSpec['id']]['name'] = $targetSpec['name'];
                                            if (!isset($arrTarget[$targetSpec['id']]['qty'])) {
                                                $arrTarget[$targetSpec['id']]['qty'] = 0;
                                            }
                                            $arrTarget[$targetSpec['id']]['qty'] += $targetSpec['qty'];
                                            $totalTarget += $targetSpec['qty'];
                                        }
                                    }
                                    //                                cekKuning($arrSrc);
                                    //                                cekPink($arrTarget);

                                    //--VALIDATE-----
                                    if (sizeof($arrSrc) != sizeof($arrTarget)) {
                                        // jumlah request barang tidak sama dengan yang diambil. Silahkan diperiksa lagi.
                                        $errMsgs[] = "Jumlah request barang tidak sama dengan yang diambil. Silahkan diperiksa lagi.";
                                    }
                                    else {
                                        if ($totalSrc != $totalTarget) {
                                            // jumlah total request barang tidak sama dengan yang diambil. Silahkan diperiksa lagi.
                                            $errMsgs[] = "Jumlah total request barang tidak sama dengan yang diambil. Silahkan diperiksa lagi.";
                                        }
                                        else {
                                            cekMerah(":: REQUEST DAN AMBIL FIFO COCOK ::");
                                            foreach ($arrSrc as $pID => $spec) {
                                                $gate_nama = $spec['name'];
                                                $gate_jml = $spec['qty'];
                                                $fifo_jml = isset($arrTarget[$pID]['qty']) ? $arrTarget[$pID]['qty'] : 0;
                                                if ($gate_jml != $fifo_jml) {
                                                    $msg = "$gate_nama, jumlah request $gate_jml, tidak sama dengan jumlah masuk persediaan, jumlah masuk $fifo_jml";
                                                    $errMsgs[] = $msg;
                                                }
                                                else {
                                                    cekHijau("$gate_nama, cocok [req: $gate_jml] [fifo: $fifo_jml]");
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        //----------------------------------


        cekBiru($errMsgs);
        if (sizeof($errMsgs) > 0) {
            $_SESSION['errMsg'] = implode("<br>", $errMsgs);

            if (sizeof($errLines) > 0) {
                $_SESSION['errLines'] = $errLines;
            }
            if (sizeof($errFields) > 0) {
                $_SESSION['errFields'] = $errFields;
            }

            echo lgShowAlert($_SESSION['errMsg']);
            die();
        }

    }

    public function unionValidate()
    {
        $unionValidatorRules = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartUnionValidators"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shoppingCartUnionValidators"] : array();


        $cCode = "_TR_" . $this->jenisTr;

        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
        //matiHEre();

        $errMsgs = array();
        $errLines = array();
        $errFields = array();
        $errRows = array();


        if (sizeof($unionValidatorRules) > 0) {
            $result = array();
            $validateFields = 0;
            foreach ($unionValidatorRules as $uSpec) {

                foreach ($uSpec as $field => $label) {
                    $validateFields++;
                    if (!isset($_SESSION[$cCode]['main'][$field])) {
                        $result[$field] = "$label value is required";
                    }
                }
                //                $result[$field] = isset($_SESSION[$cCode]['main'][$field]) ? $_SESSION[$cCode]['main'][$field] : 0;
            }
            //            cekHitam(sizeof($result));
            //            matiHEre($validateFields);
            if (sizeof($result) == $validateFields) {
                foreach ($result as $field => $label) {
                    $errMsgs[] = $label;
                    $errRows[] = $field;
                }
            }

        }

        //        matiHere(sizeof($result) ." ==". $validateFields);

        if (sizeof($errMsgs) > 0) {
            $_SESSION['errMsg'] = implode("<br>", $errMsgs);
            //            print_r($_SESSION['errMsg']);
            //            echo "<script>";
            //            echo "top.getData('" . base_url() . "_shoppingCart/viewCart/" . $this->jenisTr . "?selID=$id','shopping_cart');";
            //            echo "</script>";
            if (sizeof($errLines) > 0) {
                $_SESSION['errLines'] = $errLines;
            }
            if (sizeof($errFields) > 0) {
                $_SESSION['errFields'] = $errFields;
            }

            echo lgShowAlert($_SESSION['errMsg']);
            die();
        }
        //        else {
        //
        //            $actionTarget = "top.BootstrapDialog.show(                                   {
        //                                       title:'preview',
        //                                        message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/preview/" . $this->jenisTr . "?rawPrev=$rawPrevURL'),
        //                                        draggable:false,
        //                                        size:top.BootstrapDialog.SIZE_WIDE,
        //                                        type:top.BootstrapDialog.TYPE_SUCCESS,
        //                                        closable:true,
        //                                        }
        //                                        );";
        //
        //            echo "<html>";
        //            echo "<head>";
        //            echo "<script src=\"" . cdn_suport()."AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
        //            echo "</head>";
        //            echo "<body onload=\"$actionTarget\">";
        //            echo "</body>";
        //
        //        }
    }

    public function lastValidate($trID = "")
    {
        $cCode = "_TR_" . $this->jenisTr;
        $step = $_SESSION[$cCode]['main']['step_number'];
        $errMsgs = array();


        //region cek request vs ambil fifo
        cekhijau(":: VALIDATE AKHIR request vs postprocc fifo...");
        $postprocc = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$step]) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$step] : array();
        $postproccValidate = ($this->config->item('heTransaksi_validatePostProcc') != NULL) ? $this->config->item('heTransaksi_validatePostProcc') : array();
        if (sizeof($postprocc) > 0) {
            if (isset($postprocc['detail'])) {
                if ($postproccValidate['enabled'] == true) {
                    $jenisTrException = $postproccValidate['jenisTrException'];
                    if (!in_array($this->jenisTr, $jenisTrException)) {

                        $arrPostProcc = array();
                        foreach ($postprocc['detail'] as $postSpec) {
                            $arrPostProcc[$postSpec['comName']] = array(
                                "comName" => $postSpec['comName'],
                                "srcGateName" => $postSpec['srcGateName'],
                                //                            "resultParams" => $postSpec['resultParams'],
                            );
                        }
                        $postproccDetail = isset($postproccValidate['postProcc']['detail']) ? $postproccValidate['postProcc']['detail'] : array();
                        if (sizeof($postproccDetail) > 0) {
                            foreach ($postproccDetail as $postName => $postSpec) {
                                if (array_key_exists($postName, $arrPostProcc)) {
                                    $srcGateName = $arrPostProcc[$postName]['srcGateName'];
                                    $model = $postSpec['model'];
                                    $models = "Mdl" . $model;
                                    $arrGateItems = array();
                                    $arrFifoItems = array();
                                    //                                cekPink($arrPostProcc);
                                    //                                cekPink($model);
                                    //                                cekPink($srcGateName);

                                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $xSpec) {
                                        $arrGateItems[$xSpec['id']]['name'] = $xSpec['name'];
                                        if (!isset($arrGateItems[$xSpec['id']]['jml'])) {
                                            $arrGateItems[$xSpec['id']]['jml'] = 0;
                                        }
                                        $arrGateItems[$xSpec['id']]['jml'] += $xSpec['jml'];
                                    }

                                    //region FIFO, detail
                                    $this->load->model("Mdls/" . $models);
                                    $m = New $models();
                                    $m->addFilter("transaksi_id='$trID'");
                                    $mTmp = $m->lookupAll()->result();
                                    //endregion

                                    if (sizeof($mTmp) > 0) {
                                        foreach ($mTmp as $fSpec) {
                                            $arrFifoItems[$fSpec->produk_id]['nama'] = $fSpec->produk_nama;
                                            if (!isset($arrFifoItems[$fSpec->produk_id]['jml'])) {
                                                $arrFifoItems[$fSpec->produk_id]['jml'] = 0;
                                            }
                                            $arrFifoItems[$fSpec->produk_id]['jml'] += $fSpec->unit;
                                        }
                                    }
                                    else {
                                        $msg = "Transaksi gagal, karena gagal eksekusi fifo persediaan. Segera hubungi admin.";
                                        $errMsgs[] = $msg;
                                    }

                                    //--KALKULASI
                                    //                                cekHijau($arrFifoItems);
                                    //                                cekhijau($arrGateItems);
                                    if (count($arrFifoItems) != count($arrGateItems)) {
                                        $msg = "Transaksi gagal, karena total item yang direquest tidak sama dengan total items yang masuk persediaan. Segera hubungi admin.";
                                        $errMsgs[] = $msg;
                                    }
                                    else {
                                        cekHijau(":: fifo: " . count($arrFifoItems) . ", request: " . count($arrGateItems) . " ::");
                                        foreach ($arrGateItems as $pID => $spec) {
                                            $gate_nama = $spec['name'];
                                            $gate_jml = $spec['jml'];
                                            $fifo_jml = isset($arrFifoItems[$pID]['jml']) ? $arrFifoItems[$pID]['jml'] : 0;
                                            if ($gate_jml != $fifo_jml) {
                                                $msg = "$gate_nama, jumlah request $gate_jml, tidak sama dengan jumlah masuk persediaan, jumlah masuk $fifo_jml";
                                                $errMsgs[] = $msg;
                                            }
                                            else {
                                                cekHijau("$gate_nama, cocok [req: $gate_jml] [fifo: $fifo_jml]");
                                            }
                                        }

                                    }
                                }
                            }
                        }
                    }
                }

            }
        }
        //endregion

        cekBiru($errMsgs);
        if (sizeof($errMsgs) > 0) {
            $_SESSION['errMsg'] = implode("<br>", $errMsgs);
            //
            //            if (sizeof($errLines) > 0) {
            //                $_SESSION['errLines'] = $errLines;
            //            }
            //            if (sizeof($errFields) > 0) {
            //                $_SESSION['errFields'] = $errFields;
            //            }
            //
            echo lgShowAlert($_SESSION['errMsg']);
            die();
        }


    }

    public function inspect()
    {
        $no = $this->uri->segment(3);
        $tr = new MdlTransaksi();
        $tmp = $tr->lookupJoinedInspectionByMasterID($no)->result();
        //cekKuning($this->db->last_query());
    }

    public function followupPrePreview()
    {
        $no = rtrim($this->uri->segment(3), "-");
        //        $targetStepNum = $this->uri->segment(4);
        $stepNumber = $this->uri->segment(4);
        $currentStepNum = $this->uri->segment(5);
        $rawBuilderURL = blobEncode(current_url());


        // region mengunci transaksi by $no dan userID
        if ($this->session->login['ghost'] == 0) {

            $this->load->model("Mdls/MdlLockerTransaksi");
            $lt = New MdlLockerTransaksi();
            $lt->addFilter("transaksi_id='$no'");
            //        $lt->addFilter("state='hold'");
            //        $lt->addFilter("jumlah='1'");
            //        $lt->addFilter("oleh_id='" . $this->session->login['id'] . "'");
            //
            $ltTmp = $lt->lookupAll()->result();
            if (sizeof($ltTmp) == 0) {
                $ltActive = array(
                    "state" => "active",
                    "produk_id" => "$no",
                    "transaksi_id" => "$no",
                    "cabang_id" => $this->session->login['cabang_id'],
                    "oleh_id" => 0,
                    "oleh_nama" => "",
                    "jenis" => "transaksi",
                    "jenis_locker" => "transaksi",
                    "jumlah" => "0",
                    "gudang_id" => "0",
                );
                $ltHold = array(
                    "state" => "hold",
                    "produk_id" => "$no",
                    "transaksi_id" => "$no",
                    "cabang_id" => $this->session->login['cabang_id'],
                    "oleh_id" => $this->session->login['id'],
                    "oleh_nama" => $this->session->login['nama'],
                    "jenis" => "transaksi",
                    "jenis_locker" => "transaksi",
                    "jumlah" => "1",
                    "gudang_id" => "0",
                );

                // insert ke tabel locker transaksi
                $lt->addData($ltActive);
                $lt->addData($ltHold);
            }
            else {
                $byUpdateHold = array();
                $totalUpdateHold = 0;
                $insertHold = true;
                foreach ($ltTmp as $ltSpec) {
                    if (($ltSpec->state == "hold") && ($ltSpec->jumlah == "1")) {
                        $insertHold = false;
                        break;
                    }
                    elseif (($ltSpec->state == "hold")) {
                        $totalUpdateHold += isset($ltSpec->jumlah) ? $ltSpec->jumlah : 0;
                        $byUpdateHold[] = $ltSpec->oleh_id;
                    }
                }
                if ($insertHold == true) {
                    if (($totalUpdateHold == 0) && (in_array($this->session->login['id'], $byUpdateHold))) {
                        $ltHold = array(
                            "jumlah" => "1",
                        );
                        $ltWhere = array(
                            "state" => "hold",
                            "produk_id" => "$no",
                            "transaksi_id" => "$no",
                            "jenis" => "transaksi",
                            "jenis_locker" => "transaksi",
                            "oleh_id" => $this->session->login['id'],
                        );
                        $lt->updateData($ltWhere, $ltHold);
                    }
                    else {
                        //                    cekPink("total HOLDnya 0 dan saya BELUM pernah HOLD transaksi ini");
                        $ltHold = array(
                            "state" => "hold",
                            "produk_id" => "$no",
                            "transaksi_id" => "$no",
                            "cabang_id" => $this->session->login['cabang_id'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "jenis" => "transaksi",
                            "jenis_locker" => "transaksi",
                            "jumlah" => "1",
                            "gudang_id" => "0",
                        );
                        $lt->addData($ltHold);
                    }

                    $ltActive = array(
                        "jumlah" => "0",
                    );
                    $ltWhere = array(
                        "state" => "active",
                        "produk_id" => "$no",
                        "transaksi_id" => "$no",
                        "jenis" => "transaksi",
                        "jenis_locker" => "transaksi",
                    );
                    $lt->updateData($ltWhere, $ltActive);
                }
                else {
                    //                cekPink("sudah ada yang HOLD");
                }
            }
        }
        // endregion


        //        mati_disini();

        //
        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();

        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        //        $tr->addFilter("step_number='" . $currentStepNum . "'");
        $tmpTr = $tr->lookupJoined()->result();
        cekBiru($this->db->last_query());
        //        arrprint($tr->getFilters());
        //endregion


        $cancelPackingId = isset($tmpTr[0]->cancel_packing_source_id) ? $tmpTr[0]->cancel_packing_source_id : 0;
        $tmpTrCancelPacking = array();
        $id_top_source_cancel_packing = array();
        if ($cancelPackingId > 0) {
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $cancelPackingId)) . ")");
            $tmpTrCancelPacking = $tr->lookupJoined()->result();
            $id_top_source_cancel_packing = $tmpTrCancelPacking[0]->id_top;
        }


        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        //        cekKuning($this->db->last_query());
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {

                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }


        $rawItems = array();

        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $cCode = "_TR_" . $this->jenisTr;
            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }

            //            $stepNumber = isset($_SESSION[$cCode]['tableIn_master']['step_number']) ? $_SESSION[$cCode]['tableIn_master']['step_number'] : 1;
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber] : null;
            //            $masterID = isset($tmpTr[0]->referensi_id) && $tmpTr[0]->referensi_id > 0 ? $tmpTr[0]->referensi_id : $tmpTr[0]->transaksi_id;
            $measurementDetails = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"] : array();
            $validatePaymentLocker = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["validatePaymentSource"][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["validatePaymentSource"][$stepNumber] : array();
            $itemsChild = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fields']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fields'] : array();//dipake detil pembelian aset
            $itemsChildGate = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['gate']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['gate'] : array();//dipake detil pembelian aset/penambahan aset dari supplies sebagai switcer baca item atau main


            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = ($currentStepNum + 1);


            //region periksa locker value;
            $tempLocker = array();
            $tempBtnUndo = array();
            if (sizeof($validatePaymentLocker) > 0) {
                $mdlName = "Mdls/" . $validatePaymentLocker;
                $this->load->model($mdlName);
                $l = new $validatePaymentLocker();
                $l->addFilter("transaksi_id='$no'");
                $l->addFilter("state='active'");
                $l->addFilter("nilai > 0");
                $tempLocker = $l->lookupAll()->result();
                //cekUngu($this->db->last_query() . " >> $validatePaymentLocker");
                //arrPrint($tempLocker);
                if (sizeof($tempLocker) > 0) {
                    $tempBtnUndo = array(
                        "allowedUndone" => false,//tidak boleh di undo/reject
                        "allowedFollow" => false,//boleh di followup
                    );
                }
                else {
                    //                    arrPrint($this->config->item('payment_source')[$this->jenisTr]);
                    //                    cekKuning(":: $currentStepNum ::");
                    $jnTarget = isset($this->config->item('payment_source')[$this->jenisTr][$currentStepNum][0]['jenisTarget']) ? $this->config->item('payment_source')[$this->jenisTr][$currentStepNum][0]['jenisTarget'] : "";
                    //                    cekHitam(":: ** $jnTarget ** ::");
                    $tempBtnUndo = array(
                        "allowedUndone" => true,// boleh di undo/reject
                        "allowedFollow" => true,//tidak boleh di followup
                        "label" => isset($this->config->item('heTransaksi_ui')[$jnTarget]['label']) ? $this->config->item('heTransaksi_ui')[$jnTarget]['label'] : "",
                    );
                }
            }


            //            arrPrint($tempLocker);
            //endregion

            //            cekHEre($itemsChildGate);
            //==periksa apakah ada ganjalan
            $trA = new MdlTransaksi();
            $extSteps = $trA->lookupExtSteps($masterID);
            if (sizeof($extSteps) > 0) {
                //                cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
            }
            else {
                //                cekhijau("TAK ada ganjalan step");
            }
            $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");
            if (sizeof($paySrcs) > 0) {
                //                cekmerah("ada ganjalan paymentSrc sebanyak " . sizeof($paySrcs));
            }
            else {
                //                cekhijau("TAK ada ganjalan paymentSrc");
            }


            $allowEdit = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit'] : false;
            $allowCancel = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowCancel'] : false;
            $editableFields = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber] : array();


            //region valid items
            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();

            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");


            $tr->addFilter("sub_step_number='" . $currentStepNum . "'");
            $tr->addFilter("next_substep_code='" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['target'] . "'");
            $tr->addFilter("next_substep_num='$stepNumber'");
            $tr->addFilter("valid_qty>0");

            $tmpTr = $tr->lookupJoined()->result();
            //            cekhitam($this->db->last_query());

            $id_top = isset($tmpTr[0]->id_top) ? $tmpTr[0]->id_top : "";


            //            arrPrint($tmpTr);
            //            cekHere($id_top);
            //            cekHere($no);
            //            matiHere($no);


            if ($id_top != "") {
                $idTr = isset($tmpTr[0]->id) ? $tmpTr[0]->id : "";
                $trPack = new MdlTransaksi();
                $trPack->setFilters(array());
                $trPack->addFilter("id_top in (" . implode(",", explode("-", $id_top)) . ")");
                $trPack->addFilter("valid_qty>0");
                $tmpTrPacked = $trPack->lookupJoined()->result();
            }


            $tmpTrPrePacked = array();
            if (sizeof($id_top_source_cancel_packing) > 0) {
                $trPrePack = new MdlTransaksi();
                $trPrePack->setFilters(array());
                $trPrePack->addFilter("id_top in (" . implode(",", explode("-", $id_top_source_cancel_packing)) . ")");
                $trPrePack->addFilter("valid_qty>0");
                $trPrePack->addFilter("trash_4<1");
                $tmpTrPrePacked = $trPrePack->lookupJoined()->result();
            }
            else {
                $trPrePack = new MdlTransaksi();
                $trPrePack->setFilters(array());
                $trPrePack->addFilter("cancel_packing_source_id in (" . implode(",", explode("-", $no)) . ")");
                $trPrePack->addFilter("valid_qty>0");
                $trPrePack->addFilter("trash_4<1");
                $tmpTrPrePacked = $trPrePack->lookupJoined()->result();
            }

            $arrPreTmp__ = array();
            foreach ($tmpTrPrePacked as $y => $dd) {
                if (!isset($arrPreTmp__[$dd->jenis][$dd->produk_id])) {
                    $arrPreTmp__[$dd->jenis][$dd->produk_id] = 0;
                }
                $arrPreTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
            }

            $arrTmp__ = array();

            if (sizeof($tmpTrPacked) > 0) {
                foreach ($tmpTrPacked as $y => $dd) {
                    if (!isset($arrTmp__[$dd->jenis][$dd->produk_id])) {
                        $arrTmp__[$dd->jenis][$dd->produk_id] = 0;
                    }
                    $arrTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
                }
            }

            //            arrPrint($arrPreTmp__);
            //            matiHere();

            $extractedItems = array();//==untuk urusan update transaksi referer
            $validItems = array();
            $validItemSends = array();
            $validItemReqCancels = array();
            $validItemCancels = array();
            $validItemPreCancels = array();
            $validItemSents = array();

            if (sizeof($tmpTr) > 0) {
                cekmerah("ada yang mau diekstrak");
                foreach ($tmpTr as $row) {
                    if (!isset($validItems[$row->produk_id])) {
                        $validItems[$row->produk_id] = 0;
                    }
                    if (!isset($validItemSends[$row->produk_id])) {
                        $validItemSends[$row->produk_id] = 0;
                    }
                    if (!isset($validItemCancels[$row->produk_id])) {
                        $validItemCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemReqCancels[$row->produk_id])) {
                        $validItemReqCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPackeds[$row->produk_id])) {
                        $validItemPackeds[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPreCancels[$row->produk_id])) {
                        $validItemPreCancels[$row->produk_id] = 0;
                    }

                    $validItems[$row->produk_id] += isset($row->valid_qty) ? $row->valid_qty : 0;
                    $validItemSends[$row->produk_id] += isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0;
                    $validItemCancels[$row->produk_id] += isset($row->cancel_qty) ? $row->cancel_qty : 0;
                    $validItemReqCancels[$row->produk_id] += isset($row->req_cancel_qty) ? $row->req_cancel_qty : 0;
                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0;
                    $validItemPackeds[$row->produk_id] += isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0;

                    if (!isset($extractedItems[$row->produk_id])) {
                        $extractedItems[$row->produk_id] = array();
                    }
                    $extractedItems[$row->produk_id][$row->id] = array(
                        "id" => $row->id,
                        "produk_id" => $row->produk_id,
                        "qty" => $row->produk_ord_jml,
                        "valid_qty" => $row->valid_qty,
                        "transaksi_id" => $row->transaksi_id,
                        "packed_qty" => isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0,
                        "sent_qty" => isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0,
                        "req_cancel_qty" => isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0,
                        "cancel_qty" => $row->cancel_qty,
                        "outstanding" => $row->produk_ord_jml - ($row->produk_ord_jml - $row->valid_qty),
                    );
                }
            }
            else {
                cekmerah("TIDAK ada yang mau diekstrak");
            }
            cekBiru($validItems);


            //endregion


            //
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //            //cekMerah($this->db->last_query());
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //            arrPrint($detailValues);
            //endregion


            //region take from registries
            //==ambil value-gate
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            //            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $tmpReg = $trr->lookupRegistries()->result();
            //            $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();
            cekKuning($this->db->last_query());
            //            matiHere();
            $main = array();
            $items = array();
            $items2 = array();
            $items2_sum = array();
            $items3 = array();
            $items3_sum = array();
            $items4_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();

            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();
            //            $mainApplets = array();
            $mainElements = array();
            $mainInputs = array();
            $itemsKomposisi = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = $main + unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = $items + unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = $items2 + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems"://
                            $rsltItems = $rsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems2"://
                            $rsltItems2 = $rsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = $items2_sum + unserialize(base64_decode($row->values));
                            break;
                        case "items3"://
                            $items3 = $items3 + unserialize(base64_decode($row->values));
                            break;
                        case "items3_sum"://
                            $items3_sum = $items3_sum + unserialize(base64_decode($row->values));
                            break;
                        case "items4_sum"://
                            $items4_sum = $items4_sum + unserialize(base64_decode($row->values));
                            break;

                        case "tableIn_master"://
                            $masterTableInParams = $masterTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = $childTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems"://
                            $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems2"://
                            $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems"://
                            $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems2"://
                            $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = $masterAddValues + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = $masterAddFields + unserialize(base64_decode($row->values));
                            break;
                        //                        case "main_applets"://
                        //                            $mainApplets = unserialize(base64_decode($row->values));
                        //                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "main_inputs"://
                            $mainInputs = unserialize(base64_decode($row->values));
                            break;
                        case "items_komposisi"://
                            $itemsKomposisi = unserialize(base64_decode($row->values));
                            break;
                    }
                }

            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion


            //region replacer Downpayment avail
            if (isset($mainInputs['dp'])) {
                if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["updateDownpayment"][$stepNumber])) {
                    //                    arrPrint($mainInputs);
                    $this->load->model("Coms/ComLockerValue");
                    $mi = new ComLockerValue();
                    $mi->addFilter("produk_id='" . $main['masterID'] . "'");
                    $mainInputAvail = $mi->fetchBalances("downpayment");
                    $lockerVal = $mainInputAvail[0]->nilai;
                    //                    $mainValTmp = reversePpn($mainInputs['dp'],"10");
                    $mainValTmp_dp = $main['dp_value'];
                    $mainValTmp_dp_ppn = $main['dp_ppn_value'];

                    if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                        cekOrange();
                        $validate = round($mainInputAvail[0]->nilai - $mainValTmp_dp, 2);
                        if ($lockerVal > 0) {
                            $valnew = $main['new_net1'] - $lockerVal > 0 ? 0 : $main['new_net1'];
                            $main['dp_value'] = $valnew;
                            $main['dp_ppn_value'] = $valnew * 10 / 100;
                        }
                        else {
                            $main['dp_value'] = 0;
                            $main['dp_ppn_value'] = 0;
                            //                        $main['valid_dp'] = 0;
                        }

                        if ($validate > 0) {
                            $mainInputs['dp'] = $mainInputAvail[0]->nilai;

                        }
                        else {
                            if ($validate < 0) {
                                if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                                    $main['downpayment'] = $mainInputs['dp'];
                                    $mainInputs['downpayment'] = $mainInputs['dp'];
                                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['dp_ppn_value'];

                                }
                                unset($mainInputs['dp']);
                                //                                cekhere("sini po");
                            }
                            //                        if(!isset($main['valid_dp'])){
                            //                            $main['valid_dp'] = $mainInputAvail[0]->nilai;
                            //                        }

                        }
                    }
                    else {
                        //                         $mainInputs['dp'] = 0;
                        $main['dp_value'] = 0;
                        $main['dp_ppn_value'] = 0;
                        unset ($mainInputs['dp']);
                    }

                    if (!isset($main['valid_dp'])) {
                        $main['valid_dp'] = $mainInputAvail[0]->nilai;
                    }
                }


            }
            else {
                if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                    $main['downpayment'] = $main['dp'];
                    $mainInputs['downpayment'] = $main['dp'];
                    //                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['nilai_tambah_ppn_out'];
                    $main['total_ui'] = $masterTableInValueParams['new_net1'] - $main['valid_dp'];
                    cekBiru($masterTableInValueParams['new_net1'] . " - " . $main['valid_dp']);
                }
                else {
                    if (isset($masterTableInValueParams['new_net1'])) {

                        $main['total_ui'] = $masterTableInValueParams['new_net1'];
                    }
                    else {
                        $main['total_ui'] = $masterTableInValueParams['nett1'];
                        $main['new_grand_ppn'] = $masterTableInValueParams['grand_ppn'];
                    }
                }
            }
            //endregion

            $masterReplacers = array(
                "jenisTrMaster" => $this->jenisTr,
                "jenisTrTop" => $masterTableInParams['jenis_top'],
                "harga" => 0,
                "masterID" => $masterID,
            );
            foreach ($masterReplacers as $key => $src) {
                $main[$key] = $src;
                $mainValues[$key] = $src;
                $masterGates[$key] = $src;
            }


            //==revalidate items
            $this->load->library("FieldCalculator");
            $this->load->helper("he_angka");
            $cal = new FieldCalculator();
            cekKuning($items2);
            //arrPrint($items);
            $itemChildData = array();
            if (sizeof($items) > 0) {

                foreach ($items as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $tipeSize = isset($iSpec['detilSize']) && sizeof($iSpec['detilSize']) > 0 ? $iSpec['detilSize'] : "";

                    if (array_key_exists($id, $validItems)) {
                        $items[$id]['jml'] = $validItems[$id];
                        //                        $items[$id]['jml'] = $validItems[$id]-(int)$validItemPreCancels[$id];
                        $items[$id]['max_jml'] = $validItems[$id];
                        //                        $items[$id]['max_jml'] = $validItems[$id]-(int)$validItemPreCancels[$id];
                        $items[$id]['packed_jml'] = $validItemPackeds[$id];
                        $items[$id]['sent_jml'] = $validItemSends[$id];
                        $items[$id]['cancel_jml'] = $validItemCancels[$id];
                        $items[$id]['req_cancel_jml'] = $validItemPreCancels[$id];
                        if (sizeof($editableFields) > 0) {
                            foreach ($editableFields as $fName) {
                                $items[$id]["max_$fName"] = isset($iSpec[$fName]) ? $iSpec[$fName] : 0;
                            }
                        }

                        if (sizeof($measurementDetails)) {
                            if (in_array($stepNumber, $measurementDetails["allowView"]) && isset($measurementDetails[$tipeSize])) {
                                $selectedColl = $measurementDetails[$tipeSize];
                                foreach ($selectedColl as $colSelected => $tempHelper) {
                                    foreach ($tempHelper as $newKey => $heAngka) {
                                        $items[$id][$newKey] = $heAngka($iSpec[$colSelected]);
                                    }
                                }
                            }
                        }


                        if ($subAmountConfig != null) {
                            $tmpEx = $cal->multiExplode($subAmountConfig);
                            if (sizeof($tmpEx) > 1) {
                                //                            echo lgShowAlert("menghitung subtotal pakai rumus $subAmountConfig di step ke # $stepNumber");
                                $newSrc = $subAmountConfig;
                                foreach ($tmpEx as $key2 => $val2) {
                                    if (isset($items[$id][$val2])) {
                                        $newSrc = str_replace($val2, $items[$id][$val2], $newSrc);

                                    }
                                    else {
                                        if (isset($tmp[$val2])) {
                                            $newSrc = str_replace($val2, $items[$val2], $newSrc);

                                        }
                                        else {
                                            $newSrc = str_replace($val2, "0", $newSrc);

                                        }
                                    }


                                }
                                $subtotal = $cal->calculate($newSrc);


                            }
                            else {
                                //                            echo lgShowAlert("memasang subtotal dari $subAmountConfig");
                                $subtotal = $items[$id][$subAmountConfig];

                            }
                        }
                        else {
                            //                        echo lgShowAlert("tidak mengapa-apakan subtotal");
                            $subtotal = 0;

                        }

                        $items[$id]['subtotal'] = $subtotal;
                        //region item child

                        if (sizeof($itemsChild) > 0 && ($itemsChildGate == 'detail')) {
                            //                        if (sizeof($itemsChild)  > 0 ) {
                            for ($x = 1; $x <= $validItems[$id]; $x++) {
                                foreach ($itemsChild as $col => $col_label) {
                                    $itemChildData[$id][$x][$col] = isset($items[$id][$col]) ? $items[$id][$col] : "";
                                    $itemChildData[$id][$x]["jml"] = 1;
                                    $itemChildData[$id][$x]["qty"] = 1;
                                    $itemChildData[$id][$x]["folders"] = $main['pihakMainID'];
                                }

                            }
                            //                            arrPrint($itemsChild);
                            //                        foreach ($itemsChild as )
                        }

                        //endregion
                        cekBiru($itemsKomposisi);
                        if (sizeof($itemsKomposisi) > 0) {
                            if (array_key_exists($id, $itemsKomposisi)) {
                                //                                cekBiru(":: ADA komposisinya yaitu $id ::");
                                foreach ($items2[$id] as $jenis_komposisi => $iiSpec) {
                                    foreach ($iiSpec as $ee => $eeSpec) {
                                        $komposisi = $itemsKomposisi[$id][$jenis_komposisi][$ee];
                                        // re-kalkulasi gerbang items2
                                        $items2[$id][$jenis_komposisi][$ee]['jml'] = $komposisi->jml * $validItems[$id];
                                        $items2[$id][$jenis_komposisi][$ee]['sub_nilai'] = $komposisi->nilai * $validItems[$id];
                                        cekhijau("pID: $id [], jml: " . $komposisi->jml . " validItems: " . $validItems[$id]);
                                    }
                                }
                            }
                        }


                    }
                    else {
                        unset($items[$id]);
                        unset($items2[$id]);
                        unset($childGates[$id]);
                        unset($childTableInParams[$id]);
                        unset($childTableInValueParams[$id]);

                    }
                }

//cekKuning($items2_sum);
                cekPink($items2);
                if (sizeof($itemsKomposisi) > 0) {
                    $items2_sum = array();// supplies-nya...
                    $items3_sum = array();// biaya-nya...
                    foreach ($items2 as $pID => $pSpec) {
                        foreach ($pSpec as $jenis => $jSpec) {
                            foreach ($jSpec as $eSpec) {
                                if ($jenis == "produk") {
                                    if (!isset($items2_sum[$eSpec['id']])) {
                                        $items2_sum[$eSpec['id']] = $eSpec;
                                        $items2_sum[$eSpec['id']]['jml'] = 0;
                                        $items2_sum[$eSpec['id']]['produk_ids'] = array();
                                    }
                                    $items2_sum[$eSpec['id']]['jml'] += $eSpec['jml'];
                                    $items2_sum[$eSpec['id']]['produk_ids'][$pID] = $pID;

                                    cekBiru("pID: " . $eSpec['id'] . " jml: " . $eSpec['jml']);
                                }
                                if ($jenis == "biaya") {
                                    if (!isset($items3_sum[$eSpec['id']])) {
                                        $items3_sum[$eSpec['id']] = $eSpec;
                                        $items3_sum[$eSpec['id']]['jml'] = 0;
                                        $items3_sum[$eSpec['id']]['sub_nilai'] = 0;
                                        $items3_sum[$eSpec['id']]['produk_ids'] = array();
                                    }
                                    $items3_sum[$eSpec['id']]['jml'] += $eSpec['jml'];
                                    $items3_sum[$eSpec['id']]['sub_nilai'] += $eSpec['sub_nilai'];
                                    $items3_sum[$eSpec['id']]['produk_ids'][$pID] = $pID;
                                }
                            }
                        }
                    }
                }

            }


            if (sizeof($itemsChild) > 0 && ($itemsChildGate == 'main')) {
                //                arrPrint($main);
                $fieldAlias = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fieldAlias']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fieldAlias'] : $itemsChild;//dipake detil pembelian aset
                foreach ($fieldAlias as $col => $col_label) {
                    $itemChildData[$main['pihakMainRulesID']][1][$col] = isset($main[$col_label]) ? $main[$col_label] : "";
                }
                $itemChildData[$main['pihakMainRulesID']][1]["jml"] = 1;
                $itemChildData[$main['pihakMainRulesID']][1]["qty"] = 1;
                $itemChildData[$main['pihakMainRulesID']][1]["folders"] = $main['pihakID'];
                cekBiru("main");
            }

// matiHere();
            //region session-swapper
            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "items3" => $items3,
                "items3_sum" => $items3_sum,
                "items4_sum" => $items4_sum,
                "items_child" => $itemChildData,
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => $extractedItems,


                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                //        ""=>$childAddValues ,
                "main_add_fields" => $masterAddFields,
                //                "main_applets"          => $mainApplets,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                //
                "extSteps" => $extSteps,
                "paySrcs" => $paySrcs,
                "lockerPayment" => $tempBtnUndo,
                "items_komposisi" => $itemsKomposisi,
            );
            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;

            }
            //endregion
//arrPrint($_SESSION[$cCode]['items2_sum']);
// mati_disini();
            $this->load->helper("he_value_builder");

            //-------------------------------------------
            $receiptElementsInjector = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptElementsInjector"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptElementsInjector"] : array();
            if (sizeof($receiptElementsInjector) > 0) {
                foreach ($receiptElementsInjector as $eName => $eSpec) {
                    arrprintWebs($eSpec);
                    if ((!isset($main[$eName])) || (!isset($mainElements[$eName]))) {
                        cekhitam("tidak kenal ppv, maka diinjeckkan...");
                        if (isset($eSpec['defaultValue'])) {//==cek apakah ada seting defaultValue
                            //                        cekmerah("default value for $eName is: " . $eSpec['defaultValue']);
                            $defValueSrc = $eSpec['defaultValue'];
                            switch ($eSpec['elementType']) {
                                case "dataModel":
                                    heFetchElement($this->jenisTr, $eName, $eSpec['mdlName'], $defValueSrc);
                                    break;
                                case "dataField":
                                    heRecordElement($this->jenisTr, $eName, $defValueSrc);
                                    break;
                            }
                            $_SESSION[$cCode]['main_elements'][$eName]['autoSelect'] = true;
                        }
                        else {//==cek apakah pilihannya cuma satu
                            if (isset($eSpec['noPrefetch']) && $eSpec['noPrefetch'] == true) {

                            }
                            else {
                                //                            cekHere(__LINE__);
                                switch ($eSpec['elementType']) {
                                    case "dataModel":
                                        $amdlName = $eSpec['mdlName'];
                                        $this->load->model("Mdls/" . $amdlName);
                                        $labelSrc = $eSpec['labelSrc'];
                                        $keySrc = $eSpec['key'];
                                        $oo = new $amdlName();
                                        $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();
                                        //                                    cekHitam($amdlName);
                                        //                                    arrPrint($aFilter);
                                        if (sizeof($aFilter) > 0) {
                                            $oo = makeFilter($aFilter, $_SESSION[$cCode]['main'], $oo);
                                        }
                                        $tmpo = $oo->lookupAll()->result();
                                        if (sizeof($tmpo) == 1) {
                                            $usedKey = $eSpec['key'];
                                            $defValueSrc = $tmpo[0]->$usedKey;
                                            heFetchElement($this->jenisTr, $eName, $eSpec['mdlName'], $defValueSrc);
                                        }
                                        break;
                                    case "dataField":
                                        break;
                                }
                            }
                        }

                        resetValues($this->jenisTr);
                        fillValues($this->jenisTr, $this->uri->segment(5), $this->uri->segment(4));

                    }
                }
            }
            //            arrprint($_SESSION[$cCode]['main']);
            //            arrprint($_SESSION[$cCode]['main_elements']);
            //            mati_disini();
            //-------------------------------------------


            //==init replacer
            //==recover nilai HARGA master
            $_SESSION[$cCode]['main']['harga'] = 0;
            $_SESSION[$cCode]['main']['currentID'] = $no;

            //==default load dari nota, maka dianggap langsung done
            $_SESSION[$cCode]['main']['status_4'] = 1;
            $_SESSION[$cCode]['main']['trash_4'] = 0;
            if (sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);

                }
            }


            //            $this->load->helper("he_value_builder");
            resetValues($this->jenisTr);
            fillValues($this->jenisTr, $this->uri->segment(5), $this->uri->segment(4));


            $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
                                   {
                                       title:'Followup preview',
                                       message: " . 'top.$' . "('<div></div>').load('" . base_url() . "Transaksi/followupPreview/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "?rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        type:top.BootstrapDialog.TYPE_DEFAULT,
                                        draggable:true,
                                        closable:false,
                                        
                                        
                                        }
                                        );";
            //        echo "</script>";

            //            echo "<html>";
            //            echo "<head>";
            //            echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
            //            echo "</head>";
            echo "<script>top.close_holdon();$actionTarget</script>";

            //            echo "</body>";
            //            echo "</html>";
        }
        else {
            die(lgShowAlert("No such transaction. You may want to refresh the browser to re-fetch actual content."));
        }


    }

    public function followupPreview()
    {
        $starttime = microtime(true);
        $no = rtrim($this->uri->segment(3), "-");
        //        $no = $this->uri->segment(3);
        $targetStepNum = $this->uri->segment(4);
        $currentStepNum = $this->uri->segment(5);
        $afterTargetStepNum = ($targetStepNum + 1);

        $rawPrevURL = blobEncode(current_url());
        $rawBuilderURL = $_GET['rawBuilderURL'];

        //
        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tr->addFilter("sub_step_number='" . $currentStepNum . "'");
        $tmpTr = $tr->lookupJoined()->result();


        //endregion


        //region SIGNATURE
        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            //            cekkuning("ada signs");
            $sCtr = 0;
            foreach ($tmpSign as $row) {

                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }
        else {
            //            cekkuning("TAK ada signs");
        }
        //endregion


        $rejectAllAllowed = true;
        $partialCanceled = false;
        $rawItems = array();
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;

            $pelaku = $tmpTr[0]->oleh_id;

            $cCode = "_TR_" . $this->jenisTr;


            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "items2" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            if (!isset($_SESSION[$cCode]['items2'])) {
                $_SESSION[$cCode]['items2'] = array();
            }
            //endregion
            $detailSizeKey = isset($_SESSION[$cCode]['main_elements']['detilSize']['key']) ? $_SESSION[$cCode]['main_elements']['detilSize']['key'] : array();
            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$targetStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$targetStepNum] : array();
            $itemLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$targetStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$targetStepNum] : array();
            $itemLabels3 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$targetStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$targetStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$targetStepNum] : array();
            $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$targetStepNum] : array();
            $itemNumLabels3 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$targetStepNum] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$targetStepNum] : null;
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $noteEditabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEditabled'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEditabled'][$targetStepNum] : false;
            $noteAdditionalEditabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteAdditionalEditabled'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteAdditionalEditabled'][$targetStepNum] : false;
            $noteFollowupEditabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainNote'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainNote'][$targetStepNum] : array();
            $noteType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteType'] : "text";
            $addRowsConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows'] : array();
            $imageEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled'] == true ? true : false;
            $imageType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageType'] : "text";
            $showPoStatus = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['showPoStatus']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['showPoStatus'] : array();

            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = ($currentStepNum + 1);

            //            $kolomPilihans = array(
            //                "indexing_registry"
            //            );
            //            $this->db->select($kolomPilihans);
            //            $tmpRg = $trs->lookupByID($masterID)->result();
            //            cekHitam($this->db->last_query());
            // arrPrint($masterID);
            $regIds = $tmpTr[0]->indexing_registry == NULL ? array() : blobDecode($tmpTr[0]->indexing_registry);

            //
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //            //cekMerah($this->db->last_query());
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //            arrPrint($detailValues);
            //endregion
            //            arrPrint($regIds);
            //            cekHitam($masterID. " TrID". $trID);
            //matiHEre("under debuging");
            //region take from registries
            //==ambil value-gate
            //            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            //            cekHere($regIds);
            //            matiHEre(sizeof($regIds)."****");
            $tr->setFilters(array());
            $tr->addFilter("trash='0'");
            if (sizeof($regIds) > 0) {
                $tmpReg = $tr->lookupBaseRegistries($regIds)->result();
            }
            else {
                $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            }
            // $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();
            //cekLime($this->db->last_query());


            $endtime = microtime(true); // Bottom of page
            $val = $endtime - $starttime;
            //            cekHere("  execute time[ ". $val." ]");
            //            matiHEre("under debuging");
            // cekKuning($this->db->last_query());
            $main = array();
            $items = array();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            $mainElements = array();
            $itemsKomposisi = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = unserialize(base64_decode($row->values));
                            break;

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        //                        case "main_applets"://
                        //                            $mainApplets = unserialize(base64_decode($row->values));
                        //                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "items_komposisi"://
                            $itemsKomposisi = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion


            // region transaksi data masterID
            $tr = new MdlTransaksi();
            $detailTmp = $tr->lookupDetailTransaksiNoJenis($masterID)->result();
            $totalOrdJmlMaster = 0;
            foreach ($detailTmp as $detailSpec) {
                $totalOrdJmlMaster += $detailSpec->produk_ord_jml;
            }
            // endregion transaksi data masterID


            $arrTest = array();
            $totalValidQty = 0;
            $totalOrdJml = 0;
            $itemsKompositID = array();
            $itemsKompositName = array();
            foreach ($tmpTr as $row) {
                $id = $row->produk_id;
                $itemsKompositID[$id] = $id;
                $itemsKompositName[$id] = $row->produk_nama;

                $tmp = array();
                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (isset($_SESSION[$cCode]['tableIn_detail_values'][$row->produk_id][$key])) {
                            $fieldValue = $_SESSION[$cCode]['tableIn_detail_values'][$row->produk_id][$key];
                        }
                        else {
                            if (isset($row->$key)) {
                                $fieldValue = $row->$key;
                            }
                            else {
                                $fieldValue = "";
                            }
                        }
                        $tmp[$key] = $fieldValue;
                    }
                }

                if (sizeof($showPoStatus) > 0) {
                    $ext_blob = isset($row->ext_blob) ? $row->ext_blob : array();
                    if (sizeof($ext_blob) > 0) {
                        //                        cekOrange(arrPrint(blobDecode($row->ext_blob)));
                    }
                }
                else {
                    //                    cekOrange("function: " . __FUNCTION__ . " LINE: " . __LINE__ . " " . $this->jenisTr);
                    //                    cekOrange("prd_id: " . $id);
                }

                //region calculate subtotal
                //                arrPrint($childGates[$id]);
                //===perhitungan subtotal
                $this->load->library("FieldCalculator");
                $cal = new FieldCalculator();


                if ($subAmountConfig != null) {

                    $arrChildGates[$id] = isset($childGates[$id]) ? $childGates[$id] : array();
                    $subtotal = makeValue($subAmountConfig, $arrChildGates[$id], $arrChildGates[$id], 0);
                }
                else {
                    $subtotal = 0;
                    //                    //cekHijau("subtotal NOL");
                }
                $tmp["subtotal"] = $subtotal;
                //endregion

                switch ($detailSizeKey) {
                    default:
                    case "ckd":

                        $replaceValue = array(
                            "volume_new" => isset($tmp['volume_gross']) ? $tmp['volume_gross'] : 0,
                            "sub_volume_new" => isset($tmp['sub_volume_gross']) ? $tmp['sub_volume_gross'] : 0,
                            "berat_new" => isset($tmp['berat_gross']) ? $tmp['berat_gross'] : "0",
                            "sub_berat_new" => isset($tmp['sub_berat_gross']) ? $tmp['sub_berat_gross'] : "0",
                        );
                        $tmp = array_replace($tmp, $replaceValue);

                        break;
                    case "cbu":
                        break;
                }

                $tmp = array();

                $rawItems[$row->produk_id] = $tmp;


                // region cek partial qty
                $totalValidQty += $row->valid_qty;
                $totalOrdJml += $row->produk_ord_jml;
                // endregion cek partial qty

            }

            if ($totalValidQty == $totalOrdJml) {
                $partialCanceled = true;
            }
            if ($totalOrdJmlMaster != $totalOrdJml) {
                $rejectAllAllowed = false;
            }
        }
        else {

            $errMsg = "the entry you are trying to access does not exist.<br>";
            $errMsg .= "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            $errMsg .= "if this error re-occurs, please contact system developer.<br>";


            echo "<script>top.BootstrapDialog.closeAll();</script>";
            die(lgShowAlert($errMsg));
        }
        //endregion


        $items = array();
        $items2 = array();

        $jenisTr = $this->jenisTr;
        $_SESSION[$cCode]['main']['currentID'] = $no;


        //region deteksi tombol2 followup
        $currentStepIndex = array_search($currentStepNum, $signNumbers, true);

        //region blocking edit/reject/delete/approve/fullfillment jika ada locker transaksi (HOLD by userID lain)
        $this->load->model("Mdls/MdlLockerTransaksi");
        $lt = New MdlLockerTransaksi();
        $lt->addFilter("transaksi_id='$trID'");
        $lt->addFilter("state='hold'");
        $lt->addFilter("jumlah='1'");
        //        $lt->addFilter("oleh_id='" . $this->session->login['id'] . "'");
        $ltTmp = $lt->lookupAll()->result();
        // showLast_query("pink");
        $allowedActionByHold = "";
        if (sizeof($ltTmp) > 0) {
            if ($ltTmp[0]->oleh_id == $this->session->login['id']) {
                $allowedAction = true;
                // cekUngu("transaksi HOLD by yang login, bisa dilanjutkan");
            }
            else {
                $allowedAction = false;
                $allowedActionByHold = $ltTmp[0]->oleh_nama;
                // cekUngu("transaksi HOLD by orang lain, TIDAK BISA dilanjutkan");
            }
        }
        else {
            $allowedAction = true;
            cekUngu("transaksi TIDAK di-HOLD, BISA dilanjutkan");
        }


        //endregion


        //region blocking edit/reject delete jika ada payment source dari pembelian non credit
        //        if (isset($_SESSION[$cCode]['lockerPayment']) && $_SESSION[$cCode]['lockerPayment'] == true) {
        //
        //        }


        //endregion


        //region ========================approve, reject, undo====================================
        $origTCode = heGetOriginTCode($this->jenisTr);
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $userGroup_editElementAllowed = $this->config->item("userGroup_editElementAllowed") != NULL ? $this->config->item("userGroup_editElementAllowed") : array();
        $thisStepGID = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup'] : "";
        $nextStepGID = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['userGroup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['userGroup'] : "";
        $hideFollowUp = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['hideFollowUp']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['hideFollowUp'] : false;

        $editElementAllowed = array_intersect($userGroup_editElementAllowed, $mems);

        $allowFollowup = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowFollowup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowFollowup'] : true;

        $preProcRevConfig = null != $this->config->item("hePreProcessors");
        $preCompRevConfig = null != $this->config->item("heComponents");

        $deleteSpec = array(
            "label" => "cannot delete",
            "targetUrl" => "",
            "warning" => "",
        );

        $undoSpec = array(
            "label" => "cannot undo",
            "targetUrl" => "",
            "warning" => "",
        );

        $rejectionSpec = array(
            "label" => "cannot reject 1 step",
            "targetUrl" => "",
            "warning" => "",
        );

        $rejectionSpecAll = array(
            "label" => "cannot reject all steps",
            "targetUrl" => "",
            "warning" => "",
        );

        $approvalSpec = array(
            "label" => "cannot approve",
            "targetUrl" => "",
            "warning" => "",
        );

        $editSpec = array(
            "label" => "cannot edit",
            "targetUrl" => "",
            "warning" => "",
        );

        $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
        $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
        $evCom = evaluateComponents($this->jenisTr, $currentStepNum);

        //
        cekmerah("evPre: $evPre, evPos: $evPost, evCom: $evCom, currentStep: $currentStepNum, targetStep: $targetStepNum");
        cekKuning("origTCode: $origTCode, currentStepNum: $currentStepNum");
        cekKuning(placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum, "reject"));

        //==delete, hanya pelaku yang membuat transaksi dan step 1
        if (($origTCode == null) && ($currentStepNum == 1) && ($pelaku == $this->session->login['id']) &&
            placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum, "delete")) {//$targetStepNum
            if (isset($_SESSION[$cCode]['lockerPayment']['allowedUndone']) && $_SESSION[$cCode]['lockerPayment']['allowedUndone'] == true) {
                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);
                        $deleteSpec = array(
                            "label" => "delete",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "Klik DELETE akan membuat transaksi dimatikan.",
                        );
                    }
                    else {
                    }
                }
                else {
                    //                    cekungu("bukan credit");
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    //                    cekUngu("delete pre:$evPre, post:$evPost, com:$evCom");
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT || LINE: " . __LINE__);
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);
                        $deleteSpec = array(
                            "label" => "delete",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "Klik DELETE akan membuat transaksi dimatikan.",
                        );
                    }
                    else {
                        //                        cekmerah("NOT allowed to REJECT || LINE: " . __LINE__);
                    }
                }
            }
            else {
                //                if (!isset($_SESSION[$cCode]['main']['paymentMethod'])) {
                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                if ($evPre == null && $evPost == null && $evCom == null) {
                    $masterRevertStep = ($currentStepNum - 1);
                    $childRevertStep = -($currentStepNum);
                    $deleteSpec = array(
                        "label" => "safely delete",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                        "warning" => "Klik DELETE akan membuat transaksi dimatikan.",
                    );
                }
                //                }
            }
        }
        else {
            //            cekmerah("NOT possible to delete, $pelaku != " . $this->session->login['id']);
        }

        //==undo, hanya yang mengotorisasi transaksi
        if (($origTCode == null) && ($currentStepNum > 1) && ($pelaku == $this->session->login['id']) &&
            placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum, "undo")) {

            if (isset($_SESSION[$cCode]['lockerPayment']['allowedUndone']) && $_SESSION[$cCode]['lockerPayment']['allowedUndone'] == true) {
                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    //                    cekHere("$evPre :: $evPost :: $evCom");
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT");
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);

                        $rejectionSpec = array(
                            "label" => "reject",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "Klik UNDO akan membuat transaksi mundur 1 langkah.",
                        );
                    }
                    else {
                        //                cekmerah("NOT allowed to REJECT");
                    }
                    //undonya
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                cekhijau("allowed to undo");
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);
                        $undoSpec = array(
                            "label" => "undo last step",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "Klik UNDO akan membuat transaksi mundur 1 langkah.",
                        );
                    }
                }
            }
            else {
                //                if (!isset($_SESSION[$cCode]['main']['paymentMethod'])) {

                //                cekLime("allowed to undo");
                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                //                cekmerah("evPre: $evPre, evPos: $evPost, evCom: $evCom");
                if ($evPre == null && $evPost == null && $evCom == null) {
                    //                cekhijau("allowed to undo");
                    $masterRevertStep = ($currentStepNum - 1);
                    $childRevertStep = -($currentStepNum);
                    $undoSpec = array(
                        "label" => "undo last step",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                        "warning" => "Klik UNDO akan membuat transaksi mundur 1 langkah.",
                    );
                }
                else {
                    //                cekmerah("NOT allowed to undo");
                }
                //                }
            }

        }
        else {
            //            cekmerah("NOT possible to undo");
        }

        //==reject, hanya yang memiliki hak akses selanjutnya
        if (($origTCode == null) && ($currentStepNum > 0) &&
            placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum, "reject")) {//$targetStepNum
            //            cekHijau("ready to reject");
            if (isset($_SESSION[$cCode]['lockerPayment']['allowedUndone']) && $_SESSION[$cCode]['lockerPayment']['allowedUndone'] == true) {
                //                cekKuning("kena if locker payment");
                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT || LINE: " . __LINE__);
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);

                        $rejectionSpec = array(
                            "label" => "reject 1 step",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "Klik REJECT akan membuat transaksi mundur 1 langkah.",
                        );

                        if ($rejectAllAllowed == true) {

                            $rejectionSpecAll = array(
                                "label" => "reject all steps",
                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevertAll/$no/$jenisTr/$currentStepNum",
                                "warning" => "Dengan klik REJECT ALL transaksi ini akan dimatikan dan tidak bisa digunakan lagi. Apakah akan melanjutkan?",
                            );
                        }
                    }

                }
                else {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    //                    cekUngu("pre:$evPre, post:$evPost, com:$evCom");
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT || LINE: " . __LINE__);
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);

                        $rejectionSpec = array(
                            "label" => "reject 1 step",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "Klik REJECT akan membuat transaksi mundur 1 langkah.",
                        );

                        if ($rejectAllAllowed == true) {

                            $rejectionSpecAll = array(
                                "label" => "reject all steps",
                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevertAll/$no/$jenisTr/$currentStepNum",
                                "warning" => "Dengan klik REJECT ALL transaksi ini akan dimatikan dan tidak bisa digunakan lagi. Apakah akan melanjutkan?",
                            );
                        }
                    }

                }
            }
            else {

                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                cekHitam("evPreProcc: $evPre, evPostProcc: $evPost, evCom: $evCom");
                if ($evPre == null && $evPost == null && $evCom == null) {
                    //                    cekhijau("allowed to REJECT || LINE: " . __LINE__);
                    $masterRevertStep = ($currentStepNum - 1);
                    $childRevertStep = -($currentStepNum);
                    $rejectionSpec = array(
                        "label" => "reject 1 step",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                        "warning" => "Klik REJECT akan membuat transaksi mundur 1 langkah.",
                    );
                    if ($rejectAllAllowed == true) {

                        $rejectionSpecAll = array(
                            "label" => "reject all steps",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevertAll/$no/$jenisTr/$currentStepNum",
                            "warning" => "Dengan klik REJECT ALL transaksi ini akan dimatikan dan tidak bisa digunakan lagi. Apakah akan melanjutkan?",
                        );
                    }
                }
                else {
                    cekmerah("NOT allowed to REJECT || LINE: " . __LINE__);
                }

            }
        }
        else {
            //            cekmerah("NOT possible to reject");
        }


        //edit, hanya pelaku yang membuat transaksi dan step 1
        if (($origTCode == null) && ($currentStepNum > 0) && ($pelaku == $this->session->login['id']) &&
            placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum, "edit")) {
            $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
            $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
            $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
            $evMaster = evaluateMain($this->jenisTr, $currentStepNum);
            cekHere("$evPre :: $evPost :: $evCom :: -- $evMaster");
            if ($evPre == null && $evPost == null && $evCom == null && $evMaster == null) {
                //                cekhijau("allowed to EDIT");
                $editSpec = array(
                    "label" => "edit",
                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doPreEdit/$no/$jenisTr/$currentStepNum",
                    "warning" => "pressing EDIT will modify entire transaction data. continue?",
                );
            }
            else {
                //                cekmerah("NOT allowed to EDIT");
            }
        }
        else {
            if ($pelaku == $this->session->login['id']) {
                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                $evMaster = evaluateMain($this->jenisTr, $currentStepNum);
                cekHitam("$evPre :: $evPost :: $evCom :: $evMaster :: $currentStepNum");
                if ($evPre == null && $evPost == null && $evCom == null && $evMaster == null) {
                    //                    cekhijau("allowed to EDIT");
                    $editSpec = array(
                        "label" => "edit",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doPreEdit/$no/$jenisTr/$currentStepNum",
                        "warning" => "pressing EDIT will modify entire transaction data. continue?",
                    );
                }
                else {
                    //                    cekmerah("NOT allowed to EDIT");
                }
            }
        }


        //==approve
        if ($targetStepNum > $currentStepNum) {
            if ($allowFollowup == true) {
                if (isset($_SESSION[$cCode]['lockerPayment']['allowedFollow']) && $_SESSION[$cCode]['lockerPayment']['allowedFollow'] == true) {
                    if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                        if (isset($this->accessList[$this->jenisTr])) {
                            if (isset($this->accessList[$this->jenisTr][$targetStepNum])) {

                                $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                                if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                                    $trs = new MdlTransaksi();
                                    $trs->setFilters(array());
                                    $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                                    if (sizeof($tmpPymSrc)) {
                                        if ($tmpPymSrc[0]->sisa > 0) {
                                            $approvalSpec = array(
                                                "label" => "continue to next step",
                                                "targetUrl" => "",
                                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                                            );
                                            if ($hideFollowUp) {
                                                $approvalSpec = array();
                                            }
                                            $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                                "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                                "label" => $paymentSrcCek['label'],
                                            );
                                        }
                                        else {
                                            $approvalSpec = array(
                                                //                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                                            );
                                            if ($hideFollowUp) {
                                                $approvalSpec = array();
                                            }
                                        }
                                    }
                                    else {
                                        $approvalSpec = array(
                                            //                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        if ($hideFollowUp) {
                                            $approvalSpec = array();
                                        }
                                    }
                                }
                                else {
                                    $approvalSpec = array(
                                        //                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                    if ($hideFollowUp) {
                                        $approvalSpec = array();
                                    }
                                }
                            }
                        }
                        else {
                            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                                //                cekBiru(":: $currentStepNum :: $targetStepNum ::");
                                $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                                $msgWarning2 = array();
                                if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                                    $trs = new MdlTransaksi();
                                    $trs->setFilters(array());
                                    $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                                    if (sizeof($tmpPymSrc)) {
                                        if ($tmpPymSrc[0]->sisa > 0) {
                                            $approvalSpec = array(
                                                "label" => "continue to next step",
                                                "targetUrl" => "",
                                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                                            );
                                            if ($hideFollowUp) {
                                                $approvalSpec = array();
                                            }
                                            $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                                "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                                "label" => $paymentSrcCek['label'],
                                            );
                                        }
                                        else {
                                            $approvalSpec = array(
                                                //                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                                            );
                                            if ($hideFollowUp) {
                                                $approvalSpec = array();
                                            }
                                        }
                                    }
                                    else {
                                        $approvalSpec = array(
                                            //                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        if ($hideFollowUp) {
                                            $approvalSpec = array();
                                        }
                                    }
                                }
                                else {
                                    $approvalSpec = array(
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                    if ($hideFollowUp) {
                                        $approvalSpec = array();
                                    }
                                }
                            }
                            else {
                            }
                        }
                    }
                    else {
                        //                    $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                        //                        "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                        //                        "label" => isset($_SESSION[$cCode]['lockerPayment']['label']) ? $_SESSION[$cCode]['lockerPayment']['label'] . " belum dilakukan. Segera hubungi pihak Finance." : "Segera hubungi pihak Finance untuk follow up",
                        //                    );
                        //                    cekUngu("approve : " . placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum));
                        if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                            $approvalSpec = array(
                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                            );
                        }
                        else {
                            cekUngu("tidak ada approve");
                        }
                    }
                }
                else {

                    if (isset($this->accessList[$this->jenisTr])) {

                        if (isset($this->accessList[$this->jenisTr][$targetStepNum])) {

                            //                    $approvalSpec = array(
                            //                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                            //                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                            //                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                            //                    );
                            $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                            if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                                $trs = new MdlTransaksi();
                                $trs->setFilters(array());
                                $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                                if (sizeof($tmpPymSrc)) {
                                    if ($tmpPymSrc[0]->sisa > 0) {
                                        $approvalSpec = array(
                                            "label" => "continue to next step",
                                            "targetUrl" => "",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                            "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                            "label" => $paymentSrcCek['label'],
                                        );
                                        if ($hideFollowUp) {
                                            $approvalSpec = array();
                                        }
                                    }
                                    else {
                                        $approvalSpec = array(
                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        if ($hideFollowUp) {
                                            $approvalSpec = array();
                                        }
                                    }
                                }
                                else {
                                    $approvalSpec = array(
                                        //                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                    if ($hideFollowUp) {
                                        $approvalSpec = array();
                                    }
                                }
                            }
                            else {

                                $approvalSpec = array(
                                    //                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                    "warning" => "pressing green button will set this entry one step ahead. continue?",
                                );

                                if ($hideFollowUp) {
                                    $approvalSpec = array();
                                }
                            }
                        }
                    }
                    else {

                        if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                            //                cekBiru(":: $currentStepNum :: $targetStepNum ::");
                            $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                            $msgWarning2 = array();
                            if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                                $trs = new MdlTransaksi();
                                $trs->setFilters(array());
                                $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                                if (sizeof($tmpPymSrc)) {
                                    if ($tmpPymSrc[0]->sisa > 0) {
                                        $approvalSpec = array(
                                            "label" => "continue to next step",
                                            "targetUrl" => "",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                            "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                            "label" => $paymentSrcCek['label'],
                                        );
                                        if ($hideFollowUp) {
                                            $approvalSpec = array();
                                        }
                                    }
                                    else {
                                        $approvalSpec = array(
                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        if ($hideFollowUp) {
                                            $approvalSpec = array();
                                        }
                                    }
                                }
                                else {
                                    $approvalSpec = array(
                                        //                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                    if ($hideFollowUp) {
                                        $approvalSpec = array();
                                    }
                                }
                            }
                            else {

                                $approvalSpec = array(
                                    //                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'],
                                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
                                    "warning" => "pressing green button will set this entry one step ahead. continue?",
                                );
                                if ($hideFollowUp) {
                                    $approvalSpec = array();
                                }
                            }
                        }
                        else {

                        }
                    }
                }
            }
            if ((isset($lockerPreDownpayment)) && ($lockerPreDownpayment == true)) {
                $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                $msgWarning2 = array();
                $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                    "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                    "label" => $paymentSrcCek['label'],
                );
                $approvalSpec = array(
                    "label" => "cannot approve",
                    "targetUrl" => "",
                    "warning" => "",
                );
            }
            if (isset($lockShipment) && ($lockShipment == true)) {
                $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                    "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                    "label" => $lockShipmentLabel,
                );
                $approvalSpec = array(
                    "label" => "cannot approve",
                    "targetUrl" => "",
                    "warning" => "",
                );
            }
        }
        else {
            //            cekmerah("NOT possible to approve");
        }
        //endregion


        if (sizeof($signNumbers) > 0) {
            if ($currentStepIndex > 0) {
                $beforeCurrentIndex = ($currentStepIndex - 1);
                $beforeCurrentStep = $signNumbers[$beforeCurrentIndex];
            }
            else {

                $beforeCurrentStep = 0;
            }

            $masterRevertStep = $beforeCurrentStep;

            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
                //                if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
                $mComponents = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master'] : array();

                if (sizeof($mComponents) > 0) {
                    $comNames = array();
                    foreach ($mComponents as $cSpec) {
                        $comNames[] = $cSpec['comName'];
                    }
                    if (in_array("Jurnal", $comNames)) {
                        //==tidak bisa di-revert
                    }
                    else {
                        $allowRevert = true;
                        //                        $revertLabel = $masterRevertStep . "undo " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                        $revertLabel = "undo";
                        $childRevertStep = -($currentStepNum);
                        $revertTarget = base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";

                    }
                }
                else {
                    $allowRevert = true;
                    //                    $revertLabel = $masterRevertStep . "undo " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                    $revertLabel = "undo";
                    $childRevertStep = -($currentStepNum);
                    $revertTarget = base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";
                }

            }
            //            }
        }
        //endregion


        //region check if i may approve or unapprove current transaction

        if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum])) {
            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                //            if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['userGroup'], $this->session->login['membership'])) {
                $allowFollowup = true;
                $buttonLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'];
                $acceptTarget = base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum";

                //                echo $masterRevertStep;
                if (isset($masterRevertStep)) {


                    $mPreProcs = heCountPreProcs($this->jenisTr, $currentStepNum);
                    $mPostProcs = heCountPostProcs($this->jenisTr, $currentStepNum);
                    $mComs = heCountComponents($this->jenisTr, $currentStepNum);

                    //                    arrprint($mPreProcs);
                    //                    arrprint($mPostProcs);

                    //==set default to ENABLED
                    $childRevertStep = -($currentStepNum);
                    $rejectionLabel = "reject (def)";
                    $rejectionTarget = base_url() . $this->uri->segment(1) . "/dontFollowup/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";


                    if (sizeof($mPreProcs['reversable']) > 0 || sizeof($mPostProcs['reversable']) > 0) {//maka cek dulu, boleh  cancel apa kagak
                        //==set default to DISABLED
                        $rejectionLabel = "can not reject";
                        $rejectionTarget = "";

                    }
                    else {//==langsung bisa dicancel
                        if (heJournalExists($this->jenisTr, $currentStepNum)) {
                            $rejectionLabel = "can not reject";
                            $rejectionTarget = "";
                        }
                        else {
                            //boleh
                        }

                    }


                }

            }
        }
        //endregion

        //endregion

        //region prevalidator
        $items = $rawItems;


        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preValidator'][$targetStepNum])) {
            $procList = $this->config->item('heTransaksi_core')[$this->jenisTr]['preValidator'][$targetStepNum];

            if (sizeof($procList) > 0) {
                foreach ($procList as $procName) {
                    $mdlProcName = "PreValidator" . $procName;
                    $this->load->model($mdlProcName);
                    if (isset($childGates) && sizeof($childGates) > 0) {
                        $prc = new $mdlProcName();
                        $requiredParams = $prc->getRequiredParams();
                        if (sizeof($requiredParams) > 0) {
                            $sentParams = array();
                            foreach ($childGates as $odSpec) {
                                $tmp = array();
                                foreach ($requiredParams as $key) {
                                    $tmp[$key] = $odSpec[$key];
                                }

                                $sentParams[] = $tmp;
                            }

                            $prc->pair($masterID, $sentParams);
                            $gotParams = $prc->exec();
                            if (isset($gotParams['items2']) && sizeof($gotParams['items2']) > 0) {
                                $items2 = $gotParams['items2'];
                                foreach ($gotParams['items2'] as $id => $iSpec) {
                                    //										$id=$iSpec['id'];
                                    if (isset($_SESSION[$cCode]['items'][$id])) {

                                        $items2[$id]['produk_ord_jml'] = $iSpec['produk_ord_jml'];
                                        $items2[$id]['produk_nama'] = $rawItems[$id]['produk_nama'];
                                        $items2[$id]['satuan'] = $rawItems[$id]['satuan'];


                                        $items[$id]['produk_ord_jml'] -= $iSpec['produk_ord_jml'];
                                        $_SESSION[$cCode]['items'][$id]['jml'] -= $iSpec['produk_ord_jml'];
                                        if ($items[$id]['produk_ord_jml'] < 1) {
                                            unset($items[$id]);
                                        }
                                        if ($_SESSION[$cCode]['items'][$id]['jml'] < 1) {
                                            unset($_SESSION[$cCode]['items'][$id]);
                                        }
                                    }
                                }
                            }

                        }
                        else {
                            die("preval $procName does not have requiredParams!");
                        }

                    }
                    else {
                        die("out_detail contains nothing!. skipping preprocessor");
                    }
                }
            }


            //<editor-fold desc="re-build values">


            //</editor-fold>

        }
        else {
            //                echo("no preval defined. skipping preval..<br>");
        }

        //endregion


        //
        //region preview bottom elements

        $saveWarning = "";
        $buttonLabel = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$targetStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$targetStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$targetStepNum]['actionLabel'];
        //        cekBiru($buttonLabel . " LINE: " . __LINE__);
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$afterTargetStepNum])) {
            $saveWarning .= "clicking <strong>$buttonLabel</strong> button will make transaction state to: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['stateLabel'] . "</strong>";
            $saveWarning .= "<br>It would need to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$afterTargetStepNum]['userGroup'] . "</strong>";
        }
        else {
            $saveWarning .= "clicking <strong>$buttonLabel</strong> button will instantly make transaction state to <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['stateLabel'] . "</strong>";
        }

        //endregion

        //region warn if irreverseble
        $mComponents = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$targetStepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$targetStepNum]['master'] : array();
        if (sizeof($mComponents) > 0) {
            $comNames = array();
            $reks = array();
            foreach ($mComponents as $cSpec) {
                $comNames[] = $cSpec['comName'];
                if ($cSpec['comName'] == "Jurnal") {
                    if (isset($cSpec['loop']) && sizeof($cSpec['loop']) > 0) {
                        foreach ($cSpec['loop'] as $rek => $v) {
                            if (substr($rek, 0, 1) == "{") {
                                $rek = trim($rek, "{");
                                $rek = trim($rek, "}");
                                if (isset($_SESSION[$cCode]['main'][$rek])) {
                                    $rek = str_replace($rek, $_SESSION[$cCode]['main'][$rek], $rek);
                                }
                                else {
                                    $rek = NULL;
                                }
                            }
                            else {
                                //                        cekkuning("TIDAK mengandung kurawal");
                            }
                            $reks[$rek] = $rek;
                        }
                    }
                }
            }
            if (in_array("Jurnal", $comNames)) {
                //==tidak bisa di-revert
                $saveWarning .= "<br><span class='text-danger'>starting from this point, you can not undo the change made on this entry.</span>";
                if (sizeof($reks) > 0) {
                    $saveWarning .= "<br><h6><span class='text-blue'>these accounts will be affected at journal: <strong>" . implode(", ", $reks) . ".</strong></span></h6>";
                }
            }
        }
        //endregion


        $msgWarning = $this->validate2();

        //
        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        $mainPropReplacers = array(//===replace khusus kebutuhan preview next step
            "jenis_label" => $tmpTr[0]->next_step_label,
            //            "nomer" => "(to be generated)",
            "result_nomer" => "(to be generated)",
            "dtime" => date("Y-m-d H:i:s"),
        );
        foreach ($mainPropReplacers as $key => $val) {
            $mainProp->$key = $val;
        }
        //endregion

        //
        //region prepare params for viewer

        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $targetStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }


        $editableElements = array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $xShipmentConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['xShipmentConfig']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['xShipmentConfig'] : array();
        $itemsChildLabel = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$targetStepNum]['fields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$targetStepNum]['fields'] : array();
        $itemsChildEditable = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$targetStepNum]['editable']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$targetStepNum]['editable'] : array();
        $itemsChildGate = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$targetStepNum]['gate']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$targetStepNum]['gate'] : "none";
        $addRowsConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows'] : array();

        $kompositValidateConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['kompositValidate']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['kompositValidate'] : array();

        if (sizeof($_SESSION[$cCode]['main_elements']) > 0) {

            if (sizeof($elementConfigs) > 0) {
                foreach ($elementConfigs as $aKey => $aSpec) {
                    //                    cekHijau("receipt element $aKey");
                    if (array_key_exists($aKey, $mainElements) && in_array($targetStepNum, $aSpec['editPoints'])) {
                        $editableElements[] = $aKey;
                    }
                    if (isset($relElementConfigs[$aKey])) {

                        foreach ($relElementConfigs[$aKey] as $mainRel => $relData) {
                            //                            cekUngu("relative element $mainRel ---- $aKey");
                            foreach ($relData as $relKey => $relDetails) {
                                //                                if (in_array("o_seller_spv", $mems)) {
                                if (sizeof($editElementAllowed) > 0) {
                                    if (array_key_exists($relKey, $mainElements) && in_array($targetStepNum, $relDetails['editPoints'])) {
                                        $editableElements[] = $relKey;

                                        if (array_key_exists($relKey, $relElementConfigs)) {
                                            //                                        cekBiru("rel element $relKey mentrigger kelompoknya sendiri");
                                            foreach ($relElementConfigs[$relKey] as $ownRel => $ownData) {
                                                foreach ($ownData as $ownKey => $ownDetails) {
                                                    if (array_key_exists($ownKey, $mainElements) && in_array($targetStepNum, $ownDetails['editPoints'])) {
                                                        $editableElements[] = $ownKey;
                                                    }
                                                }
                                            }
                                        }

                                    }
                                }
                                //                                }
                            }
                        }
                    }
                }
            }

        }


        //region downpayment
        $dpValueDetails = array();
        $dpFieldName = array();
        $dpData = array();
        if (isset($masterTableInValueParams['dp_value']) && $masterTableInValueParams['dp_value'] > 0) {
            //        if (isset($masterTableInValueParams['dp_dipakai_ui']) && $masterTableInValueParams['dp_dipakai_ui'] > 0) {

            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi.cabang_id='" . $tmpTr[0]->cabang_id . "'");
            $tr->addFilter("transaksi.jenis='700'");
            $tr->addFilter("transaksi_data.produk_id='" . $tmpTr[0]->id_master . "'");
            $tmpTrs = $tr->lookupJoined()->result();
            //arrprint($tmpTrs);


            $dpValueDetails = array(
                "dpp_dp" => $masterTableInValueParams['dp_value'],
                "ppn_dp" => $masterTableInValueParams['dp_ppn_value'],
                "dp" => $masterTableInValueParams['dp'],
                //                "due_amount" => $masterTableInValueParams['tagihan'],
                "penerima" => sizeof($tmpTrs) ? $tmpTrs[0]->oleh_nama : "-",
            );
            $dpFieldName = array(
                "dpp_dp" => "DPP Dp",
                "ppn_dp" => "VAT Dp",
                "dp" => "Downpayment",
                //                "due_amount" => "Due amount",
                "penerima" => "Penerima",
            );
            $dpData = array(
                "value" => $dpValueDetails,
                "field" => $dpFieldName,
            );
        }
        else {
            //            cekHitam("-TIDAK ADA DP-");
        }


        //endregion


        //region elements editor

        $elStr = array();
        $elements = array();
        $aFilter = array();

        if (sizeof($elementConfigs) > 0) {
            foreach ($elementConfigs as $eName => $eSpec) {
                switch ($eSpec['elementType']) {
                    case "dataModel":
                        $addStr = "";
                        $editStr = "";
                        $amdlName = $eSpec['mdlName'];
                        $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();

                        $elStr[$eName] = "";
                        $this->load->model("Mdls/" . $amdlName);
                        $labelSrc = $eSpec['labelSrc'];
                        $keySrc = $eSpec['key'];
                        $oo = new $amdlName();
                        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $amdlName);
                        if (sizeof($aFilter) > 0) {
                            foreach ($aFilter as $filter) {
                                $exFilter = explode("=", $filter);
                                if (sizeof($exFilter) > 1) {
                                    if (isset($_SESSION[$cCode]['main'][$exFilter[1]])) {
                                        $oo->addFilter($exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'");
                                        $addLink .= "?reqField=" . $exFilter[0] . "&reqVal=" . $_SESSION[$cCode]['main'][$exFilter[1]];
                                    }
                                }
                            }
                        }
                        $addClick = "";
                        $dataAccess = isset($this->config->item('heDataBehaviour')[$amdlName]) ? $this->config->item('heDataBehaviour')[$amdlName] : array(
                            "viewers" => array(),
                            "creators" => array(),
                            "creatorAdmins" => array(),
                            "updaters" => array(),
                            "updaterAdmins" => array(),
                            "deleters" => array(),
                            "deleterAdmins" => array(),
                            "historyViewers" => array(),
                        );
                        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
                        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
                            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        }
                                        );";
                                $addStr = "<a href='javascript:void(0)' class='btn btn-default' onclick=\"$addClick\"><span class='glyphicon glyphicon-plus'></span></a>";
                            }
                        }

                        $tmpo = $oo->lookupAll()->result();
                        $elPair[$amdlName] = array();
                        $selectorTarget = base_url() . get_class($this) . "/fetchElement/" . $this->jenisTr . "/$eName/$amdlName/?key='+this.value";

                        $elStr[$eName] .= "<div class='box-body'>";
                        $elStr[$eName] .= "<select class='form-control' onchange=\"top.$('#result').load('$selectorTarget');\">";
                        $elStr[$eName] .= "<option value=''>-select-</option>";
                        if (sizeof($tmpo) > 0) {
                            foreach ($tmpo as $row) {

                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $row->$labelSrc . "</option>";

                            }
                        }
                        $elStr[$eName] .= "</select>";
                        $elStr[$eName] .= "</div class='box-header'>";

                        $defKey = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : 0;
                        $defValue = "";
                        if (isset($_SESSION[$cCode]['main_elements'][$eName]['key']) && $_SESSION[$cCode]['main_elements'][$eName]['contents']) {
                            if (isset($elementConfigs[$eName]['usedFields']) && sizeof($elementConfigs[$eName]['usedFields']) > 0) {
                                $defValue .= "<table class='table table-condensed no-padding' style='padding:0px;margin:0px;'>";
                                $contents[$eName] = unserialize(base64_decode($_SESSION[$cCode]['main_elements'][$eName]['contents']));
                                foreach ($elementConfigs[$eName]['usedFields'] as $src => $label) {
                                    $fieldLabel = isset($contents[$eName][$src]) ? $contents[$eName][$src] : "-";
                                    $defValue .= "<tr>";
                                    $defValue .= "<td align='left'>$label";
                                    $defValue .= "</td>";
                                    $defValue .= "<td align='left'>" . $fieldLabel;
                                    $defValue .= "</td>";
                                    $defValue .= "</tr>";
                                }
                                $defValue .= "</table>";
                            }
                        }


                        if ($defKey > 0) {
                            if (sizeof($mems) > 0 && sizeof($dataAccess['updaters']) > 0) {
                                $editLink = base_url() . "Data/edit/" . str_replace("Mdl", "", $amdlName) . "/$defKey";
                                if (sizeof(array_intersect($mems, $dataAccess['updaters'])) > 0) {
                                    $editClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $editLink . "'),
                                        draggable:true,
                                        size:BootstrapDialog.SIZE_WIDE,
                                        closable:true,
                                        }
                                        );";

                                    $editStr = "<a href='javascript:void(0)' class='btn btn-default' onclick=\"$editClick\"><span class='glyphicon glyphicon-pencil'></span></a>";
                                }
                            }
                        }

                        $elStr[$eName] .= "<div id='divel_$eName' style='padding:2px;font-size:smaller;'>$defValue";
                        $elStr[$eName] .= "</div id='el$amdlName'>";
                        $elStr[$eName] .= "<div class='box-footer'>";

                        $elStr[$eName] .= "<span class='pull-right'>$editStr $addStr</span>";
                        $elStr[$eName] .= "</div class='box-footer'>";

                        $elements[$eName] = array(
                            "mdlName" => $eSpec['mdlName'],
                            "label" => $eSpec['label'],
                            "string" => $elStr[$eName],
                        );


                        break;
                    case "dataField":
                        $elStr[$eName] = "";
                        $defaultValue = isset($eSpec['defaultValue']) ? $eSpec['defaultValue'] : "";
                        $selectorTarget = "'" . base_url() . get_class($this) . "/recordFieldElement/" . $this->jenisTr . "/$eName/$amdlName/?val='+this.value";
                        //                        $elStr[$eName] .="<div class='box'>";

                        $elStr[$eName] .= "<div class='box-body'>";
                        switch ($eSpec['inputType']) {
                            case "text":
                                $elStr[$eName] .= "<input type=text class='form-control' value='$defaultValue' onblur=\"top.$('#result').load($selectorTarget);\">";
                                break;
                            case "date":
                                $elStr[$eName] .= "<input type=date class='form-control' value='$defaultValue' onblur=\"top.$('#result').load($selectorTarget);\">";
                                break;
                        }
                        $elStr[$eName] .= "</div class='box-body'>";

                        $elements[] = array(
                            "mdlName" => null,
                            "label" => $eSpec['label'],
                            "string" => $elStr[$eName],
                        );
                        break;
                }
            }
        }

        //endregion


        $xShipmentBtn = array();
        if ($xShipmentConfig) {
            $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
            //            arrPrint($mems);
            foreach ($xShipmentConfig as $num => $val) {
                if ($num == $currentStepNum) {

                    $allowed = false;
                    foreach ($val['allowedGroups'] as $group) {
                        if (in_array($group, $mems)) {
                            $allowed = true;
                            break;
                        }
                    }
                    //                    cekHere("=== allowed::  " . $allowed);
                    if (($val['enabled'] == true) && ($allowed == true)) {

                        $labelx = $val['label'];
                        $targetJenisMaster = $val['targetJenisMaster'];
                        $warningx = $val['warning'];
                        $xShipmentBtn_str = array(
                            "label" => $labelx,
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/preCancelPacking/$no/$jenisTr/$targetJenisMaster/$currentStepNum",
                            "warning" => $warningx,
                        );
                        $xShipmentBtn = $xShipmentBtn_str;
                    }
                }
            }
        }

        $stepLabels = array();
        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $num => $sSpec) {
            $stepLabels[$num] = $sSpec['label'];
        }

        $tmpTableIn_master = isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array();
        $tmpTableIn_masterValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        $main = array_merge(array_filter($main), array_filter($tmpTableIn_master), array_filter($tmpTableIn_masterValues));
        $mainAddValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
            $mainAddValues = array_merge(array_filter($mainAddValues), array_filter($_SESSION[$cCode]['main_add_values']));
        }


        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            //            cekbiru("hendak memeriksa relative impacts");
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                //                cekbiru("memeriksa $eName:");
                if (array_key_exists($eName, $relElementConfigs)) {
                    //                    cekhijau("$eName memiliki relative impacts");
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //                        cekhijau("memenuhi syarat");
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            //                            cekmerah("memeriksa $eName, $currentValue");
                            //                            $rcCtr = 0;
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                //                                $elKey = $eName . "_" . $currentValue . "_" . $rcID;
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                                //                                $rcCtr++;
                            }
                        }
                    }
                    else {
                        //                        cekmerah("TIDAK memenuhi syarat");
                    }
                }
            }
        }


        //==ini dua benda ini dibikin ulang di sini karena nantinya harus selalu refresh tanpa memanggil PrePreview lagi
        $trA = new MdlTransaksi();
        $extSteps = $trA->lookupExtSteps($masterID);
        $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");


        $_SESSION[$cCode]['extSteps'] = $extSteps;
        $_SESSION[$cCode]['paySrcs'] = $paySrcs;

        //create followup buttons for relative inputs
        //region buttons for relative inputs
        $extBtns = array();
        $extNewBtns = array();
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        if (isset($_SESSION[$cCode]['extSteps']) && sizeof($_SESSION[$cCode]['extSteps']) > 0) {
            foreach ($_SESSION[$cCode]['extSteps'] as $xSpec) {
                if (in_array($xSpec['groupID'], $mems)) {
                    $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'review " . $xSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/previewValue/" . $this->jenisTr . "/$masterID/" . $xSpec['id'] . "/" . $this->uri->segment(5) . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                    $extBtns[$xSpec['key']] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> review " . $xSpec['label'] . "</a>";
                }
                else {
                    $extBtns[$xSpec['key']] = "<a class='btn btn-default text-muted'><i>unreviewable " . $xSpec['label'] . "</i></a>";
                }
            }
        }
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                if (array_key_exists($eName, $relOptionConfigs)) {
                    //                    cekhijau("$eName terdaftar pada relInputs");
                    if (isset($relOptionConfigs[$eName][$currentValue]) && sizeof($relOptionConfigs[$eName][$currentValue]) > 0) {
                        foreach ($relOptionConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                            if (isset($oValSpec['addPoints']) && in_array($targetStepNum, $oValSpec['addPoints'])) {
                                if (in_array($oValSpec['auth']['groupID'], $mems)) {
                                    $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'add " . $oValSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/addValue/" . $this->jenisTr . "/$masterID/" . "0" . "/" . $this->uri->segment(5) . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                                    $extNewBtns[$oValueName] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> add " . $oValSpec['label'] . "</a>";
                                }
                                else {
                                    //                                    cekmerah("you are not allowed");
                                }
                            }
                            else {
                                //                                cekhijau("$oValueName TIDAK memenuhi syarat");
                            }
                        }
                    }
                }
            }
        }
        //endregion

        //create followup buttons for paymentSrc-related
        //region buttons for paymentSrc-related
        $payBtns = array();
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        if (isset($_SESSION[$cCode]['paySrcs']) && sizeof($_SESSION[$cCode]['paySrcs']) > 0) {
            foreach ($_SESSION[$cCode]['paySrcs'] as $xSpec) {
                if ($xSpec['sisa'] > 0) {

                    //                arrprint($xSpec);
                    $xSpec['groupID'] = $this->config->item("heTransaksi_ui")[$xSpec['targetJenis']]['steps'][1]['userGroup'];
                    if (in_array($xSpec['groupID'], $mems)) {
                        $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'do " . $xSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/selectPaymentSrc/" . $xSpec['targetJenis'] . "/" . $xSpec['extID'] . "/$masterID?rawPrev=$rawPrevURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                        //                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> do " . $xSpec['label'] . "</a>";
                    }
                    else {
                        //                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-default text-muted'><i>" . $xSpec['label'] . "</i></a>";
                    }
                }
            }
        }
        //endregion

        //region additional row
        //        cekHitam($cCode . " $targetStepNum " . $currentStepNum);
        $selectedService = isset($_SESSION[$cCode]['main']['shippingService']) ? $_SESSION[$cCode]['main']['shippingService'] : "";

        //        arrPrint($selectedService);
        $allowEditRowa = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["additionalRows"]["shippingService"][$selectedService]["shipping_service"]['editPoints']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["additionalRows"]["shippingService"][$selectedService]["shipping_service"]['editPoints'] : array();
        $addRows = array();
        $addRowLabels = array();
        if (in_array($targetStepNum, $allowEditRowa)) {
            if (sizeof($elementConfigs) > 0) {
                foreach ($elementConfigs as $eName => $eSpec) {
                    //reset dulu kalau yg tidak ada
                    if (array_key_exists($eName, $relElementConfigs)) {
                        //                    cekkuning("$eName ada dalam elementConfig, reset dulu adik2nya<br>");
                        switch ($eSpec['elementType']) {
                            case "dataModel":
                                $currentValue = $eSpec['key'];
                                break;
                            case "dataField":
                                $currentValue = $eSpec['value'];
                                break;
                        }
                        if (sizeof($relElementConfigs[$eName]) > 0) {
                            foreach ($relElementConfigs[$eName] as $valID => $valSpec) {

                                //                            cekkuning("chek if i should reset $valID..");

                                if ($currentValue == $valID) {
                                    //                                cekkuning("i wont reset $valID..");
                                }
                                else {


                                }
                            }

                        }
                        //					$currentValue = "";

                        if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                            //                        echo("-- $currentValue ada dalam elementConfig $eName<br>");
                            //===daftarkan ke elementConfig
                            if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                                //                            echo("---- memeriksa $eName, $currentValue<br>");
                                //                            $rcCtr=0;
                                foreach ($relElementConfigs[$eName][$currentValue] as $rKey => $rcSpec) {
                                    //                                $elKey = $eName . "_" . $currentValue . "_" . $rKey;
                                    $elKey = $rKey;
                                    $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rKey];
                                    //                                echo "elKey: $elKey";
                                    //                                $rcCtr++;


                                }
                            }
                            else {
                                //                            echo("---- TIDAK PERLU memeriksa $eName, $currentValue<br>");
                            }

                        }
                        else {
                            //                        echo("-- $currentValue TIDAK ada dalam elementConfig $eName<br>");
                        }
                    }
                    else {
                        //                    echo("$eName TIDAK ada dalam elementConfig<br>");
                    }

                    if (array_key_exists($eName, $addRowsConfigs)) {
                        switch ($elementConfigs[$eName]['elementType']) {
                            case "dataModel":
                                $currentValue = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : "";
                                break;
                            case "dataField":
                                $currentValue = $_SESSION[$cCode]['main_elements'][$eName]['value'];
                                break;
                        }
                        //                    cekhijau("currentValue: $currentValue");
                        if (isset($addRowsConfigs[$eName][$currentValue])) {
                            //                        cekmerah("aturan untuk $currentValue ada");
                            if (sizeof($addRowsConfigs[$eName][$currentValue]) > 0) {

                                foreach ($addRowsConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                    //                                cekhijau($oValueName);
                                    //                                arrprint($oValSpec);
                                    if (isset($oValSpec['editPoints']) && in_array($targetStepNum, $oValSpec['editPoints'])) {

                                        //                                        $relInputTarget = "'" . base_url() . get_class($this) . "/recordAddRow/" . $this->jenisTr . "/$oValueName/?val='+this.value+'&ravPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'";
                                        $relInputTarget = "'" . base_url() . "_shoppingCart/recordAddRow/" . $this->jenisTr . "/$oValueName/?val='+this.value+'&ravPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'";


                                        //==init value and params
                                        //region default value
                                        if (isset($oValSpec['defaultValue'])) {
                                            $origDefValue = makeValue($oValSpec['defaultValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                        }
                                        //endregion

                                        //                                    cekmerah("$oValueName = ".$origDefValue);


                                        //region max-value
                                        $maxValue = $origDefValue;
                                        if (isset($oValSpec['maxValue'])) {
                                            $maxValue = makeValue($oValSpec['maxValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);

                                        }
                                        else {
                                            $maxValue = "";
                                        }

                                        //endregion


                                        //region min-value
                                        $minValue = $origDefValue;
                                        if (isset($oValSpec['minValue'])) {
                                            $minValue = makeValue($oValSpec['minValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                        }
                                        else {
                                            $minValue = "";
                                        }
                                        //endregion

                                        $minValStr = $minValue != "" ? "min='$minValue'" : "";
                                        $maxValStr = $maxValue != "" ? "max='$maxValue'" : "";

                                        //region inisiasi keystroke
                                        $keyupAct = "";
                                        if (isset($oValSpec['keyupAction']) && strlen($oValSpec['keyupAction']) > 0) {
                                            $keyupAct = $oValSpec['keyupAction'];
                                        }

                                        $keyupStr = "";
                                        if ($maxValue != "") {
                                            $keyupStr .= "if(parseInt(this.value)>$maxValue){this.value='$origDefValue';this.select();} ";
                                        }
                                        $keyupStr .= $keyupAct;


                                        $disabled = "";
                                        if (isset($oValSpec['disabled'])) {
                                            $disabled = $oValSpec['disabled'];
                                        }


                                        $blurStr = "";
                                        if ($minValue != "") {
                                            $blurStr = "if(this.value!=this.defaultValue){if(parseInt(this.value)>=$minValue){hiliteDiv(this);top.$('#result').load($relInputTarget);}else{this.value='$minValue';this.focus();}}";
                                        }
                                        else {
                                            $blurStr = "if(this.value!=this.defaultValue){hiliteDiv(this);top.$('#result').load($relInputTarget);}";

                                        }
                                        //endregion

                                        $defVal = isset($_SESSION[$cCode]['main'][$oValueName]) && $_SESSION[$cCode]['main'][$oValueName] > 0 ? ($_SESSION[$cCode]['main'][$oValueName] + 0) : $origDefValue;
                                        if (isset($addRowsConfigs[$eName][$currentValue][$oValueName]['role']) && $addRowsConfigs[$eName][$currentValue][$oValueName]['role'] == "minus") {
                                            $defVal = "(" . $defVal . ")";
                                        }
                                        //                                    $defVal = $origDefValue;
                                        $addRows[$oValueName] = "<input type=text autocomplete='off' id='$oValueName' class='form-control text-right' style='font-size:17px;' $disabled placeholder='$oValueName' value='$defVal' $minValStr $maxValStr 
onfocusssss='this.select()' onkeyup=\"$keyupStr\" onfocus=\"$keyupStr\"
onblur=\"$blurStr\"
onmouseout=\"$blurStr\"
>";
                                        $_SESSION[$cCode]['add_rows'][$oValueName] = $defVal;
                                        $addRowLabels[$oValueName] = $oValSpec['label'];

                                    }

                                }

                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                            //                        cekmerah("aturan untuk $currentValue TIDAK ada");
                        }

                    }
                    else {
                        //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                    }


                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $addStr = "";
                            $editStr = "";
                            $amdlName = $eSpec['mdlName'];
                            $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();

                            $elStr[$eName] = "";
                            $this->load->model("Mdls/" . $amdlName);
                            $labelSrc = $eSpec['labelSrc'];
                            $keySrc = $eSpec['key'];
                            $oo = new $amdlName();
                            $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $amdlName);

                            if (sizeof($aFilter) > 0) {
                                foreach ($aFilter as $filter) {
                                    $exFilter = explode("=", $filter);
                                    if (sizeof($exFilter) > 1) {
                                        if (substr($exFilter[1], 0, 1) == ".") {
                                            //                                        $oo->addFilter($exFilter[0] . "='" . ltrim($exFilter[1], ".") . "'");
                                        }
                                        else {
                                            if (isset($_SESSION[$cCode]['main'][$exFilter[1]])) {
                                                //                                            $oo->addFilter($exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'");
                                                $addLink .= "?reqField=" . $exFilter[0] . "&reqVal=" . $_SESSION[$cCode]['main'][$exFilter[1]];
                                            }
                                            else {
                                                //                                            $oo->addFilter($exFilter[0] . "='none'");
                                            }
                                        }
                                    }
                                }
                                $oo = makeFilter($aFilter, $_SESSION[$cCode]['main'], $oo);
                            }

                            $addClick = "";
                            $dataAccess = isset($this->config->item('heDataBehaviour')[$amdlName]) ? $this->config->item('heDataBehaviour')[$amdlName] : array(
                                "viewers" => array(),
                                "creators" => array(),
                                "creatorAdmins" => array(),
                                "updaters" => array(),
                                "updaterAdmins" => array(),
                                "deleters" => array(),
                                "deleterAdmins" => array(),
                                "historyViewers" => array(),
                            );
                            $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
                            if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
                                if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                                    $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        type:top.BootstrapDialog.TYPE_SUCCESS,
                                        }
                                        );";
                                    $addStr = "<a href='javascript:void(0)' class='btn btn-tool' onclick=\"$addClick\"><span class='glyphicon glyphicon-plus'></span></a>";
                                }
                            }

                            //                        cekmerah("pre..");
                            $tmpo = $oo->lookupAll()->result();
                            //                        cekmerah($this->db->last_query());
                            $elPair[$amdlName] = array();
                            $selectorTarget = "'" . base_url() . get_class($this) . "/fetchElement/" . $this->jenisTr . "/$eName/$amdlName/?key='+this.value";

                            $elStr[$eName] .= "<div class='box-body'>";

                            switch ($eSpec['inputType']) {
                                case "combo":
                                    $elStr[$eName] .= "<select class='form-control' onchange=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">";
                                    $elStr[$eName] .= "<option value=''>-select-</option>";
                                    if (sizeof($tmpo) > 0) {
                                        foreach ($tmpo as $row) {

                                            $ex = explode("/", $elementConfigs[$eName]['labelSrc']);
                                            if (sizeof($ex) > 1) {
                                                $labelValue = "";
                                                foreach ($ex as $col) {

                                                    $labelValue .= $row->$col . " / ";
                                                }
                                                $labelValue = rtrim($labelValue, " / ");
                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";

                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $labelValue . "</option>";
                                                //                                            $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $$labelValue . "</option>";

                                            }
                                            else {
                                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $row->$labelSrc . "</option>";
                                            }


                                        }
                                    }
                                    $elStr[$eName] .= "</select>";
                                    break;
                                case "radio":

                                    if (sizeof($tmpo) > 0) {
                                        foreach ($tmpo as $row) {
                                            $ex = explode("/", $elementConfigs[$eName]['labelSrc']);
                                            if (sizeof($ex) > 1) {
                                                $labelValue = "";
                                                foreach ($ex as $col) {

                                                    $labelValue .= $row->$col . " / ";
                                                }
                                                $labelValue = rtrim($labelValue, " / ");
                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";
                                                $elStr[$eName] .= "<label class='badge' style='padding:4px 6px 4px 6px;color:#454545;background:#e0e0e0;'><input type='radio' name='$eName' value='" . $row->$keySrc . "' $selected onclick=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">" . $labelValue . "</label>&nbsp;";
                                            }
                                            else {
                                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";
                                                $elStr[$eName] .= "<label class='badge' style='padding:4px 6px 4px 6px;color:#454545;background:#e0e0e0;'><input type='radio' name='$eName' value='" . $row->$keySrc . "' $selected onclick=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">" . $row->$labelSrc . "</label>&nbsp;";
                                            }

                                        }
                                    }
                                    break;
                            }


                            $elStr[$eName] .= "</div class='box-header'>";

                            $defKey = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : 0;
                            $defValue = "";
                            if (isset($_SESSION[$cCode]['main_elements'][$eName]['key']) && $_SESSION[$cCode]['main_elements'][$eName]['contents']) {
                                if (isset($elementConfigs[$eName]['usedFields']) && sizeof($elementConfigs[$eName]['usedFields']) > 0) {
                                    //								$defValue .= "<table class='table table-condensed no-padding' style='padding:0px;margin:0px;'>";
                                    $defValue .= "<div class='panel-body'>";
                                    $defValue .= "<table cellspacing='0' cellpadding='0' border='0'>";
                                    $contents[$eName] = unserialize(base64_decode($_SESSION[$cCode]['main_elements'][$eName]['contents']));
                                    foreach ($elementConfigs[$eName]['usedFields'] as $src => $label) {
                                        $fieldLabel = isset($contents[$eName][$src]) ? $contents[$eName][$src] : "-";
                                        //                                    if(is_numeric($fieldLabel)){
                                        //                                        $fieldLabel=number_format($fieldLabel);
                                        //                                    }
                                        $defValue .= "<tr>";
                                        $defValue .= "<td align='left'>$label";
                                        $defValue .= "&nbsp;</td>";
                                        $defValue .= "<td align='left'>:&nbsp;" . $fieldLabel;
                                        $defValue .= "</td>";
                                        $defValue .= "</tr>";
                                    }
                                    $defValue .= "</table>";
                                    $defValue .= "</div class='panel-body'>";
                                }
                            }
                            else {//menentukan nilai default

                            }

                            if ($defKey > 0) {
                                if (sizeof($mems) > 0 && sizeof($dataAccess['updaters']) > 0) {
                                    $editLink = base_url() . "Data/edit/" . str_replace("Mdl", "", $amdlName) . "/$defKey";
                                    if (sizeof(array_intersect($mems, $dataAccess['updaters'])) > 0) {
                                        $editClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $editLink . "'),
                                        draggable:true,
                                        size:BootstrapDialog.SIZE_WIDE,
                                        closable:true,
                                        type:top.BootstrapDialog.TYPE_SUCCESS,
                                        }
                                        );";

                                        $editStr = "<a href='javascript:void(0)' class='btn btn-tool' onclick=\"$editClick\"><span class='glyphicon glyphicon-pencil'></span></a>";
                                    }
                                }
                            }

                            $elStr[$eName] .= "<div id='divel_$eName' style='padding:2px;font-size:smaller;'>$defValue";
                            $elStr[$eName] .= "</div id='el$amdlName'>";

                            $elements[$eName] = array(
                                "mdlName" => $eSpec['mdlName'],
                                "label" => $eSpec['label'],
                                "string" => $elStr[$eName],
                                "editStr" => $editStr,
                                "addStr" => $addStr,
                                "bgColor" => $defValue == "" ? "#fcfce0" : "#f5fff9",
                            );


                            break;
                        case "dataField":
                            $elStr[$eName] = "";
                            $initValue = isset($eSpec['defaultValue']) ? $eSpec['defaultValue'] : "";
                            //                        $defaultValue = isset($_SESSION[$cCode]['main_elements'][$eName]['value']) ? $_SESSION[$cCode]['main_elements'][$eName]['value'] : "";
                            $defaultValue = isset($_SESSION[$cCode]['main'][$eName]) ? $_SESSION[$cCode]['main'][$eName] : 0;
                            $selectorTarget = "'" . base_url() . get_class($this) . "/recordFieldElement/" . $this->jenisTr . "/$eName/$amdlName/?val='+this.value";
                            //                        $elStr[$eName] .="<div class='box'>";

                            $maxValue = isset($eSpec['maxValue']) && isset($_SESSION[$cCode]['main'][$eSpec['maxValue']]) ? $_SESSION[$cCode]['main'][$eSpec['maxValue']] : "";

                            $elStr[$eName] .= "<div class='box-body'>";
                            switch ($eSpec['inputType']) {
                                case "text":
                                    $elStr[$eName] .= "<input type=text class='form-control' value='$defaultValue' onfocus='this.select()' oonclick=\"this.value='$defaultValue';\" 
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                                case "number":
                                    $maxValStr = $maxValue != "" ? " max='" . $maxValue . "''" : "";
                                    $maxValValidator = $maxValue != "" ? " onkeyup=\"if(this.value>$maxValue){this.value='$maxValue';}\" " : "";
                                    $elStr[$eName] .= "<input type=number class='form-control' value='$defaultValue' onfocus='this.select()' $maxValStr $maxValValidator oonclick=\"this.value='$defaultValue';\" 
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                                case "date":
                                    $elStr[$eName] .= "<input type=date class='form-control' value='$defaultValue' onfocus='this.select()' oonclick=\"this.value='$defaultValue';\" 
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                            }
                            $elStr[$eName] .= "</div class='box-body'>";

                            $elements[$eName] = array(
                                "mdlName" => null,
                                "label" => $eSpec['label'],
                                "string" => $elStr[$eName],
                                "editStr" => "",
                                "addStr" => "",
                                "bgColor" => $defaultValue == "" ? "#fcfce0" : "#fcfcff",
                            );
                            break;
                    }
                }
            }
        }


        //endregion.

        //region tambah additional rows tampil
        $addRowLabels = array();
        if (sizeof($elementConfigs) > 0) {
            foreach ($elementConfigs as $eName => $eSpec) {
                if (array_key_exists($eName, $addRowsConfigs)) {

                    switch ($elementConfigs[$eName]['elementType']) {
                        case "dataModel":
                            $currentValue = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : "";
                            break;
                        case "dataField":
                            $currentValue = $_SESSION[$cCode]['main_elements'][$eName]['value'];
                            break;
                    }

                    if (isset($addRowsConfigs[$eName][$currentValue])) {
                        if (sizeof($addRowsConfigs[$eName][$currentValue]) > 0) {

                            foreach ($addRowsConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                //                                cekhijau($oValueName);
                                //                                arrprint($oValSpec);
                                if (isset($oValSpec['addPoints']) && in_array(1, $oValSpec['addPoints'])) {
                                    if (!isset($oValSpec['hideRow'])) {
                                        $addRowLabels[$oValueName] = $oValSpec['label'];
                                    }

                                }

                            }

                        }
                    }
                    else {
                        //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        //                        cekmerah("aturan untuk $currentValue TIDAK ada");
                    }

                }
                else {
                    //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                }

            }
        }
        //endregion

        //region add mainData
        //        cekHitam($targetStepNum." ".$this->jenisTr);
        $addMainSource = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$targetStepNum] : array();
        $addMainSourceField = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$targetStepNum]["fields"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$targetStepNum]["fields"] : array();
        $addMainSourceEdit = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$targetStepNum]["editableFields"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$targetStepNum]["editableFields"] : array();

        //        arrPrint($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"]);


        //endregion


        $detilSizeBar = array();
        $measureConf = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartMeasurement'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartMeasurement'][$targetStepNum] : false;
        //        cekHere($currentStepNum);
//        arrPrint($measureConf);
        if ($measureConf) {
            if (isset($elements['detilSize'])) {
                $detilSizeBar = array(
                    "volume_gross" => isset($main['volume_gross']) ? number_format(conv_mmc_mc($main['volume_gross']), 2) : 0,
                    "berat_gross" => isset($main['berat_gross']) ? conv_g_kg($main['berat_gross']) : 0,
                );
            }
        }


        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        $itemLabels3 = $itemLabels3 + $itemNumLabels3 + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$targetStepNum] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
            unset($itemLabels3['subtotal']);
        }

        $pairedItemTarget = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName'] : "items2_sum";

        $itemsEditableConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupItemEditable']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupItemEditable'] : "_followupLiveEdit/updateItemField/";
        $itemsRemoveConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupItemRemove']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupItemRemove'] : "_followupLiveEdit/removeItem/";
        $mainEditableConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainEditable']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainEditable'] : "_followupLiveEdit/updateMainField/";

        $definitionButton = definitionButton();

        if ($partialCanceled == false) {
            $deleteSpec = array(
                "label" => "cannot delete",
                "targetUrl" => "",
                "warning" => "",
            );
            $undoSpec = array(
                "label" => "cannot undo",
                "targetUrl" => "",
                "warning" => "",
            );
            $rejectionSpec = array(
                "label" => "cannot reject 1 step",
                "targetUrl" => "",
                "warning" => "",
            );
            $rejectionSpecAll = array(
                "label" => "cannot reject all steps",
                "targetUrl" => "",
                "warning" => "",
            );
            $editSpec = array(
                "label" => "cannot edit",
                "targetUrl" => "",
                "warning" => "",
            );

            $lastWarningLabel = isset($msgWarning2[$_SESSION[$cCode]['main']['masterID']]['label']) ? $msgWarning2[$_SESSION[$cCode]['main']['masterID']]['label'] . "<br>" : "";
            $newWarningLabel = "Transaksi ini telah diproses sebagian, UNDO/REJECT/DELETE/EDIT tidak bisa digunakan.";
            $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                "label" => $lastWarningLabel . $newWarningLabel,
            );

            // $arrSwals = array(
            //     "type"              => "warning",
            //     "html"              => $newWarningLabel,
            //     "allowOutsideClick" => false,
            //     // "imageUrl"            => img_bitzer(),
            //     "background" => "aqua",
            //     "confirmButtonColor" => "#ff0055",
            // );
            //
            // echo swalAlert($arrSwals);
        }
        if ($allowedAction == false) {
            $deleteSpec = array(
                "label" => "cannot delete",
                "targetUrl" => "",
                "warning" => "",
            );
            $undoSpec = array(
                "label" => "cannot undo",
                "targetUrl" => "",
                "warning" => "",
            );
            $rejectionSpec = array(
                "label" => "cannot reject 1 step",
                "targetUrl" => "",
                "warning" => "",
            );
            $rejectionSpecAll = array(
                "label" => "cannot reject all steps",
                "targetUrl" => "",
                "warning" => "",
            );
            $editSpec = array(
                "label" => "cannot edit",
                "targetUrl" => "",
                "warning" => "",
            );
            $approvalSpec = array(
                "label" => "cannot approve",
                "targetUrl" => "",
                "warning" => "",
            );
            $xShipmentBtn = array();
            $extBtns = array();
            $extNewBtns = array();
            $payBtns = array();

            $lastWarningLabel = isset($msgWarning2[$_SESSION[$cCode]['main']['masterID']]['label']) ? $msgWarning2[$_SESSION[$cCode]['main']['masterID']]['label'] . "<br>" : "";
            $newWarningLabel = "Transaksi ini dikunci karena sedang ditindaklanjuti oleh <span class='text-uppercase text-bold'>$allowedActionByHold</span>.";
            $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                "label" => $lastWarningLabel . $newWarningLabel,
            );
        }

        //-----------------------------------------------------
        $beforeStepWarning = NULL;
        $beforeStepNum = $currentStepNum - 1;
        if ($beforeStepNum > 0) {
            $beforeStepLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$beforeStepNum]['label']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$beforeStepNum]['label'] : "-";
            $beforeStepLabels = "Transaksi akan kembali ke $beforeStepLabels";
            $beforeStepWarning = "DELETE, UNDO, REJECT 1 STEP: Transaksi akan mundur 1 langkah. $beforeStepLabels.";
        }
        else {
            $beforeStepLabels = "Transaksi akan ditutup dan tidak bisa dilanjutkan.";
            $beforeStepWarning = "DELETE, UNDO, REJECT 1 STEP: Transaksi akan ditutup dan tidak bisa dilanjutkan.";
        }
        $beforeAllStepLabels = "Transaksi akan ditutup dan tidak bisa dilanjutkan.";

        //-----------------------------------------------------
//        cekKuning($kompositValidateConfigs);
        if (sizeof($kompositValidateConfigs) > 0) {
            if (isset($kompositValidateConfigs['enabled']) && ($kompositValidateConfigs['enabled'] == true)) {
                $this->load->model("Mdls/" . $kompositValidateConfigs['mdlName']);
                $kmp = New $kompositValidateConfigs['mdlName']();
                $kmp->addFilter("produk_id in ('" . implode("','", $itemsKompositID) . "')");
                $kmpTmp = $kmp->lookupAll()->result();
                $kompositComponent = array();
                if (sizeof($kmpTmp) > 0) {
                    foreach ($kmpTmp as $kmpSpec) {
                        $kompositComponent[$kmpSpec->produk_id][] = $kmpSpec;
                    }
                }
//                cekKuning($kompositComponent);
                $noComponent = array();
                foreach ($itemsKompositName as $pID => $pName) {
                    if (!array_key_exists($pID, $kompositComponent)) {
                        $noComponent[$pID] = $pName;
                    }
                }

                if (sizeof($noComponent) > 0) {
                    $link = base_url() . "Data/view/ProdukKomposit";
                    $produk_ket = implode(",", $noComponent);
                    $msg = "Produk $produk_ket belum memiliki komposisi. ";
                    $msg .= "Untuk mengatur komposisinya ";
                    $msg .= "<a href='$link' style='font-weight:bold;color:#ffffff;'>klik disini</a>";
                    $msgWarning2[$_SESSION[$cCode]['main']['masterID']]['label'] = $msg;

                    $approvalSpec = array(
                        "label" => "cannot approve",
                        "targetUrl" => "",
                        "warning" => "",
                    );
                }
            }
        }


        // menonaktifkan tombol approve di followupPreview, tembakan menonaktifkan tombol-tombol
        $pakai_ini = 1;
        if ($pakai_ini == 1) {
            if (($this->jenisTr == "110")) {
                $rejectionSpecAll = array(
                    "label" => "cannot reject all steps",
                    "targetUrl" => "",
                    "warning" => "",
                );
            }
//            if (($this->jenisTr == "967") && ($targetStepNum == 2)) {
//                $approvalSpec = array(
//                    "label" => "cannot approve",
//                    "targetUrl" => "",
//                    "warning" => "",
//                );
//            }
            //            if (($this->jenisTr == "582") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "582") && ($targetStepNum == 4)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "382") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "382") && ($targetStepNum == 4)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "466") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "461") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "585") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "985") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "982") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1585") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1985") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "2985") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "3585") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "967") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "961") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "587") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "587") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "687") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "687") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1587") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1587") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1687") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1687") && ($targetStepNum == 3)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "334") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1334") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
            //            elseif (($this->jenisTr == "1337") && ($targetStepNum == 2)) {
            //                $approvalSpec = array(
            //                    "label" => "cannot approve",
            //                    "targetUrl" => "",
            //                    "warning" => "",
            //                );
            //            }
        }

        //--- cek saldo kas/valas uang muka valas
        $saldoLockerConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['saldoLocker']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['saldoLocker'] : array();
        if ((sizeof($saldoLockerConfig) > 0) && ($saldoLockerConfig['enabled'] == true)) {
            if (isset($saldoLockerConfig['pairModel'])) {
                $result = array();
                $resultLockerLabel = array();
                foreach ($saldoLockerConfig['pairModel'] as $mtd => $pmSpec) {
                    $resultLockerLabel[$mtd] = $pmSpec['label'];
                    $mdl = $pmSpec['mdlName'];
                    $this->load->model("Mdls/$mdl");
                    $md = New $mdl();
                    if (isset($pmSpec['mdlFilter']) && (sizeof($pmSpec['mdlFilter']) > 0)) {
                        makeFilter($pmSpec['mdlFilter'], $_SESSION[$cCode]['main'], $md);
                    }
                    $mdTmp = $md->lookupAll()->result();
//                    showLast_query("biru");

                    if (sizeof($mdTmp) > 0) {
                        $result[$mtd] = array(
                            "name" => $_SESSION[$cCode]['main'][$pmSpec['sesKey']],
                            "nilai" => $mdTmp[0]->nilai,
                        );
                    }
                    else {
                        $result[$mtd] = array(
                            "name" => $_SESSION[$cCode]['main'][$pmSpec['sesKey']],
                            "nilai" => 0,
                        );
                    }

                }
                if (sizeof($result) > 0) {
                    $metode = $_SESSION[$cCode]['main']['pihak3ID'];
                    switch ($metode) {
                        case "cash":
                            if (isset($result[$metode])) {
                                $bayar_total = $_SESSION[$cCode]['main']['total_bayar'];
                                $saldo = isset($result[$metode]['nilai']) ? $result[$metode]['nilai'] : 0;
                                $kas_nama = isset($result[$metode]['name']) ? $result[$metode]['name'] : "";
//                                $saldo = 0;
                                if ($bayar_total > $saldo) {
                                    $result[$metode]['warning'] = "Saldo kas $kas_nama tidak cukup untuk melanjutkan transaksi ini. Silahkan mengisi saldo kas atau melakukan edit.";
//                                    $result[$metode]['warning'] = $resultLockerLabel[$metode];
                                    $approvalSpec = array(
                                        "label" => "cannot approve",
                                        "targetUrl" => "",
                                        "warning" => "",
                                    );
                                }
                            }
                            break;
                        case "valas":
                            if (isset($result[$metode])) {
                                $bayar_total_valas = $_SESSION[$cCode]['main']['valas_nilai_bayar'];
                                $bayar_total = $_SESSION[$cCode]['main']['biaya_transfer'] + $_SESSION[$cCode]['main']['biaya_lain_lain_novalas'];
                                $saldo = isset($result[$metode]['nilai']) ? $result[$metode]['nilai'] : 0;
                                $valas_nama = isset($result[$metode]['name']) ? $result[$metode]['name'] : "";
                                $kas_nama = isset($result['cash']['name']) ? $result['cash']['name'] : "";
                                $kas_saldo = isset($result['cash']['nilai']) ? $result['cash']['nilai'] : "";
                                $metodeWarning = "";
                                if ($bayar_total_valas > $saldo) {
//                                        $result[$mtd]['warning'] = $resultLockerLabel[$metode];
                                    $metodeWarning .= "Saldo valas $valas_nama tidak cukup untuk melanjutkan transaksi ini.<br>";
                                    $approvalSpec = array(
                                        "label" => "cannot approve",
                                        "targetUrl" => "",
                                        "warning" => "",
                                    );
                                }
                                if ($bayar_total_valas > $kas_saldo) {
                                    $metodeWarning .= "Saldo kas $kas_nama tidak cukup untuk melanjutkan transaksi ini.";
                                    $approvalSpec = array(
                                        "label" => "cannot approve",
                                        "targetUrl" => "",
                                        "warning" => "",
                                    );
                                }
                                $result[$metode]['warning'] = $metodeWarning;
                            }
                            break;
                    }
                }
            }
        }
//arrPrintPink($result);
        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $_SESSION[$cCode]['main'],
            "detailValues" => $_SESSION[$cCode]['tableIn_detail_values'],
            "itemLabels" => $itemLabels,
            "itemLabels2" => $itemLabels2,
            "itemLabels3" => $itemLabels3,
            "noteEnabled" => $noteEnabled,
            "noteEditabled" => $noteEditabled,
            "noteType" => $noteType,
            "imageEnabled" => $imageEnabled,
            "imageType" => $imageType,

            "items" => $_SESSION[$cCode]['items'],
            "items2" => isset($_SESSION[$cCode][$pairedItemTarget]) ? $_SESSION[$cCode][$pairedItemTarget] : array(),
            "items3" => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
            "items_child" => isset($_SESSION[$cCode]['items_child']) ? $_SESSION[$cCode]['items_child'] : array(),
            "itemsChildLabel" => $itemsChildLabel,
            "itemsChildLabelEditable" => $itemsChildEditable,
            "itemsChildGate" => $itemsChildGate,
            "buttonLabel" => $buttonLabel,
            "saveWarning" => $saveWarning,
            "sumRows" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][$targetStepNum] : $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$targetStepNum],
            "sumRowsAdditional" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFieldsAdditional'][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFieldsAdditional'][$targetStepNum] : array(),
            "sumAddRows" => $addRowLabels,
            "sumRows3" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields3'][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields3'][$targetStepNum] : isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields3'][$targetStepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields3'][$targetStepNum] : array(),
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "extEditableFields" => $editableAddVals,

            "mainAddValues" => $mainAddValues,
            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),

            "mainElements" => $_SESSION[$cCode]['main_elements'],
            "elements" => $elements,
            "editableElements" => $editableElements,
            "elementConfig" => $elementConfigs,
            "mainInputs" => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
            "elementEditTarget" => base_url() . "_followupLiveEdit/selectElement/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            //            "actionTarget" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum",
            "actionTarget" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum",
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "grandTotal" => isset($_SESSION[$cCode]['main']['grand_total']) ? $_SESSION[$cCode]['main']['grand_total'] : 0,


            "description" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            "descriptionAdditional" => isset($_SESSION[$cCode]['main']['description_additional'][$targetStepNum]) ? $_SESSION[$cCode]['main']['description_additional'][$targetStepNum] : "",
            "descriptionAdditionalPreviews" => isset($_SESSION[$cCode]['main']['description_additional']) ? $_SESSION[$cCode]['main']['description_additional'] : array(),
            "descriptionAdditionalRule" => $noteAdditionalEditabled,

            "descriptionMainFollowup" => isset($_SESSION[$cCode]['main']['description_main_followup']) ? $_SESSION[$cCode]['main']['description_main_followup'] : "",
            "descriptionMainFollowupRule" => $noteFollowupEditabled,

            "allowEdit" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowEdit'] : false,
            "allowRemove" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowRemove']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowRemove'] : true,
            "allowCancel" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowCancel'] : false,
            "allowIncrement" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowIncrement']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowIncrement'] : false,
            "editableFields" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$targetStepNum] : array(),
            "stepLabels" => $stepLabels,
            "rawPrevURL" => $rawPrevURL,
            "rawBuilderURL" => $rawBuilderURL,
            "currentStep" => $targetStepNum,
            "extSteps" => isset($_SESSION[$cCode]['extSteps']) ? $_SESSION[$cCode]['extSteps'] : array(),
            "paySrcs" => isset($_SESSION[$cCode]['paySrcs']) ? $_SESSION[$cCode]['paySrcs'] : array(),
            "extBtns" => $extBtns,
            "extNewBtns" => $extNewBtns,
            "payBtns" => $payBtns,
            "xShipmentBtn" => $xShipmentBtn,
            //==================liveEdit========================
            "followupSegments" => array(
                $this->uri->segment(3),
                $this->uri->segment(4),
                $this->uri->segment(5),
            ),
            "removeItemTarget" => base_url() . "$itemsRemoveConfig" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateItemFieldTarget" => base_url() . "$itemsEditableConfig" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateItemChildTarget" => base_url() . "_followupLiveEdit/updateChildField/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateMainFieldTarget" => base_url() . "$mainEditableConfig" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateMainSourceTarget" => base_url() . "_followupLiveEdit/updateSourceField/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "clearContentTarget" => base_url() . get_class($this) . "/clearContent/" . $this->jenisTr . "/" . $this->uri->segment(3),
            "msgWarning" => isset($msgWarning) ? $msgWarning : array(),

            "msgWarning2" => isset($msgWarning2) ? $msgWarning2 : array(),

            "addRows" => $addRows,
            "addRowLabels" => $addRowLabels,
            "deleteSpec" => $deleteSpec,
            "undoSpec" => $undoSpec,
            "rejectionSpec" => $rejectionSpec,
            "rejectionSpecAll" => $rejectionSpecAll,
            "approvalSpec" => $approvalSpec,
            "editSpec" => $editSpec,
            "detailSizeKey" => $detailSizeKey,
            "detilSizeBar" => $detilSizeBar,
            "addMainSourceField" => $addMainSourceField,
            "addMainSourceEdit" => $addMainSourceEdit,
            "definitionButton" => $definitionButton,
            "dpData" => $dpData,
            //--------------------------
            "beforeStepLabels" => $beforeStepLabels,
            "beforeAllStepLabels" => $beforeAllStepLabels,
            "beforeStepWarning" => $beforeStepWarning,

            "itemsKompositID" => $itemsKompositID,
            //-----------------------
            "saldoLocker" => isset($result) ? $result : array(),
        );


        if (isset($_SESSION[$cCode]['main'])) {
            $data['pihakID'] = isset($_SESSION[$cCode]['main']['pihakID']) ? $_SESSION[$cCode]['main']['pihakID'] : 0;
            $data['pihakName'] = isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : "";
        }
        //endregion


        $this->load->view("transaksi", $data);

    }

    public function preview()
    {

        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;
        $stepNumber = isset($_SESSION[$cCode]['tableIn_master']['step_number']) ? $_SESSION[$cCode]['tableIn_master']['step_number'] : 1;
        $itemLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$stepNumber] : array();
        $itemLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$stepNumber] : array();
        $itemLabels3 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields3'][$stepNumber] : array();
        $itemSrcLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFieldItemSrc'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFieldItemSrc'][$stepNumber] : array();
        $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
        $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$stepNumber] : array();
        $itemNumLabels3 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$stepNumber] : array();
        $itemSrcNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFieldItemSrc'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFieldItemSrc'][$stepNumber] : array();
        $fieldSrcs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFieldSrc']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFieldSrc'] : array();

        $appletConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['applets']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['applets'] : array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
        $imageEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled'] == true ? true : false;
        $addRowsConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows'] : array();
        $inputLabels = array();
        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";

        //
        //region lookup items from shopping cart sessions

        //        cekbiru($rawPrevURL);

        $main = array();
        $items = array();
        $items2 = array();
        $items2_sum = array();
        $items3_sum = array();
        $itemsSrc = array();
        //        arrPrint($_SESSION[$cCode]['itemSrc']);
        //        matiHEre();
        if (isset($_SESSION[$cCode])) {
            if (isset($_SESSION[$cCode]['items'])) {
                foreach ($_SESSION[$cCode]['items'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "no_part" => isset($iSpec['no_part']) ? $iSpec['no_part'] : "n/a",

                        "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : "",
                        "stok_center" => isset($iSpec['stok_center']) ? $iSpec['stok_center'] : "0",
                        "merk" => isset($iSpec['merk']) ? $iSpec['merk'] : "",
                        "serial_no" => isset($iSpec['serial_no']) ? $iSpec['serial_no'] : "",
                        "kode" => isset($iSpec['kode']) ? $iSpec['kode'] : "",
                        "extern_date2" => isset($iSpec['extern_date2']) ? $iSpec['extern_date2'] : "",
                        "extern_label2" => isset($iSpec['extern_label2']) ? $iSpec['extern_label2'] : "",
                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    //-------------------------------------
                    if (sizeof($fieldSrcs) > 0) {
                        foreach ($fieldSrcs as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                        }
                    }
                    //-------------------------------------
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = $iSpec['subtotal'];


                    $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                    $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];

                    $items[] = $tmp;
                }
            }

            if (isset($_SESSION[$cCode]['items2'])) {
                foreach ($_SESSION[$cCode]['items2'] as $aSpec) {
                    //                    arrPrint($iSpec);
                    foreach ($aSpec as $iSpec) {
                        if (isset($iSpec['id'])) {

                            $tmp = array(
                                "id" => $iSpec['id'],
                                "nama" => $iSpec['nama'],
                                "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                                "jml" => $iSpec['jml'],
                                "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                                "no_part" => isset($iSpec['no_part']) ? $iSpec['no_part'] : "n/a",

                                "kode" => isset($iSpec['kode']) ? $iSpec['kode'] : "n/a",
                                "disc_value" => isset($iSpec['disc_value']) ? $iSpec['disc_value'] : "0",
                                "jual" => isset($iSpec['jual']) ? $iSpec['jual'] : 0,
                                "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : 0,
                                "stok_center" => isset($iSpec['stok_center']) ? $iSpec['stok_center'] : 0,
                                "harga_ori" => isset($iSpec['harga_ori']) ? $iSpec['harga_ori'] : "",
                                "harga" => isset($iSpec['harga']) ? $iSpec['harga'] : "",

                            );
                            if (sizeof($itemNumLabels) > 0) {
                                foreach ($itemNumLabels as $key => $label) {
                                    $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                                    if (!isset($main[$key])) {
                                        $main[$key] = 0;
                                    }
                                    $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                                }
                            }
                            if ($noteEnabled) {
                                if (isset($iSpec['note'])) {
                                    $tmp['note'] = $iSpec['note'];
                                }
                            }
                            if ($imageEnabled) {
                                if (isset($iSpec['images'])) {
                                    $tmp['images'] = $iSpec['images'];
                                }
                            }
                            $tmp['subtotal'] = $iSpec['subtotal'];

                            if (isset($iSpec['handler'])) {
                                $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                                $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];
                            }
                            else {
                                $tmp["editTarget"] = "#";
                                $tmp["removeTarget"] = "#";
                            }

                            $items2[] = $tmp;
                        }
                    }


                }
            }

            if (isset($_SESSION[$cCode]['items2_sum'])) {
                foreach ($_SESSION[$cCode]['items2_sum'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "no_part" => isset($iSpec['no_part']) ? $iSpec['no_part'] : "n/a",

                        "kode" => isset($iSpec['kode']) ? $iSpec['kode'] : "n/a",
                        "harga" => isset($iSpec['harga_ori']) ? $iSpec['harga_ori'] : isset($iSpec['harga']) ? $iSpec['harga'] : "0",
                        "harga_ori" => isset($iSpec['harga_ori']) ? $iSpec['harga_ori'] : "",
                        "referensi" => isset($iSpec['pihakName']) ? $iSpec['pihakName'] : "",
                        "disc_value" => isset($iSpec['disc_value']) ? $iSpec['disc_value'] : 0,
                        "jual" => isset($iSpec['jual']) ? $iSpec['jual'] : 0,

                        "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : "",
                        "stok_center" => isset($iSpec['stok_center']) ? $iSpec['stok_center'] : "0",
                        "sisa" => isset($iSpec['stok']) ? $iSpec['stok'] - $iSpec['jml'] : "",
                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = isset($iSpec['subtotal']) ? $iSpec['subtotal'] : 0;

                    if (isset($iSpec['handler'])) {

                        $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                        $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];
                    }
                    else {
                        $tmp["editTarget"] = "#";
                        $tmp["removeTarget"] = "#";
                    }

                    $items2_sum[] = $tmp;
                }
            }

            if (isset($_SESSION[$cCode]['items3_sum'])) {
                foreach ($_SESSION[$cCode]['items3_sum'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "no_part" => isset($iSpec['no_part']) ? $iSpec['no_part'] : "n/a",

                        "harga" => isset($iSpec['harga']) ? $iSpec['harga'] : "",
                        "referensi" => isset($iSpec['pihakName']) ? $iSpec['pihakName'] : "",
                        "sub_nilai" => isset($iSpec['sub_nilai']) ? $iSpec['sub_nilai'] : "",

                        "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : "",
                        "stok_center" => isset($iSpec['stok_center']) ? $iSpec['stok_center'] : "0",
                        "sisa" => isset($iSpec['stok']) ? $iSpec['stok'] - $iSpec['jml'] : "",
                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = isset($iSpec['subtotal']) ? $iSpec['subtotal'] : 0;

                    if (isset($iSpec['handler'])) {

                        $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                        $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];
                    }
                    else {
                        $tmp["editTarget"] = "#";
                        $tmp["removeTarget"] = "#";
                    }

                    $items3_sum[] = $tmp;
                }
            }
            if (isset($_SESSION[$cCode]['itemSrc'])) {
                foreach ($_SESSION[$cCode]['itemSrc'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "no_part" => isset($iSpec['no_part']) ? $iSpec['no_part'] : "n/a",

                        "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : "",
                        "stok_center" => isset($iSpec['stok_center']) ? $iSpec['stok_center'] : "0",
                        "merk" => isset($iSpec['merk']) ? $iSpec['merk'] : "",
                        "serial_no" => isset($iSpec['serial_no']) ? $iSpec['serial_no'] : "",
                        "kode" => isset($iSpec['kode']) ? $iSpec['kode'] : "",
                        "extern_date2" => isset($iSpec['extern_date2']) ? $iSpec['extern_date2'] : "",
                        "extern_label2" => isset($iSpec['extern_label2']) ? $iSpec['extern_label2'] : "",
                        "extern_nama" => isset($iSpec['extern_nama']) ? $iSpec['extern_nama'] : "",
                    );
                    if (sizeof($itemSrcNumLabels) > 0) {
                        foreach ($itemSrcNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            //                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = $iSpec['subtotal'];


                    $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                    $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];

                    $itemsSrc[] = $tmp;
                }
            }
        }
        //endregion

        //
        //region labels for preview's bottom elements
        $jenisTr = $this->jenisTr;
        $buttonLabel = $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['actionLabel'];
        if (sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']) > 1) {
            $saveWarning = "clicking <strong>$buttonLabel</strong> button will make transaction state to: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['stateLabel'] . "</strong>";
            $saveWarning .= "<br>It would need to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][2]['userGroup'] . "</strong>";
        }
        else {
            $saveWarning = "clicking <strong>$buttonLabel</strong> button will instantly make transaction state to <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['stateLabel'] . "</strong>";
        }
        //endregion


        $stepLabels = array();
        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $num => $sSpec) {
            $stepLabels[$num] = $sSpec['label'];
        }

        //

        //region prepare params to viewer

        $tmpTableIn_master = isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array();
        $tmpTableIn_masterValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        $main = array_merge(array_filter($main), array_filter($tmpTableIn_master), array_filter($tmpTableIn_masterValues), array_filter($_SESSION[$cCode]['main']));
        $mainAddValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
            $mainAddValues = array_merge(array_filter($mainAddValues), array_filter($_SESSION[$cCode]['main_add_values']));
        }

        //        arrPrint($mainAddValues);

        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            //            cekbiru("hendak memeriksa relative impacts");
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                //                cekbiru("memeriksa $eName:");
                if (array_key_exists($eName, $relElementConfigs)) {
                    //                    cekhijau("$eName memiliki relative impacts");
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    //                    cekmerah($currentValue);
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //                        cekhijau("memenuhi syarat");
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            //                            cekmerah("memeriksa $eName, $currentValue");
                            //                            $rcCtr = 0;
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                //                                $elKey = $eName . "_" . $currentValue . "_" . $rcID;
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                                //                                $rcCtr++;
                            }
                        }
                    }
                    else {
                        //                        cekmerah("TIDAK memenuhi syarat");
                    }
                }

                if (array_key_exists($eName, $relOptionConfigs)) {
                    //					cekhijau("$eName terdaftar pada relInputs");


                    if (isset($relOptionConfigs[$eName][$currentValue])) {
                        if (sizeof($relOptionConfigs[$eName][$currentValue]) > 0) {
                            foreach ($relOptionConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                $inputLabels[$oValueName] = $oValSpec['label'];
                            }
                        }
                    }
                    else {
                        //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                    }

                }
                else {
                    //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                }
            }
        }

        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        $itemLabels3 = $itemLabels3 + $itemNumLabels3 + array("subtotal" => "sub-amount");
        $itemSrcLabels = $itemSrcLabels + $itemSrcNumLabels + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$stepNumber] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
            unset($itemLabels3['subtotal']);
        }

        //region tambah additional rows tampil
        $addRowLabels = array();
        if (sizeof($elementConfigs) > 0) {
            foreach ($elementConfigs as $eName => $eSpec) {
                if (array_key_exists($eName, $addRowsConfigs)) {
                    switch ($elementConfigs[$eName]['elementType']) {
                        case "dataModel":
                            $currentValue = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : "";
                            break;
                        case "dataField":
                            $currentValue = $_SESSION[$cCode]['main_elements'][$eName]['value'];
                            break;
                    }
                    if (isset($addRowsConfigs[$eName][$currentValue])) {
                        if (sizeof($addRowsConfigs[$eName][$currentValue]) > 0) {

                            foreach ($addRowsConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                //                                cekhijau($oValueName);
                                //                                arrprint($oValSpec);
                                if (isset($oValSpec['addPoints']) && in_array(1, $oValSpec['addPoints'])) {
                                    if (!isset($oValSpec['hideRow'])) {
                                        $addRowLabels[$oValueName] = $oValSpec['label'];
                                    }


                                }

                            }

                        }
                    }
                    else {
                        //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        //                        cekmerah("aturan untuk $currentValue TIDAK ada");
                    }

                }
                else {
                    //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                }

            }
        }
        //endregion


        //endregion

        //arrPrint($addRowLabels);

        $pairedItemTarget = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName'] : "items2";

        //cekHitam($this->config->item("heTransaksi_ui")[$jenisTr]["template"]);

        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "itemLabels" => $itemLabels,
            "itemLabels2" => $itemLabels2,
            "itemLabels3" => $itemLabels3,
            "itemSrcLabels" => $itemSrcLabels,
            "noteEnabled" => $noteEnabled,
            "imageEnabled" => $imageEnabled,
            "main" => $main,
            "items" => $items,
            //            "items2" => $items2,
            "items2" => $$pairedItemTarget,
            "items3" => $items3_sum,
            "itemsSrc" => $itemsSrc,
            "buttonLabel" => $buttonLabel,
            "saveWarning" => $saveWarning,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$stepNumber],
            "sumRows" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][1]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][1] : $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1],
            "sumAddRows" => $addRowLabels,
            "sumRows3" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields3'][1]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields3'][1] : isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields3'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields3'][1] : array(),
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            //            "mainAddValues" => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
            "mainAddValues" => $mainAddValues,
            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            //            "mainApplets"    => isset($_SESSION[$cCode]['main_applets']) ? $_SESSION[$cCode]['main_applets'] : array(),
            "mainElements" => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
            "actionTarget" => base_url() . $this->uri->segment(1) . "/save/" . $this->uri->segment(3) . "?rawPrev=$rawPrevURL",
            "appletConfig" => $appletConfigs,
            "elementConfig" => $elementConfigs,
            "mainInputs" => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
            "grandTotal" => isset($_SESSION[$cCode]['main']['grand_total']) ? $_SESSION[$cCode]['main']['grand_total'] : 0,
            "headerRows" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptMainFields'][$stepNumber]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptMainFields'][$stepNumber] : array(),
            "description" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            "stepLabels" => $stepLabels,
            "currentStep" => 1,
            "pairedValue" => isset($_SESSION[$cCode]['pairs']) ? $_SESSION[$cCode]['pairs'] : array(),
        );

        if (isset($_SESSION[$cCode]['main'])) {
            $data['pihakID'] = isset($_SESSION[$cCode]['main']['pihakID']) ? $_SESSION[$cCode]['main']['pihakID'] : 0;
            $data['pihakName'] = isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : "";
        }

        //endregion

        $this->load->view("transaksi", $data);
    }

    public function swapFrom()
    {
        //                die("swapping................");

        $jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $needToClear = false;
        if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
            $needToClear = true;
        }
        if ($needToClear) {
            die(lgShowAlert("you must clear the selected list before selecting another entry"));
        }
        if (isset($_POST['trID']) && sizeof($_POST['trID']) > 0) {

            //            arrprint($_POST['trID']);
            //            foreach($_POST['trID'] as $trID){
            //
            //            }

            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi_id in ('" . implode("','", $_POST['trID']) . "')");
            $tr->addFilter("valid_qty>0");
            $tmpTr = $tr->lookupJoined()->result();
            //            cekKuning($this->db->last_query());
            if (sizeof($tmpTr) > 0) {
                $items = array();
                $trIDs = array();
                $lastTRID = 0;
                foreach ($tmpTr as $row) {
                    if (!array_key_exists($row->produk_id, $items)) {
                        $items[$row->produk_id] = 0;
                    }

                    if ($row->valid_qty > 0) {
                        $items[$row->produk_id] += $row->valid_qty;
                    }
                    else {
                        unset($items[$row->produk_id]);
                    }

                    if (!in_array($row->id_master, $trIDs)) {
                        $trIDs[] = $row->id_master;
                    }
                    $lastTRID = $row->transaksi_id;
                }
                //                arrprint($items);
                //                arrprint($trIDs);
                //                echo $lastTRID;

                //==ambil value-gate
                $trr = new MdlTransaksi();
                $trr->setFilters(array());
                $trr->addFilter("transaksi_id in ('" . implode("','", $_POST['trID']) . "')");
                $trr->addFilter("param='main'");
                $tmpReg = $trr->lookupRegistries()->result();
                //                cekHere($this->db->last_query());
                $swappedKeys = isset($this->config->item("heTransaksi_ui")[$jenisTr]['swappedKeys']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['swappedKeys'] : array();
                $allowMultiSelect = isset($this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['allowMultiSelect']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['requestCode']['allowMultiSelect'] : false;
                $oldMain = "";
                if (sizeof($tmpReg) > 0 && sizeof($swappedKeys) > 0) {
                    $oldMain = unserialize(base64_decode($tmpReg[0]->values));

                    foreach ($tmpReg as $rowr) {
                        foreach ($swappedKeys as $kr) {
                            $_SESSION[$cCode]['main'][$kr] = $oldMain[$kr];
                            echo "<script>";
                            echo "if(top.document.getElementById('$kr')){top.document.getElementById('$kr').value='" . $oldMain[$kr] . "'}";
                            echo "</script>";
                        }
                    }
                }

                $targetProc = base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]['itemSwapper'] . "/$jenisTr/?items=" . base64_encode(serialize($items)) . "&main=" . base64_encode(serialize($oldMain)) . "&trs=" . base64_encode(serialize($trIDs));
                $targetProc = base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]['itemSwapper'] . "/$jenisTr/?items=" . base64_encode(serialize($items)) . "&main=" . base64_encode(serialize($oldMain)) . "&trs=" . base64_encode(serialize($trIDs));
                $targetSuffix = $allowMultiSelect == true ? "" : "&singleRefID=$lastTRID";
                $targetProc .= $targetSuffix;
                //                                die($targetProc);
                echo "<script>";
                echo "top.$('#result').load('$targetProc');";
                echo "</script>";
            }

        }
        elseif (isset($_POST['prdID']) && sizeof($_POST['prdID']) > 0) {


            $origJenisTr = $this->uri->segment(3);
            $jenisTr = isset($this->config->item("heTransaksi_ui")[$origJenisTr]['aliasMainTrans']) ? $this->config->item("heTransaksi_ui")[$origJenisTr]['aliasMainTrans'] : $origJenisTr;
            $this->jenisTr = $jenisTr;
            $cCode = "_TR_" . $this->jenisTr;
            $cCodeOrig = "_TR_" . $origJenisTr;


            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("produk_id in ('" . implode("','", $_POST['prdID']) . "')");
            $tr->addFilter("next_substep_code='" . $this->jenisTr . "'");
            $tr->addFilter("valid_qty>0");
            $tmpTr = $tr->lookupJoined()->result();

            if (sizeof($tmpTr) > 0) {
                $items = array();
                $trIDs = array();
                $arrIDs = array();
                $lastTRID = 0;
                foreach ($tmpTr as $row) {
                    if (!array_key_exists($row->produk_id, $items)) {
                        $items[$row->produk_id] = 0;
                    }
                    $items[$row->produk_id] += $row->valid_qty;
                    if (!in_array($row->id_master, $trIDs)) {
                        $trIDs[] = $row->id_master;
                        $arrIDs[] = $row->transaksi_id;
                    }
                    $lastTRID = $row->transaksi_id;
                }
                //==ambil value-gate
                $trr = new MdlTransaksi();
                $trr->setFilters(array());
                $trr->addFilter("transaksi_id in ('" . implode("','", $arrIDs) . "')");
                $trr->addFilter("param='main'");
                $tmpReg = $trr->lookupRegistries()->result();

                $swappedKeys = isset($this->config->item("heTransaksi_ui")[$origJenisTr]['swappedKeys']) ? $this->config->item("heTransaksi_ui")[$origJenisTr]['swappedKeys'] : array();
                $allowMultiSelect = isset($this->config->item("heTransaksi_ui")[$origJenisTr]['requestCode']['allowMultiSelect']) ? $this->config->item("heTransaksi_ui")[$origJenisTr]['requestCode']['allowMultiSelect'] : false;
                $oldMain = "";
                if (sizeof($tmpReg) > 0 && sizeof($swappedKeys) > 0) {
                    $oldMain = unserialize(base64_decode($tmpReg[0]->values));
                    foreach ($tmpReg as $rowr) {
                        foreach ($swappedKeys as $kr) {

                            $_SESSION[$cCodeOrig]['main'][$kr] = $oldMain[$kr];
                            echo "<script>";
                            echo "if(top.document.getElementById('$kr')){top.document.getElementById('$kr').value='" . $oldMain[$kr] . "'}";
                            echo "</script>";
                        }
                    }
                }
                $targetProc = base_url() . $this->config->item("heTransaksi_ui")[$origJenisTr]['itemSwapper'] . "/$origJenisTr/?items=" . base64_encode(serialize($items)) . "&main=" . base64_encode(serialize($oldMain)) . "&trs=" . base64_encode(serialize($trIDs));
                //                $targetSuffix = $allowMultiSelect == true ? "" : "&singleRefID=$lastTRID";//ini dimatiin untuk akomodasi followup dari request conected selected prroduk biar tidak diupate Transaksi_releaser
                $targetSuffix = $allowMultiSelect == true ? "" : "";
                $targetProc .= $targetSuffix;
                echo "<script>";
                echo "top.$('#result').load('$targetProc');";
                echo "</script>";
            }

        }
        else {
            echo(lgShowAlert("please select at least one item"));
            echo "<script>";
            echo "top.fillBoxes();";
            //            echo "top.document.getElementById('btnConnect').disabled=false;";
            //            echo "top.document.getElementById('btnConnect').innerHTML='<span class=\'fa fa-external-link\'></span> followup selected entry';";
            echo "</script>";
            die();
        }


        $no = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;


    }

    public function selectPaymentExternSrc()
    {
        $targetJenis = $this->uri->segment(3);

        heInitCart($targetJenis);


        //==dapatkan srcJenis
        $paymentSources = null != ($this->config->item("payment_source")) ? $this->config->item("payment_source") : array();
        $readerDueDate = isset($this->config->item("heTransaksi_ui")[$targetJenis]['dueDateReader']) ? $this->config->item("heTransaksi_ui")[$targetJenis]['dueDateReader'] : false;

        if (sizeof($paymentSources) > 0) {
            foreach ($paymentSources as $src => $mainSpecs) {
                //                cekHere("$src");;
                if (sizeof($mainSpecs) > 0) {

                    foreach ($mainSpecs as $step => $sSpecTemp) {
                        //                        cekHere("$step");
                        //                        arrprint($sSpecTemp);
                        $sCtr = 0;
                        foreach ($sSpecTemp as $sSpec) {

                            //                            arrPrint($sSpec);
                            //                            cekHitam($src);
                            if (isset($sSpec['jenisTarget']) && $sSpec['jenisTarget'] == $targetJenis) {
                                $srcJenis = $sSpec['jenisSrc'];
                                $rawSrcJenis = $src;
                                $srcIndex = $sCtr;
                                $srcStep = $step;
                                //                            cekhijau($srcJenis . " memenuhi syarat");
                            }
                            else {
                                $srcJenis = isset($sSpec['jenisSrc']) ? $sSpec['jenisSrc'] : "";
                                $rawSrcJenis = "";
                                $step = "";
                                $srcIndex = "";
                                $srcStep = "";
                                //                            cekmerah($srcJenis . " TIDAK memenuhi syarat");
                            }
                        }
                        $sCtr++;

                    }
                }
            }
        }

        //        arrPrint($paymentSources[$rawSrcJenis][$srcStep][$srcIndex]);
        //cekHitam("$rawSrcJenis |$srcStep| $srcIndex");
        //        die();
        $defItemLabels = array(
            "extern_nama" => isset($paymentSources[$rawSrcJenis][$srcStep][$srcIndex]['externSrc']['extLabel']) ? $paymentSources[$rawSrcJenis][$srcStep][$srcIndex]['externSrc']['extLabel'] : "",
            //                "nomer"=>"receipt number",
            //                "fulldate"=>"date",
            "tagihan" => "due amount",
            "terbayar" => "paid",
            "diskon" => "discount",
            "sisa" => "due remain",
            "tagihan_valas" => "due amount",
            "terbayar_valas" => "paid",
            "diskon_valas" => "discount",
            "sisa_valas" => "due remain",
        );
        $itemLabels = (isset($this->config->item("heTransaksi_ui")[$targetJenis]["shoppingCartReferenceExternFields"])) ? $this->config->item("heTransaksi_ui")[$targetJenis]["shoppingCartReferenceExternFields"] : $defItemLabels;
        $itemLabels["due_date"] = "due date";
        $itemLabels["aging"] = "aging(days)";
        $itemLabels["over_due"] = "over due";

        //		die();
        //==dapatkan daftar kolom dari srcJenis
        //        $historyFields = $this->config->item("heTransaksi_ui")[$srcJenis]['shortHistoryFields'];

        $tr = new MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("transaksi_payment_source.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("sisa>0");
        $tmpSrc = $tr->lookupPaymentSrcByJenis($targetJenis)->result();
        //        cekHere($this->db->last_query());
        $tmpSrcDue = array();
        $dueEmployee = array();
        if ($readerDueDate) {
            $tr->setFilters(array());
            $tr->addFilter("status='1'");
            $tmpSrcDue = $tr->lookupAllDueDate()->result();
            $tempDataDues = array();
            $validDate = array();
            foreach ($tmpSrcDue as $tmpSrcDue_tmp) {
                $tempDataDues[$tmpSrcDue_tmp->customers_id][] = array(
                    "due_date" => $tmpSrcDue_tmp->due_date,
                    "aging_dtime" => $tmpSrcDue_tmp->dtime,
                );

            }
            //            arrPrint($tempDataDues);
            $dtime_now = strtotime(date("Y-m-d"));
            foreach ($tempDataDues as $cus_id => $tempDataDues_0) {
                $dueVal = array();
                $dtimeVal = array();
                foreach ($tempDataDues_0 as $dtime_val) {

                    $keyIndex = strtotime($dtime_val['due_date']);
                    $dueVal[] = $keyIndex;
                    $dtimeVal[$keyIndex] = array(
                        "due_date" => $dtime_val['due_date'],
                        "aging" => $dtime_val['aging_dtime'],
                    );

                }
                asort($dueVal);
                $key_index = $dueVal['0'];
                $date_due = $dtimeVal[$key_index]['due_date'];
                $aging = $dtimeVal[$key_index]['aging'];

                //cekHere("$date_due || $aging");
                if ($dtime_now > $key_index) {
                    $dueEmployee[$cus_id] = array(
                        "due_date" => formatField("dtime", $date_due),
                        "over_due" => umurDay($date_due) > 0 ? umurDay($date_due) : "0",
                        "aging" => umurDay($aging) > 0 ? umurDay($aging) : "0",
                    );
                }
            }


        }
        //matiHere();
        //cekHere($targetJenis);
        //        arrPrint($dueEmployee);
        $items = array();
        $externs = array();
        $tagihans = array();
        $terbayars = array();
        $sisas = array();
        $diskons = array();
        $tagihans_valas = array();
        $terbayars_valas = array();
        $sisas_valas = array();
        $diskons_valas = array();
        $srcLabel = "";
        if (sizeof($tmpSrc) > 0) {
            foreach ($tmpSrc as $row) {
                $tmp = array();
                //                foreach($historyFields as $fName=>$label){
                //                    $tmp[$fName]=$row->$fName;
                //                }
                $classMarking = "";
                if (isset($dueEmployee[$row->extern_id])) {
                    $classMarking = "bg-danger";
                    //                    cekHere($row->extern_nama);
                }

                if (!in_array($row->extern_id, $externs)) {
                    if (!isset($tagihans[$row->extern_id])) {
                        $tagihans[$row->extern_id] = 0;
                        $terbayars[$row->extern_id] = 0;
                        $diskons[$row->extern_id] = 0;
                        $sisas[$row->extern_id] = 0;
                        $tagihans_valas[$row->extern_id] = 0;
                        $terbayars_valas[$row->extern_id] = 0;
                        $sisas_valas[$row->extern_id] = 0;
                        $diskons_valas[$row->extern_id] = 0;

                    }

                    $tmp = (array)$row;
                    $tmp["link"] = base_url() . get_class($this) . "/selectPaymentSrc/$targetJenis/" . $row->extern_id;
                    $tmp["due_date"] = isset($dueEmployee[$row->extern_id]['due_date']) ? formatField("dtime", $dueEmployee[$row->extern_id]['due_date']) : "-";
                    $tmp["aging"] = isset($dueEmployee[$row->extern_id]['aging']) ? $dueEmployee[$row->extern_id]['aging'] : "-";
                    $tmp["over_due"] = isset($dueEmployee[$row->extern_id]['over_due']) ? $dueEmployee[$row->extern_id]['over_due'] : "-";
                    $tmp["class_marking"] = $classMarking;
                    //                    $tmp["class_marking"] = "bg-danger";
                    //                    $tmp["tagihan"] = $tagihans[$row->extern_id];
                    $items[$row->extern_id] = $tmp;
                    $externs[] = $row->extern_id;
                    $externName = $row->extern_nama;
                }
                $tagihans[$row->extern_id] += isset($row->tagihan) ? $row->tagihan : 0;
                $terbayars[$row->extern_id] += isset($row->terbayar) ? $row->terbayar : 0;
                $sisas[$row->extern_id] += isset($row->sisa) ? $row->sisa : 0;
                $diskons[$row->extern_id] += isset($row->diskon) ? $row->diskon : 0;
                $tagihans_valas[$row->extern_id] += isset($row->tagihan_valas) ? $row->tagihan_valas : 0;
                $terbayars_valas[$row->extern_id] += isset($row->terbayar_valas) ? $row->terbayar_valas : 0;
                $sisas_valas[$row->extern_id] += isset($row->sisa_valas) ? $row->sisa_valas : 0;
                $diskons_valas[$row->extern_id] += isset($row->diskon_valas) ? $row->diskon_valas : 0;
                $srcLabel = $row->label;
            }
            //            arrPrint($items);
            foreach ($items as $externID => $iSpec) {
                $items[$externID]['tagihan'] = $tagihans[$externID];
                $items[$externID]['terbayar'] = $terbayars[$externID];
                $items[$externID]['diskon'] = $diskons[$externID];
                $items[$externID]['sisa'] = $sisas[$externID];
                $items[$externID]['tagihan_valas'] = $tagihans_valas[$externID];
                $items[$externID]['terbayar_valas'] = $terbayars_valas[$externID];
                $items[$externID]['diskon_valas'] = $diskons_valas[$externID];
                $items[$externID]['sisa_valas'] = $sisas_valas[$externID];
            }
        }

        //        cekHitam("$srcStep||$srcIndex");
        //		cekkuning("rawSrcJenis: ".$rawSrcJenis);
        //        arrPrint($this->uri->segment_array());
        $data = array(
            "mode" => $this->uri->segment(2),
            //            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$targetJenis]["label"],
            "subTitle" => isset($paymentSources[$rawSrcJenis][$srcStep][$srcIndex]['externSrc']['extLabel']) ? "select " . $paymentSources[$rawSrcJenis][$srcStep][$srcIndex]['externSrc']['extLabel'] . "(s) listed below" : "",
            "items" => $items,
            "srcLabel" => $srcLabel,
            "itemLabels" => $itemLabels,
            "jenisTr" => $this->jenisTr,
            //            "dueDate"    =>$dueEmployee,
        );
        //        arrprint($data);

        if (!isset($_GET['json'])) {
            $this->load->view("transaksi", $data);
        }
        else {
            //            echo json_encode($data);

            //arrPrint($data);
        }


        //        die("selecting payment src...");
    }

    public function selectPaymentSrc()
    {
        if (!isset($this->session->login['id'])) {
            gotoLogin();
        }
        $externID = $this->uri->segment(4);
        $selectedTrID = $this->uri->segment(5);

        $scriptBottom = "";

        $jenisTr = $targetJenis = $this->jenisTr;
        $cCode = "_TR_" . $this->jenisTr;


        heInitCart($targetJenis);
        $this->load->helper("he_versi_history_old");

        $detailResetList = array(
            "items",
            //            "out_detail",
            //            "out_detail2",
            "tableIn_detail",
            "tableIn_detail2",
            "tableIn_detail_values",
            "tableIn_detail2_sum",
            "tableIn_detail_values2_sum",
        );
        foreach ($detailResetList as $sSName) {
            $_SESSION[$cCode][$sSName] = null;
            unset($_SESSION[$cCode][$sSName]);
        }


        if (!isset($_SESSION[$cCode])) {
            $_SESSION[$cCode] = array(
                "items" => array(),
                "main" => array(),

            );
        }
        if (!isset($_SESSION[$cCode]['main'])) {
            $_SESSION[$cCode]['main'] = array();
        }
        if (!isset($_SESSION[$cCode]['items'])) {
            $_SESSION[$cCode]['items'] = array();
        }


        //==dapatkan srcJenis
        $stepCode = $this->config->item("heTransaksi_ui")[$targetJenis]['steps'][1]['target'];
        $steps = $this->config->item("heTransaksi_ui")[$targetJenis]['steps'];
        $tagihanSrc = isset($this->config->item("heTransaksi_ui")[$targetJenis]['tagihanSrc']) ? $this->config->item("heTransaksi_ui")[$targetJenis]['tagihanSrc'] : "sisa";
        $paymentSources = null != ($this->config->item("payment_source")) ? $this->config->item("payment_source") : array();
        $returnRoutes = null != ($this->config->item("transaksi_returnRoutes")) ? $this->config->item("transaksi_returnRoutes") : array();
        $readerDueDate = isset($this->config->item("heTransaksi_ui")[$targetJenis]['dueDateReader']) ? $this->config->item("heTransaksi_ui")[$targetJenis]['dueDateReader'] : false;
        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
        $prePrint = isset($steps[1]['prePrint']) ? $steps[1]['prePrint'] : "";

        $ppnDisabledConfig = isset($this->config->item("heTransaksi_ui")[$targetJenis]['ppnDisabled']) ? $this->config->item("heTransaksi_ui")[$targetJenis]['ppnDisabled'] : array();
        $kelebihanBayarConfig = isset($this->config->item("heTransaksi_ui")[$targetJenis]['kelebihanBayar']) && ($this->config->item("heTransaksi_ui")[$targetJenis]['kelebihanBayar'] == true) ? true : false;
        $paymentSrcLocked = isset($this->config->item("heTransaksi_ui")[$targetJenis]['paymentSrcLocked']) ? $this->config->item("heTransaksi_ui")[$targetJenis]['paymentSrcLocked'] : array();

        $jenisSrc = null;


        if (sizeof($paymentSources) > 0) {
            foreach ($paymentSources as $src => $sSpec) {
                $payConfigs = $paymentSources[$src];
                if (sizeof($payConfigs) > 0) {
                    //                    $sCtr = 0;
                    foreach ($payConfigs as $paymentSrcConfigTmp) {
                        $sCtr = 0;
                        foreach ($paymentSrcConfigTmp as $paymentSrcConfig) {
                            if (isset($paymentSrcConfig['jenisTarget']) && $paymentSrcConfig['jenisTarget'] == $targetJenis) {
                                $srcJenis = $paymentSrcConfig['jenisSrc'];
                                $rawSrcJenis = $src;
                                $srcIndex = $sCtr;
                                $jenisSrc = $srcJenis;
                            }
                            $sCtr++;
                        }

                    }
                }
            }
        }

        $references = array();
        if ($jenisSrc != null) {
            if (isset($returnRoutes[$jenisSrc])) {
                $retCode = $returnRoutes[$jenisSrc];


                $trr = new MdlTransaksi();
                $trr->setFilters(array());
                $trr->addFilter("param='main'");
                $trr->addFilter("jenis='$retCode'");
                $tmpR = $trr->lookupRegistries_joined()->result();
                //cekHere($this->db->last_query());

                if (sizeof($tmpR) > 0) {
                    foreach ($tmpR as $row) {
                        $main = blobDecode($row->values);
                        //                        arrprint($main);
                        $references[$main['referenceID']] = array(
                            "id" => $row->transaksi_id,
                            "nomer" => $row->nomer,
                            "refID" => $main['referenceID'],
                            "refJenis" => $main['referenceJenis'],
                            "refNum" => $main['referenceNomer'],
                            "harga" => isset($main['harga']) ? $main['harga'] : 0,
                            "nett" => isset($main['nett']) ? $main['nett'] : 0,


                        );
                    }
                }
            }
        }


        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();


        //==dapatkan daftar kolom dari srcJenis
        $tr = new MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("transaksi_payment_source.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("extern_id='$externID'");
        $tr->addFilter("sisa>0.9");
        //        $tr->addFilter("sisa>0");

        if ($selectedTrID > 0) {
            $tr->addFilter("transaksi_id='$selectedTrID'");
        }
        $tmpSrc = $tr->lookupPaymentSrcByJenis_joined($targetJenis)->result();

        if ($readerDueDate) {
            $tr->setFilters(array());
            $tmpSrcDue = $tr->lookupAllDueDate()->result();
            //        arrPrint($tmpSrcDue);
            if (sizeof($tmpSrcDue) > 0) {
                foreach ($tmpSrcDue as $tmpSrccDue_0) {
                    $mainDueDate[$tmpSrccDue_0->transaksi_id] = $tmpSrccDue_0->due_date;
                }
            }
        }

        $externName = "";
        $items = array();
        $tempDueDate = array();
        $ppnDisabled = array();
        $paymentSrcDisabled = array();
        $lockerDisabled = array();
        $trIDs = array();
        if (sizeof($tmpSrc) > 0) {
            foreach ($tmpSrc as $row) {
                $tmp = array();

                $jenis = $row->jenis;
                $transaksi_id = $row->id;
                if ($readerDueDate) {
                    $tempDueDate = blobDecode($row->ids_prev);
                    $dueTime = array();
                    if (sizeof($tempDueDate) > 0) {
                        $time_due = array();
                        foreach ($tempDueDate as $k => $spdID) {
                            if (isset($mainDueDate[$spdID])) {
                                $time_due[] = strtotime($mainDueDate[$spdID]);
                                $dueTime[strtotime($mainDueDate[$spdID])] = $mainDueDate[$spdID];
                            }
                        }
                        asort($time_due);
                        $key_due = $time_due[0];
                    }
                    if ($key_due > 0) {
                        $date_now = strtotime(date("Y-m-d"));
                        $dateValid = strtotime($dueTime[$key_due]);
                        //                        cekHijau("$dateValid >$date_now");
                        if ($dateValid < $date_now) {
                            //                            cekHere("$dateValid >$date_now");
                            $tmp['class_bg'] = "bg-danger";
                        }
                        else {
                            $tmp['class_bg'] = "";
                        }
                    }
                    else {
                        $tmp['class_bg'] = "";
                    }

                    $tmp['due_date'] = isset($dueTime[$key_due]) ? formatField("dtime", $dueTime[$key_due]) : "-";
                    $tmp['aging'] = isset($dueTime[$key_due]) && umurDay($dueTime[$key_due]) > 0 ? umurDay($dueTime[$key_due]) : "0";
                }
                else {
                    $tmp['class_bg'] = "";
                }


                $tmp['refID'] = array_key_exists($row->transaksi_id, $references) ? $references[$row->transaksi_id]['refID'] : "";
                $tmp['refNum'] = array_key_exists($row->transaksi_id, $references) ? $references[$row->transaksi_id]['refNum'] : "";
                $tmp['refValue'] = array_key_exists($row->transaksi_id, $references) ? $references[$row->transaksi_id]['nett'] : "";

                if (strlen($prePrint) > 10) {
                    $linkPrint = base_url() . "$prePrint/$jenis/$transaksi_id";
                    $tmp['prePrint'] = "<button type='button' class='btn btn-link' onclick=\"window.open('$linkPrint')\"><i class='fa fa-print'></i></button>";
                }

                if (isset($ppnDisabledConfig['enabled']) && $ppnDisabledConfig['enabled'] == true) {
                    //                    if (($row->ppn_sisa > 0) && ($row->ppn_status == 1)) {
                    if (($row->ppn_status == 1)) {
                        $ppnDisabled[] = $row->transaksi_id;
                        $tmp['notes'] = isset($ppnDisabledConfig['notes']) ? "<span style='color:red;font-size:10px;'>" . $ppnDisabledConfig['notes'] . "</span>" : "-";
                    }
                }
                if (isset($paymentSrcLocked['enabled']) && ($paymentSrcLocked['enabled'] == true)) {
                    if ($row->payment_locked == 1) {
                        $paymentSrcDisabled[] = $row->transaksi_id;
                        $tmp['notes'] = isset($paymentSrcLocked['notes']) ? "<span style='color:red;font-size:10px;'>" . $paymentSrcLocked['notes'] . "</span>" : "-";
                    }
                }

                $items[] = (array)$row + $tmp;
                $externName = $row->extern_nama;

                $trIDs[] = $row->transaksi_id;
            }

            //            if (sizeof($trIDs) > 0) {
            //                $this->load->model("Mdls/MdlLockerTransaksi");
            //                $lt = New MdlLockerTransaksi();
            //                $lt->addFilter("transaksi_id in ('" . implode("','", $trIDs) . "')");
            //                $lt->addFilter("state='active'");
            //                $lt->addFilter("jumlah='0'");
            //                $lt_tmp = $lt->lookupAll()->result();
            //                if (sizeof($lt_tmp) > 0) {
            //                    foreach ($lt_tmp as $lt_row) {
            //                        $lockerDisabled[] = $lt_row->transaksi_id;
            //                    }
            //                }
            //            }

        }

        $cCode = "_TR_" . $targetJenis;

        $defaultItemLabels = array(
            "extern_label2" => "jenis",
            "nomer" => "receipt number",
            "nomer_top" => "receipt ref.",
            "refNum" => "return ref.",
            "fulldate" => "date",
            "tagihan" => "due amount",
            "refValue" => "returned",
            "terbayar" => "paid",
            "diskon" => "discount",
            "sisa" => "due remain",
        );

        $jQueryCustom = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['jQueryCustom']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['jQueryCustom'] : "";

        if (sizeof($jQueryCustom) > 0) {
            $scriptBottom .= $jQueryCustom;
        }


        $defSisa = isset($_SESSION[$cCode]['main']['sisa']) ? $_SESSION[$cCode]['main']['sisa'] : 0;
        $data = array(
            "mode" => $this->uri->segment(2),
            "title" => $this->config->item("heTransaksi_ui")[$targetJenis]["label"],
            "subTitle" => $externName,
            "jenisTr" => $targetJenis,
            "items" => $items,
            "prePrint" => $prePrint,
            "itemLabels" => isset($this->config->item('heTransaksi_ui')[$targetJenis]["shoppingCartReferenceFields"]) ? $this->config->item('heTransaksi_ui')[$targetJenis]["shoppingCartReferenceFields"] : $defaultItemLabels,
            "selectProcessor" => $this->config->item("heTransaksi_ui")[$targetJenis]["selectorProcessor"],
            "paymentSubtitle" => "details for " . $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'],
            "btnLabel" => "continue " . $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'],
            "ses_outMaster" => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
            "ses_items" => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),

            "actionTarget" => "top.$('#result').load('" . base_url() . "Transaksi/validate/" . $targetJenis . "?rawPrev=$rawPrevURL');",
            "columnRecorderTarget" => base_url() . "ValueGate/recordColumn/" . $this->jenisTr . "/nilai_entry",
            "bankColumnRecorderTarget" => base_url() . "ValueGate/recordColumn/" . $this->jenisTr . "/paymentMethod_cash",

            "selectedBankID" => isset($_SESSION[$cCode]['main']['cash_account']) ? $_SESSION[$cCode]['main']['cash_account'] : 0,
            "dueDateReader" => $readerDueDate,
            "tagihanSrc" => $tagihanSrc,
            "scriptBottom" => $scriptBottom,
            "tagihanValue" => isset($_SESSION[$cCode]['main'][$tagihanSrc]) ? $_SESSION[$cCode]['main'][$tagihanSrc] : $defSisa,
            "isPaymentRadioSelect" => isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['isPaymentRadioSelect']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['isPaymentRadioSelect'] : false,
            "kelebihanBayar" => $kelebihanBayarConfig,
            "ppnDisabled" => $ppnDisabled,
            "lockerDisabled" => isset($lockerDisabled) ? $lockerDisabled : array(),
            "paymentSrcDisabled" => isset($paymentSrcDisabled) ? $paymentSrcDisabled : array(),

        );

        if (!isset($_GET['json'])) {
            $this->load->view("transaksi", $data);
        }
        else {
            return json_encode($data);
        }

        //        die("selecting payment src...");
    }

    // ------------------------------------------------------------

    public function doRevert()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $transaksiID_reference = $no = $this->uri->segment(3);
        $jenisTr_con = $jenisTr = $this->uri->segment(4);
        $masterTargetStepNum_con = $masterTargetStepNum = $this->uri->segment(5);
        $childTargetStepNum_con = $childTargetStepNum = $this->uri->segment(6);
        $stepNumCurrent_son = $stepNumCurrent = $this->uri->segment(7);
        $cCode = "_TR_" . $jenisTr;

        $rejectException = $this->config->item('heTransaksi_rejectException') != NULL ? $this->config->item('heTransaksi_rejectException') : array();
        $referenceRevertConfigs = $this->config->item('heTransaksi_ui')[$jenisTr]['referenceRevert'] ? $this->config->item('heTransaksi_ui')[$jenisTr]['referenceRevert'] : array();
        $prepConfigs = null != $this->config->item('hePreProcessors') ? $this->config->item('hePreProcessors') : array();
        $postConfigs = null != $this->config->item('hePostProcessors') ? $this->config->item('hePostProcessors') : array();

        //region swap from registry, transaksi yang dibuka saat ini
        $tr = new MdlTransaksi();
        $tmpReg = $tr->lookupRegistriesByMasterID($no)->result();
        cekmerah($this->db->last_query());
        if (sizeof($tmpReg) > 0) {
            foreach ($tmpReg as $row) {
                $var = $row->param;
                $$var = unserialize(base64_decode($row->values));
            }
        }
        //endregion

        //region swap from main transaksi, transaksi yang dibuka saat ini
        $tr = new MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("id='$no'");
        $tmpTr = $tr->lookupMainTransaksi()->result();
        cekOrange($this->db->last_query());
        $insertID = $tmpTr[0]->id;
        $insertNum = $tmpTr[0]->nomer;
        $thisStepNumber = $tmpTr[0]->step_number;
        //endregion


        echo "no saat ini : $no<br>";
        echo "no reference : " . $tmpTr[0]->id_top . "<br>";
        echo "masterTargetStepNum: $masterTargetStepNum<br>";
        echo "childTargetStepNum: $childTargetStepNum<br>";
        echo "stepNumCurrent: $stepNumCurrent<br>";


        $this->db->trans_start();
        //
        // jika ada connecting antar-cabang...
        cekHitam("jenisTr -> $jenisTr");
        cekhitam("checking dulu connecting antar cabang... (connecto transaksi_ui)");
        $connector = isset($this->config->item("heTransaksi_ui")[$jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['connectTo'] : "";
        $mongListUpadte = array();
        $mongoList = array();
        if (strlen($connector) > 0) {
            cekUngu(":: ADA CONNECTING :: connector-> $connector ::");
            cekBiru("bila ada normal, yang membatalkan pihak source/sumber/asal...");


            //region update step2an di masternya
            $nextMasterStep = $stepNumCurrent;
            $nextProp = array(
                "num" => $nextMasterStep,
                "code" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'] : "",
                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'] : "",
                "groupID" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'] : "",
            );
            echo "nextMasterStep: $nextMasterStep<br>";
            arrPrint($nextProp);

            //update masternya, transaksi TOP
            if ($tmpTr[0]->id_top != $no) {
                $arrData = array(
                    "next_step_code" => $nextProp['code'],
                    "next_step_label" => $nextProp['label'],
                    "next_group_code" => $nextProp['groupID'],
                    "next_step_num" => $nextProp['num'],
                    "step_current" => $masterTargetStepNum,
                    "step_number" => $masterTargetStepNum,
                );
                $arrData_detail = array(
                    "next_substep_code" => $nextProp['code'],
                    "next_substep_label" => $nextProp['label'],
                    "next_subgroup_code" => $nextProp['groupID'],
                    "next_substep_num" => $nextProp['num'],
                    "sub_step_current" => $masterTargetStepNum,
                    "sub_step_number" => $masterTargetStepNum,
                    //                "valid_qty" => $new_valid_qty,
                );
            }
            else {
                $arrData = array(
                    "next_step_code" => $nextProp['code'],
                    "next_step_label" => $nextProp['label'],
                    "next_group_code" => $nextProp['groupID'],
                    "next_step_num" => $nextProp['num'],
                    "step_current" => $masterTargetStepNum,
                    "step_number" => $childTargetStepNum,
                    "trash_4" => "1",
                    "cancel_dtime" => date("Y-m-d H:i:s"),
                    "cancel_name" => $this->session->login['id'],
                    "cancel_id" => $this->session->login['nama'],
                );
                $arrData_detail = array(
                    "next_substep_code" => $nextProp['code'],
                    "next_substep_label" => $nextProp['label'],
                    "next_subgroup_code" => $nextProp['groupID'],
                    "next_substep_num" => $nextProp['num'],
                    //            "sub_step_current" => 0,
                    "sub_step_number" => 0,
                );
            }
            $tr = new MdlTransaksi();
            $dupState = $tr->updateData(array(
                //                "id" => $no,
                "id" => $tmpTr[0]->id_top,
            ), $arrData) or die("Failed to update tr next-state!");

            $mongListUpadte['update']['main'][] = array(
                "where" => array(
                    "id" => $tmpTr[0]->id_top,
                ),
                "value" => $arrData,
            );
            cekHijau("UPDATE transaksi step sebelumnya...");
            cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
            //endregion

            //region update step transaksi 1 step sebelumnya (detail)
            if (sizeof($tmpTr) > 0) {
                $arrPrevID = $tmpTr[0]->ids_prev != null ? blobDecode($tmpTr[0]->ids_prev) : array($tmpTr[0]->id_top);
                arrPrint($arrPrevID);
                foreach ($arrPrevID as $prevID) {
                    $tb = new MdlTransaksi();
                    $tb->setFilters(array());
                    $dupState = $tb->updateData(array(
                        "id" => $prevID,
                    ), array(
                        "status_4" => "11",
                    )) or die("Failed to update tr next-state!");

                    $mongListUpadte['update']['main'][] = array(
                        "where" => array(
                            "id" => $prevID,
                        ),
                        "value" => array("status_4" => "11",),
                    );
                    cekKuning("UPDATE transaksi 1 step sebelumnya...");
                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");


                    $td = new MdlTransaksi();
                    $td->setFilters(array());
                    $rslt = $td->lookupJoinedByID($prevID)->result();
                    if (sizeof($rslt) > 0) {
                        foreach ($rslt as $rsltSpec) {
                            if (array_key_exists($rsltSpec->produk_id, $items)) {
                                $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");

                                if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                    $new_valid_qty = $rsltSpec->valid_qty;
                                    //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                }
                                else {
                                    $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                }
                                //                            cekHitam("ROLLBACK... :: valid_qty-> " . $rsltSpec->valid_qty . " :: kembali-> " . $items[$rsltSpec->produk_id]['qty'] . " :: " . $new_valid_qty);

                                $arrData_detail["valid_qty"] = $new_valid_qty;
                                $tr = new MdlTransaksi();
                                $tr->setFilters(array());
                                $tr->setTableName($tr->getTableNames()['detail']);
                                $dupState = $tr->updateData(array(
                                    "transaksi_id" => $prevID,
                                    "produk_id" => $rsltSpec->produk_id,
                                ), $arrData_detail) or die("Failed to update tr next-state!");
                                $mongListUpadte['update']['detail'][] = array(
                                    "where" => array(
                                        "transaksi_id" => $prevID,
                                        "produk_id" => $rsltSpec->produk_id,
                                    ),
                                    "value" => $arrData_detail,
                                );
                                cekKuning("UPDATE transaksi data...");
                                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                            }
                        }
                    }

                }
            }
            //endregion

            //region update step yang sebelumnya aktif, transaksi yang dibuka sekarang
            // cekUngu($tmpTr[0]->id_top);
            // cekUngu("$no");
            // if ($tmpTr[0]->id_top != $no) {
            $tp = new MdlTransaksi();
            $dupState = $tp->updateData(array(
                "id" => $no,
                "step_number" => $stepNumCurrent,
            ), array(
                "step_number" => $childTargetStepNum,
                "trash_4" => "1",
                "cancel_dtime" => date("Y-m-d H:i:s"),
                "cancel_name" => $this->session->login['nama'],
                "cancel_id" => $this->session->login['id'],

            )) or die("Failed to update tr next-state!");
            $mongListUpadte['update']['main'][] = array(
                "where" => array(
                    "id" => $no,
                    "step_number" => $stepNumCurrent,
                ),
                "value" => array(
                    "step_number" => $childTargetStepNum,
                    "trash_4" => "1",
                    "cancel_dtime" => date("Y-m-d H:i:s"),
                    "cancel_name" => $this->session->login['nama'],
                    "cancel_id" => $this->session->login['id']),
            );
            cekLime("UPDATE transaksi ini... yang dibuka sekarang...");
            cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

            $to = new MdlTransaksi();
            $to->setFilters(array());
            $to->setTableName($to->getTableNames()['detail']);
            $dupState = $to->updateData(array(
                "transaksi_id" => $no,
            ), array(
                "next_substep_code" => $nextProp['code'],
                "next_substep_label" => $nextProp['label'],
                "next_subgroup_code" => $nextProp['groupID'],
                "next_substep_num" => $nextProp['num'],
                //            "sub_step_current" => 0,
                "sub_step_number" => 0,
            )) or die("Failed to update tr next-state!");
            $mongListUpadte['update']['main'][] = array(
                "where" => array(
                    "transaksi_id" => $no,
                ),
                "value" => array(
                    "next_substep_code" => $nextProp['code'],
                    "next_substep_label" => $nextProp['label'],
                    "next_subgroup_code" => $nextProp['groupID'],
                    "next_substep_num" => $nextProp['num'],
                    //            "sub_step_current" => 0,
                    "sub_step_number" => 0,
                ),
            );
            cekLime("UPDATE transaksi data...");
            cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
            // }
            //endregion

            //region sesuaikan signature untuk cloningan, ikut minus
            //        $dwsign = $tr->writeSignature($no, array(
            $dwsign = $tr->writeSignature($tmpTr[0]->id_top, array(
                "prev_id" => $no,
                "nomer" => "rejection",
                "step_number" => $childTargetStepNum, // ini minus step number
                "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['target'],
                "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'],
                "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['userGroup'],
                "oleh_id" => $this->session->login['id'],
                "oleh_nama" => $this->session->login['nama'],
                "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
                //            "transaksi_id" => $no,
            )) or die("Failed to write signature");
            $mongoList['sign'][] = $dwsign;
            cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
            //endregion

            // region netralisasi payment source
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("sisa>0");
            $paymentSrc = $tr->lookupPaymentSrcByTransID($no)->result();
            cekBiru($this->db->last_query());
            if (sizeof($paymentSrc) > 0) {
                //            arrPrint($paymentSrc);
                foreach ($paymentSrc as $pSpec) {
                    if ($pSpec->terbayar == 0) {
                        $where = array(
                            "id" => $pSpec->id,
                            "transaksi_id" => $pSpec->transaksi_id,
                        );
                        $data = array(
                            "sisa" => 0,
                            "returned" => $pSpec->sisa,
                            "sisa_valas" => 0,
                            "returned_valas" => $pSpec->sisa_valas,
                        );

                        $tra = New MdlTransaksi();
                        $tra->setFilters(array());
                        $tra->updatePaymentSrc($where, $data);
                        cekUngu(":: mereject payment source bila ada...");
                        cekUngu($this->db->last_query());
                    }
                    else {
                        mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                    }
                }
            }
            else {
                cekBiru(":: tidak ada payment source... ::");
            }
            // endregion netralisasi payment source

            // region netralisasi extended step
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $exTmp = $tr->lookupExtStepByTrID($no);
            if (sizeof($exTmp) > 0) {
                foreach ($exTmp as $exSpec) {

                    $tra = New MdlTransaksi();
                    $tra->setFilters(array());
                    $tra->rejectExtStepByID($exSpec['id']);
                    $mongListUpadte['update']['extra'][] = array(
                        "where" => array(
                            "id" => $exSpec['id'],
                        ),
                        "value" => array(
                            "state" => "-1",
                        ),
                    );
                    cekUngu(":: mereject extended step bila ada...");
                    cekUngu($this->db->last_query());
                }
            }
            else {
                cekBiru(":: tidak ada extended step... ::");
            }

            // endregion netralisasi extended step

            //==entry point
            if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                $tableIn_master['trash_4'] = 1;
                $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                $tableIn_master['cancel_name'] = $this->session->login['nama'];
                $tableIn_master['cancel_id'] = $this->session->login['id'];
                $tableIn_master['deskripsi'] = "rejection";
                $epID = $tr->writeMainEntries_entryPoint($no, $tableIn_master['id_master'], $tableIn_master);
                $mongoList['main'][] = $epID;

                if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                    $insertIDs = array();
                    foreach ($tableIn_detail as $dSpec) {
                        if ($epID != 999) {
                            $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                            $mongoList['detail'] = $insertIDs;
                        }
                    }
                }
            }

            //===if rollback is needed
            //rollback preproc, master
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'])) {
                //            cekbiru("ada config pre-proc master $stepNumCurrent");
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'] : array();
                //            arrprint($iterator);
                if (sizeof($iterator) > 0) {
                    $it = 0;
                    cekbiru("ada iterator pre-proc master");
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $it++;
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'] . "_reverse";
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        echo "reverse master-preproc: $comName, initializing values <br>";
                        $tmpOutParams[$cCtr] = array();


                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                $subParams['static'][$key] = $realValue;

                            }

                            if (array_key_exists($oriComName, $prepConfigs)) {
                                if (sizeof($prepConfigs[$oriComName]) > 0) {
                                    foreach ($prepConfigs[$oriComName] as $key => $src) {
                                        $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                    }
                                }
                            }

                            if (!isset($subParams['static']["transaksi_id"])) {
                                $subParams['static']["transaksi_id"] = $no;
                            }


                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                        }
                        if (sizeof($subParams) > 0) {
                            $tmpOutParams[$cCtr] = $subParams;
                        }


                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);


                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            arrprint($tmpOutParams[$cCtr]);
                            $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();


                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }

                    }
                }
            }
            else {
                cekbiru("TIDAK ada config pre-proc master $jenisTr :: $stepNumCurrent");
            }
            //rollback preproc, detail
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'])) {
                //            cekbiru("ada config pre-proc detail $stepNumCurrent");
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'] : array();
                //            arrprint($iterator);
                if (sizeof($iterator) > 0) {
                    $it = 0;
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $it++;
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'] . "_reverse";
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        echo "reverse preproc (detail): $comName, initializing values <br>";
                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            //                        $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (array_key_exists($oriComName, $prepConfigs)) {
                                    cekhitam("terdapat di dalam prepConfig");
                                    if (sizeof($prepConfigs[$oriComName]) > 0) {
                                        foreach ($prepConfigs[$oriComName] as $key => $src) {
                                            $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                        }
                                    }
                                }
                                else {
                                    cekhitam("TIDAK terdapat di dalam prepConfig");
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $no;
                                }


                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "rollingback " . $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                            }

                            if (sizeof($subParams) > 0) {

                                $tmpOutParams[$cCtr][] = $subParams;
                            }


                            $comName = $tComSpec['comName'] . "_reverse";
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                            echo "sub preproc #$it: $comName, sending values <br>";

                            $mdlName = "Pre" . ucfirst($comName);
                            $this->load->model("Preprocs/" . $mdlName);
                            $m = new $mdlName($resultParams);


                            if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                $tobeExecuted = true;
                            }
                            else {
                                $tobeExecuted = false;
                            }

                            if ($tobeExecuted) {

                                //                            arrprint($tmpOutParams[$cCtr]);

                                $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                $gotParams = $m->exec();

                                //                            cekbiru("gotparams");
                                //                            arrprint($gotParams);

                            }
                            else {
                                cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                            }

                        }
                    }
                }
            }
            else {
                cekbiru("TIDAK ada config pre-proc detail $jenisTr :: $stepNumCurrent");
            }
            //rollback postproc, master
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'])) {
                //            cekbiru("ada config pre-proc master $stepNumCurrent");
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'] : array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        echo "rollback main post-processor: $comName<br>";

                        $dSpec = $_SESSION[$cCode][$srcGateName];
                        $tmpOutParams = array();
                        if (isset($tComSpec['loop'])) {
                            foreach ($tComSpec['loop'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                $tmpOutParams['loop'][$key] = $realValue;

                            }
                        }
                        if (isset($tComSpec['static'])) {
                            //cekHere("DISINI OIII");
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                $tmpOutParams['static'][$key] = $realValue;

                            }
                            if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                $tmpOutParams['static']["transaksi_id"] = $insertID;
                            }
                            if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                $tmpOutParams['static']["transaksi_no"] = $insertNum;
                            }

                            $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                            $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];


                        }
                        if (isset($tComSpec['static2'])) {
                            //cekHere("DISINI OIII");
                            foreach ($tComSpec['static2'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                                $tmpOutParams['static2'][$key] = $realValue;

                            }
                            if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                                $tmpOutParams['static2']["transaksi_id"] = $insertID;
                            }
                            if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                                $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                            }

                            $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                            $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                            $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                        }


                        if (array_key_exists($oriComName, $postConfigs)) {
                            if (sizeof($postConfigs[$oriComName]) > 0) {
                                foreach ($postConfigs[$oriComName] as $key) {
                                    $oldVal = isset($tmpOutParams['static'][$key]) ? $tmpOutParams['static'][$key] : 0;
                                    cekbiru("oldVal: $oldVal");
                                    $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                    cekHijau("newVal: $newVal");
                                    //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                    $tmpOutParams['static'][$key] = $newVal;
                                }
                            }
                        }

                        //lgShowError("Ada kesalahan",);
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();

                        cekBiru("kiriman rollback main-postproc $comName");
                        arrPrint($tmpOutParams);
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                    }
                }
            }
            else {
                cekbiru("TIDAK ada config post-proc master $jenisTr :: $stepNumCurrent");
            }
            //rollback postproc, detail
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'])) {

                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'] : array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        echo "rollback sub-postProcessor: $comName, initializing values <br>";
                        //                arrPrint($_SESSION[$cCode][$srcGateName]);
                        $tmpOutParams[$cCtr] = array();
                        foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                    $subParams['loop'][$key] = $realValue;

                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                    $subParams['static'][$key] = $realValue;
                                    //                                cekBiru("$key diisi dengan $realValue");

                                }

                                if (array_key_exists($oriComName, $postConfigs)) {
                                    //                                cekhitam("terdapat di dalam postConfig");
                                    if (sizeof($postConfigs[$oriComName]) > 0) {
                                        foreach ($postConfigs[$oriComName] as $key) {
                                            //                                        $replVal=makeValue($src,$_SESSION[$cCode][$srcGateName][$cnt],$_SESSION[$cCode][$srcGateName][$cnt],0);
                                            //                                        cekbiru("$key akan direplace dengan nilai $replVal");
                                            //                                        $subParams['static'][$key]=$replVal;

                                            $oldVal = isset($subParams['static'][$key]) ? $subParams['static'][$key] : 0;
                                            cekbiru("oldVal2: $oldVal");
                                            $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                            cekHijau("newVal2: $newVal");
                                            $subParams['static'][$key] = $newVal;
                                            //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                            //                                        $tmpOutParams['static'][$key]=$newVal;
                                        }
                                    }
                                }
                                else {
                                    //                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                }

                                //                            $subParams['static']["transaksi_id"] = $insertID;
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $no;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $no;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "rollback of $no";
                            }


                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }

                    foreach ($iterator as $cCtr => $tComSpec) {
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        echo "sub-postProcessor: $comName, sending values <br>";

                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();


                        cekBiru("kiriman rollback detail-postproc $comName");
                        arrPrint($tmpOutParams[$cCtr]);
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                }
            }
            else {
                cekbiru("TIDAK ada config post-proc detail $jenisTr :: $stepNumCurrent");
            }


            //region cancel transaksi yang stanby di pihak ke-2
            $tb = new MdlTransaksi();
            $tb->setFilters(array());
            $tb->addFilter("id_master='" . $tmpTr[0]->id_master . "'");
            $tb->addFilter("jenis_master='$connector'");
            $trTmp = $tb->lookupAll()->result();
            if (sizeof($trTmp) > 0) {

                $connectorID = $trTmp[0]->id;
                if ($connectorID > 0) {

                    $tb = new MdlTransaksi();
                    $tb->setFilters(array());
                    $dupState = $tb->updateData(array(
                        "id" => $connectorID,
                    ), array(
                        "status_4" => "11",
                        "trash_4" => "1",
                        "cancel_dtime" => date("Y-m-d H:i:s"),
                        "cancel_name" => $this->session->login['nama'],
                        "cancel_id" => $this->session->login['id'],

                    )) or die("Failed to update tr next-state!");
                    $mongListUpadte['update']['main'][] = array(
                        "where" => array(
                            "id" => $connectorID,
                        ),
                        "value" => array(
                            "status_4" => "11",
                            "trash_4" => "1",
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                            "cancel_name" => $this->session->login['nama'],
                            "cancel_id" => $this->session->login['id'],
                        ),
                    );
                    cekHitam("UPDATE transaksi connector -- selanjutnya yang digenerate by system");
                    cekHitam($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                    $to = new MdlTransaksi();
                    $to->setFilters(array());
                    $to->setTableName($to->getTableNames()['detail']);
                    $dupState = $to->updateData(array(
                        "transaksi_id" => $connectorID,
                    ), array(
                        "next_substep_code" => "",
                        "next_substep_label" => "",
                        "next_subgroup_code" => "",
                        "next_substep_num" => 0,
                        //            "sub_step_current" => 0,
                        "sub_step_number" => 0,
                    )) or die("Failed to update tr next-state!");
                    $mongListUpadte['update']['detail'][] = array(
                        "where" => array(
                            "transaksi_id" => $connectorID,
                        ),
                        "value" => array(
                            "next_substep_code" => "",
                            "next_substep_label" => "",
                            "next_subgroup_code" => "",
                            "next_substep_num" => 0,
                            //            "sub_step_current" => 0,
                            "sub_step_number" => 0,
                        ),
                    );
                    cekHitam("UPDATE transaksi data connector -- selanjutnya yang digenerate by system");
                    cekHitam($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                }
            }
            //endregion

        }
        else {
            cekUngu(":: CHECK CONNECTING MUNDUR :: $jenisTr ::");
//mati_disini("cek konekting mundur...");
            $origTCode = heGetOriginTCode_orig($jenisTr); // mencari transaksi yang connecto 110
            cekMerah("origTCode: $origTCode");
            if (strlen($origTCode) > 2) {
                cekMerah("origTCode: $origTCode, ADA CONNECTING MUNDUR...");
                cekBiru("bila tidak normal, yang membatalkan pihak target/tujuan...");
                cekBiru("dan ada connecting ke belakang...");

                cekKuning("[$origTCode] step transaksi ini " . $thisStepNumber);
//mati_disini(__LINE__);
                if ($thisStepNumber == 1) {

                    //region transaksi connector -> 583 / 759
                    $arrSteps = isset($this->config->item("heTransaksi_ui")[$origTCode]['steps']) ? $this->config->item("heTransaksi_ui")[$origTCode]['steps'] : "";
                    $lastCode = $origTCode;
                    if (sizeof($arrSteps) > 0) {
                        foreach ($arrSteps as $stSpec) {
                            $lastCode = $stSpec['target'];
                        }
                    }
                    if (sizeof($rejectException) > 0 && (!in_array($lastCode, $rejectException['code']))) {
                        $tb = new MdlTransaksi();
                        $tb->setFilters(array());
                        $tb->addFilter("id_master='" . $tmpTr[0]->id_master . "'");
                        $tb->addFilter("jenis_master='$origTCode'");
                        $tb->addFilter("jenis='$lastCode'");
                        $tb->setSortBy(array("kolom" => "id", "mode" => "DESC"));
                        $trTmp = $tb->lookupAll()->result();
                    }
                    else {
                        $trTmp = array();
                    }
                    cekHere($this->db->last_query() . " --> [" . count($trTmp) . "]");

                    if (sizeof($trTmp) > 0) {
                        cekHere(":: BENER BENER CONNECTING ANTAR INSTANSI - PUSAT -> CABANG ::");

                        $jenisTr = $origTCode;
                        $stepNumCurrent = $trTmp[0]->step_number;

                        cekHere("jenisTR $jenisTr, idTR " . $trTmp[0]->id);


                        //region swap from registry
                        $tr = new MdlTransaksi();
                        $tmpReg = $tr->lookupRegistriesByMasterID($trTmp[0]->id)->result();
                        cekmerah($this->db->last_query());
                        if (sizeof($tmpReg) > 0) {
                            foreach ($tmpReg as $row) {
                                $var = $row->param;
                                $$var = unserialize(base64_decode($row->values));
                            }
                        }
                        //        arrPrint($items);
                        //endregion

                        $nextMasterStep = $stepNumCurrent;
                        $nextProp = array(
                            "num" => $nextMasterStep,
                            "code" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'] : "",
                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'] : "",
                            "groupID" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'] : "",
                        );
                        echo __LINE__ . " :: nextMasterStep: $nextMasterStep<br>";
                        arrPrint($nextProp);

                        $arrData = array(
                            "next_step_code" => $nextProp['code'],
                            "next_step_label" => $nextProp['label'],
                            "next_group_code" => $nextProp['groupID'],
                            "next_step_num" => $nextProp['num'],
                            "step_current" => $masterTargetStepNum,
                            "step_number" => $childTargetStepNum,
                            "trash_4" => "1",
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                            "cancel_name" => $this->session->login['nama'],
                            "cancel_id" => $this->session->login['id'],
                        );
                        $arrData_detail = array(
                            "next_substep_code" => $nextProp['code'],
                            "next_substep_label" => $nextProp['label'],
                            "next_subgroup_code" => $nextProp['groupID'],
                            "next_substep_num" => $nextProp['num'],
                            //            "sub_step_current" => 0,
                            "sub_step_number" => 0,
                        );

                        //region update step transaksi connector dan TOP-nya
                        if (sizeof($trTmp) > 0) {
                            cekUngu(":: trID -> " . $trTmp[0]->id);

                            //region update transaksi connector-nya
                            $prevID = $trTmp[0]->id;
                            $tc = new MdlTransaksi();
                            $tc->setFilters(array());
                            $dupState = $tc->updateData(array(
                                "id" => $prevID,
                            ), $arrData) or die("Failed to update tr next-state!");
                            cekKuning("UPDATE transaksi connector...");
                            cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                            $mongListUpadte['update']['main'][] = array(
                                "where" => array(
                                    "id" => $prevID,
                                ),
                                "value" => $arrData,
                            );
                            $td = new MdlTransaksi();
                            $td->setFilters(array());
                            $rslt = $td->lookupJoinedByID($prevID)->result();
                            if (sizeof($rslt) > 0) {
                                foreach ($rslt as $rsltSpec) {
                                    if (array_key_exists($rsltSpec->produk_id, $items)) {
                                        $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];

                                        if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                            $new_valid_qty = $rsltSpec->valid_qty;
                                            //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                        }
                                        else {
                                            $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                        }


                                        $arrData_detail["valid_qty"] = $new_valid_qty;
                                        $arrData_detail["sub_step_number"] = 0;
                                        $tr = new MdlTransaksi();
                                        $tr->setFilters(array());
                                        $tr->setTableName($tr->getTableNames()['detail']);
                                        $dupState = $tr->updateData(array(
                                            "transaksi_id" => $prevID,
                                            "produk_id" => $rsltSpec->produk_id,
                                        ), $arrData_detail) or die("Failed to update tr next-state!");
                                        $mongListUpadte['update']['detail'][] = array(
                                            "where" => array(
                                                "transaksi_id" => $prevID,
                                                "produk_id" => $rsltSpec->produk_id,
                                            ),
                                            "value" => $arrData_detail,
                                        );
                                        cekKuning("UPDATE transaksi data...");
                                        cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                    }
                                }
                            }
                            //endregion


                            //region update transaksi ID TOP, transaksi induk-nya
                            $arrData = array(
                                "next_step_code" => $nextProp['code'],
                                "next_step_label" => $nextProp['label'],
                                "next_group_code" => $nextProp['groupID'],
                                "next_step_num" => $nextProp['num'],
                                //                            "step_current" => $masterTargetStepNum,
                                //                            "step_number" => $masterTargetStepNum,
                                //                            "trash_4" => "1",
                                "step_current" => $nextProp['num'] - 1,
                                "step_number" => $nextProp['num'] - 1,
                            );
                            $arrData_detail = array(
                                "next_substep_code" => $nextProp['code'],
                                "next_substep_label" => $nextProp['label'],
                                "next_subgroup_code" => $nextProp['groupID'],
                                "next_substep_num" => $nextProp['num'],
                                //                            "sub_step_current" => $masterTargetStepNum,
                                //                            "sub_step_number" => $masterTargetStepNum,
                                "sub_step_current" => $nextProp['num'] - 1,
                                "sub_step_number" => $nextProp['num'] - 1,
                            );
                            $prevID = $trTmp[0]->id_top;
                            $tc = new MdlTransaksi();
                            $tc->setFilters(array());
                            $dupState = $tc->updateData(array(
                                "id" => $prevID,
                            ), $arrData) or die("Failed to update tr next-state!");
                            $mongListUpadte['update']['main'][] = array(
                                "where" => array("id" => $prevID,),
                                "value" => $arrData,
                            );
                            cekLime("UPDATE transaksi 1 step sebelumnya...");
                            cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                            $td = new MdlTransaksi();
                            $td->setFilters(array());
                            $rslt = $td->lookupJoinedByID($prevID)->result();
                            if (sizeof($rslt) > 0) {
                                foreach ($rslt as $rsltSpec) {
                                    if (array_key_exists($rsltSpec->produk_id, $items)) {
                                        $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];

                                        if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                            $new_valid_qty = $rsltSpec->valid_qty;
                                            //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                        }
                                        else {
                                            $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                        }


                                        $arrData_detail["valid_qty"] = $new_valid_qty;
                                        $tr = new MdlTransaksi();
                                        $tr->setFilters(array());
                                        $tr->setTableName($tr->getTableNames()['detail']);
                                        $dupState = $tr->updateData(array(
                                            "transaksi_id" => $prevID,
                                            "produk_id" => $rsltSpec->produk_id,
                                        ), $arrData_detail) or die("Failed to update tr next-state!");
                                        $mongListUpadte['update']['detail'][] = array(
                                            "where" => array(
                                                "transaksi_id" => $prevID,
                                                "produk_id" => $rsltSpec->produk_id,
                                            ),
                                            "value" => $arrData_detail,
                                        );
                                        cekLime("UPDATE transaksi data...");
                                        cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                    }
                                }
                            }
                            //endregion


                        }

                        //endregion

                        //region sesuaikan signature untuk cloningan, ikut minus
                        //        $dwsign = $tr->writeSignature($no, array(
                        $dwsign = $tb->writeSignature($trTmp[0]->id, array(
                            "prev_id" => $trTmp[0]->id,
                            "nomer" => "rejection",
                            "step_number" => $childTargetStepNum, // ini minus step number
                            "step_code" => $this->config->item("heTransaksi_ui")[$origTCode]['steps'][abs($childTargetStepNum)]['target'],
                            "step_name" => $this->config->item("heTransaksi_ui")[$origTCode]['steps'][abs($childTargetStepNum)]['label'],
                            "group_code" => $this->config->item("heTransaksi_ui")[$origTCode]['steps'][abs($childTargetStepNum)]['userGroup'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "keterangan" => $this->config->item("heTransaksi_ui")[$origTCode]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
                            //            "transaksi_id" => $no,
                        )) or die("Failed to write signature");
                        $mongoList['sign'][] = $dwsign;
                        cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        //endregion

                        // region netralisasi payment source
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->addFilter("sisa>0");
                        $paymentSrc = $tr->lookupPaymentSrcByTransID($trTmp[0]->id)->result();
                        cekBiru($this->db->last_query());
                        if (sizeof($paymentSrc) > 0) {
                            //            arrPrint($paymentSrc);
                            foreach ($paymentSrc as $pSpec) {
                                if ($pSpec->terbayar == 0) {
                                    $where = array(
                                        "id" => $pSpec->id,
                                        "transaksi_id" => $pSpec->transaksi_id,
                                    );
                                    $data = array(
                                        "sisa" => 0,
                                        "returned" => $pSpec->sisa,
                                        "sisa_valas" => 0,
                                        "returned_valas" => $pSpec->sisa_valas,
                                    );

                                    $tra = New MdlTransaksi();
                                    $tra->setFilters(array());
                                    $tra->updatePaymentSrc($where, $data);
                                    cekUngu(":: mereject payment source bila ada...");
                                    cekUngu($this->db->last_query());
                                }
                                else {
                                    mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                                }
                            }
                        }
                        else {
                            cekBiru(":: tidak ada payment source... ::");
                        }
                        // endregion netralisasi payment source

                        // region netralisasi extended step
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $exTmp = $tr->lookupExtStepByTrID($trTmp[0]->id);
                        if (sizeof($exTmp) > 0) {
                            foreach ($exTmp as $exSpec) {

                                $tra = New MdlTransaksi();
                                $tra->setFilters(array());
                                $tra->rejectExtStepByID($exSpec['id']);
                                $mongListUpadte['update']['extra'][] = array(
                                    "where" => array(
                                        "id" => $exSpec['id'],
                                    ),
                                    "value" => array(
                                        "state" => "-1",
                                    ),
                                );
                                cekUngu(":: mereject extended step bila ada...");
                                cekUngu($this->db->last_query());
                            }
                        }
                        else {
                            cekBiru(":: tidak ada extended step... ::");
                        }

                        // endregion netralisasi extended step

                        //==entry point
                        if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                            $tableIn_master['trash_4'] = 1;
                            $tableIn_master['cancel_id'] = $this->session->login['id'];
                            $tableIn_master['cancel_name'] = $this->session->login['nama'];
                            $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                            $tableIn_master['deskripsi'] = "rejection";
                            $epID = $tr->writeMainEntries_entryPoint($trTmp[0]->id, $tableIn_master['id_master'], $tableIn_master);
                            $mongoList['main'][] = $epID;
                            if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                                $insertIDs = array();
                                foreach ($tableIn_detail as $dSpec) {
                                    if ($epID != 999) {
                                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                        $mongoList['detail'] = $insertIDs;

                                    }
                                }
                            }
                        }

                        cekKuning("stepNumCurrent -> $stepNumCurrent, jenisTR -> $jenisTr");
                        //===if rollback is needed
                        //rollback preproc, master
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'])) {
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'] : array();
                            if (sizeof($iterator) > 0) {
                                $it = 0;
                                cekbiru("ada iterator pre-proc master");
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $it++;
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'] . "_reverse";
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                                    echo "reverse master-preproc: $comName, initializing values <br>";
                                    $tmpOutParams[$cCtr] = array();


                                    $subParams = array();

                                    if (isset($tComSpec['static'])) {
                                        foreach ($tComSpec['static'] as $key => $value) {
                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $subParams['static'][$key] = $realValue;
                                        }

                                        if (array_key_exists($oriComName, $prepConfigs)) {
                                            if (sizeof($prepConfigs[$oriComName]) > 0) {
                                                foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                    $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                                }
                                            }
                                        }

                                        if (!isset($subParams['static']["transaksi_id"])) {
                                            $subParams['static']["transaksi_id"] = $no;
                                        }


                                        $subParams['static']["fulldate"] = date("Y-m-d");
                                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                    }
                                    if (sizeof($subParams) > 0) {
                                        $tmpOutParams[$cCtr] = $subParams;
                                    }


                                    $mdlName = "Pre" . ucfirst($comName);
                                    $this->load->model("Preprocs/" . $mdlName);
                                    $m = new $mdlName($resultParams);


                                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                        $tobeExecuted = true;
                                    }
                                    else {
                                        $tobeExecuted = false;
                                    }

                                    if ($tobeExecuted) {
                                        arrprint($tmpOutParams[$cCtr]);
                                        $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                        $gotParams = $m->exec();


                                    }
                                    else {
                                        cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                    }

                                }
                            }
                            else {
                                cekHitam(":: tidak ada config preproc master yang harus rollback ::");
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config pre-proc master $jenisTr :: $stepNumCurrent");
                        }
                        //rollback preproc, detail
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'])) {
                            //            cekbiru("ada config pre-proc detail $stepNumCurrent");
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'] : array();
                            //            arrprint($iterator);
                            if (sizeof($iterator) > 0) {
                                $it = 0;
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $it++;
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'] . "_reverse";
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "reverse preproc (detail): $comName, initializing values <br>";
                                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                                        $tmpOutParams[$cCtr] = array();
                                        //                        $id = $dSpec['id'];
                                        $id = $xid;
                                        $subParams = array();

                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                                $subParams['static'][$key] = $realValue;

                                            }

                                            if (array_key_exists($oriComName, $prepConfigs)) {
                                                cekhitam("terdapat di dalam prepConfig");
                                                if (sizeof($prepConfigs[$oriComName]) > 0) {
                                                    foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                        $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                                    }
                                                }
                                            }
                                            else {
                                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                            }
                                            if (!isset($subParams['static']["transaksi_id"])) {
                                                $subParams['static']["transaksi_id"] = $no;
                                            }


                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = "rollingback " . $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                        }

                                        if (sizeof($subParams) > 0) {

                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }


                                        $comName = $tComSpec['comName'] . "_reverse";
                                        $srcGateName = $tComSpec['srcGateName'];
                                        $srcRawGateName = $tComSpec['srcRawGateName'];
                                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                        echo "sub preproc #$it: $comName, sending values <br>";

                                        $mdlName = "Pre" . ucfirst($comName);
                                        $this->load->model("Preprocs/" . $mdlName);
                                        $m = new $mdlName($resultParams);


                                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                            $tobeExecuted = true;
                                        }
                                        else {
                                            $tobeExecuted = false;
                                        }

                                        if ($tobeExecuted) {

                                            //                            arrprint($tmpOutParams[$cCtr]);

                                            $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                            $gotParams = $m->exec();

                                            //                            cekbiru("gotparams");
                                            //                            arrprint($gotParams);

                                        }
                                        else {
                                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                        }

                                    }
                                }
                            }
                            else {
                                cekHitam(":: tidak ada config preproc detail yang harus rollback ::");
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config pre-proc detail $jenisTr :: $stepNumCurrent");
                        }

                        //rollback postproc, master
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'])) {
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'] : array();
                            if (sizeof($iterator) > 0) {
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "rollback main post-processor: $comName [$srcGateName]<br>";

                                    $dSpec = $_SESSION[$cCode][$srcGateName];
                                    $tmpOutParams = array();
                                    if (isset($tComSpec['loop'])) {
                                        foreach ($tComSpec['loop'] as $key => $value) {
                                            //                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $realValue = makeValue($value, $$srcGateName, $$srcGateName, 0);
                                            $tmpOutParams['loop'][$key] = $realValue;
                                        }
                                    }
                                    if (isset($tComSpec['static'])) {
                                        //cekHere("DISINI OIII");
                                        foreach ($tComSpec['static'] as $key => $value) {
                                            //                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $realValue = makeValue($value, $$srcGateName, $$srcGateName, 0);
                                            $tmpOutParams['static'][$key] = $realValue;
                                        }
                                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                                        }
                                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                                        }

                                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                    }
                                    if (isset($tComSpec['static2'])) {
                                        //cekHere("DISINI OIII");
                                        foreach ($tComSpec['static2'] as $key => $value) {
                                            //                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                                            $realValue = makeValue($value, $$srcGateName, $$srcGateName, 0);
                                            $tmpOutParams['static2'][$key] = $realValue;
                                        }
                                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                                        }
                                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                                        }

                                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                                    }


                                    if (array_key_exists($oriComName, $postConfigs)) {
                                        if (sizeof($postConfigs[$oriComName]) > 0) {
                                            foreach ($postConfigs[$oriComName] as $key) {
                                                $oldVal = isset($tmpOutParams['static'][$key]) ? $tmpOutParams['static'][$key] : 0;
                                                cekbiru("oldVal: $oldVal");
                                                $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                cekHijau("newVal: $newVal");

                                                $tmpOutParams['static'][$key] = $newVal;
                                            }
                                        }
                                    }

                                    //lgShowError("Ada kesalahan",);
                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();

                                    cekBiru("kiriman rollback main-postproc $comName");
                                    arrPrint($tmpOutParams);
                                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                                }
                            }
                            else {
                                cekHitam(":: tidak ada config postproc master yang harus rollback ::");
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config post-proc master $jenisTr :: $stepNumCurrent");
                        }
                        //rollback postproc, detail
                        cekPink(":: membatalkan step ke $stepNumCurrent milik $jenisTr");
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'])) {
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'] : array();
                            if (sizeof($iterator) > 0) {
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "rollback sub-postProcessor: $comName, initializing values <br>";

                                    $tmpOutParams[$cCtr] = array();
                                    foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                                        $subParams = array();
                                        if (isset($tComSpec['loop'])) {
                                            foreach ($tComSpec['loop'] as $key => $value) {
                                                $gateItems = $$srcGateName;
                                                //                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                                $realValue = makeValue($value, $gateItems[$cnt], $gateItems[$cnt], 0);
                                                $subParams['loop'][$key] = $realValue;
                                            }
                                        }
                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {
                                                $gateItems = $$srcGateName;
                                                //                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                                $realValue = makeValue($value, $gateItems[$cnt], $gateItems[$cnt], 0);
                                                $subParams['static'][$key] = $realValue;
                                            }

                                            if (array_key_exists($oriComName, $postConfigs)) {
                                                if (sizeof($postConfigs[$oriComName]) > 0) {
                                                    foreach ($postConfigs[$oriComName] as $key) {
                                                        $oldVal = isset($subParams['static'][$key]) ? $subParams['static'][$key] : 0;
                                                        cekbiru("oldVal2: $oldVal");
                                                        $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                        cekHijau("newVal2: $newVal");
                                                        $subParams['static'][$key] = $newVal;
                                                    }
                                                }
                                            }
                                            else {
                                                //                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                            }

                                            //                            $subParams['static']["transaksi_id"] = $insertID;
                                            if (!isset($subParams['static']["transaksi_id"])) {
                                                $subParams['static']["transaksi_id"] = $no;
                                            }
                                            if (!isset($subParams['static']["transaksi_no"])) {
                                                $subParams['static']["transaksi_no"] = $no;
                                            }
                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = "rollback of $no";
                                        }


                                        if (sizeof($subParams) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                }

                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "sub-postProcessor: $comName, sending values <br>";

                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();


                                    cekBiru("kiriman rollback detail-postproc $comName");
                                    arrPrint($tmpOutParams[$cCtr]);
                                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                }
                            }
                            else {
                                cekHitam(":: tidak ada config postproc detail yang harus rollback ::");
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config post-proc detail $jenisTr :: $stepNumCurrent");
                        }


                        //region transaksi stanby di pihak tujuan...
                        $nextMasterStep = $stepNumCurrent_son;
                        $childTargetStepNum = $childTargetStepNum_con;
                        $jenisTr = $jenisTr_con;
                        $nextProp = array(
                            "num" => $nextMasterStep,
                            "code" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'] : "",
                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'] : "",
                            "groupID" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'] : "",
                        );

                        //region swap from registry, transaksi yang dibuka saat ini
                        $tr = new MdlTransaksi();
                        $tmpReg = $tr->lookupRegistriesByMasterID($no)->result();
                        cekmerah($this->db->last_query());
                        if (sizeof($tmpReg) > 0) {
                            foreach ($tmpReg as $row) {
                                $var = $row->param;
                                $$var = unserialize(base64_decode($row->values));
                            }
                        }
                        //endregion

                        //region swap from main transaksi, transaksi yang dibuka saat ini
                        $tr = new MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->addFilter("id='$no'");
                        $tmpTr = $tr->lookupMainTransaksi()->result();
                        cekOrange($this->db->last_query());
                        //endregion

                        //region transaksi yang stanby di pihak ke-2
                        $tb = new MdlTransaksi();
                        $tb->setFilters(array());
                        $dupState = $tb->updateData(array(
                            "id" => $no,
                        ), array(
                            "status_4" => "11",
                            "trash_4" => "1",
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                            "cancel_name" => $this->session->login['nama'],
                            "cancel_id" => $this->session->login['id'],

                        )) or die("Failed to update tr next-state!");

                        $mongListUpadte['update']['main'][] = array(
                            "where" => array(
                                "id" => $no,
                            ),
                            "value" => array(
                                "status_4" => "11",
                                "trash_4" => "1",
                                "cancel_dtime" => date("Y-m-d H:i:s"),
                                "cancel_name" => $this->session->login['nama'],
                                "cancel_id" => $this->session->login['id'],
                            ),
                        );
                        cekHitam("UPDATE transaksi yang stanby di pihak ke-2");
                        cekHitam($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                        $to = new MdlTransaksi();
                        $to->setFilters(array());
                        $to->setTableName($to->getTableNames()['detail']);
                        $dupState = $to->updateData(array(
                            "transaksi_id" => $no,
                        ), array(
                            "next_substep_code" => $nextProp['code'],
                            "next_substep_label" => $nextProp['label'],
                            "next_subgroup_code" => $nextProp['groupID'],
                            "next_substep_num" => $nextProp['num'],
                            //            "sub_step_current" => 0,
                            "sub_step_number" => 0,
                        )) or die("Failed to update tr next-state!");
                        $mongListUpadte['update']['main'][] = array(
                            "where" => array(
                                "transaksi_id" => $no,
                            ),
                            "value" => array(
                                "next_substep_code" => $nextProp['code'],
                                "next_substep_label" => $nextProp['label'],
                                "next_subgroup_code" => $nextProp['groupID'],
                                "next_substep_num" => $nextProp['num'],
                                //            "sub_step_current" => 0,
                                "sub_step_number" => 0,
                            ),
                        );
                        cekHitam("UPDATE transaksi data yang stanby di pihak ke-2");
                        cekHitam($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        //endregion

                        //region sesuaikan signature untuk cloningan, ikut minus
                        //        $dwsign = $tr->writeSignature($no, array(
                        $dwsign = $tr->writeSignature($no, array(
                            "prev_id" => $no,
                            "nomer" => "rejection",
                            "step_number" => $childTargetStepNum, // ini minus step number
                            "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['target'],
                            "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'],
                            "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['userGroup'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
                            //            "transaksi_id" => $no,
                        )) or die("Failed to write signature");
                        $mongoList['sign'][] = $dwsign;
                        cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        //endregion

                        //==entry point
                        if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                            $tableIn_master['trash_4'] = 1;
                            $tableIn_master['cancel_id'] = $this->session->login['id'];
                            $tableIn_master['cancel_name'] = $this->session->login['nama'];
                            $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                            $tableIn_master['deskripsi'] = "rejection";
                            $epID = $tr->writeMainEntries_entryPoint($no, $tableIn_master['id_master'], $tableIn_master);
                            $mongoList['main'][] = $epID;

                            if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                                $insertIDs = array();
                                foreach ($tableIn_detail as $dSpec) {
                                    if ($epID != 999) {
                                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                        $mongoList['detail'] = $insertIDs;
                                    }
                                }
                            }
                        }

                        //endregion

                    }
                    else {
                        cekMerah(":: CONNECTING, SATU INSTANSI (PUSAT DOANG / CABANG DOANG)::");
                        cekHitam(":: jenisTR > $jenisTr, jenis_master > $jenisTr, id_master > " . $tmpTr[0]->id_master . " ::");
                        //                    mati_disini(":: transaksi gagal karena transaksi yang dimaksud tidak valid.");


                        //region :: update ID-nya sendiri...

                        //region update step2an di masternya
                        $nextMasterStep = $stepNumCurrent;
                        $nextProp = array(
                            "num" => $nextMasterStep,
                            "code" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'] : "",
                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'] : "",
                            "groupID" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'] : "",
                        );
                        echo "nextMasterStep: $nextMasterStep<br>";
                        arrPrint($nextProp);
                        cekKuning($masterTargetStepNum);
                        //update masternya, transaksi TOP
                        if ($tmpTr[0]->id_top != $no) {
                            $arrData = array(
                                "next_step_code" => $nextProp['code'],
                                "next_step_label" => $nextProp['label'],
                                "next_group_code" => $nextProp['groupID'],
                                "next_step_num" => $nextProp['num'],
                                "step_current" => $masterTargetStepNum,
                                "step_number" => $masterTargetStepNum,
                            );
                            $arrData_detail = array(
                                "next_substep_code" => $nextProp['code'],
                                "next_substep_label" => $nextProp['label'],
                                "next_subgroup_code" => $nextProp['groupID'],
                                "next_substep_num" => $nextProp['num'],
                                "sub_step_current" => $masterTargetStepNum,
                                "sub_step_number" => $masterTargetStepNum,
                                //                "valid_qty" => $new_valid_qty,
                            );
                        }
                        else {
                            $arrData = array(
                                "next_step_code" => $nextProp['code'],
                                "next_step_label" => $nextProp['label'],
                                "next_group_code" => $nextProp['groupID'],
                                "next_step_num" => $nextProp['num'],
                                "step_current" => $masterTargetStepNum,
                                "step_number" => $masterTargetStepNum,
                                //                        "step_number" => $childTargetStepNum,
                                "trash_4" => "1",
                            );
                            $arrData_detail = array(
                                "next_substep_code" => $nextProp['code'],
                                "next_substep_label" => $nextProp['label'],
                                "next_subgroup_code" => $nextProp['groupID'],
                                "next_substep_num" => $nextProp['num'],
                                //            "sub_step_current" => 0,
                                "sub_step_number" => 0,
                            );
                        }
                        $tr = new MdlTransaksi();
                        $dupState = $tr->updateData(array(
                            //                "id" => $no,
                            "id" => $tmpTr[0]->id_top,
                        ), $arrData) or die("Failed to update tr next-state!");
                        $mongListUpadte['update']['main'][] = array(
                            "where" => array("id" => $tmpTr[0]->id_top),
                            "value" => $arrData,
                        );
                        cekHijau("UPDATE transaksi step sebelumnya...");
                        cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        //endregion

                        //region update step transaksi 1 step sebelumnya (detail)
                        if (sizeof($tmpTr) > 0) {
                            $arrPrevID = $tmpTr[0]->ids_prev != null ? blobDecode($tmpTr[0]->ids_prev) : array($tmpTr[0]->id_top);
                            arrPrint($arrPrevID);
                            foreach ($arrPrevID as $prevID) {
                                $tb = new MdlTransaksi();
                                $tb->setFilters(array());
                                $dupState = $tb->updateData(array(
                                    "id" => $prevID,
                                ), array(
                                    "status_4" => "11",
                                )) or die("Failed to update tr next-state!");
                                $mongListUpadte['update']['main'][] = array(
                                    "where" => array("id" => $prevID),
                                    "value" => $arrData,
                                );
                                cekKuning("UPDATE transaksi 1 step sebelumnya...");
                                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");


                                $td = new MdlTransaksi();
                                $td->setFilters(array());
                                $rslt = $td->lookupJoinedByID($prevID)->result();
                                if (sizeof($rslt) > 0) {
                                    foreach ($rslt as $rsltSpec) {
                                        if (array_key_exists($rsltSpec->produk_id, $items)) {
                                            $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                            //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");

                                            if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                                $new_valid_qty = $rsltSpec->valid_qty;
                                                //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                            }
                                            else {
                                                $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                            }
                                            //                            cekHitam("ROLLBACK... :: valid_qty-> " . $rsltSpec->valid_qty . " :: kembali-> " . $items[$rsltSpec->produk_id]['qty'] . " :: " . $new_valid_qty);

                                            $arrData_detail["valid_qty"] = $new_valid_qty;
                                            $tr = new MdlTransaksi();
                                            $tr->setFilters(array());
                                            $tr->setTableName($tr->getTableNames()['detail']);
                                            $dupState = $tr->updateData(array(
                                                "transaksi_id" => $prevID,
                                                "produk_id" => $rsltSpec->produk_id,
                                            ), $arrData_detail) or die("Failed to update tr next-state!");
                                            $mongListUpadte['update']['detail'][] = array(
                                                "where" => array(
                                                    "transaksi_id" => $prevID,
                                                    "produk_id" => $rsltSpec->produk_id,
                                                ),
                                                "value" => $arrData_detail,
                                            );
                                            cekKuning("UPDATE transaksi data...");
                                            cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                        }
                                    }
                                }

                            }
                        }
                        //endregion

                        //region update step yang sebelumnya aktif, transaksi yang dibuka sekarang
                        // cekUngu($tmpTr[0]->id_top);
                        // cekUngu("$no");
                        // if ($tmpTr[0]->id_top != $no) {
                        $tp = new MdlTransaksi();
                        $dupState = $tp->updateData(array(
                            "id" => $no,
                            "step_number" => $stepNumCurrent,
                        ), array(
                            "step_number" => $masterTargetStepNum,
                            //                    "step_number" => $childTargetStepNum,
                            "trash_4" => "1",
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                            "cancel_name" => $this->session->login['nama'],
                            "cancel_id" => $this->session->login['id'],

                        )) or die("Failed to update tr next-state!");

                        $mongListUpadte['update']['main'][] = array(
                            "where" => array(
                                "id" => $no,
                                "step_number" => $stepNumCurrent,
                            ),
                            "value" => array(
                                "step_number" => $masterTargetStepNum,
                                //                    "step_number" => $childTargetStepNum,
                                "trash_4" => "1",
                                "cancel_dtime" => date("Y-m-d H:i:s"),
                                "cancel_name" => $this->session->login['nama'],
                                "cancel_id" => $this->session->login['id'],
                            ),
                        );
                        cekLime("UPDATE transaksi ini... yang dibuka sekarang...");
                        cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                        $to = new MdlTransaksi();
                        $to->setFilters(array());
                        $to->setTableName($to->getTableNames()['detail']);
                        $dupState = $to->updateData(array(
                            "transaksi_id" => $no,
                        ), array(
                            "next_substep_code" => $nextProp['code'],
                            "next_substep_label" => $nextProp['label'],
                            "next_subgroup_code" => $nextProp['groupID'],
                            "next_substep_num" => $nextProp['num'],
                            //            "sub_step_current" => 0,
                            "sub_step_number" => 0,
                        )) or die("Failed to update tr next-state!");
                        $mongListUpadte['update']['main'][] = array(
                            "where" => array(
                                "transaksi_id" => $no,
                            ),
                            "value" => array(
                                "next_substep_code" => $nextProp['code'],
                                "next_substep_label" => $nextProp['label'],
                                "next_subgroup_code" => $nextProp['groupID'],
                                "next_substep_num" => $nextProp['num'],
                                //            "sub_step_current" => 0,
                                "sub_step_number" => 0,
                            ),
                        );
                        cekLime("UPDATE transaksi data...");
                        cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        // }
                        //endregion

                        //region sesuaikan signature untuk cloningan, ikut minus
                        //        $dwsign = $tr->writeSignature($no, array(
                        $dwsign = $tr->writeSignature($tmpTr[0]->id_top, array(
                            "prev_id" => $no,
                            "nomer" => "rejection",
                            "step_number" => $childTargetStepNum, // ini minus step number
                            "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['target'],
                            "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'],
                            "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['userGroup'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
                            //            "transaksi_id" => $no,
                        )) or die("Failed to write signature");
                        $mongoList['sign'][] = $dwsign;
                        cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        //endregion

                        // region netralisasi payment source
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $tr->addFilter("sisa>0");
                        $paymentSrc = $tr->lookupPaymentSrcByTransID($no)->result();
                        cekBiru($this->db->last_query());
                        if (sizeof($paymentSrc) > 0) {
                            //            arrPrint($paymentSrc);
                            foreach ($paymentSrc as $pSpec) {
                                if ($pSpec->terbayar == 0) {
                                    $where = array(
                                        "id" => $pSpec->id,
                                        "transaksi_id" => $pSpec->transaksi_id,
                                    );
                                    $data = array(
                                        "sisa" => 0,
                                        "returned" => $pSpec->sisa,
                                        "sisa_valas" => 0,
                                        "returned_valas" => $pSpec->sisa_valas,
                                    );

                                    $tra = New MdlTransaksi();
                                    $tra->setFilters(array());
                                    $tra->updatePaymentSrc($where, $data);
                                    cekUngu(":: mereject payment source bila ada...");
                                    cekUngu($this->db->last_query());
                                }
                                else {
                                    mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                                }
                            }
                        }
                        else {
                            cekBiru(":: tidak ada payment source... ::");
                        }
                        // endregion netralisasi payment source

                        // region netralisasi extended step
                        $tr = New MdlTransaksi();
                        $tr->setFilters(array());
                        $exTmp = $tr->lookupExtStepByTrID($no);
                        if (sizeof($exTmp) > 0) {
                            foreach ($exTmp as $exSpec) {

                                $tra = New MdlTransaksi();
                                $tra->setFilters(array());
                                $tra->rejectExtStepByID($exSpec['id']);
                                $mongListUpadte['update']['extra'][] = array(
                                    "where" => array(
                                        "id" => $valID,
                                    ),
                                    "value" => array(
                                        "state" => "-1",
                                    ),
                                );
                                cekUngu(":: mereject extended step bila ada...");
                                cekUngu($this->db->last_query());
                            }
                        }
                        else {
                            cekBiru(":: tidak ada extended step... ::");
                        }

                        // endregion netralisasi extended step


                        //region entry point
                        if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                            $tableIn_master['trash_4'] = 1;
                            $tableIn_master['cancel_id'] = $this->session->login['id'];
                            $tableIn_master['cancel_name'] = $this->session->login['nama'];
                            $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                            $tableIn_master['deskripsi'] = "rejection";
                            $epID = $tr->writeMainEntries_entryPoint($no, $tableIn_master['id_master'], $tableIn_master);
                            $mongoList['main'][] = $epID;
                            //                        cekHitam($this->db->last_query());
                            if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                                $insertIDs = array();
                                foreach ($tableIn_detail as $dSpec) {
                                    if ($epID != 999) {
                                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                        $mongoList['detil'] = $insertIDs;
                                        //                                    cekHitam($this->db->last_query());
                                    }
                                }
                            }
                        }
                        //endregion

                        //===if rollback is needed
                        //rollback preproc, master
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'])) {
                            //            cekbiru("ada config pre-proc master $stepNumCurrent");
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'] : array();
                            //            arrprint($iterator);
                            if (sizeof($iterator) > 0) {
                                $it = 0;
                                cekbiru("ada iterator pre-proc master");
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $it++;
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'] . "_reverse";
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                                    echo "reverse master-preproc: $comName, initializing values <br>";
                                    $tmpOutParams[$cCtr] = array();


                                    $subParams = array();

                                    if (isset($tComSpec['static'])) {
                                        foreach ($tComSpec['static'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $subParams['static'][$key] = $realValue;

                                        }

                                        if (array_key_exists($oriComName, $prepConfigs)) {
                                            if (sizeof($prepConfigs[$oriComName]) > 0) {
                                                foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                    $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                                }
                                            }
                                        }

                                        if (!isset($subParams['static']["transaksi_id"])) {
                                            $subParams['static']["transaksi_id"] = $no;
                                        }


                                        $subParams['static']["fulldate"] = date("Y-m-d");
                                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                    }
                                    if (sizeof($subParams) > 0) {
                                        $tmpOutParams[$cCtr] = $subParams;
                                    }


                                    $mdlName = "Pre" . ucfirst($comName);
                                    $this->load->model("Preprocs/" . $mdlName);
                                    $m = new $mdlName($resultParams);


                                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                        $tobeExecuted = true;
                                    }
                                    else {
                                        $tobeExecuted = false;
                                    }

                                    if ($tobeExecuted) {
                                        arrprint($tmpOutParams[$cCtr]);
                                        $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                        $gotParams = $m->exec();


                                    }
                                    else {
                                        cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                    }

                                }
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config pre-proc master $jenisTr :: $stepNumCurrent");
                        }
                        //rollback preproc, detail
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'])) {
                            //            cekbiru("ada config pre-proc detail $stepNumCurrent");
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'] : array();
                            //            arrprint($iterator);
                            if (sizeof($iterator) > 0) {
                                $it = 0;
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $it++;
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'] . "_reverse";
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "reverse preproc (detail): $comName, initializing values <br>";
                                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                                        $tmpOutParams[$cCtr] = array();
                                        //                        $id = $dSpec['id'];
                                        $id = $xid;
                                        $subParams = array();

                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                                $subParams['static'][$key] = $realValue;

                                            }

                                            if (array_key_exists($oriComName, $prepConfigs)) {
                                                cekhitam("terdapat di dalam prepConfig");
                                                if (sizeof($prepConfigs[$oriComName]) > 0) {
                                                    foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                        $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                                    }
                                                }
                                            }
                                            else {
                                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                            }
                                            if (!isset($subParams['static']["transaksi_id"])) {
                                                $subParams['static']["transaksi_id"] = $no;
                                            }


                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = "rollingback " . $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                        }

                                        if (sizeof($subParams) > 0) {

                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }


                                        $comName = $tComSpec['comName'] . "_reverse";
                                        $srcGateName = $tComSpec['srcGateName'];
                                        $srcRawGateName = $tComSpec['srcRawGateName'];
                                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                        echo "sub preproc #$it: $comName, sending values <br>";

                                        $mdlName = "Pre" . ucfirst($comName);
                                        $this->load->model("Preprocs/" . $mdlName);
                                        $m = new $mdlName($resultParams);


                                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                            $tobeExecuted = true;
                                        }
                                        else {
                                            $tobeExecuted = false;
                                        }

                                        if ($tobeExecuted) {

                                            //                            arrprint($tmpOutParams[$cCtr]);

                                            $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                            $gotParams = $m->exec();

                                            //                            cekbiru("gotparams");
                                            //                            arrprint($gotParams);

                                        }
                                        else {
                                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                        }

                                    }
                                }
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config pre-proc detail $jenisTr :: $stepNumCurrent");
                        }
                        //rollback postproc, master
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'])) {
                            //            cekbiru("ada config pre-proc master $stepNumCurrent");
                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'] : array();
                            if (sizeof($iterator) > 0) {
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "rollback main post-processor: $comName<br>";

                                    $dSpec = $_SESSION[$cCode][$srcGateName];
                                    $tmpOutParams = array();
                                    if (isset($tComSpec['loop'])) {
                                        foreach ($tComSpec['loop'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $tmpOutParams['loop'][$key] = $realValue;

                                        }
                                    }
                                    if (isset($tComSpec['static'])) {
                                        //cekHere("DISINI OIII");
                                        foreach ($tComSpec['static'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            $tmpOutParams['static'][$key] = $realValue;

                                        }
                                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                                        }
                                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                                        }

                                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];


                                    }
                                    if (isset($tComSpec['static2'])) {
                                        //cekHere("DISINI OIII");
                                        foreach ($tComSpec['static2'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                                            $tmpOutParams['static2'][$key] = $realValue;

                                        }
                                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                                        }
                                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                                        }

                                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                                    }


                                    if (array_key_exists($oriComName, $postConfigs)) {
                                        if (sizeof($postConfigs[$oriComName]) > 0) {
                                            foreach ($postConfigs[$oriComName] as $key) {
                                                $oldVal = isset($tmpOutParams['static'][$key]) ? $tmpOutParams['static'][$key] : 0;
                                                cekbiru("oldVal: $oldVal");
                                                $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                cekHijau("newVal: $newVal");
                                                //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                                $tmpOutParams['static'][$key] = $newVal;
                                            }
                                        }
                                    }

                                    //lgShowError("Ada kesalahan",);
                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();

                                    cekBiru("kiriman rollback main-postproc $comName");
                                    arrPrint($tmpOutParams);
                                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                                }
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config post-proc master $jenisTr :: $stepNumCurrent");
                        }
                        //rollback postproc, detail
                        if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'])) {

                            $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'] : array();
                            if (sizeof($iterator) > 0) {
                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "rollback sub-postProcessor: $comName, initializing values <br>";
                                    //                arrPrint($_SESSION[$cCode][$srcGateName]);
                                    $tmpOutParams[$cCtr] = array();
                                    foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                                        $subParams = array();
                                        if (isset($tComSpec['loop'])) {
                                            foreach ($tComSpec['loop'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                                $subParams['loop'][$key] = $realValue;

                                            }
                                        }
                                        if (isset($tComSpec['static'])) {
                                            foreach ($tComSpec['static'] as $key => $value) {

                                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                                $subParams['static'][$key] = $realValue;
                                                //                                cekBiru("$key diisi dengan $realValue");

                                            }

                                            if (array_key_exists($oriComName, $postConfigs)) {
                                                //                                cekhitam("terdapat di dalam postConfig");
                                                if (sizeof($postConfigs[$oriComName]) > 0) {
                                                    foreach ($postConfigs[$oriComName] as $key) {
                                                        //                                        $replVal=makeValue($src,$_SESSION[$cCode][$srcGateName][$cnt],$_SESSION[$cCode][$srcGateName][$cnt],0);
                                                        //                                        cekbiru("$key akan direplace dengan nilai $replVal");
                                                        //                                        $subParams['static'][$key]=$replVal;

                                                        $oldVal = isset($subParams['static'][$key]) ? $subParams['static'][$key] : 0;
                                                        cekbiru("oldVal2: $oldVal");
                                                        $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                        cekHijau("newVal2: $newVal");
                                                        $subParams['static'][$key] = $newVal;
                                                        //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                                        //                                        $tmpOutParams['static'][$key]=$newVal;
                                                    }
                                                }
                                            }
                                            else {
                                                //                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                            }

                                            //                            $subParams['static']["transaksi_id"] = $insertID;
                                            if (!isset($subParams['static']["transaksi_id"])) {
                                                $subParams['static']["transaksi_id"] = $no;
                                            }
                                            if (!isset($subParams['static']["transaksi_no"])) {
                                                $subParams['static']["transaksi_no"] = $no;
                                            }
                                            $subParams['static']["fulldate"] = date("Y-m-d");
                                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                            $subParams['static']["keterangan"] = "rollback of $no";
                                        }


                                        if (sizeof($subParams) > 0) {
                                            $tmpOutParams[$cCtr][] = $subParams;
                                        }
                                    }
                                }

                                foreach ($iterator as $cCtr => $tComSpec) {
                                    $oriComName = $tComSpec['comName'];
                                    $comName = $tComSpec['comName'];
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    echo "sub-postProcessor: $comName, sending values <br>";

                                    $mdlName = "Com" . ucfirst($comName);
                                    $this->load->model("Coms/" . $mdlName);
                                    $m = new $mdlName();


                                    cekBiru("kiriman rollback detail-postproc $comName");
                                    arrPrint($tmpOutParams[$cCtr]);
                                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                }
                            }
                        }
                        else {
                            cekbiru("TIDAK ada config post-proc detail $jenisTr :: $stepNumCurrent");
                        }

                        //endregion

                    }
                    //endregion

//                    mati_disini("=== masuk sini ===");
                }
                else {
                    // hanya mundur 1 langkah di pihak target
//mati_disini(__LINE__);
                    //region update step2an di masternya
                    $nextMasterStep = $stepNumCurrent;
                    $nextProp = array(
                        "num" => $nextMasterStep,
                        "code" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'] : "",
                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'] : "",
                        "groupID" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'] : "",
                    );
                    echo "nextMasterStep: $nextMasterStep<br>";
//                    arrPrint($nextProp);
//                    cekKuning($masterTargetStepNum);
                    //update masternya, transaksi TOP
                    if ($tmpTr[0]->id_top != $no) {
                        $arrData = array(
                            "next_step_code" => $nextProp['code'],
                            "next_step_label" => $nextProp['label'],
                            "next_group_code" => $nextProp['groupID'],
                            "next_step_num" => $nextProp['num'],
                            "step_current" => $masterTargetStepNum,
                            "step_number" => $masterTargetStepNum,
                        );
                        $arrData_detail = array(
                            "next_substep_code" => $nextProp['code'],
                            "next_substep_label" => $nextProp['label'],
                            "next_subgroup_code" => $nextProp['groupID'],
                            "next_substep_num" => $nextProp['num'],
                            "sub_step_current" => $masterTargetStepNum,
                            "sub_step_number" => $masterTargetStepNum,
                            //                "valid_qty" => $new_valid_qty,
                        );
                    }
                    else {
                        $arrData = array(
                            "next_step_code" => $nextProp['code'],
                            "next_step_label" => $nextProp['label'],
                            "next_group_code" => $nextProp['groupID'],
                            "next_step_num" => $nextProp['num'],
                            "step_current" => $masterTargetStepNum,
                            "step_number" => $masterTargetStepNum,
                            //                        "step_number" => $childTargetStepNum,
                            "trash_4" => "1",
                            "cancel_dtime" => dtime("Y-m-d H:i:s"),
                            "cancel_id" => $this->session->login['id'],
                            "cancel_name" => $this->session->login['nama'],
                        );
                        $arrData_detail = array(
                            "next_substep_code" => $nextProp['code'],
                            "next_substep_label" => $nextProp['label'],
                            "next_subgroup_code" => $nextProp['groupID'],
                            "next_substep_num" => $nextProp['num'],
                            //            "sub_step_current" => 0,
                            "sub_step_number" => 0,
                        );
                    }
                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array(
                        //                "id" => $no,
                        "id" => $tmpTr[0]->id_top,
                    ), $arrData) or die("Failed to update tr next-state!");
                    $mongListUpadte['update']['main'][] = array(
                        "where" => array(
                            "id" => $tmpTr[0]->id_top
                        ),
                        "value" => $arrData,
                    );
                    cekHijau("UPDATE transaksi step sebelumnya...");
                    cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    //endregion

                    //region update step transaksi 1 step sebelumnya (detail)
                    if (sizeof($tmpTr) > 0) {
                        $arrPrevID = $tmpTr[0]->ids_prev != null ? blobDecode($tmpTr[0]->ids_prev) : array($tmpTr[0]->id_top);
//                        arrPrint($arrPrevID);
                        foreach ($arrPrevID as $prevID) {
                            $tb = new MdlTransaksi();
                            $tb->setFilters(array());
                            $dupState = $tb->updateData(array(
                                "id" => $prevID,
                            ), array(
                                "status_4" => "11",
                            )) or die("Failed to update tr next-state!");
                            $mongListUpadte['update']['main'][] = array(
                                "where" => array(
                                    "id" => $prevID
                                ),
                                "value" => array(
                                    "status_4" => "11",
                                ),
                            );
                            cekKuning("UPDATE transaksi 1 step sebelumnya...");
                            cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                            $td = new MdlTransaksi();
                            $td->setFilters(array());
                            $rslt = $td->lookupJoinedByID($prevID)->result();
                            if (sizeof($rslt) > 0) {
                                foreach ($rslt as $rsltSpec) {
                                    if (array_key_exists($rsltSpec->produk_id, $items)) {
                                        $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                        //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");

                                        if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                            $new_valid_qty = $rsltSpec->valid_qty;
                                            //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                        }
                                        else {
                                            $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                        }
                                        //                            cekHitam("ROLLBACK... :: valid_qty-> " . $rsltSpec->valid_qty . " :: kembali-> " . $items[$rsltSpec->produk_id]['qty'] . " :: " . $new_valid_qty);

                                        $arrData_detail["valid_qty"] = $new_valid_qty;
                                        $tr = new MdlTransaksi();
                                        $tr->setFilters(array());
                                        $tr->setTableName($tr->getTableNames()['detail']);
                                        $dupState = $tr->updateData(array(
                                            "transaksi_id" => $prevID,
                                            "produk_id" => $rsltSpec->produk_id,
                                        ), $arrData_detail) or die("Failed to update tr next-state!");
                                        $mongListUpadte['update']['detail'][] = array(
                                            "where" => array(
                                                "transaksi_id" => $prevID,
                                                "produk_id" => $rsltSpec->produk_id,
                                            ),
                                            "value" => $arrData_detail,
                                        );
                                        cekKuning("UPDATE transaksi data...");
                                        cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                    }
                                }
                            }

                        }
                    }
                    //endregion

                    //region update step yang sebelumnya aktif, transaksi yang dibuka sekarang
                    $tp = new MdlTransaksi();
                    $dupState = $tp->updateData(array(
                        "id" => $no,
                        "step_number" => $stepNumCurrent,
                    ), array(
                        "step_number" => $masterTargetStepNum,
                        //                    "step_number" => $childTargetStepNum,
                        "trash_4" => "1",
                        "cancel_dtime" => date("Y-m-d H:i:s"),
                        "cancel_name" => $this->session->login['nama'],
                        "cancel_id" => $this->session->login['id'],

                    )) or die("Failed to update tr next-state!");

                    $mongListUpadte['update']['main'][] = array(
                        "where" => array(
                            "id" => $no,
                            "step_number" => $stepNumCurrent,
                        ),
                        "value" => array(
                            "step_number" => $masterTargetStepNum,
                            //                    "step_number" => $childTargetStepNum,
                            "trash_4" => "1",
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                            "cancel_name" => $this->session->login['nama'],
                            "cancel_id" => $this->session->login['id'],
                        ),
                    );
                    cekLime("UPDATE transaksi ini... yang dibuka sekarang...");
                    cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
//arrPrintWebs($mongListUpadte);
                    $to = new MdlTransaksi();
                    $to->setFilters(array());
                    $to->setTableName($to->getTableNames()['detail']);
                    $dupState = $to->updateData(array(
                        "transaksi_id" => $no,
                    ), array(
                        "next_substep_code" => $nextProp['code'],
                        "next_substep_label" => $nextProp['label'],
                        "next_subgroup_code" => $nextProp['groupID'],
                        "next_substep_num" => $nextProp['num'],
                        //            "sub_step_current" => 0,
                        "sub_step_number" => 0,
                    )) or die("Failed to update tr next-state!");
                    $mongListUpadte['update']['detail'][] = array(
                        "where" => array(
                            "transaksi_id" => $no, "id" => $no,
                        ),
                        "value" => array(
                            "next_substep_code" => $nextProp['code'],
                            "next_substep_label" => $nextProp['label'],
                            "next_subgroup_code" => $nextProp['groupID'],
                            "next_substep_num" => $nextProp['num'],
                            //            "sub_step_current" => 0,
                            "sub_step_number" => 0,
                        ),
                    );
                    cekLime("UPDATE transaksi data...");
                    cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                    //endregion

                    //region sesuaikan signature untuk cloningan, ikut minus
                    //        $dwsign = $tr->writeSignature($no, array(
                    $dwsign = $tr->writeSignature($tmpTr[0]->id_top, array(
                        "prev_id" => $no,
                        "nomer" => "rejection",
                        "step_number" => $childTargetStepNum, // ini minus step number
                        "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['target'],
                        "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'],
                        "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['userGroup'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
                        //            "transaksi_id" => $no,
                    )) or die("Failed to write signature");
                    $mongoList['sign'][] = $dwsign;
                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    //endregion

                    // region netralisasi payment source
                    $tr = New MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("sisa>0");
                    $paymentSrc = $tr->lookupPaymentSrcByTransID($no)->result();
                    cekBiru($this->db->last_query());
                    if (sizeof($paymentSrc) > 0) {
                        //            arrPrint($paymentSrc);
                        foreach ($paymentSrc as $pSpec) {
                            if ($pSpec->terbayar == 0) {
                                $where = array(
                                    "id" => $pSpec->id,
                                    "transaksi_id" => $pSpec->transaksi_id,
                                );
                                $data = array(
                                    "sisa" => 0,
                                    "returned" => $pSpec->sisa,
                                    "sisa_valas" => 0,
                                    "returned_valas" => $pSpec->sisa_valas,
                                );

                                $tra = New MdlTransaksi();
                                $tra->setFilters(array());
                                $tra->updatePaymentSrc($where, $data);
                                cekUngu(":: mereject payment source bila ada...");
                                cekUngu($this->db->last_query());
                            }
                            else {
                                mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                            }
                        }
                    }
                    else {
                        cekBiru(":: tidak ada payment source... ::");
                    }
                    // endregion netralisasi payment source

                    // region netralisasi extended step
                    $tr = New MdlTransaksi();
                    $tr->setFilters(array());
                    $exTmp = $tr->lookupExtStepByTrID($no);
                    if (sizeof($exTmp) > 0) {
                        foreach ($exTmp as $exSpec) {

                            $tra = New MdlTransaksi();
                            $tra->setFilters(array());
                            $tra->rejectExtStepByID($exSpec['id']);
                            $mongListUpadte['update']['extra'][] = array(
                                "where" => array(
                                    "id" => $exSpec['id'],
                                ),
                                "value" => array(
                                    "state" => "-1",
                                ),
                            );
                            cekUngu(":: mereject extended step bila ada...");
                            cekUngu($this->db->last_query());
                        }
                    }
                    else {
                        cekBiru(":: tidak ada extended step... ::");
                    }

                    // endregion netralisasi extended step

                    //==entry point
                    if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                        $tableIn_master['trash_4'] = 1;
                        $tableIn_master['cancel_id'] = $this->session->login['id'];
                        $tableIn_master['cancel_name'] = $this->session->login['nama'];
                        $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                        $tableIn_master['deskripsi'] = "rejection";
                        $epID = $tr->writeMainEntries_entryPoint($no, $tableIn_master['id_master'], $tableIn_master);
                        $mongoList['main'][] = $epID;

                        if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                            $insertIDs = array();
                            foreach ($tableIn_detail as $dSpec) {
                                if ($epID != 999) {
                                    $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                    $mongoList['detail'] = $insertIDs;
                                }
                            }
                        }
                    }

                    //===if rollback is needed
                    //rollback preproc, master
                    if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'])) {
                        //            cekbiru("ada config pre-proc master $stepNumCurrent");
                        $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'] : array();
                        //            arrprint($iterator);
                        if (sizeof($iterator) > 0) {
                            $it = 0;
                            cekbiru("ada iterator pre-proc master");
                            foreach ($iterator as $cCtr => $tComSpec) {
                                $it++;
                                $oriComName = $tComSpec['comName'];
                                $comName = $tComSpec['comName'] . "_reverse";
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                                echo "reverse master-preproc: $comName, initializing values <br>";
                                $tmpOutParams[$cCtr] = array();


                                $subParams = array();

                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }

                                    if (array_key_exists($oriComName, $prepConfigs)) {
                                        if (sizeof($prepConfigs[$oriComName]) > 0) {
                                            foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                            }
                                        }
                                    }

                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $no;
                                    }


                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                }
                                if (sizeof($subParams) > 0) {
                                    $tmpOutParams[$cCtr] = $subParams;
                                }


                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);


                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    arrprint($tmpOutParams[$cCtr]);
                                    $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();


                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }

                            }
                        }
                    }
                    else {
                        cekbiru("TIDAK ada config pre-proc master $jenisTr :: $stepNumCurrent");
                    }
                    //rollback preproc, detail
                    if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'])) {
                        //            cekbiru("ada config pre-proc detail $stepNumCurrent");
                        $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'] : array();
                        //            arrprint($iterator);
                        if (sizeof($iterator) > 0) {
                            $it = 0;
                            foreach ($iterator as $cCtr => $tComSpec) {
                                $it++;
                                $oriComName = $tComSpec['comName'];
                                $comName = $tComSpec['comName'] . "_reverse";
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                echo "reverse preproc (detail): $comName, initializing values <br>";
                                foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                                    $tmpOutParams[$cCtr] = array();
                                    //                        $id = $dSpec['id'];
                                    $id = $xid;
                                    $subParams = array();

                                    if (isset($tComSpec['static'])) {
                                        foreach ($tComSpec['static'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                            $subParams['static'][$key] = $realValue;

                                        }

                                        if (array_key_exists($oriComName, $prepConfigs)) {
                                            cekhitam("terdapat di dalam prepConfig");
                                            if (sizeof($prepConfigs[$oriComName]) > 0) {
                                                foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                    $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                                }
                                            }
                                        }
                                        else {
                                            cekhitam("TIDAK terdapat di dalam prepConfig");
                                        }
                                        if (!isset($subParams['static']["transaksi_id"])) {
                                            $subParams['static']["transaksi_id"] = $no;
                                        }


                                        $subParams['static']["fulldate"] = date("Y-m-d");
                                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $subParams['static']["keterangan"] = "rollingback " . $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                    }

                                    if (sizeof($subParams) > 0) {

                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }


                                    $comName = $tComSpec['comName'] . "_reverse";
                                    $srcGateName = $tComSpec['srcGateName'];
                                    $srcRawGateName = $tComSpec['srcRawGateName'];
                                    $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                    echo "sub preproc #$it: $comName, sending values <br>";

                                    $mdlName = "Pre" . ucfirst($comName);
                                    $this->load->model("Preprocs/" . $mdlName);
                                    $m = new $mdlName($resultParams);


                                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                        $tobeExecuted = true;
                                    }
                                    else {
                                        $tobeExecuted = false;
                                    }

                                    if ($tobeExecuted) {

                                        //                            arrprint($tmpOutParams[$cCtr]);

                                        $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                        $gotParams = $m->exec();

                                        //                            cekbiru("gotparams");
                                        //                            arrprint($gotParams);

                                    }
                                    else {
                                        cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                    }

                                }
                            }
                        }
                    }
                    else {
                        cekbiru("TIDAK ada config pre-proc detail $jenisTr :: $stepNumCurrent");
                    }
                    //rollback postproc, master
                    if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'])) {
                        //            cekbiru("ada config pre-proc master $stepNumCurrent");
                        $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'] : array();
                        if (sizeof($iterator) > 0) {
                            foreach ($iterator as $cCtr => $tComSpec) {
                                $oriComName = $tComSpec['comName'];
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                echo "rollback main post-processor: $comName<br>";

                                $dSpec = $_SESSION[$cCode][$srcGateName];
                                $tmpOutParams = array();
                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                        $tmpOutParams['loop'][$key] = $realValue;

                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    //cekHere("DISINI OIII");
                                    foreach ($tComSpec['static'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                        $tmpOutParams['static'][$key] = $realValue;

                                    }
                                    if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                        $tmpOutParams['static']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                        $tmpOutParams['static']["transaksi_no"] = $insertNum;
                                    }

                                    $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                    $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];


                                }
                                if (isset($tComSpec['static2'])) {
                                    //cekHere("DISINI OIII");
                                    foreach ($tComSpec['static2'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                                        $tmpOutParams['static2'][$key] = $realValue;

                                    }
                                    if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                                        $tmpOutParams['static2']["transaksi_id"] = $insertID;
                                    }
                                    if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                                        $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                                    }

                                    $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                    $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                    $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                                }


                                if (array_key_exists($oriComName, $postConfigs)) {
                                    if (sizeof($postConfigs[$oriComName]) > 0) {
                                        foreach ($postConfigs[$oriComName] as $key) {
                                            $oldVal = isset($tmpOutParams['static'][$key]) ? $tmpOutParams['static'][$key] : 0;
                                            cekbiru("oldVal: $oldVal");
                                            $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                            cekHijau("newVal: $newVal");
                                            //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                            $tmpOutParams['static'][$key] = $newVal;
                                        }
                                    }
                                }

                                //lgShowError("Ada kesalahan",);
                                $mdlName = "Com" . ucfirst($comName);
                                $this->load->model("Coms/" . $mdlName);
                                $m = new $mdlName();

                                cekBiru("kiriman rollback main-postproc $comName");
                                arrPrint($tmpOutParams);
                                $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                            }
                        }
                    }
                    else {
                        cekbiru("TIDAK ada config post-proc master $jenisTr :: $stepNumCurrent");
                    }
                    //rollback postproc, detail
                    if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'])) {

                        $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'] : array();
                        if (sizeof($iterator) > 0) {
                            foreach ($iterator as $cCtr => $tComSpec) {
                                $oriComName = $tComSpec['comName'];
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                echo "rollback sub-postProcessor: $comName, initializing values <br>";
                                //                arrPrint($_SESSION[$cCode][$srcGateName]);
                                $tmpOutParams[$cCtr] = array();
                                foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                                    $subParams = array();
                                    if (isset($tComSpec['loop'])) {
                                        foreach ($tComSpec['loop'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                            $subParams['loop'][$key] = $realValue;

                                        }
                                    }
                                    if (isset($tComSpec['static'])) {
                                        foreach ($tComSpec['static'] as $key => $value) {

                                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                            $subParams['static'][$key] = $realValue;
                                            //                                cekBiru("$key diisi dengan $realValue");

                                        }

                                        if (array_key_exists($oriComName, $postConfigs)) {
                                            //                                cekhitam("terdapat di dalam postConfig");
                                            if (sizeof($postConfigs[$oriComName]) > 0) {
                                                foreach ($postConfigs[$oriComName] as $key) {
                                                    //                                        $replVal=makeValue($src,$_SESSION[$cCode][$srcGateName][$cnt],$_SESSION[$cCode][$srcGateName][$cnt],0);
                                                    //                                        cekbiru("$key akan direplace dengan nilai $replVal");
                                                    //                                        $subParams['static'][$key]=$replVal;

                                                    $oldVal = isset($subParams['static'][$key]) ? $subParams['static'][$key] : 0;
                                                    cekbiru("oldVal2: $oldVal");
                                                    $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                    cekHijau("newVal2: $newVal");
                                                    $subParams['static'][$key] = $newVal;
                                                    //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                                    //                                        $tmpOutParams['static'][$key]=$newVal;
                                                }
                                            }
                                        }
                                        else {
                                            //                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                        }

                                        //                            $subParams['static']["transaksi_id"] = $insertID;
                                        if (!isset($subParams['static']["transaksi_id"])) {
                                            $subParams['static']["transaksi_id"] = $no;
                                        }
                                        if (!isset($subParams['static']["transaksi_no"])) {
                                            $subParams['static']["transaksi_no"] = $no;
                                        }
                                        $subParams['static']["fulldate"] = date("Y-m-d");
                                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                        $subParams['static']["keterangan"] = "rollback of $no";
                                    }


                                    if (sizeof($subParams) > 0) {
                                        $tmpOutParams[$cCtr][] = $subParams;
                                    }
                                }
                            }

                            foreach ($iterator as $cCtr => $tComSpec) {
                                $oriComName = $tComSpec['comName'];
                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                echo "sub-postProcessor: $comName, sending values <br>";

                                $mdlName = "Com" . ucfirst($comName);
                                $this->load->model("Coms/" . $mdlName);
                                $m = new $mdlName();


                                cekBiru("kiriman rollback detail-postproc $comName");
                                arrPrint($tmpOutParams[$cCtr]);
                                $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            }
                        }
                    }
                    else {
                        cekbiru("TIDAK ada config post-proc detail $jenisTr :: $stepNumCurrent");
                    }
//mati_disini(__LINE__);
                }

            }
            else {
                cekBiru("yang membatalkan pihak source/sumber...");
                cekBiru("TIDAK ADA CONNECTING MUNDUR...");
//mati_disini(__LINE__);

                //region update step2an di masternya
                $nextMasterStep = $stepNumCurrent;
                $nextProp = array(
                    "num" => $nextMasterStep,
                    "code" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'] : "",
                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'] : "",
                    "groupID" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'] : "",
                );
                echo "nextMasterStep: $nextMasterStep<br>";
                arrPrint($nextProp);
                cekKuning($masterTargetStepNum);
                //update masternya, transaksi TOP
                if ($tmpTr[0]->id_top != $no) {
                    $arrData = array(
                        "next_step_code" => $nextProp['code'],
                        "next_step_label" => $nextProp['label'],
                        "next_group_code" => $nextProp['groupID'],
                        "next_step_num" => $nextProp['num'],
                        "step_current" => $masterTargetStepNum,
                        "step_number" => $masterTargetStepNum,
                    );
                    $arrData_detail = array(
                        "next_substep_code" => $nextProp['code'],
                        "next_substep_label" => $nextProp['label'],
                        "next_subgroup_code" => $nextProp['groupID'],
                        "next_substep_num" => $nextProp['num'],
                        "sub_step_current" => $masterTargetStepNum,
                        "sub_step_number" => $masterTargetStepNum,
                        //                "valid_qty" => $new_valid_qty,
                    );
                }
                else {
                    $arrData = array(
                        "next_step_code" => $nextProp['code'],
                        "next_step_label" => $nextProp['label'],
                        "next_group_code" => $nextProp['groupID'],
                        "next_step_num" => $nextProp['num'],
                        "step_current" => $masterTargetStepNum,
                        "step_number" => $masterTargetStepNum,
                        //                        "step_number" => $childTargetStepNum,
                        "trash_4" => "1",
                        "cancel_id" => $this->session->login['id'],
                        "cancel_name" => $this->session->login['nama'],
                        "cancel_dtime" => date("Y-m-d H:i:s"),

                    );
                    $arrData_detail = array(
                        "next_substep_code" => $nextProp['code'],
                        "next_substep_label" => $nextProp['label'],
                        "next_subgroup_code" => $nextProp['groupID'],
                        "next_substep_num" => $nextProp['num'],
                        //            "sub_step_current" => 0,
                        "sub_step_number" => 0,
                    );
                }
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array(
                    //                "id" => $no,
                    "id" => $tmpTr[0]->id_top,
                ), $arrData) or die("Failed to update tr next-state!");
                $mongListUpadte['update']['main'][] = array(
                    "where" => array(
                        "id" => $tmpTr[0]->id_top
                    ),
                    "value" => $arrData,
                );
                cekHijau("UPDATE transaksi step sebelumnya...");
                cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                //endregion

                //region update step transaksi 1 step sebelumnya (detail)
                if (sizeof($tmpTr) > 0) {
                    $arrPrevID = $tmpTr[0]->ids_prev != null ? blobDecode($tmpTr[0]->ids_prev) : array($tmpTr[0]->id_top);
                    arrPrint($arrPrevID);
                    foreach ($arrPrevID as $prevID) {
                        $tb = new MdlTransaksi();
                        $tb->setFilters(array());
                        $dupState = $tb->updateData(array(
                            "id" => $prevID,
                        ), array(
                            "status_4" => "11",
                        )) or die("Failed to update tr next-state!");
                        $mongListUpadte['update']['main'][] = array(
                            "where" => array(
                                "id" => $prevID
                            ),
                            "value" => array(
                                "status_4" => "11",
                            ),
                        );
                        cekKuning("UPDATE transaksi 1 step sebelumnya...");
                        cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");


                        $td = new MdlTransaksi();
                        $td->setFilters(array());
                        $rslt = $td->lookupJoinedByID($prevID)->result();
                        if (sizeof($rslt) > 0) {
                            foreach ($rslt as $rsltSpec) {
                                if (array_key_exists($rsltSpec->produk_id, $items)) {
                                    $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                    //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");

                                    if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                        $new_valid_qty = $rsltSpec->valid_qty;
                                        //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                    }
                                    else {
                                        $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                    }
                                    //                            cekHitam("ROLLBACK... :: valid_qty-> " . $rsltSpec->valid_qty . " :: kembali-> " . $items[$rsltSpec->produk_id]['qty'] . " :: " . $new_valid_qty);

                                    $arrData_detail["valid_qty"] = $new_valid_qty;
                                    $tr = new MdlTransaksi();
                                    $tr->setFilters(array());
                                    $tr->setTableName($tr->getTableNames()['detail']);
                                    $dupState = $tr->updateData(array(
                                        "transaksi_id" => $prevID,
                                        "produk_id" => $rsltSpec->produk_id,
                                    ), $arrData_detail) or die("Failed to update tr next-state!");
                                    $mongListUpadte['update']['detail'][] = array(
                                        "where" => array(
                                            "transaksi_id" => $prevID,
                                            "produk_id" => $rsltSpec->produk_id,
                                        ),
                                        "value" => $arrData_detail,
                                    );
                                    cekKuning("UPDATE transaksi data...");
                                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                }
                            }
                        }

                    }
                }
                //endregion

                //region update step yang sebelumnya aktif, transaksi yang dibuka sekarang
                $tp = new MdlTransaksi();
                $dupState = $tp->updateData(array(
                    "id" => $no,
                    "step_number" => $stepNumCurrent,
                ), array(
                    "step_number" => $masterTargetStepNum,
                    //                    "step_number" => $childTargetStepNum,
                    "trash_4" => "1",
                    "cancel_dtime" => date("Y-m-d H:i:s"),
                    "cancel_name" => $this->session->login['nama'],
                    "cancel_id" => $this->session->login['id'],

                )) or die("Failed to update tr next-state!");

                $mongListUpadte['update']['main'][] = array(
                    "where" => array(
                        "id" => $no,
                        "step_number" => $stepNumCurrent,
                    ),
                    "value" => array(
                        "step_number" => $masterTargetStepNum,
                        //                    "step_number" => $childTargetStepNum,
                        "trash_4" => "1",
                        "cancel_dtime" => date("Y-m-d H:i:s"),
                        "cancel_name" => $this->session->login['nama'],
                        "cancel_id" => $this->session->login['id'],
                    ),
                );
                cekLime("UPDATE transaksi ini... yang dibuka sekarang...");
                cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                $to = new MdlTransaksi();
                $to->setFilters(array());
                $to->setTableName($to->getTableNames()['detail']);
                $dupState = $to->updateData(array(
                    "transaksi_id" => $no,
                ), array(
                    "next_substep_code" => $nextProp['code'],
                    "next_substep_label" => $nextProp['label'],
                    "next_subgroup_code" => $nextProp['groupID'],
                    "next_substep_num" => $nextProp['num'],
                    //            "sub_step_current" => 0,
                    "sub_step_number" => 0,
                )) or die("Failed to update tr next-state!");
                $mongListUpadte['update']['detail'][] = array(
                    "where" => array(
                        "transaksi_id" => $no, "id" => $no,
                    ),
                    "value" => array(
                        "next_substep_code" => $nextProp['code'],
                        "next_substep_label" => $nextProp['label'],
                        "next_subgroup_code" => $nextProp['groupID'],
                        "next_substep_num" => $nextProp['num'],
                        //            "sub_step_current" => 0,
                        "sub_step_number" => 0,
                    ),
                );
                cekLime("UPDATE transaksi data...");
                cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                //endregion

                //region sesuaikan signature untuk cloningan, ikut minus
                //        $dwsign = $tr->writeSignature($no, array(
                $dwsign = $tr->writeSignature($tmpTr[0]->id_top, array(
                    "prev_id" => $no,
                    "nomer" => "rejection",
                    "step_number" => $childTargetStepNum, // ini minus step number
                    "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['target'],
                    "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'],
                    "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['userGroup'],
                    "oleh_id" => $this->session->login['id'],
                    "oleh_nama" => $this->session->login['nama'],
                    "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
                    //            "transaksi_id" => $no,
                )) or die("Failed to write signature");
                $mongoList['sign'][] = $dwsign;
                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                //endregion

                // region netralisasi payment source
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("sisa>0");
                $paymentSrc = $tr->lookupPaymentSrcByTransID($no)->result();
                cekBiru($this->db->last_query());
                if (sizeof($paymentSrc) > 0) {
                    //            arrPrint($paymentSrc);
                    foreach ($paymentSrc as $pSpec) {
                        if ($pSpec->terbayar == 0) {
                            $where = array(
                                "id" => $pSpec->id,
                                "transaksi_id" => $pSpec->transaksi_id,
                            );
                            $data = array(
                                "sisa" => 0,
                                "returned" => $pSpec->sisa,
                                "sisa_valas" => 0,
                                "returned_valas" => $pSpec->sisa_valas,
                            );

                            $tra = New MdlTransaksi();
                            $tra->setFilters(array());
                            $tra->updatePaymentSrc($where, $data);
                            cekUngu(":: mereject payment source bila ada...");
                            cekUngu($this->db->last_query());
                        }
                        else {
                            mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                        }
                    }
                }
                else {
                    cekBiru(":: tidak ada payment source... ::");
                }
                // endregion netralisasi payment source

                // region netralisasi extended step
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $exTmp = $tr->lookupExtStepByTrID($no);
                if (sizeof($exTmp) > 0) {
                    foreach ($exTmp as $exSpec) {

                        $tra = New MdlTransaksi();
                        $tra->setFilters(array());
                        $tra->rejectExtStepByID($exSpec['id']);
                        $mongListUpadte['update']['extra'][] = array(
                            "where" => array(
                                "id" => $exSpec['id'],
                            ),
                            "value" => array(
                                "state" => "-1",
                            ),
                        );
                        cekUngu(":: mereject extended step bila ada...");
                        cekUngu($this->db->last_query());
                    }
                }
                else {
                    cekBiru(":: tidak ada extended step... ::");
                }

                // endregion netralisasi extended step

                //==entry point
                if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                    $tableIn_master['trash_4'] = 1;
                    $tableIn_master['cancel_id'] = $this->session->login['id'];
                    $tableIn_master['cancel_name'] = $this->session->login['nama'];
                    $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                    $tableIn_master['deskripsi'] = "rejection";
                    $epID = $tr->writeMainEntries_entryPoint($no, $tableIn_master['id_master'], $tableIn_master);
                    $mongoList['main'][] = $epID;

                    if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                        $insertIDs = array();
                        foreach ($tableIn_detail as $dSpec) {
                            if ($epID != 999) {
                                $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                $mongoList['detail'] = $insertIDs;
                            }
                        }
                    }
                }

                //===if rollback is needed
                //rollback preproc, master
                if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'])) {
                    //            cekbiru("ada config pre-proc master $stepNumCurrent");
                    $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'] : array();
                    //            arrprint($iterator);
                    if (sizeof($iterator) > 0) {
                        $it = 0;
                        cekbiru("ada iterator pre-proc master");
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $it++;
                            $oriComName = $tComSpec['comName'];
                            $comName = $tComSpec['comName'] . "_reverse";
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                            echo "reverse master-preproc: $comName, initializing values <br>";
                            $tmpOutParams[$cCtr] = array();


                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (array_key_exists($oriComName, $prepConfigs)) {
                                    if (sizeof($prepConfigs[$oriComName]) > 0) {
                                        foreach ($prepConfigs[$oriComName] as $key => $src) {
                                            $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                        }
                                    }
                                }

                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $no;
                                }


                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                            }
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr] = $subParams;
                            }


                            $mdlName = "Pre" . ucfirst($comName);
                            $this->load->model("Preprocs/" . $mdlName);
                            $m = new $mdlName($resultParams);


                            if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                $tobeExecuted = true;
                            }
                            else {
                                $tobeExecuted = false;
                            }

                            if ($tobeExecuted) {
                                arrprint($tmpOutParams[$cCtr]);
                                $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                $gotParams = $m->exec();


                            }
                            else {
                                cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                            }

                        }
                    }
                }
                else {
                    cekbiru("TIDAK ada config pre-proc master $jenisTr :: $stepNumCurrent");
                }
                //rollback preproc, detail
                if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'])) {
                    //            cekbiru("ada config pre-proc detail $stepNumCurrent");
                    $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'] : array();
                    //            arrprint($iterator);
                    if (sizeof($iterator) > 0) {
                        $it = 0;
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $it++;
                            $oriComName = $tComSpec['comName'];
                            $comName = $tComSpec['comName'] . "_reverse";
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            echo "reverse preproc (detail): $comName, initializing values <br>";
                            foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                                $tmpOutParams[$cCtr] = array();
                                //                        $id = $dSpec['id'];
                                $id = $xid;
                                $subParams = array();

                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }

                                    if (array_key_exists($oriComName, $prepConfigs)) {
                                        cekhitam("terdapat di dalam prepConfig");
                                        if (sizeof($prepConfigs[$oriComName]) > 0) {
                                            foreach ($prepConfigs[$oriComName] as $key => $src) {
                                                $subParams['static'][$key] = makeValue($src, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                            }
                                        }
                                    }
                                    else {
                                        cekhitam("TIDAK terdapat di dalam prepConfig");
                                    }
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $no;
                                    }


                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "rollingback " . $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                                }

                                if (sizeof($subParams) > 0) {

                                    $tmpOutParams[$cCtr][] = $subParams;
                                }


                                $comName = $tComSpec['comName'] . "_reverse";
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                echo "sub preproc #$it: $comName, sending values <br>";

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);


                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {

                                    //                            arrprint($tmpOutParams[$cCtr]);

                                    $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();

                                    //                            cekbiru("gotparams");
                                    //                            arrprint($gotParams);

                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }

                            }
                        }
                    }
                }
                else {
                    cekbiru("TIDAK ada config pre-proc detail $jenisTr :: $stepNumCurrent");
                }
                //rollback postproc, master
                if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'])) {
                    //            cekbiru("ada config pre-proc master $stepNumCurrent");
                    $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'] : array();
                    if (sizeof($iterator) > 0) {
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $oriComName = $tComSpec['comName'];
                            $comName = $tComSpec['comName'];
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            echo "rollback main post-processor: $comName<br>";

                            $dSpec = $_SESSION[$cCode][$srcGateName];
                            $tmpOutParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                    $tmpOutParams['loop'][$key] = $realValue;

                                }
                            }
                            if (isset($tComSpec['static'])) {
                                //cekHere("DISINI OIII");
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                    $tmpOutParams['static'][$key] = $realValue;

                                }
                                if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                    $tmpOutParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                    $tmpOutParams['static']["transaksi_no"] = $insertNum;
                                }

                                $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];


                            }
                            if (isset($tComSpec['static2'])) {
                                //cekHere("DISINI OIII");
                                foreach ($tComSpec['static2'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                                    $tmpOutParams['static2'][$key] = $realValue;

                                }
                                if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                                    $tmpOutParams['static2']["transaksi_id"] = $insertID;
                                }
                                if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                                    $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                                }

                                $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                            }


                            if (array_key_exists($oriComName, $postConfigs)) {
                                if (sizeof($postConfigs[$oriComName]) > 0) {
                                    foreach ($postConfigs[$oriComName] as $key) {
                                        $oldVal = isset($tmpOutParams['static'][$key]) ? $tmpOutParams['static'][$key] : 0;
                                        cekbiru("oldVal: $oldVal");
                                        $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                        cekHijau("newVal: $newVal");
                                        //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                        $tmpOutParams['static'][$key] = $newVal;
                                    }
                                }
                            }

                            //lgShowError("Ada kesalahan",);
                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();

                            cekBiru("kiriman rollback main-postproc $comName");
                            arrPrint($tmpOutParams);
                            $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                        }
                    }
                }
                else {
                    cekbiru("TIDAK ada config post-proc master $jenisTr :: $stepNumCurrent");
                }
                //rollback postproc, detail
                if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'])) {

                    $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'] : array();
                    if (sizeof($iterator) > 0) {
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $oriComName = $tComSpec['comName'];
                            $comName = $tComSpec['comName'];
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            echo "rollback sub-postProcessor: $comName, initializing values <br>";
                            //                arrPrint($_SESSION[$cCode][$srcGateName]);
                            $tmpOutParams[$cCtr] = array();
                            foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                                $subParams = array();
                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                        $subParams['loop'][$key] = $realValue;

                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {

                                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                                        $subParams['static'][$key] = $realValue;
                                        //                                cekBiru("$key diisi dengan $realValue");

                                    }

                                    if (array_key_exists($oriComName, $postConfigs)) {
                                        //                                cekhitam("terdapat di dalam postConfig");
                                        if (sizeof($postConfigs[$oriComName]) > 0) {
                                            foreach ($postConfigs[$oriComName] as $key) {
                                                //                                        $replVal=makeValue($src,$_SESSION[$cCode][$srcGateName][$cnt],$_SESSION[$cCode][$srcGateName][$cnt],0);
                                                //                                        cekbiru("$key akan direplace dengan nilai $replVal");
                                                //                                        $subParams['static'][$key]=$replVal;

                                                $oldVal = isset($subParams['static'][$key]) ? $subParams['static'][$key] : 0;
                                                cekbiru("oldVal2: $oldVal");
                                                $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                cekHijau("newVal2: $newVal");
                                                $subParams['static'][$key] = $newVal;
                                                //                                $tmpOutParams['static'][$key]=makeValue($src,$_SESSION[$cCode][$srcGateName],$_SESSION[$cCode][$srcGateName],0);
                                                //                                        $tmpOutParams['static'][$key]=$newVal;
                                            }
                                        }
                                    }
                                    else {
                                        //                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                    }

                                    //                            $subParams['static']["transaksi_id"] = $insertID;
                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $no;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $no;
                                    }
                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "rollback of $no";
                                }


                                if (sizeof($subParams) > 0) {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                        }

                        foreach ($iterator as $cCtr => $tComSpec) {
                            $oriComName = $tComSpec['comName'];
                            $comName = $tComSpec['comName'];
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            echo "sub-postProcessor: $comName, sending values <br>";

                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();


                            cekBiru("kiriman rollback detail-postproc $comName");
                            arrPrint($tmpOutParams[$cCtr]);
                            $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        }
                    }
                }
                else {
                    cekbiru("TIDAK ada config post-proc detail $jenisTr :: $stepNumCurrent");
                }

            }
        }


        if (sizeof($referenceRevertConfigs) > 0) {
            if (isset($referenceRevertConfigs['enabled']) && ($referenceRevertConfigs['enabled'] == true)) {

                $arrQtyRevert = array();
                foreach ($items as $spec) {
                    $arrQtyRevert[$spec['id']] = $spec['qty'];
                }

                $referenceID = $_SESSION[$cCode]['main'][$referenceRevertConfigs['referenceID']];
                cekHitam(":: $referenceID ::");

                $tr = new MdlTransaksi();
                $tr->setFilters(array());
                $refTr = $tr->lookupDetailTransaksi($referenceID)->result();
                if (sizeof($refTr) > 0) {
                    foreach ($refTr as $spec) {
                        $qty = isset($arrQtyRevert[$spec->produk_id]) ? $arrQtyRevert[$spec->produk_id] : 0;
                        $data = array(
                            "valid_qty" => $spec->valid_qty + $qty,
                            "req_cancel_qty" => $spec->req_cancel_qty - $qty,
                        );
                        $where = array(
                            "produk_id" => $spec->produk_id,
                            "transaksi_id" => $spec->transaksi_id,
                        );
                        $to = new MdlTransaksi();
                        $to->setFilters(array());
                        $to->setTableName($to->getTableNames()['detail']);
                        $dupState = $to->updateData($where, $data);
                        $mongListUpadte['update']['detail'][] = array(
                            "where" => $where,
                            "value" => $data,
                        );
                        cekPink2($this->db->last_query());
                    }
                }

                //arrPrint($arrQtyRevert);
            }
        }


        //==================================================================================================
        //==MENGUPDATE LOCKER TRANSAKSI ====================================================================
        $this->load->model("Mdls/MdlLockerTransaksi");
        $lt = New MdlLockerTransaksi();
        $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], $transaksiID_reference, NULL);
        //==================================================================================================


        //==tampilkan receipt
        cekMerah("-- DONE --");


        echo "<script>top.close_holdon()</script>";
        //        arrPrint($mongListUpadte);
        //        arrPrint($mongoList);

//        mati_disini(get_class($this) . " " . __FUNCTION__ . " under maintenance...");


        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        //region connect ke mongoDB
//arrPrint($mongListUpadte);
        if (sizeof($mongListUpadte) > 0) {
            $mong = new MdlMongoMother();
            foreach ($mongListUpadte as $metode => $tmpData) {
                if ($metode == "update") {
                    if (sizeof($tmpData) > 0) {
                        foreach ($tmpData as $gate => $fildsData) {
                            $mong->setTableName($this->mongoTableList[$gate]);
                            foreach ($fildsData as $mongUpadte) {
                                $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                            }
                        }
                    }
                }
            }
        }


        if (sizeof($mongoList) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongoList as $gateList => $listIDSData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$gateList]);
                $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$gateList]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        //                        cekLime("ninsert into :".$this->mongoTableList[$gateList]);
                        //                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }
                //                    cekHitam($listedTable[$gateList]);
                //                    cekLime($gateList);

            }
        }
        //endregion
//        mati_disini();

        if (isset($_SESSION[$cCode])) {
            unset($_SESSION[$cCode]);
        }
        if (isset($oldCode)) {
            if (isset($_SESSION[$oldCode])) {
                unset($_SESSION[$oldCode]);
            }
        }
        $arrAlert = array(
            "type" => "success",
            "title" => "Transaction updated",
            //                        "html" => "your order has been saved and ready to process",
            "html" => $this->session->errMsg,
            "timer" => "1500",
            "showConfirmButton" => false,
            "allowOutsideClick" => false,
        );

        echo swalAlert($arrAlert);
        echo "<script>topReload(1500)</script>";
        echo topReload();
        echo "</script>";
        unset($this->session->errMsg);
    }

    public function doRevertAll()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $transaksiID_reference = $no = $this->uri->segment(3);
        $jenisTr_con = $jenisTr = $this->uri->segment(4);
        //        $masterTargetStepNum_con = $masterTargetStepNum = $this->uri->segment(5);
        //        $childTargetStepNum_con = $childTargetStepNum = $this->uri->segment(6);
        $stepNumCurrent = $stepNumCurrent = $masterTargetStepNum = $childTargetStepNum = $this->uri->segment(5);
        $cCode = "_TR_" . $jenisTr;


        // region transaksi yang dibuka
        $tr = new MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("id='$no'");
        $tmpTr = $tr->lookupMainTransaksi()->result();
        //        cekOrange($this->db->last_query());
        $insertID = $tmpTr[0]->id;
        $insertNum = $tmpTr[0]->nomer;
        $masterID = $tmpTr[0]->id_master;
        // endregion transaksi yang dibuka
        cekHitam("trID: $insertID, masterID: $masterID");


        //region membaca transaksi berdasarkan masterID
        $trm = new MdlTransaksi();
        $trm->setFilters(array());
        $trm->addFilter("id_master='$masterID'");
        $trm->addFilter("link_id='0'");
        $trm->addFilter("trash_4='0'");
        $tmpTrm = $trm->lookupMainTransaksi()->result();
        $indexReg = array();
        $arrMainDataTrans = array();
        $arrMainDataTransID = array();
        $regParam = array(
            "main",
            "items",
            "tableIn_master",
            "tableIn_detail",
        );
        foreach ($tmpTrm as $tmpTrmSpec) {
            //            arrPrintWebs($tmpTrmSpec);
            //            $arrMainDataTrans[$tmpTrmSpec->step_number] = $tmpTrmSpec;
            //            $arrMainDataTransID[$tmpTrmSpec->step_number] = $tmpTrmSpec->id;
            //
            $arrMainDataTransID[$tmpTrmSpec->id] = array(
                "step" => $tmpTrmSpec->step_number,
                "jenisTr" => $tmpTrmSpec->jenis_master,
                "transaksi_id" => $tmpTrmSpec->id,
            );

            $indexRegTmp = blobDecode($tmpTrmSpec->indexing_registry);

            foreach ($indexRegTmp as $key => $val) {
                if (in_array($key, $regParam)) {
                    $indexReg[] = $val;
                }
            }
        }
        //endregion

        krsort($arrMainDataTransID);


        //region swap from registry
        $tr = new MdlTransaksi();
        $tr->setFilters(array());
        $tr->addFilter("id in ('" . implode("','", $indexReg) . "')");
        $tmpReg = $tr->lookupRegistries()->result();
        //        cekmerah($this->db->last_query());

        $tmpRegData = array();
        if (sizeof($tmpReg) > 0) {
            foreach ($tmpReg as $row) {
                $tmpRegData[$row->transaksi_id][] = $row;

            }
        }
        //endregion
        //arrPrintWebs($arrMainDataTransID);
        //arrPrintWebs($tmpRegData);
        //mati_disini();

        $this->db->trans_start();


        //        $referenceRevertConfigs = isset($this->config->item('heTransaksi_ui')[$jenisTr]['referenceRevert']) ? $this->config->item('heTransaksi_ui')[$jenisTr]['referenceRevert'] : array();
        $prepConfigs = null != $this->config->item('hePreProcessors') ? $this->config->item('hePreProcessors') : array();
        $postConfigs = null != $this->config->item('hePostProcessors') ? $this->config->item('hePostProcessors') : array();
        $postDeniedConfigs = null != $this->config->item('hePostProcessorsDenied') ? $this->config->item('hePostProcessorsDenied') : array();


        $nextProp = array(
            "num" => 0,
            "code" => "",
            "label" => "",
            "groupID" => "",
        );


        $mongListUpadte = array();
        $mongoList = array();
        foreach ($arrMainDataTransID as $arrMainDataTransIDSpec) {

            $no = $arrMainDataTransIDSpec['transaksi_id'];
            $stepNumCurrent = $arrMainDataTransIDSpec['step'];
            $jenisTr = $arrMainDataTransIDSpec['jenisTr'];

            cekHitam("MENGEMBALIKAN PRE & POST UNTUK STEP $stepNumCurrent");

            $arrData = array(
                "next_step_code" => $nextProp['code'],
                "next_step_label" => $nextProp['label'],
                "next_group_code" => $nextProp['groupID'],
                "next_step_num" => $nextProp['num'],
                "step_current" => $stepNumCurrent,
                //                "step_number" => $stepNumCurrent,
                "trash_4" => "1",
                "cancel_dtime" => date("Y-m-d H:i:s"),
                "cancel_name" => $this->session->login['nama'],
                "cancel_id" => $this->session->login['id'],
            );
            $arrData_detail = array(
                "next_substep_code" => $nextProp['code'],
                "next_substep_label" => $nextProp['label'],
                "next_subgroup_code" => $nextProp['groupID'],
                "next_substep_num" => $nextProp['num'],
                "sub_step_number" => 0,
            );

            foreach ($tmpRegData[$no] as $spec) {

                $var = $spec->param;
                $$var = blobDecode($spec->values);
            }


            //region update step yang sebelumnya aktif, transaksi yang dibuka sekarang
            $tp = new MdlTransaksi();
            $dupState = $tp->updateData(array(
                "id" => $no,
            ), $arrData) or die("Failed to update tr next-state!");
            $mongListUpadte['update']['main'][] = array(
                "where" => array("id" => $no,),
                "value" => $arrData,
            );
            cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

            $to = new MdlTransaksi();
            $to->setFilters(array());
            $to->setTableName($to->getTableNames()['detail']);
            $dupState = $to->updateData(array(
                "transaksi_id" => $no,
                "trash" => 0,
            ), $arrData_detail) or die("Failed to update tr next-state!");
            $mongListUpadte['update']['detail'][] = array(
                "where" => array(
                    "transaksi_id" => $no,
                    "trash" => 0,
                ),
                "value" => $arrData_detail,
            );
            cekLime($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

            //endregion


            //region sesuaikan signature untuk cloningan, ikut minus
            $arrSign = array(
                "prev_id" => $no,
                "nomer" => "rejection",
                "step_number" => -$stepNumCurrent, // ini minus step number
                "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($stepNumCurrent)]['target'],
                "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($stepNumCurrent)]['label'],
                "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($stepNumCurrent)]['userGroup'],
                "oleh_id" => $this->session->login['id'],
                "oleh_nama" => $this->session->login['nama'],
                "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($stepNumCurrent)]['label'] . " oleh " . $this->session->login['nama'],
            );
            $dwsign = $tr->writeSignature($tmpTr[0]->id_top, $arrSign) or die("Failed to write signature");
            $mongoList['sign'][] = $dwsign;
            cekPink2($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
            //endregion


            // region netralisasi payment source
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("sisa>0");
            $paymentSrc = $tr->lookupPaymentSrcByTransID($no)->result();
            cekBiru($this->db->last_query());
            if (sizeof($paymentSrc) > 0) {
                foreach ($paymentSrc as $pSpec) {
                    if ($pSpec->terbayar == 0) {
                        $where = array(
                            "id" => $pSpec->id,
                            "transaksi_id" => $pSpec->transaksi_id,
                        );
                        $data = array(
                            "sisa" => 0,
                            "returned" => $pSpec->sisa,
                            "sisa_valas" => 0,
                            "returned_valas" => $pSpec->sisa_valas,
                            "cancel_id" => $this->session->login['id'],
                            "cancel_name" => $this->session->login['nama'],
                            "cancel_dtime" => date("Y-m-d H:i:s"),
                        );

                        $tra = New MdlTransaksi();
                        $tra->setFilters(array());
                        $tra->updatePaymentSrc($where, $data);
                        cekUngu(":: mereject payment source bila ada...");
                        cekUngu($this->db->last_query());
                    }
                    else {
                        mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                    }
                }
            }
            else {
                cekBiru(":: tidak ada payment source... ::");
            }
            // endregion netralisasi payment source

            // region netralisasi extended step
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $exTmp = $tr->lookupExtStepByTrID($no);
            if (sizeof($exTmp) > 0) {
                foreach ($exTmp as $exSpec) {

                    $tra = New MdlTransaksi();
                    $tra->setFilters(array());
                    $tra->rejectExtStepByID($exSpec['id']);
                    $mongListUpadte['update']['extra'][] = array(
                        "where" => array(
                            "id" => $exSpec['id'],
                        ),
                        "value" => array(
                            "state" => "-1",
                        ),
                    );
                    cekUngu(":: mereject extended step bila ada...");
                    cekUngu($this->db->last_query());
                }
            }
            else {
                cekBiru(":: tidak ada extended step... ::");
            }

            // endregion netralisasi extended step

            // region menulis entry point
            if (isset($tableIn_master) && sizeof($tableIn_master) > 0) {
                $tableIn_master['trash_4'] = 1;
                $tableIn_master['deskripsi'] = "rejection";
                $tableIn_master['cancel_dtime'] = date("Y-m-d H:i:s");
                $tableIn_master['cancel_name'] = $this->session->login['nama'];
                $tableIn_master['cancel_id'] = $this->session->login['id'];
                $epID = $tr->writeMainEntries_entryPoint($no, $tableIn_master['id_master'], $tableIn_master);
                $mongoList['main'][] = $epID;
                showLast_query("pink");
                if (isset($tableIn_detail) && sizeof($tableIn_detail) > 0) {
                    $insertIDs = array();
                    foreach ($tableIn_detail as $dSpec) {
                        if ($epID != 999) {
                            $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                            $mongoList['detail'] = $insertIDs;
                            showLast_query("pink2");
                        }
                    }
                }
            }
            // endregion menulis entry point


            //rollback preproc, master
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'])) {
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['master'] : array();
                if (sizeof($iterator) > 0) {
                    $it = 0;
                    cekbiru("ada iterator pre-proc master");
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $it++;
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'] . "_reverse";
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $gateItems = $$srcGateName;

                        echo "reverse master-preproc: $comName, initializing values <br>";
                        $tmpOutParams[$cCtr] = array();


                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $gateItems, $gateItems, 0);
                                $subParams['static'][$key] = $realValue;

                            }

                            if (array_key_exists($oriComName, $prepConfigs)) {
                                if (sizeof($prepConfigs[$oriComName]) > 0) {
                                    foreach ($prepConfigs[$oriComName] as $key => $src) {
                                        $subParams['static'][$key] = makeValue($src, $gateItems, $gateItems, 0);
                                    }
                                }
                            }

                            if (!isset($subParams['static']["transaksi_id"])) {
                                $subParams['static']["transaksi_id"] = $no;
                            }


                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                        }
                        if (sizeof($subParams) > 0) {
                            $tmpOutParams[$cCtr] = $subParams;
                        }


                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);


                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            arrprint($tmpOutParams[$cCtr]);
                            $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();


                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }

                    }
                }
            }
            else {
                cekbiru("TIDAK ada config pre-proc master $jenisTr :: $stepNumCurrent");
            }
            //rollback preproc, detail
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'])) {
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['preProcessor'][$stepNumCurrent]['detail'] : array();
                if (sizeof($iterator) > 0) {
                    $it = 0;
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $it++;
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'] . "_reverse";
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $gateItems = $$srcGateName;

                        echo "reverse preproc (detail): $comName, initializing values <br>";
                        foreach ($gateItems as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();
                            //                        $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $gateItems[$id], $gateItems[$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (array_key_exists($oriComName, $prepConfigs)) {
                                    cekhitam("terdapat di dalam prepConfig");
                                    if (sizeof($prepConfigs[$oriComName]) > 0) {
                                        foreach ($prepConfigs[$oriComName] as $key => $src) {
                                            $subParams['static'][$key] = makeValue($src, $gateItems[$id], $gateItems[$id], 0);
                                        }
                                    }
                                }
                                else {
                                    cekhitam("TIDAK terdapat di dalam prepConfig");
                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $no;
                                }


                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = "rollingback " . $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];
                            }

                            if (sizeof($subParams) > 0) {

                                $tmpOutParams[$cCtr][] = $subParams;
                            }


                            $comName = $tComSpec['comName'] . "_reverse";
                            $srcGateName = $tComSpec['srcGateName'];
                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                            echo "sub preproc #$it: $comName, sending values <br>";

                            $mdlName = "Pre" . ucfirst($comName);
                            $this->load->model("Preprocs/" . $mdlName);
                            $m = new $mdlName($resultParams);


                            if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                $tobeExecuted = true;
                            }
                            else {
                                $tobeExecuted = false;
                            }

                            if ($tobeExecuted) {

                                //                            arrprint($tmpOutParams[$cCtr]);

                                $m->pair($no, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                $gotParams = $m->exec();

                                //                            cekbiru("gotparams");
                                //                            arrprint($gotParams);

                            }
                            else {
                                cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                            }

                        }
                    }
                }
            }
            else {
                cekbiru("TIDAK ada config pre-proc detail $jenisTr :: $stepNumCurrent");
            }
            //rollback postproc, master
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'])) {
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['master'] : array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $gateItems = $$srcGateName;

                        echo "rollback main post-processor: $comName<br>";
                        if (!in_array($comName, $postDeniedConfigs)) {

                            $dSpec = $gateItems;
                            $tmpOutParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {

                                    $realValue = makeValue($value, $gateItems, $gateItems, 0);
                                    $tmpOutParams['loop'][$key] = $realValue;

                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $gateItems, $gateItems, 0);
                                    $tmpOutParams['static'][$key] = $realValue;

                                }
                                if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                    $tmpOutParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                    $tmpOutParams['static']["transaksi_no"] = $insertNum;
                                }

                                $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                                $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$jenisTr]['steps'][$stepNumCurrent]['label'] . " nomor " . $no . " oleh " . $this->session->login['nama'];


                            }
                            if (isset($tComSpec['static2'])) {

                                foreach ($tComSpec['static2'] as $key => $value) {

                                    $realValue = makeValue($value, $gateItems[$cCtr], $gateItems[$cCtr], 0);
                                    $tmpOutParams['static2'][$key] = $realValue;

                                }
                                if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                                    $tmpOutParams['static2']["transaksi_id"] = $insertID;
                                }
                                if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                                    $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                                }

                                $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                                $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                                $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                            }

                            if (array_key_exists($oriComName, $postConfigs)) {
                                if (sizeof($postConfigs[$oriComName]) > 0) {
                                    foreach ($postConfigs[$oriComName] as $key) {
                                        $oldVal = isset($tmpOutParams['static'][$key]) ? $tmpOutParams['static'][$key] : 0;
                                        cekbiru("oldVal: $oldVal");
                                        $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                        cekHijau("newVal: $newVal");
                                        $tmpOutParams['static'][$key] = $newVal;
                                    }
                                }
                            }


                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();

                            cekBiru("kiriman rollback main-postproc $comName");

                            $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);

                        }
                        else {
                            cekHitam("$comName denied");
                        }

                    }
                }
            }
            else {
                cekbiru("TIDAK ada config post-proc master $jenisTr :: $stepNumCurrent");
            }
            //rollback postproc, detail
            if (isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'])) {
                $iterator = isset($this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail']) ? $this->config->item('heTransaksi_core')[$jenisTr]['postProcessor'][$stepNumCurrent]['detail'] : array();
                if (sizeof($iterator) > 0) {
                    cekHitam("cetak iterator :: $jenisTr :: $stepNumCurrent ||");
                    //                    arrPrintWebs($iterator);
                    $iteratorAdd = array();
                    foreach ($iterator as $cCtr => $tComSpec) {
                        if (isset($tComSpec['static']['state']) && ($tComSpec['static']['state'] == '.hold')) {
                            if (isset($tComSpec['static']['oleh_id']) && ($tComSpec['static']['oleh_id'] != '.0')) {
                                // bila state == .hold dan oleh_id != .0, maka dibuatkan ::
                                // HOLD, +QTY, oleh_id dan ACTIVE, -QTY
                                $tComSpecAddHold = $tComSpec;
                                $tComSpecAddActive = $tComSpec;
                                $staticReplaceHold = array(
                                    "jumlah" => "qty",
                                    "transaksi_no" => ".0",
                                );
                                $staticReplaceActive = array(
                                    "jumlah" => "-qty",
                                    "transaksi_id" => ".0",
                                    "nomer" => ".0",
                                    "state" => ".active",
                                    "oleh_id" => ".0",
                                    "oleh_nama" => "",
                                    "transaksi_no" => ".0",
                                );
                                foreach ($staticReplaceHold as $k_rpc => $v_rpc) {
                                    $tComSpecAddHold['static'][$k_rpc] = $v_rpc;
                                }
                                foreach ($staticReplaceActive as $k_rpc => $v_rpc) {
                                    $tComSpecAddActive['static'][$k_rpc] = $v_rpc;
                                }

                                $iteratorAdd[101] = $tComSpecAddHold; // postprocc hold by orang
                                $iteratorAdd[102] = $tComSpecAddActive; // postprocc active
                            }
                        }
                    }

                    if (sizeof($iteratorAdd) > 0) {
                        foreach ($iteratorAdd as $ii => $spec) {
                            $iterator[$ii] = $spec;
                        }
                    }
                    //                    arrPrintWebs($iterator);
                    //
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $gateItems = $$srcGateName;

                        echo "rollback sub-postProcessor: $comName, initializing values <br>";
                        if (!in_array($comName, $postDeniedConfigs)) {

                            $tmpOutParams[$cCtr] = array();
                            foreach ($gateItems as $cnt => $dSpec) {

                                $subParams = array();
                                if (isset($tComSpec['loop'])) {
                                    foreach ($tComSpec['loop'] as $key => $value) {

                                        $realValue = makeValue($value, $gateItems[$cnt], $gateItems[$cnt], 0);
                                        $subParams['loop'][$key] = $realValue;

                                    }
                                }
                                if (isset($tComSpec['static'])) {
                                    foreach ($tComSpec['static'] as $key => $value) {

                                        $realValue = makeValue($value, $gateItems[$cnt], $gateItems[$cnt], 0);
                                        $subParams['static'][$key] = $realValue;

                                    }

                                    if (array_key_exists($oriComName, $postConfigs)) {

                                        if (sizeof($postConfigs[$oriComName]) > 0) {
                                            foreach ($postConfigs[$oriComName] as $key) {

                                                $oldVal = isset($subParams['static'][$key]) ? $subParams['static'][$key] : 0;
                                                $newVal = $oldVal < 0 ? abs($oldVal) : -($oldVal);
                                                $subParams['static'][$key] = $newVal;

                                            }
                                        }
                                    }
                                    else {
                                        //                                cekhitam("TIDAK terdapat di dalam prepConfig");
                                    }


                                    if (!isset($subParams['static']["transaksi_id"])) {
                                        $subParams['static']["transaksi_id"] = $no;
                                    }
                                    if (!isset($subParams['static']["transaksi_no"])) {
                                        $subParams['static']["transaksi_no"] = $no;
                                    }
                                    $subParams['static']["fulldate"] = date("Y-m-d");
                                    $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                    $subParams['static']["keterangan"] = "rollback of $no";
                                }


                                if (sizeof($subParams) > 0) {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                        }
                        else {
                            cekHitam("$comName denied");
                        }
                    }

                    foreach ($iterator as $cCtr => $tComSpec) {
                        $oriComName = $tComSpec['comName'];
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        echo "sub-postProcessor: $comName, sending values <br>";
                        if (!in_array($comName, $postDeniedConfigs)) {

                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();


                            cekBiru("kiriman rollback detail-postproc $comName");
                            arrPrint($tmpOutParams[$cCtr]);
                            $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        }
                        else {
                            cekHitam("$comName denied");
                        }
                    }
                }
            }
            else {
                cekbiru("TIDAK ada config post-proc detail $jenisTr :: $stepNumCurrent");
            }

            //            mati_disini();
        }


        //==================================================================================================
        //==MENGUPDATE LOCKER TRANSAKSI ====================================================================
        $this->load->model("Mdls/MdlLockerTransaksi");
        $lt = New MdlLockerTransaksi();
        $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], $transaksiID_reference, NULL);
        //==================================================================================================


        //        arrPrint($mongListUpadte);
        //        arrPrint($mongoList);

//                mati_disini("DONE :: $cCode :: $jenisTr_con :: $stepNumCurrent");

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        //region connect ke mongoDB
        if (sizeof($mongListUpadte) > 0) {
            $mong = new MdlMongoMother();
            foreach ($mongListUpadte as $metode => $tmpData) {
                if ($metode == "update") {
                    if (sizeof($tmpData) > 0) {
                        foreach ($tmpData as $gate => $fildsData) {
                            //                            arrPrint($fildsData);
                            $mong->setTableName($this->mongoTableList[$gate]);
                            foreach ($fildsData as $mongUpadte) {
                                //                                    cekHitam("update ".$this->mongoTableList[$gate]);
                                //                                    arrPrint( $mongUpadte['value']);
                                //                                    arrPrintWebs($mongUpadte['where']);
                                $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                            }
                        }
                    }
                }

            }
        }
        if (sizeof($mongoList) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongoList as $gateList => $listIDSData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$gateList]);
                $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$gateList]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        //                        cekLime("ninsert into :".$this->mongoTableList[$gateList]);
                        //                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }

            }
        }

        //endregion

        if (isset($_SESSION[$cCode])) {
            unset($_SESSION[$cCode]);
        }
        if (isset($oldCode)) {
            if (isset($_SESSION[$oldCode])) {
                unset($_SESSION[$oldCode]);
            }
        }
        $arrAlert = array(
            "type" => "success",
            "title" => "Transaction updated",
            //                        "html" => "your order has been saved and ready to process",
            "html" => $this->session->errMsg,
            "timer" => "1500",
            "showConfirmButton" => false,
            "allowOutsideClick" => false,
        );

        echo swalAlert($arrAlert);
        echo "<script>topReload(1500)</script>";
        echo topReload();
        echo "</script>";
        unset($this->session->errMsg);

    }

    // ------------------------------------------------------------

    public function dontFollowup()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $no = $this->uri->segment(3);
        $jenisTr = $this->uri->segment(4);
        $masterTargetStepNum = $this->uri->segment(5);
        $childTargetStepNum = $this->uri->segment(6);
        $stepNumCurrent = $this->uri->segment(7);
        $cCode = "_TR_" . $this->jenisTr;

        echo "no: $no<br>";
        echo "masterTargetStepNum: $masterTargetStepNum<br>";
        echo "childTargetStepNum: $childTargetStepNum<br>";
        echo "stepNumCurrent: $stepNumCurrent<br>";


        $this->db->trans_start();

        //
        //region update step2an di masternya

        $nextMasterStep = $stepNumCurrent;
        echo "nextMasterStep: $nextMasterStep<br>";
        $nextProp = array(
            "num" => $nextMasterStep,
            "code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['target'],
            "label" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['label'],
            "groupID" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextMasterStep]['userGroup'],
        );
        $tr = new MdlTransaksi();
        $dupState = $tr->updateData(array("id" => $no), array(
            "next_step_code" => $nextProp['code'],
            "next_step_label" => $nextProp['label'],
            "next_group_code" => $nextProp['groupID'],
            "next_step_num" => $nextProp['num'],
            "step_current" => $masterTargetStepNum,

        )) or die("Failed to update tr next-state!");
        cekHijau($this->db->last_query());
        //endregion


        //region update step2an di childnya
        $tru = new MdlTransaksi();
        $tru->setFilters(array());
        $tru->setTableName($tru->getTableNames()['detail']);


        $dupState = $tru->updateData(array(
            "transaksi_id" => $no,
        ), array(
            "next_substep_code" => $nextProp['code'],
            "next_substep_label" => $nextProp['label'],
            "next_subgroup_code" => $nextProp['groupID'],
            "next_substep_num" => $nextProp['num'],
            "sub_step_current" => $masterTargetStepNum,
        )) or die("Failed to update previous detail entries!");
        cekHijau($this->db->last_query());
        unset($tru);
        //endregion


        //region update step yang sebelumnya aktif
        $tr = new MdlTransaksi();
        $dupState = $tr->updateData(array("id_master" => $no, "step_number" => $stepNumCurrent), array(
            "step_number" => $childTargetStepNum,

        )) or die("Failed to update tr next-state!");
        cekHijau($this->db->last_query());
        //endregion

        //
        //region update nomor step di cloningan jadi minus current
        //endregion
        //
        //region sesuaikan signature untuk cloningan, ikut minus
        $dwsign = $tr->writeSignature($no, array(
            "nomer" => "rejection",
            "step_number" => $childTargetStepNum,
            "step_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['target'],
            "step_name" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'],
            "group_code" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['userGroup'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "keterangan" => $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][abs($childTargetStepNum)]['label'] . " oleh " . $this->session->login['nama'],
            "transaksi_id" => $masterID,
        )) or die("Failed to write signature");
        cekKuning($this->db->last_query());
        //endregion

        //==tampilkan receipt
        cekOrange("-- DONE --");
        //        die();
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        $_SESSION[$cCode] = null;
        unset($_SESSION[$cCode]);
        if (isset($oldCode)) {
            $_SESSION[$oldCode] = null;
            unset($_SESSION[$oldCode]);
        }
        //region feedback msg
        $this->session->errMsg = "transaction entry has been rejected<br>";
        $nextNum = $nextProp["num"];
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $this->session->errMsg .= "This entry needs to followed-up by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;

        }
        else {
            $this->session->errMsg .= "cannot detect transaction state<br>";
            $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;

        }
        $trBackClick = "location.href='$trBackLink'";
        $this->session->errMsg .= "<a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
        //endregion
        echo "<script>";
        //        echo "top.window.open('" . base_url() . "Transaksi/viewReceipt/$tmpNomorNota');";
        echo "top.location.reload();";
        echo "</script>";

    }

    public function previewValue()
    {

        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $jenisTr = $this->uri->segment(3);
        $masterID = $this->uri->segment(4);
        $valID = $this->uri->segment(5);
        $this->load->model("MdlTransaksi");
        $trA = new MdlTransaksi();
        $extSteps = $trA->lookupExtStepByID($valID);
        $rawPrevURL = $_GET['rawPrev'];
        $rawBuilderURL = $_GET['rawBuilderURL'];

        //arrprint($_GET);

        if (sizeof($extSteps) > 0) {
            //            cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
            $xSpec = $extSteps[0];
            echo "<h4 class='text-center'>" . $xSpec['label'] . " has been proposed at " . formatField("dtime", $xSpec['proposed']['time']);
            echo "</h4>";

            echo "<h6 class='text-center'>here are the details</h6>";


            echo "<table class='table table-condensed'>";

            //            foreach ($extSteps as $xSpec) {
            echo "<tr>";
            echo "<td bbgcolor='#f0f0f0'>value name</td>";
            echo "<td>" . $xSpec['label'] . "</td>";
            echo "</tr>";

            echo "<tr>";
            echo "<td bbgcolor='#f0f0f0'>amount</td>";
            echo "<td align='right'><input type='text' class='form-control text-right' readonly value='" . number_format($xSpec['value']) . "'></td>";
            echo "</tr>";

            if (in_array($xSpec['groupID'], $mems)) {
                echo "<tr>";
                echo "<td>";
                echo "<a class='btn btn-warning btn-block' onclick=\"if(confirm('Rejecting this " . $xSpec['label'] . " will delete this value and can not be undone. \\nContinue rejecting?')==1){top.$('#result').load('" . base_url() . get_class($this) . "/dontSaveValue/$jenisTr/$masterID/$valID/" . $xSpec['key'] . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL');}\">reject " . $xSpec['label'] . "</a>";
                echo "</td>";
                echo "<td align='right'>";
                echo "<a class='btn btn-success btn-block' onclick=\"if(confirm('Approving this " . $xSpec['label'] . " value will add this value into this transaction. \\nContinue approving?')==1){top.$('#result').load('" . base_url() . get_class($this) . "/saveValue/$jenisTr/$masterID/$valID/" . $xSpec['value'] . "?rawPrev=$rawPrevURL');}\">approve " . $xSpec['label'] . "</a>";
                echo "</td>";
                echo "</tr>";
            }
            else {
                echo "<tr>";
                echo "<td colspan='2' align='center'>you are not allowed to approve this value</td>";
                echo "</tr>";
            }

            //            }
            echo "</table>";
        }
        else {
            die("no such value!");
        }

    }

    public function saveValue()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $jenisTr = $this->uri->segment(3);
        $masterID = $this->uri->segment(4);
        $valID = $this->uri->segment(5);
        $valValue = $this->uri->segment(6);

        $rawPrevURL = $_GET['rawPrev'];
        $prevUrl = blobDecode($rawPrevURL);

        //        cekmerah($rawPrevURL);


        $this->load->model("MdlTransaksi");
        $trA = new MdlTransaksi();
        //        cekmerah("$masterID / $valID / $valValue");

        $xProp = $trA->lookupExtStepByID($valID);

        //        cekbiru($xProp[0]['key'].": $valValue");

        $this->db->trans_start();

        $trA->approveExtStepByID($valID) or die(lgShowAlert("unable to mark the approval sign into this entry"));

        cekhijau($this->db->last_query());

        //write signature
        //==tulis signature

        //        print_r($xProp);

        $dwsign = $trA->writeSignature($masterID, array(
            "nomer" => "0.0.0.0",
            "step_number" => "99",
            "step_code" => $jenisTr . "_",
            "step_name" => $xProp[0]['label'] . " approval",
            "group_code" => $xProp[0]['groupID'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "keterangan" => $xProp[0]['label'] . " approval by " . $this->session->login['nama'],
            "transaksi_id" => $masterID,
        )) or die("Failed to write signature");
        cekKuning($this->db->last_query());

        cekOrange("-- DONE --");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
                                   {
                                       title:'Followup preview',
                                       message: " . 'top.$' . "('<div></div>').load('$prevUrl'),
                                        size:top.BootstrapDialog.SIZE_WIDE,                                        
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
        //        echo "</script>";


        //==cek, perlukah langsung membuka payment untuk nilai yang bersangkutan
        $paySrcs = $trA->lookupPaymentSrcs($masterID, $jenisTr . "_", $xProp[0]['key']);
        cekkuning("paySrcs");
        //        arrprint($paySrcs);
        if (sizeof($paySrcs) > 0) {
            foreach ($paySrcs as $xSpec) {
                if ($xSpec['sisa'] > 0) {
                    $xSpec['groupID'] = $this->config->item("heTransaksi_ui")[$xSpec['targetJenis']]['steps'][1]['userGroup'];
                    if (in_array($xSpec['groupID'], $mems)) {
                        $actionTarget .= "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'do " . $xSpec['label'] . "',
                                       message: " . 'top.$' . "('<div></div>').load('" . base_url() . "Transaksi/selectPaymentSrc/" . $xSpec['targetJenis'] . "/" . $xSpec['extID'] . "/$masterID?rawPrev=$rawPrevURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-default' href='javascript:void(0)' onclick=\"$actionTarget\">do " . $xSpec['label'] . "</a>";
                    }
                }
            }
        }

        //        echo "<html>";
        //        echo "<head>";
        //        echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
        //        echo "</head>";
        echo "<script>top.close_holdon();$actionTarget</script>";

        //        echo "</body>";
        //        echo "</html>";


    }

    public function addValue()
    {

        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $jenisTr = $this->uri->segment(3);
        $masterID = $this->uri->segment(4);
        $valID = $this->uri->segment(5);
        $this->load->model("MdlTransaksi");
        $trA = new MdlTransaksi();
        $extSteps = $trA->lookupExtStepByID($valID);
        $rawPrevURL = $_GET['rawPrev'];
        $rawBuilderURL = $_GET['rawBuilderURL'];

        //arrprint($_GET);

        if (sizeof($extSteps) > 0) {
            //            cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
            $xSpec = $extSteps[0];
            echo "<h4 class='text-center'>" . $xSpec['label'] . " has been proposed at " . formatField("dtime", $xSpec['proposed']['time']);
            echo "</h4>";

            echo "<h6 class='text-center'>here are the details</h6>";


            echo "<table class='table table-condensed'>";

            //            foreach ($extSteps as $xSpec) {
            echo "<tr>";
            echo "<td bbgcolor='#f0f0f0'>value name</td>";
            echo "<td>" . $xSpec['label'] . "</td>";
            echo "</tr>";

            echo "<tr>";
            echo "<td bbgcolor='#f0f0f0'>amount</td>";
            echo "<td align='right'><input type='text' class='form-control text-right' readonly value='" . number_format($xSpec['value']) . "'></td>";
            echo "</tr>";

            if (in_array($xSpec['groupID'], $mems)) {
                echo "<tr>";
                echo "<td>";
                echo "<a class='btn btn-warning btn-block' onclick=\"if(confirm('Rejecting this " . $xSpec['label'] . " will delete this value and can not be undone. \\nContinue rejecting?')==1){top.$('#result').load('" . base_url() . get_class($this) . "/dontSaveValue/$jenisTr/$masterID/$valID/" . $xSpec['key'] . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL');}\">reject " . $xSpec['label'] . "</a>";
                echo "</td>";
                echo "<td align='right'>";
                echo "<a class='btn btn-success btn-block' onclick=\"if(confirm('Approving this " . $xSpec['label'] . " value will add this value into this transaction. \\nContinue approving?')==1){top.$('#result').load('" . base_url() . get_class($this) . "/saveValue/$jenisTr/$masterID/$valID/" . $xSpec['value'] . "?rawPrev=$rawPrevURL');}\">approve " . $xSpec['label'] . "</a>";
                echo "</td>";
                echo "</tr>";
            }
            else {
                echo "<tr>";
                echo "<td colspan='2' align='center'>you are not allowed to approve this value</td>";
                echo "</tr>";
            }

            //            }
            echo "</table>";
        }
        else {
            die("no such value!");
        }

    }

    public function dontSaveValue()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $jenisTr = $this->uri->segment(3);
        $masterID = $this->uri->segment(4);
        $valID = $this->uri->segment(5);
        $key = $this->uri->segment(6);

        $rawPrevURL = $_GET['rawPrev'];
        $prevUrl = blobDecode($rawPrevURL);
        $builderUrl = blobDecode($_GET['rawBuilderURL']);

        //        cekmerah($rawPrevURL);


        $this->load->model("MdlTransaksi");
        $trA = new MdlTransaksi();
        //        cekmerah("$masterID / $valID / $valValue");

        $xProp = $trA->lookupExtStepByID($valID);

        //        cekbiru($xProp[0]['key'].": $valValue");

        $this->db->trans_start();

        $trA->rejectExtStepByID($valID) or die(lgShowAlert("unable to mark the approval sign into this entry"));

        cekhijau($this->db->last_query());

        //write signature
        //==tulis signature

        //        print_r($xProp);

        $dwsign = $trA->writeSignature($masterID, array(
            "nomer" => "0.0.0.0",
            "step_number" => "99",
            "step_code" => $jenisTr . "_",
            "step_name" => $xProp[0]['label'] . " rejection",
            "group_code" => $xProp[0]['groupID'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "keterangan" => $xProp[0]['label'] . " rejection by " . $this->session->login['nama'],
            "transaksi_id" => $masterID,
        )) or die("Failed to write signature");
        cekKuning($this->db->last_query());


        //        $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
        //                                   {
        //                                       title:'Followup preview',
        //                                       message: " . '$' . "('<div></div>').load('$prevUrl'),
        //                                        size:top.BootstrapDialog.SIZE_WIDE,
        //                                        draggable:false,
        //                                        closable:true,
        //                                        }
        //                                        );";

        $actionTarget = "top.$('#result').load('$builderUrl');";

        //        echo "</script>";


        //==menghapus payment untuk nilai yang bersangkutan (if any)
        $paySrcs = $trA->lookupPaymentSrcs($masterID, $jenisTr . "_", $xProp[0]['key']);
        cekkuning("paySrcs");
        //        arrprint($paySrcs);
        if (sizeof($paySrcs) > 0) {
            foreach ($paySrcs as $xSpec) {
                $this->load->model("Mdls/MdlPaymentSource");
                $l = new MdlPaymentSource();
                $insertIDs[] = $l->updateData(array(
                    "id" => $xSpec['id'],
                ), array("sisa" => 0,));
                cekHijau($this->db->last_query());
            }
        }

        //==update nilai2 yang dihapus ini dari registri
        $trr = new MdlTransaksi();
        $trr->setFilters(array());
        $trr->addFilter("transaksi_id='$masterID'");
        $trr->addFilter("param='main_inputs'");
        $tmpReg = $trr->lookupRegistries()->result();
        if (sizeof($tmpReg) > 0) {
            cekkuning("ada registri milik $key yang perlu didepak!");

            foreach ($tmpReg as $row) {
                $oldValues = unserialize(base64_decode($row->values));
                $baseRegistries['main_inputs'] = $oldValues;
                $trr->updateRegistry(array(
                    "id" => $row->id,
                ), array(
                    "transaksi_id" => -($masterID),
                ));
                $baseRegistries['main_inputs'][$key] = 0;


            }
            $doWriteReg = $trr->writeRegistries($masterID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
        }
        else {
            cekkuning("registri: no depak depak club!");
        }

        cekOrange("-- DONE --");
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

        //        echo "<html>";
        //        echo "<head>";
        //        echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
        //        echo "</head>";
        echo "<script>top.close_holdon();$actionTarget</script>";

        //        echo "</body>";
        //        echo "</html>";


    }

    public function doFollowup()
    {

        echo "<script>top.writeProgress('MEMULAI PROSES FOLLOWUP....');</script>";
        $starttime = microtime(true);
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $transaksiID_reference = $no = rtrim($this->uri->segment(3), "-");
        $stepNum = $this->uri->segment(4);
        $stepNumCurrent = $this->uri->segment(5);


        echo "<script>top.writeProgress('MEMUAT CONFIG', 'HEAD');</script>";

        $paramPatchers = $this->config->item('heTransaksi_paramPatchers') != null ? $this->config->item('heTransaksi_paramPatchers') : array();
        $paramForceFillers = $this->config->item('heTransaksi_paramForceFillers') != null ? $this->config->item('heTransaksi_paramForceFillers') : array();

        echo "<script>top.writeProgress('MENYIAPKAN CALCULATOR', 'HEAD');</script>";

        $this->load->library("FieldCalculator");
        $cal = new FieldCalculator();

        echo "<script>top.writeProgress('MENYIAPKAN DATA-DATA TRANSAKSI', 'HEAD');</script>";

        //==ambil datanya
        $stepNowParameter = array();
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tr->addFilter("step_number='" . $stepNumCurrent . "'");
        $tr->addFilter("transaksi_data.trash='0'");
        $tmpTr = $tr->lookupJoined()->result();
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;

            $cCode = "_TR_" . $this->jenisTr;
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            $_SESSION[$cCode]['rsltItems'] = array();
            $_SESSION[$cCode]['rsltItems2'] = array();
            //endregion

            $detailValuesConfig = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] : array();
            $additionalData = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addDetailData"][$stepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addDetailData"][$stepNum] : array();

            $masterID = $_SESSION[$cCode]['main']['masterID'];
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;

            //            $trID = $tmpTr[0]->id_master;
            $trID = $tmpTr[0]->transaksi_id;


            $totalSteps = sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']);


            //==references, previous entry
            $prevProp = array(
                "id" => $tmpTr[0]->transaksi_id,
                "jenis" => $tmpTr[0]->jenis,
                "nomer" => $tmpTr[0]->nomer,
            );


            //------
            $stepNowParameter = array(
                "next_step_code" => $tmpTr[0]->next_step_code,
                "next_step_label" => $tmpTr[0]->next_step_label,
                "next_group_code" => $tmpTr[0]->next_group_code,
                "next_step_num" => $tmpTr[0]->next_step_num,
                "step_current" => $tmpTr[0]->step_current,
            );


            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }


            $main = array();
            $items = array();
            $prevIDs = array();
            $prevNos = array();
            foreach ($tmpTr as $row) {
                $items[$row->produk_id] = array(
                    "id" => $row->produk_id,
                    "nama" => $row->produk_nama,
                    "jml" => $row->produk_ord_jml,
                    "harga" => $row->produk_ord_hrg,
                    "valid_qty" => $row->valid_qty,
                    "transaksi_id" => $row->transaksi_id,
                    "nomer" => $row->nomer,
                );

                if ($row->valid_qty > 0) {
                    cekHitam("ok lanjut");
                }
                else {
                    if (isset($_SESSION[$cCode]['items'][$row->produk_id])) {
                        matiHere("Followed up already. Please close and refresh your browser " . $row->produk_nama . " " . $row->produk_id);//kalo session active ya harus dimatiin biar gak dobel
                    }
                }

                if (!in_array($row->transaksi_id, $prevIDs)) {
                    $prevIDs[] = $row->transaksi_id;
                }
                if (!in_array($row->nomer, $prevNos)) {
                    $prevNos[] = $row->nomer;
                }
                if (sizeof($detailValuesConfig) > 0) {
                    echo "detail values ada..<br>";
                    foreach ($detailValuesConfig as $key => $src) {
                        echo "$key akan ambil nilai dari $src<br>";
                        echo "<script>top.writeProgress('$key akan ambil nilai dari $src');</script>";
                        //                            $tmp[$key]=isset($iSpec[$val])?$iSpec[$val]:0;
                        if (isset($detailValues[$row->produk_id][$key])) {
                            //                            $tmp[$key] = formatField($key, $detailValues[$row->produk_id][$key]);
                            $items[$row->produk_id][$key] = $detailValues[$row->produk_id][$key];
                        }
                        else {
                            if (isset($row->$key)) {
                                //                                $tmp[$key] = formatField($key, $row->$key);
                                $items[$row->produk_id][$key] = $row->$key;
                            }
                        }
                        echo "dan sekarang nilainya: " . $items[$row->produk_id][$key] . "<br>";
                        echo "<script>top.writeProgress('dan sekarang nilainya: " . $items[$row->produk_id][$key] . "');</script>";
                    }
                }
            }

        }
        else {
            $masterID = 0;
            $tmpNomorNota = "XXXX";
            $origJenis = 0;
            $topID = 0;
            die(lgShowAlert("No such receipt ID: $no!"));
        }


        //==ongkir dll (additional fees) harus diselipkan kedalam masterGates aktual
        //region ongkir dll diselipkan ke masterGates
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exKey => $exSpec) {
                if ($exSpec['useAt'] == $stepNum) {
                    if (isset($exSpec['mdlName']) && strlen($exSpec['mdlName']) > 3) {
                        $_SESSION[$cCode]['main'][$exKey . "_src"] = $_POST[$exKey . "_src"];
                        if (isset($_SESSION[$cCode]['main_add_values'][$exKey . "_src"])) {
                            $_SESSION[$cCode]['main_add_values'][$exKey . "_src"] = $_POST[$exKey . "_src"];
                        }
                    }
                    $_SESSION[$cCode]['main'][$exKey] = $_POST[$exKey];
                    if (isset($_SESSION[$cCode]['main_add_values'][$exKey])) {
                        $_SESSION[$cCode]['main_add_values'][$exKey] = $_POST[$exKey];
                    }

                    if ($exSpec['taxFactor'] > 0) {
                        $_SESSION[$cCode]['main'][$exKey . "_tax"] = $_POST[$exKey . "_tax"];
                        if (isset($_SESSION[$cCode]['main_add_values'][$exKey . "_tax"])) {
                            $_SESSION[$cCode]['main_add_values'][$exKey . "_tax"] = $_POST[$exKey . "_tax"];
                        }
                    }
                }
            }
        }
        //endregion


        //region baca seting optional step
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['optCriteriaField']) && strlen($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['optCriteriaField']) > 0) {
            echo "<script>top.writeProgress('READING OPTIONAL STEPs', 'HEAD');</script>";
            $criteriaField = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['optCriteriaField'];
            if (isset($_SESSION[$cCode]['main'][$criteriaField]) && $_SESSION[$cCode]['main'][$criteriaField] > 0) {
                echo "nextstepnum normal<br>";
                $nextStepNum = ($stepNum + 1);
                $useAdditionalStep = true;
            }
            else {
                echo "nextstepnum hampir normal<br>";
                $useAdditionalStep = false;
                $nextStepNum = ($stepNum + 2);
            }
        }
        else {
            //            //cekBiru("OPT TIDAK ditentukan");
            echo "nextstepnum TIDAK normal<br>";
            $useAdditionalStep = false;
            $nextStepNum = ($stepNum + 1);
            echo "yaitu $nextStepNum<br>";
        }
        //endregion


        //region build table rekening
        $buildTablesMaster = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master'] : array();
        $buildTablesDetail = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail'] : array();
        //arrPrint($buildTablesMaster);

        $addMasterTables = array(
            "rugilaba",
            "laba ditahan",
            "rugilaba lain lain",
        );
        foreach ($addMasterTables as $trek) {
            $buildTablesMaster[] = array(
                "comName" => "RugiLaba",
                "loop" => array(
                    "$trek" => .0,
                ),
            );
        }

        if (sizeof($buildTablesMaster) > 0) {
            foreach ($buildTablesMaster as $buildTablesMaster_specs) {
                $mdlName = $buildTablesMaster_specs['comName'];
                if (substr($mdlName, 0, 1) == "{") {
                    //                        cekkuning("mengandung kurawal");
                    $mdlName = trim($mdlName, "{");
                    $mdlName = trim($mdlName, "}");
                    $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                }
                else {
                    //                        cekkuning("TIDAK mengandung kurawal");
                }
                $mdlName = "Com" . $mdlName;
                cekHitam("model: $mdlName");


                if (isset($buildTablesMaster_specs['loop'])) {
                    foreach ($buildTablesMaster_specs['loop'] as $key => $val) {
                        unset($buildTablesMaster_specs['loop'][$key]);
                        //                        if (isset($_SESSION[$cCode]['main'][$key])) {
                        if (substr($key, 0, 1) == "{") {
                            $key = trim($key, "{");
                            $key = trim($key, "}");
                            $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                        }
                        $buildTablesMaster_specs['loop'][$key] = $val;
                        //                        }
                    }
                }

                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();
                if (method_exists($m, "getTableNameMaster")) {
                    if (sizeof($m->getTableNameMaster())) {
                        $m->buildTables($buildTablesMaster_specs);
                    }
                }
            }
        }

        if (sizeof($buildTablesDetail) > 0) {
            foreach ($buildTablesDetail as $buildTablesDetail_specs) {
                foreach ($_SESSION[$cCode]['items'] as $itemSpec) {

                    $mdlName = $buildTablesDetail_specs['comName'];
                    if (substr($mdlName, 0, 1) == "{") {
                        $mdlName = trim($mdlName, "{");
                        $mdlName = trim($mdlName, "}");
                        $mdlName = str_replace($mdlName, $itemSpec[$mdlName], $mdlName);
                    }

                    if (isset($buildTablesDetail_specs['loop'])) {
                        foreach ($buildTablesDetail_specs['loop'] as $key => $val) {
                            unset($buildTablesDetail_specs['loop'][$key]);

                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $itemSpec[$key], $key);
                            }
                            $buildTablesDetail_specs['loop'][$key] = $val;
                            cekHitam("LINE: " . __LINE__ . " ::sini bukan??  akan build tabel detail $key");

                        }
                    }


                    $mdlName = "Com" . $mdlName;
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();
                    if (method_exists($m, "getTableNameMaster")) {
                        if (sizeof($m->getTableNameMaster())) {
                            $m->buildTables($buildTablesDetail_specs);
                            arrPrint($buildTablesDetail_specs);
                            cekHitam(":: build tabel detail");
                        }
                    }
                }
            }
        }
        //endregion


        $this->db->trans_start();

        //region pembulatan replacer disini
        $injectBulat = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['valuePembulatan'][$stepNum]) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['valuePembulatan'][$stepNum] : array();
        if (sizeof($injectBulat) > 0) {
            echo "<script>top.writeProgress('PEMBULATAN', 'HEAD');</script>";
            //            arrPrint($injectBulat);
            $selectedSource = $injectBulat['source'];
            $injectSource = makeDppBulat($_SESSION[$cCode]['main'][$selectedSource]);
            foreach ($injectBulat['replacer'] as $k => $fields) {
                $_SESSION[$cCode]['main'][$fields] = $injectSource[$k];
                echo "<script>top.writeProgress('PEMBULATAN ($fields)');</script>";
            }

        }
        //endregion


        cekMerah(":: MEMULAI PRE-PROCC ITEMS...");


        //region pre-processors (item)
        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['detail'])) {
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['detail'] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNum] : array();
            echo "ITEM NUM LABELS";

            if (sizeof($iterator) > 0) {
                echo "<script>top.writeProgress('PERSIAPAN PRE-PROCESSOR...', 'HEAD');</script>";
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo __LINE__ . " :: sub-preproc: $comName, initializing values <br>";

                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                        $tmpOutParams[$cCtr] = array();
                        //                        $id = $dSpec['id'];
                        $id = $xid;
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['static'][$key] = $realValue;

                            }

                            if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                foreach ($paramPatchers[$comName] as $k => $v) {
                                    if (!isset($subParams['static'][$k])) {
                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                    }
                                }
                            }
                            if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                $jenis = $_SESSION[$cCode]['main']['jenis'];
                                foreach ($paramForceFillers[$comName] as $k => $v) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                        }

                        if (sizeof($subParams) > 0) {

                            $tmpOutParams[$cCtr][] = $subParams;
                        }


                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                        echo "sub preproc #$it: $comName, sending values <br>";

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);
                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();
                            cekHitam(":: PRE-PROCC -> GOTNAME, ITERATING...");
                            arrprint($gotParams);
                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $paramSpec) {

                                    if (!isset($_SESSION[$cCode][$gateName])) {
                                        $_SESSION[$cCode][$gateName] = array();
                                        //                                    cekhijau("building the session: $gateName");
                                    }
                                    else {
                                        //                                    cekhijau("NOT building the session: $gateName");
                                    }

                                    foreach ($paramSpec as $id => $gSpec) {
                                        //                                        $id = $gSpec['id'];
                                        if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                            $_SESSION[$cCode][$gateName][$id] = array();
                                        }

                                        if (isset($_SESSION[$cCode][$gateName][$id])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                }
                                            }
                                        }
                                        //==inject gotParams to child gate
                                        if ($gateName == $srcGateName) {
                                            if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                                if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                    foreach ($gSpec as $key => $val) {
                                                        $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                    }
                                                }
                                            }
                                        }

                                        //cekMerah("REBUILDING VALUES..");
                                        if (sizeof($itemNumLabels) > 0) {
                                            //cekHijau("REBUILDING SUBS FOR ITEMS");
                                            foreach ($itemNumLabels as $key => $label) {
                                                //cekHere("$id === $key => $label");
                                                $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                //                                        die();
                                            }
                                        }
                                    }
                                    //                                    arrPrint($_SESSION[$cCode][$gateName]);die();
                                }
                            }

                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }

                    $this->load->helper("he_value_builder");
                    fillValues($this->jenisTr, $stepNumCurrent, $stepNum);
                }
            }
            else {
                //cekKuning("sub-preproc is not set");
            }


            $this->load->helper("he_value_builder");
            fillValues($this->jenisTr, $stepNumCurrent, $stepNum);
        }
        else {
            echo("no processor defined. skipping preprocessor..<br>");
        }

        //endregion

        // matiHEre(__LINE__);
        //region pre-processors (master)
        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['master'])) {
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['master'] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();

            echo "ITEM NUM LABELS";

            if (sizeof($iterator) > 0) {
                echo "<script>top.writeProgress('PERSIAPAN PRE-PROCESSOR...', 'HEAD');</script>";
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                    $switchResultParams = isset($tComSpec['switchResultParams']) ? $tComSpec['switchResultParams'] : false;

                    echo "master-preproc: $comName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();


                    $subParams = array();
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $subParams['static'][$key] = $realValue;

                        }

                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            foreach ($paramPatchers[$comName] as $k => $v) {
                                if (!isset($subParams['static'][$k])) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }
                        }
                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }

                        $subParams['static']["fulldate"] = date("Y-m-d");
                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }
                    if (sizeof($subParams) > 0) {
                        $tmpOutParams[$cCtr] = $subParams;
                    }


                    $mdlName = "Pre" . ucfirst($comName);
                    $this->load->model("Preprocs/" . $mdlName);
                    $m = new $mdlName($resultParams);


                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    if ($tobeExecuted) {
                        $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $gotParams = $m->exec();

                        cekbiru("gotparams dari $comName");
                        arrprint($gotParams);

                        if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                            cekhijau("ada gotparam, sekarang mau replace");
                            foreach ($gotParams as $gateName => $gSpec) {

                                if ($switchResultParams == true) {
                                    foreach ($gSpec as $id => $ggSpec) {
                                        if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                            $_SESSION[$cCode][$gateName][$id] = array();
                                        }
                                        if (isset($_SESSION[$cCode][$gateName][$id])) {
                                            if (is_array($ggSpec) && sizeof($ggSpec) > 0) {
                                                foreach ($ggSpec as $key => $val) {
                                                    $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                }
                                            }
                                        }
                                        //cekMerah("REBUILDING VALUES..");
                                        if (sizeof($itemNumLabels) > 0) {
                                            //cekHijau("REBUILDING SUBS FOR ITEMS");
                                            foreach ($itemNumLabels as $key => $label) {
                                                //cekHere("$id === $key => $label");
                                                if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                    $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                }
                                            }
                                        }
                                    }
                                }
                                else {

                                    if (isset($_SESSION[$cCode]['main'])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                cekbiru("injecting param $key with $val");
                                                $_SESSION[$cCode]['main'][$key] = $val;
                                            }
                                        }
                                    }
                                    //==inject gotParams to child gate
                                    if (isset($_SESSION[$cCode]['main'])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $_SESSION[$cCode]['main'][$key] = $val;
                                            }
                                        }
                                    }
                                }

                            }
                        }
                        else {
                            cekmerah("TIDAK ada gotparam, tidak perlu replace");
                        }

                    }
                    else {
                        cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                    }
                }
            }
            else {
                //cekKuning("sub-preproc is not set");
            }


            $this->load->helper("he_value_builder");
            fillValues($this->jenisTr, $stepNumCurrent, $stepNum);


        }
        else {
            echo("no processor defined. skipping preprocessor..<br>");
        }

        //endregion

        //region pre-proc value injector items2 items2_sum dari gerbang main
        $injectValues = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preInjectValue'][$stepNum]) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preInjectValue'][$stepNum] : array();
        if (sizeof($injectValues) > 0) {
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preInjectValue'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preInjectValue'][$stepNum]['master'] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                    //                    echo "master-preproc: $comName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();


                    $subParams = array();
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $subParams['static'][$key] = $realValue;

                        }

                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            foreach ($paramPatchers[$comName] as $k => $v) {
                                if (!isset($subParams['static'][$k])) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }
                        }
                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }

                        $subParams['static']["fulldate"] = date("Y-m-d");
                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }
                    if (sizeof($subParams) > 0) {
                        $tmpOutParams[$cCtr] = $subParams;
                    }


                    $mdlName = "Pre" . ucfirst($comName);
                    $this->load->model("Preprocs/" . $mdlName);
                    $m = new $mdlName($resultParams);


                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    if ($tobeExecuted) {
                        $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $gotParams = $m->exec();
                        if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                            //                            cekhijau("ada gotparam, sekarang mau replace");
                            foreach ($gotParams as $gateName => $gSpec) {
                                if ($gateName == "main") {
                                    foreach ($gSpec as $key => $val) {
                                        $_SESSION[$cCode]['main'][$key] = $val;
                                    }
                                }
                                if ($gateName == "items2") {
                                    foreach ($_SESSION[$cCode]['items2'] as $k => $tmpSes) {
                                        foreach ($gSpec as $key => $val) {
                                            foreach ($tmpSes as $y => $sesData) {
                                                if (array_key_exists($key, $sesData)) {
                                                    $_SESSION[$cCode]['items2'][$k][$y][$key] = $val;
                                                }
                                            }
                                        }
                                    }

                                }
                                if ($gateName == "items2_sum") {
                                    foreach ($_SESSION[$cCode]['items2_sum'] as $k => $tmpSes) {
                                        foreach ($gSpec as $key => $val) {
                                            $_SESSION[$cCode]['items2_sum'][$k][$key] = $val;
                                        }
                                    }

                                }

                            }
                        }
                        else {
                            cekmerah("TIDAK ada gotparam, tidak perlu replace");
                        }

                    }
                    else {
                        cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                    }

                }
            }
            else {
                //cekKuning("sub-preproc is not set");
            }

            $this->load->helper("he_value_builder");
            fillValues($this->jenisTr, $stepNumCurrent, $stepNum);

        }
        //endregion

//mati_disini(get_class($this));
        $this->midValidate();

        $this->unionValidate();
        //==tulis komponen, if any


        //region update step2an
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum])) {//===masih ada langkah selanjutnya
            echo "authorizing to next step..<br>";
            $nextProp = array(
                "num" => $nextStepNum,
                "code" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum]['target'],
                "label" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum]['label'],
                "groupID" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum]['userGroup'],
            );
        }
        else {//==ini step terakhir, tulis komponen jika ada

            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
        }
        //endregion


        echo "checking components..<br>";
        echo "<script>top.writeProgress('CHECKING KOMPONEN');</script>";
        //referensi_id pada steps (dimatikan)
        //        $masterReplacers = array(
        //            "referensi_id" => $masterID,
        //        );
        //        $childReplacers = array(
        //            "referensi_id" => $masterID,
        //        );
        //        foreach ($masterReplacers as $key => $val) {
        //            $_SESSION[$cCode]['main'][$key] = $val;
        //        }
        //        foreach ($childReplacers as $key => $val) {
        //            foreach ($_SESSION[$cCode]['out_detail'] as $xid => $cSpec) {
        //                $id = $cSpec['id'];
        //                $_SESSION[$cCode]['out_detail'][$id][$key] = $val;
        //            }
        //
        //        }


        //==tulis signature

        $dwsign = $tr->writeSignature($masterID, array(
            "nomer" => $tmpNomorNota,
            "step_number" => $stepNum,
            "step_code" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['target'],
            "step_name" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'],
            "group_code" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['userGroup'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "keterangan" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'] . " oleh " . $this->session->login['nama'],
            "transaksi_id" => $masterID,
        )) or die("Failed to write signature");
        $mongoList['sign'][] = $dwsign;
        //cekKuning($this->db->last_query());

        //region update step terdahulu
        $tr = new MdlTransaksi();
        $dupState = $tr->updateData(array("id" => $topID), array(
            "next_step_code" => $nextProp['code'],
            "next_step_label" => $nextProp['label'],
            "next_group_code" => $nextProp['groupID'],
            "next_step_num" => $nextProp['num'],
            "step_current" => $stepNum,

            "partial" => $_SESSION[$cCode]['main']['partial'],

        )) or die("Failed to update tr next-state!");
        $mongUpdateList['update']['main'][] = array(
            "where" => array("id" => "$topID"),
            "value" => array(
                "next_step_code" => $nextProp['code'],
                "next_step_label" => $nextProp['label'],
                "next_group_code" => $nextProp['groupID'],
                "next_step_num" => $nextProp['num'],
                "step_current" => $stepNum,
            ),
        );
        cekHijau($this->db->last_query());

        //-------------------------------------------------
        $tr = new MdlTransaksi();
        $dupState = $tr->updateData(array("id" => $trID), array(
            "partial" => $_SESSION[$cCode]['main']['partial'],
        )) or die("Failed to update tr next-state!");
        $mongUpdateList['update']['main'][] = array(
            "where" => array("id" => "$trID"),
            "value" => array(
                "partial" => $_SESSION[$cCode]['main']['partial'],
            ),
        );


        //mati_disini("==== ==== ====");
        //endregion


        //==prepare kloningan
        $tCode = $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['target'];
        $tCodeName = $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'];
        $masterReplacers = array(
            //            "referensi_id" => $masterID, (dimatikan)
            //            "id_master"       => $masterID,
            //            "id_top"          => $topID,
            "inv" => $tmpNomorNota,
            //            "jenis_top"           => $tCode,
            "jenis" => $tCode,
            "jenis_label" => $tCodeName,
            "transaksi_jenis" => $tCode,
            "cabang_id" => selectedTransactionSession() ? $_SESSION[$cCode]['main']['cabangID'] : $this->session->login['cabang_id'],
            "cabang_nama" => selectedTransactionSession() ? $_SESSION[$cCode]['main']['cabangName'] : $this->session->login['cabang_nama'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "step_current" => "0",
            "step_number" => $stepNum,
            //            "next_step_code"      => "",
            //            "next_step_label"     => "",
            //            "next_group_code"     => "",
            "next_step_code" => $nextProp['code'],
            "next_step_label" => $nextProp['label'],
            "next_group_code" => $nextProp['groupID'],
            //===references
            "id_master" => $masterID,
            "id_top" => $topID,
            "ids_prev" => base64_encode(serialize($prevIDs)),
            "ids_prev_intext" => print_r($prevIDs, true),
            "nomer_top2" => isset($_SESSION[$cCode]['main']['nomer_top2']) ? $_SESSION[$cCode]['main']['nomer_top2'] : "",
            "nomer_top" => $_SESSION[$cCode]['tableIn_master']['nomer_top'],
            "nomers_prev" => base64_encode(serialize($prevNos)),
            "nomers_prev_intext" => print_r($prevNos, true),
            //            "jenis_top"           => $this->jenisTr,
            "jenises_prev" => base64_encode(serialize(array($prevProp['jenis']))),
            "jenises_prev_intext" => print_r(array($prevProp['jenis']), true),
            "tail_number" => $stepNum,
            "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
        );

        foreach ($masterReplacers as $key => $val) {
            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
        }

        $childTableRepaclers = array(
            "sub_step_number" => $stepNum,
            "sub_step_current" => $stepNum,
            "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']),
            "next_substep_num" => $nextProp['num'],
            "next_substep_code" => $nextProp['code'],
            "next_substep_label" => $nextProp['label'],
            "next_subgroup_code" => $nextProp['groupID'],
        );
        foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
            //			$id = $dSpec['id'];
            foreach ($childTableRepaclers as $key => $val) {
                $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
            }
        }


        $masterReplacersO = array(

            "jenisTr" => $tCode,
            "jenisTrName" => $tCodeName,
            "olehID" => $this->session->login['id'],
            "olehName" => $this->session->login['nama'],
            "stepNumber" => $stepNum,
            "stepCode" => $tCode,
        );
        foreach ($masterReplacersO as $key => $val) {
            $_SESSION[$cCode]['main'][$key] = $val;
        }

        //region menimbulkan nilai tagihan
        $unpaidList = null != $this->config->item('tr_unpaidList') ? $this->config->item('tr_unpaidList') : array();
        //        arrprint($_SESSION[$cCode]['tableIn_master']);
        if (in_array($tCode, $unpaidList)) {
            $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_tagihan"] = $_SESSION[$cCode]['tableIn_master']['transaksi_nilai'];
            $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_terbayar"] = 0;
            $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_sisa"] = ($_SESSION[$cCode]['tableIn_master']['transaksi_nilai_tagihan'] - $_SESSION[$cCode]['tableIn_master']['transaksi_nilai_terbayar']);
            //cekMerah("NULIS TAGIHANN");
        }
        else {
            //cekMerah("TIDAK NULIS TAGIHANN");
        }
        //endregion


        //region penomoran receipt #1

        $this->load->model("CustomCounter");
        $cn = new CustomCounter("transaksi");
        $cn->setType("transaksi");

        $counterForNumber = array($this->config->item('heTransaksi_core')[$origJenis]['formatNota']);
        if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$origJenis]['counters'])) {
            die(__LINE__ . " Used number should be registered in 'counters' config as well");
        }

        foreach ($counterForNumber as $i => $cRawParams) {
            $cParams = explode("|", $cRawParams);
            $cValues = array();
            foreach ($cParams as $param) {
                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
            }
            $cRawValues = implode("|", $cValues[$i]);
            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);
        }
        $tmpNomorNota2 = $paramSpec['paramString'];
        $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);

        //endregion

        //region dynamic counters #1
        echo "<script>top.writeProgress('sedang membuat penomoran');</script>";
        // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
        $cn = new CustomCounter("transaksi");
        $cn->setType("transaksi");
        $configCustomParams = $this->config->item('heTransaksi_core')[$origJenis]['counters'];
        $configCustomParams[] = "stepCode";
        if (sizeof($configCustomParams) > 0) {
            $cContent = array();
            foreach ($configCustomParams as $i => $cRawParams) {
                $cParams = explode("|", $cRawParams);
                $cValues = array();
                foreach ($cParams as $param) {
                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                }
                $cRawValues = implode("|", $cValues[$i]);
                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                switch ($paramSpec['id']) {
                    case 0: //===counter type is new
                        $paramKeyRaw = print_r($cParams, true);
                        $paramValuesRaw = print_r($cValues[$i], true);
                        $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                        break;
                    default: //===counter to be updated
                        $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                        break;
                }
                //echo "<hr>";
            }
        }
        $appliedCounters2 = base64_encode(serialize($cContent));
        $appliedCounters_inText2 = print_r($cContent, true);


        $masterReplacers = array(
            "nomer" => $tmpNomorNota2,
            "nomer2" => $tmpNomorNota2Alias,
            "counters" => $appliedCounters2,
            "counters_intext" => $appliedCounters_inText2,
        );
        foreach ($masterReplacers as $key => $val) {
            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
        }

        $addValues = array(
            'counters' => $appliedCounters2,
            'counters_intext' => $appliedCounters_inText2,
            'nomer' => $tmpNomorNota2,
            'nomer2' => $tmpNomorNota2Alias,
            'dtime' => date("Y-m-d H:i:s"),
            'fulldate' => date("Y-m-d"),
        );
        foreach ($addValues as $key => $val) {
            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
        }

        // </editor-fold>
        //endregion


        //==tulis kloningan transaksi

        //region write entries
        if (sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

            $_SESSION[$cCode]['tableIn_master']['status_4'] = 11;
            $_SESSION[$cCode]['tableIn_master']['trash_4'] = 0;


            $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
            $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
            $mongoList['main'] = array($insertID, $epID);
            $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
            $_SESSION[$cCode]['main']['nomer'] = $insertNum;
            if ($insertID < 1) {
                die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
            }


            if (isset($_SESSION[$cCode]['tableIn_master']['ids_his'])) {
                $idHis_decode = blobDecode($_SESSION[$cCode]['tableIn_master']['ids_his']);
                $idHis_decode[$stepNum] = array(
                    "olehID" => $_SESSION[$cCode]['main']['olehID'],
                    "olehName" => $_SESSION[$cCode]['main']['olehName'],
                    "step" => $stepNum,
                    "trID" => $insertID,
                    "nomer" => $tmpNomorNota2,
                    "nomer2" => $tmpNomorNota2Alias,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                $idHis_blob = blobEncode($idHis_decode);
                $idHis_intext = print_r($idHis_decode, true);

                $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;


                $tr = new MdlTransaksi();
                $dup = $tr->updateData(array("id" => $insertID), array(
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");
                cekUngu($this->db->last_query());
            }


            cekUngu(":: insertID => $insertID ::");
            if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                $mongoList['mainValues'] = array();
                foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                    $mongoList['mainValues'][] = $dd;
                }
                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $mongoList['mainValues'][] = $dd;
                }
            }
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $mongoList['mainValues'][] = $dd;
                }
            }
            if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }


            if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                //                cekMerah("ada mainElements $cCode");
                //                arrprint($_SESSION[$cCode]['main_elements']);die();
                foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec['label'],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                    ));
                }
            }
            else {
                //                cekMerah("TAK ada mainElements");
            }

            if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                            ));
                            $insertIDs[$pID][] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }

                    }
                }
                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }


                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detail_rsltItems'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detail_rsltItems'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail_rsltItems'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[$pID][] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }


                }
            }


            //region update validQty pada step sebelumnya yang di-refer
            echo "<script>top.writeProgress('EXTRACT ITEMS...','head');</script>";
            $seluruhnya = true;
            $prevTrID = 0;
            $arrvalidQtySisa = array();
            if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                $closedRequest = isset($this->config->item('heTransaksi_core')[$origJenis]['closedRequest'][$stepNum]['enabled']) ? $this->config->item('heTransaksi_core')[$origJenis]['closedRequest'][$stepNum]['enabled'] : false;

                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail'] as $iID => $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                        $mongoList['detail'][] = $insertDetailID;

                    }

                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                            $mongoList['detail'][] = $insertDetailID;
                        }
                    }

                    cekHitam("EXTRACTED ITEMS... [$iID]");
                    echo "<script>top.writeProgress('" . strtoupper($dSpec['produk_nama']) . "');</script>";


                    if (isset($_SESSION[$cCode]['extractedItems'])) {
                        if (array_key_exists($iID, $_SESSION[$cCode]['extractedItems'])) {
                            $itemFulfilledJml = 0;
                            foreach ($_SESSION[$cCode]['extractedItems'][$iID] as $triID => $triSpec) {
                                $prevTrID = $triSpec['transaksi_id'];
                                $tru = new MdlTransaksi();
                                $tru->setFilters(array());
                                $tru->setTableName($tru->getTableNames()['detail']);
                                //----------------------------------------------------------
                                if ($triSpec['valid_qty'] >= $dSpec['produk_ord_jml']) {
                                    $newValidQty = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);
                                    //                                    cekmerah("validQty dikurangi oleh produk_ord_jml, yaitu " . $dSpec['produk_ord_jml']);
                                }
                                else {
                                    $newValidQty = ($triSpec['valid_qty'] - $triSpec['valid_qty']);
                                    //                                    cekmerah("validQty dikurangi oleh triSpec,  myaitu " . $triSpec['valid_qty']);
                                }
                                //----------------------------------------------------------
                                $newValidQtyNotApprove = 0;
                                if ($closedRequest == true) {
                                    cekPink2("closed Request enabled, request: " . $triSpec['valid_qty'] . ", approve: " . $dSpec['produk_ord_jml'] . ", newValidQty: " . $newValidQty);
                                    if ($triSpec['valid_qty'] >= $dSpec['produk_ord_jml']) {
                                        $newValidQty = 0;
                                        $newValidQtyNotApprove = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);

                                    }
                                    //                                    else{
                                    //                                        $newValidQty = 0;
                                    //                                        $newValidQtyNotApprove = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);
                                    //                                    }
                                    cekPink2("new valid qty: $newValidQty, valid qty not approve: $newValidQtyNotApprove");
                                }
                                //----------------------------------------------------------


                                $itemFulfilledJml += $newValidQty;
                                $updateContents = array(
                                    "valid_qty" => $newValidQty,
                                    "valid_qty_no_approve" => $newValidQtyNotApprove,
                                );
                                if ($newValidQty < 1) {
                                    $childPrevRepaclers = array(
                                        "next_substep_code" => "",
                                        "next_substep_label" => "",
                                        "next_subgroup_code" => "",
                                        "sub_tail_number" => $stepNum,
                                        "sub_tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                                    );
                                    foreach ($childPrevRepaclers as $key => $val) {
                                        $updateContents[$key] = $val;
                                    }
                                }
                                else {//==kalau ada yang tidak habis, berarti TIDAK seluruhnya yang dilanjutkan pada step berikutnya
                                    $seluruhnya = false;
                                    $arrvalidQtySisa[$iID] = $newValidQty;
                                }
                                $dupState = $tru->updateData(array(
                                    "produk_id" => $iID,
                                    "id" => $triID,
                                    "transaksi_id" => $triSpec['transaksi_id'],
                                ), $updateContents) or die("Failed to update previous detail entries!");
                                cekHijau($this->db->last_query());

                                $mongUpdateList['update']['detail'][] = array(
                                    "where" => array(
                                        //                                        "transaksi_id" => $triSpec['transaksi_id'],
                                        "id" => "$triID",
                                        //                                        "produk_id" => $iID,
                                    ),
                                    "value" => $updateContents,
                                );
                                unset($tru);
                            }
                        }
                        //                        else{
                        //                            if($closedRequest == true){
                        //
                        //                            }
                        //                        }
                    }
                }

                if ($closedRequest == true) {
                    if (isset($_SESSION[$cCode]['extractedItems'])) {
                        foreach ($_SESSION[$cCode]['extractedItems'] as $iIDex => $exSpec) {
                            if (!array_key_exists($iIDex, $_SESSION[$cCode]['tableIn_detail'])) {
                                foreach ($exSpec as $trDataID => $trdSpec) {
                                    $tru = new MdlTransaksi();
                                    $tru->setFilters(array());
                                    $tru->setTableName($tru->getTableNames()['detail']);
                                    $updateContents = array(
                                        "valid_qty" => 0,
                                        "valid_qty_no_approve" => $trdSpec['qty'],
                                    );
                                    $childPrevRepaclers = array(
                                        "next_substep_code" => "",
                                        "next_substep_label" => "",
                                        "next_subgroup_code" => "",
                                        "sub_tail_number" => $stepNum,
                                        "sub_tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                                    );
                                    foreach ($childPrevRepaclers as $key => $val) {
                                        $updateContents[$key] = $val;
                                    }
                                    $dupState = $tru->updateData(array(
                                        "produk_id" => $iIDex,
                                        "id" => $trDataID,
                                        "transaksi_id" => $trdSpec['transaksi_id'],
                                    ), $updateContents) or die("Failed to update previous detail entries!");
                                    //                                    cekHijau($this->db->last_query());
                                    $mongUpdateList['update']['detail'][] = array(
                                        "where" => array(
                                            //                                            "transaksi_id" => $trdSpec['transaksi_id'],
                                            "id" => "$trDataID",
                                            //                                            "produk_id" => $iIDex,
                                        ),
                                        "value" => $updateContents,
                                    );
                                    unset($tru);
                                }
                            }
                        }
                    }
                }

                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }
                    foreach ($indexing_details as $k => $arrID) {
                        arrPrint($arrID);
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }


                //-------------
                //                $totalSteps
                $lastStepPartialApprove = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['lastStepPartialApprove']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['lastStepPartialApprove'] : false;
                if ($lastStepPartialApprove == true) {
                    cekKuning(__LINE__ . " $lastStepPartialApprove :: $totalSteps");
                    if ($totalSteps == 2) {
                        if (sizeof($arrvalidQtySisa) > 0) {
                            cekPink("ada valid qty yang tersisa");
                            $tr = new MdlTransaksi();
                            $dupState = $tr->updateData(array("id" => $topID), $stepNowParameter) or die("Failed to update tr next-state!");
                            cekHitam(__LINE__ . " ## 2 step, dan step akhir partial, YESS...");
                            showLast_query("orange");
                        }
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }

            if ($seluruhnya) {
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $prevTrID), array(
                    "tail_number" => $stepNum,
                    "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                    "status_4" => $_SESSION[$cCode]['main']['status_4'],
                    "trash_4" => $_SESSION[$cCode]['main']['trash_4'],
                )) or die("Failed to update tr next-state!");
                cekHijau(":: UOPDATE transaksi dengan trID -> $prevTrID");
                $mongUpdateList['update']['main'][] = array(
                    "where" => array(
                        "id" => "$prevTrID",
                    ),
                    "value" => array(
                        "tail_number" => $stepNum,
                        "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                        "status_4" => $_SESSION[$cCode]['main']['status_4'],
                        "trash_4" => $_SESSION[$cCode]['main']['trash_4'],
                    ),
                );
                cekHijau($this->db->last_query());
            }
            //endregion

            //region cloner items to item_child
            if (sizeof($additionalData) > 0) {
                echo "<script>top.writeProgress('CLONING ITEMS TO ITEM CHILD...','head');</script>";
                cekHitam("ini data");
                $dataMdl = $additionalData["mdlName"];
                $this->load->model("Mdls/" . $dataMdl);
                $da = new $dataMdl();
                $arrColl = $da->getFields();
                $selectedCol = array();
                foreach ($arrColl as $colSpec) {
                    $selectedCol[] = $colSpec['kolom'];
                }

                if (isset($_SESSION[$cCode]['items_child']) && sizeof($_SESSION[$cCode]['items_child'])) {
                    $gateData = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$stepNum]['gate']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$stepNum]['gate'] : "detail";

                    $arrBlacklist = array(
                        "jml", "max_jml", "qty",
                    );
                    if (isset($_SESSION[$cCode]["items2_sum"])) {
                        unset($_SESSION[$cCode]["items2_sum"]);
                        unset($_SESSION[$cCode]["items2"]);
                        unset($_SESSION[$cCode]["tableIn_detail_values2_sum"]);
                    }
                    foreach ($_SESSION[$cCode]['items_child'] as $mainProdsID => $defData) {
                        if ($gateData == "detail") {
                            $itemsMain = isset($_SESSION[$cCode]['items'][$mainProdsID]) ? $_SESSION[$cCode]['items'][$mainProdsID] : array();
                        }
                        else {
                            $forceMainToItems = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$stepNum]['changeToItems'][$gateData]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$stepNum]['changeToItems'][$gateData] : array();
                            if (sizeof($forceMainToItems) > 0) {
                                foreach ($forceMainToItems as $key1 => $key2) {
                                    $keyForce = strlen($key2) > 2 ? $key2 : $key1;
                                    $itemsMain[$key1] = isset($_SESSION[$cCode]['main'][$keyForce]) ? $_SESSION[$cCode]['main'][$keyForce] : "";
                                }
                                $itemsMain["jml"] = "1";
                                $itemsMain["qty"] = "1";
                                $itemsMain["max_jml"] = "1";

                            }
                            else {
                                matiHEre("detil aset gagal di tulis!");
                            }
                            //                            arrPrint($forceMainToItems);
                        }

                        $arrChilds = array_diff_key($itemsMain, array_flip($arrBlacklist));
                        //                        arrPrint($itemsMain);
                        //                        matiHEre();
                        //
                        //arrPrint($arrChilds);
                        cekLime("ini brooo " . $gateData);

                        $arrNew = array();
                        if (sizeof($itemsMain) > 0) {
                            foreach ($defData as $inID => $detil_child) {
                                //                        $arrNewChild = array_diff($itemsMain,$detil_child);

                                $paramDetil = array_replace($arrChilds, $detil_child);
                                if (array_key_exists("id", $paramDetil)) {

                                    $paramDetil["parent_id"] = $paramDetil["id"];
                                    if (!isset($paramDetil["folders"]) || $paramDetil["folders"] == 0) {
                                        $paramDetil["folders"] = $paramDetil["pihakMainId"];
                                        $paramDetil["keterangan"] = $paramDetil["pihakMainName"];
                                    }
                                    unset($paramDetil["id"]);
                                }
                                $tmpData = array();
                                foreach ($selectedCol as $i => $coloum) {
                                    if (isset($paramDetil[$coloum])) {
                                        $tmpData[$coloum] = $paramDetil[$coloum];
                                    }
                                }
                                //                                arrPrint($paramDetil);
                                if (isset($paramDetil["subtotal"])) {
                                    $paramDetil["subtotal"] = $paramDetil["jml"] * $paramDetil["harga"];
                                }

                                $insertDataID = $da->addData($tmpData, $da->getTableName()) or die(lgShowError("Gagal menulis pengajuan data", __FILE__));
                                cekHere($this->db->last_query());
                                $paramDetil["id"] = $insertDataID;
                                echo "<script>top.writeProgress('PENGAJUAN DATA (TRID:$insertDataID)');</script>";
                                $_SESSION[$cCode]["items2_sum"][$insertDataID] = $paramDetil;
                                $_SESSION[$cCode]["items2"][$mainProdsID][$insertDataID] = $paramDetil;
                                //                            $arrNew

                            }
                        }


                        //                        arrPrint($arrNew);
                        //


                        //                  arrPrint($itemsMain);
                    }

                }
            }

            //endregion


            if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $iID => $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detail'][] = $dd;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2'] as $iID => $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detail'][] = $dd;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                    cekUngu($this->db->last_query());
                }
            }


            if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['updateDueDate'][$stepNum])) {
                $dueDateConf = $this->config->item("heTransaksi_ui")[$this->jenisTr]['updateDueDate'][$stepNum];
                $sourceDue = $dueDateConf['source'];
                $targetDue = $dueDateConf['target'];
                $datenow = date("Y-m-d");
                foreach ($sourceDue as $key => $val) {
                    $indexVal = isset($_SESSION[$cCode]['main_elements'][$key][$val]) ? $_SESSION[$cCode]['main_elements'][$key][$val] : 14;
                    $dueDate = dueDate($datenow, $indexVal);
                }
                $fieldDue = $tr->getFields()["dueDate"];
                $dataDue = array();
                foreach ($fieldDue as $kol) {
                    if (isset($_SESSION[$cCode]['tableIn_master'][$kol])) {
                        $dataDue[$kol] = $_SESSION[$cCode]['tableIn_master'][$kol];
                    }
                }
                $dataDue['due_date'] = $dueDate;
                $validateDue = validateDueDate($_SESSION[$cCode]['main']['customerID'], $_SESSION[$cCode]['main']['dtime']);

                arrPrint($validateDue);
                if ($validateDue['allow_create'] == "true") {
                    if (isset($_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen']) && $_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen'] > 0) {
                        cekBiru($_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen']);

                        $tr->writeDueDate($insertID, $dataDue);
                    }
                }
                else {
                    $allowedOver = validateOverDue($_SESSION[$cCode]['main']['customerID']);
                    if ($allowedOver['status'] == "allowed") {

                    }
                    else {
                        //                        matiHere($validateDue['error']);//matiin transaksi sudah over due
                    }
                    //                    arrPrint()
                    //                    matiHere($validateDue['error']);//matiin transaksi sudah over due
                }
                //                matiHere();
                //update main elementnya
                foreach ($targetDue as $keyTarget => $valTarget) {
                    $_SESSION[$cCode]['main_elements'][$keyTarget][$valTarget] = $dueDate;
                    $_SESSION[$cCode]['main']['dueDate'] = $dueDate;
                }
            }


            $baseRegistries = array(
                'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                'items_noapprove' => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),

                'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][$stepNum] : array(),
                "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$stepNum] : array(),
                "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][$stepNum] : array(),
                "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][$stepNum] : array(),
                "jurnal_index" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['components'][$stepNum]) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['components'][$stepNum] : array(),
                "preProcessor" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['preProcessor'][$stepNum]) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['preProcessor'][$stepNum] : array(),
                "postProcessor" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][$stepNum]) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][$stepNum] : array(),
                "revert" => isset($_SESSION[$cCode]['revert']) ? $_SESSION[$cCode]['revert'] : array(),
                "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                "componentsBuilder" => isset($_SESSION[$cCode]['componentsBuilder']) ? $_SESSION[$cCode]['componentsBuilder'] : array(),
                "jurnalItems" => isset($_SESSION[$cCode]['jurnalItems']) ? $_SESSION[$cCode]['jurnalItems'] : array(),
            );
            $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            $mongRegID = $doWriteReg;
            echo "<script>top.writeProgress('MENULIS KE-REGISTRY....');</script>";
        }
        else {
            die(lgShowAlert("Transaksi gagal disimpan, silahkan cek kembali transaksi ini."));
        }
        //endregion


        //        validateAllBalances();

        //
        //region processing sub-post-processors, always
        //<editor-fold desc="----------sub postProc">

        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['detail'] : array();
        if (sizeof($iterator) > 0) {
            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "sub-postProcessor: $comName, initializing values <br>";
                echo "<script>top.writeProgress('MENYIAPKAN DATA SUB-PROCESSORS UNTUK DIKIRIM...', 'head');</script>";

                $tmpOutParams[$cCtr] = array();
                foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                    $subParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                            $subParams['loop'][$key] = $realValue;

                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                            $subParams['static'][$key] = $realValue;
                            cekBiru("$key diisi dengan $realValue");

                        }

                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            foreach ($paramPatchers[$comName] as $k => $v) {
                                if (!isset($subParams['static'][$k])) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }
                        }
                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                cekorange(":: $k diisikan dengan " . $subParams['static'][$k]);
                            }
                        }

                        $subParams['static']["fulldate"] = date("Y-m-d");
                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }

                    if (sizeof($subParams) > 0) {
                        $tmpOutParams[$cCtr][] = $subParams;
                    }
                    echo "<script>top.writeProgress('" . isset($subParams['static']['name']) ? $subParams['static']['name'] : "" . " " . isset($subParams['static']['extern_nama']) ? $subParams['static']['extern_nama'] : "" . " " . isset($subParams['static']['nama']) ? $subParams['static']['nama'] : "" . "');</script>";
                }
            }

            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "sub-postProcessor: $comName, sending values <br>";
                echo "<script>top.writeProgress('SENDING SUB-PROCESSORS ($comName)...', 'head');</script>";
                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();

                $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                cekBiru($this->db->last_query());
            }
        }

        // matiHere();
        //</editor-fold>
        //endregion

        //
        //region processing main-post-processors, always
        //<editor-fold desc="----------postProc">

        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['master'] : array();
        if (sizeof($iterator) > 0) {
            echo "<script>top.writeProgress('MEMPROSES MAIN-PROCESSORS...', 'head');</script>";
            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "post-processor: $comName<br>";

                $dSpec = $_SESSION[$cCode][$srcGateName];
                $tmpOutParams = array();
                if (isset($tComSpec['loop'])) {
                    foreach ($tComSpec['loop'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['loop'][$key] = $realValue;

                    }
                }
                if (isset($tComSpec['static'])) {
                    //cekHere("DISINI OIII");
                    foreach ($tComSpec['static'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['static'][$key] = $realValue;

                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            if (!isset($tmpOutParams['static'][$k])) {
                                $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                                echo "<script>top.writeProgress(':: $key diisikan dengan " . $tmpOutParams['static'][$k] . ");</script>";
                            }
                        }
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                            echo "<script>top.writeProgress(':: $key diisikan dengan " . $tmpOutParams['static'][$k] . ");</script>";
                        }
                    }
                    $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }
                if (isset($tComSpec['static2'])) {
                    //cekHere("DISINI OIII");
                    foreach ($tComSpec['static2'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                        $tmpOutParams['static2'][$key] = $realValue;

                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            if (!isset($subParams['static'][$k])) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                        }
                    }
                    $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }

                //lgShowError("Ada kesalahan",);
                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();

                //                cekBiru("kiriman komponem $comName");
                //                                    arrPrint($tmpOutParams);
                $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


            }
        }


        //</editor-fold>
        //endregion


        //
        //region ----------subcomponents GESER KE CLI

        //        $componentGate['detail'] = array();
        //        //arrPrint($paramForceFillers);
        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail'] : array();
        $componentConfig['detail'] = $iterator;
        //        if (sizeof($iterator) > 0) {
        //            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
        //            $filterNeeded = false;
        //            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
        //                $filterNeeded = true;
        //            }
        //            foreach ($iterator as $cCtr => $tComSpec) {
        ////                $comName = $tComSpec['comName'];
        //                $srcGateName = $tComSpec['srcGateName'];
        //                $srcRawGateName = $tComSpec['srcRawGateName'];
        //
        //                echo "sub-component: $comName, $srcGateName, initializing values <br>";
        //                $tmpOutParams[$cCtr] = array();
        //                foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
        //                    cekmerah("mengevaluasi $srcGateName..");
        //                    $comName = $tComSpec['comName'];
        //                    if (substr($comName, 0, 1) == "{") {
        //                        $comName = trim($comName, "{");
        //                        $comName = trim($comName, "}");
        //                        $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
        //                        $tComSpec['comName'] = $comName;
        //                        $iterator[$cCtr]['comName'] = $comName;
        //                    }
        //
        //                    $filterNeeded = false;
        //                    $mdlName = "Com" . ucfirst($comName);
        //                    if (in_array($mdlName, $compValidators)) {//perlu validasi filter
        //                        $filterNeeded = true;
        //                    }
        //
        //
        //                    $subParams = array();
        //                    if (isset($tComSpec['loop'])) {
        //                        foreach ($tComSpec['loop'] as $key => $value) {
        //                            if (substr($key, 0, 1) == "{") {
        //                                $key = trim($key, "{");
        //                                $key = trim($key, "}");
        //                                $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$id][$key], $key);
        //                            }
        //                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
        //                            $subParams['loop'][$key] = $realValue;
        //                            cekKuning("LOOP: $key diisi dengan $realValue");
        //
        //                            if ($filterNeeded) {
        //                                if ($subParams['loop'][$key] == 0) {
        //                                    unset($subParams['loop'][$key]);
        //                                }
        //                            }
        //                        }
        //                    }
        //                    if (isset($tComSpec['static'])) {
        //                        foreach ($tComSpec['static'] as $key => $value) {
        //
        //                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
        //                            $subParams['static'][$key] = $realValue;
        //                            cekKuning("STATIC: $key diisi dengan $realValue");
        //
        //                        }
        //                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
        //                            foreach ($paramPatchers[$comName] as $k => $v) {
        //                                if (!isset($subParams['static'][$k])) {
        //                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
        //                                    cekOrange("fill :: $comName :: $k => " . $subParams['static'][$k]);
        //                                }
        //                            }
        //                        }
        //                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
        //                            //                            cekOrange("comName:: $comName");
        //                            $jenis = $_SESSION[$cCode]['main']['jenis'];
        //                            foreach ($paramForceFillers[$comName] as $k => $v) {
        //                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
        //                                cekOrange("fillforce :: $comName :: $k => " . $subParams['static'][$k]);
        //                            }
        //                        }
        //                        $subParams['static']["fulldate"] = date("Y-m-d");
        //                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
        //                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
        //                    }
        //                    cekHitam("cetak subParams");
        //                    arrPrint($subParams);
        //                    if (sizeof($subParams) > 0) {
        //                        if ($filterNeeded) {
        //                            if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
        //                                $tmpOutParams[$cCtr][] = $subParams;
        //                            }
        //                        }
        //                        else {
        //
        //                            $tmpOutParams[$cCtr][] = $subParams;
        //                        }
        //                    }
        //                }
        //
        //                $componentGate['detail'][$cCtr] = $subParams;
        //            }
        //
        //
        //            $it = 0;
        //            foreach ($iterator as $cCtr => $tComSpec) {
        //                $it++;
        //
        //
        //                $comName = $tComSpec['comName'];
        //                $srcGateName = $tComSpec['srcGateName'];
        //                $srcRawGateName = $tComSpec['srcRawGateName'];
        //
        //                echo "sub component #$it: $comName, sending values <br>";
        //
        //                $mdlName = "Com" . ucfirst($comName);
        //                $this->load->model("Coms/" . $mdlName);
        //                $m = new $mdlName();
        //
        //
        //                if (sizeof($tmpOutParams[$cCtr]) > 0) {
        //                    $tobeExecuted = true;
        //                }
        //                else {
        //                    $tobeExecuted = false;
        //                }
        //
        //
        //                if ($tobeExecuted) {
        //                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
        //                    $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
        //                }
        //                else {
        //                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
        //                }
        //            }
        //        }
        //        else {
        //            //cekKuning("subcomponents is not set");
        //        }

        //endregion


        //region ----------components
        //<editor-fold desc="----------components">

        $componentGate['master'] = array();
        $componentConfig['master'] = array();
        //        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master'] : array();
        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
            $iterator = isset($_SESSION[$cCode]['revert']['jurnal'][$stepNum]['master']) ? $_SESSION[$cCode]['revert']['jurnal'][$stepNum]['master'] : array();
        }
        else {
            if (isset($_SESSION[$cCode]['componentsBuilder'][$stepNum]['master'])) {
                $iterator = $_SESSION[$cCode]['componentsBuilder'][$stepNum]['master'];
            }
            elseif (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master'])) {
                $iterator = $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master'];
            }
            else {
                $iterator = array();
            }
        }

        //cekkuning("cek ITERATOR MASTER");
        //cekPink($iterator);
        //mati_disini();
        if (sizeof($iterator) > 0) {
            echo "<script>top.writeProgress('KOMPONEN...', 'head');</script>";
            $componentConfig['master'] = $iterator;

            $it = 0;
            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            foreach ($iterator as $cCtr => $tComSpec) {
                //                cekPink($tComSpec);
                //                mati_disini();
                $it++;
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "component #$it: $comName :: $srcGateName <br>";

                $dSpec = $_SESSION[$cCode][$srcGateName];
                $tmpOutParams = array();
                if (isset($tComSpec['loop'])) {
                    foreach ($tComSpec['loop'] as $key => $value) {
                        if (substr($key, 0, 1) == "{") {
                            $key = trim($key, "{");
                            $key = trim($key, "}");
                            //                            $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                            $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$key], $key);
                        }
                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        if ($key != null) {
                            $tmpOutParams['loop'][$key] = $realValue;
                        }

                    }
                }
                //                cekBiru($tmpOutParams);
                //                mati_disini(__LINE__);
                if (isset($tComSpec['static'])) {
                    foreach ($tComSpec['static'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['static'][$key] = $realValue;
                        cekHijau(":: NORMAL :: $key => $realValue ::");
                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        cekHijau(":: masuk ke PATCHER ::");
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            cekHijau(":: ada yang mau di-PATCHER ::");
                            arrPrint($tmpOutParams['static']);
                            if (!isset($tmpOutParams['static'][$k])) {
                                $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                                cekHijau(":: PATCHER :: $key => $realValue ::");
                            }

                        }
                    }
                    else {
                        cekMerah(":: TIDAK TERMASUK PATCHER ::");
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                            cekHijau(":: FORCEFILL :: $key => $realValue ::");
                        }
                    }
                    $tmpOutParams['static']["urut"] = $cCtr;
                    $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }
                if (isset($tComSpec['static2'])) {
                    foreach ($tComSpec['static2'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['static2'][$key] = $realValue;

                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            if (!isset($subParams['static'][$k])) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                        }
                    }
                    $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }

                //lgShowError("Ada kesalahan",);
                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();

                //===filter value nol, jika harus difilter
                $tobeExecuted = true;

                if (in_array($mdlName, $compValidators)) {

                    $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                    if (sizeof($loopParams) > 0) {
                        foreach ($loopParams as $key => $val) {
                            cekmerah("$comName : $key = $val ");
                            if ($val == 0) {
                                unset($tmpOutParams['loop'][$key]);
                            }
                        }
                    }
                    if (sizeof($tmpOutParams['loop']) < 1) {
                        $tobeExecuted = false;
                    }

                }


                if ($tobeExecuted) {
                    cekBiru("kiriman komponen $comName");
                    arrPrint($tmpOutParams);
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
                else {
                    cekBiru("komponem $comName tidak memenuhi syarat untuk ditulis");
                }

                $componentGate['master'][$cCtr] = $tmpOutParams;
            }
        }
        else {
            //cekKuning("components is not set");
        }

        //                mati_disini(__FUNCTION__ . " *** under maintenance *** <br> TUNGGU SEBENTAR YA... ");
        //</editor-fold>
        //endregion

        //mati_disini("SIMULASI...");
        //
        //region nulis paymentSource
        $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['target'];
        $paymentSources = $this->config->item("payment_source");
        if (array_key_exists($stepCode, $paymentSources)) {
            $payConfigs = isset($paymentSources[$stepCode][$stepNum]) ? $paymentSources[$stepCode][$stepNum] : array();
            if (sizeof($payConfigs) > 0) {
                foreach ($payConfigs as $paymentSrcConfig) {
                    $valueSrc = $paymentSrcConfig['valueSrc'];
                    $externSrc = $paymentSrcConfig['externSrc'];
                    if (isset($paymentSrcConfig['model'])) {
                        $mdlName = $paymentSrcConfig['model'];
                        $this->load->model("Mdls/$mdlName");
                        $pMdl = New $mdlName();
                        $pTmpMdl = $pMdl->lookupAll()->result();
                        $pTmpMdlResult = array();
                        if (sizeof($pTmpMdl) > 0) {
                            foreach ($pTmpMdl as $pTmpMdlSpec) {
                                $pTmpMdlResult[$pTmpMdlSpec->id] = $pTmpMdlSpec;
                            }
                        }
                    }
                    else {
                        $pTmpMdlResult = array();
                    }

                    if (isset($_SESSION[$cCode]['main'][$valueSrc]) && $_SESSION[$cCode]['main'][$valueSrc] > 0) {
                        if (isset($externSrc['extern_label2'])) {
                            //cek ada isinya atau kosong
                            $cek = strlen($_SESSION[$cCode]['main'][$externSrc['extern_label2']]) > 4 ? "" : matiHere("jenis biaya tidak dikenali " . __LINE__);//
                        }
                        $arrPymSrc = array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => isset($_SESSION[$cCode]['main'][$externSrc['id']]) ? $_SESSION[$cCode]['main'][$externSrc['id']] : "",
                            "extern_nama" => isset($_SESSION[$cCode]['main'][$externSrc['nama']]) ? $_SESSION[$cCode]['main'][$externSrc['nama']] : "",
                            "nomer" => $tmpNomorNota2,
                            "label" => $paymentSrcConfig['label'],

                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],

                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',

                            "tagihan_valas" => isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                            "terbayar_valas" => 0,
                            "sisa_valas" => isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',

                            //                            "extern_label2" => isset($_SESSION[$cCode]['main']['pihakMainName']) ? $_SESSION[$cCode]['main']['pihakMainName'] : "",
                            "extern_label2" => (isset($externSrc['extern_label2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_label2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_label2']] : "",

                            "ppn" => (isset($externSrc['ppn']) && ($_SESSION[$cCode]['main'][$externSrc['ppn']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn']] : "",
                            "ppn_approved" => (isset($externSrc['ppn_approved']) && ($_SESSION[$cCode]['main'][$externSrc['ppn_approved']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn_approved']] : 0,
                            "ppn_sisa" => (isset($externSrc['ppn']) && ($_SESSION[$cCode]['main'][$externSrc['ppn']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn']] : "",
                            "ppn_status" => (isset($externSrc['ppn_status'])) ? $externSrc['ppn_status'] : 0,
                            "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : 0,
                            "extern_date2" => (isset($externSrc['extern_date2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_date2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_date2']] : "",
                            "pph_23" => (isset($externSrc['pph_23']) && ($_SESSION[$cCode]['main'][$externSrc['pph_23']])) ? $_SESSION[$cCode]['main'][$externSrc['pph_23']] : "",

                            "npwp" => (isset($externSrc['npwp']) && ($_SESSION[$cCode]['main'][$externSrc['npwp']])) ? $_SESSION[$cCode]['main'][$externSrc['npwp']] : "",
                            "extern2_id" => (isset($externSrc['extern2_id']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_id']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_id']] : "",
                            "extern2_nama" => (isset($externSrc['extern2_nama']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_nama']] : "",
                            "ppn_pph_faktor" => (isset($externSrc['ppn_pph_faktor']) && ($_SESSION[$cCode]['main'][$externSrc['ppn_pph_faktor']])) ? $_SESSION[$cCode]['main'][$externSrc['ppn_pph_faktor']] : "",
                            "extern_jenis" => (isset($externSrc['extern_jenis']) && ($_SESSION[$cCode]['main'][$externSrc['extern_jenis']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_jenis']] : "",
                            "extern_nilai3" => (isset($externSrc['extern_nilai3']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai3']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai3']] : "",
                            "extern_nilai4" => (isset($externSrc['extern_nilai4']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai4']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai4']] : "",
                            "npwp" => (isset($externSrc['npwp']) && ($_SESSION[$cCode]['main'][$externSrc['npwp']])) ? $_SESSION[$cCode]['main'][$externSrc['npwp']] : "",
                            //                            "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : "",
                            "payment_locked" => (isset($externSrc['payment_locked']) && ($_SESSION[$cCode]['main'][$externSrc['payment_locked']])) ? $_SESSION[$cCode]['main'][$externSrc['payment_locked']] : 0,
                            "cash_account" => (isset($externSrc['cash_account']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account']] : 0,
                            "cash_account_nama" => (isset($externSrc['cash_account_nama']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account_nama']] : 0,
                        );
                        $tr->writePaymentSrc($insertID, $arrPymSrc);

                    }


                    cekMerah($this->db->last_query());
                }
            }

        }
        else {
            cekMerah("TIDAK nulis paymentSrc");
        }

        //matiHere("hoopppp");
        //cek additional step
        $addPaymentSource = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['additionalStep']['shippingService']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['additionalStep']['shippingService'] : array();
        //        arrPrint($addPaymentSource);
        //endregion


        //
        //region nulis paymentAntiSource
        $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['target'];
        $paymentSources = $this->config->item("payment_antiSource");
        if (array_key_exists($stepCode, $paymentSources)) {
            cekMerah(":: starting PAYMENT ANTI SOURCE");
            $payConfigs = $paymentSources[$stepCode];
            if (sizeof($payConfigs) > 0) {
                foreach ($payConfigs as $paymentSrcConfig) {
                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                    $valueSrc = $paymentSrcConfig['valueSrc'];
                    $externSrc = $paymentSrcConfig['externSrc'];
                    $tr->writePaymentAntiSrc($insertID, array(
                        "jenis" => $stepCode,
                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                        "nomer" => $tmpNomorNota2,
                        "label" => $paymentSrcConfig['label'],
                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                        "terbayar" => 0,
                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "dtime" => date("Y-m-d H:i:s"),
                        "fulldate" => date("Y-m-d"),
                    ));
                    //cekMerah($this->db->last_query());
                }
            }

        }
        else {
            //cekMerah("TIDAK nulis paymentSrc");
        }
        //endregion

        //region nulis uangMukaSource
        /*dimatiin geser ke ComUangmukaSourceDetail karena ada di items.
        /*revisi tanggal 27 mei 2020 subject digeser ke vendor dari jenis transaksi misal uangmuka asuransi,uang muka pembelian ->uang muka.
         *
         */
        $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['target'];
        $uangMukaSources = $this->config->item("uang_muka");

        if (array_key_exists($stepCode, $uangMukaSources)) {
            cekMerah(":: starting UANG MUKA  SOURCE");
            //            matiHere();
            $uangMukaConfigs = isset($uangMukaSources[$stepCode][$stepNum]) ? $uangMukaSources[$stepCode][$stepNum] : array();
            if (sizeof($uangMukaConfigs) > 0) {
                $cekPreValue = "";
                $this->load->model("Mdls/MdlPaymentUangMuka");
                $l = new MdlPaymentUangMuka();
                foreach ($uangMukaConfigs as $uangMukaSrcConfig) {
                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                    //                    arrPrint($uangMukaSrcConfig);
                    $valueSrc = $uangMukaSrcConfig['valueSrc'];
                    $externSrc = $uangMukaSrcConfig['externSrc'];
                    $l->addFilter("extern_id='" . $_SESSION[$cCode]['main'][$externSrc['id']] . "'");
                    $l->addFilter("extern_label2='" . $externSrc['extLabel'] . "'");
                    $tmpUm = $l->lookupAll()->result();
                    //                    arrPrint($tmpUm);
                    if (sizeof($tmpUm) > 0) {
                        //update here broo
                        $preTagihan = $tmpUm[0]->tagihan;
                        $preSisa = $tmpUm[0]->sisa;

                        $newTahigan = $preTagihan + $_SESSION[$cCode]['main'][$valueSrc];
                        $newsisa = $preSisa + $_SESSION[$cCode]['main'][$valueSrc];
                        $update = array(
                            "tagihan" => $newTahigan,
                            "sisa" => $newsisa,
                        );
                        $where = array(
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                        );
                        $tr->updateUangMukaSrc($where, $update);
                        cekHitam($this->db->last_query());
                    }
                    else {
                        //insertbaru brooo
                        $tr->writeUangMukaSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $uangMukaSrcConfig['jenisTarget'],
                            "reference_jenis" => $uangMukaSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => "",
                            "note" => "",
                            "label" => $uangMukaSrcConfig['label'],
                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "extern_label2" => $externSrc['extLabel'],
                        ));
                    }
                    cekMerah($this->db->last_query());
                }
            }
            else {
                cekLime("not write uang muka");
            }

        }
        else {
            cekMerah("not write uang muka");
        }
        //endregion

        cekMerah("MULAI LAST_VALIDATE");
        $this->lastValidate($insertID);
        //        mati_disini("setelah lastValidate");


        cekKuning(":: mulai cek rek besar dan rek pembantu");
        $cabangID_validate = $this->session->login['cabang_id'];


        validateBalancesComparison($cabangID_validate, $componentGate, $componentConfig, "master", $insertID, $tmpNomorNota2);
        validateJurnal($insertID, $componentConfig);
        validateAllBalances();


        //==================================================================================================
        //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
        $this->load->model("Mdls/MdlLockerTransaksi");
        $lt = New MdlLockerTransaksi();
        $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], $transaksiID_reference, $insertID);
        //==================================================================================================

//                mati_disini("STOPP... sebelum CONNECTING");

        //
        //region connecting antar cabang
        $steps = isset($this->config->item("heTransaksi_ui")[$origJenis]['steps']) ? $this->config->item("heTransaksi_ui")[$origJenis]['steps'] : array();
        $connector = isset($this->config->item("heTransaksi_ui")[$origJenis]['connectTo']) ? $this->config->item("heTransaksi_ui")[$origJenis]['connectTo'] : "";
        $preReplacer = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['replacerConnectTo']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['replacerConnectTo'] : array();
        $validateValueConnector = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['connectoValidate'][$stepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['connectoValidate'][$stepNum] : array();
        $mongoListConnect = array();
        $mongRegIDConnect = array();

        if (strlen($connector) > 0) {
            cekMerah("to be connected to $connector |$stepNum|" . sizeof($steps));

            if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['connectoValidate'][$stepNum])) {
                $validateValueConnector = $this->config->item("heTransaksi_ui")[$this->jenisTr]['connectoValidate'][$stepNum];
                $preVal = $_SESSION[$cCode]['main'][$validateValueConnector];
                $stepNum = $preVal > 0 ? $stepNum : "1000";//1000 untuk nglewatin step biar gak jalan connectingnya karena nilai yang dicari 0 kasusnya cash in advance ppn sudah masuk pusat tidak perlu diterbitkan auto dorong ppn ke pusat
            }

            if ($stepNum == sizeof($steps)) {
                cekMerah("NOW CONNECTING to $connector");

                if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                    die("kode connector tidak dikenali!");
                }
                if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                    die("konfigurasi connector harus memiliki step lebih dari satu!");
                }


                $oldCode = $cCode;
                $cCode = "_TR_" . $connector;

                $_SESSION[$cCode] = array();

                $_SESSION[$cCode] = array(
                    "main" => $_SESSION[$oldCode]['main'],
                    "items" => $_SESSION[$oldCode]['items'],
                    "items2" => $_SESSION[$oldCode]['items2'],
                    "items2_sum" => $_SESSION[$oldCode]['items2_sum'],
                    "items3" => $_SESSION[$oldCode]['items3'],
                    "items3_sum" => $_SESSION[$oldCode]['items3_sum'],
                    "items4_sum" => $_SESSION[$oldCode]['items4_sum'],
                    "items_noapprove" => $_SESSION[$oldCode]['items_noapprove'],

                    "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                    "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                    //
                    "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                    "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                    //
                    "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                    "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                    "tableIn_detail_values_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'],
                );

                //                    print_r($_SESSION[$cCode]);die();

                //==replace pertama
                $masterReplacersO = array(
                    "jenisTr" => $connector,
                    "jenisTrMaster" => $connector,
                    "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                    "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "placeID" => isset($preReplacer['place2ID']) ? $preReplacer['place2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                    "placeName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                    "place2ID" => $_SESSION[$cCode]['main']['placeID'],
                    "place2Name" => $_SESSION[$cCode]['main']['placeName'],
                    "cabangID" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                    "cabangName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                    "cabang2ID" => $_SESSION[$cCode]['main']['placeID'],
                    "cabang2Name" => $_SESSION[$cCode]['main']['placeName'],
                    //
                    "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                    "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                    "gudangID" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['main']['gudang2ID'],
                    "gudangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['main']['gudang2Name'],
                    "pihakID" => isset($_SESSION[$cCode]['main']['placeID']) ? $_SESSION[$cCode]['main']['placeID'] : "",
                    "pihakName" => isset($_SESSION[$cCode]['main']['placeName']) ? $_SESSION[$cCode]['main']['placeName'] : "",
                    "pihakName2" => $_SESSION[$cCode]['main']['placeName'],
                    "gudang" => $_SESSION[$cCode]['main']['gudangID'],
                    "gudang__name" => $_SESSION[$cCode]['main']['gudangName'],
                    "gudang__label" => $_SESSION[$cCode]['main']['gudangName'],
                    "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",

                );
                foreach ($masterReplacersO as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    //                    $_SESSION[$cCode]['main'][$key] = $val;
                }
                $masterReplacers = array(
                    //                    "referensi_id" => $masterID, (dimatikan)
                    "inv" => $tmpNomorNota,
                    "jenis_master" => $connector,
                    "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                    "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "cabang_id" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['tableIn_master']['cabang2_id'],
                    "cabang_nama" => isset($preReplacer['cabang2Name']) ? $preReplacer['cabang2Name'] : $_SESSION[$cCode]['tableIn_master']['cabang2_nama'],
                    "cabang2_id" => $_SESSION[$cCode]['tableIn_master']['cabang_id'],
                    "cabang2_nama" => $_SESSION[$cCode]['tableIn_master']['cabang_nama'],
                    "gudang_id" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['tableIn_master']['gudang2_id'],
                    "gudang_nama" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['tableIn_master']['gudang2_nama'],
                    "gudang2_id" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                    "gudang2_nama" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                    "gudang" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                    "gudang__name" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                    "gudang__label" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],

                    "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                    "step_current" => 1,
                    "step_number" => 1,
                    "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                    "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                    "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                    "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                    "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",
                    //===references
                    //                    "id_master"            => $masterID,
                    //                    "id_top"               => $topID,
                    //                    "ids_prev"             => base64_encode(serialize(array($prevProp['id']))),
                    //                    "ids_prev_intext"      => print_r(array($prevProp['id'], true)),
                    //                    "nomer_top"            => $_SESSION[$cCode]['main']['nomer'],
                    //                    "nomers_prev"          => base64_encode(serialize(array($prevProp['nomer']))),
                    //                    "nomers_prev_intext"   => print_r(array($prevProp['nomer'], true)),
                    //                    "jenis_top"            => $this->jenisTr,
                    //                    "jenises_prev"        => base64_encode(serialize(array($prevProp['jenis']))),
                    //                    "jenises_prev_intext" => print_r(array($prevProp['jenis'], true)),
                );

                foreach ($masterReplacers as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }


                //region penomoran receipt #2
                //<editor-fold desc="==========penomoran">
                $this->load->model("CustomCounter");
                $cn = new CustomCounter("transaksi");
                $cn->setType("transaksi");

                $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                    die(__LINE__ . " Used number should be registered in 'counters' config as well");
                }

                foreach ($counterForNumber as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                }

                $tmpNomorNota2 = $paramSpec['paramString'];
                $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);


                //</editor-fold>
                //endregion

                //region dynamic counters #2
                // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                $cn = new CustomCounter("transaksi");
                $cn->setType("transaksi");
                $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                $configCustomParams[] = "stepCode";
                if (sizeof($configCustomParams) > 0) {
                    $cContent = array();
                    foreach ($configCustomParams as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                        $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                        switch ($paramSpec['id']) {
                            case 0: //===counter type is new
                                $paramKeyRaw = print_r($cParams, true);
                                $paramValuesRaw = print_r($cValues[$i], true);
                                $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                break;
                            default: //===counter to be updated
                                $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                break;
                        }
                        //echo "<hr>";
                    }
                }
                $appliedCounters2 = base64_encode(serialize($cContent));
                $appliedCounters_inText2 = print_r($cContent, true);
                // </editor-fold>
                //endregion


                $addValues = array(
                    'counters' => $appliedCounters2,
                    'counters_intext' => $appliedCounters_inText2,
                    'nomer' => $tmpNomorNota2,
                    'nomer2' => $tmpNomorNota2Alias,
                    'dtime' => date("Y-m-d H:i:s"),
                    'fulldate' => date("Y-m-d"),
                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

                //===cloning nota cab1 ke cab2
                //===daftar perbedaan
                //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,

                //==replace kedua
                $masterReplacers = array(
                    "nomer" => $tmpNomorNota2,
                    "nomer2" => $tmpNomorNota2Alias,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                foreach ($masterReplacers as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

                //===cloning detail/items cabang1 ke cabang2
                //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                $detailReplacers = array(
                    "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                    "sub_step_current" => 1,
                    "sub_step_number" => 1,
                    "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                    "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                    "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                    "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                    //                    "next_substep_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                    //                    "next_substep_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                    //                    "next_subgroup_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                );
                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                    //                    cekmerah("tulis rincian transaksi kedua");
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                        foreach ($dSpec as $key => $val) {
                            $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                        }
                    }
                }
                else {
                    //                    cekmerah("GAGAL tulis rincian transaksi kedua");
                }


                //region ----------write transaksi & transaksi_data #2
                if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                    $tr = new MdlTransaksi();
                    $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                    $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                    cekUngu($this->db->last_query());
                    $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                    $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                    $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                    $mongoListConnect['main'] = array($insertID, $epID);
                    cekmerah("tulis transaksi kedua :: trID $insertID");
                    cekmerah($this->db->last_query());
                    if ($insertID < 1) {
                        die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                }
                else {
                    cekmerah("GAGAL tulis transaksi kedua");
                }

                if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                    $inserMainValues = array();
                    foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $inserMainValues[] = $dd;
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                    if (sizeof($inserMainValues) > 0) {
                        $arrBlob = blobEncode($inserMainValues);
                        $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                    }
                }


                if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                    foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                }
                if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                    foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $inserMainValues[] = $dd;
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                }

                if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                    //                    cekMerah("ada mainElements");
                    foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                        $tr->writeMainElements($insertID, array(
                            "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                            "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                            "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                            "name" => $aSpec['name'],
                            "label" => $aSpec['label'],
                            "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                            "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                        ));
                    }
                }


                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                    $insertIDs = array();
                    $insertDeIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                        $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                        if ($insertDetailID < 1) {
                            die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertDetailID;
                            $insertDeIDs[$insertID][] = $insertDetailID;
                            $mongoListConnect['detail'][] = $insertDetailID;
                        }
                        if ($epID != 999) {
                            $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                            if ($insertEpID < 1) {
                                die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                            }
                            else {
                                $insertIDs[] = $insertEpID;
                                $insertDeIDs[$epID][] = $insertEpID;
                                $mongoListConnect['detail'][] = $insertEpID;
                            }
                        }
                    }
                    if (sizeof($insertIDs) == 0) {
                        die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                    }
                    else {
                        $indexing_details = array();
                        foreach ($insertDeIDs as $key => $numb) {
                            $indexing_details[$key] = $numb;
                        }

                        foreach ($indexing_details as $k => $arrID) {
                            $arrBlob = blobEncode($arrID);
                            $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                            cekOrange($this->db->last_query());
                        }
                    }
                }

                if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                    $insertIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                        $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                        $mongoListConnect['detail'] = $insertIDs;
                        if ($epID != 999) {
                            $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                            $mongoListConnect['detail'] = $mongoListConnect['detail'] = $insertIDs;;
                        }
                    }
                }

                if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                    $insertIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                            foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                //                                $insertIDs[$pID][] = $tr->writeDetailValues($insertID, array(
                                //                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                //                                    "produk_id" => $pID,
                                //                                    "key" => $key,
                                //                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                //                                ));
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                ));
                                $insertIDs[] = $dd;
                                $mongoListConnect['detailValues'][] = $dd;

                            }
                        }
                    }
                    if (sizeof($insertIDs) > 0) {
                        $arrBlob = blobEncode($insertIDs);
                        $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                    }
                }


                if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                    foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                            foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => $dSpec[$src],
                                ));

                            }
                        }
                    }
                }

                //
                //region nulis paymentSource
                //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                $paymentSources = $this->config->item("payment_source");
                if (array_key_exists($stepCode, $paymentSources)) {

                    $payConfigs = $paymentSources[$stepCode];
                    if (sizeof($payConfigs) > 0) {
                        foreach ($payConfigs as $paymentSrcConfig) {
                            //					$paymentSrcConfig = $paymentSources[$stepCode];
                            $valueSrc = $paymentSrcConfig['valueSrc'];
                            $externSrc = $paymentSrcConfig['externSrc'];
                            $tr->writePaymentSrc($insertID, array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $tmpNomorNota2,
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                "terbayar" => 0,
                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                "terbayar_valas" => 0,
                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                            ));
                        }
                    }


                    //cekMerah($this->db->last_query());

                }
                else {
                    //cekMerah("TIDAK nulis paymentSrc");
                }
                //endregion


                //region nulis paymentAntiSource
                //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                $paymentSources = $this->config->item("payment_antiSource");
                if (array_key_exists($stepCode, $paymentSources)) {
                    $payConfigs = $paymentSources[$stepCode];
                    if (sizeof($payConfigs) > 0) {
                        foreach ($payConfigs as $paymentSrcConfig) {
                            //					$paymentSrcConfig = $paymentSources[$stepCode];
                            $valueSrc = $paymentSrcConfig['valueSrc'];
                            $externSrc = $paymentSrcConfig['externSrc'];
                            $tr->writePaymentAntiSrc($insertID, array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $tmpNomorNota2,
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                "terbayar" => 0,
                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                            ));
                        }
                    }


                    //cekMerah($this->db->last_query());

                }
                else {
                    //cekMerah("TIDAK nulis paymentSrc");
                }
                //endregion


                $idHis_decode[$stepNum] = array(
                    "olehID" => $_SESSION[$cCode]['main']['olehID'],
                    "olehName" => $_SESSION[$cCode]['main']['olehName'],
                    "step" => $stepNum,
                    "trID" => $insertID,
                    "nomer" => $tmpNomorNota2,
                    "nomer2" => $tmpNomorNota2Alias,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                $idHis_blob = blobEncode($idHis_decode);
                $idHis_intext = print_r($idHis_decode, true);

                $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;

                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "id_master" => $masterID,
                    "id_top" => $insertID,

                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");

                //                if($seluruhnya){
                //                    $dupState = $tr->updateData(array("id" => $insertID), array(
                //                        "tail_number" => $nextStepNum,
                //                        "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$nextStepNum]['target'],
                //
                //                    )) or die("Failed to update trans tail!");
                //                }
                //cekHijau($this->db->last_query());


                $baseRegistries = array(
                    'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                    'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                    'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                    'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                    'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                    'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                    'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                    'items_noapprove' => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),

                    'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                    'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                    'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                    'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                    'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                    'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                    'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                    'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                    'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                    'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                    'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                    'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                    'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                    'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                    'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                    'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                    'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                    'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                    "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                    "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                    "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                    "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                    "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                    "componentsBuilder" => isset($_SESSION[$cCode]['componentsBuilder']) ? $_SESSION[$cCode]['componentsBuilder'] : array(),
                    "jurnalItems" => isset($_SESSION[$cCode]['jurnalItems']) ? $_SESSION[$cCode]['jurnalItems'] : array(),
                );
                $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                $mongRegIDConnect = $doWriteReg;
                //endregion


                //==================================================================================================
                //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
                $this->load->model("Mdls/MdlLockerTransaksi");
                $lt = New MdlLockerTransaksi();
                $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], NULL, $insertID);
                //                mati_disini();
                //==================================================================================================
            }
            else {
                cekMerah("to be delayed to connect to $connector");
            }
        }
        else {
            //cekKuning("not connecting to any tCode");
        }
        //endregion

        //region extConnecting
        // triger dari items contoh produk komposit yang perlu direpack dipusat sebelum di distribusi
        $extConnecting = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['extConnectTo']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['extConnectTo'] : array();
        if (sizeof($extConnecting) > 0) {
            $this->load->Model("Mdls/MdlProdukKomposit");
            $this->load->Model("Mdls/MdlProdukKompositKomposisi");
            $pk = new MdlProdukKomposit();
            $ck = new MdlProdukKompositKomposisi();
            $tempProdukKomposit = $pk->lookUpAll()->result();
            $produkKomposit = array();
            $idProdukKomposit = array();
            $komposisiKomposit = array();
            if (sizeof($tempProdukKomposit) > 0) {
                foreach ($tempProdukKomposit as $kIndex => $kData) {
                    if (isset($_SESSION[$cCode]["items"][$kData->id])) {
                        $produkKomposit[$kData->id] = $_SESSION[$cCode]["items"][$kData->id];
                        $idProdukKomposit[] = $kData->id;
                        $requiredParamKomposit[$kData->id] = array("jml" => $_SESSION[$cCode]["items"][$kData->id]["jml"]);
                    }
                }

            }
            // arrPRint($requiredParamKomposit);
            // matiHEre();
            if (sizeof($produkKomposit) > 0) {
                $ck->addFilter("produk_id in (" . implode(",", $idProdukKomposit) . ")");
                $tmpProdukKompositKomposisi = $ck->lookUpAll_res();
                if (sizeof($tmpProdukKompositKomposisi) > 0) {
                    foreach ($tmpProdukKompositKomposisi as $prID => $tmpProdukKompositKomposisi_0) {
                        $ix = 0;
                        foreach ($tmpProdukKompositKomposisi_0 as $tData) {
                            $ix++;
                            $komposisiKomposit[$prID]["produk"][$ix] = $tData;
                        }
                    }
                }
            }
            $intems2Komposit = array();
            $detil2Sum = array();
            if (sizeof($requiredParamKomposit)) {
                foreach ($requiredParamKomposit as $pid => $pidData) {
                    if (isset($komposisiKomposit[$pid])) {
                        $iex = 0;
                        foreach ($komposisiKomposit[$pid]["produk"] as $iExtID => $extData) {
                            $iex++;
                            $intems2Komposit[$pid]["produk"][$iex] = array(
                                "id" => $extData->produk_dasar_id,
                                "nama" => $extData->produk_dasar_nama,
                                "name" => $extData->produk_dasar_nama,
                                "satuan" => $extData->satuan_nama,
                                "jenis" => $extData->jenis,
                                "jml" => $extData->jml * $pidData["jml"],
                            );
                            $detil2Sum[$extData->produk_dasar_id][] = array(
                                "id" => $extData->produk_dasar_id,
                                "nama" => $extData->produk_dasar_nama,
                                "name" => $extData->produk_dasar_nama,
                                "satuan" => $extData->satuan_nama,
                                "jenis" => $extData->jenis,
                                "jml" => $extData->jml * $pidData["jml"],
                            );
                            // $intemsKomposit
                        }
                    }
                }

                foreach ($_SESSION[$cCode]["items"] as $pID => $iSPec) {
                    if (!isset($requiredParamKomposit[$pID])) {
                        unset($_SESSION[$cCode]['tableIn_detail'][$pID]);
                        unset($_SESSION[$cCode]['tableIn_detail_values'][$pID]);
                    }
                }
            }
            $intems2_sumKomposit = array();
            if (sizeof($detil2Sum) > 0) {
                $srcFieldsExt = $this->config->item("heTransaksi_ui")[$connector]["shoppingCartFields"]["1"];
                foreach ($detil2Sum as $PID => $dataKomposit) {
                    $jmlNeed = 0;
                    foreach ($dataKomposit as $iiD => $tmpData_komposit) {
                        // arrPrint($tmpData_komposit);
                        $jmlNeed += $tmpData_komposit['jml'];
                        $intems2_sumKomposit[$PID] = array(
                            "handler" => "",
                            "id" => $tmpData_komposit['id'],
                            "nama" => $tmpData_komposit['nama'],
                            "name" => $tmpData_komposit['name'],
                            "satuan" => $tmpData_komposit['satuan'],
                            "jenis" => $tmpData_komposit['jenis'],
                            "jml" => $jmlNeed,
                        );
                    }
                }

            }
            // matiHEre(__LINE__);
            $steps = isset($this->config->item("heTransaksi_ui")[$origJenis]['steps']) ? $this->config->item("heTransaksi_ui")[$origJenis]['steps'] : array();
            if (isset($extConnecting[$stepNum]['connecTo']) && (sizeof($produkKomposit) > 0)) {

                cekMerah("NOW CONNECTING to $connector");

                if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                    die("kode connector tidak dikenali!");
                }
                if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                    die("konfigurasi connector harus memiliki step lebih dari satu!");
                }


                $oldCode = $cCode;
                $connector = $extConnecting[$stepNum]['connecTo'];
                $cCode = "_TR_" . $connector;

                $_SESSION[$cCode] = array();

                // matiHere($cCode . " LINE --:::" . __LINE__);
                $_SESSION[$cCode] = array(
                    "main" => $_SESSION[$oldCode]['main'],
                    "items" => $produkKomposit,
                    "items_komposisi" => $komposisiKomposit,
                    "items2" => $intems2Komposit,
                    "items2_sum" => $intems2_sumKomposit,
                    "items3" => array(),
                    "items3_sum" => array(),
                    "items4_sum" => array(),
                    "items_noapprove" => array(),

                    "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                    "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                    //
                    "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                    "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                    //
                    "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                    "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                    "tableIn_detail_values_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'],
                );

                //                    print_r($_SESSION[$cCode]);die();

                //==replace pertama
                $masterReplacersO = array(
                    "jenisTr" => $connector,
                    "jenisTrMaster" => $connector,
                    "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                    "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "placeID" => isset($preReplacer['place2ID']) ? $preReplacer['place2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                    "placeName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                    "place2ID" => $_SESSION[$cCode]['main']['placeID'],
                    "place2Name" => $_SESSION[$cCode]['main']['placeName'],
                    "cabangID" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['main']['place2ID'],
                    "cabangName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$cCode]['main']['place2Name'],
                    "cabang2ID" => $_SESSION[$cCode]['main']['placeID'],
                    "cabang2Name" => $_SESSION[$cCode]['main']['placeName'],
                    //
                    "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                    "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                    "gudangID" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['main']['gudang2ID'],
                    "gudangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['main']['gudang2Name'],
                    "pihakID" => isset($_SESSION[$cCode]['main']['placeID']) ? $_SESSION[$cCode]['main']['placeID'] : "",
                    "pihakName" => isset($_SESSION[$cCode]['main']['placeName']) ? $_SESSION[$cCode]['main']['placeName'] : "",
                    "pihakName2" => $_SESSION[$cCode]['main']['placeName'],
                    "gudang" => $_SESSION[$cCode]['main']['gudangID'],
                    "gudang__name" => $_SESSION[$cCode]['main']['gudangName'],
                    "gudang__label" => $_SESSION[$cCode]['main']['gudangName'],
                    "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",

                );
                foreach ($masterReplacersO as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    //                    $_SESSION[$cCode]['main'][$key] = $val;
                }
                $masterReplacers = array(
                    //                    "referensi_id" => $masterID, (dimatikan)
                    "inv" => $tmpNomorNota,
                    "jenis_master" => $connector,
                    "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                    "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "cabang_id" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$cCode]['tableIn_master']['cabang2_id'],
                    "cabang_nama" => isset($preReplacer['cabang2Name']) ? $preReplacer['cabang2Name'] : $_SESSION[$cCode]['tableIn_master']['cabang2_nama'],
                    "cabang2_id" => $_SESSION[$cCode]['tableIn_master']['cabang_id'],
                    "cabang2_nama" => $_SESSION[$cCode]['tableIn_master']['cabang_nama'],
                    "gudang_id" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['tableIn_master']['gudang2_id'],
                    "gudang_nama" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['tableIn_master']['gudang2_nama'],
                    "gudang2_id" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                    "gudang2_nama" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                    "gudang" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                    "gudang__name" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                    "gudang__label" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],

                    "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                    "step_current" => 1,
                    "step_number" => 1,
                    "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                    "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                    "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                    "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                    "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",
                    //===references
                    //                    "id_master"            => $masterID,
                    //                    "id_top"               => $topID,
                    //                    "ids_prev"             => base64_encode(serialize(array($prevProp['id']))),
                    //                    "ids_prev_intext"      => print_r(array($prevProp['id'], true)),
                    //                    "nomer_top"            => $_SESSION[$cCode]['main']['nomer'],
                    //                    "nomers_prev"          => base64_encode(serialize(array($prevProp['nomer']))),
                    //                    "nomers_prev_intext"   => print_r(array($prevProp['nomer'], true)),
                    //                    "jenis_top"            => $this->jenisTr,
                    //                    "jenises_prev"        => base64_encode(serialize(array($prevProp['jenis']))),
                    //                    "jenises_prev_intext" => print_r(array($prevProp['jenis'], true)),
                );

                foreach ($masterReplacers as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }


                //region penomoran receipt #2
                //<editor-fold desc="==========penomoran">
                $this->load->model("CustomCounter");
                $cn = new CustomCounter("transaksi");
                $cn->setType("transaksi");

                $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                    die(__LINE__ . " Used number should be registered in 'counters' config as well");
                }

                foreach ($counterForNumber as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                }

                $tmpNomorNota2 = $paramSpec['paramString'];
                $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);


                //</editor-fold>
                //endregion

                //region dynamic counters #2
                // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                $cn = new CustomCounter("transaksi");
                $cn->setType("transaksi");
                $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                $configCustomParams[] = "stepCode";
                if (sizeof($configCustomParams) > 0) {
                    $cContent = array();
                    foreach ($configCustomParams as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                        $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                        switch ($paramSpec['id']) {
                            case 0: //===counter type is new
                                $paramKeyRaw = print_r($cParams, true);
                                $paramValuesRaw = print_r($cValues[$i], true);
                                $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                break;
                            default: //===counter to be updated
                                $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                break;
                        }
                        //echo "<hr>";
                    }
                }
                $appliedCounters2 = base64_encode(serialize($cContent));
                $appliedCounters_inText2 = print_r($cContent, true);
                // </editor-fold>
                //endregion


                $addValues = array(
                    'counters' => $appliedCounters2,
                    'counters_intext' => $appliedCounters_inText2,
                    'nomer' => $tmpNomorNota,
                    'dtime' => date("Y-m-d H:i:s"),
                    'fulldate' => date("Y-m-d"),
                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

                //===cloning nota cab1 ke cab2
                //===daftar perbedaan
                //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,

                //==replace kedua
                $masterReplacers = array(
                    "nomer" => $tmpNomorNota2,
                    "nomer2" => $tmpNomorNota2Alias,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                foreach ($masterReplacers as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

                //===cloning detail/items cabang1 ke cabang2
                //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                $detailReplacers = array(
                    "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                    "sub_step_current" => 1,
                    "sub_step_number" => 1,
                    "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                    "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                    "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                    "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                    //                    "next_substep_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                    //                    "next_substep_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                    //                    "next_subgroup_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                );
                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                    //                    cekmerah("tulis rincian transaksi kedua");
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                        foreach ($dSpec as $key => $val) {
                            $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                        }
                    }
                }
                else {
                    //                    cekmerah("GAGAL tulis rincian transaksi kedua");
                }


                //region ----------write transaksi & transaksi_data #2
                if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                    $tr = new MdlTransaksi();
                    $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                    $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                    cekUngu($this->db->last_query());
                    $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                    $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                    $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                    $mongoListConnect['main'] = array($insertID, $epID);
                    cekmerah("tulis transaksi kedua :: trID $insertID");
                    cekmerah($this->db->last_query());
                    if ($insertID < 1) {
                        die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                }
                else {
                    cekmerah("GAGAL tulis transaksi kedua");
                }

                if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                    $inserMainValues = array();
                    foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $inserMainValues[] = $dd;
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                    if (sizeof($inserMainValues) > 0) {
                        $arrBlob = blobEncode($inserMainValues);
                        $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                    }
                }


                if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                    foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                }
                if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                    foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $inserMainValues[] = $dd;
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                }

                if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                    //                    cekMerah("ada mainElements");
                    foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                        $tr->writeMainElements($insertID, array(
                            "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                            "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                            "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                            "name" => $aSpec['name'],
                            "label" => $aSpec['label'],
                            "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                            "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                        ));
                    }
                }


                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                    $insertIDs = array();
                    $insertDeIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                        $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                        if ($insertDetailID < 1) {
                            die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertDetailID;
                            $insertDeIDs[$insertID][] = $insertDetailID;
                            $mongoListConnect['detail'][] = $insertDetailID;
                        }
                        if ($epID != 999) {
                            $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                            if ($insertEpID < 1) {
                                die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                            }
                            else {
                                $insertIDs[] = $insertEpID;
                                $insertDeIDs[$epID][] = $insertEpID;
                                $mongoListConnect['detail'][] = $insertEpID;
                            }
                        }
                    }
                    if (sizeof($insertIDs) == 0) {
                        die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                    }
                    else {
                        $indexing_details = array();
                        foreach ($insertDeIDs as $key => $numb) {
                            $indexing_details[$key] = $numb;
                        }

                        foreach ($indexing_details as $k => $arrID) {
                            $arrBlob = blobEncode($arrID);
                            $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                            cekOrange($this->db->last_query());
                        }
                    }
                }

                if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                    $insertIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                        $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                        $mongoListConnect['detail'] = $insertIDs;
                        if ($epID != 999) {
                            $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                            $mongoListConnect['detail'] = $mongoListConnect['detail'] = $insertIDs;;
                        }
                    }
                }

                if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                    $insertIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                            foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                //                                $insertIDs[$pID][] = $tr->writeDetailValues($insertID, array(
                                //                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                //                                    "produk_id" => $pID,
                                //                                    "key" => $key,
                                //                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                //                                ));
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                ));
                                $insertIDs[] = $dd;
                                $mongoListConnect['detailValues'][] = $dd;

                            }
                        }
                    }
                    if (sizeof($insertIDs) > 0) {
                        $arrBlob = blobEncode($insertIDs);
                        $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                    }
                }


                if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                    foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                            foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => $dSpec[$src],
                                ));

                            }
                        }
                    }
                }

                //
                //region nulis paymentSource
                //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                $paymentSources = $this->config->item("payment_source");
                if (array_key_exists($stepCode, $paymentSources)) {

                    $payConfigs = $paymentSources[$stepCode];
                    if (sizeof($payConfigs) > 0) {
                        foreach ($payConfigs as $paymentSrcConfig) {
                            //					$paymentSrcConfig = $paymentSources[$stepCode];
                            $valueSrc = $paymentSrcConfig['valueSrc'];
                            $externSrc = $paymentSrcConfig['externSrc'];
                            $tr->writePaymentSrc($insertID, array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $tmpNomorNota2,
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                "terbayar" => 0,
                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                "terbayar_valas" => 0,
                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                            ));
                        }
                    }


                    //cekMerah($this->db->last_query());

                }
                else {
                    //cekMerah("TIDAK nulis paymentSrc");
                }
                //endregion


                //region nulis paymentAntiSource
                //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                $paymentSources = $this->config->item("payment_antiSource");
                if (array_key_exists($stepCode, $paymentSources)) {
                    $payConfigs = $paymentSources[$stepCode];
                    if (sizeof($payConfigs) > 0) {
                        foreach ($payConfigs as $paymentSrcConfig) {
                            //					$paymentSrcConfig = $paymentSources[$stepCode];
                            $valueSrc = $paymentSrcConfig['valueSrc'];
                            $externSrc = $paymentSrcConfig['externSrc'];
                            $tr->writePaymentAntiSrc($insertID, array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $tmpNomorNota2,
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                "terbayar" => 0,
                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                            ));
                        }
                    }


                    //cekMerah($this->db->last_query());

                }
                else {
                    //cekMerah("TIDAK nulis paymentSrc");
                }
                //endregion


                $idHis_decode[$stepNum] = array(
                    "olehID" => $_SESSION[$cCode]['main']['olehID'],
                    "olehName" => $_SESSION[$cCode]['main']['olehName'],
                    "step" => $stepNum,
                    "trID" => $insertID,
                    "nomer" => $tmpNomorNota2,
                    "nomer2" => $tmpNomorNota2Alias,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                $idHis_blob = blobEncode($idHis_decode);
                $idHis_intext = print_r($idHis_decode, true);

                $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;

                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "id_master" => $masterID,
                    "id_top" => $insertID,

                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");

                //                if($seluruhnya){
                //                    $dupState = $tr->updateData(array("id" => $insertID), array(
                //                        "tail_number" => $nextStepNum,
                //                        "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$nextStepNum]['target'],
                //
                //                    )) or die("Failed to update trans tail!");
                //                }
                //cekHijau($this->db->last_query());


                $baseRegistries = array(
                    'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                    'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                    'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                    'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                    'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                    'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                    'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),
                    'items_noapprove' => isset($_SESSION[$cCode]['items_noapprove']) ? $_SESSION[$cCode]['items_noapprove'] : array(),

                    'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                    'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                    'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                    'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                    'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                    'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                    'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                    'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                    'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                    'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                    'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                    'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                    'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                    'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                    'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                    'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                    'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                    'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                    "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                    "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                    "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                    "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                    "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                );
                // arrPrint($baseRegistries);
                // matiHere();
                $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                $mongRegIDConnect = $doWriteReg;
                //endregion


                //==================================================================================================
                //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
                $this->load->model("Mdls/MdlLockerTransaksi");
                $lt = New MdlLockerTransaksi();
                $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], NULL, $insertID);
                //                mati_disini();
                //==================================================================================================


            }
            else {
                cekMerah("no data ext to conected");
            }

            // matiHEre($connector);
            // arrPrint($_SESSION[$cCode]["items"]);
            // arrPrint($produkKomposit);


        }
        // arrPrint($komposisiKomposit);
        // matiHEre(__LINE__ . " cek extConnectig antar cabang");
        //endregion


        //region check stoc produk

        //        $stopdulu=false;
        //        if(!$stopdulu){

        $trr = new MdlTransaksi();
        $trr->setFilters(array());
        $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $trr->addFilter("param='main'");
        $tmpReg = $trr->lookupRegistries()->result();

        $origRequest = array();
        $stockActive = array();
        $pushToRequestPO = array();
        $pushToDisribution = array();

        $totalUnitToPush = 0;
        if (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['pushPurchas'][$stepNum])) {
            //                matidisini("under maintenance ".__LINE__);
            if (sizeof($tmpTr) > 0) {
                $items = array();
                $trIDs = array();
                $lastTRID = 0;
                $cabang2_id = array();
                $gudang2_id = array();
                foreach ($tmpTr as $row) {
                    $cabang2_id[$row->produk_id] = $row->cabang2_id;
                    $gudang2_id[$row->produk_id] = $row->gudang2_id;
                    if (!array_key_exists($row->produk_id, $items)) {
                        $items[$row->produk_id] = 0;
                    }
                    $items[$row->produk_id] += $row->valid_qty;
                    if (!in_array($row->id_master, $trIDs)) {
                        $trIDs[] = $row->id_master;
                    }
                    $lastTRID = $row->transaksi_id;
                }
                if (sizeof($tmpReg) > 0) {
                    $oldMain = unserialize(base64_decode($tmpReg[0]->values));
                }
                $targetProc = base_url() . $this->config->item("heTransaksi_ui")[$this->jenisTr]['itemSwapper'] . "/$this->jenisTr/?items=" . base64_encode(serialize($items)) . "&main=" . base64_encode(serialize($oldMain)) . "&trs=" . base64_encode(serialize($trIDs));
                $lockerConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['lockerCheckAppr']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['lockerCheckAppr'] : array();
                $selectorModel = $this->config->item('heTransaksi_ui')[$this->jenisTr]['selectorModel'];
                $selectorSrcModel = $this->config->item('heTransaksi_ui')[$this->jenisTr]['selectorSrcModel'];
                $this->load->model("Mdls/" . $selectorSrcModel);
                $b = new $selectorSrcModel();
                $arrItems = isset($items) ? $items : array();
                $arrTrID = isset($trIDs) ? $trIDs : array();
                $arrMain = isset($oldMain) ? $oldMain : array();

                if (sizeof($arrItems) > 0) {

                    foreach ($arrItems as $id => $jmlParam) {
                        $tmpB = $b->lookupByID($id)->result();
                        $jml = $jmlParam;//jumlah dari request

                        if (!isset($origRequest[$id])) {
                            $origRequest[$id] = $jml;
                        }
                        if (!isset($pushToRequestPO[$id])) {
                            $pushToRequestPO[$id] = 0;
                        }
                        if (!isset($pushToDisribution[$id])) {
                            $pushToDisribution[$id] = 0;
                        }

                        if (sizeof($tmpB) > 0) {
                            foreach ($tmpB as $row) {
                                cekHitam("####BEGIN####");
                                if (isset($lockerConfig['enabled']) && $lockerConfig['enabled'] == true) {
                                    cekMerah("masuk locker config");
                                    $mdlName = $lockerConfig['mdlName'];
                                    $this->load->model("Mdls/" . $mdlName);
                                    $c = new $mdlName();
                                    $c->addFilter("produk_id='$id'");
                                    $c->addFilter("state='active'");
                                    $c->addFilter("cabang_id=" . $cabang2_id[$id]);
                                    $c->addFilter("gudang_id=" . $gudang2_id[$id]);
                                    $tmpC = $c->lookupAll($id)->result();
                                    cekHere($this->db->last_query());

                                    if (sizeof($tmpC) > 0) {

                                        foreach ($tmpC as $row) {
                                            $satuan = strlen($row->satuan) > 0 ? $row->satuan : "n/a";
                                            $nama = $row->nama;

                                            $jml_now = $row->jumlah;//jumlah dari stocklocker
                                            $stockActive[$id] = $row->jumlah;
                                            if (!array_key_exists($id, $_SESSION[$cCode]['items'])) {
                                                $jml_sudah_diambil = 0;
                                                $jml_diperlukan = $jml_now > $jmlParam ? $jmlParam : $jml_now;
                                                $jml_nambah = $jml_now > $jmlParam ? $jmlParam : $jml_now;
                                            }
                                            else {
                                                if (isset($_GET['newQty'])) {
                                                    $jml_sudah_diambil = $_SESSION[$cCode]['items'][$id]['jml'];
                                                    $jml_diperlukan = $_GET['newQty'];
                                                    $jml_nambah = $jml_diperlukan - $jml_sudah_diambil;
                                                }
                                                else {
                                                    $jml_sudah_diambil = $_SESSION[$cCode]['items'][$id]['jml'];
                                                    $jml_diperlukan = $jml_sudah_diambil + $jml;
                                                    $jml_nambah = $jml_now > $jml ? $jml : $jml_now;
                                                }
                                            }
                                            //  region validasi stok
                                            //  jml=jml direq || jml_now=jml yg active di locker

                                            if ($jml > $jml_now) {
                                                //                                                echo "<script>top.alert('stok $nama tidak cukup. (perlu $jmlParam, nambah $jml_nambah stok $jml_now)')";
                                                //                                                echo "</script>";
                                                $pushToRequestPO[$id] = $jml - $jml_now;
                                                $pushToDisribution[$id] = $jml_now;
                                                $totalUnitToPush += $jml - $jml_now;
                                            }
                                            else {
                                                $pushToDisribution[$id] = $jml;
                                            }


                                            //  endregion validasi stok
                                            //                                            $this->db->trans_start();
                                            //  region update locker active

                                            $where = array(
                                                "id" => $row->id,
                                            );
                                            $data_active = array(
                                                "jumlah" => $jml_now - $jml_nambah,
                                                "state" => "active",
                                            );
                                            //                                            $c->updateData($where, $data_active);
                                            //                                            cekHere($this->db->last_query());
                                            //  endregion update locker active

                                            //  region locker hold
                                            //                                            $array_hold_sebelumnya = $c->cekLoker($this->session->login['cabang_id'], $id, "hold", $this->session->login['id'], "0", $this->session->login['gudang_id']);
                                            $array_hold_sebelumnya = $c->cekLoker($cabang2_id[$id], $id, "hold", $this->session->login['id'], "0", $gudang2_id[$id]);
                                            if (sizeof($array_hold_sebelumnya) > 0) {
                                                $where = array(
                                                    "id" => $array_hold_sebelumnya['id'],
                                                );
                                                $data_hold = array(
                                                    "jumlah" => $array_hold_sebelumnya['jumlah'] + $jml_nambah,
                                                );
                                                //                                                $c->updateData($where, $data_hold);
                                                //                                                cekHere($this->db->last_query());
                                            }
                                            else {
                                                $data_hold = array(
                                                    "jenis" => "supplies",
                                                    "cabang_id" => $cabang2_id[$id],
                                                    "produk_id" => $id,
                                                    "nama" => $nama,
                                                    "satuan" => $row->satuan,
                                                    "state" => "hold",
                                                    "jumlah" => $jml_nambah,
                                                    "oleh_id" => $this->session->login['id'],
                                                    "oleh_nama" => $this->session->login['nama'],
                                                    "gudang_id" => $gudang2_id[$id],
                                                );
                                                //                                                $c->addData($data_hold);
                                                //                                                cekHere($this->db->last_query());
                                            }

                                            //  endregion locker hold
                                            //  $this->db->trans_complete() or die("Gagal bro");

                                            $tmpJml = $jml_diperlukan;

                                        }
                                        //                                        arrPrint($tmpC);
                                    }
                                    else {
                                        //                                        mati_disini("tidak ditemukan item " . $row->nama . " di locker stock.");
                                        $pushToRequestPO[$id] = $jml;
                                        $totalUnitToPush += $jml;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }


        //        cekHitam("## origRequest ##");
        //        arrPrint($origRequest);
        //        cekHitam("## stockActive ##");
        //        arrPrint($stockActive);
        //        cekHitam("## pushToRequestPO ##");
        //        arrPrint($pushToRequestPO);
        //        cekHitam("## pushToDisribution ##");
        //        arrPrint($pushToDisribution);
        //
        //        cekOrange("## totalUnitToPush: $totalUnitToPush ##");
        //matiHere();
        //        }

        //endregion check stock produk

        //region connecting connectToPrePurchase
        $mongPrePurcash = array();
        $mongPrePurcashReg = array();
        if ($totalUnitToPush > 0) {

            cekMerah("total Unit To Push: $totalUnitToPush || ada yg akan masuk purchase...!");
            //cekMerah("//cek connecting dari $origJenis========================================");
            $steps = isset($this->config->item("heTransaksi_ui")[$origJenis]['steps']) ? $this->config->item("heTransaksi_ui")[$origJenis]['steps'] : array();
            $connector = isset($this->config->item("heTransaksi_ui")[$origJenis]['connectToPrePurchase']) ? $this->config->item("heTransaksi_ui")[$origJenis]['connectToPrePurchase'] : "";

            if (strlen($connector) > 0) {
                cekMerah("to be connected to $connector");
                if ($stepNum == sizeof($steps)) {
                    cekMerah("now connecting to $connector");
                    if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                        die("kode connector tidak dikenali!");
                    }
                    if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                        die("konfigurasi connector harus memiliki step lebih dari satu!");
                    }

                    $oldCode = $cCode;
                    $cCode = "_TR_" . $connector;

                    $_SESSION[$cCode] = array();
                    $_SESSION[$cCode] = array(
                        "main" => $_SESSION[$oldCode]['main'],
                        "items" => $_SESSION[$oldCode]['items'],
                        "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                        "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                        "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                        //                    "out_detail_rsltItems" => $_SESSION[$oldCode]['out_detail_rsltItems'],
                        "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                        "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                        "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                        "tableIn_detail_values_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'],
                    );

                    //==replace pertama
                    $masterReplacersO = array(
                        "jenisTr" => $connector,
                        "jenisTrMaster" => $connector,
                        "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                        "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "placeID" => $_SESSION[$cCode]['main']['placeID'],
                        "placeName" => $_SESSION[$cCode]['main']['placeName'],
                        "place2ID" => $_SESSION[$cCode]['main']['place2ID'],
                        "place2Name" => $_SESSION[$cCode]['main']['place2Name'],
                        "cabangID" => $_SESSION[$cCode]['main']['placeID'],
                        "cabangName" => $_SESSION[$cCode]['main']['placeName'],
                        "cabang2ID" => $_SESSION[$cCode]['main']['place2ID'],
                        "cabang2Name" => $_SESSION[$cCode]['main']['place2Name'],
                        "gudang2ID" => $_SESSION[$cCode]['main']['gudang2ID'],
                        "gudang2Name" => $_SESSION[$cCode]['main']['gudang2Name'],
                        "gudangID" => $_SESSION[$cCode]['main']['gudangID'],
                        "gudangName" => $_SESSION[$cCode]['main']['gudangName'],
                        "pihakID" => "",
                        "pihakName" => "",
                        "pihakName2" => "",
                        "gudang" => "",
                        "gudang__name" => "",
                        "gudang__label" => "",

                    );
                    //                arrPrint($masterReplacersO);
                    //                matiHere();
                    foreach ($masterReplacersO as $key => $val) {
                        $_SESSION[$cCode]['main'][$key] = $val;
                    }

                    //                arrPrint($_SESSION[$cCode]['main']);
                    //                matiHere();
                    $masterReplacers = array(
                        //                    "referensi_id" => $masterID, (dimatikan)
                        "inv" => $tmpNomorNota,
                        "jenis_master" => $connector,
                        "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                        "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "cabang_id" => $_SESSION[$cCode]['tableIn_master']['cabang_id'],
                        "cabang_nama" => $_SESSION[$cCode]['tableIn_master']['cabang_nama'],
                        "cabang2_id" => $_SESSION[$cCode]['tableIn_master']['cabang2_id'],
                        "cabang2_nama" => $_SESSION[$cCode]['tableIn_master']['cabang2_nama'],
                        "gudang_id" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                        "gudang_nama" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                        "gudang2_id" => $_SESSION[$cCode]['tableIn_master']['gudang2_id'],
                        "gudang2_nama" => $_SESSION[$cCode]['tableIn_master']['gudang2_nama'],
                        "gudang" => "",
                        "gudang__name" => "",
                        "gudang__label" => "",

                        "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                        "step_current" => 1,
                        "step_number" => 1,
                        "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                        "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                        "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                        "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                        //===references
                        //                    "id_master"            => $masterID,
                        //                    "id_top"               => $topID,
                        //                    "ids_prev"             => base64_encode(serialize(array($prevProp['id']))),
                        //                    "ids_prev_intext"      => print_r(array($prevProp['id'], true)),
                        //                    "nomer_top"            => $_SESSION[$cCode]['main']['nomer'],
                        //                    "nomers_prev"          => base64_encode(serialize(array($prevProp['nomer']))),
                        //                    "nomers_prev_intext"   => print_r(array($prevProp['nomer'], true)),
                        //                    "jenis_top"            => $this->jenisTr,
                        //                    "jenises_prev"        => base64_encode(serialize(array($prevProp['jenis']))),
                        //                    "jenises_prev_intext" => print_r(array($prevProp['jenis'], true)),
                    );
                    //                arrPrint($masterReplacers);
                    //                matiHere();
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //region penomoran receipt #2
                    //<editor-fold desc="==========penomoran">
                    $this->load->model("CustomCounter");
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");

                    $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                    arrPrint($counterForNumber);
                    arrPrint($connector);
                    if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                        die(__LINE__ . " Used number should be registered in 'counters' config as well");
                    }

                    foreach ($counterForNumber as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    }

                    $tmpNomorNota2 = $paramSpec['paramString'];
                    $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);

                    //</editor-fold>
                    //endregion

                    //region dynamic counters #2
                    // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");
                    $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                    $configCustomParams[] = "stepCode";
                    if (sizeof($configCustomParams) > 0) {
                        $cContent = array();
                        foreach ($configCustomParams as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                            $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                            switch ($paramSpec['id']) {
                                case 0: //===counter type is new
                                    $paramKeyRaw = print_r($cParams, true);
                                    $paramValuesRaw = print_r($cValues[$i], true);
                                    $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                    break;
                                default: //===counter to be updated
                                    $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                    break;
                            }
                            //echo "<hr>";
                        }
                    }
                    $appliedCounters2 = base64_encode(serialize($cContent));
                    $appliedCounters_inText2 = print_r($cContent, true);
                    // </editor-fold>
                    //endregion

                    $addValues = array(
                        'counters' => $appliedCounters2,
                        'counters_intext' => $appliedCounters_inText2,
                        'nomer' => $tmpNomorNota,
                        'dtime' => date("Y-m-d H:i:s"),
                        'fulldate' => date("Y-m-d"),
                    );
                    foreach ($addValues as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning nota cab1 ke cab2
                    //===daftar perbedaan
                    //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,

                    //==replace kedua
                    $masterReplacers = array(
                        "nomer" => $tmpNomorNota2,
                        "nomer2" => $tmpNomorNota2Alias,
                        "counters" => $appliedCounters2,
                        "counters_intext" => $appliedCounters_inText2,
                    );
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning detail/items cabang1 ke cabang2
                    //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code

                    //                arrPrint($_SESSION[$cCode]['tableIn_detail']);

                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                            if (isset($pushToRequestPO)) {
                                foreach ($pushToRequestPO as $pid => $vals) {

                                    $detailReplacers[$pid] = array(
                                        "valid_qty" => $vals,
                                        "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                                        "sub_step_current" => 1,
                                        "sub_step_number" => 1,
                                        "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                                        "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                                        "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                                        "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                                    );

                                    if ($vals > 0) {
                                        foreach ($dSpec as $key => $val) {
                                            if ($pid == $k) {
                                                $_SESSION[$cCode]['tableIn_detail'][$pid][$key] = isset($detailReplacers[$pid][$key]) ? $detailReplacers[$pid][$key] : $val;
                                                //                                            cekMerah("pid build: " . $pid);
                                            }
                                        }

                                    }
                                    else {
                                        foreach ($dSpec as $key => $val) {
                                            if ($pid == $k) {
                                                unset($_SESSION[$cCode]['tableIn_detail'][$pid]);
                                                //                                            cekMerah("pid delete: " . $pid);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else {
                        //                    cekmerah("GAGAL tulis rincian transaksi kedua");
                    }

                    //region ----------write transaksi & transaksi_data #2
                    if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                        $tr = new MdlTransaksi();
                        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                        $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                        cekUngu(__LINE__ . " " . $this->db->last_query());
                        $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                        $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                        $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                        $mongPrePurcash['main'] = array($insertID, $epID);
                        cekmerah("tulis transaksi kedua :: trID $insertID");
                        cekmerah(__LINE__ . " " . $this->db->last_query());
                        if ($insertID < 1) {
                            die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                        }
                    }
                    else {
                        cekmerah("GAGAL tulis transaksi ketiga");
                    }

                    if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $mongPrePurcash['mainValues'][] = $dd;
                        }
                    }


                    if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                        foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $mongPrePurcash['mainValues'][] = $dd;
                        }
                    }
                    if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                        foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $mongPrePurcash['mainValues'][] = $dd;
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                        //                    cekMerah("ada mainElements");
                        foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                            $tr->writeMainElements($insertID, array(
                                "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                "name" => $aSpec['name'],
                                "label" => $aSpec['label'],
                                "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                            ));
                        }
                    }
                    else {
                        //                    cekMerah("TAK ada mainElements");
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                            $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                            $mongPrePurcash['detail'] = $insertIDs;
                            if ($epID != 999) {
                                $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                $mongPrePurcash['detail'] = $insertIDs;
                            }
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                            $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                            $mongPrePurcash['detail'] = $insertIDs;
                            if ($epID != 999) {
                                $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                $mongPrePurcash['detail'] = $insertIDs;
                            }
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                                foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                    $dd = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                    ));
                                    $insertIDs[] = $dd;
                                    $mongPrePurcash['detailValues'][] = $dd;

                                }
                            }
                        }
                    }


                    if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                                foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                    $dd = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => $dSpec[$src],
                                    ));
                                    $insertIDs[] = $dd;
                                    $mongPrePurcash['detailValues'][] = $dd;

                                }
                            }
                        }
                    }

                    //
                    //region nulis paymentSource
                    //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                    $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_source");
                    if (array_key_exists($stepCode, $paymentSources)) {

                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentSrc($insertID, array(
                                    "jenis" => $stepCode,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $tmpNomorNota2,
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                    "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                    "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                    "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                    "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                    "terbayar_valas" => 0,
                                    "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                ));
                            }
                        }


                        //cekMerah(__LINE__. " " .$this->db->last_query());

                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion

                    //region nulis paymentAntiSource
                    //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                    $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_antiSource");
                    if (array_key_exists($stepCode, $paymentSources)) {
                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentAntiSrc($insertID, array(
                                    "jenis" => $stepCode,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $tmpNomorNota2,
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                ));
                            }
                        }


                        //cekMerah(__LINE__. " " .$this->db->last_query());

                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion

                    $idHis_decode[$stepNum] = array(
                        "step" => $stepNum,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota2,
                        "nomer2" => $tmpNomorNota2Alias,
                        "counters" => $appliedCounters2,
                        "counters_intext" => $appliedCounters_inText2,
                    );
                    $idHis_blob = blobEncode($idHis_decode);
                    $idHis_intext = print_r($idHis_decode, true);

                    $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                    $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;

                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array("id" => $insertID), array(
                        "id_master" => $masterID,
                        "id_top" => $insertID,

                        "ids_his" => $idHis_blob,
                        "ids_his_intext" => $idHis_intext,

                    )) or die("Failed to update tr next-state!");

                    //                if($seluruhnya){
                    //                    $dupState = $tr->updateData(array("id" => $insertID), array(
                    //                        "tail_number" => $nextStepNum,
                    //                        "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$nextStepNum]['target'],
                    //
                    //                    )) or die("Failed to update trans tail!");
                    //                }
                    //cekHijau(__LINE__. " " .$this->db->last_query());


                    $baseRegistries = array(
                        'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                        'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                        'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                        'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                        'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                        'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                        'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                        'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                        'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                        'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                        'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                        'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                        'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                        'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                        'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                        'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                        'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                        'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                        'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                        'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                        "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                        "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                        "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                    );
                    $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                    $mongPrePurcashReg = $doWriteReg;
                    //endregion
                }
                else {
                    //cekMerah("to be delayed to connect to $connector");
                }
            }
            else {
                //cekKuning("not connecting to any tCode");
            }
        }
        //endregion

        //region nonactive allowed shipment
        $cekvalidateOverDue = isset($_SESSION[$cCode]['main']['customerID']) ? validateOverDue($_SESSION[$cCode]['main']['customerID']) : array();
        if (isset($cekvalidateOverDue['status']) && $cekvalidateOverDue['status'] == "allowed") {
            $this->load->model("Mdls/MdlOverDuePass");
            $od = new MdlOverDuePass();
            $where = array(
                "customers_id" => $_SESSION[$cCode]['main']['customerID'],
                "jenis" => "forever",
            );
            $arrUpdate = array(
                "status" => "0",
                "used_byID" => $_SESSION['login']['nama'],
                "used_byNama" => $_SESSION['login']['nama'],
                "used_id" => $insertID,
                "nomor" => $tmpNomorNota,

            );
            $od->updateData($where, $arrUpdate, $od->getTableName());
        }
        //endregion

        //region Com pre purchase
        //split to Pre Pre Purchase Supplies dari Request Cabang untuk stok yang tidak ada/kurang diPusat.
        //sekaligus check jika valid_qty sudah nol maka update next_substep_code transaksi bayangannya.
        $iterator = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['comPrePurchase'][$stepNum]['detail']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['comPrePurchase'][$stepNum]['detail'] : array();
        $aliasMainTrans = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['aliasMainTrans']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['aliasMainTrans'] : 999;

        cekOrange("LINE: " . __LINE__ . " || JENIS: " . $this->jenisTr);
        cekOrange("LINE: " . __LINE__ . " || aliasMainTrans: " . $aliasMainTrans);

        if (sizeof($iterator) > 0) {

            $this->load->model("MdlTransaksi");
            $l = new MdlTransaksi();
            $l->setFilters(array());
            $l->addFilter("transaksi_data.valid_qty>0");
            $l->addFilter("transaksi_data.next_substep_code='" . $aliasMainTrans . "'");
            $l->addFilter("link_id=0");
            $l->addFilter("produk_id in (" . implode(",", array_keys($_SESSION[$cCode]['items'])) . ")");
            $tmp = $l->lookupJoined()->result();

            if (sizeof($tmp) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];

                    echo "post-processor: $comName<br>LINE: " . __LINE__;
                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {
                            $tmpOutParams['loop'][$key] = $value;
                        }
                    }
                    if (sizeof($dSpec) > 0) {
                        foreach ($dSpec as $pid => $arrValue) {
                            $tmpOutParams[$srcGateName][$pid] = $arrValue['jml'];
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {
                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;
                        }
                        if (!isset($tmpOutParams['static']["jenis"])) {
                            $tmpOutParams['static']["jenis"] = $aliasMainTrans;
                        }
                        if (!isset($tmpOutParams['static']["jenis_master"])) {
                            $tmpOutParams['static']["jenis_master"] = $this->jenisTr;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }

        }
        else {
            cekHere("LINE: " . __LINE__ . " || jenis: " . $this->jenisTr . " Tidak masuk Iterator PRE PURCHASE SUPPLIES");
        }
        //endregion Com pre purchase

        //region nulis ke data jika ada
        $addTodata = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addData"][$stepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addData"][$stepNum] : array();
        if (sizeof($addTodata) > 0) {
            $gateData = isset($_SESSION[$cCode][$addTodata["gate"]]) ? $_SESSION[$cCode][$addTodata["gate"]] : array();
            $selectedFields = $addTodata["fieldName"];
            $dataMdl = $addTodata["MdlNameMain"];
            $this->load->model("DComs/" . $dataMdl);
            $d = new $dataMdl();
            $childMdl = $addTodata["MdlNameChild"];
            $d = new $dataMdl();
            if (sizeof($gateData) > 0) {
                $outparams = array();
                $ctr = 0;
                foreach ($gateData as $gateValues) {
                    $params = array();
                    $ctr++;
                    foreach ($selectedFields as $colum => $gate_collom) {
                        $params['static'][$colum] = $gateValues[$gate_collom];
                    }
                    if ($masterID != "") {
                        $params['static']['transaksi_id_request_bunga'] = $masterID;
                    }
                    if ($insertID != "") {
                        $params['static']['transaksi_id'] = $insertID;
                    }
                    if ($this->session->login['nama_login'] != "") {
                        $params['static']['nama_login'] = $this->session->login['nama_login'];
                    }
                    if ($this->session->login['id'] != "") {
                        $params['static']['pihakid'] = $this->session->login['id'];
                    }
                    if ($tmpNomorNota2 != "") {
                        $params['static']['tmpNomorNota2'] = $tmpNomorNota2;
                    }
                    $outparams[] = $params + array("MdlName" => $childMdl);
                }

                if (sizeof($outparams) > 0) {
                    $d->pair($outparams) or die("Tidak berhasil memasang  values pada post-processor: $dataMdl/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $d->exec() or die("Gagal saat berusaha  exec values pada post-processor: $dataMdl/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    //                cekLime($this->db->last_query());

                }
                else {
                    matiHEre("error on insert data");
                }
            }
        }
        //        matiHere();


        //endregion

        //==tampilkan receipt
        cekOrange("-- DONE --");

        //region writelog
        echo "<script>top.writeProgress('sedang menulis ke log');</script>";
        $this->load->model("Mdls/" . "MdlActivityLog");
        $hTmp = new MdlActivityLog();
        $tmpHData = array(
            "title" => $_SESSION[$cCode]['main']['jenisTrName'],
            "sub_title" => "Saving followup process",
            "uid" => $this->session->login['id'],
            "uname" => $this->session->login['nama'],
            "dtime" => date("Y-m-d H:i:s"),
            "transaksi_id" => $insertID,
            "deskripsi_old" => "",
            "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
            "jenis" => $this->jenisTr,
            "ipadd" => $_SERVER['REMOTE_ADDR'],
            "devices" => $_SERVER['HTTP_USER_AGENT'],
            "category" => "transaksi",
            "controller" => $this->uri->segment(1),
            "method" => $this->uri->segment(2),
            "url" => current_url(),

        );
        $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Gagal menulis riwayat data", __FILE__));
        //endregion


        //        echo "<script>top.close_holdon()</script>";
        $endtime = microtime(true); // Bottom of page
        $val = $endtime - $starttime;

//        mati_disini(__FUNCTION__ . "  TRANSAKSI BERHASIL (UNDER MAINTENANCE)  <br> silahkan tutup browser terlebih dahulu. <br>execute in " . $val . " ms");

        //        if($this->jenisTr == "1119"){
        //            mati_disini(__FUNCTION__ . " *** TRANSAKSI BERHASIL (UNDER MAINTENANCE) *** <br> silahkan tutup browser terlebih dahulu ");
        //        }
        //        arrPrint($mongoList);
        //        arrPrint($mongUpdateList);
        //        arrPrint($mongRegID);


        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");


        //region cloning ke mongo

        //region update transaksi transaksi data mongo prev step
        if (sizeof($mongUpdateList) > 0) {
            $mong = new MdlMongoMother();
            foreach ($mongUpdateList as $metode => $tmpData) {
                if ($metode == "update") {
                    if (sizeof($tmpData) > 0) {
                        foreach ($tmpData as $gate => $fildsData) {
                            $mong->setTableName($this->mongoTableList[$gate]);
                            foreach ($fildsData as $mongUpadte) {
                                $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                            }
                        }
                    }
                }

            }
        }
        //endregion


        //region write transaksional mongo
        if (sizeof($mongoList) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongoList as $gateList => $listIDSData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$gateList]);
                $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$gateList]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        //                        cekLime("nulis ke mongo broo:");
                        //                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }
                //                    cekHitam($listedTable[$gateList]);
                //                    cekLime($gateList);

            }

            //                matiHEre();

        }
        //endregion

        //region write Registry mongo current
        if (sizeof($mongRegID) > 0) {
            //            $mongRegID = $mongoList['main'];
            $tr->setTableName("transaksi_registry");
            $tr->setFilters(array());
            $tr->setSortBy(array());
            $tr->addFilter("id in (" . implode(",", $mongRegID) . ")");
            $tmpTrm = $tr->lookUpAll()->result();

            $mong->setTableName("transaksi_registry");
            if (sizeof($tmpTrm) > 0) {
                foreach ($tmpTrm as $tmpMain) {
                    $transksi_main = json_decode(json_encode($tmpMain), true);
                    //                    arrPrint($transksi_main);
                    $mong->addData($transksi_main);
                }
            }

        }
        //endregion

        //region mongo Connected
        if (sizeof($mongoListConnect) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongoListConnect as $connGate => $connData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$connGate]);
                $tr->addFilter("id in (" . implode(",", $connData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$connGate]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        $mong->addData($transksi_main);
                    }
                }
            }
        }
        if (sizeof($mongRegIDConnect) > 0) {
            //            $mongRegID = $mongRegIDConnect['main'];
            $tr->setTableName("transaksi_registry");
            $tr->setFilters(array());
            $tr->setSortBy(array());
            $tr->addFilter("id in (" . implode(",", $mongRegIDConnect) . ")");
            $tmpTrm = $tr->lookUpAll()->result();
            $mong->setTableName("transaksi_registry");
            if (sizeof($tmpTrm) > 0) {
                foreach ($tmpTrm as $tmpMain) {
                    $transksi_main = json_decode(json_encode($tmpMain), true);
                    $mong->addData($transksi_main);
                }
            }

        }


        //endregion

        //region pre purcash
        if (sizeof($mongPrePurcash) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongPrePurcash as $gateList => $listIDSData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$gateList]);
                $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();

                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$gateList]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        $mong->addData($transksi_main);
                    }
                }
            }
            //            matiHere("pre purcash");
        }
        if (sizeof($mongPrePurcashReg) > 0) {
            //            $mongRegID = $mongPrePurcashReg['main'];
            $tr->setTableName("transaksi_registry");
            $tr->setFilters(array());
            $tr->setSortBy(array());
            $tr->addFilter("id in (" . implode(",", $mongPrePurcashReg) . ")");
            $tmpTrm = $tr->lookUpAll()->result();
            $mong->setTableName("transaksi_registry");
            if (sizeof($tmpTrm) > 0) {
                foreach ($tmpTrm as $tmpMain) {
                    $transksi_main = json_decode(json_encode($tmpMain), true);
                    $mong->addData($transksi_main);
                }
            }
        }

        //endregion

        //endregion


        if (isset($_SESSION[$cCode])) {
            unset($_SESSION[$cCode]);
        }

        if (isset($_SESSION["_TR_" . $origJenis])) {
            unset($_SESSION["_TR_" . $origJenis]);
        }

        if (isset($oldCode)) {
            if (isset($_SESSION[$oldCode])) {
                unset($_SESSION[$oldCode]);
            }
        }

        //region feedback msg
        $this->session->errMsg = "transaction entry has been saved<br>";
        $nextNum = $nextProp["num"];
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;

        }
        else {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;

        }
        $trBackClick = "location.href='$trBackLink'";
        //        $this->session->errMsg .= "<br><a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
        //endregion

        if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum])) {
            $printLocation = $this->config->item('heTransaksi_layout')[$this->jenisTr]['printLocation'];
            $printException = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['printException'][$stepNum]) ? "/" . $this->config->item('heTransaksi_layout')[$this->jenisTr]['printException'][$stepNum] : "";
            $printSettings = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum] : array();
            if (isset($printSettings['size'])) {
                switch ($printSettings['size']) {
                    case "normal":
                        //                        cekkuning("size: NORMAL");
                        echo "<script>";
                        echo "top.popBig('" . base_url() . $printLocation . "$tmpNomorNota2$printException');";
                        echo "top.location.reload();";
                        echo "</script>";
                        break;
                    case "small":
                        //                        cekkuning("size: SMALL");
                        echo "<script>";
                        echo "top.popSmall('" . base_url() . $printLocation . "$tmpNomorNota2$printException');";
                        echo "top.location.reload();";
                        echo "</script>";
                        break;
                    default:
                        //                        cekkuning("size: UNKNOWN");
                        break;
                }
            }
            else {
                $arrAlert = array(
                    "type" => "success",
                    "title" => "Transaction saved",
                    //                        "html" => "your order has been saved and ready to process",
                    "html" => $this->session->errMsg,
                    "timer" => "1500",
                    "showConfirmButton" => false,
                    "allowOutsideClick" => false,
                );
                echo swalAlert($arrAlert);
                echo "<script>topReload(1500)</script>";
                echo topReload();
                echo "</script>";
                unset($this->session->errMsg);
            }

        }
        else {
            $arrAlert = array(
                "type" => "success",
                "title" => "Transaction saved",
                //                        "html" => "your order has been saved and ready to process",
                "html" => $this->session->errMsg,
                "timer" => "1500",
                "showConfirmButton" => false,
                "allowOutsideClick" => false,
            );
            echo swalAlert($arrAlert);
            echo "<script>topReload(1500)</script>";
            echo topReload();
            echo "</script>";
            unset($this->session->errMsg);
        }


    }

    public function tmpSave()
    {
        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        if (isset($_SESSION[$cCode])) {

            if (isset($_SESSION[$cCode]['main']) && sizeof($_SESSION[$cCode]['main']) > 0 && isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {

                $content = array(
                    "main" => $_SESSION[$cCode]['main'],
                    "items" => $_SESSION[$cCode]['items'],
                );

                $tr = new MdlTransaksi();
                $insertID = $tr->writeTmpEntries(array(
                    "jenis" => $this->jenisTr,
                    "cabang_id" => $this->session->login['cabang_id'],
                    "gudang_id" => $this->session->login['gudang_id'],
                    "date_created" => date("Y-m-d H:i:s"),
                    "created_by" => $this->session->login['id'],
                    "content" => base64_encode(serialize($content)),
                    "content_intext" => print_r($content, true),
                ));
                cekkuning($this->db->last_query());
            }

            cekMerah("TRANSAKSI DONE");
            //region writelog
            $this->load->model("Mdls/" . "MdlActivityLog");
            $hTmp = new MdlActivityLog();
            $tmpHData = array(
                "title" => $_SESSION[$cCode]['main']['jenisTrName'],
                "sub_title" => "Saving new transaction",
                "uid" => $this->session->login['id'],
                "uname" => $this->session->login['nama'],
                "dtime" => date("Y-m-d H:i:s"),
                "transaksi_id" => $insertID,
                "deskripsi_old" => "",
                "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
                "jenis" => $this->jenisTr,
                "ipadd" => $_SERVER['REMOTE_ADDR'],
                "devices" => $_SERVER['HTTP_USER_AGENT'],
                "category" => "transaksi",
                "controller" => $this->uri->segment(1),
                "method" => $this->uri->segment(2),
                "url" => current_url(),

            );
            $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Gagal menulis riwayat data", __FILE__));
            //endregion
            //            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
            //            if (isset($_SESSION[$cCode])) {
            //                unset($_SESSION[$cCode]);
            //            }
            //            if (isset($oldCode)) {
            //                if (isset($_SESSION[$oldCode])) {
            //                    unset($_SESSION[$oldCode]);
            //                }
            //            }
            //
            //


        }
        else {
            die("the gate index you want to debug has not been formed yet!");
        }
    }

    public function save()
    {
        echo "<script>top.writeProgress('MEMULAI PROSES SAVING....');</script>";

        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }

        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;


        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $inputLabels = array();
        $inputAuthConfigs = array();

        $this->load->library("FieldCalculator");
        $cal = new FieldCalculator();

        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
        $prevUrl = blobDecode($rawPrevURL);
        $mongoList = array();
        $mongRegID = array();
        if (isset($_SESSION[$cCode])) {

            if (!isset($_SESSION[$cCode]['items'])) {
                die("belum ada item yang dipilih");
            }
            else {
                if (sizeof($_SESSION[$cCode]['items']) < 1) {
                    die("belum ada item yang dipilih");
                }
            }
            echo("now processing your transaction..<br>");


            //region build table rekening
            $buildTablesMaster = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master'] : array();
            $buildTablesDetail = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail'] : array();
            $addMasterTables = array(
                "rugilaba",
                "laba ditahan",
                "rugilaba lain lain",
            );
            foreach ($addMasterTables as $trek) {
                $buildTablesMaster[] = array(
                    "comName" => "RugiLaba",
                    "loop" => array(
                        "$trek" => .0,
                    ),
                );
            }
            if (sizeof($buildTablesMaster) > 0) {
                //                arrprint($buildTablesMaster);
                $bCtr = 0;
                foreach ($buildTablesMaster as $buildTablesMaster_specs) {

                    $bCtr++;
                    $mdlName = $buildTablesMaster_specs['comName'];
                    if (substr($mdlName, 0, 1) == "{") {
                        //                        cekkuning("mengandung kurawal");
                        $mdlName = trim($mdlName, "{");
                        $mdlName = trim($mdlName, "}");
                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                    }
                    else {
                        cekkuning("TIDAK mengandung kurawal");
                    }

                    $mdlName = "Com" . $mdlName;

                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();


                    if (isset($buildTablesMaster_specs['loop']) && sizeof($buildTablesMaster_specs['loop']) > 0) {
                        foreach ($buildTablesMaster_specs['loop'] as $key => $val) {
                            if (substr($key, 0, 1) == "{") {
                                $oldParam = $buildTablesMaster_specs['loop'][$key];
                                cekHere($oldParam);
                                unset($buildTablesMaster_specs['loop'][$key]);
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                $buildTablesMaster_specs['loop'][$key] = $oldParam;
                            }
                        }
                    }


                    if (method_exists($m, "getTableNameMaster")) {
                        if (sizeof($m->getTableNameMaster())) {
                            $m->buildTables($buildTablesMaster_specs);
                        }
                    }
                }
            }
            if (sizeof($buildTablesDetail) > 0) {
                foreach ($buildTablesDetail as $buildTablesDetail_specs) {
                    foreach ($_SESSION[$cCode]['items'] as $itemSpec) {
                        //arrPrint($itemSpec);
                        $mdlName = $buildTablesDetail_specs['comName'];
                        cekLime($mdlName);
                        if (substr($mdlName, 0, 1) == "{") {
                            $mdlName = trim($mdlName, "{");
                            $mdlName = trim($mdlName, "}");
                            $mdlName = str_replace($mdlName, $itemSpec[$mdlName], $mdlName);
                            //                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                        }
                        $mdlName = "Com" . $mdlName;
                        cekbiru("model: $mdlName");
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();

                        if (isset($buildTablesDetail_specs['loop']) && sizeof($buildTablesDetail_specs['loop']) > 0) {
                            foreach ($buildTablesDetail_specs['loop'] as $key => $val) {
                                if (substr($key, 0, 1) == "{") {
                                    $oldParam = $buildTablesDetail_specs['loop'][$key];
                                    unset($buildTablesDetail_specs['loop'][$key]);
                                    $key = trim($key, "{");
                                    $key = trim($key, "}");
                                    $key = str_replace($key, $itemSpec[$key], $key);
                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                    $buildTablesDetail_specs['loop'][$key] = $oldParam;
                                }
                            }
                        }
                        if (method_exists($m, "getTableNameMaster")) {
                            if (sizeof($m->getTableNameMaster())) {
                                $m->buildTables($buildTablesDetail_specs);
                            }
                        }
                    }
                }
            }
            //endregion


            $this->db->trans_start();

            cekMerah("start pre-processor...");
            //
            //region pre-processors (item)
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['preProc']['detail']) ? $_SESSION[$cCode]['revert']['preProc']['detail'] : array();
                cekMerah(":: iterator preprocc dari gerbang revert ::");
                arrPrintWebs($iterator);
            }
            else {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail'] : array();
            }
            //            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail'])) {
            if (sizeof($iterator) > 0) {


                $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();
                echo "ITEM NUM LABELS";

                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        echo "sub-preproc: $comName, initializing values <br>";

                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();

                            //                            $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (!isset($subParams['static']["transaksi_id"])) {
                                    //									$subParams['static']["transaksi_id"] = $masterID;
                                }


                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                            }
                            //                            cekLime(":: cetak preprocc... $comName :: $srcGateName ::");
                            //                            arrPrint($subParams);
                            //mati_disini();
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;


                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                //                                echo "sub preproc #$it: $comName, sending values <br>";

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);


                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();

                                    cekmerah("gotparams dari pre-proc $comName");
                                    arrprint($gotParams);


                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor

                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($_SESSION[$cCode][$gateName])) {
                                                $_SESSION[$cCode][$gateName] = array();
                                                //                                    cekhijau("building the session: $gateName");
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }

                                            foreach ($paramSpec as $id => $gSpec) {
                                                //										$id=$gSpec['id'];


                                                if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                    $_SESSION[$cCode][$gateName][$id] = array();
                                                }


                                                if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val");
                                                            $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                cekHitam("srcGateName = $srcGateName :: " . __LINE__);
                                                if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }

                                                //cekMerah("REBUILDING VALUES..");
                                                if (sizeof($itemNumLabels) > 0) {
                                                    //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        //cekHere("$id === $key => $label");
                                                        if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                            $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                        }
                                                    }
                                                }
                                            }
                                            //                                    arrPrint($items);die();
                                        }


                                    }

                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }


                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }


                $this->load->helper("he_value_builder");
                fillValues($this->jenisTr, 1, 1);


                //region injector gerbang value untuk pembatalan ppv dan selisih
                if (isset($_SESSION[$cCode]["revert"]["preProc"]["replacer"])) {
                    $replace = $_SESSION[$cCode]["revert"]["preProc"]["replacer"];
                    $jenisTrReference = $_SESSION[$cCode]["main"]["jenisTr_reference"];
                    switch ($jenisTrReference) {
                        case "460":
                            $tempCalculate = array(
                                //                                "selisih" => ($_SESSION[$cCode]["main"]["hpp_riil"] + $_SESSION[$cCode]["main"]["exchange__nilai_tambah_ppn_in"]) - ($_SESSION[$cCode]["main"]["exchange__nilai_tambah_piutang_pembelian"]),
                                //                                "exchange__harga" => $_SESSION[$cCode]["main"]["hpp_riil"],//riil
                                //                                "exchange__hpp_nppv" => $_SESSION[$cCode]["main"]["hpp_nppv"],//riil+ppv
                                //                                "exchange__ppv" => $_SESSION[$cCode]["main"]["ppv_riil"],//riil+ppv
                            );
                            break;
                        default:
                            $tempCalculate = array(
                                "selisih" => ($_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"]) - ($_SESSION[$cCode]["main"]["nett"] + $_SESSION[$cCode]["main"]["ppv"]),
                                "hpp_nppv" => $_SESSION[$cCode]["main"]["hpp"],
                                "hpp_nppn" => $_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"],
                            );
                            break;
                    }
                    //                    $tempCalculate = array(
                    //                        "selisih" => ($_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"]) - ($_SESSION[$cCode]["main"]["nett"] + $_SESSION[$cCode]["main"]["ppv"]),
                    //                        "hpp_nppv" => $_SESSION[$cCode]["main"]["hpp"],
                    //                        "hpp_nppn" => $_SESSION[$cCode]["main"]["hpp"] + $_SESSION[$cCode]["main"]["ppn"],
                    //                    );

                    //arrPrintWebs($tempCalculate);
                    foreach ($replace['recalculate'] as $iKey => $gate) {
                        $_SESSION[$cCode]["main"][$gate] = $tempCalculate[$gate];
                    }

                    cekLime($_SESSION[$cCode]["main"]["hpp"] . "+" . $_SESSION[$cCode]["main"]["ppn"] . "-" . $_SESSION[$cCode]["main"]["nett"]);

                }

                //endregion


            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion
            //mati_disini("==== ==== ====");

            //region pre-processors (master)
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['preProc']['master']) ? $_SESSION[$cCode]['revert']['preProc']['master'] : array();
            }
            else {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['master'] : array();
            }

            if (sizeof($iterator) > 0) {

                $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();


                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {

                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $switchResultParams = isset($tComSpec['switchResultParams']) ? $tComSpec['switchResultParams'] : false;

                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                $subParams['static'][$key] = $realValue;

                                //                                cekPink2("$comName == $value || $realValue");
                                //                                cekPink2("valas_harga " . $_SESSION[$cCode]['main']['valas_harga']);
                                //                                cekPink2("uang_muka_valas_harga " . $_SESSION[$cCode]['main']['uang_muka_valas_harga']);
                            }

                            if (!isset($subParams['static']["transaksi_id"])) {
                                //									$subParams['static']["transaksi_id"] = $masterID;
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);


                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            cekbiru("gotparams dari pre-proc $comName");
                            arrprint($gotParams);

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    //										$id=$gSpec['id'];

                                    if ($switchResultParams == true) {

                                        foreach ($gSpec as $id => $ggSpec) {
                                            if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                $_SESSION[$cCode][$gateName][$id] = array();
                                            }

                                            if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                if (is_array($ggSpec) && sizeof($ggSpec) > 0) {
                                                    foreach ($ggSpec as $key => $val) {
                                                        $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                    }
                                                }
                                            }

                                            //cekMerah("REBUILDING VALUES..");
                                            if (sizeof($itemNumLabels) > 0) {
                                                //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                foreach ($itemNumLabels as $key => $label) {
                                                    //cekHere("$id === $key => $label");
                                                    if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                        $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                    }
                                                }
                                            }

                                        }
                                    }
                                    else {
                                        if (isset($_SESSION[$cCode]['main'])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode]['main'][$key] = $val;
                                                }
                                            }
                                        }
                                        //==inject gotParams to child gate
                                        if (isset($_SESSION[$cCode]['main'])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode]['main'][$key] = $val;
                                                }
                                            }
                                        }
                                        //cekMerah("REBUILDING VALUES..");
                                        if (sizeof($itemNumLabels) > 0) {
                                            //cekHijau("REBUILDING SUBS FOR ITEMS");
                                            foreach ($itemNumLabels as $key => $label) {
                                                cekHere("$id === $key => $label");
                                                if (isset($_SESSION[$cCode]['main'][$key])) {
                                                    $_SESSION[$cCode]['main']['sub_' . $key] = ($_SESSION[$cCode]['main']['jml'] * $_SESSION[$cCode]['main'][$key]);
                                                }
                                            }
                                        }
                                    }

                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }

                        cekPink2("fillvalue setelah $comName");
                        $this->load->helper("he_value_builder");
                        fillValues($this->jenisTr, 1, 1);


                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }

                $this->load->helper("he_value_builder");
                fillValues($this->jenisTr, 1, 1);
            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //arrPrintWebs($_SESSION[$cCode]['main']);
            //mati_disini("==== selesai preproc ====");

            $this->midValidate();

            $this->unionValidate();
            //mati_disini(__LINE__ . "==== ==== ====");
            //===finalisasi sebelum masuk tabel beneran
            //===isinya ada pembentukan nomor nota dll

            //
            //region penomoran receipt
            //<editor-fold desc="==========penomoran">
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");

            $counterForNumber = array($this->config->item('heTransaksi_core')[$this->jenisTr]['formatNota']);
            arrPrintWebs($counterForNumber);
            if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$this->jenisTr]['counters'])) {
                die(__LINE__ . " Used number should be registered in 'counters' config as well");
            }
            echo "<div style='background:#ff7766;'>";
            foreach ($counterForNumber as $i => $cRawParams) {
                $cParams = explode("|", $cRawParams);
                $cValues = array();
                foreach ($cParams as $param) {
                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                }
                $cRawValues = implode("|", $cValues[$i]);
                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

            }
            echo "</div style='background:#ff7766;'>";
            //arrPrintWebs($paramSpec);
            //mati_disini("hahaha");


            $stepNumber = 1;

            $tmpNomorNota = $paramSpec['paramString'];
            $tmpNomorNotaAlias = formatNota("nomer_nolink", $tmpNomorNota);

            if (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2])) {
                $nextProp = array(
                    "num" => 2,
                    "code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['target'],
                    "label" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['label'],
                    "groupID" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['userGroup'],
                );
            }
            else {
                $nextProp = array(
                    "num" => 0,
                    "code" => "",
                    "label" => "",
                    "groupID" => "",
                );
            }

            //</editor-fold>
            //endregion
            //
            //region dynamic counters
            // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $this->config->item('heTransaksi_core')[$this->jenisTr]['counters'];
            $configCustomParams[] = "stepCode";
            //arrPrint($configCustomParams);
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                    switch ($paramSpec['id']) {
                        case 0: //===counter type is new
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                            break;
                    }
                    //echo "<hr>";
                }
            }
            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);
            //mati_disini();

            //
            //region addition on master


            $addValues = array(
                'counters' => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'nomer2' => $tmpNomorNotaAlias,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => sizeof($this->config->item('heTransaksi_ui')[$this->jenisTr]['steps']),
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp['num'],
                "next_step_code" => $nextProp['code'],
                "next_step_label" => $nextProp['label'],
                "next_group_code" => $nextProp['groupID'],
                "tail_number" => 1,
                "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['target'],


            );
            foreach ($addValues as $key => $val) {
                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
            }
            //endregion

            //
            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']),
                "next_substep_num" => $nextProp['num'],
                "next_substep_code" => $nextProp['code'],
                "next_substep_label" => $nextProp['label'],
                "next_subgroup_code" => $nextProp['groupID'],
                "sub_tail_number" => 1,
                "sub_tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['target'],


            );
            foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
                }
            }
            //endregion
            // </editor-fold>
            //endregion

            //
            //region ----------write transaksi, transaksi_data, main_fields, main_values, main_applets, etc
            if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

                $_SESSION[$cCode]['tableIn_master']['status_4'] = 11;
                $_SESSION[$cCode]['tableIn_master']['trash_4'] = 0;


                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                cekHitam($this->db->last_query());
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }
                $mongoList['main'] = array($insertID, $epID);
                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => $tmpNomorNotaAlias,
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($_SESSION[$cCode][$target])) {
                            foreach ($_SESSION[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec['id']) && $iSpec['id'] > 0 ? $iSpec['id'] : $xid;
                                if (isset($_SESSION[$cCode][$target][$id])) {
                                    $_SESSION[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
                    "step_name" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['label'],
                    "group_code" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['userGroup'],
                    "oleh_id" => $this->session->login['id'],
                    "oleh_nama" => $this->session->login['nama'],
                    "keterangan" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'],
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");
                $mongoList['sign'][] = $dwsign;
                $idHis = array(
                    $stepNumber => array(
                        "olehID" => $_SESSION[$cCode]['main']['olehID'],
                        "olehName" => $_SESSION[$cCode]['main']['olehName'],
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "nomer2" => $tmpNomorNotaAlias,
                        "counters" => $appliedCounters,
                        "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp['num'],
                    "next_step_code" => $nextProp['code'],
                    "next_step_label" => $nextProp['label'],
                    "next_group_code" => $nextProp['groupID'],

                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");
                cekHijau($this->db->last_query());

                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,
                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

            }
            if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                $inserMainValues = array();
                if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['mainValues'])) {
                    //matiHEre("hooppp");
                    $inserMainValues = array();
                    foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['mainValues'] as $key => $src) {
                        if (isset($_SESSION[$cCode]['tableIn_master_values'][$key])) {
                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $_SESSION[$cCode]['tableIn_master_values'][$key],
                            ));

                            $inserMainValues[] = $dd;
                            $mongoList['mainValues'][] = $dd;
                        }
                    }
                }

                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }

            }
            if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                $inserMainValues = array();
                foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $inserMainValues[] = $dd;
                    $mongoList['mainValues'][] = $dd;
                }

                if (sizeof($inserMainValues) > 0) {
                    $arrBlob = blobEncode($inserMainValues);
                    $this->db->query("UPDATE transaksi SET indexing_main_values = '$arrBlob' WHERE id=$insertID");
                }
            }
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    //                    cekkuning("making a clone for input key $key / $val");
                    //                    $tmpTableIn=$_SESSION[$cCode]['tableIn_master'];
                    //                    $replacers=array(
                    //                        "nomer"=>$_SESSION[$cCode]['tableIn_master']['nomer']."_$key",
                    //                    );
                    //                    foreach($replacers as $key=>$val){
                    //                        $tmpTableIn[$key]=$val;
                    //                    }
                    //                    $subInputInsertID = $tr->writeMainEntries($tmpTableIn);
                }
            }
            if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($_SESSION[$cCode]['main_applets']) && sizeof($_SESSION[$cCode]['main_applets']) > 0) {
                foreach ($_SESSION[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec['label'],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));


                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec['value'];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        //					cekhijau("$eName terdaftar pada relInputs");


                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec['label'];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']['groupID'])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']['groupID'];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }

                    }

                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {

                $insertIDs = array();
                $insertDeIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    if ($insertDetailID < 1) {
                        die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                    else {
                        $insertIDs[] = $insertDetailID;
                        $insertDeIDs[$insertID][] = $insertDetailID;
                        $mongoList['detail'][] = $insertDetailID;
                    }
                    if ($epID != 999) {
                        $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                        if ($insertEpID < 1) {
                            die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                        }
                        else {
                            $insertIDs[] = $insertEpID;
                            $insertDeIDs[$epID][] = $insertEpID;
                            $mongoList['detail'][] = $insertEpID;
                        }
                    }
                    cekUngu($this->db->last_query());
                }


                if (sizeof($insertIDs) == 0) {
                    die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                }
                else {
                    $indexing_details = array();
                    foreach ($insertDeIDs as $key => $numb) {
                        $indexing_details[$key] = $numb;
                    }

                    foreach ($indexing_details as $k => $arrID) {
                        $arrBlob = blobEncode($arrID);
                        $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                        cekOrange($this->db->last_query());
                    }
                }
            }
            else {
                die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detail'] = $insertIDs;
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $insertDetailID;
                    $mongoList['detail'][] = $insertDetailID;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detil'][] = $dd;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detil'] = $insertIDs;
                    }
                    cekUngu($this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {

                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                            if (isset($_SESSION[$cCode]['tableIn_detail'][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : "0",
                                ));
                                $insertIDs[$pID][] = $dd;
                                $mongoList['detailValues'][] = $dd;

                            }
                        }
                    }
                }

                if (sizeof($insertIDs) > 0) {
                    $arrBlob = blobEncode($insertIDs);
                    $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                }

            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }
                }
            }
            //endregion


            //===components akan langsung dieksekusi jika steps-nya tidak pakai approval
            $steps = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'];

            //region processing sub-components, if in single step geser ke CLI

            $componentGate['detail'] = array();
            $componentConfig['detail'] = array();
            //            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $filterNeeded = false;
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['jurnal']['detail']) ? $_SESSION[$cCode]['revert']['jurnal']['detail'] : array();
                $revertedTarget = $_SESSION[$cCode]['main']['pihakExternID'];
            }
            else {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail'] : array();
                $revertedTarget = "";
            }
            $componentConfig['detail'] = $iterator;
            //            //region processing sub-components
            //            if (sizeof($iterator) > 0) {
            //                foreach ($iterator as $cCtr => $tComSpec) {
            //                    $tmpOutParams[$cCtr] = array();
            //                    $gg = 0;
            //                    $srcGateName = $tComSpec['srcGateName'];
            //                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
            //                        $srcRawGateName = $tComSpec['srcRawGateName'];
            //                        $comName = $tComSpec['comName'];
            //                        if (substr($comName, 0, 1) == "{") {
            //                            $comName = trim($comName, "{");
            //                            $comName = trim($comName, "}");
            //                            //                            $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
            //                            cekLime($cCode . " || " . $srcGateName . " || " . $id . " || " . $comName);
            //                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
            //                        }
            //                        cekHitam(":: $comName ::");
            //                        $mdlName = "Com" . ucfirst($comName);
            //                        if (in_array($mdlName, $compValidators)) {//perlu validasi filter
            ////cekLime($mdlName. "line");
            //                            $filterNeeded = true;
            //                        }
            //                        else {
            //                            cekLime($mdlName . "like");
            //                            $filterNeeded = false;
            //                        }
            //                        echo "sub-component: $comName, initializing values <br>";
            //                        //                        cekHitam(__LINE__);
            //                        //                        $tmpOutParams[$cCtr] = array();
            //
            //                        //                        cekhitam("$comName filterneeded: $filterNeeded");
            //                        //                        cekhitam("mau mengiterasi $srcGateName");
            //                        //                        cekhitam("telah mengiterasi $srcGateName");
            //                        //
            //                        $subParams = array();
            ////arrPrint($tComSpec);
            //                        if (isset($tComSpec['loop'])) {
            //                            foreach ($tComSpec['loop'] as $key => $value) {
            //                                cekMerah(":: $key => $value ::");
            //                                if (substr($key, 0, 1) == "{") {
            //                                    $key = trim($key, "{");
            //                                    $key = trim($key, "}");
            //                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
            //                                    $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$id][$key], $key);
            //                                }
            //
            //                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
            //                                $subParams['loop'][$key] = $realValue;
            //
            //                                if ($filterNeeded) {
            //                                    if ($subParams['loop'][$key] == 0) {
            //                                        unset($subParams['loop'][$key]);
            //                                    }
            //                                }
            //                            }
            //                        }
            //                        if (isset($tComSpec['static'])) {
            //                            foreach ($tComSpec['static'] as $key => $value) {
            //
            //                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
            //                                $subParams['static'][$key] = $realValue;
            //
            //                            }
            //                            if (!isset($subParams['static']["transaksi_id"])) {
            //                                $subParams['static']["transaksi_id"] = $insertID;
            //                            }
            //                            if (!isset($subParams['static']["transaksi_no"])) {
            //                                $subParams['static']["transaksi_no"] = $insertNum;
            //                            }
            //
            //                            $subParams['static']["fulldate"] = date("Y-m-d");
            //                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
            //                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
            //                            if (strlen($revertedTarget) > 1) {
            //                                $subParams['static']['reverted_target'] = $revertedTarget;
            //                            }
            //                        }
            //                        //arrPrint($subParams);
            //                        if (sizeof($subParams) > 0) {
            ////                            arrprint($subParams);
            //                            cekhitam("subparam ada isinya");
            //                            if ($filterNeeded) {
            //                                if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
            //                                    $tmpOutParams[$cCtr][] = $subParams;
            //                                }
            //                            }
            //                            else {
            //                                $tmpOutParams[$cCtr][] = $subParams;
            ////                                CekHijiau("asem" .$gg++);
            //                            }
            //                        }
            //                        else {
            //                            cekhitam("subparam TIDAK ada isinya");
            //                        }
            //                    }
            //
            //                    $componentGate['detail'][$cCtr] = $subParams;
            //                }
            //                //cekHitam("cetak tmpOutParams");
            //
            //                foreach ($iterator as $cCtr => $tComSpec) {
            //                    $srcGateName = $tComSpec['srcGateName'];
            //                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
            //
            //                        $srcRawGateName = $tComSpec['srcRawGateName'];
            //                        $comName = $tComSpec['comName'];
            //                        if (substr($comName, 0, 1) == "{") {
            //                            $comName = trim($comName, "{");
            //                            $comName = trim($comName, "}");
            //                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
            //                            //                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
            //                        }
            //                    }
            //                    echo "sub component: $comName, sending values <br>";
            //
            //                    $mdlName = "Com" . ucfirst($comName);
            //                    $this->load->model("Coms/" . $mdlName);
            //                    $m = new $mdlName();
            //                    //===filter value nol, jika harus difilter
            ////                    arrPrint($tmpOutParams[$cCtr]);
            //                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
            //                        $tobeExecuted = true;
            //                    }
            //                    else {
            //                        $tobeExecuted = false;
            //                    }
            //
            //                    if ($tobeExecuted) {
            //                        cekMerah("$comName dieksekusiii");
            //                        arrPrint($tmpOutParams[$cCtr]);
            //                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
            //                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
            //                        cekBiru($this->db->last_query());
            //                    }
            //                    else {
            //                        cekMerah("$comName tidak eksekusi");
            //                    }
            //
            //                }
            //            }
            //            else {
            //                //cekKuning("subcomponents is not set");
            //            }
            //            //endregion

            //endregion

            //region processing main components, if in single step

            $componentGate['master'] = array();
            $componentConfig['master'] = array();
            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['jurnal']['master']) ? $_SESSION[$cCode]['revert']['jurnal']['master'] : array();
            }
            else {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master'] : array();
            }

            if (sizeof($iterator) > 0) {
                $componentConfig['master'] = $iterator;
                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "component # $cCtr: $comName<br>";

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                            }

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                            //                            cekKuning("LOOP $key diisi dengan $realValue");
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }
                        $tmpOutParams['static']["urut"] = $cCtr;
                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }


                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;

                    if (in_array($mdlName, $compValidators)) {

                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }

                    }

                    if ($tobeExecuted) {

                        //cekBiru("kiriman komponem $comName");
                        //                        arrPrint($tmpOutParams);
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }

                    $componentGate['master'][$cCtr] = $tmpOutParams;
                }
            }
            else {
                //cekKuning("components is not set");
            }


            //endregion


            cekHitam(":: START POST PROCC DETAIL... ::");
            //region processing sub-post-processors, always
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['postProc']['detail']) ? $_SESSION[$cCode]['revert']['postProc']['detail'] : array();
                cekHitam("post procc pakai revert");
            }
            else {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['detail'] : array();
                cekHitam("post procc pakai config core");
            }
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "[$cCtr] sub-postProcessor: $comName, gate: $srcGateName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();
                    if (isset($_SESSION[$cCode][$srcGateName]) && (sizeof($_SESSION[$cCode][$srcGateName]) > 0)) {
                        arrPrint($_SESSION[$cCode][$srcGateName]);
                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            //                            $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();
                            if (isset($tComSpec['loop'])) {
                                foreach ($tComSpec['loop'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['loop'][$key] = $realValue;

                                }
                            }
                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {
                                    cekHitam("gate: $srcGateName, dengan key $id");
                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }
                                if (!isset($subParams['static']["transaksi_id"])) {
                                    $subParams['static']["transaksi_id"] = $insertID;
                                }
                                if (!isset($subParams['static']["transaksi_no"])) {
                                    $subParams['static']["transaksi_no"] = $insertNum;
                                }
                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                if (isset($_SESSION[$cCode]['revert']['postProc']['detail'])) {
                                    $subParams['static']["reverted_target"] = $_SESSION[$cCode]['main']['pihakExternID'];
                                }

                                $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                            }

                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                    }
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    if (isset($_SESSION[$cCode][$srcGateName])) {
                        echo "[$cCtr] sub-postProcessor: $comName, sending values <br>";

                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        //arrPrint($tmpOutParams[$cCtr]);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekPink($this->db->last_query());
                    }

                }
            }
            //endregion
            //mati_disini();

            //region relesaese connected payment source dan marking trash transaksi
            //            arrPrint($_SESSION[$cCode]["revert"]);
            if (isset($_SESSION[$cCode]["revert"]["connectedPaymentsource"]) && $_SESSION[$cCode]["revert"]["connectedPaymentsource"] == true) {
                $keyRel = $_SESSION[$cCode]["main"]["referenceID"];
                $keyRelRef = $_SESSION[$cCode]["main"]["pihakExternID"];
                $relPaymentSrc = isset($this->config->item("payment_source")[$keyRelRef]) ? $this->config->item("payment_source")[$keyRelRef] : array();
                if (sizeof($relPaymentSrc) > 0) {
                    $this->load->model("Mdls/MdlPaymentSource");
                    $m = new MdlPaymentSource();
                    $m->addFilter("transaksi_id='$keyRel'");
                    $tmpRelPay = $m->lookupAll()->result();
                    $paymentRelUsed = array(
                        "cabang_id" => "placeID",
                        "extern_id" => "id",
                        "extern_nama" => "name",
                        "label" => ".hutang biaya",
                        "target_jenis" => "jenisTr",
                        "transaksi_id" => "refID",
                        "terbayar" => "nilai_bayar",
                        "sisa" => "new_sisa",
                        "ppn" => "valid_ppn",
                        "extern_nilai2" => "valid_dpp",
                    );
                    if (sizeof($tmpRelPay) > 0) {
                        $tmpOutParams = array();
                        $iterator = array();
                        foreach ($tmpRelPay as $indexKey => $relData) {
                            $tmp = array();
                            foreach ($paymentRelUsed as $key => $keyGate) {
                                if ($key == "terbayar") {
                                    $val = $relData->sisa;
                                }
                                else {
                                    if ($key == "sisa") {
                                        $val = "-" . $relData->sisa;
                                    }
                                    else {
                                        $val = $relData->$key;
                                    }
                                }
                                $tmp["static"][$key] = $val;
                                $tmp["static"]["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];

                            }
                            $iterator[$indexKey]["loop"] = array();
                            $iterator[$indexKey]["comName"] = "PaymentSrcItem";
                            if (sizeof($tmp) > 0) {
                                $tmpOutParams[$indexKey][] = $tmp;
                            }
                        }
                        foreach ($iterator as $cCtr => $tComSpec) {
                            $comName = $tComSpec['comName'];
                            //                            $srcGateName = $tComSpec['srcGateName'];
                            //                            $srcRawGateName = $tComSpec['srcRawGateName'];
                            echo "sub-postProcessor: $comName, sending values <br>";

                            $mdlName = "Com" . ucfirst($comName);
                            $this->load->model("Coms/" . $mdlName);
                            $m = new $mdlName();
                            $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            //                            cekHitam($this->db->last_query());
                        }
                    }
                    //                    foreach()
                    cekLime("yuk direset paymentsource**");
                }


            }
            //endregion


            //region processing main-post-processors, always
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {
                $iterator = isset($_SESSION[$cCode]['revert']['postProc']['detail']) ? $_SESSION[$cCode]['revert']['postProc']['master'] : array();
            }
            else {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master'] : array();
            }
            //            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "post-processor: $comName<br>LINE: " . __LINE__;

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;

                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }
                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    cekBiru("kiriman komponem $comName");
                    arrPrint($tmpOutParams);
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    //cekHitam($this->db->last_query());

                }
            }
            else {

            }
            //endregion

            //cekHijau(":: HALLOOO ::");

            //region updater main transaksi rejection jurnal next step exist
            $mongUpdateList = array();
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets']) && $this->config->item('heTransaksi_core')[$this->jenisTr]['relativeComponets'] == true) {

                $tr->setFilters(array());
                $tr->addFilter("id='" . $_SESSION[$cCode]["main"]["referenceID"] . "'");
                $tempData = $tr->lookupAll()->result();
                $refMasterID = $tempData[0]->id_master;
                $refMasterJenis = $tempData[0]->jenis_master;
                $nextStepCode = $tempData[0]->next_step_code;
                $mainStepCode = $tempData[0]->jenis;
                $stepnum = $tempData[0]->step_number;
                $stepnumAvail = $tempData[0]->step_avail;
                if (($stepnumAvail - $stepnum) > 0) {
                    //                    matiHere("masukk".$nextStepCode);
                    $this->load->model("Coms/ComTransaksi_jurnal_revert");
                    $r = new ComTransaksi_jurnal_revert();
                    $outParams = array(
                        "refID" => $refMasterID,
                        "main_code" => $mainStepCode,
                        "next_code" => $nextStepCode,
                        "step_num" => $stepnum,
                    );
                    $r->pair($outParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $r->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);

                    //marking main transaksi trash4
                    $udpate = array(
                        "trash_4" => "1",
                    );
                    $tr->setFilters(array());
                    //                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array(
                        //                "id" => $no,
                        "id" => $_SESSION[$cCode]["main"]["referenceID"],
                    ), $udpate) or die("Failed to update tr next-state!");
                    $mongUpdateList['update']['main'][] = array(
                        "where" => array("id" => $_SESSION[$cCode]["main"]["referenceID"]),
                        "value" => array(
                            "trash_4" => "1",
                        ),
                    );
                    cekHijau("UPDATE transaksi step sebelumnya...");
                    cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                    //update validqty 0 supaya gak bisa difollowup
                    //                    $arrData_detail["valid_qty"] = 0;
                    $td = new MdlTransaksi();
                    $td->setFilters(array());
                    $rslt = $td->lookupJoinedByID($_SESSION[$cCode]["main"]["referenceID"])->result();
                    if (sizeof($rslt) > 0) {
                        foreach ($rslt as $rsltSpec) {
                            if (array_key_exists($rsltSpec->produk_id, $_SESSION[$cCode]["items"])) {
                                //                                $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");
                                //
                                //                                if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty;
                                //                                    //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                //                                }
                                //                                else {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                }
                                $arrData_detail["valid_qty"] = 0;
                                $tr = new MdlTransaksi();
                                $tr->setFilters(array());
                                $tr->setTableName($tr->getTableNames()['detail']);
                                $dupState = $tr->updateData(array(
                                    "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                    "produk_id" => $rsltSpec->produk_id,
                                ), $arrData_detail) or die("Failed to update tr next-state!");
                                $mongUpdateList['update']['detail'][] = array(
                                    "where" => array(
                                        "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                        "produk_id" => $rsltSpec->produk_id,
                                    ),
                                    "value" => $arrData_detail,
                                );
                                cekKuning("UPDATE transaksi data...");
                                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                            }
                        }
                    }

                    $dwsign = $tr->writeSignature($refMasterID, array(
                        "prev_id" => "",
                        "nomer" => "pembatalan jurnal",
                        "step_number" => "-" . $stepnum, // ini minus step number
                        "step_code" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['target'],
                        "step_name" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['label'],
                        "group_code" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['userGroup'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "keterangan" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['label'] . " oleh " . $this->session->login['nama'],
                        //            "transaksi_id" => $no,
                    )) or die("Failed to write signature");
                    $mongoList['sign'][] = $dwsign;
                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    //                    matiHere();
                }
                else {

                    //marking main transaksi trash4
                    $udpate = array(
                        "trash_4" => "1",
                    );
                    $tr->setFilters(array());
                    //                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array(
                        //                "id" => $no,
                        "id" => $_SESSION[$cCode]["main"]["referenceID"],
                    ), $udpate) or die("Failed to update tr next-state!");
                    cekHijau("UPDATE transaksi step sebelumnya...");
                    cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    $mongUpdateList['update']['main'][] = array(
                        "where" => array("id" => $_SESSION[$cCode]["main"]["referenceID"]),
                        "value" => array(
                            "trash_4" => "1",
                        ),
                    );

                    //update validqty 0 supaya gak bisa difollowup
                    $arrData_detail["valid_qty"] = $new_valid_qty;
                    $td = new MdlTransaksi();
                    $td->setFilters(array());
                    $rslt = $td->lookupJoinedByID($_SESSION[$cCode]["main"]["referenceID"])->result();
                    if (sizeof($rslt) > 0) {
                        foreach ($rslt as $rsltSpec) {
                            if (array_key_exists($rsltSpec->produk_id, $_SESSION[$cCode]["items"])) {
                                //                                $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                //                            cekHitam(":: $prevID :: $rsltSpec->valid_qty :: " . $items[$rsltSpec->produk_id]['qty'] . " :: $new_valid_qty ::");
                                //
                                //                                if ($new_valid_qty > $rsltSpec->produk_ord_jml) {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty;
                                //                                    //                                mati_disini("undo/reject/delete gagal karena valid_qty melebihi produk_ord_jml");
                                //                                }
                                //                                else {
                                //                                    $new_valid_qty = $rsltSpec->valid_qty + $items[$rsltSpec->produk_id]['qty'];
                                //                                }
                                $arrData_detail["valid_qty"] = 0;
                                $tr = new MdlTransaksi();
                                $tr->setFilters(array());
                                $tr->setTableName($tr->getTableNames()['detail']);
                                $dupState = $tr->updateData(array(
                                    "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                    "produk_id" => $rsltSpec->produk_id,
                                ), $arrData_detail) or die("Failed to update tr next-state!");
                                cekKuning("UPDATE transaksi data...");
                                cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                                $mongUpdateList['update']['detail'][] = array(
                                    "where" => array(
                                        "transaksi_id" => $_SESSION[$cCode]["main"]["referenceID"],
                                        "produk_id" => $rsltSpec->produk_id,
                                    ),
                                    "value" => $arrData_detail,
                                );
                            }
                        }
                    }

                    $dwsign = $tr->writeSignature($refMasterID, array(
                        "prev_id" => "",
                        "nomer" => "pembatalan jurnal",
                        "step_number" => "-" . $stepnum, // ini minus step number
                        "step_code" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['target'],
                        "step_name" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['label'],
                        "group_code" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['userGroup'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "keterangan" => $this->config->item("heTransaksi_ui")[$refMasterJenis]['steps'][abs($stepnum)]['label'] . " oleh " . $this->session->login['nama'],
                        //            "transaksi_id" => $no,
                    )) or die("Failed to write signature");
                    $mongoList['sign'][] = $dwsign;
                    cekKuning($this->db->last_query() . " [" . $this->db->affected_rows() . "]");

                    //                    matiHEre("uhuu");
                }
            }

            //endregion

            // region berlaku pembatalan transaksi bila ada config revertStep di model MdlRevertJurnal (true)
            if (isset($_SESSION[$cCode]['main']['pihakExternRevertStep']) && ($_SESSION[$cCode]['main']['pihakExternRevertStep'] == true)) {
                $referenceNextProp = (isset($_SESSION[$cCode]['main']['referenceNextProp']) && (sizeof($_SESSION[$cCode]['main']['referenceNextProp']) > 0)) ? $_SESSION[$cCode]['main']['referenceNextProp'] : array();
                if (sizeof($referenceNextProp) > 0) {
                    // update transaksi reference, step sebelumnya menjadi aktif lagi
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $dupState = $tr->updateData(array("id" => $referenceNextProp['trID']), array(
                        "next_step_code" => $referenceNextProp['code'],
                        "next_step_label" => $referenceNextProp['label'],
                        "next_group_code" => $referenceNextProp['groupID'],
                        "next_step_num" => $referenceNextProp['num'],
                        "step_current" => $referenceNextProp['step_num'],

                    )) or die("Failed to update tr next-state!");
                    cekHijau("BATAL :: " . $this->db->last_query() . " -- " . $this->db->affected_rows());
                    $mongUpdateList['update']['main'][] = array(
                        "where" => array("id" => $referenceNextProp['trID']),
                        "value" => array(
                            "next_step_code" => $referenceNextProp['code'],
                            "next_step_label" => $referenceNextProp['label'],
                            "next_group_code" => $referenceNextProp['groupID'],
                            "next_step_num" => $referenceNextProp['num'],
                            "step_current" => $referenceNextProp['step_num'],
                        ),
                    );


                    // update transaksi data reference, step sebelumnya menjadi aktif lagi
                    $tr = new MdlTransaksi();
                    $tr->setFilters(array());
                    $tr->addFilter("trash='0'");
                    $tr->addFilter("transaksi_id='" . $referenceNextProp['trID'] . "'");
                    $tr->setTableName($tr->getTableNames()['detail']);
                    $detailTmp = $tr->lookupAll()->result();
                    $detailData = array();
                    foreach ($detailTmp as $dTmpSpec) {
                        $detailData[$dTmpSpec->produk_id] = array(
                            "valid_qty" => $dTmpSpec->valid_qty,
                        );
                    }
                    cekOrange($referenceNextProp['detailGate']);
                    if (isset($_SESSION[$cCode][$referenceNextProp['detailGate']]) && ($_SESSION[$cCode][$referenceNextProp['detailGate']] != NULL)) {

                        foreach ($_SESSION[$cCode][$referenceNextProp['detailGate']] as $itemsSpec) {
                            //                        arrPrint($itemsSpec);
                            $valid_qty = isset($detailData[$itemsSpec['id']]['valid_qty']) ? $detailData[$itemsSpec['id']]['valid_qty'] : 0;
                            $valid_qty_new = $valid_qty + $itemsSpec['qty'];

                            $tr = new MdlTransaksi();
                            $tr->setFilters(array());
                            $tr->setTableName($tr->getTableNames()['detail']);
                            $ddupState = $tr->updateData(
                                array(
                                    "transaksi_id" => $referenceNextProp['trID'],
                                    "trash" => 0,
                                    "produk_id" => $itemsSpec['id'],
                                ), array(
                                "next_substep_code" => $referenceNextProp['code'],
                                "next_substep_label" => $referenceNextProp['label'],
                                "next_subgroup_code" => $referenceNextProp['groupID'],
                                "next_substep_num" => $referenceNextProp['num'],
                                "sub_step_current" => $referenceNextProp['step_num'],
                                "valid_qty" => $valid_qty_new,

                            )) or die("Failed to update tr next-state!");
                            cekHijau("BATAL :: " . $this->db->last_query() . " -- " . $this->db->affected_rows());
                            $mongUpdateList['update']['detail'][] = array(
                                "where" => array(
                                    "transaksi_id" => $referenceNextProp['trID'],
                                    "trash" => 0,
                                    "produk_id" => $itemsSpec['id'],
                                ),
                                "value" => array(
                                    "next_substep_code" => $referenceNextProp['code'],
                                    "next_substep_label" => $referenceNextProp['label'],
                                    "next_subgroup_code" => $referenceNextProp['groupID'],
                                    "next_substep_num" => $referenceNextProp['num'],
                                    "sub_step_current" => $referenceNextProp['step_num'],
                                    "valid_qty" => $valid_qty_new,
                                ),
                            );

                        }
                    }
                }
            }
            // endregion


            //
            //region nulis paymentSource
            $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_source");
            if (array_key_exists($stepCode, $paymentSources)) {

                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs[1] as $paymentSrcConfig) {
                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        $paymentMethod = isset($paymentSrcConfig['method']) ? $paymentSrcConfig['method'] : "insert";

                        if ($paymentMethod == "update") {
                            $filters = array(
                                "extern_id" => ""
                            );
                            //                            arrPrint($externSrc);
                            $tr->setFilters(array());
                            $tmpData = $tr->lookupPaymentSrcByJenis($paymentSrcConfig['jenisTarget'])->result();
                            if (sizeof($tmpData) > 0) {
                                //sudah ada update aja gak perlu insert
                                $prevID = $tmpData[0]->id;
                                $preValue = $tmpData[0]->sisa;
                                $currValue = isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0;
                                $newValue = $preValue + $currValue;
                                $where = array(
                                    "id" => $prevID,
                                    //                                    "transaksi_id" => $pSpec->transaksi_id,
                                );
                                $data = array(
                                    "tagihan" => $newValue,
                                    "sisa" => $newValue,
                                );
                                $tr->updatePaymentSrc($where, $data);
                                //                                cekHitam($this->db->last_query());
                            }
                            else {
                                //di insert baru
                                $tr->writePaymentSrc($insertID, array(
                                    "jenis" => $stepCode,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                    "terbayar" => 0,
                                    "sisa" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                    "valas_id" => (isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']])) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                    "valas_nama" => (isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']])) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                    "valas_nilai" => (isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']])) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : 0,
                                    "tagihan_valas" => (isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : 0,
                                    "terbayar_valas" => (isset($externSrc['valasTerbayar']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : 0,
                                    "sisa_valas" => (isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']])) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : 0,
                                    "extern_label2" => (isset($externSrc['extern_label2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_label2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_label2']] : "",
                                    "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : 0,
                                ));
                            }


                        }
                        else {
                            $arrDataPym = array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                "terbayar" => 0,
                                "sisa" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                                "valas_id" => (isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']])) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                "valas_nama" => (isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']])) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                "valas_nilai" => (isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']])) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : 0,
                                "tagihan_valas" => (isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : 0,
                                "terbayar_valas" => (isset($externSrc['valasTerbayar']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : 0,
                                "sisa_valas" => (isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']])) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : 0,
                                "extern_label2" => (isset($externSrc['extern_label2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_label2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_label2']] : "",
                                "extern_nilai2" => (isset($externSrc['extern_nilai2']) && ($_SESSION[$cCode]['main'][$externSrc['extern_nilai2']])) ? $_SESSION[$cCode]['main'][$externSrc['extern_nilai2']] : 0,
                                "payment_locked" => (isset($externSrc['payment_locked']) && ($_SESSION[$cCode]['main'][$externSrc['payment_locked']])) ? $_SESSION[$cCode]['main'][$externSrc['payment_locked']] : 0,
                                "cash_account" => (isset($externSrc['cash_account']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account']] : 0,
                                "cash_account_nama" => (isset($externSrc['cash_account_nama']) && ($_SESSION[$cCode]['main'][$externSrc['cash_account_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['cash_account_nama']] : 0,
                                "extern2_id" => (isset($externSrc['extern2_id']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_id']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_id']] : 0,
                                "extern2_nama" => (isset($externSrc['extern2_nama']) && ($_SESSION[$cCode]['main'][$externSrc['extern2_nama']])) ? $_SESSION[$cCode]['main'][$externSrc['extern2_nama']] : 0,
                            );
                            arrPrintWebs($arrDataPym);
                            $tr->writePaymentSrc($insertID, $arrDataPym);
                        }

                        cekMerah($this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion


            //
            //region nulis paymentAntiSource
            $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_antiSource") != null ? $this->config->item("payment_antiSource") : array();
            if (array_key_exists($stepCode, $paymentSources)) {
                cekHitam(":: starting PAYMENT ANTI SOURCE");
                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs as $paymentSrcConfig) {
                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        $tr->writePaymentAntiSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $_SESSION[$cCode]['main']['nomer'],
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                            "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                            "terbayar_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : '',
                            "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',

                        ));
                        //cekMerah($this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion


            //====registri value-gate
            if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['components'][1]) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['components'][1])) {
                $jurnalIndex = $this->config->item("heTransaksi_core")[$this->jenisTr]['components'][1];
            }
            else {
                if (isset($_SESSION[$cCode]["revert"]["jurnal"]) && sizeof($_SESSION[$cCode]["revert"]["jurnal"]) > 0) {
                    $jurnalIndex = $_SESSION[$cCode]["revert"]["jurnal"];
                }
                else {
                    $jurnalIndex = array();
                }
            }
            //---------------------------------------------------
            if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][1]) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][1])) {
                $jurnalPostProc = $this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][1];
            }
            else {
                if (isset($_SESSION[$cCode]["revert"]["postProc"]) && sizeof($_SESSION[$cCode]["revert"]["postProc"]) > 0) {
                    $jurnalPostProc = $_SESSION[$cCode]["revert"]["postProc"];
                }
                else {
                    $jurnalPostProc = array();
                }
            }
            //---------------------------------------------------
            if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['preProcessor'][1]) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['preProcessor'][1])) {
                $jurnalPreProc = $this->config->item("heTransaksi_core")[$this->jenisTr]['preProcessor'][1];
            }
            else {
                if (isset($_SESSION[$cCode]["revert"]["preProc"]) && sizeof($_SESSION[$cCode]["revert"]["preProc"]) > 0) {
                    $jurnalPreProc = $_SESSION[$cCode]["revert"]["preProc"];
                }
                else {
                    $jurnalPreProc = array();
                }
            }
            //---------------------------------------------------


            $baseRegistries = array(
                'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                'itemSrc' => isset($_SESSION[$cCode]['itemSrc']) ? $_SESSION[$cCode]['itemSrc'] : array(),
                'itemSrc_sum' => isset($_SESSION[$cCode]['itemSrc_sum']) ? $_SESSION[$cCode]['itemSrc_sum'] : array(),
                'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),

                'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptDetailSrcFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailSrcFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailSrcFields'][1] : array(),
                "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][1] : array(),
                //                "jurnal_index" =>isset($this->config->item("heTransaksi_core")[$this->jenisTr]['components'][1]) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['components'][1] : array(),
                "jurnal_index" => $jurnalIndex,
                //                "postProcessor" =>isset($this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][1]) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['postProcessor'][1] : array(),
                "postProcessor" => $jurnalPostProc,
                "preProcessor" => $jurnalPreProc,
                "revert" => isset($_SESSION[$cCode]['revert']) ? $_SESSION[$cCode]['revert'] : array(),
                "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
            );
            //            arrPrint($baseRegistries);
            //===
            $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            $mongRegID = $doWriteReg;
            //            cekHitam($this->db->last_query());

            //========extended steps (if any)
            //region extended steps
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $iKey => $iVal) {
                    if ($iVal > 0) {

                        cekbiru("evaluating $iKey ($iVal) for paymentSrc..");
                        $stepCode = $this->jenisTr . "_";
                        $paymentSources = $this->config->item("payment_source");


                        if (array_key_exists($stepCode, $paymentSources)) {
                            $payConfigs = $paymentSources[$stepCode];
                            cekbiru("$stepCode registered");


                            //===kalau melibatkan payment-source
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    if ($paymentSrcConfig['valueSrc'] == $iKey) {
                                        cekhijau($paymentSrcConfig['valueSrc'] . "/$iKey akan dieksekusi");
                                        $valueSrc = $paymentSrcConfig['valueSrc'];
                                        $externSrc = $paymentSrcConfig['externSrc'];
                                        if ($tr->paymentSrcExistsInMaster($insertID, $stepCode, $paymentSrcConfig['label'])) {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID sudah ada, tidak perlu ditulis");
                                        }
                                        else {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID BELUM ada, ditulis sekarang");
                                            $tr->writePaymentSrc($insertID, array(
                                                "_key" => $iKey,
                                                "jenis" => $stepCode,
                                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                                "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                                "label" => $paymentSrcConfig['label'],
                                                "tagihan" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "terbayar" => 0,
                                                "sisa" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                                "oleh_id" => $this->session->login['id'],
                                                "oleh_nama" => $this->session->login['nama'],
                                                "dtime" => date("Y-m-d H:i:s"),
                                                "fulldate" => date("Y-m-d"),
                                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                                "terbayar_valas" => 0,
                                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                            ));
                                        }
                                        //									cekMerah("paySrc: ".$this->db->last_query());

                                    }
                                    else {
                                        cekmerah($paymentSrcConfig['valueSrc'] . "/$iKey tidak untuk dieksekusi");
                                    }
                                }
                            }

                        }
                        else {
                            cekbiru("$stepCode NOT registered");
                        }


                        //==periksa apakah mainInput memerlukan auth
                        if (array_key_exists($iKey, $inputAuthConfigs)) {
                            $gID = $inputAuthConfigs[$iKey];
                            if (strlen($gID) > 0) {
                                cekhijau("input $iKey bernilai $iVal memerlukan auth dari $gID");
                                $trA = new MdlTransaksi();
                                if ($trA->extStepExistsInMaster($insertID, $iKey)) {
                                    cekhijau("extStep SUDAH terdaftar, sekarang nggak akan ditulis");
                                }
                                else {
                                    cekhijau("extStep belum terdaftar, sekarang hendak ditulis");
                                    $insertNew = $trA->writeExtStep($insertID, array(
                                        "master_id" => $insertID,
                                        "transaksi_id" => $insertID,
                                        "_key" => $iKey,
                                        "_label" => $inputLabels[$iKey],
                                        "_value" => $iVal,
                                        "group_id" => $gID,
                                        "state" => "0",
                                        "proposed_by" => $this->session->login['id'],
                                        "proposed_dtime" => date("Y-m-d H:i:s"),
                                        "done_by",
                                        "done_dtime",
                                    ));
                                    $mongoList['extras'][] = $insertNew;
                                    cekhijau($this->db->last_query());
                                }
                            }

                        }
                    }

                }
            }
            //endregion


            //==================================================================================================
            //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
            // bila step lebih dari 1
            if ($nextProp['num'] > 1) {
                $this->load->model("Mdls/MdlLockerTransaksi");
                $lt = New MdlLockerTransaksi();
                $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], NULL, $insertID);
            }

            //==========================================================================================================

            $masterID = $insertID;

            cekMerah("MULAI LAST_VALIDATE");
            $this->lastValidate($insertID);
            //        mati_disini("setelah lastValidate");

            //
            //region connecting antar cabang
            $mongoListConnect = array();
            $mongRegIDConnect = array();
            $connector = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['connectTo'] : "";
            $preReplacer = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['replacerConnectTo']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['replacerConnectTo'] : array();
            if (strlen($connector) > 0) {
                cekMerah(":: CONNECTING BEGIN...");
                //cekMerah("to be connected to $connector");
                if (sizeof($steps) == 1) {
                    //cekMerah("now connecting to $connector");
                    if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                        die("kode connector tidak dikenali!");
                    }
                    if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                        die("konfigurasi connector harus memiliki step lebih dari satu!");
                    }


                    $oldCode = $cCode;
                    $cCode = "_TR_" . $connector;

                    if (isset($_SESSION[$cCode])) {
                        $_SESSION[$cCode] = null;
                        unset($_SESSION[$cCode]);
                        $_SESSION[$cCode] = array();
                    }

                    //region detector cloner dalam satu cabang
                    $oldStep = $_SESSION[$oldCode]['main']["step_number"];
                    $clonerTransaction = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['clonerTransaction'][$oldStep]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['clonerTransaction'][$oldStep] : array();


                    //endregion
                    if (sizeof($clonerTransaction) && isset($clonerTransaction['main']['cloner'])) {
                        cekHere("i am here");
                        $replacerTableinDetail = array(
                            "dtime" => "dtime",
                            "produk_id" => "id",
                            "produk_kode" => "kode",
                            "produk_label" => "label",
                            "produk_nama" => "nama",
                            "produk_ord_jml" => "produk_ord_jml",
                            "produk_ord_hrg" => "harga1",
                            "satuan" => "satuan",
                            "produk_jenis" => "produk_jenis",
                            "harga" => "harga1",
                            "valid_qty" => "produk_ord_jml",
                        );
                        $replacerStepItems2 = array(
                            "sub_tail_number" => "",
                            "sub_tail_code" => "",
                            "sub_step_avail" => "",
                            "sub_step_current" => "",
                            "sub_step_number" => "",
                            "next_substep_num" => "",
                            "next_substep_code" => "",
                            "next_substep_label" => "",
                            "next_subgroup_code" => "",
                        );

                        $itesmNewTmp = array();
                        foreach ($_SESSION[$oldCode]['items2'] as $indexItems2) {
                            foreach ($indexItems2 as $itemsDetail) {

                                $itesmNewTmp[$itemsDetail['id']] = array_merge($itemsDetail, $replacerStepItems2);
                                foreach ($replacerTableinDetail as $selCol => $xAlias) {
                                    $_SESSION[$oldCode]['tableIn_detail2'][$itemsDetail['id']][$selCol] = $itemsDetail[$selCol];
                                }
                                foreach ($replacerStepItems2 as $stepItems2 => $tempItems2Val) {
                                    $_SESSION[$oldCode]['tableIn_detail2'][$itemsDetail['id']][$stepItems2] = $tempItems2Val;
                                }

                            }

                            //                            arrPrint($itesmNew);
                        }
                        $itesmNew = array();
                        foreach ($itesmNewTmp as $itemsID => $itemData) {
                            if (isset($itemData['harga'])) {
                                $itemData['harga'] = $itemData['produk_ord_hrg'];
                            }
                            if (!isset($itemData['pihakName'])) {
                                $itemData['pihakName'] = $_SESSION[$oldCode]['main']['pihakName'];
                            }

                            $itesmNew[$itemsID] = $itemData;
                        }

                        //region itemsToMaster
                        $itemTomasterStatic = isset($clonerTransaction['staticItemToMaster']) ? $clonerTransaction['staticItemToMaster'] : array();
                        $itemToMaster = isset($clonerTransaction['itemToMaster']) ? $clonerTransaction['itemToMaster'] : array();
                        //                        arrPrint($itemToMaster);
                        if (sizeof($itemToMaster) > 0) {
                            foreach ($_SESSION[$oldCode]['items'] as $itemsTemp) {
                                foreach ($itemToMaster as $colItems => $aliasMaster) {
                                    if (isset($itemsTemp[$colItems])) {
                                        $_SESSION[$oldCode]['main'][$aliasMaster] = $itemsTemp[$colItems];
                                        $_SESSION[$oldCode]['tableIn_master'][$aliasMaster] = $itemsTemp[$colItems];
                                    }
                                }
                            }
                            if (sizeof($itemTomasterStatic) > 0) {
                                foreach ($itemTomasterStatic as $kolStatic => $valStatic) {
                                    $_SESSION[$oldCode]['main'][$kolStatic] = $valStatic;
                                    $_SESSION[$oldCode]['tableIn_master'][$kolStatic] = $valStatic;
                                }
                            }

                        }


                        //endregion

                        $_SESSION[$cCode] = array(
                            "main" => $_SESSION[$oldCode]['main'],
                            "items" => $itesmNew,
                            'items2' => isset($_SESSION[$oldCode]['items2']) ? $_SESSION[$oldCode]['items2'] : array(),
                            'items2_sum' => isset($_SESSION[$oldCode]['items2_sum']) ? $_SESSION[$oldCode]['items2_sum'] : array(),
                            'items3' => isset($_SESSION[$oldCode]['items3']) ? $_SESSION[$oldCode]['items3'] : array(),
                            'items3_sum' => isset($_SESSION[$oldCode]['items3_sum']) ? $_SESSION[$oldCode]['items3_sum'] : array(),
                            'items4_sum' => isset($_SESSION[$oldCode]['items4_sum']) ? $_SESSION[$oldCode]['items4_sum'] : array(),


                            "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                            "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail2'],
                            'tableIn_detail2_sum' => isset($_SESSION[$oldCode]['tableIn_detail2_sum']) ? $_SESSION[$oldCode]['tableIn_detail2_sum'] : array(),
                            "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                            'rsltItems2' => isset($_SESSION[$oldCode]['rsltItems2']) ? $_SESSION[$oldCode]['rsltItems2'] : array(),
                            "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                            'tableIn_detail_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_rsltItems2'] : array(),
                            "main_add_values" => $_SESSION[$oldCode]['main_add_values'],
                            "main_add_fields" => $_SESSION[$oldCode]['main_add_fields'],
                            "main_elements" => $_SESSION[$oldCode]['main_elements'],
                            //
                            "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                            "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values2_sum'],
                            "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                            'tableIn_detail_values_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems2'] : array(),
                            'tableIn_detail_values2_sum' => isset($_SESSION[$oldCode]['tableIn_detail_values2_sum']) ? $_SESSION[$oldCode]['tableIn_detail_values2_sum'] : array(),
                        );

                        //region unset sessio details2
                        //                        unset($_SESSION[$cCode]['tableIn_detail_values2_sum']);
                        if (isset($clonerTransaction['resetGate']) && (sizeof($clonerTransaction['resetGate']) > 0)) {
                            foreach ($clonerTransaction['resetGate'] as $gate) {
                                unset($_SESSION[$cCode][$gate]);
                            }
                        }
                        //endregion

                        $masterReplacers = array(
                            //                        "referensi_id" => $masterID, (dimatikan)
                            "inv" => $tmpNomorNota,
                            //                        "jenis_master"    => $connector,

                            "jenis_master" => $connector,
                            "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            //                        "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                            "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "div_id" => "18",
                            "div_nama" => "default",
                            //                            "cabang_id"       => $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                            //                            "cabang_nama"     => $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                            //                            "cabang2_id"      => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                            //                            "cabang2_nama"    => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                            //                            "gudang_id"       => $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                            //                            "gudang_nama"     => $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                            //                            "gudang2_id"      => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                            //                            "gudang2_nama"    => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                            "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                            "step_current" => 1,
                            "step_number" => 1,
                            "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                            "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                            "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                            "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",


                        );

                        //                        arrPrint( $_SESSION[$cCode]);
                        $masterReplacersO = array(
                            "jenisTr" => $connector,
                            "div_id" => "18",
                            "jenisTrMaster" => $connector,
                            "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                            "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            //                            "placeID"         => $_SESSION[$oldCode]['main']['place2ID'],


                            //                            "placeName"       => $_SESSION[$oldCode]['main']['place2Name'],
                            //                            "place2ID"        => $_SESSION[$oldCode]['main']['placeID'],
                            //                            "place2Name"      => $_SESSION[$oldCode]['main']['placeName'],
                            //                            "cabangID"        => $_SESSION[$oldCode]['main']['place2ID'],
                            //                            "cabangName"      => $_SESSION[$oldCode]['main']['place2Name'],
                            //                            "cabang2ID"       => $_SESSION[$oldCode]['main']['placeID'],
                            //                            "cabang2Name"     => $_SESSION[$oldCode]['main']['placeName'],
                            //                            //
                            //                            "gudang2ID"       => $_SESSION[$cCode]['main']['gudangID'],
                            //                            "gudang2Name"     => $_SESSION[$cCode]['main']['gudangName'],
                            //                            "gudangID"        => $_SESSION[$cCode]['main']['gudang2ID'],
                            //                            "gudangName"      => $_SESSION[$cCode]['main']['gudang2Name'],
                        );
                    }
                    else {
                        $_SESSION[$cCode] = array(
                            "main" => $_SESSION[$oldCode]['main'],
                            "items" => $_SESSION[$oldCode]['items'],
                            'items2' => isset($_SESSION[$oldCode]['items2']) ? $_SESSION[$oldCode]['items2'] : array(),
                            'items2_sum' => isset($_SESSION[$oldCode]['items2_sum']) ? $_SESSION[$oldCode]['items2_sum'] : array(),
                            'items3' => isset($_SESSION[$oldCode]['items3']) ? $_SESSION[$oldCode]['items3'] : array(),
                            'items3_sum' => isset($_SESSION[$oldCode]['items3_sum']) ? $_SESSION[$oldCode]['items3_sum'] : array(),
                            'items4_sum' => isset($_SESSION[$oldCode]['items4_sum']) ? $_SESSION[$oldCode]['items4_sum'] : array(),

                            "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                            "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                            'tableIn_detail2_sum' => isset($_SESSION[$oldCode]['tableIn_detail2_sum']) ? $_SESSION[$oldCode]['tableIn_detail2_sum'] : array(),
                            "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                            'rsltItems2' => isset($_SESSION[$oldCode]['rsltItems2']) ? $_SESSION[$oldCode]['rsltItems2'] : array(),

                            "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                            'tableIn_detail_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_rsltItems2'] : array(),
                            "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                            "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                            "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                            'tableIn_detail_values_rsltItems2' => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems2'] : array(),
                            'tableIn_detail_values2_sum' => isset($_SESSION[$oldCode]['tableIn_detail_values2_sum']) ? $_SESSION[$oldCode]['tableIn_detail_values2_sum'] : array(),
                        );
                        $masterReplacers = array(
                            //                        "referensi_id" => $masterID, (dimatikan)
                            "inv" => $tmpNomorNota,
                            //                        "jenis_master"    => $connector,

                            "jenis_master" => $connector,
                            "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            //                        "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                            "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "cabang_id" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                            "cabang_nama" => isset($preReplacer['cabang2Name']) ? $preReplacer['cabang2Name'] : $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                            "cabang2_id" => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                            "cabang2_nama" => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                            "gudang_id" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                            "gudang_nama" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                            "gudang2_id" => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                            "gudang2_nama" => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                            "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                            "step_current" => 1,
                            "step_number" => 1,
                            "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                            "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                            "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                            "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                        );
                        $masterReplacersO = array(
                            "jenisTr" => $connector,
                            "jenisTrMaster" => $connector,
                            "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                            "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "placeID" => isset($preReplacer['place2ID']) ? $preReplacer['place2ID'] : $_SESSION[$oldCode]['main']['place2ID'],
                            "placeName" => isset($preReplacer['place2Name']) ? $preReplacer['place2Name'] : $_SESSION[$oldCode]['main']['place2Name'],
                            "place2ID" => $_SESSION[$oldCode]['main']['placeID'],
                            "place2Name" => $_SESSION[$oldCode]['main']['placeName'],
                            "cabangID" => isset($preReplacer['cabang2ID']) ? $preReplacer['cabang2ID'] : $_SESSION[$oldCode]['main']['place2ID'],
                            "cabangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$oldCode]['main']['place2Name'],
                            "cabang2ID" => $_SESSION[$oldCode]['main']['placeID'],
                            "cabang2Name" => $_SESSION[$oldCode]['main']['placeName'],
                            //
                            "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                            "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                            "gudangID" => isset($preReplacer['gudang2ID']) ? $preReplacer['gudang2ID'] : $_SESSION[$cCode]['main']['gudang2ID'],
                            "gudangName" => isset($preReplacer['gudang2Name']) ? $preReplacer['gudang2Name'] : $_SESSION[$cCode]['main']['gudang2Name'],
                            "efaktur_source" => isset($preReplacer['efaktur_source']) ? $_SESSION[$cCode]['main']['nomer'] : "",
                        );
                    }

                    //==replace pertama

                    foreach ($masterReplacersO as $key => $val) {
                        $_SESSION[$cCode]['main'][$key] = $val;
                    }


                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }


                    //region penomoran receipt #2
                    //<editor-fold desc="==========penomoran">
                    $this->load->model("CustomCounter");
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");

                    $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                    if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                        die(__LINE__ . " Used number should be registered in 'counters' config as well");
                    }

                    foreach ($counterForNumber as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    }

                    $tmpNomorNota2 = $paramSpec['paramString'];
                    $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);


                    //</editor-fold>
                    //endregion

                    //region dynamic counters #2
                    // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");
                    $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                    $configCustomParams[] = "stepCode";
                    if (sizeof($configCustomParams) > 0) {
                        $cContent = array();
                        foreach ($configCustomParams as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                            $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                            switch ($paramSpec['id']) {
                                case 0: //===counter type is new
                                    $paramKeyRaw = print_r($cParams, true);
                                    $paramValuesRaw = print_r($cValues[$i], true);
                                    $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                    break;
                                default: //===counter to be updated
                                    $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                    break;
                            }
                            //echo "<hr>";
                        }
                    }
                    $appliedCounters2 = base64_encode(serialize($cContent));
                    $appliedCounters_inText2 = print_r($cContent, true);
                    // </editor-fold>
                    //endregion


                    $addValues = array(
                        'counters' => $appliedCounters,
                        'counters_intext' => $appliedCounters_inText,
                        'nomer' => $tmpNomorNota2,
                        'nomer2' => $tmpNomorNota2Alias,
                        'dtime' => date("Y-m-d H:i:s"),
                        'fulldate' => date("Y-m-d"),
                    );
                    foreach ($addValues as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning nota cab1 ke cab2
                    //===daftar perbedaan
                    //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,


                    //==replace kedua

                    $masterReplacers = array(
                        "nomer" => $tmpNomorNota2,
                        "nomer2" => $tmpNomorNota2Alias,
                        "counters" => $appliedCounters2,
                        "counters_intext" => $appliedCounters_inText2,
                    );
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning detail/items cabang1 ke cabang2
                    //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                    $detailReplacers = array(
                        "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                        "sub_step_current" => 1,
                        "sub_step_number" => 1,
                        "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                        "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                        "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                        "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                        //                    "next_substep_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                        //                    "next_substep_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                        //                    "next_subgroup_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                    );
                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                            foreach ($dSpec as $key => $val) {
                                $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                            }
                        }
                    }

                    //region ----------write transaksi & transaksi_data #2
                    if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                        $tr = new MdlTransaksi();
                        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                        $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                        $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                        $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                        $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                        if ($insertID < 1) {
                            die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                        }
                        $mongoListConnect['main'] = array($insertID, $epID);
                    }
                    $inserMainValues = array();
                    if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                        foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                        cekkuning("main_inputs detected");
                        $inserMainValues = array();
                        foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                            //                            cekkuning("making a clone for input key $key / $val");
                            //                            $subInputInsertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                        foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                            $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                        }
                    }


                    if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                        foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                            $tr->writeMainElements($insertID, array(
                                "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                "name" => $aSpec['name'],
                                "label" => $aSpec['label'],
                                "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                            ));
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        $insertIDs = array();
                        $insertDeIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                            $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                            if ($insertDetailID < 1) {
                                die("Gagal saat berusaha write transaction detail entry pada " . __FILE__ . " baris " . __LINE__);
                            }
                            else {
                                $insertIDs[] = $insertDetailID;
                                $insertDeIDs[$insertID][] = $insertDetailID;
                                $mongoListConnect['detail'][] = $insertDetailID;
                            }
                            if ($epID != 999) {
                                $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                if ($insertEpID < 1) {
                                    die("Gagal saat berusaha write transaction detail entry point pada " . __FILE__ . " baris " . __LINE__);
                                }
                                else {
                                    $insertIDs[] = $insertEpID;
                                    $insertDeIDs[$epID][] = $insertEpID;
                                    $mongoListConnect['detail'][] = $insertEpID;
                                }
                            }
                        }
                        if (sizeof($insertIDs) == 0) {
                            die(lgShowAlert("Transaksi gagal disimpan karena rincian transaksi kosong."));
                        }
                        else {
                            $indexing_details = array();
                            foreach ($insertDeIDs as $key => $numb) {
                                $indexing_details[$key] = $numb;
                            }

                            foreach ($indexing_details as $k => $arrID) {
                                $arrBlob = blobEncode($arrID);
                                $this->db->query("UPDATE transaksi SET indexing_details = '$arrBlob' WHERE id=$k");
                                cekOrange($this->db->last_query());
                            }
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                            $insertIDDetail = $tr->writeDetailEntries($insertID, $dSpec);
                            $insertIDs[] = $insertIDDetail;
                            $mongoListConnect['detail'][] = $insertIDDetail;
                            if ($epID != 999) {
                                $insertIDDetail = $tr->writeDetailEntries($epID, $dSpec);
                                $insertIDs[] = $insertIDDetail;
                                $mongoListConnect['detail'][] = $insertIDDetail;
                            }
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                                foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                    if (isset($_SESSION[$cCode]['tableIn_detail'][$pID])) {
                                        $dd = $tr->writeDetailValues($insertID, array(
                                            "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                            "produk_id" => $pID,
                                            "key" => $key,
                                            "value" => $dSpec[$src],
                                        ));
                                        $insertIDs[$pID][] = $dd;
                                        $mongoListConnect['detailValues'][] = $dd;
                                    }
                                }
                            }
                        }
                        if (sizeof($insertIDs) > 0) {
                            $arrBlob = blobEncode($insertIDs);
                            $this->db->query("UPDATE transaksi SET indexing_detail_values = '$arrBlob' WHERE id=$insertID");
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                                foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                    $dd = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => $dSpec[$src],
                                    ));
                                    $insertIDs[] = $dd;
                                    $mongoListConnect['detailValues'][] = $dd;
                                }
                            }


                        }
                    }


                    $idHis = array(
                        $stepNumber => array(
                            "olehID" => $_SESSION[$cCode]['main']['olehID'],
                            "olehName" => $_SESSION[$cCode]['main']['olehName'],
                            "step" => $stepNumber,
                            "trID" => $insertID,
                            "nomer" => $tmpNomorNota2,
                            "nomer2" => $tmpNomorNota2Alias,
                            "counters" => $appliedCounters2,
                            "counters_intext" => $appliedCounters_inText2,
                        ),
                    );
                    $idHis_blob = blobEncode($idHis);
                    $idHis_intext = print_r($idHis, true);

                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array("id" => $insertID), array(
                        "id_master" => $masterID,
                        "id_top" => $insertID,

                        "ids_his" => $idHis_blob,
                        "ids_his_intext" => $idHis_intext,

                    )) or die("Failed to update tr next-state!");

                    $baseRegistries = array(
                        'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                        'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                        'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                        'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                        'items3' => isset($_SESSION[$cCode]['items3']) ? $_SESSION[$cCode]['items3'] : array(),
                        'items3_sum' => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
                        'items4_sum' => isset($_SESSION[$cCode]['items4_sum']) ? $_SESSION[$cCode]['items4_sum'] : array(),

                        'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                        'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),
                        'rsltItems3' => isset($_SESSION[$cCode]['rsltItems3']) ? $_SESSION[$cCode]['rsltItems3'] : array(),

                        'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                        'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                        'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                        'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                        'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                        'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                        'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                        'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                        'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                        'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                        'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                        'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                        'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                        'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                        "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                        "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                        "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                        "items_komposisi" => isset($_SESSION[$cCode]['items_komposisi']) ? $_SESSION[$cCode]['items_komposisi'] : array(),
                    );
                    //                    arrPrint($baseRegistries);

                    $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                    $mongRegIDConnect = $doWriteReg;
                    //endregion

                    //
                    //region nulis paymentSource
                    //                    $stepCode = $connector;
                    $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_source");
                    cekHitam(":: $stepCode ::");
                    if (array_key_exists($stepCode, $paymentSources)) {

                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentSrc($insertID, array(
                                    "jenis" => $connector,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                    "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                    "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                    "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                    "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                    "terbayar_valas" => 0,
                                    "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                ));
                                //cekMerah($this->db->last_query());
                            }
                        }


                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion


                    //region nulis paymentAntiSource
                    //                    $stepCode = $connector;
                    $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_antiSource");
                    if (array_key_exists($stepCode, $paymentSources)) {

                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentAntiSrc($insertID, array(
                                    "jenis" => $connector,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                ));
                                //cekMerah($this->db->last_query());
                            }
                        }


                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion


                    //==================================================================================================
                    //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
                    // bila step lebih dari 1
                    $nextStepConnector = sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']);
                    if ($nextStepConnector > 1) {
                        $this->load->model("Mdls/MdlLockerTransaksi");
                        $lt = New MdlLockerTransaksi();
                        $lt->execLocker($_SESSION[$cCode]['main'], $nextStepConnector, NULL, $insertID);
                    }


                }
                else {
                    //cekMerah("to be delayed to connect to $connector");
                }
            }
            else {
                //cekKuning("not connecting to any tCode");
            }

            //endregion


            //region Com pre purchase
            //split to Pre Pre Purchase Supplies dari Request Cabang untuk stok yang tidak ada/kurang diPusat.
            //sekaligus check jika valid_qty sudah nol maka update next_substep_code transaksi bayangannya.
            //dimatikan sementara untuk TEST
            $iterator = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['comPrePurchase'][1]['detail']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['comPrePurchase'][1]['detail'] : array();
            $aliasMainTrans = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['aliasMainTrans']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['aliasMainTrans'] : 999;
            if (sizeof($iterator) > 0) {
                //            matiHere();
                $tmp = array();
                $this->load->model("MdlTransaksi");
                $l = new MdlTransaksi();
                $l->setFilters(array());
                $l->addFilter("transaksi.link_id=0");
                $l->addFilter("transaksi_data.valid_qty>0");
                $l->addFilter("transaksi_data.next_substep_code='" . $aliasMainTrans . "'");

                $l->addFilter("transaksi_data.produk_id in (" . implode(",", array_keys($_SESSION[$cCode]['items'])) . ")");
                //            $this->db->where("transaksi_data.next_substep_code",$aliasMainTrans);
                //            $this->db->where("(transaksi_data.produk_id='690' or transaksi_data.produk_id='166')");
                //            $this->db->where_in('transaksi_data.produk_id',array("166","640","690","421"));


                $tmp = $l->lookupJoined()->result();
                //            cekHitam($this->db->last_query());
                //            arrPrint( implode(",",array_keys($_SESSION[$cCode]['items'])));
                //matiHEre(sizeof($tmp). " iki ".__LINE__);
                if (sizeof($tmp) > 0) {
                    //                matiHEre("masukk");
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        echo "post-processor: $comName<br>LINE: " . __LINE__;
                        $dSpec = $_SESSION[$cCode][$srcGateName];
                        $tmpOutParams = array();
                        if (isset($tComSpec['loop'])) {
                            foreach ($tComSpec['loop'] as $key => $value) {
                                $tmpOutParams['loop'][$key] = $value;
                            }
                        }
                        if (sizeof($dSpec) > 0) {
                            foreach ($dSpec as $pid => $arrValue) {
                                $tmpOutParams[$srcGateName][$pid] = $arrValue['jml'];
                            }
                        }
                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {
                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                                $tmpOutParams['static'][$key] = $realValue;
                            }
                            if (!isset($tmpOutParams['static']["jenis"])) {
                                $tmpOutParams['static']["jenis"] = $aliasMainTrans;
                            }
                            if (!isset($tmpOutParams['static']["jenis_master"])) {
                                $tmpOutParams['static']["jenis_master"] = $this->jenisTr;
                            }
                            if (!isset($tmpOutParams['static']["transaksi_id"])) {
                                $tmpOutParams['static']["transaksi_id"] = $insertID;
                            }
                            if (!isset($tmpOutParams['static']["transaksi_no"])) {
                                $tmpOutParams['static']["transaksi_no"] = $insertNum;
                            }
                            $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                            $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                        }
                        $mdlName = "Com" . ucfirst($comName);
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                }

            }
            else {
                cekHere("LINE: " . __LINE__ . " || jenis: " . $this->jenisTr . " Tidak masuk Iterator PRE PURCHASE SUPPLIES");
            }

            //endregion Com pre purchase
            //            matiHere("pre otorisasi conented auto request");
            //            cekMerah("TRANSAKSI DONE");

            //region writelog
            $this->load->model("Mdls/" . "MdlActivityLog");
            $hTmp = new MdlActivityLog();
            $tmpHData = array(
                "title" => $_SESSION[$cCode]['main']['jenisTrName'],
                "sub_title" => "Saving new transaction",
                "uid" => $this->session->login['id'],
                "uname" => $this->session->login['nama'],
                "dtime" => date("Y-m-d H:i:s"),
                "transaksi_id" => $insertID,
                "deskripsi_old" => "",
                "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
                "jenis" => $this->jenisTr,
                "ipadd" => $_SERVER['REMOTE_ADDR'],
                "devices" => $_SERVER['HTTP_USER_AGENT'],
                "category" => "transaksi",
                "controller" => $this->uri->segment(1),
                "method" => $this->uri->segment(2),
                "url" => current_url(),

            );
            $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Gagal menulis riwayat data", __FILE__));
            //endregion

            cekKuning(":: mulai cek rek besar dan rek pembantu");
            $cabangID_validate = $this->session->login['cabang_id'];
            validateBalancesComparison($cabangID_validate, $componentGate, $componentConfig, "master", $insertID, $tmpNomorNota);
            validateJurnal($insertID, $componentConfig);
            validateAllBalances();


//                                    mati_disini("LINE: " . __LINE__ . " under maintenance, tunggu beberapa saat lagi yaa..");


            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");

            if (isset($_SESSION[$cCode])) {
                unset($_SESSION[$cCode]);
            }
            if (isset($oldCode)) {
                if (isset($_SESSION[$oldCode])) {
                    unset($_SESSION[$oldCode]);
                }
            }

            //region cloning update mongo
            if (sizeof($mongUpdateList) > 0) {
                $mong = new MdlMongoMother();
                foreach ($mongUpdateList as $metode => $tmpData) {
                    if ($metode == "update") {
                        if (sizeof($tmpData) > 0) {
                            foreach ($tmpData as $gate => $fildsData) {
                                $mong->setTableName($this->mongoTableList[$gate]);
                                foreach ($fildsData as $mongUpadte) {
                                    $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                                }
                            }
                        }
                    }

                }
            }

            //endregion

            //region cloning ke mongo
            if (sizeof($mongoList) > 0) {
                $mong = new MdlMongoMother();
                $tr = new MdlTransaksi();
                foreach ($mongoList as $gateList => $listIDSData) {
                    $tr->setFilters(array());
                    $tr->setSortBy(array());
                    $tr->setTableName($this->mongoTableList[$gateList]);
                    $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                    $tmpTrm = $tr->lookUpAll()->result();

                    if (sizeof($tmpTrm) > 0) {
                        $mong->setTableName($this->mongoTableList[$gateList]);
                        foreach ($tmpTrm as $tmpMain) {
                            $transksi_main = json_decode(json_encode($tmpMain), true);
                            //                            arrPrint($transksi_main);
                            $mong->addData($transksi_main);
                        }
                    }
                    //                    cekHitam($listedTable[$gateList]);
                    //                    cekLime($gateList);

                }
            }
            if (sizeof($mongRegID) > 0) {
                //                $arrMainID = $mongoList['main'];
                $tr->setTableName("transaksi_registry");
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->addFilter("id in (" . implode(",", $mongRegID) . ")");
                $tmpTrm = $tr->lookUpAll()->result();

                $mong->setTableName("transaksi_registry");
                if (sizeof($tmpTrm) > 0) {
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }

            }
            //endregion

            //region cloning conecto mongo
            if (sizeof($mongoListConnect) > 0) {
                $mong = new MdlMongoMother();
                $tr = new MdlTransaksi();
                foreach ($mongoListConnect as $connGate => $connData) {
                    $tr->setFilters(array());
                    $tr->setSortBy(array());
                    $tr->setTableName($this->mongoTableList[$connGate]);
                    $tr->addFilter("id in (" . implode(",", $connData) . ")");
                    $tmpTrm = $tr->lookUpAll()->result();
                    if (sizeof($tmpTrm) > 0) {
                        $mong->setTableName($this->mongoTableList[$connGate]);
                        foreach ($tmpTrm as $tmpMain) {
                            $transksi_main = json_decode(json_encode($tmpMain), true);
                            $mong->addData($transksi_main);
                        }
                    }
                }
            }

            if (sizeof($mongRegIDConnect) > 0) {
                //                $arrMainID = $mongRegIDConnect['main'];
                $tr->setTableName("transaksi_registry");
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->addFilter("id in (" . implode(",", $mongRegIDConnect) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                //                    cekbiru($this->db->last_query());
                $mong->setTableName("transaksi_registry");
                if (sizeof($tmpTrm) > 0) {
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        $mong->addData($transksi_main);
                    }
                }

            }
            //            $mongRegIDConnect //punya registry 2
            //endregion

            //region feedback msg
            $this->session->errMsg = "transaction entry has been saved<br>";
            $nextNum = $nextProp["num"];
            if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
                $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
                $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;

            }
            else {
                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
                $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;

            }
            $trBackClick = "location.href='$trBackLink'";
            //            $this->session->errMsg .= "<a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
            //endregion


            if (strlen($rawPrevURL) > 3) {
                $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
                                   {
                                       title:'Followup preview',
                                       message: " . 'top.$' . "('<div><img class=\"text-center text-bold\" width=\"35%\" src=\"//cdn.mayagrahakencana.com/assets/images/d60eb1v-79212624-e842-4e55-8d58-4ac7514ca8e4.gif\"><br/><h2>MOHON TUNGGU, SYSTEM SEDANG MEMUAT DATA...</h2></div>').load('$prevUrl'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";


                //                echo "<html>";
                //                echo "<head>";
                //                echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
                //                echo "</head>";
                echo "<script>top.open_holdon();$actionTarget</script>";

                //                echo "</body>";
                //                echo "</html>";
            }
            else {


                //                cekkuning("detecting print settings");
                if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint']['1'])) {
                    $printSettings = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint']['1']) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint']['1'] : array();
                    $printLocation = $this->config->item('heTransaksi_layout')[$this->jenisTr]['printLocation'];
                    if (isset($printSettings['size'])) {
                        cekkuning("detecting printing size");

                        switch ($printSettings['size']) {
                            case "normal":

                                //                                cekkuning("size: NORMAL");
                                echo "<script>";
                                echo "top.popBig('" . base_url() . $printLocation . "$tmpNomorNota');";
                                echo "top.location.reload();";
                                echo "</script>";
                                break;
                            case "small":
                                //                                cekkuning("size: SMALL");
                                echo "<script>";
                                echo "top.popSmall('" . base_url() . $printLocation . "$tmpNomorNota');";
                                echo "top.location.reload();";
                                echo "</script>";
                                break;
                            default:
                                //                                cekkuning("size: UNKNOWN");
                                break;
                        }


                    }
                    else {
                        cekkuning("not printing");
                        $arrAlert = array(
                            "type" => "success",
                            "title" => "Transaction saved",
                            //                        "html" => "your order has been saved and ready to process",
                            "html" => $this->session->errMsg,
                            "timer" => "1500",
                            "showConfirmButton" => false,
                            "allowOutsideClick" => false,
                        );
                        echo swalAlert($arrAlert);
                        echo "<script>topReload(1500)</script>";
                        echo topReload();
                        echo "</script>";
                        unset($this->session->errMsg);
                    }

                }
                else {
                    //                    cekkuning("settings dont exist, not printing");
                    $arrAlert = array(
                        "type" => "success",
                        "title" => "Transaction saved",
                        //                        "html" => "your order has been saved and ready to process",
                        "html" => $this->session->errMsg,
                        "timer" => "1500",
                        "showConfirmButton" => false,
                        "allowOutsideClick" => false,
                    );
                    echo swalAlert($arrAlert);
                    echo "<script>topReload(1500)</script>";
                    echo topReload();
                    echo "</script>";
                    unset($this->session->errMsg);
                }

            }

        }
        else {
            die("the gate index you want to debug has not been formed yet!");
        }
    }

    //extract data to shoppingcart
    public function preCancelPacking()
    {
        $no = rtrim($this->uri->segment(3), "-");
        $stepNumber = $this->uri->segment(4);
        $targetJenisTr = $this->uri->segment(5);
        $currentStepNum = $this->uri->segment(6);
        $rawBuilderURL = blobEncode(current_url());

        $this->jenisTr = $targetJenisTr;
        $cCode = "_TR_" . $this->jenisTr;

        $cancelMode = array(
            "cancel" => "$no",
        );

        $editMode = array();

        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tmpTr = $tr->lookupJoined()->result();


        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {
                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }

        $rawItems = array();

        cekHere("no: $no ::: $targetJenisTr");
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {

            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$targetJenisTr]['receiptDetailFields'][$stepNumber]) ? $this->config->item('heTransaksi_layout')[$targetJenisTr]['receiptDetailFields'][$stepNumber] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$targetJenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$targetJenisTr]['shoppingCartNumFields'][$stepNumber] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$targetJenisTr]['shoppingCartAmountValue'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$targetJenisTr]['shoppingCartAmountValue'][$stepNumber] : null;
            $measurementDetails = isset($this->config->item("heTransaksi_ui")[$targetJenisTr]["receiptMesurementRows"]) ? $this->config->item("heTransaksi_ui")[$targetJenisTr]["receiptMesurementRows"] : array();
            $xCancelConfig = isset($this->config->item("heTransaksi_ui")[$targetJenisTr]["xShipmentConfig"][$currentStepNum]) ? $this->config->item("heTransaksi_ui")[$targetJenisTr]["xShipmentConfig"][$currentStepNum] : array();


            $currentID = $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $cCodeOrig = "_TR_" . $origJenis;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = (1);

            //            cekHere("id_master: $masterID");
            //            cekHere("id_top: $topID");
            //            cekHere("nomer: $tmpNomorNota");
            //            cekHere("jenis_master: $origJenis");
            //            cekHere("cCodeOrig: $cCodeOrig");
            //            cekHere("step_number: $currentStepNum");


            if (isset($_SESSION[$cCodeOrig])) {
                $_SESSION[$cCodeOrig] = null;
                unset($_SESSION[$cCodeOrig]);
            }

            //==periksa apakah ada ganjalan
            $trA = new MdlTransaksi();
            $extSteps = $trA->lookupExtSteps($trID);
            if (sizeof($extSteps) > 0) {
                cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
            }
            else {
                cekhijau("TAK ada ganjalan step");
            }

            $paySrcs = $trA->lookupPaymentSrcs($trID, $this->jenisTr . "_");
            if (sizeof($paySrcs) > 0) {
                cekmerah("ada ganjalan paymentSrc sebanyak " . sizeof($paySrcs));
            }
            else {
                cekhijau("TAK ada ganjalan paymentSrc");
            }

            $allowEdit = isset($this->config->item("heTransaksi_ui")[$targetJenisTr]['steps'][$stepNumber]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$targetJenisTr]['steps'][$stepNumber]['allowEdit'] : false;
            $editableFields = isset($this->config->item("heTransaksi_ui")[$targetJenisTr]['shoppingCartEditableFields'][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$targetJenisTr]['shoppingCartEditableFields'][$stepNumber] : array();

            //region valid items
            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            $tr->addFilter("valid_qty>0");
            $tmpTr = $tr->lookupJoined()->result();
            showLast_query("biru");
            $id_top = isset($tmpTr[0]->id_top) ? $tmpTr[0]->id_top : "";

            //region prepacked
            $tmpTrPrePacked = array();
            $trPrePack = new MdlTransaksi();
            $trPrePack->setFilters(array());
            $trPrePack->addFilter("cancel_packing_source_id in (" . implode(",", explode("-", $no)) . ")");
            $trPrePack->addFilter("valid_qty>0");
            $trPrePack->addFilter("trash_4<1");
            $tmpTrPrePacked = $trPrePack->lookupJoined()->result();
            showLast_query("merah");
            cekMerah("ada " . sizeof($tmpTrPrePacked));

            $arrPreTmp__ = array();
            foreach ($tmpTrPrePacked as $y => $dd) {
                if (!isset($arrPreTmp__[$dd->jenis][$dd->produk_id])) {
                    $arrPreTmp__[$dd->jenis][$dd->produk_id] = 0;
                }
                $arrPreTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
            }
            //endregion prepacked

            //region packed
            $tmpTrPacked = array();
            $trPack = new MdlTransaksi();
            $trPack->setFilters(array());
            $trPack->addFilter("id_top in (" . implode(",", explode("-", $id_top)) . ")");
            $trPack->addFilter("valid_qty>0");
            $tmpTrPacked = $trPack->lookupJoined()->result();
            showLast_query("kuning");
            cekKuning("ada " . sizeof($tmpTrPacked));

            $arrTmp__ = array();
            foreach ($tmpTrPacked as $y => $dd) {
                if (!isset($arrTmp__[$dd->jenis][$dd->produk_id])) {
                    $arrTmp__[$dd->jenis][$dd->produk_id] = 0;
                }
                $arrTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
            }
            //endregion packed

            //            arrPrint($arrTmp__);

            $extractedItems = array();//==untuk urusan update transaksi referer
            $validItems = array();
            $validItemSends = array();
            $validItemReqCancels = array();
            $validItemCancels = array();
            $validItemPreCancels = array();
            $validItemPackeds = array();

            if (sizeof($tmpTr) > 0) {
                cekmerah("ada yang mau diekstrak");
                //                arrPrint($tmpTr);
                $shipment = isset($xCancelConfig['shipment']) ? $xCancelConfig['shipment'] : "";
                $packing = isset($xCancelConfig['packing']) ? $xCancelConfig['packing'] : "";
                $cancel = isset($xCancelConfig['cancel']) ? $xCancelConfig['cancel'] : "";

                foreach ($tmpTr as $row) {
                    if (!isset($validItems[$row->produk_id])) {
                        $validItems[$row->produk_id] = 0;
                    }
                    if (!isset($validItemSends[$row->produk_id])) {
                        $validItemSends[$row->produk_id] = 0;
                    }
                    if (!isset($validItemCancels[$row->produk_id])) {
                        $validItemCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemReqCancels[$row->produk_id])) {
                        $validItemReqCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPackeds[$row->produk_id])) {
                        $validItemPackeds[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPreCancels[$row->produk_id])) {
                        $validItemPreCancels[$row->produk_id] = 0;
                    }

                    $validItems[$row->produk_id] += $row->valid_qty;
                    //                    $validItemSends[$row->produk_id] += $row->produk_ord_jml - $row->cancel_qty - $row->valid_qty;
                    //                    $validItemSends[$row->produk_id] += isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0; // ini jumlah yang sudah dikirim atau GRN
                    $validItemSends[$row->produk_id] += isset($arrTmp__[$shipment][$row->produk_id]) ? $arrTmp__[$shipment][$row->produk_id] : 0; // ini jumlah yang sudah dikirim atau GRN
                    $validItemReqCancels[$row->produk_id] += isset($row->req_cancel_qty) ? $row->req_cancel_qty : 0;
                    $validItemCancels[$row->produk_id] += isset($row->cancel_qty) ? $row->cancel_qty : 0;
                    //                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0; // ini jumlah yang sudah direquest cancel item
                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__[$cancel][$row->produk_id]) ? $arrPreTmp__[$cancel][$row->produk_id] : 0; // ini jumlah yang sudah direquest cancel item
                    //                    $validItemPackeds[$row->produk_id] += isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0; // ini jumlah prepacking
                    $validItemPackeds[$row->produk_id] += isset($arrTmp__[$packing][$row->produk_id]) ? $arrTmp__[$packing][$row->produk_id] : 0; // ini jumlah prepacking

                    if (!isset($extractedItems[$row->produk_id])) {
                        $extractedItems[$row->produk_id] = array();
                    }

                    $extractedItems[$row->produk_id][$row->id] = array(
                        "id" => $row->id,
                        "produk_id" => $row->produk_id,
                        "qty" => $row->produk_ord_jml,
                        "valid_qty" => $row->valid_qty,
                        "transaksi_id" => $row->transaksi_id,
                        //                        "packed_qty" => isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0, // ini jumlah prepacking
                        "packed_qty" => isset($arrTmp__[$packing][$row->produk_id]) ? $arrTmp__[$packing][$row->produk_id] : 0, // ini jumlah prepacking
                        "cancel_qty" => $row->cancel_qty,
                        "req_cancel_qty" => $row->req_cancel_qty,
                        "sent_qty" => $row->produk_ord_jml - $row->cancel_qty - $row->valid_qty,
                        "outstanding" => $row->produk_ord_jml - ($row->produk_ord_jml - $row->valid_qty),
                    );
                }
                arrPrintWebs($extractedItems);
            }
            else {
                cekmerah("TIDAK ada yang mau diekstrak");
            }
            //endregion

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //endregion

            //region take from registries
            //==ambil value-gate
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            $tmpReg = $trr->lookupRegistries()->result();
            //            cekKuning(__LINE__ . " " . $this->db->last_query());

            $main = array();
            $items = array();
            $items2 = array();
            $items2_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();
            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();

            $mainElements = array();
            $mainInputs = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = $main + unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = $items + unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = $items2 + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems"://
                            $rsltItems = $rsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems2"://
                            $rsltItems2 = $rsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = $items2_sum + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master"://
                            $masterTableInParams = $masterTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = $childTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems"://
                            $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems2"://
                            $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems"://
                            $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems2"://
                            $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = $masterAddValues + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = $masterAddFields + unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "main_inputs"://
                            $mainInputs = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            $masterReplacers = array(
                "jenisTrMaster" => $targetJenisTr,
                "jenisTrTop" => $targetJenisTr,
                "harga" => 0,
                "masterID" => $masterID,
                "currentID" => $currentID,
            );
            foreach ($masterReplacers as $key => $src) {
                $main[$key] = $src;
                $mainValues[$key] = $src;
                $masterGates[$key] = $src;
            }

            //==revalidate items
            $this->load->library("FieldCalculator");
            $this->load->helper("he_angka");
            $cal = new FieldCalculator();

            if (sizeof($items) > 0) {
                foreach ($items as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $items[$id]['handler'] = "Selectors/_processSelectNotaItem";
                    $tipeSize = isset($iSpec['detilSize']) && sizeof($iSpec['detilSize']) > 0 ? $iSpec['detilSize'] : "";
                    if (array_key_exists($id, $validItems)) {
                        //                        $items[$id]['jml'] = $validItems[$id]-(int)$validItemPreCancels[$id];//orig
                        $items[$id]['jml'] = $validItems[$id];
                        $items[$id]['max_jml'] = (int)$validItems[$id] + (int)$validItemSends[$id] + (int)$validItemPackeds[$id] + (int)$validItemCancels[$id] + (int)$validItemReqCancels[$id];
                        $items[$id]['sent_jml'] = $validItemSends[$id];
                        $items[$id]['packed_jml'] = $validItemPackeds[$id];
                        $items[$id]['cancel_jml'] = $validItemCancels[$id];
                        $items[$id]['req_cancel_jml'] = $validItemPreCancels[$id];

                        if (sizeof($editableFields) > 0) {
                            foreach ($editableFields as $fName) {
                                $items[$id]["max_$fName"] = isset($iSpec[$fName]) ? $iSpec[$fName] : 0;
                            }
                        }
                        if (sizeof($measurementDetails)) {
                            if (in_array($stepNumber, $measurementDetails["allowView"]) && isset($measurementDetails[$tipeSize])) {
                                $selectedColl = $measurementDetails[$tipeSize];
                                foreach ($selectedColl as $colSelected => $tempHelper) {
                                    foreach ($tempHelper as $newKey => $heAngka) {
                                        cekHitam($newKey);
                                        $items[$id][$newKey] = $heAngka($iSpec[$colSelected]);
                                    }
                                }
                            }
                        }
                    }
                    else {
                        unset($items[$id]);
                        unset($childGates[$id]);
                        unset($childTableInParams[$id]);
                        unset($childTableInValueParams[$id]);
                    }
                }
            }

            //region session-swapper
            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => $extractedItems,
                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                "main_add_fields" => $masterAddFields,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                "extSteps" => $extSteps,
                "paySrcs" => $paySrcs,
                "mode" => $cancelMode,
            );


            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;
            }
            //endregion

            //==init replacer
            //==recover nilai HARGA master
            $_SESSION[$cCode]['main']['harga'] = 0;
            if (sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);
                }
            }
        }
        else {
            die(lgShowAlert("No such transaction. You may want to refresh the browser to re-fetch actual content."));
        }


        //        matiHere("STOP DULU...");

        $link = base_url() . "Transaksi/createForm/$targetJenisTr";
        topRedirect($link);
        die();

    }

    //preview followup from shoppingcart__
    public function preCancelPackingPreview()
    {

        $this->jenisTr = $this->uri->segment(3);
        $selectedID = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;

        $stepNumber = isset($_SESSION[$cCode]['tableIn_master']['step_number']) ? $_SESSION[$cCode]['tableIn_master']['step_number'] : 1;
        $itemLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$stepNumber] : array();
        $itemLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$stepNumber] : array();
        $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
        $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$stepNumber] : array();

        $appletConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['applets']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['applets'] : array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
        $imageEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled'] == true ? true : false;

        $inputLabels = array();
        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";

        //        cekHitam($rawPrevURL);

        //region lookup items from shopping cart sessions
        $main = array();
        $items = array();
        $items2 = array();
        $items2_sum = array();
        if (isset($_SESSION[$cCode])) {
            if (isset($_SESSION[$cCode]['items'])) {
                foreach ($_SESSION[$cCode]['items'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : "",
                        "packed_jml" => isset($iSpec['packed_jml']) ? $iSpec['packed_jml'] : "",
                        "sent_jml" => isset($iSpec['sent_jml']) ? $iSpec['sent_jml'] : "",
                        "cancel_jml" => isset($iSpec['cancel_jml']) ? $iSpec['cancel_jml'] : "",
                        "req_cancel_jml" => isset($iSpec['req_cancel_jml']) ? $iSpec['req_cancel_jml'] : "",
                        "max_jml" => isset($iSpec['max_jml']) ? $iSpec['max_jml'] : "",
                        "outstanding" => isset($iSpec['outstanding']) ? $iSpec['outstanding'] : 0,
                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = $iSpec['subtotal'];
                    $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                    $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];
                    $items[] = $tmp;
                }
            }
            if (isset($_SESSION[$cCode]['items2'])) {
                foreach ($_SESSION[$cCode]['items2'] as $iSpec) {
                    if (isset($iSpec['id'])) {
                        $tmp = array(
                            "id" => $iSpec['id'],
                            "nama" => $iSpec['nama'],
                            "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                            "jml" => $iSpec['jml'],
                            "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        );
                        if (sizeof($itemNumLabels) > 0) {
                            foreach ($itemNumLabels as $key => $label) {
                                $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                                if (!isset($main[$key])) {
                                    $main[$key] = 0;
                                }
                                $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;
                            }
                        }
                        if ($noteEnabled) {
                            if (isset($iSpec['note'])) {
                                $tmp['note'] = $iSpec['note'];
                            }
                        }
                        if ($imageEnabled) {
                            if (isset($iSpec['images'])) {
                                $tmp['images'] = $iSpec['images'];
                            }
                        }
                        $tmp['subtotal'] = $iSpec['subtotal'];
                        $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                        $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];
                        $items2[] = $tmp;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['items2_sum'])) {
                foreach ($_SESSION[$cCode]['items2_sum'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "harga" => isset($iSpec['harga']) ? $iSpec['harga'] : "",
                        "referensi" => isset($iSpec['pihakName']) ? $iSpec['pihakName'] : "",

                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = isset($iSpec['subtotal']) ? $iSpec['subtotal'] : 0;


                    $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                    $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];

                    $items2_sum[] = $tmp;
                }
            }
        }
        //endregion

        //region labels for preview's bottom elements
        $jenisTr = $this->jenisTr;
        //        $buttonLabel = $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['actionLabel'];
        $buttonLabel = "<span class='text-uppercase'> " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['actionLabel'] . " </span>";
        if (sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']) > 1) {
            $saveWarning = "clicking <strong>$buttonLabel</strong> button will make transaction state to: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['stateLabel'] . "</strong>";
            $saveWarning .= "<br>It would need to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][2]['userGroup'] . "</strong>";
        }
        else {
            $saveWarning = "clicking <strong>$buttonLabel</strong> button will instantly make transaction state to <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['stateLabel'] . "</strong>";
        }
        //endregion
        //        arrPrint($main);die();

        $stepLabels = array();
        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $num => $sSpec) {
            $stepLabels[$num] = $sSpec['label'];
        }

        //
        //region prepare params to viewer

        $tmpTableIn_master = isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array();
        $tmpTableIn_masterValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        $main = array_merge(array_filter($main), array_filter($tmpTableIn_master), array_filter($tmpTableIn_masterValues), array_filter($_SESSION[$cCode]['main']));
        $mainAddValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
            $mainAddValues = array_merge(array_filter($mainAddValues), array_filter($_SESSION[$cCode]['main_add_values']));
        }

        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                if (array_key_exists($eName, $relElementConfigs)) {
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                            }
                        }
                    }
                    else {
                    }
                }

                if (array_key_exists($eName, $relOptionConfigs)) {
                    if (isset($relOptionConfigs[$eName][$currentValue])) {
                        if (sizeof($relOptionConfigs[$eName][$currentValue]) > 0) {
                            foreach ($relOptionConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                $inputLabels[$oValueName] = $oValSpec['label'];
                            }
                        }
                    }
                    else {
                    }

                }
                else {
                }
            }
        }

        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$stepNumber] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }

        $pairedItemTarget = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName'] : "items2";
        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "itemLabels" => $itemLabels,
            "itemLabels2" => $itemLabels2,
            "noteEnabled" => $noteEnabled,
            "imageEnabled" => $imageEnabled,
            "main" => $main,
            "items" => $items,
            "items2" => $$pairedItemTarget,
            "buttonLabel" => $buttonLabel,
            "saveWarning" => $saveWarning,
            "sumRows" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][1]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][1] : $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1],
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "mainAddValues" => $mainAddValues,
            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            "mainElements" => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
            "actionTarget" => base_url() . $this->uri->segment(1) . "/doPreCancelPacking/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "?rawPrev=$rawPrevURL",
            "appletConfig" => $appletConfigs,
            "elementConfig" => $elementConfigs,
            "mainInputs" => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
            "grandTotal" => isset($_SESSION[$cCode]['main']['grand_total']) ? $_SESSION[$cCode]['main']['grand_total'] : 0,
            "headerRows" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptMainFields'][$stepNumber]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptMainFields'][$stepNumber] : array(),
            "description" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            "stepLabels" => $stepLabels,
            "currentStep" => 1,
            "pairedValue" => isset($_SESSION[$cCode]['pairs']) ? $_SESSION[$cCode]['pairs'] : array(),
        );
        //arrPrint($data);
        if (isset($_SESSION[$cCode]['main'])) {
            $data['pihakID'] = isset($_SESSION[$cCode]['main']['pihakID']) ? $_SESSION[$cCode]['main']['pihakID'] : 0;
            $data['pihakName'] = isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : "";
        }
        //endregion
        $this->load->view("transaksi", $data);
    }

    //preview on approval
    public function followupCancelPackingPrePreview()
    {

        $no = rtrim($this->uri->segment(3), "-");
        $stepNumber = $this->uri->segment(4);
        $currentStepNum = $this->uri->segment(5);
        $rawBuilderURL = blobEncode(current_url());

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tmpTr = $tr->lookupJoined()->result();
        //endregion

        $cancelPackingId = isset($tmpTr[0]->cancel_packing_source_id) ? $tmpTr[0]->cancel_packing_source_id : 0;
        $tmpTrCancelPacking = array();
        $id_top_source_cancel_packing = array();
        if ($cancelPackingId > 0) {
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $cancelPackingId)) . ")");
            $tmpTrCancelPacking = $tr->lookupJoined()->result();
            $id_top_source_cancel_packing = $tmpTrCancelPacking[0]->id_top;
        }

        //        matiHere($id_top_source_cancel_packing);

        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {
                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }
        $rawItems = array();

        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $cCode = "_TR_" . $this->jenisTr;
            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber] : null;
            $measurementDetails = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"] : array();
            $validatePaymentLocker = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["validatePaymentSource"][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["validatePaymentSource"][$stepNumber] : array();
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = ($currentStepNum + 1);

            //region periksa locker value
            $tempLocker = array();
            $tempBtnUndo = array();
            if (sizeof($validatePaymentLocker) > 0) {
                $mdlName = "Mdls/" . $validatePaymentLocker;
                $this->load->model($mdlName);
                $l = new $validatePaymentLocker();
                $l->addFilter("transaksi_id='$no'");
                $l->addFilter("state='active'");
                $l->addFilter("nilai>0");
                $tempLocker = $l->lookupAll()->result();

                if (sizeof($tempLocker) > 0) {
                    $tempBtnUndo = array(
                        "allowedUndone" => true,//tidak boleh di undo/reject
                        "allowedFollow" => false,//boleh di followup
                    );
                }
                else {
                    $jnTarget = isset($this->config->item('payment_source')[$this->jenisTr][$currentStepNum][0]['jenisTarget']) ? $this->config->item('payment_source')[$this->jenisTr][$currentStepNum][0]['jenisTarget'] : "";
                    $tempBtnUndo = array(
                        "allowedUndone" => true,// boleh di undo/reject
                        "allowedFollow" => true,//tidak boleh di followup
                        "label" => isset($this->config->item('heTransaksi_ui')[$jnTarget]['label']) ? $this->config->item('heTransaksi_ui')[$jnTarget]['label'] : "",
                    );
                }
            }

            //endregion

            //==periksa apakah ada ganjalan
            $trA = new MdlTransaksi();
            $extSteps = $trA->lookupExtSteps($masterID);
            if (sizeof($extSteps) > 0) {
                cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
            }
            else {
                cekhijau("TAK ada ganjalan step");
            }
            $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");
            if (sizeof($paySrcs) > 0) {
                cekmerah("ada ganjalan paymentSrc sebanyak " . sizeof($paySrcs));
            }
            else {
                cekhijau("TAK ada ganjalan paymentSrc");
            }

            $allowEdit = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit'] : false;
            $allowCancel = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowCancel'] : false;
            $editableFields = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber] : array();
            $xCancelConfig = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["xShipmentConfig"][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["xShipmentConfig"][$stepNumber] : array();


            //region valid items
            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            $tr->addFilter("sub_step_number='" . $currentStepNum . "'");
            $tr->addFilter("next_substep_code='" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['target'] . "'");
            $tr->addFilter("next_substep_num='$stepNumber'");
            $tr->addFilter("valid_qty>0");
            $tmpTr = $tr->lookupJoined()->result();


            $id_top = isset($tmpTr[0]->id_top) ? $tmpTr[0]->id_top : "";
            $idTr = isset($tmpTr[0]->id) ? $tmpTr[0]->id : "";
            $trPack = new MdlTransaksi();
            $trPack->setFilters(array());
            $trPack->addFilter("id_top in (" . implode(",", explode("-", $id_top)) . ")");
            $trPack->addFilter("valid_qty>0");
            $tmpTrPacked = $trPack->lookupJoined()->result();

            $tmpTrPrePacked = array();
            if (sizeof($id_top_source_cancel_packing) > 0) {
                $trPrePack = new MdlTransaksi();
                $trPrePack->setFilters(array());
                $trPrePack->addFilter("id_top in (" . implode(",", explode("-", $id_top_source_cancel_packing)) . ")");
                $trPrePack->addFilter("valid_qty>0");
                $trPrePack->addFilter("trash_4<1");
                $tmpTrPrePacked = $trPrePack->lookupJoined()->result();
            }
            else {
                $trPrePack = new MdlTransaksi();
                $trPrePack->setFilters(array());
                $trPrePack->addFilter("cancel_packing_source_id in (" . implode(",", explode("-", $no)) . ")");
                $trPrePack->addFilter("valid_qty>0");
                $trPrePack->addFilter("trash_4<1");
                $tmpTrPrePacked = $trPrePack->lookupJoined()->result();
            }

            $arrPreTmp__ = array();
            foreach ($tmpTrPrePacked as $y => $dd) {
                if (!isset($arrPreTmp__[$dd->jenis][$dd->produk_id])) {
                    $arrPreTmp__[$dd->jenis][$dd->produk_id] = 0;
                }
                $arrPreTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
            }

            $arrTmp__ = array();
            foreach ($tmpTrPacked as $y => $dd) {
                if (!isset($arrTmp__[$dd->jenis][$dd->produk_id])) {
                    $arrTmp__[$dd->jenis][$dd->produk_id] = 0;
                }
                $arrTmp__[$dd->jenis][$dd->produk_id] += $dd->produk_ord_jml;
            }

            //            arrPrint($arrPreTmp__);
            //            matiHere();

            $extractedItems = array();//==untuk urusan update transaksi referer

            $validItems = array();
            $validItemSends = array();
            $validItemCancels = array();
            $validItemPreCancels = array();
            $validItemSents = array();

            if (sizeof($tmpTr) > 0) {
                cekmerah("ada yang mau diekstrak");
                $shipment = isset($xCancelConfig['shipment']) ? $xCancelConfig['shipment'] : "";
                $packing = isset($xCancelConfig['packing']) ? $xCancelConfig['packing'] : "";
                $cancel = isset($xCancelConfig['cancel']) ? $xCancelConfig['cancel'] : "";


                foreach ($tmpTr as $row) {

                    if (!isset($validItems[$row->produk_id])) {
                        $validItems[$row->produk_id] = 0;
                    }
                    if (!isset($validItemSends[$row->produk_id])) {
                        $validItemSends[$row->produk_id] = 0;
                    }
                    if (!isset($validItemCancels[$row->produk_id])) {
                        $validItemCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPackeds[$row->produk_id])) {
                        $validItemPackeds[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPreCancels[$row->produk_id])) {
                        $validItemPreCancels[$row->produk_id] = 0;
                    }

                    $validItems[$row->produk_id] += $row->valid_qty;
                    //                    $validItemSends[$row->produk_id] += isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0;
                    $validItemSends[$row->produk_id] += isset($arrTmp__[$shipment][$row->produk_id]) ? $arrTmp__[$shipment][$row->produk_id] : 0;
                    $validItemCancels[$row->produk_id] += $row->cancel_qty;
                    //                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0;
                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__[$cancel][$row->produk_id]) ? $arrPreTmp__[$cancel][$row->produk_id] : 0;
                    //                    $validItemPackeds[$row->produk_id] += isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0;
                    $validItemPackeds[$row->produk_id] += isset($arrTmp__[$packing][$row->produk_id]) ? $arrTmp__[$packing][$row->produk_id] : 0;

                    if (!isset($extractedItems[$row->produk_id])) {
                        $extractedItems[$row->produk_id] = array();
                    }
                    $extractedItems[$row->produk_id][$row->id] = array(
                        "id" => $row->id,
                        "produk_id" => $row->produk_id,
                        "qty" => $row->produk_ord_jml,
                        "valid_qty" => $row->valid_qty,
                        "transaksi_id" => $row->transaksi_id,
                        //                        "packed_qty" => isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0,
                        "packed_qty" => isset($arrTmp__[$packing][$row->produk_id]) ? $arrTmp__[$packing][$row->produk_id] : 0,
                        //                        "sent_qty" => isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0,
                        "sent_qty" => isset($arrTmp__[$shipment][$row->produk_id]) ? $arrTmp__[$shipment][$row->produk_id] : 0,
                        //                        "req_cancel_qty" => isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0,
                        "req_cancel_qty" => isset($arrPreTmp__[$cancel][$row->produk_id]) ? $arrPreTmp__[$cancel][$row->produk_id] : 0,
                        "cancel_qty" => $row->cancel_qty,
                        "outstanding" => $row->produk_ord_jml - ($row->produk_ord_jml - $row->valid_qty),
                    );
                }
            }
            else {
                cekmerah("TIDAK ada yang mau diekstrak");
            }

            cekHijau(__LINE__);
            arrprint($extractedItems);

            //endregion

            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //            //cekMerah(__LINE__. " " .$this->db->last_query());
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //            arrPrint($detailValues);
            //endregion

            //region take from registries
            //==ambil value-gate
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            //            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $tmpReg = $trr->lookupRegistries()->result();
            //            $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();
            //            cekKuning(__LINE__. " " .$this->db->last_query());
            //            matiHere();
            $main = array();

            $items = array();
            $items2 = array();
            $items2_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();

            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();
            //            $mainApplets = array();
            $mainElements = array();
            $mainInputs = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = $main + unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = $items + unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = $items2 + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems"://
                            $rsltItems = $rsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems2"://
                            $rsltItems2 = $rsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = $items2_sum + unserialize(base64_decode($row->values));
                            break;

                        case "tableIn_master"://
                            $masterTableInParams = $masterTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = $childTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems"://
                            $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems2"://
                            $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems"://
                            $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems2"://
                            $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = $masterAddValues + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = $masterAddFields + unserialize(base64_decode($row->values));
                            break;
                        //                        case "main_applets"://
                        //                            $mainApplets = unserialize(base64_decode($row->values));
                        //                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "main_inputs"://
                            $mainInputs = unserialize(base64_decode($row->values));
                            break;
                    }
                }

            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion
            //region replacer Downpayment avail
            if (isset($mainInputs['dp'])) {
                if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["updateDownpayment"][$stepNumber])) {
                    //                    arrPrint($mainInputs);
                    $this->load->model("Coms/ComLockerValue");
                    $mi = new ComLockerValue();
                    $mi->addFilter("produk_id='" . $main['masterID'] . "'");
                    $mainInputAvail = $mi->fetchBalances("downpayment");
                    $lockerVal = $mainInputAvail[0]->nilai;
                    //                    $mainValTmp = reversePpn($mainInputs['dp'],"10");
                    $mainValTmp_dp = $main['dp_value'];
                    $mainValTmp_dp_ppn = $main['dp_ppn_value'];

                    if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                        cekOrange();
                        $validate = round($mainInputAvail[0]->nilai - $mainValTmp_dp, 2);
                        if ($lockerVal > 0) {
                            $valnew = $main['new_net1'] - $lockerVal > 0 ? 0 : $main['new_net1'];
                            $main['dp_value'] = $valnew;
                            $main['dp_ppn_value'] = $valnew * 10 / 100;
                        }
                        else {
                            $main['dp_value'] = 0;
                            $main['dp_ppn_value'] = 0;
                            //                        $main['valid_dp'] = 0;
                        }

                        if ($validate > 0) {
                            $mainInputs['dp'] = $mainInputAvail[0]->nilai;

                        }
                        else {
                            if ($validate < 0) {
                                if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                                    $main['downpayment'] = $mainInputs['dp'];
                                    $mainInputs['downpayment'] = $mainInputs['dp'];
                                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['dp_ppn_value'];

                                }
                                unset($mainInputs['dp']);
                                cekhere("sini po");
                            }
                            //                        if(!isset($main['valid_dp'])){
                            //                            $main['valid_dp'] = $mainInputAvail[0]->nilai;
                            //                        }

                        }
                    }
                    else {
                        //                         $mainInputs['dp'] = 0;
                        $main['dp_value'] = 0;
                        $main['dp_ppn_value'] = 0;
                        unset ($mainInputs['dp']);
                    }

                    if (!isset($main['valid_dp'])) {
                        $main['valid_dp'] = $mainInputAvail[0]->nilai;
                    }
                }


            }
            else {
                if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                    $main['downpayment'] = $main['dp'];
                    $mainInputs['downpayment'] = $main['dp'];
                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['nilai_tambah_ppn_out'];
                }
            }
            //endregion

            $masterReplacers = array(
                "jenisTrMaster" => $this->jenisTr,
                "jenisTrTop" => $masterTableInParams['jenis_top'],
                "harga" => 0,
                "masterID" => $masterID,
            );
            foreach ($masterReplacers as $key => $src) {
                $main[$key] = $src;
                $mainValues[$key] = $src;
                $masterGates[$key] = $src;
            }

            //==revalidate items
            $this->load->library("FieldCalculator");
            $this->load->helper("he_angka");
            $cal = new FieldCalculator();

            if (sizeof($items) > 0) {
                foreach ($items as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $tipeSize = isset($iSpec['detilSize']) && sizeof($iSpec['detilSize']) > 0 ? $iSpec['detilSize'] : "";
                    if (array_key_exists($id, $validItems)) {
                        $items[$id]['jml'] = $validItems[$id] - (int)$validItemPreCancels[$id];
                        $items[$id]['max_jml'] = $validItems[$id] - (int)$validItemPreCancels[$id];
                        $items[$id]['packed_jml'] = $validItemPackeds[$id];
                        $items[$id]['sent_jml'] = $validItemSends[$id];
                        $items[$id]['cancel_jml'] = $validItemCancels[$id];
                        $items[$id]['req_cancel_jml'] = $validItemPreCancels[$id];
                        if (sizeof($editableFields) > 0) {
                            foreach ($editableFields as $fName) {
                                $items[$id]["max_$fName"] = isset($iSpec[$fName]) ? $iSpec[$fName] : 0;
                            }
                        }
                        if (sizeof($measurementDetails)) {
                            if (in_array($stepNumber, $measurementDetails["allowView"]) && isset($measurementDetails[$tipeSize])) {
                                $selectedColl = $measurementDetails[$tipeSize];
                                foreach ($selectedColl as $colSelected => $tempHelper) {
                                    foreach ($tempHelper as $newKey => $heAngka) {
                                        cekHitam($newKey);
                                        $items[$id][$newKey] = $heAngka($iSpec[$colSelected]);
                                    }
                                }
                            }
                        }
                        if ($subAmountConfig != null) {
                            $tmpEx = $cal->multiExplode($subAmountConfig);
                            if (sizeof($tmpEx) > 1) {
                                $newSrc = $subAmountConfig;
                                foreach ($tmpEx as $key2 => $val2) {
                                    if (isset($items[$id][$val2])) {
                                        $newSrc = str_replace($val2, $items[$id][$val2], $newSrc);
                                    }
                                    else {
                                        if (isset($tmp[$val2])) {
                                            $newSrc = str_replace($val2, $items[$val2], $newSrc);
                                        }
                                        else {
                                            $newSrc = str_replace($val2, "0", $newSrc);
                                        }
                                    }
                                }
                                $subtotal = $cal->calculate($newSrc);
                            }
                            else {
                                $subtotal = $items[$id][$subAmountConfig];
                            }
                        }
                        else {
                            $subtotal = 0;
                        }
                        $items[$id]['subtotal'] = $subtotal;
                    }
                    else {
                        cekUngu(":: masuk sini, UNSET semua ::");
                        unset($items[$id]);
                        unset($childGates[$id]);
                        unset($childTableInParams[$id]);
                        unset($childTableInValueParams[$id]);
                    }
                }
            }

            //region session-swapper
            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => $extractedItems,
                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                "main_add_fields" => $masterAddFields,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                "extSteps" => $extSteps,
                "paySrcs" => $paySrcs,
                "lockerPayment" => $tempBtnUndo,
            );
            //            cekKuning("swapping $cCode");
            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;
            }
            //endregion

            //==init replacer
            //==recover nilai HARGA master
            $_SESSION[$cCode]['main']['harga'] = 0;
            //==default load dari nota, maka dianggap langsung done
            $_SESSION[$cCode]['main']['status_4'] = 1;
            $_SESSION[$cCode]['main']['trash_4'] = 0;
            if (sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);
                }
            }

            $this->load->helper("he_value_builder");
            resetValues($this->jenisTr);

            fillValues($this->jenisTr, $this->uri->segment(5), $this->uri->segment(4));

            $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
                                   {
                                       title:'FollowUp Cancel Packing Preview',
                                       message: " . 'top.$' . "('<div></div>').load('" . base_url() . "Transaksi/followupCancelPackingPreview/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "?rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        type:top.BootstrapDialog.TYPE_DEFAULT,
                                        draggable:true,
                                        closable:false,


                                        }
                                        );";

            //            echo "<html>";
            //            echo "<head>";
            //            echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
            //            echo "</head>";
            //            echo "<body onload=\"$actionTarget\">";
            echo "<script>top.close_holdon();$actionTarget</script>";
            //            echo "</body>";
            //            echo "</html>";
        }
        else {
            die(lgShowAlert("No such transaction. You may want to refresh the browser to re-fetch actual content."));
        }


    }

    public function followupCancelPackingPreview()
    {

        $no = rtrim($this->uri->segment(3), "-");
        $targetStepNum = $this->uri->segment(4);
        $currentStepNum = $this->uri->segment(5);
        $afterTargetStepNum = ($targetStepNum + 1);

        $rawPrevURL = blobEncode(current_url());
        $rawBuilderURL = $_GET['rawBuilderURL'];

        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tr->addFilter("sub_step_number='" . $currentStepNum . "'");

        $tmpTr = $tr->lookupJoined()->result();
        //endregion

        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {
                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }
        else {
            //            cekkuning("TAK ada signs");
        }


        $rawItems = array();
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $pelaku = $tmpTr[0]->oleh_id;
            $cCode = "_TR_" . $this->jenisTr;

            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "items2" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            if (!isset($_SESSION[$cCode]['items2'])) {
                $_SESSION[$cCode]['items2'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$targetStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$targetStepNum] : array();
            $itemLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$targetStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$targetStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$targetStepNum] : array();
            $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$targetStepNum] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$targetStepNum] : null;
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $noteEditabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEditabled'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEditabled'][$targetStepNum] : false;
            $noteType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteType'] : "text";
            $addRowsConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows'] : array();
            $imageEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled'] == true ? true : false;
            $imageType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageType'] : "text";

            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = ($currentStepNum + 1);


            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //endregion

            //region take from registries
            //==ambil value-gate
            $tr->setFilters(array());
            $tr->addFilter("trash='0'");
            $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();

            $main = array();
            $items = array();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();

            $mainElements = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion

            foreach ($tmpTr as $row) {
                $id = $row->produk_id;
                $tmp = array();
                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (isset($_SESSION[$cCode]['tableIn_detail_values'][$row->produk_id][$key])) {
                            $fieldValue = $_SESSION[$cCode]['tableIn_detail_values'][$row->produk_id][$key];
                        }
                        else {
                            if (isset($row->$key)) {
                                $fieldValue = $row->$key;
                            }
                        }
                        $tmp[$key] = $fieldValue;
                    }
                }

                //region calculate subtotal
                //                arrPrint($childGates[$id]);
                //===perhitungan subtotal
                $this->load->library("FieldCalculator");
                $cal = new FieldCalculator();


                if ($subAmountConfig != null) {

                    $arrChildGates[$id] = isset($childGates[$id]) ? $childGates[$id] : array();
                    $subtotal = makeValue($subAmountConfig, $arrChildGates[$id], $arrChildGates[$id], 0);
                }
                else {
                    $subtotal = 0;
                    //                    //cekHijau("subtotal NOL");
                }
                $tmp["subtotal"] = $subtotal;
                //endregion

                $rawItems[$row->produk_id] = $tmp;
            }

        }
        else {

            $errMsg = "the entry you are trying to access does not exist.<br>";
            $errMsg .= "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            $errMsg .= "if this error re-occurs, please contact system developer.<br>";


            echo "<script>top.BootstrapDialog.closeAll();</script>";
            die(lgShowAlert($errMsg));
        }
        //endregion

        $items = array();
        $items2 = array();

        $jenisTr = $this->jenisTr;
        $_SESSION[$cCode]['main']['currentID'] = $no;

        //region deteksi tombol2 followup
        $currentStepIndex = array_search($currentStepNum, $signNumbers, true);

        //region blocking edit/reject delete jika ada payment source dari pembelian non credit
        if (isset($_SESSION[$cCode]['lockerPayment']) && $_SESSION[$cCode]['lockerPayment'] == true) {

        }
        //endregion

        //region ========================approve, reject, undo====================================
        $origTCode = heGetOriginTCode($this->jenisTr);
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $thisStepGID = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup'] : "";
        $nextStepGID = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['userGroup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['userGroup'] : "";

        $preProcRevConfig = null != $this->config->item("hePreProcessors");
        $preCompRevConfig = null != $this->config->item("heComponents");


        $deleteSpec = array(
            "label" => "cannot delete",
            "targetUrl" => "",
            "warning" => "",
        );

        $undoSpec = array(
            "label" => "cannot undo",
            "targetUrl" => "",
            "warning" => "",
        );

        $rejectionSpec = array(
            "label" => "cannot reject",
            "targetUrl" => "",
            "warning" => "",
        );

        $approvalSpec = array(
            "label" => "cannot approve",
            "targetUrl" => "",
            "warning" => "",
        );

        $editSpec = array(
            "label" => "cannot edit",
            "targetUrl" => "",
            "warning" => "",
        );

        $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
        $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
        $evCom = evaluateComponents($this->jenisTr, $currentStepNum);

        //cekHere("origTCODE: $origTCode, evPre: $evPre, evPost: $evPost, evCom: $evCom, currentStep: $currentStepNum, " .
        //            placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum));

        //==delete
        if ($origTCode == null && $currentStepNum == 1 && $pelaku == $this->session->login['id'] && placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
            //            cekbiru("checking if i may delete my action");

            if (isset($_SESSION[$cCode]['lockerPayment']['allowedUndone']) && $_SESSION[$cCode]['lockerPayment']['allowedUndone'] == true) {
                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    //                    cekHere("$evPre :: $evPost :: $evCom");
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT");
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);

                        $rejectionSpec = array(
                            "label" => "reject",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "pressing REJECT will set this entry one step behind. continue?",
                        );
                    }
                    else {
                        //                cekmerah("NOT allowed to REJECT");
                    }
                }
            }
            else {
                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);

                //            cekmerah("evPre: $evPre, evPos: $evPost, evCom: $evCom");

                if ($evPre == null && $evPost == null && $evCom == null) {
                    //                cekhijau("allowed to undo");
                    $masterRevertStep = ($currentStepNum - 1);
                    $childRevertStep = -($currentStepNum);
                    $deleteSpec = array(
                        "label" => "safely delete",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                        "warning" => "DELETING this entry will destroy all of its details and can not be undone. continue?",
                    );
                }
                else {
                    //                cekmerah("NOT allowed to undo");
                }
            }

        }
        //==undo
        if ($origTCode == null && $currentStepNum > 1 && placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
            //            cekbiru("checking if i may undo my action");
            if (isset($_SESSION[$cCode]['lockerPayment']['allowedUndone']) && $_SESSION[$cCode]['lockerPayment']['allowedUndone'] == true) {
                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    //                    cekHere("$evPre :: $evPost :: $evCom");
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT");
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);

                        $rejectionSpec = array(
                            "label" => "reject",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "pressing REJECT will set this entry one step behind. continue?",
                        );
                    }
                    else {
                        //                cekmerah("NOT allowed to REJECT");
                    }
                }
            }
            else {
                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);

                //                        cekmerah("evPre: $evPre, evPos: $evPost, evCom: $evCom");

                if ($evPre == null && $evPost == null && $evCom == null) {
                    //                cekhijau("allowed to undo");
                    $masterRevertStep = ($currentStepNum - 1);
                    $childRevertStep = -($currentStepNum);
                    $undoSpec = array(
                        "label" => "undo last step",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                        "warning" => "pressing UNDO will set this entry one step behind. continue?",
                    );
                }
                else {
                    //                cekmerah("NOT allowed to undo");
                }
            }

        }
        //==reject
        if ($origTCode == null && $currentStepNum > 0 && placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
            //cekPink2("MASUK REJECT");
            if (isset($_SESSION[$cCode]['lockerPayment']['allowedUndone']) && $_SESSION[$cCode]['lockerPayment']['allowedUndone'] == true) {

                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                    $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                    $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                    //                    cekHere("$evPre :: $evPost :: $evCom");
                    if ($evPre == null && $evPost == null && $evCom == null) {
                        //                        cekhijau("allowed to REJECT");
                        $masterRevertStep = ($currentStepNum - 1);
                        $childRevertStep = -($currentStepNum);

                        $rejectionSpec = array(
                            "label" => "reject",
                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                            "warning" => "pressing REJECT will set this entry one step behind. continue?",
                        );
                    }
                    else {
                        //                cekmerah("NOT allowed to REJECT");
                    }
                }
                //                cekMerah("not allowed to reject");
            }
            else {

                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                //cekHitam("$evPre :: $evPost :: $evCom");
                if ($evPre == null && $evPost == null && $evCom == null) {
                    //cekhijau("allowed to REJECT");
                    $masterRevertStep = ($currentStepNum - 1);
                    $childRevertStep = -($currentStepNum);

                    $rejectionSpec = array(
                        "label" => "reject",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum",
                        "warning" => "pressing REJECT will set this entry one step behind. continue?",
                    );
                }
                else {
                    //                cekmerah("NOT allowed to REJECT");
                }
            }

        }
        //edit
        if ($origTCode == null && $currentStepNum > 0 && placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
            $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
            $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
            $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
            $evMaster = evaluateMain($this->jenisTr, $currentStepNum);
            //            cekHere("$evPre :: $evPost :: $evCom :: -- $evMaster");
            if ($evPre == null && $evPost == null && $evCom == null && $evMaster == null) {
                //                cekhijau("allowed to EDIT");
                $editSpec = array(
                    "label" => "edit",
                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doPreEdit/$no/$jenisTr/$currentStepNum",
                    "warning" => "pressing EDIT will modify entire transaction data. continue?",
                );
            }
            else {
                //                cekmerah("NOT allowed to EDIT");
            }
        }
        else {
            if ($pelaku == $this->session->login['id']) {
                $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
                $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
                $evCom = evaluateComponents($this->jenisTr, $currentStepNum);
                $evMaster = evaluateMain($this->jenisTr, $currentStepNum);
                if ($evPre == null && $evPost == null && $evCom == null && $evMaster == null) {
                    cekhijau("allowed to EDIT");
                    $editSpec = array(
                        "label" => "edit",
                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doPreEdit/$no/$jenisTr/$currentStepNum",
                        "warning" => "pressing EDIT will modify entire transaction data. continue?",
                    );
                }
                else {
                    cekmerah("NOT allowed to EDIT");
                }
            }
        }
        //==approve
        if ($targetStepNum > $currentStepNum) {
            if (isset($_SESSION[$cCode]['lockerPayment']['allowedFollow']) && $_SESSION[$cCode]['lockerPayment']['allowedFollow'] == true) {
                if ($_SESSION[$cCode]['main']['paymentMethod'] == "credit") {
                    if (isset($this->accessList[$this->jenisTr])) {
                        if (isset($this->accessList[$this->jenisTr][$targetStepNum])) {
                            $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                            if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                                $trs = new MdlTransaksi();
                                $trs->setFilters(array());
                                $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                                if (sizeof($tmpPymSrc)) {
                                    if ($tmpPymSrc[0]->sisa > 0) {
                                        $approvalSpec = array(
                                            "label" => "continue to next step",
                                            "targetUrl" => "",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                            "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                            "label" => $paymentSrcCek['label'],
                                        );
                                    }
                                    else {
                                        $approvalSpec = array(
                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                    }
                                }
                                else {
                                    $approvalSpec = array(
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                }
                            }
                            else {
                                $approvalSpec = array(
                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                    "warning" => "pressing green button will set this entry one step ahead. continue?",
                                );
                            }
                        }
                    }
                    else {
                        if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                            $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                            $msgWarning2 = array();
                            if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                                $trs = new MdlTransaksi();
                                $trs->setFilters(array());
                                $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                                if (sizeof($tmpPymSrc)) {
                                    if ($tmpPymSrc[0]->sisa > 0) {
                                        $approvalSpec = array(
                                            "label" => "continue to next step",
                                            "targetUrl" => "",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                        $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                            "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                            "label" => $paymentSrcCek['label'],
                                        );
                                    }
                                    else {
                                        $approvalSpec = array(
                                            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                            "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                            "warning" => "pressing green button will set this entry one step ahead. continue?",
                                        );
                                    }
                                }
                                else {
                                    $approvalSpec = array(
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                }
                            }
                            else {
                                $approvalSpec = array(
                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                    "warning" => "pressing green button will set this entry one step ahead. continue?",
                                );
                            }
                        }
                        else {
                        }
                    }
                }
                else {
                    $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                        "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                        "label" => isset($_SESSION[$cCode]['lockerPayment']['label']) ? $_SESSION[$cCode]['lockerPayment']['label'] . " belum dilakukan. Segera hubungi pihak Finance." : "Segera hubungi pihak Finance untuk follow up",
                    );
                }
            }
            else {
                if (isset($this->accessList[$this->jenisTr])) {
                    if (isset($this->accessList[$this->jenisTr][$targetStepNum])) {
                        $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                        if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                            $trs = new MdlTransaksi();
                            $trs->setFilters(array());
                            $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                            if (sizeof($tmpPymSrc)) {
                                if ($tmpPymSrc[0]->sisa > 0) {
                                    $approvalSpec = array(
                                        "label" => "continue to next step",
                                        "targetUrl" => "",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                    $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                        "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                        "label" => $paymentSrcCek['label'],
                                    );
                                }
                                else {
                                    $approvalSpec = array(
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                }
                            }
                            else {
                                $approvalSpec = array(
                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                    "warning" => "pressing green button will set this entry one step ahead. continue?",
                                );
                            }
                        }
                        else {
                            $approvalSpec = array(
                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                            );
                        }
                    }
                }
                else {
                    if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                        //                cekBiru(":: $currentStepNum :: $targetStepNum ::");
                        $paymentSrcCek = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['paymentSrc'] : array();
                        $msgWarning2 = array();
                        if ((sizeof($paymentSrcCek)) && (isset($paymentSrcCek['enabled'])) && ($paymentSrcCek['enabled'] == true)) {
                            $trs = new MdlTransaksi();
                            $trs->setFilters(array());
                            $tmpPymSrc = $trs->lookupPaymentSrcByTransID($_SESSION[$cCode]['main']['masterID'])->result();
                            if (sizeof($tmpPymSrc)) {
                                if ($tmpPymSrc[0]->sisa > 0) {
                                    $approvalSpec = array(
                                        "label" => "continue to next step",
                                        "targetUrl" => "",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                    $msgWarning2[$_SESSION[$cCode]['main']['masterID']] = array(
                                        "id" => "trItems_" . $_SESSION[$cCode]['main']['masterID'],
                                        "label" => $paymentSrcCek['label'],
                                    );
                                }
                                else {
                                    $approvalSpec = array(
                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                        "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                        "warning" => "pressing green button will set this entry one step ahead. continue?",
                                    );
                                }
                            }
                            else {
                                $approvalSpec = array(
                                    "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                    "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                    "warning" => "pressing green button will set this entry one step ahead. continue?",
                                );
                            }
                        }
                        else {
                            $approvalSpec = array(
                                "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'] : "continue to next step",
                                "targetUrl" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
                                "warning" => "pressing green button will set this entry one step ahead. continue?",
                            );
                        }
                    }
                    else {
                    }
                }
            }
        }
        else {
            //                        cekmerah("NOT possible to approve");
        }
        //endregion

        if (sizeof($signNumbers) > 0) {
            if ($currentStepIndex > 0) {
                $beforeCurrentIndex = ($currentStepIndex - 1);
                $beforeCurrentStep = $signNumbers[$beforeCurrentIndex];
            }
            else {
                $beforeCurrentStep = 0;
            }

            $masterRevertStep = $beforeCurrentStep;

            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
                //                if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
                $mComponents = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master'] : array();

                if (sizeof($mComponents) > 0) {
                    $comNames = array();
                    foreach ($mComponents as $cSpec) {
                        $comNames[] = $cSpec['comName'];
                    }
                    if (in_array("Jurnal", $comNames)) {
                        //==tidak bisa di-revert
                    }
                    else {
                        $allowRevert = true;
                        //                        $revertLabel = $masterRevertStep . "undo " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                        $revertLabel = "undo";
                        $childRevertStep = -($currentStepNum);
                        $revertTarget = base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";

                    }
                }
                else {
                    $allowRevert = true;
                    //                    $revertLabel = $masterRevertStep . "undo " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                    $revertLabel = "undo";
                    $childRevertStep = -($currentStepNum);
                    $revertTarget = base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";
                }

            }
        }

        //arrprint($rejectionSpec);


        //region check if i may approve or unapprove current transaction
        if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum])) {
            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $targetStepNum)) {
                //            if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['userGroup'], $this->session->login['membership'])) {
                $allowFollowup = true;

                $acceptLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$targetStepNum]['actionLabel'];
                $acceptTarget = base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum/$currentStepNum";

                //                echo $masterRevertStep;
                if (isset($masterRevertStep)) {


                    $mPreProcs = heCountPreProcs($this->jenisTr, $currentStepNum);
                    $mPostProcs = heCountPostProcs($this->jenisTr, $currentStepNum);
                    $mComs = heCountComponents($this->jenisTr, $currentStepNum);

                    //                    arrprint($mPreProcs);
                    //                    arrprint($mPostProcs);

                    //==set default to ENABLED
                    $childRevertStep = -($currentStepNum);
                    $rejectionLabel = "reject (def)";
                    $rejectionTarget = base_url() . $this->uri->segment(1) . "/dontFollowup/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";


                    if (sizeof($mPreProcs['reversable']) > 0 || sizeof($mPostProcs['reversable']) > 0) {//maka cek dulu, boleh  cancel apa kagak
                        //==set default to DISABLED
                        $rejectionLabel = "can not reject";
                        $rejectionTarget = "";

                    }
                    else {//==langsung bisa dicancel
                        if (heJournalExists($this->jenisTr, $currentStepNum)) {
                            $rejectionLabel = "can not reject";
                            $rejectionTarget = "";
                        }
                        else {
                            //boleh
                        }

                    }


                }

            }
        }
        //endregion

        //region prevalidator
        $items = $rawItems;
        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preValidator'][$targetStepNum])) {
            $procList = $this->config->item('heTransaksi_core')[$this->jenisTr]['preValidator'][$targetStepNum];

            if (sizeof($procList) > 0) {
                //                //cekBiru("now processing prevalidator..<br>");
                foreach ($procList as $procName) {
                    $mdlProcName = "PreValidator" . $procName;
                    $this->load->model($mdlProcName);
                    //                                            cekHijau("preval name: $mdlProcName<br>");
                    if (isset($childGates) && sizeof($childGates) > 0) {
                        $prc = new $mdlProcName();
                        $requiredParams = $prc->getRequiredParams();
                        if (sizeof($requiredParams) > 0) {
                            $sentParams = array();
                            foreach ($childGates as $odSpec) {
                                $tmp = array();
                                foreach ($requiredParams as $key) {
                                    $tmp[$key] = $odSpec[$key];
                                }

                                $sentParams[] = $tmp;
                            }

                            $prc->pair($masterID, $sentParams);
                            $gotParams = $prc->exec();
                            //                                cekHijau("gotParams");
                            //                                arrprint($gotParams);
                            //                            print_r($gotParams);die();
                            if (isset($gotParams['items2']) && sizeof($gotParams['items2']) > 0) {

                                //                                $items2 = $rawItems;
                                $items2 = $gotParams['items2'];
                                foreach ($gotParams['items2'] as $id => $iSpec) {
                                    //										$id=$iSpec['id'];
                                    if (isset($_SESSION[$cCode]['items'][$id])) {

                                        $items2[$id]['produk_ord_jml'] = $iSpec['produk_ord_jml'];
                                        $items2[$id]['produk_nama'] = $rawItems[$id]['produk_nama'];
                                        $items2[$id]['satuan'] = $rawItems[$id]['satuan'];


                                        $items[$id]['produk_ord_jml'] -= $iSpec['produk_ord_jml'];
                                        $_SESSION[$cCode]['items'][$id]['jml'] -= $iSpec['produk_ord_jml'];
                                        if ($items[$id]['produk_ord_jml'] < 1) {
                                            unset($items[$id]);
                                        }
                                        if ($_SESSION[$cCode]['items'][$id]['jml'] < 1) {
                                            unset($_SESSION[$cCode]['items'][$id]);
                                        }
                                    }
                                }
                            }

                        }
                        else {
                            die("preval $procName does not have requiredParams!");
                        }

                    }
                    else {
                        die("out_detail contains nothing!. skipping preprocessor");
                    }
                }
            }

        }
        else {
            //                echo("no preval defined. skipping preval..<br>");
        }

        //endregion

        //region preview bottom elements

        $saveWarning = "";
        $buttonLabel = $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$targetStepNum]['actionLabel'];
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$afterTargetStepNum])) {
            $saveWarning .= "clicking <strong>$buttonLabel</strong> button will make transaction state to: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['stateLabel'] . "</strong>";
            $saveWarning .= "<br>It would need to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$afterTargetStepNum]['userGroup'] . "</strong>";
        }
        else {
            $saveWarning .= "clicking <strong>$buttonLabel</strong> button will instantly make transaction state to <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['stateLabel'] . "</strong>";
        }

        //endregion

        //region warn if irreverseble
        $mComponents = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$targetStepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$targetStepNum]['master'] : array();
        if (sizeof($mComponents) > 0) {
            $comNames = array();
            $reks = array();
            foreach ($mComponents as $cSpec) {
                $comNames[] = $cSpec['comName'];
                if ($cSpec['comName'] == "Jurnal") {
                    if (isset($cSpec['loop']) && sizeof($cSpec['loop']) > 0) {
                        foreach ($cSpec['loop'] as $rek => $v) {
                            $reks[$rek] = $rek;
                        }
                    }
                }
            }
            if (in_array("Jurnal", $comNames)) {
                //==tidak bisa di-revert
                $saveWarning .= "<br><span class='text-danger'>starting from this point, you can not undo the change made on this entry.</span>";
                if (sizeof($reks) > 0) {
                    $saveWarning .= "<br><h6><span class='text-blue'>these accounts will be affected at journal: <strong>" . implode(", ", $reks) . ".</strong></span></h6>";
                }
            }
        }
        //endregion

        $msgWarning = $this->validate2();

        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        //        $mainProp = (object)$_SESSION[$cCode]['main'];
        $mainPropReplacers = array(//===replace khusus kebutuhan preview next step
            "jenis_label" => $tmpTr[0]->next_step_label,
            "nomer" => $tmpTr[0]->nomer,
            "result_nomer" => "(to be generated)",
            "dtime" => date("Y-m-d H:i:s"),
        );
        foreach ($mainPropReplacers as $key => $val) {
            $mainProp->$key = $val;
        }
        //endregion
        //
        //region prepare params for viewer

        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $targetStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }


        $editableElements = array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $xShipmentConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['xShipmentConfig']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['xShipmentConfig'] : array();
        //            $appletConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['applets']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['applets'] : array();
        if (sizeof($_SESSION[$cCode]['main_elements']) > 0) {

            if (sizeof($elementConfigs) > 0) {
                foreach ($elementConfigs as $aKey => $aSpec) {
                    if (array_key_exists($aKey, $mainElements) && in_array($targetStepNum, $aSpec['editPoints'])) {
                        $editableElements[] = $aKey;
                    }
                    if (isset($relElementConfigs[$aKey])) {
                        foreach ($relElementConfigs[$aKey] as $mainRel => $relData) {
                            foreach ($relData as $relKey => $relDetails) {
                                if (in_array("o_seller_spv", $mems)) {
                                    if (array_key_exists($relKey, $mainElements) && in_array($targetStepNum, $relDetails['editPoints'])) {
                                        $editableElements[] = $relKey;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        //region elements editor

        $elStr = array();
        $elements = array();
        $aFilter = array();

        if (sizeof($elementConfigs) > 0) {
            foreach ($elementConfigs as $eName => $eSpec) {
                switch ($eSpec['elementType']) {
                    case "dataModel":
                        $addStr = "";
                        $editStr = "";
                        $amdlName = $eSpec['mdlName'];
                        $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();

                        $elStr[$eName] = "";
                        $this->load->model("Mdls/" . $amdlName);
                        $labelSrc = $eSpec['labelSrc'];
                        $keySrc = $eSpec['key'];
                        $oo = new $amdlName();
                        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $amdlName);
                        //                        $realFilter = "";
                        if (sizeof($aFilter) > 0) {
                            foreach ($aFilter as $filter) {
                                $exFilter = explode("=", $filter);
                                if (sizeof($exFilter) > 1) {
                                    if (isset($_SESSION[$cCode]['main'][$exFilter[1]])) {
                                        $oo->addFilter($exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'");
                                        //                                    $realFilter = $exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'";
                                        $addLink .= "?reqField=" . $exFilter[0] . "&reqVal=" . $_SESSION[$cCode]['main'][$exFilter[1]];
                                    }
                                }
                            }
                        }
                        $addClick = "";
                        $dataAccess = isset($this->config->item('heDataBehaviour')[$amdlName]) ? $this->config->item('heDataBehaviour')[$amdlName] : array(
                            "viewers" => array(),
                            "creators" => array(),
                            "creatorAdmins" => array(),
                            "updaters" => array(),
                            "updaterAdmins" => array(),
                            "deleters" => array(),
                            "deleterAdmins" => array(),
                            "historyViewers" => array(),
                        );
                        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
                        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
                            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        }
                                        );";
                                $addStr = "<a href='javascript:void(0)' class='btn btn-default' onclick=\"$addClick\"><span class='glyphicon glyphicon-plus'></span></a>";
                            }
                        }
                        //                        if (strlen($realFilter) > 0) {
                        //                            $oo->addFilter($realFilter);
                        //                        }
                        $tmpo = $oo->lookupAll()->result();
                        $elPair[$amdlName] = array();
                        $selectorTarget = base_url() . get_class($this) . "/fetchElement/" . $this->jenisTr . "/$eName/$amdlName/?key='+this.value";
                        //                        $elStr[$eName] .= "<div class='box'>";
                        $elStr[$eName] .= "<div class='box-body'>";
                        $elStr[$eName] .= "<select class='form-control' onchange=\"top.$('#result').load('$selectorTarget');\">";
                        $elStr[$eName] .= "<option value=''>-select-</option>";
                        if (sizeof($tmpo) > 0) {
                            foreach ($tmpo as $row) {
                                //                                cekHitam($keySrc);
                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $row->$labelSrc . "</option>";
                                //                                $elStr[$eName] .= "<option value='" . $row->id . "' $selected>" . $row->$labelSrc . "</option>";
                            }
                        }
                        $elStr[$eName] .= "</select>";
                        $elStr[$eName] .= "</div class='box-header'>";

                        $defKey = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : 0;
                        $defValue = "";
                        if (isset($_SESSION[$cCode]['main_elements'][$eName]['key']) && $_SESSION[$cCode]['main_elements'][$eName]['contents']) {
                            if (isset($elementConfigs[$eName]['usedFields']) && sizeof($elementConfigs[$eName]['usedFields']) > 0) {
                                $defValue .= "<table class='table table-condensed no-padding' style='padding:0px;margin:0px;'>";
                                $contents[$eName] = unserialize(base64_decode($_SESSION[$cCode]['main_elements'][$eName]['contents']));
                                foreach ($elementConfigs[$eName]['usedFields'] as $src => $label) {
                                    $fieldLabel = isset($contents[$eName][$src]) ? $contents[$eName][$src] : "-";
                                    $defValue .= "<tr>";
                                    $defValue .= "<td align='left'>$label";
                                    $defValue .= "</td>";
                                    $defValue .= "<td align='left'>" . $fieldLabel;
                                    $defValue .= "</td>";
                                    $defValue .= "</tr>";
                                }
                                $defValue .= "</table>";
                            }
                        }


                        if ($defKey > 0) {
                            if (sizeof($mems) > 0 && sizeof($dataAccess['updaters']) > 0) {
                                $editLink = base_url() . "Data/edit/" . str_replace("Mdl", "", $amdlName) . "/$defKey";
                                if (sizeof(array_intersect($mems, $dataAccess['updaters'])) > 0) {
                                    $editClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $editLink . "'),
                                        draggable:true,
                                        size:BootstrapDialog.SIZE_WIDE,
                                        closable:true,
                                        }
                                        );";

                                    $editStr = "<a href='javascript:void(0)' class='btn btn-default' onclick=\"$editClick\"><span class='glyphicon glyphicon-pencil'></span></a>";
                                }
                            }
                        }

                        $elStr[$eName] .= "<div id='divel_$eName' style='padding:2px;font-size:smaller;'>$defValue";
                        $elStr[$eName] .= "</div id='el$amdlName'>";
                        $elStr[$eName] .= "<div class='box-footer'>";

                        $elStr[$eName] .= "<span class='pull-right'>$editStr $addStr</span>";
                        $elStr[$eName] .= "</div class='box-footer'>";

                        $elements[$eName] = array(
                            "mdlName" => $eSpec['mdlName'],
                            "label" => $eSpec['label'],
                            "string" => $elStr[$eName],
                        );


                        break;
                    case "dataField":
                        $elStr[$eName] = "";
                        $defaultValue = isset($eSpec['defaultValue']) ? $eSpec['defaultValue'] : "";
                        $selectorTarget = "'" . base_url() . get_class($this) . "/recordFieldElement/" . $this->jenisTr . "/$eName/$amdlName/?val='+this.value";
                        //                        $elStr[$eName] .="<div class='box'>";

                        $elStr[$eName] .= "<div class='box-body'>";
                        switch ($eSpec['inputType']) {
                            case "text":
                                $elStr[$eName] .= "<input type=text class='form-control' value='$defaultValue' onblur=\"top.$('#result').load($selectorTarget);\">";
                                break;
                            case "date":
                                $elStr[$eName] .= "<input type=date class='form-control' value='$defaultValue' onblur=\"top.$('#result').load($selectorTarget);\">";
                                break;
                        }
                        $elStr[$eName] .= "</div class='box-body'>";

                        $elements[] = array(
                            "mdlName" => null,
                            "label" => $eSpec['label'],
                            "string" => $elStr[$eName],
                        );
                        break;
                }
            }
        }

        //endregion

        $xShipmentBtn = array();
        if ($xShipmentConfig) {
            foreach ($xShipmentConfig as $num => $val) {
                $xShipmentBtn_str = array(
                    "label" => "close/fullfillment transaksi",
                    "targetUrl" => base_url() . $this->uri->segment(1) . "/preCancelPacking/$no/$jenisTr/1982/$currentStepNum",
                    "warning" => "You may cancel the Packing with the remaining items that have not been Packed to Shipping. continue cancel this packing?",
                );
                $xShipmentBtn = $num == $currentStepNum ? $xShipmentBtn_str : "";
            }
        }

        $stepLabels = array();
        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $num => $sSpec) {
            $stepLabels[$num] = $sSpec['label'];
        }

        $tmpTableIn_master = isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array();
        $tmpTableIn_masterValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        $main = array_merge(array_filter($main), array_filter($tmpTableIn_master), array_filter($tmpTableIn_masterValues));
        $mainAddValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
            $mainAddValues = array_merge(array_filter($mainAddValues), array_filter($_SESSION[$cCode]['main_add_values']));
        }

        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            //            cekbiru("hendak memeriksa relative impacts");
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                //                cekbiru("memeriksa $eName:");
                if (array_key_exists($eName, $relElementConfigs)) {
                    //                    cekhijau("$eName memiliki relative impacts");
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //                        cekhijau("memenuhi syarat");
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            //                            cekmerah("memeriksa $eName, $currentValue");
                            //                            $rcCtr = 0;
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                //                                $elKey = $eName . "_" . $currentValue . "_" . $rcID;
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                                //                                $rcCtr++;
                            }
                        }
                    }
                    else {
                        //                        cekmerah("TIDAK memenuhi syarat");
                    }
                }
            }
        }

        //==ini dua benda ini dibikin ulang di sini karena nantinya harus selalu refresh tanpa memanggil PrePreview lagi
        $trA = new MdlTransaksi();
        $extSteps = $trA->lookupExtSteps($masterID);
        $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");

        $_SESSION[$cCode]['extSteps'] = $extSteps;
        $_SESSION[$cCode]['paySrcs'] = $paySrcs;

        //create followup buttons for relative inputs
        //region buttons for relative inputs
        $extBtns = array();
        $extNewBtns = array();
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        if (isset($_SESSION[$cCode]['extSteps']) && sizeof($_SESSION[$cCode]['extSteps']) > 0) {
            foreach ($_SESSION[$cCode]['extSteps'] as $xSpec) {
                if (in_array($xSpec['groupID'], $mems)) {
                    $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'review " . $xSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/previewValue/" . $this->jenisTr . "/$masterID/" . $xSpec['id'] . "/" . $this->uri->segment(5) . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                    $extBtns[$xSpec['key']] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> review " . $xSpec['label'] . "</a>";
                }
                else {
                    $extBtns[$xSpec['key']] = "<a class='btn btn-default text-muted'><i>unreviewable " . $xSpec['label'] . "</i></a>";
                }
            }
        }
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                if (array_key_exists($eName, $relOptionConfigs)) {
                    //                    cekhijau("$eName terdaftar pada relInputs");
                    if (isset($relOptionConfigs[$eName][$currentValue]) && sizeof($relOptionConfigs[$eName][$currentValue]) > 0) {
                        foreach ($relOptionConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                            if (isset($oValSpec['addPoints']) && in_array($targetStepNum, $oValSpec['addPoints'])) {
                                if (in_array($oValSpec['auth']['groupID'], $mems)) {
                                    $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'add " . $oValSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/addValue/" . $this->jenisTr . "/$masterID/" . "0" . "/" . $this->uri->segment(5) . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                                    $extNewBtns[$oValueName] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> add " . $oValSpec['label'] . "</a>";
                                }
                                else {
                                    //                                    cekmerah("you are not allowed");
                                }
                            }
                            else {
                                //                                cekhijau("$oValueName TIDAK memenuhi syarat");
                            }
                        }
                    }
                }
            }
        }
        //endregion

        //create followup buttons for paymentSrc-related
        //region buttons for paymentSrc-related
        $payBtns = array();
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        if (isset($_SESSION[$cCode]['paySrcs']) && sizeof($_SESSION[$cCode]['paySrcs']) > 0) {
            foreach ($_SESSION[$cCode]['paySrcs'] as $xSpec) {
                if ($xSpec['sisa'] > 0) {

                    //                arrprint($xSpec);
                    $xSpec['groupID'] = $this->config->item("heTransaksi_ui")[$xSpec['targetJenis']]['steps'][1]['userGroup'];
                    if (in_array($xSpec['groupID'], $mems)) {
                        $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'do " . $xSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/selectPaymentSrc/" . $xSpec['targetJenis'] . "/" . $xSpec['extID'] . "/$masterID?rawPrev=$rawPrevURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                        //                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> do " . $xSpec['label'] . "</a>";
                    }
                    else {
                        //                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-default text-muted'><i>" . $xSpec['label'] . "</i></a>";
                    }
                }
            }
        }
        //endregion

        //region additional row
        $selectedService = isset($_SESSION[$cCode]['main']['shippingService']) ? $_SESSION[$cCode]['main']['shippingService'] : "";

        $allowEditRowa = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["additionalRows"]["shippingService"][$selectedService]["shipping_service"]['editPoints']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["additionalRows"]["shippingService"][$selectedService]["shipping_service"]['editPoints'] : array();
        $addRows = array();
        $addRowLabels = array();
        if (in_array($targetStepNum, $allowEditRowa)) {
            if (sizeof($elementConfigs) > 0) {
                foreach ($elementConfigs as $eName => $eSpec) {
                    //reset dulu kalau yg tidak ada
                    if (array_key_exists($eName, $relElementConfigs)) {
                        //                    cekkuning("$eName ada dalam elementConfig, reset dulu adik2nya<br>");
                        switch ($eSpec['elementType']) {
                            case "dataModel":
                                $currentValue = $eSpec['key'];
                                break;
                            case "dataField":
                                $currentValue = $eSpec['value'];
                                break;
                        }
                        if (sizeof($relElementConfigs[$eName]) > 0) {
                            foreach ($relElementConfigs[$eName] as $valID => $valSpec) {

                                //                            cekkuning("chek if i should reset $valID..");

                                if ($currentValue == $valID) {
                                    //                                cekkuning("i wont reset $valID..");
                                }
                                else {


                                }
                            }

                        }
                        //					$currentValue = "";

                        if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                            //                        echo("-- $currentValue ada dalam elementConfig $eName<br>");
                            //===daftarkan ke elementConfig
                            if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                                //                            echo("---- memeriksa $eName, $currentValue<br>");
                                //                            $rcCtr=0;
                                foreach ($relElementConfigs[$eName][$currentValue] as $rKey => $rcSpec) {
                                    //                                $elKey = $eName . "_" . $currentValue . "_" . $rKey;
                                    $elKey = $rKey;
                                    $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rKey];
                                    //                                echo "elKey: $elKey";
                                    //                                $rcCtr++;


                                }
                            }
                            else {
                                //                            echo("---- TIDAK PERLU memeriksa $eName, $currentValue<br>");
                            }

                        }
                        else {
                            //                        echo("-- $currentValue TIDAK ada dalam elementConfig $eName<br>");
                        }
                    }
                    else {
                        //                    echo("$eName TIDAK ada dalam elementConfig<br>");
                    }
                    if (array_key_exists($eName, $addRowsConfigs)) {
                        switch ($elementConfigs[$eName]['elementType']) {
                            case "dataModel":
                                $currentValue = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : "";
                                break;
                            case "dataField":
                                $currentValue = $_SESSION[$cCode]['main_elements'][$eName]['value'];
                                break;
                        }
                        //                    cekhijau("currentValue: $currentValue");
                        if (isset($addRowsConfigs[$eName][$currentValue])) {
                            //                        cekmerah("aturan untuk $currentValue ada");
                            if (sizeof($addRowsConfigs[$eName][$currentValue]) > 0) {

                                foreach ($addRowsConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                    //                                cekhijau($oValueName);
                                    //                                arrprint($oValSpec);
                                    if (isset($oValSpec['editPoints']) && in_array($targetStepNum, $oValSpec['editPoints'])) {

                                        //                                        $relInputTarget = "'" . base_url() . get_class($this) . "/recordAddRow/" . $this->jenisTr . "/$oValueName/?val='+this.value+'&ravPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'";
                                        $relInputTarget = "'" . base_url() . "_shoppingCart/recordAddRow/" . $this->jenisTr . "/$oValueName/?val='+this.value+'&ravPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'";


                                        //==init value and params
                                        //region default value
                                        if (isset($oValSpec['defaultValue'])) {
                                            $origDefValue = makeValue($oValSpec['defaultValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                        }
                                        //endregion

                                        //                                    cekmerah("$oValueName = ".$origDefValue);


                                        //region max-value
                                        $maxValue = $origDefValue;
                                        if (isset($oValSpec['maxValue'])) {
                                            $maxValue = makeValue($oValSpec['maxValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);

                                        }
                                        else {
                                            $maxValue = "";
                                        }

                                        //endregion


                                        //region min-value
                                        $minValue = $origDefValue;
                                        if (isset($oValSpec['minValue'])) {
                                            $minValue = makeValue($oValSpec['minValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                        }
                                        else {
                                            $minValue = "";
                                        }
                                        //endregion

                                        $minValStr = $minValue != "" ? "min='$minValue'" : "";
                                        $maxValStr = $maxValue != "" ? "max='$maxValue'" : "";

                                        //region inisiasi keystroke
                                        $keyupAct = "";
                                        if (isset($oValSpec['keyupAction']) && strlen($oValSpec['keyupAction']) > 0) {
                                            $keyupAct = $oValSpec['keyupAction'];
                                        }

                                        $keyupStr = "";
                                        if ($maxValue != "") {
                                            $keyupStr .= "if(parseInt(this.value)>$maxValue){this.value='$origDefValue';this.select();} ";
                                        }
                                        $keyupStr .= $keyupAct;


                                        $disabled = "";
                                        if (isset($oValSpec['disabled'])) {
                                            $disabled = $oValSpec['disabled'];
                                        }


                                        $blurStr = "";
                                        if ($minValue != "") {
                                            $blurStr = "if(this.value!=this.defaultValue){if(parseInt(this.value)>=$minValue){hiliteDiv(this);top.$('#result').load($relInputTarget);}else{this.value='$minValue';this.focus();}}";
                                        }
                                        else {
                                            $blurStr = "if(this.value!=this.defaultValue){hiliteDiv(this);top.$('#result').load($relInputTarget);}";

                                        }
                                        //endregion

                                        $defVal = isset($_SESSION[$cCode]['main'][$oValueName]) && $_SESSION[$cCode]['main'][$oValueName] > 0 ? ($_SESSION[$cCode]['main'][$oValueName] + 0) : $origDefValue;
                                        if (isset($addRowsConfigs[$eName][$currentValue][$oValueName]['role']) && $addRowsConfigs[$eName][$currentValue][$oValueName]['role'] == "minus") {
                                            $defVal = "(" . $defVal . ")";
                                        }
                                        //                                    $defVal = $origDefValue;
                                        $addRows[$oValueName] = "<input type=text autocomplete='off' id='$oValueName' class='form-control text-right' style='font-size:17px;' $disabled placeholder='$oValueName' value='$defVal' $minValStr $maxValStr
onfocusssss='this.select()' onkeyup=\"$keyupStr\" onfocus=\"$keyupStr\"
onblur=\"$blurStr\"
onmouseout=\"$blurStr\"
>";
                                        $_SESSION[$cCode]['add_rows'][$oValueName] = $defVal;
                                        $addRowLabels[$oValueName] = $oValSpec['label'];

                                    }

                                }

                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                            //                        cekmerah("aturan untuk $currentValue TIDAK ada");
                        }

                    }
                    else {
                        //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                    }
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $addStr = "";
                            $editStr = "";
                            $amdlName = $eSpec['mdlName'];
                            $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();

                            $elStr[$eName] = "";
                            $this->load->model("Mdls/" . $amdlName);
                            $labelSrc = $eSpec['labelSrc'];
                            $keySrc = $eSpec['key'];
                            $oo = new $amdlName();
                            $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $amdlName);

                            if (sizeof($aFilter) > 0) {
                                foreach ($aFilter as $filter) {
                                    $exFilter = explode("=", $filter);
                                    if (sizeof($exFilter) > 1) {
                                        if (substr($exFilter[1], 0, 1) == ".") {
                                            //                                        $oo->addFilter($exFilter[0] . "='" . ltrim($exFilter[1], ".") . "'");
                                        }
                                        else {
                                            if (isset($_SESSION[$cCode]['main'][$exFilter[1]])) {
                                                //                                            $oo->addFilter($exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'");
                                                $addLink .= "?reqField=" . $exFilter[0] . "&reqVal=" . $_SESSION[$cCode]['main'][$exFilter[1]];
                                            }
                                            else {
                                                //                                            $oo->addFilter($exFilter[0] . "='none'");
                                            }
                                        }
                                    }
                                }
                                $oo = makeFilter($aFilter, $_SESSION[$cCode]['main'], $oo);
                            }

                            $addClick = "";
                            $dataAccess = isset($this->config->item('heDataBehaviour')[$amdlName]) ? $this->config->item('heDataBehaviour')[$amdlName] : array(
                                "viewers" => array(),
                                "creators" => array(),
                                "creatorAdmins" => array(),
                                "updaters" => array(),
                                "updaterAdmins" => array(),
                                "deleters" => array(),
                                "deleterAdmins" => array(),
                                "historyViewers" => array(),
                            );
                            $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
                            if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
                                if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                                    $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        type:top.BootstrapDialog.TYPE_SUCCESS,
                                        }
                                        );";
                                    $addStr = "<a href='javascript:void(0)' class='btn btn-tool' onclick=\"$addClick\"><span class='glyphicon glyphicon-plus'></span></a>";
                                }
                            }

                            //                        cekmerah("pre..");
                            $tmpo = $oo->lookupAll()->result();
                            //                        cekmerah(__LINE__. " " .$this->db->last_query());
                            $elPair[$amdlName] = array();
                            $selectorTarget = "'" . base_url() . get_class($this) . "/fetchElement/" . $this->jenisTr . "/$eName/$amdlName/?key='+this.value";

                            $elStr[$eName] .= "<div class='box-body'>";

                            switch ($eSpec['inputType']) {
                                case "combo":
                                    $elStr[$eName] .= "<select class='form-control' onchange=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">";
                                    $elStr[$eName] .= "<option value=''>-select-</option>";
                                    if (sizeof($tmpo) > 0) {
                                        foreach ($tmpo as $row) {

                                            $ex = explode("/", $elementConfigs[$eName]['labelSrc']);
                                            if (sizeof($ex) > 1) {
                                                $labelValue = "";
                                                foreach ($ex as $col) {

                                                    $labelValue .= $row->$col . " / ";
                                                }
                                                $labelValue = rtrim($labelValue, " / ");
                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";

                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $labelValue . "</option>";
                                                //                                            $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $$labelValue . "</option>";

                                            }
                                            else {
                                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $row->$labelSrc . "</option>";
                                            }


                                        }
                                    }
                                    $elStr[$eName] .= "</select>";
                                    break;
                                case "radio":

                                    if (sizeof($tmpo) > 0) {
                                        foreach ($tmpo as $row) {
                                            $ex = explode("/", $elementConfigs[$eName]['labelSrc']);
                                            if (sizeof($ex) > 1) {
                                                $labelValue = "";
                                                foreach ($ex as $col) {

                                                    $labelValue .= $row->$col . " / ";
                                                }
                                                $labelValue = rtrim($labelValue, " / ");
                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";
                                                $elStr[$eName] .= "<label class='badge' style='padding:4px 6px 4px 6px;color:#454545;background:#e0e0e0;'><input type='radio' name='$eName' value='" . $row->$keySrc . "' $selected onclick=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">" . $labelValue . "</label>&nbsp;";
                                            }
                                            else {
                                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";
                                                $elStr[$eName] .= "<label class='badge' style='padding:4px 6px 4px 6px;color:#454545;background:#e0e0e0;'><input type='radio' name='$eName' value='" . $row->$keySrc . "' $selected onclick=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">" . $row->$labelSrc . "</label>&nbsp;";
                                            }

                                        }
                                    }
                                    break;
                            }


                            $elStr[$eName] .= "</div class='box-header'>";

                            $defKey = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : 0;
                            $defValue = "";
                            if (isset($_SESSION[$cCode]['main_elements'][$eName]['key']) && $_SESSION[$cCode]['main_elements'][$eName]['contents']) {
                                if (isset($elementConfigs[$eName]['usedFields']) && sizeof($elementConfigs[$eName]['usedFields']) > 0) {
                                    //								$defValue .= "<table class='table table-condensed no-padding' style='padding:0px;margin:0px;'>";
                                    $defValue .= "<div class='panel-body'>";
                                    $defValue .= "<table cellspacing='0' cellpadding='0' border='0'>";
                                    $contents[$eName] = unserialize(base64_decode($_SESSION[$cCode]['main_elements'][$eName]['contents']));
                                    foreach ($elementConfigs[$eName]['usedFields'] as $src => $label) {
                                        $fieldLabel = isset($contents[$eName][$src]) ? $contents[$eName][$src] : "-";
                                        //                                    if(is_numeric($fieldLabel)){
                                        //                                        $fieldLabel=number_format($fieldLabel);
                                        //                                    }
                                        $defValue .= "<tr>";
                                        $defValue .= "<td align='left'>$label";
                                        $defValue .= "&nbsp;</td>";
                                        $defValue .= "<td align='left'>:&nbsp;" . $fieldLabel;
                                        $defValue .= "</td>";
                                        $defValue .= "</tr>";
                                    }
                                    $defValue .= "</table>";
                                    $defValue .= "</div class='panel-body'>";
                                }
                            }
                            else {//menentukan nilai default

                            }

                            if ($defKey > 0) {
                                if (sizeof($mems) > 0 && sizeof($dataAccess['updaters']) > 0) {
                                    $editLink = base_url() . "Data/edit/" . str_replace("Mdl", "", $amdlName) . "/$defKey";
                                    if (sizeof(array_intersect($mems, $dataAccess['updaters'])) > 0) {
                                        $editClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $editLink . "'),
                                        draggable:true,
                                        size:BootstrapDialog.SIZE_WIDE,
                                        closable:true,
                                        type:top.BootstrapDialog.TYPE_SUCCESS,
                                        }
                                        );";

                                        $editStr = "<a href='javascript:void(0)' class='btn btn-tool' onclick=\"$editClick\"><span class='glyphicon glyphicon-pencil'></span></a>";
                                    }
                                }
                            }

                            $elStr[$eName] .= "<div id='divel_$eName' style='padding:2px;font-size:smaller;'>$defValue";
                            $elStr[$eName] .= "</div id='el$amdlName'>";

                            $elements[$eName] = array(
                                "mdlName" => $eSpec['mdlName'],
                                "label" => $eSpec['label'],
                                "string" => $elStr[$eName],
                                "editStr" => $editStr,
                                "addStr" => $addStr,
                                "bgColor" => $defValue == "" ? "#fcfce0" : "#f5fff9",
                            );


                            break;
                        case "dataField":
                            $elStr[$eName] = "";
                            $initValue = isset($eSpec['defaultValue']) ? $eSpec['defaultValue'] : "";
                            //                        $defaultValue = isset($_SESSION[$cCode]['main_elements'][$eName]['value']) ? $_SESSION[$cCode]['main_elements'][$eName]['value'] : "";
                            $defaultValue = isset($_SESSION[$cCode]['main'][$eName]) ? $_SESSION[$cCode]['main'][$eName] : 0;
                            $selectorTarget = "'" . base_url() . get_class($this) . "/recordFieldElement/" . $this->jenisTr . "/$eName/$amdlName/?val='+this.value";
                            //                        $elStr[$eName] .="<div class='box'>";

                            $maxValue = isset($eSpec['maxValue']) && isset($_SESSION[$cCode]['main'][$eSpec['maxValue']]) ? $_SESSION[$cCode]['main'][$eSpec['maxValue']] : "";

                            $elStr[$eName] .= "<div class='box-body'>";
                            switch ($eSpec['inputType']) {
                                case "text":
                                    $elStr[$eName] .= "<input type=text class='form-control' value='$defaultValue' onfocus='this.select()' oonclick=\"this.value='$defaultValue';\"
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                                case "number":
                                    $maxValStr = $maxValue != "" ? " max='" . $maxValue . "''" : "";
                                    $maxValValidator = $maxValue != "" ? " onkeyup=\"if(this.value>$maxValue){this.value='$maxValue';}\" " : "";
                                    $elStr[$eName] .= "<input type=number class='form-control' value='$defaultValue' onfocus='this.select()' $maxValStr $maxValValidator oonclick=\"this.value='$defaultValue';\"
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                                case "date":
                                    $elStr[$eName] .= "<input type=date class='form-control' value='$defaultValue' onfocus='this.select()' oonclick=\"this.value='$defaultValue';\"
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                            }
                            $elStr[$eName] .= "</div class='box-body'>";

                            $elements[$eName] = array(
                                "mdlName" => null,
                                "label" => $eSpec['label'],
                                "string" => $elStr[$eName],
                                "editStr" => "",
                                "addStr" => "",
                                "bgColor" => $defaultValue == "" ? "#fcfce0" : "#fcfcff",
                            );
                            break;
                    }
                }
            }
        }

        //endregion


        $detilSizeBar = array();
        $measureConf = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartMeasurement'][$targetStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartMeasurement'][$targetStepNum] : false;

        if ($measureConf) {
            if (isset($elements['detilSize'])) {
                $detilSizeBar = array(
                    "volume_gross" => isset($main['volume_gross']) ? number_format(conv_mmc_mc($main['volume_gross']), 2) : 0,
                    "berat_gross" => isset($main['berat_gross']) ? conv_g_kg($main['berat_gross']) : 0,
                );
            }
        }


        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$targetStepNum] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }

        //        $rejectionSpec = array(
        //            "label" => "cannot reject",
        //            "targetUrl" => "",
        //            "warning" => "",
        //        );
        //        $deleteSpec = array(
        //            "label" => "cannot delete",
        //            "targetUrl" => "",
        //            "warning" => "",
        //        );

        $pairedItemTarget = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName'] : "items2";
        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            //            "mainValues"        => $mainValues,
            "mainValues" => $_SESSION[$cCode]['main'],
            //            "detailValues"      => $detailValues,
            "detailValues" => $_SESSION[$cCode]['tableIn_detail_values'],
            //            "itemLabels" => $itemLabels,
            "itemLabels" => $itemLabels,
            "itemLabels2" => $itemLabels2,
            "noteEnabled" => $noteEnabled,
            "noteEditabled" => $noteEditabled,
            "noteType" => $noteType,
            "imageEnabled" => $imageEnabled,
            "imageType" => $imageType,
            "detilSizeBar" => $detilSizeBar,

            //            "itemLabels2" => array
            //            (
            //                "produk_nama" => "item name",
            //                "produk_ord_jml" => "qty",
            //                "satuan" => "satuan",
            //
            //            ),
            "items" => $_SESSION[$cCode]['items'],
            //            "items2"                => $_SESSION[$cCode]['items2_sum'],
            "items2" => isset($_SESSION[$cCode][$pairedItemTarget]) ? $_SESSION[$cCode][$pairedItemTarget] : array(),
            //            "items2" => $_SESSION[$cCode]['items2'],
            "buttonLabel" => $buttonLabel,
            "saveWarning" => $saveWarning,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$targetStepNum],
            "sumRows" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][$targetStepNum] : $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$targetStepNum],
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "extEditableFields" => $editableAddVals,
            //            "mainAddValues" => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
            //            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            "mainAddValues" => $mainAddValues,
            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            //            "mainApplets"       => $mainApplets,
            //            "editableApplets"   => $editableApplets,
            "mainElements" => $_SESSION[$cCode]['main_elements'],
            "elements" => $elements,
            "editableElements" => $editableElements,
            "elementConfig" => $elementConfigs,
            "mainInputs" => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
            "elementEditTarget" => base_url() . "_followupLiveEdit/selectElement/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            //            "actionTarget" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$targetStepNum",
            "actionTarget" => base_url() . $this->uri->segment(1) . "/doCancelPacking/$no/$targetStepNum/$currentStepNum",
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "grandTotal" => isset($_SESSION[$cCode]['main']['grand_total']) ? $_SESSION[$cCode]['main']['grand_total'] : 0,
            //            "description" => isset($main['description']) ? $main['description'] : "",
            "description" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            //            "revertLabel"           => $revertLabel,
            //            "revertTarget"          => $revertTarget,
            //            "acceptLabel"           => $acceptLabel,
            //            "acceptTarget"          => $acceptTarget,
            //            "rejectionLabel"        => $rejectionLabel,
            //            "rejectionTarget"       => $rejectionTarget,
            "allowEdit" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowEdit'] : false,
            "allowCancel" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowCancel'] : false,
            "allowIncrement" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowIncrement']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$targetStepNum]['allowIncrement'] : false,
            "editableFields" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$targetStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$targetStepNum] : array(),
            "stepLabels" => $stepLabels,
            "rawPrevURL" => $rawPrevURL,
            "rawBuilderURL" => $rawBuilderURL,
            "currentStep" => $targetStepNum,
            "extSteps" => isset($_SESSION[$cCode]['extSteps']) ? $_SESSION[$cCode]['extSteps'] : array(),
            "paySrcs" => isset($_SESSION[$cCode]['paySrcs']) ? $_SESSION[$cCode]['paySrcs'] : array(),
            "extBtns" => $extBtns,
            "extNewBtns" => $extNewBtns,
            "payBtns" => $payBtns,
            "xShipmentBtn" => $xShipmentBtn,
            //==================liveEdit========================
            "followupSegments" => array(
                $this->uri->segment(3),
                $this->uri->segment(4),
                $this->uri->segment(5),
            ),
            "removeItemTarget" => base_url() . "_followupLiveEdit/removeItem/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateItemFieldTarget" => base_url() . "_followupLiveEdit/updateItemField/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateMainFieldTarget" => base_url() . "_followupLiveEdit/updateMainField/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "clearContentTarget" => base_url() . get_class($this) . "/clearContent/" . $this->jenisTr,
            "msgWarning" => isset($msgWarning) ? $msgWarning : array(),

            "msgWarning2" => isset($msgWarning2) ? $msgWarning2 : array(),
            //
            "addRows" => $addRows,
            "addRowLabels" => $addRowLabels,
            "deleteSpec" => $deleteSpec,
            "undoSpec" => $undoSpec,
            "rejectionSpec" => $rejectionSpec,
            "approvalSpec" => $approvalSpec,
            "editSpec" => $editSpec,

        );


        if (isset($_SESSION[$cCode]['main'])) {
            $data['pihakID'] = isset($_SESSION[$cCode]['main']['pihakID']) ? $_SESSION[$cCode]['main']['pihakID'] : 0;
            $data['pihakName'] = isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : "";
        }
        //endregion


        $this->load->view("transaksi", $data);

    }

    //do pre cancel packing
    public function doPreCancelPacking()
    {
        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $inputLabels = array();
        $inputAuthConfigs = array();

        $this->load->library("FieldCalculator");
        $cal = new FieldCalculator();

        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
        $prevUrl = blobDecode($rawPrevURL);

        if (isset($_SESSION[$cCode])) {

            if (!isset($_SESSION[$cCode]['items'])) {
                die("belum ada item yang dipilih");
            }
            else {
                if (sizeof($_SESSION[$cCode]['items']) < 1) {
                    die("belum ada item yang dipilih");
                }
            }
            echo("now processing your transaction..<br>");

            //region build table rekening
            $buildTablesMaster = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master'] : array();
            $buildTablesDetail = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail'] : array();
            $addMasterTables = array(
                "rugilaba",
                "laba ditahan",
                "rugilaba lain lain",
            );
            foreach ($addMasterTables as $trek) {
                $buildTablesMaster[] = array(
                    "comName" => "RugiLaba",
                    "loop" => array(
                        "$trek" => .0,
                    ),
                );
            }
            if (sizeof($buildTablesMaster) > 0) {
                //                arrprint($buildTablesMaster);
                $bCtr = 0;
                foreach ($buildTablesMaster as $buildTablesMaster_specs) {
                    //                    arrprint($buildTablesMaster_specs);
                    $bCtr++;
                    $mdlName = $buildTablesMaster_specs['comName'];
                    if (substr($mdlName, 0, 1) == "{") {
                        //                        cekkuning("mengandung kurawal");
                        $mdlName = trim($mdlName, "{");
                        $mdlName = trim($mdlName, "}");
                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                    }
                    else {
                        //                        cekkuning("TIDAK mengandung kurawal");
                    }
                    $mdlName = "Com" . $mdlName;
                    //                    cekHitam("# $bCtr - model: $mdlName");
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();


                    if (isset($buildTablesMaster_specs['loop']) && sizeof($buildTablesMaster_specs['loop']) > 0) {
                        foreach ($buildTablesMaster_specs['loop'] as $key => $val) {
                            if (substr($key, 0, 1) == "{") {
                                $oldParam = $buildTablesMaster_specs['loop'][$key];
                                unset($buildTablesMaster_specs['loop'][$key]);
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                $buildTablesMaster_specs['loop'][$key] = $oldParam;
                            }
                        }
                    }


                    if (method_exists($m, "getTableNameMaster")) {
                        if (sizeof($m->getTableNameMaster())) {
                            $m->buildTables($buildTablesMaster_specs);
                        }
                    }
                }
            }
            if (sizeof($buildTablesDetail) > 0) {
                foreach ($buildTablesDetail as $buildTablesDetail_specs) {
                    foreach ($_SESSION[$cCode]['items'] as $itemSpec) {

                        $mdlName = $buildTablesDetail_specs['comName'];
                        if (substr($mdlName, 0, 1) == "{") {
                            $mdlName = trim($mdlName, "{");
                            $mdlName = trim($mdlName, "}");
                            $mdlName = str_replace($mdlName, $itemSpec[$mdlName], $mdlName);
                            //                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                        }
                        $mdlName = "Com" . $mdlName;
                        cekbiru("model: $mdlName");
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();

                        if (isset($buildTablesDetail_specs['loop']) && sizeof($buildTablesDetail_specs['loop']) > 0) {
                            foreach ($buildTablesDetail_specs['loop'] as $key => $val) {
                                if (substr($key, 0, 1) == "{") {
                                    $oldParam = $buildTablesDetail_specs['loop'][$key];
                                    unset($buildTablesDetail_specs['loop'][$key]);
                                    $key = trim($key, "{");
                                    $key = trim($key, "}");
                                    $key = str_replace($key, $itemSpec[$key], $key);
                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                    $buildTablesDetail_specs['loop'][$key] = $oldParam;
                                }
                            }
                        }
                        if (method_exists($m, "getTableNameMaster")) {
                            if (sizeof($m->getTableNameMaster())) {
                                $m->buildTables($buildTablesDetail_specs);
                            }
                        }
                    }
                }
            }
            //endregion

            $this->db->trans_start();

            //region pre-processors (master)
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['master'])) {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['master'] : array();
                $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();
                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                $subParams['static'][$key] = $realValue;

                            }

                            if (!isset($subParams['static']["transaksi_id"])) {
                                //									$subParams['static']["transaksi_id"] = $masterID;
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);


                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            cekbiru("gotparams dari pre-proc $comName");
                            arrprint($gotParams);

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    //										$id=$gSpec['id'];
                                    if (isset($_SESSION[$cCode]['main'])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $_SESSION[$cCode]['main'][$key] = $val;
                                            }
                                        }
                                    }
                                    //==inject gotParams to child gate
                                    if (isset($_SESSION[$cCode]['main'])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $_SESSION[$cCode]['main'][$key] = $val;
                                            }
                                        }
                                    }
                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($_SESSION[$cCode]['main'][$key])) {
                                                $_SESSION[$cCode]['main']['sub_' . $key] = ($_SESSION[$cCode]['main']['jml'] * $_SESSION[$cCode]['main'][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
                fillValues($this->jenisTr, 1, 1);
            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion

            //region pre-processors (item)
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail'])) {
                //                $procList = $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1];

                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail'] : array();
                $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();
                echo "ITEM NUM LABELS";

                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        echo "sub-preproc: $comName, initializing values <br>";

                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();

                            //                            $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (!isset($subParams['static']["transaksi_id"])) {
                                    //									$subParams['static']["transaksi_id"] = $masterID;
                                }


                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                            }
                            cekLime(":: cetak preprocc... $comName :: $srcGateName ::");
                            arrPrint($subParams);
                            //mati_disini();
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;


                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                //                                echo "sub preproc #$it: $comName, sending values <br>";

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);


                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();

                                    cekmerah("gotparams dari pre-proc $comName");
                                    arrprint($gotParams);


                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor

                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($_SESSION[$cCode][$gateName])) {
                                                $_SESSION[$cCode][$gateName] = array();
                                                //                                    cekhijau("building the session: $gateName");
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }

                                            foreach ($paramSpec as $id => $gSpec) {
                                                //										$id=$gSpec['id'];


                                                if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                    $_SESSION[$cCode][$gateName][$id] = array();
                                                }


                                                if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val");
                                                            $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                cekHitam("srcGateName = $srcGateName :: " . __LINE__);
                                                if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }

                                                //cekMerah("REBUILDING VALUES..");
                                                if (sizeof($itemNumLabels) > 0) {
                                                    //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        //cekHere("$id === $key => $label");
                                                        if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                            $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                        }
                                                        //                                        die();
                                                    }
                                                }
                                            }
                                            //                                    arrPrint($items);die();
                                        }


                                    }

                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }


                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }


                $this->load->helper("he_value_builder");
                fillValues($this->jenisTr, 1, 1);


            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion

            $this->midValidate();
            $this->unionValidate();
            //===finalisasi sebelum masuk tabel beneran
            //===isinya ada pembentukan nomor nota dll

            //region penomoran receipt
            //<editor-fold desc="==========penomoran">
            $this->load->model("CustomCounter");
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");

            $counterForNumber = array($this->config->item('heTransaksi_core')[$this->jenisTr]['formatNota']);
            if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$this->jenisTr]['counters'])) {
                die(__LINE__ . " Used number should be registered in 'counters' config as well");
            }
            echo "<div style='background:#ff7766;'>";
            foreach ($counterForNumber as $i => $cRawParams) {
                $cParams = explode("|", $cRawParams);
                $cValues = array();
                foreach ($cParams as $param) {
                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                }
                $cRawValues = implode("|", $cValues[$i]);
                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

            }
            echo "</div style='background:#ff7766;'>";

            $stepNumber = 1;

            $tmpNomorNota = $paramSpec['paramString'];


            if (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2])) {
                $nextProp = array(
                    "num" => 2,
                    "code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['target'],
                    "label" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['label'],
                    "groupID" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['userGroup'],
                );
            }
            else {
                $nextProp = array(
                    "num" => 0,
                    "code" => "",
                    "label" => "",
                    "groupID" => "",
                );
            }

            //</editor-fold>
            //endregion

            //region dynamic counters
            // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
            $cn = new CustomCounter("transaksi");
            $cn->setType("transaksi");
            $configCustomParams = $this->config->item('heTransaksi_core')[$this->jenisTr]['counters'];
            $configCustomParams[] = "stepCode";
            //arrPrint($configCustomParams);
            if (sizeof($configCustomParams) > 0) {
                $cContent = array();
                foreach ($configCustomParams as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                    switch ($paramSpec['id']) {
                        case 0: //===counter type is new
                            $paramKeyRaw = print_r($cParams, true);
                            $paramValuesRaw = print_r($cValues[$i], true);
                            $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                            break;
                        default: //===counter to be updated
                            $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                            break;
                    }
                    //echo "<hr>";
                }
            }
            $appliedCounters = base64_encode(serialize($cContent));
            $appliedCounters_inText = print_r($cContent, true);
            //mati_disini();

            //
            //region addition on master


            $addValues = array(
                'counters' => $appliedCounters,
                'counters_intext' => $appliedCounters_inText,
                'nomer' => $tmpNomorNota,
                'dtime' => date("Y-m-d H:i:s"),
                'fulldate' => date("Y-m-d"),
                "step_avail" => sizeof($this->config->item('heTransaksi_ui')[$this->jenisTr]['steps']),
                "step_number" => 1,
                "step_current" => 1,
                "next_step_num" => $nextProp['num'],
                "next_step_code" => $nextProp['code'],
                "next_step_label" => $nextProp['label'],
                "next_group_code" => $nextProp['groupID'],
                "tail_number" => 1,
                "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['target'],
            );

            foreach ($addValues as $key => $val) {
                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
            }
            //endregion

            //
            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']),
                "next_substep_num" => $nextProp['num'],
                "next_substep_code" => $nextProp['code'],
                "next_substep_label" => $nextProp['label'],
                "next_subgroup_code" => $nextProp['groupID'],
                "sub_tail_number" => 1,
                "sub_tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['target'],


            );
            foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
                }
            }
            //endregion
            // </editor-fold>
            //endregion
            $mongoList = array();
            $mongUpdateList = array();
            //region ----------write transaksi, transaksi_data, main_fields, main_values, main_applets, etc
            if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

                $cps_id = $_SESSION[$cCode]['mode']['cancel'];

                $_SESSION[$cCode]['tableIn_master']['status_4'] = 11;
                $_SESSION[$cCode]['tableIn_master']['trash_4'] = 0;
                $_SESSION[$cCode]['tableIn_master']['cancel_packing_source_id'] = $cps_id;

                $udt = new MdlTransaksi();
                $udt->addFilter("transaksi_id=" . $_SESSION[$cCode]['mode']['cancel'] . "");
                $udTr = $udt->lookupJoined()->result();

                //                arrPrint($udTr);
                $nomer_top_replacer = 0;
                if (sizeof($udTr) > 0) {
                    //                    arrPrint($udTr[0]->ids_his);
                    $_SESSION[$cCode]['tableIn_master']['nomer2'] = $udTr[0]->nomer;
                    $nomer_top_replacer = showHistoriGlobalNumbers($udTr[0]->ids_his, 2, true);
                }
                //cekBiru($nomer_top_replacer);
                $tr = new MdlTransaksi();
                $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                $mongoList['main'] = array($insertID, $epID);
                $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                $_SESSION[$cCode]['main']['nomer2'] = $nomer_top_replacer;
                if ($insertID < 1) {
                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                }
                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $insertID,
                    "nomer" => $tmpNomorNota,
                    "nomer2" => $nomer_top_replacer,
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($_SESSION[$cCode][$target])) {
                            foreach ($_SESSION[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec['id']) && $iSpec['id'] > 0 ? $iSpec['id'] : $xid;
                                if (isset($_SESSION[$cCode][$target][$id])) {
                                    $_SESSION[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }

                //===signature
                $dwsign = $tr->writeSignature($insertID, array(
                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                    "step_number" => 1,
                    "step_code" => $this->jenisTr,
                    "step_name" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['label'],
                    "group_code" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['userGroup'],
                    "oleh_id" => $this->session->login['id'],
                    "oleh_nama" => $this->session->login['nama'],
                    "keterangan" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'],
                    "transaksi_id" => $insertID,
                )) or die("Failed to write signature");
                $mongoList['sign'][] = $dwsign;
                $idHis = array(
                    $stepNumber => array(
                        "step" => $stepNumber,
                        "trID" => $insertID,
                        "nomer" => $tmpNomorNota,
                        "counters" => $appliedCounters,
                        "counters_intext" => $appliedCounters_inText,
                    ),
                );
                $idHis_blob = blobEncode($idHis);
                $idHis_intext = print_r($idHis, true);

                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "next_step_num" => $nextProp['num'],
                    "next_step_code" => $nextProp['code'],
                    "next_step_label" => $nextProp['label'],
                    "next_group_code" => $nextProp['groupID'],
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomer2" => $_SESSION[$cCode]['main']['nomer2'],
                    "cancel_packing_source_id" => $_SESSION[$cCode]['mode']['cancel'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,
                )) or die("Failed to update tr next-state!");

                cekHijau(__LINE__ . " " . $this->db->last_query());

                $addValues = array(
                    //===references
                    "id_master" => $insertID,
                    "id_top" => $insertID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomer2" => $_SESSION[$cCode]['main']['nomer2'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,
                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }


                $trCancel = array();
                if (isset($_SESSION[$cCode]['mode']['cancel']) && $_SESSION[$cCode]['mode']['cancel'] > 0) {
                    $udt = new MdlTransaksi();
                    $udt->addFilter("transaksi_id=" . $_SESSION[$cCode]['mode']['cancel'] . "");
                    $udTr = $udt->lookupJoined()->result();
                    if (sizeof($udTr) > 0) {
                        foreach ($udTr as $row) {
                            $trCancel['valid_qty'][$row->produk_id] = $row->valid_qty;
                            $trCancel['cancel_qty'][$row->produk_id] = $row->cancel_qty;
                            $trCancel['req_cancel_qty'][$row->produk_id] = $row->req_cancel_qty;
                        }
                    }
                }

                $cancel = 0;
                $validqty = 0;
                if (isset($_SESSION[$cCode]['tableIn_detail']) && isset($_SESSION[$cCode]['mode']['cancel']) && $_SESSION[$cCode]['mode']['cancel'] > 0) {
                    $trUpd = new MdlTransaksi();
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $pid => $row) {
                        $valid_qty_b4 = $trCancel['valid_qty'][$pid];
                        $cancel_qty_b4 = $trCancel['cancel_qty'][$pid];
                        $req_cancel_qty_b4 = $trCancel['req_cancel_qty'][$pid];

                        $cancel = $row['produk_ord_jml'];
                        $valid_qty_af = (int)$valid_qty_b4 - (int)$cancel;
                        $valid_qty_af < 0 ? mati_disini("Transaksi close/fullfillment gagal disimpan karena jumlah request melebihi jumlah available di nota.") : "";
                        $req_cancel_qty_b4 = (int)$req_cancel_qty_b4 + (int)$cancel;
                        $where = "transaksi_id='" . $_SESSION[$cCode]['mode']['cancel'] . "' AND produk_id='" . $pid . "'";
                        $trUpd->setFilters(array());
                        $trUpd->setTableName("transaksi_data");

                        $dataItems = array(
                            "valid_qty" => $valid_qty_af,
                            "req_cancel_qty" => $req_cancel_qty_b4,
                        );
                        $updateItems = $trUpd->updateData($where, $dataItems) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  updte  params registries"));
                        $mongUpdateList['update']['detail'][] = array(
                            "where" => $where,
                            "value" => $dataItems,
                        );
                        cekHitam($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    }
                }

            }
            if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['mainValues'])) {
                    foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['mainValues'] as $key => $src) {
                        if (isset($_SESSION[$cCode]['tableIn_master_values'][$key])) {

                            $dd = $tr->writeMainValues($insertID, array(
                                "key" => $key,
                                "value" => $_SESSION[$cCode]['tableIn_master_values'][$key],
                            ));
                            $mongoList['mainValues'][] = $dd;
                        }
                    }
                }
            }
            if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $mongoList['mainValues'][] = $dd;
                }
            }
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $mongoList['mainValues'][] = $dd;
                    //                    cekkuning("making a clone for input key $key / $val");
                    //                    $tmpTableIn=$_SESSION[$cCode]['tableIn_master'];
                    //                    $replacers=array(
                    //                        "nomer"=>$_SESSION[$cCode]['tableIn_master']['nomer']."_$key",
                    //                    );
                    //                    foreach($replacers as $key=>$val){
                    //                        $tmpTableIn[$key]=$val;
                    //                    }
                    //                    $subInputInsertID = $tr->writeMainEntries($tmpTableIn);
                }
            }
            if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($_SESSION[$cCode]['main_applets']) && sizeof($_SESSION[$cCode]['main_applets']) > 0) {
                foreach ($_SESSION[$cCode]['main_applets'] as $amdl => $aSpec) {
                    $tr->writeMainApplets($insertID, array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }
            if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec['label'],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));


                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec['value'];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        //					cekhijau("$eName terdaftar pada relInputs");


                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec['label'];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']['groupID'])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']['groupID'];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }

                    }

                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detail'] = $insertIDs;
                    }
                    cekUngu(__LINE__ . " " . $this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detail'] = $insertIDs;
                    }
                    cekUngu(__LINE__ . " " . $this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detail'] = $insertIDs;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detail'][] = $dd;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                    cekUngu(__LINE__ . " " . $this->db->last_query());
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                            if (isset($_SESSION[$cCode]['tableIn_detail'][$pID])) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                                ));
                                $insertIDs[] = $dd;
                                $mongoList['detailValues'][] = $dd;

                            }
                        }
                    }


                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }


                }
            }
            //endregion

            //===components akan langsung dieksekusi jika steps-nya tidak pakai approval
            $steps = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'];

            //region processing sub-components, if in single step
            //<editor-fold desc="----------subcomponents">

            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $filterNeeded = false;

            //region processing sub-components
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();

                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            //                            $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                        cekHitam(":: $comName ::");
                        $mdlName = "Com" . ucfirst($comName);
                        if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                            $filterNeeded = true;
                        }
                        else {
                            $filterNeeded = false;
                        }
                        echo "sub-component: $comName, initializing values <br>";
                        //                        cekHitam(__LINE__);
                        //                        $tmpOutParams[$cCtr] = array();

                        //                        cekhitam("$comName filterneeded: $filterNeeded");
                        //                        cekhitam("mau mengiterasi $srcGateName");
                        //                        cekhitam("telah mengiterasi $srcGateName");
                        //
                        $subParams = array();
                        if (isset($tComSpec['loop'])) {
                            foreach ($tComSpec['loop'] as $key => $value) {
                                cekMerah(":: $key => $value ::");
                                if (substr($key, 0, 1) == "{") {
                                    $key = trim($key, "{");
                                    $key = trim($key, "}");
                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                    $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$id][$key], $key);
                                }

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['loop'][$key] = $realValue;

                                if ($filterNeeded) {
                                    if ($subParams['loop'][$key] == 0) {
                                        unset($subParams['loop'][$key]);
                                    }
                                }
                            }
                        }
                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['static'][$key] = $realValue;

                            }
                            if (!isset($subParams['static']["transaksi_id"])) {
                                $subParams['static']["transaksi_id"] = $insertID;
                            }
                            if (!isset($subParams['static']["transaksi_no"])) {
                                $subParams['static']["transaksi_no"] = $insertNum;
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                        }
                        //arrPrint($subParams);
                        if (sizeof($subParams) > 0) {
                            arrprint($subParams);
                            cekhitam("subparam ada isinya");
                            if ($filterNeeded) {
                                if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                        else {
                            cekhitam("subparam TIDAK ada isinya");
                        }
                    }
                }
                //cekHitam("cetak tmpOutParams");
                //arrPrint($tmpOutParams);
                //cekHitam();
                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {

                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
                            //                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                        }
                    }
                    echo "sub component: $comName, sending values <br>";

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter
                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    if ($tobeExecuted) {
                        cekMerah("$comName dieksekusiii");
                        arrPrint($tmpOutParams[$cCtr]);
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                //cekKuning("subcomponents is not set");
            }
            //endregion
            //die();
            //</editor-fold>
            //endregion

            //region processing main components, if in single step


            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master'] : array();
            if (sizeof($iterator) > 0) {

                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "component # $cCtr: $comName<br>";

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                            }

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                            //                            cekKuning("LOOP $key diisi dengan $realValue");
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;

                    if (in_array($mdlName, $compValidators)) {

                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }

                    }

                    if ($tobeExecuted) {

                        //cekBiru("kiriman komponem $comName");
                        //                        arrPrint($tmpOutParams);
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }


                }
            }
            else {
                //cekKuning("components is not set");
            }


            //endregion

            //region processing sub-post-processors, always
            //<editor-fold desc="----------sub postProc">

            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['detail'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "sub-postProcessor: $comName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();
                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                        $id = $dSpec['id'];
                        $subParams = array();
                        if (isset($tComSpec['loop'])) {
                            foreach ($tComSpec['loop'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['loop'][$key] = $realValue;

                            }
                        }
                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['static'][$key] = $realValue;

                            }
                            if (!isset($subParams['static']["transaksi_id"])) {
                                $subParams['static']["transaksi_id"] = $insertID;
                            }
                            if (!isset($subParams['static']["transaksi_no"])) {
                                $subParams['static']["transaksi_no"] = $insertNum;
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                        }

                        if (sizeof($subParams) > 0) {
                            $tmpOutParams[$cCtr][] = $subParams;
                        }
                    }
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "sub-postProcessor: $comName, sending values <br>";

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();


                    //                    arrprint($tmpOutParams[$cCtr]);

                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }

            //</editor-fold>
            //endregion

            //region processing main-post-processors, always
            //<editor-fold desc="----------postProc">
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "post-processor: $comName<br>";

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;

                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }
                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //cekBiru("kiriman komponem $comName");
                    //                    arrPrint($tmpOutParams);
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                }
            }
            else {

            }


            //</editor-fold>
            //endregion

            //region nulis paymentSource
            $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_source");
            if (array_key_exists($stepCode, $paymentSources)) {

                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs[1] as $paymentSrcConfig) {
                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        arrPrint($externSrc);
                        $tr->writePaymentSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $_SESSION[$cCode]['main']['nomer'],
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                            "terbayar" => 0,
                            "sisa" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => (isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']])) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => (isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']])) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => (isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']])) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : 0,
                            "tagihan_valas" => (isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : 0,
                            "terbayar_valas" => (isset($externSrc['valasTerbayar']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : 0,
                            "sisa_valas" => (isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']])) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : 0,

                        ));
                        cekMerah(__LINE__ . " " . $this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion

            //region nulis paymentAntiSource
            $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_antiSource") != null ? $this->config->item("payment_antiSource") : array();
            if (array_key_exists($stepCode, $paymentSources)) {
                cekHitam(":: starting PAYMENT ANTI SOURCE");
                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs as $paymentSrcConfig) {
                        //					$paymentSrcConfig = $paymentSources[$stepCode];
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        $tr->writePaymentAntiSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $_SESSION[$cCode]['main']['nomer'],
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                            "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                            "terbayar_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : '',
                            "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',

                        ));
                        //cekMerah(__LINE__. " " .$this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion

            //====registri value-gate
            $baseRegistries = array(
                'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][1] : array(),
            );

            //===
            $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            $mongRegID = $doWriteReg;
            cekHitam(__LINE__ . " " . $this->db->last_query());

            //========extended steps (if any)
            //region extended steps
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $iKey => $iVal) {
                    if ($iVal > 0) {
                        cekbiru("evaluating $iKey ($iVal) for paymentSrc..");
                        $stepCode = $this->jenisTr . "_";
                        $paymentSources = $this->config->item("payment_source");
                        if (array_key_exists($stepCode, $paymentSources)) {
                            $payConfigs = $paymentSources[$stepCode];
                            cekbiru("$stepCode registered");
                            //===kalau melibatkan payment-source
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    if ($paymentSrcConfig['valueSrc'] == $iKey) {
                                        cekhijau($paymentSrcConfig['valueSrc'] . "/$iKey akan dieksekusi");
                                        $valueSrc = $paymentSrcConfig['valueSrc'];
                                        $externSrc = $paymentSrcConfig['externSrc'];
                                        if ($tr->paymentSrcExistsInMaster($insertID, $stepCode, $paymentSrcConfig['label'])) {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID sudah ada, tidak perlu ditulis");
                                        }
                                        else {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID BELUM ada, ditulis sekarang");
                                            $tr->writePaymentSrc($insertID, array(
                                                "_key" => $iKey,
                                                "jenis" => $stepCode,
                                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                                "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                                "label" => $paymentSrcConfig['label'],
                                                "tagihan" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "terbayar" => 0,
                                                "sisa" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                                "oleh_id" => $this->session->login['id'],
                                                "oleh_nama" => $this->session->login['nama'],
                                                "dtime" => date("Y-m-d H:i:s"),
                                                "fulldate" => date("Y-m-d"),
                                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                                "terbayar_valas" => 0,
                                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                            ));
                                        }
                                        //									cekMerah("paySrc: ".$this->db->last_query());
                                    }
                                    else {
                                        cekmerah($paymentSrcConfig['valueSrc'] . "/$iKey tidak untuk dieksekusi");
                                    }
                                }
                            }
                        }
                        else {
                            cekbiru("$stepCode NOT registered");
                        }
                        //==periksa apakah mainInput memerlukan auth
                        if (array_key_exists($iKey, $inputAuthConfigs)) {
                            $gID = $inputAuthConfigs[$iKey];
                            if (strlen($gID) > 0) {
                                cekhijau("input $iKey bernilai $iVal memerlukan auth dari $gID");
                                $trA = new MdlTransaksi();
                                if ($trA->extStepExistsInMaster($insertID, $iKey)) {
                                    cekhijau("extStep SUDAH terdaftar, sekarang nggak akan ditulis");
                                }
                                else {
                                    cekhijau("extStep belum terdaftar, sekarang hendak ditulis");
                                    $insertNew = $trA->writeExtStep($insertID, array(
                                        "master_id" => $insertID,
                                        "transaksi_id" => $insertID,
                                        "_key" => $iKey,
                                        "_label" => $inputLabels[$iKey],
                                        "_value" => $iVal,
                                        "group_id" => $gID,
                                        "state" => "0",
                                        "proposed_by" => $this->session->login['id'],
                                        "proposed_dtime" => date("Y-m-d H:i:s"),
                                        "done_by",
                                        "done_dtime",
                                    ));
                                    $mongoList['extras'][] = $insertNew;
                                    cekhijau(__LINE__ . " " . $this->db->last_query());
                                }
                            }

                        }
                    }
                }
            }
            //endregion

            //==========================================================================================================
            $masterID = $insertID;

            //region connecting antar cabang
            $connector = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['connectTo'] : "";
            if (strlen($connector) > 0) {
                cekMerah(":: CONNECTING BEGIN...");
                //cekMerah("to be connected to $connector");
                if (sizeof($steps) == 1) {
                    //cekMerah("now connecting to $connector");
                    if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                        die("kode connector tidak dikenali!");
                    }
                    if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                        die("konfigurasi connector harus memiliki step lebih dari satu!");
                    }


                    $oldCode = $cCode;
                    $cCode = "_TR_" . $connector;

                    //                    print_r($_SESSION[$cCode]);die();
                    //                    print_r($_SESSION[$oldCode]);die();
                    if (isset($_SESSION[$cCode])) {
                        $_SESSION[$cCode] = null;
                        unset($_SESSION[$cCode]);
                        $_SESSION[$cCode] = array();
                    }

                    $_SESSION[$cCode] = array(
                        "main" => $_SESSION[$oldCode]['main'],
                        "items" => $_SESSION[$oldCode]['items'],
                        //

                        "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                        "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                        //
                        "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                        //                        "out_detail_rsltItems" => $_SESSION[$oldCode]['out_detail_rsltItems'],
                        "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                        //
                        "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                        "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                        "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                    );

                    //                    print_r($_SESSION[$cCode]);die();

                    //==replace pertama
                    $masterReplacersO = array(
                        "jenisTr" => $connector,
                        "jenisTrMaster" => $connector,
                        "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                        "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "placeID" => $_SESSION[$oldCode]['main']['place2ID'],
                        "placeName" => $_SESSION[$oldCode]['main']['place2Name'],
                        "place2ID" => $_SESSION[$oldCode]['main']['placeID'],
                        "place2Name" => $_SESSION[$oldCode]['main']['placeName'],
                        "cabangID" => $_SESSION[$oldCode]['main']['place2ID'],
                        "cabangName" => $_SESSION[$oldCode]['main']['place2Name'],
                        "cabang2ID" => $_SESSION[$oldCode]['main']['placeID'],
                        "cabang2Name" => $_SESSION[$oldCode]['main']['placeName'],
                        //
                        "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                        "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                        "gudangID" => $_SESSION[$cCode]['main']['gudang2ID'],
                        "gudangName" => $_SESSION[$cCode]['main']['gudang2Name'],
                    );
                    foreach ($masterReplacersO as $key => $val) {
                        $_SESSION[$cCode]['main'][$key] = $val;
                        $_SESSION[$cCode]['main'][$key] = $val;
                    }
                    $masterReplacers = array(
                        //                        "referensi_id" => $masterID, (dimatikan)
                        "inv" => $tmpNomorNota,
                        //                        "jenis_master"    => $connector,

                        "jenis_master" => $connector,
                        "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        //                        "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                        "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                        "cabang_id" => $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                        "cabang_nama" => $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                        "cabang2_id" => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                        "cabang2_nama" => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                        "gudang_id" => $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                        "gudang_nama" => $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                        "gudang2_id" => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                        "gudang2_nama" => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                        "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                        "step_current" => 1,
                        "step_number" => 1,
                        "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                        "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                        "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                        "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                    );
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //region penomoran receipt #2
                    //<editor-fold desc="==========penomoran">
                    $this->load->model("CustomCounter");
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");

                    $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                    if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                        die(__LINE__ . " Used number should be registered in 'counters' config as well");
                    }

                    foreach ($counterForNumber as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                    }
                    $tmpNomorNota2 = $paramSpec['paramString'];
                    //</editor-fold>
                    //endregion

                    //region dynamic counters #2
                    // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                    $cn = new CustomCounter("transaksi");
                    $cn->setType("transaksi");
                    $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                    $configCustomParams[] = "stepCode";
                    if (sizeof($configCustomParams) > 0) {
                        $cContent = array();
                        foreach ($configCustomParams as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                            $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                            switch ($paramSpec['id']) {
                                case 0: //===counter type is new
                                    $paramKeyRaw = print_r($cParams, true);
                                    $paramValuesRaw = print_r($cValues[$i], true);
                                    $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                    break;
                                default: //===counter to be updated
                                    $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                    break;
                            }
                        }
                    }
                    $appliedCounters2 = base64_encode(serialize($cContent));
                    $appliedCounters_inText2 = print_r($cContent, true);
                    // </editor-fold>
                    //endregion

                    $addValues = array(
                        'counters' => $appliedCounters,
                        'counters_intext' => $appliedCounters_inText,
                        'nomer' => $tmpNomorNota,
                        'dtime' => date("Y-m-d H:i:s"),
                        'fulldate' => date("Y-m-d"),
                    );
                    foreach ($addValues as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }
                    //===cloning nota cab1 ke cab2
                    //===daftar perbedaan
                    //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,
                    //==replace kedua
                    $masterReplacers = array(
                        "nomer" => $tmpNomorNota2,
                        "counters" => $appliedCounters2,
                        "counters_intext" => $appliedCounters_inText2,
                    );
                    foreach ($masterReplacers as $key => $val) {
                        $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                    }

                    //===cloning detail/items cabang1 ke cabang2
                    //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                    $detailReplacers = array(
                        "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                        "sub_step_current" => 1,
                        "sub_step_number" => 1,
                        "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                        "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                        "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                        "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                        //                    "next_substep_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                        //                    "next_substep_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                        //                    "next_subgroup_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                    );
                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                            foreach ($dSpec as $key => $val) {
                                $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                            }
                        }
                    }

                    //region ----------write transaksi & transaksi_data #2
                    if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                        $tr = new MdlTransaksi();
                        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                        $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                        $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                        $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                        $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                        $mongoListConnect['main'] = array($insertID, $epID);
                        if ($insertID < 1) {
                            die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                        foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                            $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            $inserMainValues[] = $dd;
                            $mongoListConnect['mainValues'][] = $dd;
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                        cekkuning("main_inputs detected");
                        foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                            $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            //                            cekkuning("making a clone for input key $key / $val");
                            //                            $subInputInsertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                        foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                            $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                        }
                    }

                    if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                        foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                            $tr->writeMainElements($insertID, array(
                                "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                "name" => $aSpec['name'],
                                "label" => $aSpec['label'],
                                "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                            ));
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                            $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                            $insertIDs[] = $insertDetailID;
                            $mongoListConnect['detail'][] = $insertDetailID;
                            if ($epID != 999) {
                                $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                $insertIDs[] = $insertEpID;
                                $mongoListConnect['detail'][] = $insertEpID;
                            }
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                        $insertIDs = array();
                        foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                            $insertIDDetail = $tr->writeDetailEntries($insertID, $dSpec);
                            $insertIDs[] = $insertIDDetail;
                            $mongoListConnect['detail'][] = $insertIDDetail;
                            if ($epID != 999) {
                                $insertEpID = $tr->writeDetailEntries($epID, $dSpec);
                                $insertIDs[] = $insertEpID;
                                $mongoListConnect['detail'][] = $insertEpID;
                            }
                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                                foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                    $dd = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => $dSpec[$src],
                                    ));
                                    $insertIDs[$pID][] = $dd;
                                    $mongoListConnect['detailValues'][] = $dd;
                                }
                            }


                        }
                    }

                    if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                        foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                                foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                    $dd = $tr->writeDetailValues($insertID, array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => $dSpec[$src],
                                    ));
                                    $insertIDs[] = $dd;
                                    $mongoListConnect['detailValues'][] = $dd;
                                }
                            }


                        }
                    }


                    $idHis = array(
                        $stepNumber => array(
                            "step" => $stepNumber,
                            "trID" => $insertID,
                            "nomer" => $tmpNomorNota2,
                            "counters" => $appliedCounters2,
                            "counters_intext" => $appliedCounters_inText2,
                        ),
                    );
                    $idHis_blob = blobEncode($idHis);
                    $idHis_intext = print_r($idHis, true);

                    $tr = new MdlTransaksi();
                    $dupState = $tr->updateData(array("id" => $insertID), array(
                        "id_master" => $masterID,
                        "id_top" => $insertID,

                        "ids_his" => $idHis_blob,
                        "ids_his_intext" => $idHis_intext,

                    )) or die("Failed to update tr next-state!");
                    //cekHijau(__LINE__. " " .$this->db->last_query());

                    $baseRegistries = array(
                        'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                        'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                        'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                        'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                        'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                        'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                        'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                        'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                        'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                        'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                        'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                        'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                        'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                        'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                        'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                        'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                        'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                        'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                        'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                        'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                        "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                        "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                        "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                        "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                    );
                    //                    cekHitam("cetak transaksi $cCode");
                    $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                    $mongRegIDConnect = $doWriteReg;
                    //endregion

                    //
                    //region nulis paymentSource
                    //                    $stepCode = $connector;
                    $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_source");
                    cekHitam(":: $stepCode ::");
                    if (array_key_exists($stepCode, $paymentSources)) {

                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentSrc($insertID, array(
                                    "jenis" => $connector,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                    "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                    "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                    "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                    "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                    "terbayar_valas" => 0,
                                    "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                ));
                                //cekMerah(__LINE__. " " .$this->db->last_query());
                            }
                        }


                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion


                    //region nulis paymentAntiSource
                    //                    $stepCode = $connector;
                    $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                    $paymentSources = $this->config->item("payment_antiSource");
                    if (array_key_exists($stepCode, $paymentSources)) {

                        $payConfigs = $paymentSources[$stepCode];
                        if (sizeof($payConfigs) > 0) {
                            foreach ($payConfigs as $paymentSrcConfig) {
                                //					$paymentSrcConfig = $paymentSources[$stepCode];
                                $valueSrc = $paymentSrcConfig['valueSrc'];
                                $externSrc = $paymentSrcConfig['externSrc'];
                                $tr->writePaymentAntiSrc($insertID, array(
                                    "jenis" => $connector,
                                    "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                    "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                    "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                    "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                    "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                    "label" => $paymentSrcConfig['label'],
                                    "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "terbayar" => 0,
                                    "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                    "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                    "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                    "oleh_id" => $this->session->login['id'],
                                    "oleh_nama" => $this->session->login['nama'],
                                    "dtime" => date("Y-m-d H:i:s"),
                                    "fulldate" => date("Y-m-d"),
                                ));
                                //cekMerah(__LINE__. " " .$this->db->last_query());
                            }
                        }


                    }
                    else {
                        //cekMerah("TIDAK nulis paymentSrc");
                    }
                    //endregion


                }
                else {
                    //cekMerah("to be delayed to connect to $connector");
                }
            }
            else {
                //cekKuning("not connecting to any tCode");
            }

            //endregion

            cekMerah("TRANSAKSI DONE");

            //region writelog
            $this->load->model("Mdls/" . "MdlActivityLog");
            $hTmp = new MdlActivityLog();
            $tmpHData = array(
                "title" => $_SESSION[$cCode]['main']['jenisTrName'],
                "sub_title" => "Saving new transaction",
                "uid" => $this->session->login['id'],
                "uname" => $this->session->login['nama'],
                "dtime" => date("Y-m-d H:i:s"),
                "transaksi_id" => $insertID,
                "deskripsi_old" => "",
                "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
                "jenis" => $this->jenisTr,
                "ipadd" => $_SERVER['REMOTE_ADDR'],
                "devices" => $_SERVER['HTTP_USER_AGENT'],
                "category" => "transaksi",
                "controller" => $this->uri->segment(1),
                "method" => $this->uri->segment(2),
                "url" => current_url(),
            );
            $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Line: " . __LINE__ . " - Gagal menulis riwayat data", __FILE__));
            //endregion

            validateAllBalances();
            //            arrPrint( $_SESSION[$cCode]['mode'] );
            //            arrPrint( $cCode );
            //            arrPrint( $masterID );

            //            mati_disini("under maintenance");
            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
            //region cloning ke mongo
            if (sizeof($mongoList) > 0) {
                $mong = new MdlMongoMother();
                $tr = new MdlTransaksi();
                foreach ($mongoList as $gateList => $listIDSData) {
                    $tr->setFilters(array());
                    $tr->setSortBy(array());
                    $tr->setTableName($this->mongoTableList[$gateList]);
                    $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                    $tmpTrm = $tr->lookUpAll()->result();

                    if (sizeof($tmpTrm) > 0) {
                        $mong->setTableName($this->mongoTableList[$gateList]);
                        foreach ($tmpTrm as $tmpMain) {
                            $transksi_main = json_decode(json_encode($tmpMain), true);
                            //                            arrPrint($transksi_main);
                            $mong->addData($transksi_main);
                        }
                    }
                    //                    cekHitam($listedTable[$gateList]);
                    //                    cekLime($gateList);

                }
            }
            if (sizeof($mongRegID) > 0) {
                //                $arrMainID = $mongoList['main'];
                $tr->setTableName("transaksi_registry");
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->addFilter("id in (" . implode(",", $mongRegID) . ")");
                $tmpTrm = $tr->lookUpAll()->result();

                $mong->setTableName("transaksi_registry");
                if (sizeof($tmpTrm) > 0) {
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }

            }
            //endregion

            //region cloning conecto mongo
            if (sizeof($mongoListConnect) > 0) {
                $mong = new MdlMongoMother();
                $tr = new MdlTransaksi();
                foreach ($mongoListConnect as $connGate => $connData) {
                    $tr->setFilters(array());
                    $tr->setSortBy(array());
                    $tr->setTableName($this->mongoTableList[$connGate]);
                    $tr->addFilter("id in (" . implode(",", $connData) . ")");
                    $tmpTrm = $tr->lookUpAll()->result();
                    if (sizeof($tmpTrm) > 0) {
                        $mong->setTableName($this->mongoTableList[$connGate]);
                        foreach ($tmpTrm as $tmpMain) {
                            $transksi_main = json_decode(json_encode($tmpMain), true);
                            $mong->addData($transksi_main);
                        }
                    }
                }
            }

            if (sizeof($mongRegIDConnect) > 0) {
                //                $arrMainID = $mongRegIDConnect['main'];
                $tr->setTableName("transaksi_registry");
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->addFilter("id in (" . implode(",", $mongRegIDConnect) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                //                    cekbiru($this->db->last_query());
                $mong->setTableName("transaksi_registry");
                if (sizeof($tmpTrm) > 0) {
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        $mong->addData($transksi_main);
                    }
                }

            }
            //            $mongRegIDConnect //punya registry 2
            //endregion
            //region cloning update mongo
            if (sizeof($mongUpdateList) > 0) {
                $mong = new MdlMongoMother();
                foreach ($mongUpdateList as $metode => $tmpData) {
                    if ($metode == "update") {
                        if (sizeof($tmpData) > 0) {
                            foreach ($tmpData as $gate => $fildsData) {
                                $mong->setTableName($this->mongoTableList[$gate]);
                                foreach ($fildsData as $mongUpadte) {
                                    $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                                }
                            }
                        }
                    }

                }
            }

            //endregion

            if (isset($_SESSION[$cCode])) {
                unset($_SESSION[$cCode]);
            }
            if (isset($oldCode)) {
                if (isset($_SESSION[$oldCode])) {
                    unset($_SESSION[$oldCode]);
                }
            }

            //region feedback msg
            $this->session->errMsg = "transaction entry has been saved<br>";
            $nextNum = $nextProp["num"];
            if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
                $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
                $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;
            }
            else {
                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
                $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;
            }
            $trBackClick = "location.href='$trBackLink'";
            //            $this->session->errMsg .= "<a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
            //endregion

            if (strlen($rawPrevURL) > 3) {
                $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
                                   {
                                       title:'Followup preview',
                                       message: " . 'top.$' . "('<div></div>').load('$prevUrl'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                //                echo "<html>";
                //                echo "<head>";
                //                echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
                //                echo "</head>";
                //                echo "<body onload=\"$actionTarget\">";
                //                echo "</body>";
                //                echo "</html>";
            }
            else {
                if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint']['1'])) {
                    $printSettings = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint']['1']) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint']['1'] : array();
                    $printLocation = $this->config->item('heTransaksi_layout')[$this->jenisTr]['printLocation'];
                    if (isset($printSettings['size'])) {
                        cekkuning("detecting printing size");

                        switch ($printSettings['size']) {
                            case "normal":

                                //                                cekkuning("size: NORMAL");
                                echo "<script>";
                                echo "top.popBig('" . base_url() . $printLocation . "$tmpNomorNota');";
                                echo "top.location.reload();";
                                echo "</script>";
                                break;
                            case "small":
                                //                                cekkuning("size: SMALL");
                                echo "<script>";
                                echo "top.popSmall('" . base_url() . $printLocation . "$tmpNomorNota');";
                                echo "top.location.reload();";
                                echo "</script>";
                                break;
                            default:
                                //                                cekkuning("size: UNKNOWN");
                                break;
                        }


                    }
                    else {
                        cekkuning("not printing");
                        $arrAlert = array(
                            "type" => "success",
                            "title" => "Transaction saved",
                            //                        "html" => "your order has been saved and ready to process",
                            "html" => $this->session->errMsg,
                            "timer" => "1500",
                            "showConfirmButton" => false,
                            "allowOutsideClick" => false,
                        );
                        echo swalAlert($arrAlert);
                        echo "<script>topReload(1500)</script>";
                        echo topReload();
                        echo "</script>";
                        unset($this->session->errMsg);
                    }

                }
                else {
                    //                    cekkuning("settings dont exist, not printing");
                    $arrAlert = array(
                        "type" => "success",
                        "title" => "Transaction saved",
                        //                        "html" => "your order has been saved and ready to process",
                        "html" => $this->session->errMsg,
                        "timer" => "1500",
                        "showConfirmButton" => false,
                        "allowOutsideClick" => false,
                    );
                    echo swalAlert($arrAlert);
                    echo "<script>topReload(1500)</script>";
                    echo topReload();
                    echo "</script>";
                    unset($this->session->errMsg);
                }
            }
        }
        else {
            die("the gate index you want to debug has not been formed yet!");
        }
    }

    //approval cancel packing
    public function doCancelPacking()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }


        $transaksiID_reference = $no = rtrim($this->uri->segment(3), "-");
        $stepNum = $this->uri->segment(4);
        $stepNumCurrent = $this->uri->segment(5);

        $paramPatchers = $this->config->item('heTransaksi_paramPatchers') != null ? $this->config->item('heTransaksi_paramPatchers') : array();
        $paramForceFillers = $this->config->item('heTransaksi_paramForceFillers') != null ? $this->config->item('heTransaksi_paramForceFillers') : array();

        $this->load->library("FieldCalculator");
        $cal = new FieldCalculator();

        //==ambil datanya
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tr->addFilter("step_number='" . $stepNumCurrent . "'");
        $tr->addFilter("transaksi_data.trash='0'");
        $tmpTr = $tr->lookupJoined()->result();

        $cancel_packing_source_id = $tmpTr[0]->cancel_packing_source_id;
        cekHitam($this->db->last_query());

        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $cCode = "_TR_" . $this->jenisTr;
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $detailValuesConfig = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] : array();
            $masterID = $_SESSION[$cCode]['main']['masterID'];
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;

            $trID = $tmpTr[0]->transaksi_id;

            //==references, previous entry
            $prevProp = array(
                "id" => $tmpTr[0]->transaksi_id,
                "jenis" => $tmpTr[0]->jenis,
                "nomer" => $tmpTr[0]->nomer,
            );

            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }


            $main = array();
            $items = array();
            $prevIDs = array();
            $prevNos = array();
            foreach ($tmpTr as $row) {
                $items[$row->produk_id] = array(
                    "id" => $row->produk_id,
                    "nama" => $row->produk_nama,
                    "jml" => $row->produk_ord_jml,
                    "harga" => $row->produk_ord_hrg,
                    "valid_qty" => $row->valid_qty,
                    "transaksi_id" => $row->transaksi_id,
                    "nomer" => $row->nomer,
                );

                if ($row->valid_qty > 0) {
                    cekHitam("ok lanjut");
                }
                else {
                    if (isset($_SESSION[$cCode]['items'][$row->produk_id])) {
                        matiHere("Followed up already. Please close and refresh your browser " . $row->produk_nama . " " . $row->produk_id);//kalo session active ya harus dimatiin biar gak dobel
                    }
                }

                if (!in_array($row->transaksi_id, $prevIDs)) {
                    $prevIDs[] = $row->transaksi_id;
                }
                if (!in_array($row->nomer, $prevNos)) {
                    $prevNos[] = $row->nomer;
                }
                if (sizeof($detailValuesConfig) > 0) {
                    echo "detail values ada..<br>";
                    foreach ($detailValuesConfig as $key => $src) {
                        echo "$key akan ambil nilai dari $src<br>";
                        if (isset($detailValues[$row->produk_id][$key])) {
                            $items[$row->produk_id][$key] = $detailValues[$row->produk_id][$key];
                        }
                        else {
                            if (isset($row->$key)) {
                                $items[$row->produk_id][$key] = $row->$key;
                            }
                        }
                        echo "dan sekarang nilainya: " . $items[$row->produk_id][$key] . "<br>";
                    }
                }
            }

        }
        else {
            $masterID = 0;
            $tmpNomorNota = "XXXX";
            $origJenis = 0;
            $topID = 0;
            die(lgShowAlert("No such receipt ID: $no!"));
        }

        //        cekMerah("items items items");
        //        arrprint($items);
        //
        //        cekHitam("CHILD GATES BEFORE");
        //        arrprint($_SESSION[$cCode]['out_detail']);

        //==ongkir dll (additional fees) harus diselipkan kedalam masterGates aktual
        //region ongkir dll diselipkan ke masterGates
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exKey => $exSpec) {
                if ($exSpec['useAt'] == $stepNum) {
                    if (isset($exSpec['mdlName']) && strlen($exSpec['mdlName']) > 3) {
                        $_SESSION[$cCode]['main'][$exKey . "_src"] = $_POST[$exKey . "_src"];
                        if (isset($_SESSION[$cCode]['main_add_values'][$exKey . "_src"])) {
                            $_SESSION[$cCode]['main_add_values'][$exKey . "_src"] = $_POST[$exKey . "_src"];
                        }
                    }
                    $_SESSION[$cCode]['main'][$exKey] = $_POST[$exKey];
                    if (isset($_SESSION[$cCode]['main_add_values'][$exKey])) {
                        $_SESSION[$cCode]['main_add_values'][$exKey] = $_POST[$exKey];
                    }

                    if ($exSpec['taxFactor'] > 0) {
                        $_SESSION[$cCode]['main'][$exKey . "_tax"] = $_POST[$exKey . "_tax"];
                        if (isset($_SESSION[$cCode]['main_add_values'][$exKey . "_tax"])) {
                            $_SESSION[$cCode]['main_add_values'][$exKey . "_tax"] = $_POST[$exKey . "_tax"];
                        }
                    }
                }
            }
        }
        //endregion


        //region baca seting optional step
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['optCriteriaField']) && strlen($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['optCriteriaField']) > 0) {
            //            //cekBiru("OPT ditentukan");
            $criteriaField = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['optCriteriaField'];
            if (isset($_SESSION[$cCode]['main'][$criteriaField]) && $_SESSION[$cCode]['main'][$criteriaField] > 0) {
                echo "nextstepnum normal<br>";
                $nextStepNum = ($stepNum + 1);
                $useAdditionalStep = true;
            }
            else {
                echo "nextstepnum hampir normal<br>";
                $useAdditionalStep = false;
                $nextStepNum = ($stepNum + 2);
            }
        }
        else {
            //            //cekBiru("OPT TIDAK ditentukan");
            echo "nextstepnum TIDAK normal<br>";
            $useAdditionalStep = false;
            $nextStepNum = ($stepNum + 1);
            echo "yaitu $nextStepNum<br>";
        }
        //endregion


        //region build table rekening
        $buildTablesMaster = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master'] : array();
        $buildTablesDetail = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail'] : array();


        $addMasterTables = array(
            "rugilaba",
            "laba ditahan",
            "rugilaba lain lain",
        );
        foreach ($addMasterTables as $trek) {
            $buildTablesMaster[] = array(
                "comName" => "RugiLaba",
                "loop" => array(
                    "$trek" => .0,
                ),
            );
        }

        if (sizeof($buildTablesMaster) > 0) {
            foreach ($buildTablesMaster as $buildTablesMaster_specs) {
                $mdlName = $buildTablesMaster_specs['comName'];
                $mdlName = "Com" . $mdlName;
                //cekHitam("model: $mdlName");
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();
                if (method_exists($m, "getTableNameMaster")) {
                    if (sizeof($m->getTableNameMaster())) {
                        $m->buildTables($buildTablesMaster_specs);
                    }
                }
            }
        }

        if (sizeof($buildTablesDetail) > 0) {
            foreach ($buildTablesDetail as $buildTablesDetail_specs) {
                $mdlName = $buildTablesDetail_specs['comName'];
                $mdlName = "Com" . $mdlName;
                //cekHitam("model: $mdlName");
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();
                if (method_exists($m, "getTableNameMaster")) {
                    if (sizeof($m->getTableNameMaster())) {
                        $m->buildTables($buildTablesDetail_specs);
                    }
                }
            }
        }
        //endregion


        //mati_disini();
        $this->db->trans_start();


        //update/swap valid_qty to cancel_qty
        $trTrash = new MdlTransaksi();
        $trTrash->setFilters(array());
        $trTrash->addFilter("transaksi_id in (" . implode(",", explode("-", $cancel_packing_source_id)) . ")");
        //        $trTrash->addFilter("valid_qty>0 OR req_cancel_qty>0");
        $tmpTrS = $trTrash->lookupJoined()->result();

        $trCancel = array();
        if (sizeof($tmpTrS) > 0) {
            foreach ($tmpTrS as $row) {
                $trCancel['valid_qty'][$row->produk_id] = $row->valid_qty;
                $trCancel['cancel_qty'][$row->produk_id] = $row->cancel_qty;
                $trCancel['req_cancel_qty'][$row->produk_id] = $row->req_cancel_qty;
            }
        }

        arrPrint($trCancel);

        $bQty = array();
        foreach ($tmpTr as $row) {
            if (!isset($bQty[$row->produk_id])) {
                $bQty[$row->produk_id] = 0;
            }
            $bQty[$row->produk_id] += $row->valid_qty;
        }

        $mongoList = array();
        $mongUpdateList = array();
        $mongRegID = array();
        if (sizeof($tmpTr) > 0) {
            foreach ($tmpTr as $row) {
                $dataItems = array();
                $where = array(
                    "transaksi_id" => $cancel_packing_source_id,
                    "produk_id" => $row->produk_id,
                );

                $req_cancel_qty_b4 = isset($trCancel['req_cancel_qty'][$row->produk_id]) ? $trCancel['req_cancel_qty'][$row->produk_id] : 0;
                $valid_qty_b4 = isset($trCancel['valid_qty'][$row->produk_id]) ? $trCancel['valid_qty'][$row->produk_id] : 0;
                $cancel_qty_b4 = isset($bQty[$row->produk_id]) ? $bQty[$row->produk_id] : 0;

                cekHijau("req_cancel_qty_b4: " . $req_cancel_qty_b4);
                cekHijau("valid_qty_b4: " . $valid_qty_b4);
                cekHijau("cancel_qty_b4: " . $cancel_qty_b4);

                $req_cancel_qty_af = (int)$req_cancel_qty_b4 - (int)$cancel_qty_b4;
                $cancel_qty_af = (int)$cancel_qty_b4 + (int)$req_cancel_qty_b4;

                if ($valid_qty_b4 > 0) {
                    $dataItems = array(
                        "cancel_qty" => $cancel_qty_af,
                        "req_cancel_qty" => $req_cancel_qty_af,
                    );

                    cekOrange("valid QTY masih ada");

                }
                else {
                    $dataItems = array(
                        "cancel_qty" => $cancel_qty_af,
                        "req_cancel_qty" => $req_cancel_qty_af,
                        "sub_step_number" => '',
                        "next_substep_code" => '',
                    );
                    cekOrange("valid QTY kosong boss, marking sub_step_number");
                }


                $trTrash->setTableName("transaksi_data");
                $trTrash->setFilters(array());

                $updateItems = $trTrash->updateData($where, $dataItems) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  updte  params registries"));
                $mongUpdateList['update']['detail'][] = array(
                    "where" => $where,
                    "value" => $dataItems,
                );
                cekHitam($this->db->last_query());
                cekHere($row->id . " - " . $row->produk_id);
                cekHere("cancel_packing_source_id " . $row->cancel_packing_source_id);
                arrPrint($where);

            }
        }


        cekHere("no: " . $no);
        //        matiHere();

        //
        //region pre-processors (master)
        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['master'])) {
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['master'] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();

            echo "ITEM NUM LABELS";
            arrPrint($iterator);
            if (sizeof($iterator) > 0) {

                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                    echo "master-preproc: $comName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();


                    $subParams = array();
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $subParams['static'][$key] = $realValue;

                        }

                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            foreach ($paramPatchers[$comName] as $k => $v) {
                                if (!isset($subParams['static'][$k])) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }
                        }
                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }

                        $subParams['static']["fulldate"] = date("Y-m-d");
                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }
                    if (sizeof($subParams) > 0) {
                        $tmpOutParams[$cCtr] = $subParams;
                    }


                    $mdlName = "Pre" . ucfirst($comName);
                    $this->load->model("Preprocs/" . $mdlName);
                    $m = new $mdlName($resultParams);


                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    if ($tobeExecuted) {
                        $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $gotParams = $m->exec();

                        cekbiru("gotparams dari $comName");
                        arrprint($gotParams);

                        if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                            cekhijau("ada gotparam, sekarang mau replace");
                            foreach ($gotParams as $gateName => $gSpec) {
                                if (isset($_SESSION[$cCode]['main'])) {
                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                        foreach ($gSpec as $key => $val) {
                                            cekbiru("injecting param $key with $val");
                                            $_SESSION[$cCode]['main'][$key] = $val;
                                        }
                                    }
                                }
                                //==inject gotParams to child gate
                                if (isset($_SESSION[$cCode]['main'])) {
                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                        foreach ($gSpec as $key => $val) {
                                            $_SESSION[$cCode]['main'][$key] = $val;
                                        }
                                    }
                                }

                            }
                        }
                        else {
                            cekmerah("TIDAK ada gotparam, tidak perlu replace");
                        }

                    }
                    else {
                        cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                    }

                }
            }
            else {
                //cekKuning("sub-preproc is not set");
            }


            $this->load->helper("he_value_builder");
            fillValues($this->jenisTr, $stepNumCurrent, $stepNum);
        }
        else {
            echo("no processor defined. skipping preprocessor..<br>");
        }

        //endregion


        //
        //region pre-processors (item)
        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['detail'])) {
            //                $procList = $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum];
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][$stepNum]['detail'] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNum] : array();
            echo "ITEM NUM LABELS";

            if (sizeof($iterator) > 0) {

                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "sub-preproc: $comName, initializing values <br>";

                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                        $tmpOutParams[$cCtr] = array();
                        //                        $id = $dSpec['id'];
                        $id = $xid;
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['static'][$key] = $realValue;

                            }

                            if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                                foreach ($paramPatchers[$comName] as $k => $v) {
                                    if (!isset($subParams['static'][$k])) {
                                        $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                    }
                                }
                            }
                            if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                                $jenis = $_SESSION[$cCode]['main']['jenis'];
                                foreach ($paramForceFillers[$comName] as $k => $v) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                        }

                        if (sizeof($subParams) > 0) {

                            $tmpOutParams[$cCtr][] = $subParams;
                        }


                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                        echo "sub preproc #$it: $comName, sending values <br>";

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);
                        //cekHitam($mdlName);
                        //arrPrint($tmpOutParams);
                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair($masterID, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();
                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor


                                foreach ($gotParams as $gateName => $paramSpec) {

                                    if (!isset($_SESSION[$cCode][$gateName])) {
                                        $_SESSION[$cCode][$gateName] = array();
                                        //                                    cekhijau("building the session: $gateName");
                                    }
                                    else {
                                        //                                    cekhijau("NOT building the session: $gateName");
                                    }

                                    foreach ($paramSpec as $id => $gSpec) {
                                        //                                        $id = $gSpec['id'];

                                        if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                            $_SESSION[$cCode][$gateName][$id] = array();
                                        }

                                        if (isset($_SESSION[$cCode][$gateName][$id])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                }

                                            }
                                        }
                                        //==inject gotParams to child gate
                                        if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                            if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                foreach ($gSpec as $key => $val) {
                                                    $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                }

                                            }
                                        }

                                        //cekMerah("REBUILDING VALUES..");
                                        if (sizeof($itemNumLabels) > 0) {
                                            //cekHijau("REBUILDING SUBS FOR ITEMS");
                                            foreach ($itemNumLabels as $key => $label) {
                                                //cekHere("$id === $key => $label");
                                                $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                //                                        die();
                                            }
                                        }
                                    }
                                    //                                    arrPrint($_SESSION[$cCode][$gateName]);die();
                                }


                            }

                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }

                    }
                }
            }
            else {
                //cekKuning("sub-preproc is not set");
            }


            $this->load->helper("he_value_builder");
            fillValues($this->jenisTr, $stepNumCurrent, $stepNum);


        }
        else {
            echo("no processor defined. skipping preprocessor..<br>");
        }

        //endregion

        $this->midValidate();
        $this->unionValidate();
        //==tulis komponen, if any
        //        $nextStepNum = ($stepNum + 1);
        //


        //region update step2an
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum])) {//===masih ada langkah selanjutnya
            echo "authorizing to next step..<br>";
            $nextProp = array(
                "num" => $nextStepNum,
                "code" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum]['target'],
                "label" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum]['label'],
                "groupID" => $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextStepNum]['userGroup'],
            );
        }
        else {//==ini step terakhir, tulis komponen jika ada

            $nextProp = array(
                "num" => 0,
                "code" => "",
                "label" => "",
                "groupID" => "",
            );
        }
        //endregion

        //        print_r($nextProp);die();


        echo "checking components..<br>";

        //referensi_id pada steps (dimatikan)
        //        $masterReplacers = array(
        //            "referensi_id" => $masterID,
        //        );
        //        $childReplacers = array(
        //            "referensi_id" => $masterID,
        //        );
        //        foreach ($masterReplacers as $key => $val) {
        //            $_SESSION[$cCode]['main'][$key] = $val;
        //        }
        //        foreach ($childReplacers as $key => $val) {
        //            foreach ($_SESSION[$cCode]['out_detail'] as $xid => $cSpec) {
        //                $id = $cSpec['id'];
        //                $_SESSION[$cCode]['out_detail'][$id][$key] = $val;
        //            }
        //
        //        }


        //        cekHitam("CHILD GATES AFTER");
        //        arrprint($_SESSION[$cCode]['out_detail']);


        //==tulis signature
        //        arrPrint($_SESSION[$cCode]['main']);die();
        $dwsign = $tr->writeSignature($masterID, array(
            "nomer" => $tmpNomorNota,
            "step_number" => $stepNum,
            "step_code" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['target'],
            "step_name" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'],
            "group_code" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['userGroup'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "keterangan" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'] . " oleh " . $this->session->login['nama'],
            "transaksi_id" => $masterID,
        )) or die("Failed to write signature");
        $mongoList['sign'][] = $dwsign;
        //cekKuning(__LINE__. " " .$this->db->last_query());

        //region update step terdahulu
        $tr = new MdlTransaksi();
        $dupState = $tr->updateData(array("id" => $topID), array(
            "next_step_code" => $nextProp['code'],
            "next_step_label" => $nextProp['label'],
            "next_group_code" => $nextProp['groupID'],
            "next_step_num" => $nextProp['num'],
            "step_current" => $stepNum,

        )) or die("Failed to update tr next-state!");
        $mongUpdateList['update']['main'][] = array(
            "where" => array("id" => $topID),
            "value" => array(
                "next_step_code" => $nextProp['code'],
                "next_step_label" => $nextProp['label'],
                "next_group_code" => $nextProp['groupID'],
                "next_step_num" => $nextProp['num'],
                "step_current" => $stepNum,
            ),
        );
        cekHijau(__LINE__ . " " . $this->db->last_query());


        //        $dupState = $tr->updateData(array("id" => $topID), array(
        //            "next_step_code"  => $nextProp['code'],
        //            "next_step_label" => $nextProp['label'],
        //            "next_group_code" => $nextProp['groupID'],
        //            "next_step_num"   => $nextProp['num'],
        //            "step_current"    => $stepNum,
        //
        //        )) or die("Failed to update tr next-state!");
        //        cekHijau(__LINE__. " " .$this->db->last_query());
        //endregion


        //        arrprint($_SESSION[$cCode]['tableIn_master']);die();
        //==prepare kloningan
        $tCode = $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['target'];
        $tCodeName = $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'];
        $masterReplacers = array(
            //            "referensi_id" => $masterID, (dimatikan)
            //            "id_master"       => $masterID,
            //            "id_top"          => $topID,
            "inv" => $tmpNomorNota,
            //            "jenis_top"           => $tCode,
            "jenis" => $tCode,
            "jenis_label" => $tCodeName,
            "transaksi_jenis" => $tCode,
            "cabang_id" => selectedTransactionSession() ? $_SESSION[$cCode]['main']['cabangID'] : $this->session->login['cabang_id'],
            "cabang_nama" => selectedTransactionSession() ? $_SESSION[$cCode]['main']['cabangName'] : $this->session->login['cabang_nama'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "step_current" => "0",
            "step_number" => $stepNum,
            //            "next_step_code"      => "",
            //            "next_step_label"     => "",
            //            "next_group_code"     => "",
            "next_step_code" => $nextProp['code'],
            "next_step_label" => $nextProp['label'],
            "next_group_code" => $nextProp['groupID'],
            //===references
            "id_master" => $masterID,
            "id_top" => $topID,
            "ids_prev" => base64_encode(serialize($prevIDs)),
            "ids_prev_intext" => print_r($prevIDs, true),
            "nomer_top" => $_SESSION[$cCode]['tableIn_master']['nomer_top'],
            "nomers_prev" => base64_encode(serialize($prevNos)),
            "nomers_prev_intext" => print_r($prevNos, true),
            //            "jenis_top"           => $this->jenisTr,
            "jenises_prev" => base64_encode(serialize(array($prevProp['jenis']))),
            "jenises_prev_intext" => print_r(array($prevProp['jenis']), true),
            "tail_number" => $stepNum,
            "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
        );
        foreach ($masterReplacers as $key => $val) {
            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
        }

        $childTableRepaclers = array(
            "sub_step_number" => $stepNum,
            "sub_step_current" => $stepNum,
            "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']),
            "next_substep_num" => $nextProp['num'],
            "next_substep_code" => $nextProp['code'],
            "next_substep_label" => $nextProp['label'],
            "next_subgroup_code" => $nextProp['groupID'],
        );
        foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
            //			$id = $dSpec['id'];
            foreach ($childTableRepaclers as $key => $val) {
                $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
            }
        }

        //        arrprint($_SESSION[$cCode]['tableIn_detail']);die();
        $masterReplacersO = array(

            "jenisTr" => $tCode,
            "jenisTrName" => $tCodeName,
            "olehID" => $this->session->login['id'],
            "olehName" => $this->session->login['nama'],
            "stepNumber" => $stepNum,
            "stepCode" => $tCode,
        );
        foreach ($masterReplacersO as $key => $val) {
            $_SESSION[$cCode]['main'][$key] = $val;
        }

        //region menimbulkan nilai tagihan
        $unpaidList = null != $this->config->item('tr_unpaidList') ? $this->config->item('tr_unpaidList') : array();
        //        arrprint($_SESSION[$cCode]['tableIn_master']);
        if (in_array($tCode, $unpaidList)) {
            $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_tagihan"] = $_SESSION[$cCode]['tableIn_master']['transaksi_nilai'];
            $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_terbayar"] = 0;
            $_SESSION[$cCode]['tableIn_master']["transaksi_nilai_sisa"] = ($_SESSION[$cCode]['tableIn_master']['transaksi_nilai_tagihan'] - $_SESSION[$cCode]['tableIn_master']['transaksi_nilai_terbayar']);
            //cekMerah("NULIS TAGIHANN");
        }
        else {
            //cekMerah("TIDAK NULIS TAGIHANN");
        }
        //endregion


        //region penomoran receipt #1

        $this->load->model("CustomCounter");
        $cn = new CustomCounter("transaksi");
        $cn->setType("transaksi");

        $counterForNumber = array($this->config->item('heTransaksi_core')[$origJenis]['formatNota']);
        if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$origJenis]['counters'])) {
            die(__LINE__ . " Used number should be registered in 'counters' config as well");
        }

        foreach ($counterForNumber as $i => $cRawParams) {
            $cParams = explode("|", $cRawParams);
            $cValues = array();
            foreach ($cParams as $param) {
                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
            }
            $cRawValues = implode("|", $cValues[$i]);
            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);
        }
        $tmpNomorNota2 = $paramSpec['paramString'];
        $tmpNomorNota2Alias = formatNota("nomer_nolink", $tmpNomorNota2);

        //endregion

        //region dynamic counters #1
        // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
        $cn = new CustomCounter("transaksi");
        $cn->setType("transaksi");
        $configCustomParams = $this->config->item('heTransaksi_core')[$origJenis]['counters'];
        $configCustomParams[] = "stepCode";
        if (sizeof($configCustomParams) > 0) {
            $cContent = array();
            foreach ($configCustomParams as $i => $cRawParams) {
                $cParams = explode("|", $cRawParams);
                $cValues = array();
                foreach ($cParams as $param) {
                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                }
                $cRawValues = implode("|", $cValues[$i]);
                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                switch ($paramSpec['id']) {
                    case 0: //===counter type is new
                        $paramKeyRaw = print_r($cParams, true);
                        $paramValuesRaw = print_r($cValues[$i], true);
                        $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                        break;
                    default: //===counter to be updated
                        $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                        break;
                }
                //echo "<hr>";
            }
        }
        $appliedCounters2 = base64_encode(serialize($cContent));
        $appliedCounters_inText2 = print_r($cContent, true);


        $masterReplacers = array(
            "nomer" => $tmpNomorNota2,
            "counters" => $appliedCounters2,
            "counters_intext" => $appliedCounters_inText2,
        );
        foreach ($masterReplacers as $key => $val) {
            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
        }

        $addValues = array(
            'counters' => $appliedCounters2,
            'counters_intext' => $appliedCounters_inText2,
            'nomer' => $tmpNomorNota2,
            'dtime' => date("Y-m-d H:i:s"),
            'fulldate' => date("Y-m-d"),
        );
        foreach ($addValues as $key => $val) {
            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
        }

        // </editor-fold>
        //endregion


        //==tulis kloningan transaksi
        //region write entries
        if (sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {

            $_SESSION[$cCode]['tableIn_master']['status_4'] = 11;
            $_SESSION[$cCode]['tableIn_master']['trash_4'] = 0;


            $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
            $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
            $mongoList['main'] = array($insertID, $epID);

            $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
            $_SESSION[$cCode]['main']['nomer'] = $insertNum;
            if ($insertID < 1) {
                die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
            }


            if (isset($_SESSION[$cCode]['tableIn_master']['ids_his'])) {
                $idHis_decode = blobDecode($_SESSION[$cCode]['tableIn_master']['ids_his']);
                $idHis_decode[$stepNum] = array(
                    "step" => $stepNum,
                    "trID" => $insertID,
                    "nomer" => $tmpNomorNota2,
                    "nomer2" => $tmpNomorNota2Alias,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                $idHis_blob = blobEncode($idHis_decode);
                $idHis_intext = print_r($idHis_decode, true);

                $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;


                cekUngu($idHis_blob);
                cekUngu($idHis_intext);
                arrPrint($idHis_decode);
                arrPrint($_SESSION[$cCode]['tableIn_master']);

                $tr = new MdlTransaksi();
                $dup = $tr->updateData(array("id" => $insertID), array(
                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");
                cekUngu(__LINE__ . " " . $this->db->last_query());
            }


            cekUngu(":: insertID => $insertID ::");
            if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $mongoList['mainValues'][] = $dd;
                }
            }
            if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                    $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    $mongoList['mainValues'][] = $dd;
                }
            }
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                    $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                }
            }
            if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                }
            }


            if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                //                cekMerah("ada mainElements $cCode");
                //                arrprint($_SESSION[$cCode]['main_elements']);die();
                foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                    $tr->writeMainElements($insertID, array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec['label'],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                    ));
                }
            }
            else {
                //                cekMerah("TAK ada mainElements");
            }

            if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                        $insertIDs = array();
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => isset($dSpec[$src]) ? $dSpec[$src] : 0,
                            ));
                            $insertIDs[] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }


                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                        $insertIDs = array();
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                            $dd = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $insertIDs[] = $dd;
                            $mongoList['detailValues'][] = $dd;
                        }
                    }


                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detail_rsltItems'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detail_rsltItems'] as $key => $src) {
                            $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail_rsltItems'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                        }
                    }


                }
            }


            //region update validQty pada step sebelumnya yang di-refer
            $seluruhnya = true;
            $prevTrID = 0;
            if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail'] as $iID => $dSpec) {
                    $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    if ($epID != 999) {
                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                        $mongoList['detail'] = $insertIDs;
                    }


                    if (isset($_SESSION[$cCode]['extractedItems'])) {
                        if (array_key_exists($iID, $_SESSION[$cCode]['extractedItems'])) {

                            $itemFulfilledJml = 0;
                            foreach ($_SESSION[$cCode]['extractedItems'][$iID] as $triID => $triSpec) {
                                $prevTrID = $triSpec['transaksi_id'];
                                $tru = new MdlTransaksi();
                                $tru->setFilters(array());
                                $tru->setTableName($tru->getTableNames()['detail']);

                                if ($triSpec['valid_qty'] >= $dSpec['produk_ord_jml']) {
                                    $newValidQty = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);
                                    cekmerah("validQty dikurangi oleh produk_ord_jml, yaitu " . $dSpec['produk_ord_jml']);
                                }
                                else {
                                    $newValidQty = ($triSpec['valid_qty'] - $triSpec['valid_qty']);
                                    cekmerah("validQty dikurangi oleh triSpec,  myaitu " . $triSpec['valid_qty']);
                                }
                                $itemFulfilledJml += $newValidQty;
                                //                                $newValidQty = ($triSpec['valid_qty'] - $dSpec['produk_ord_jml']);
                                $updateContents = array(
                                    "valid_qty" => $newValidQty,
                                );
                                if ($newValidQty < 1) {
                                    $childPrevRepaclers = array(
                                        "next_substep_code" => "",
                                        "next_substep_label" => "",
                                        "next_subgroup_code" => "",
                                        "sub_tail_number" => $stepNum,
                                        "sub_tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                                    );
                                    foreach ($childPrevRepaclers as $key => $val) {
                                        $updateContents[$key] = $val;
                                    }
                                }
                                else {//==kalau ada yang tidak habis, berarti TIDAK seluruhnya yang dilanjutkan pada step berikutnya
                                    $seluruhnya = false;
                                }
                                $dupState = $tru->updateData(array(
                                    "produk_id" => $iID,
                                    "id" => $triID,
                                    //                            "transaksi_id" => $trID,
                                    "transaksi_id" => $triSpec['transaksi_id'],
                                ), $updateContents) or die("Failed to update previous detail entries!");
                                $mongUpdateList['update']['detail'][] = array(
                                    "where" => array(
                                        "produk_id" => $iID,
                                        "id" => $triID,
                                        //                            "transaksi_id" => $trID,
                                        "transaksi_id" => $triSpec['transaksi_id'],
                                    ),
                                    "value" => $updateContents,
                                );
                                cekHijau(__LINE__ . " " . $this->db->last_query());
                                unset($tru);
                            }
                        }
                    }

                }
            }

            if ($seluruhnya) {
                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $prevTrID), array(
                    "tail_number" => $stepNum,
                    "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                    "status_4" => $_SESSION[$cCode]['main']['status_4'],
                    "trash_4" => $_SESSION[$cCode]['main']['trash_4'],
                )) or die("Failed to update tr next-state!");
                $mongUpdateList['update']['main'][] = array(
                    "where" => array(
                        "id" => $prevTrID,
                    ),
                    "value" => array(
                        "tail_number" => $stepNum,
                        "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['target'],
                        "status_4" => $_SESSION[$cCode]['main']['status_4'],
                        "trash_4" => $_SESSION[$cCode]['main']['trash_4'],
                    ),
                );
                cekHijau(":: UOPDATE transaksi dengan trID -> $prevTrID");
                cekHijau(__LINE__ . " " . $this->db->last_query());
            }

            if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $iID => $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detail'][] = $dd;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2'] as $iID => $dSpec) {
                    $dd = $tr->writeDetailEntries($insertID, $dSpec);
                    $insertIDs[] = $dd;
                    $mongoList['detail'][] = $dd;
                    if ($epID != 999) {
                        $dd = $tr->writeDetailEntries($epID, $dSpec);
                        $insertIDs[] = $dd;
                        $mongoList['detail'][] = $dd;
                    }
                    cekUngu(__LINE__ . " " . $this->db->last_query());
                }
            }
            //endregion

            //            arrPrint($_SESSION[$cCode]['main']);
            //            arrPrint($this->config->item("heTransaksi_ui")[$this->jenisTr]['updateDueDate']);
            if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['updateDueDate'][$stepNum])) {
                $dueDateConf = $this->config->item("heTransaksi_ui")[$this->jenisTr]['updateDueDate'][$stepNum];
                $sourceDue = $dueDateConf['source'];
                $targetDue = $dueDateConf['target'];
                $datenow = date("Y-m-d");
                foreach ($sourceDue as $key => $val) {
                    $indexVal = isset($_SESSION[$cCode]['main_elements'][$key][$val]) ? $_SESSION[$cCode]['main_elements'][$key][$val] : 14;
                    $dueDate = dueDate($datenow, $indexVal);
                }
                $fieldDue = $tr->getFields()["dueDate"];
                $dataDue = array();
                foreach ($fieldDue as $kol) {
                    if (isset($_SESSION[$cCode]['tableIn_master'][$kol])) {
                        $dataDue[$kol] = $_SESSION[$cCode]['tableIn_master'][$kol];
                    }
                }
                $dataDue['due_date'] = $dueDate;
                $validateDue = validateDueDate($_SESSION[$cCode]['main']['customerID'], $_SESSION[$cCode]['main']['dtime']);

                arrPrint($validateDue);
                if ($validateDue['allow_create'] == "true") {
                    if (isset($_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen']) && $_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen'] > 0) {
                        cekBiru($_SESSION[$cCode]['main']['nilai_tambah_hutang_ke_konsumen']);

                        $tr->writeDueDate($insertID, $dataDue);
                    }
                }
                else {
                    $allowedOver = validateOverDue($_SESSION[$cCode]['main']['customerID']);
                    if ($allowedOver['status'] == "allowed") {

                    }
                    else {
                        matiHere($validateDue['error']);//matiin transaksi sudah over due
                    }
                    //                    arrPrint()
                    //                    matiHere($validateDue['error']);//matiin transaksi sudah over due
                }
                //                matiHere();
                //update main elementnya
                foreach ($targetDue as $keyTarget => $valTarget) {
                    $_SESSION[$cCode]['main_elements'][$keyTarget][$valTarget] = $dueDate;
                    $_SESSION[$cCode]['main']['dueDate'] = $dueDate;
                }
            }
            //            arrPrint( $_SESSION[$cCode]['main_elements']);
            //matiHere("line__".__LINE__);


            $baseRegistries = array(
                'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][$stepNum] : array(),
                "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$stepNum] : array(),
                "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][$stepNum] : array(),
                "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][$stepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][$stepNum] : array(),
            );


            $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            $mongRegID = $doWriteReg;
        }
        //endregion


        //        validateAllBalances();

        //
        //region processing sub-post-processors, always
        //<editor-fold desc="----------sub postProc">

        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['detail'] : array();
        if (sizeof($iterator) > 0) {
            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "sub-postProcessor: $comName, initializing values <br>";
                //                arrPrint($_SESSION[$cCode][$srcGateName]);
                $tmpOutParams[$cCtr] = array();
                foreach ($_SESSION[$cCode][$srcGateName] as $cnt => $dSpec) {
                    $subParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                            $subParams['loop'][$key] = $realValue;

                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cnt], $_SESSION[$cCode][$srcGateName][$cnt], 0);
                            $subParams['static'][$key] = $realValue;
                            cekBiru("$key diisi dengan $realValue");

                        }

                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            foreach ($paramPatchers[$comName] as $k => $v) {
                                if (!isset($subParams['static'][$k])) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                }
                            }
                        }
                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                cekorange(":: $key diisikan dengan " . $subParams['static'][$k]);
                            }
                        }

                        $subParams['static']["fulldate"] = date("Y-m-d");
                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }

                    if (sizeof($subParams) > 0) {
                        $tmpOutParams[$cCtr][] = $subParams;
                    }
                }
            }

            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "sub-postProcessor: $comName, sending values <br>";

                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();

                $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
            }
        }


        //</editor-fold>
        //endregion

        //
        //region processing main-post-processors, always
        //<editor-fold desc="----------postProc">

        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][$stepNum]['master'] : array();
        if (sizeof($iterator) > 0) {
            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "post-processor: $comName<br>" . __LINE__;

                $dSpec = $_SESSION[$cCode][$srcGateName];
                $tmpOutParams = array();
                if (isset($tComSpec['loop'])) {
                    foreach ($tComSpec['loop'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['loop'][$key] = $realValue;

                    }
                }
                if (isset($tComSpec['static'])) {
                    //cekHere("DISINI OIII");
                    foreach ($tComSpec['static'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['static'][$key] = $realValue;

                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            if (!isset($tmpOutParams['static'][$k])) {
                                $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                        }
                    }
                    $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }
                if (isset($tComSpec['static2'])) {
                    //cekHere("DISINI OIII");
                    foreach ($tComSpec['static2'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                        $tmpOutParams['static2'][$key] = $realValue;

                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            if (!isset($subParams['static'][$k])) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                        }
                    }
                    $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }

                //lgShowError("Ada kesalahan",);
                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();

                //cekBiru("kiriman komponem $comName");
                //                    arrPrint($tmpOutParams);
                $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


            }
        }


        //</editor-fold>
        //endregion


        //
        //region ----------subcomponents
        //<editor-fold desc="----------subcomponents">

        //arrPrint($paramForceFillers);
        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['detail'] : array();
        if (sizeof($iterator) > 0) {
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $filterNeeded = false;
            if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                $filterNeeded = true;
            }
            foreach ($iterator as $cCtr => $tComSpec) {
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "sub-component: $comName, $srcGateName, initializing values <br>";
                $tmpOutParams[$cCtr] = array();
                foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
                    cekmerah("mengevaluasi $srcGateName..");
                    //						$id = $dSpec['id'];
                    $subParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                            $subParams['loop'][$key] = $realValue;
                            cekKuning("LOOP: $key diisi dengan $realValue");

                            if ($filterNeeded) {
                                if ($subParams['loop'][$key] == 0) {
                                    unset($subParams['loop'][$key]);
                                }
                            }
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                            $subParams['static'][$key] = $realValue;
                            cekKuning("STATIC: $key diisi dengan $realValue");

                        }
                        if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                            foreach ($paramPatchers[$comName] as $k => $v) {
                                if (!isset($subParams['static'][$k])) {
                                    $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                    cekOrange("fill :: $comName :: $k => " . $subParams['static'][$k]);
                                }
                            }
                        }
                        if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                            //                            cekOrange("comName:: $comName");
                            $jenis = $_SESSION[$cCode]['main']['jenis'];
                            foreach ($paramForceFillers[$comName] as $k => $v) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                                cekOrange("fillforce :: $comName :: $k => " . $subParams['static'][$k]);
                            }
                        }
                        $subParams['static']["fulldate"] = date("Y-m-d");
                        $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                    }
                    cekHitam("cetak subParams");
                    arrPrint($subParams);
                    if (sizeof($subParams) > 0) {
                        if ($filterNeeded) {
                            if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                        else {

                            $tmpOutParams[$cCtr][] = $subParams;
                        }
                    }
                }
            }


            $it = 0;
            foreach ($iterator as $cCtr => $tComSpec) {
                $it++;


                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                //                    cekbiru("outparamnya komponen $comName");
                //                    arrprint($tmpOutParams[$cCtr]);
                //                    cekbiru("EO outparamnya komponen $comName");

                echo "sub component #$it: $comName, sending values <br>";

                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();


                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                    $tobeExecuted = true;
                }
                else {
                    $tobeExecuted = false;
                }


                //cekHitam("kiriman sub-component $comName");
                //                    cekMerah($comName . ", tobe-executed: $tobeExecuted");
                //                    arrPri nt($tmpOutParams[$cCtr]);
                if ($tobeExecuted) {
                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
                else {
                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                }
            }
        }
        else {
            //cekKuning("subcomponents is not set");
        }


        //</editor-fold>
        //endregion
        //        mati_disini("End of ...");
        //
        //region ----------components
        //<editor-fold desc="----------components">


        $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$stepNum]['master'] : array();
        if (sizeof($iterator) > 0) {
            $it = 0;
            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            foreach ($iterator as $cCtr => $tComSpec) {
                $it++;
                $comName = $tComSpec['comName'];
                $srcGateName = $tComSpec['srcGateName'];
                $srcRawGateName = $tComSpec['srcRawGateName'];
                echo "component #$it: $comName<br>";

                $dSpec = $_SESSION[$cCode][$srcGateName];
                $tmpOutParams = array();
                if (isset($tComSpec['loop'])) {
                    foreach ($tComSpec['loop'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['loop'][$key] = $realValue;

                    }
                }
                if (isset($tComSpec['static'])) {
                    foreach ($tComSpec['static'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['static'][$key] = $realValue;
                        cekHijau(":: NORMAL :: $key => $realValue ::");
                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        cekHijau(":: masuk ke PATCHER ::");
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            cekHijau(":: ada yang mau di-PATCHER ::");
                            arrPrint($tmpOutParams['static']);
                            if (!isset($tmpOutParams['static'][$k])) {
                                $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                                cekHijau(":: PATCHER :: $key => $realValue ::");
                            }

                        }
                    }
                    else {
                        cekMerah(":: TIDAK TERMASUK PATCHER ::");
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $tmpOutParams['static'][$k] = isset($$v) ? $$v : "_v";
                            cekHijau(":: FORCEFILL :: $key => $realValue ::");
                        }
                    }
                    $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }
                if (isset($tComSpec['static2'])) {
                    foreach ($tComSpec['static2'] as $key => $value) {

                        $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                        $tmpOutParams['static2'][$key] = $realValue;

                    }
                    if (isset($paramPatchers[$comName]) && sizeof($paramPatchers[$comName]) > 0) {
                        foreach ($paramPatchers[$comName] as $k => $v) {
                            if (!isset($subParams['static'][$k])) {
                                $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                            }
                        }
                    }
                    if (isset($paramForceFillers[$comName]) && sizeof($paramForceFillers[$comName]) > 0) {
                        $jenis = $_SESSION[$cCode]['main']['jenis'];
                        foreach ($paramForceFillers[$comName] as $k => $v) {
                            $subParams['static'][$k] = isset($$v) ? $$v : "_v";
                        }
                    }
                    $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                    $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                    $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                }

                //lgShowError("Ada kesalahan",);
                $mdlName = "Com" . ucfirst($comName);
                $this->load->model("Coms/" . $mdlName);
                $m = new $mdlName();

                //===filter value nol, jika harus difilter
                $tobeExecuted = true;

                if (in_array($mdlName, $compValidators)) {

                    $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                    if (sizeof($loopParams) > 0) {
                        foreach ($loopParams as $key => $val) {
                            cekmerah("$comName : $key = $val ");
                            if ($val == 0) {
                                unset($tmpOutParams['loop'][$key]);
                            }
                        }
                    }
                    if (sizeof($tmpOutParams['loop']) < 1) {
                        $tobeExecuted = false;
                    }

                }


                if ($tobeExecuted) {
                    cekBiru("kiriman komponen $comName");
                    arrPrint($tmpOutParams);
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
                else {
                    cekBiru("komponem $comName tidak memenuhi syarat untuk ditulis");
                }


            }
        }
        else {
            //cekKuning("components is not set");
        }


        //</editor-fold>
        //endregion


        //        //
        //        //  region //cek lajur dan neraca
        ////        if (sizeof($steps) == 1) {//==nggak pakai step2 lanjutan
        //
        //        $mdlName = "ComLedger";
        //        $this->load->model("Mdls/".$mdlName);
        //        $l = new ComLedger();
        //        $l->addFilter("periode='forever'");
        ////        $date = date("Y-m-d");
        //        $tmp = $l->getLastEntries();
        ////                arrPrint($tmp);
        //        $arrHasilLajur = $l->getLajurBalance($tmp);
        //        $arrHasilNeraca = $l->getNeracaBalance($tmp);
        //
        ////            if (is_null($arrHasilLajur)) {
        ////                mati_disini("UN-BALANCE... LAJUR");
        ////            } else {
        ////                //cekBiru("BALANCE LAJUR...");
        ////            }
        ////
        ////            if (is_null($arrHasilNeraca)) {
        ////                mati_disini("UN-BALANCE... NERACA");
        ////            } else {
        ////                arrPrint($arrHasilNeraca);
        ////                //cekBiru("BALANCE NERACA...");
        ////            }
        //
        ////        }
        //        //  endregion //cek lajur dan neraca

        //
        //region nulis paymentSource
        $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['target'];
        $paymentSources = $this->config->item("payment_source");
        if (array_key_exists($stepCode, $paymentSources)) {
            $payConfigs = isset($paymentSources[$stepCode][$stepNum]) ? $paymentSources[$stepCode][$stepNum] : array();
            if (sizeof($payConfigs) > 0) {
                foreach ($payConfigs as $paymentSrcConfig) {
                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                    $valueSrc = $paymentSrcConfig['valueSrc'];
                    $externSrc = $paymentSrcConfig['externSrc'];
                    if (isset($_SESSION[$cCode]['main'][$valueSrc]) && $_SESSION[$cCode]['main'][$valueSrc] > 0) {
                        $tr->writePaymentSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $tmpNomorNota2,
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                            "tagihan_valas" => isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                            "terbayar_valas" => 0,
                            "sisa_valas" => isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                        ));
                    }
                    //cekHitam($valueSrc);
                    //                    cekHitam($_SESSION[$cCode]['main'][$valueSrc]);

                    cekMerah(__LINE__ . " " . $this->db->last_query());
                }
            }

        }
        else {
            //cekMerah("TIDAK nulis paymentSrc");
        }

        //matiHere("hoopppp");
        //cek additional step
        $addPaymentSource = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['additionalStep']['shippingService']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['additionalStep']['shippingService'] : array();
        //        arrPrint($addPaymentSource);
        //endregion


        //
        //region nulis paymentAntiSource
        $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNum]['target'];
        $paymentSources = $this->config->item("payment_antiSource");
        if (array_key_exists($stepCode, $paymentSources)) {
            cekMerah(":: starting PAYMENT ANTI SOURCE");
            $payConfigs = $paymentSources[$stepCode];
            if (sizeof($payConfigs) > 0) {
                foreach ($payConfigs as $paymentSrcConfig) {
                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                    $valueSrc = $paymentSrcConfig['valueSrc'];
                    $externSrc = $paymentSrcConfig['externSrc'];
                    $tr->writePaymentAntiSrc($insertID, array(
                        "jenis" => $stepCode,
                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                        "nomer" => $tmpNomorNota2,
                        "label" => $paymentSrcConfig['label'],
                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                        "terbayar" => 0,
                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                        "oleh_id" => $this->session->login['id'],
                        "oleh_nama" => $this->session->login['nama'],
                        "dtime" => date("Y-m-d H:i:s"),
                        "fulldate" => date("Y-m-d"),
                    ));
                    //cekMerah(__LINE__. " " .$this->db->last_query());
                }
            }

        }
        else {
            //cekMerah("TIDAK nulis paymentSrc");
        }
        //endregion

        validateAllBalances();
        //        validateAllBalancesPeriode();

        //        $masterID = $insertID;
        //
        //region connecting antar cabang
        //cekMerah("//cek connecting dari $origJenis========================================");
        $steps = isset($this->config->item("heTransaksi_ui")[$origJenis]['steps']) ? $this->config->item("heTransaksi_ui")[$origJenis]['steps'] : array();
        $connector = isset($this->config->item("heTransaksi_ui")[$origJenis]['connectTo']) ? $this->config->item("heTransaksi_ui")[$origJenis]['connectTo'] : "";
        $mongoListConnect = array();
        $mongRegIDConnect = array();
        if (strlen($connector) > 0) {
            cekMerah("to be connected to $connector");
            if ($stepNum == sizeof($steps)) {
                cekMerah("now connecting to $connector");
                if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                    die("kode connector tidak dikenali!");
                }
                if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                    die("konfigurasi connector harus memiliki step lebih dari satu!");
                }


                $oldCode = $cCode;
                $cCode = "_TR_" . $connector;

                $_SESSION[$cCode] = array();

                $_SESSION[$cCode] = array(
                    "main" => $_SESSION[$oldCode]['main'],
                    "items" => $_SESSION[$oldCode]['items'],

                    "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                    "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                    //
                    "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                    //                    "out_detail_rsltItems" => $_SESSION[$oldCode]['out_detail_rsltItems'],
                    "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                    //
                    "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                    "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                    "tableIn_detail_values_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'],
                );

                //                    print_r($_SESSION[$cCode]);die();

                //==replace pertama
                $masterReplacersO = array(
                    "jenisTr" => $connector,
                    "jenisTrMaster" => $connector,
                    "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                    "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "placeID" => $_SESSION[$cCode]['main']['place2ID'],
                    "placeName" => $_SESSION[$cCode]['main']['place2Name'],
                    "place2ID" => $_SESSION[$cCode]['main']['placeID'],
                    "place2Name" => $_SESSION[$cCode]['main']['placeName'],
                    "cabangID" => $_SESSION[$cCode]['main']['place2ID'],
                    "cabangName" => $_SESSION[$cCode]['main']['place2Name'],
                    "cabang2ID" => $_SESSION[$cCode]['main']['placeID'],
                    "cabang2Name" => $_SESSION[$cCode]['main']['placeName'],
                    //
                    "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                    "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                    "gudangID" => $_SESSION[$cCode]['main']['gudang2ID'],
                    "gudangName" => $_SESSION[$cCode]['main']['gudang2Name'],

                );
                foreach ($masterReplacersO as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    //                    $_SESSION[$cCode]['main'][$key] = $val;
                }
                $masterReplacers = array(
                    //                    "referensi_id" => $masterID, (dimatikan)
                    "inv" => $tmpNomorNota,
                    "jenis_master" => $connector,
                    "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                    "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                    "cabang_id" => $_SESSION[$cCode]['tableIn_master']['cabang2_id'],
                    "cabang_nama" => $_SESSION[$cCode]['tableIn_master']['cabang2_nama'],
                    "cabang2_id" => $_SESSION[$cCode]['tableIn_master']['cabang_id'],
                    "cabang2_nama" => $_SESSION[$cCode]['tableIn_master']['cabang_nama'],
                    "gudang_id" => $_SESSION[$cCode]['tableIn_master']['gudang2_id'],
                    "gudang_nama" => $_SESSION[$cCode]['tableIn_master']['gudang2_nama'],
                    "gudang2_id" => $_SESSION[$cCode]['tableIn_master']['gudang_id'],
                    "gudang2_nama" => $_SESSION[$cCode]['tableIn_master']['gudang_nama'],
                    "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                    "step_current" => 1,
                    "step_number" => 1,
                    "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                    "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                    "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                    "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                    //===references
                    //                    "id_master"            => $masterID,
                    //                    "id_top"               => $topID,
                    //                    "ids_prev"             => base64_encode(serialize(array($prevProp['id']))),
                    //                    "ids_prev_intext"      => print_r(array($prevProp['id'], true)),
                    //                    "nomer_top"            => $_SESSION[$cCode]['main']['nomer'],
                    //                    "nomers_prev"          => base64_encode(serialize(array($prevProp['nomer']))),
                    //                    "nomers_prev_intext"   => print_r(array($prevProp['nomer'], true)),
                    //                    "jenis_top"            => $this->jenisTr,
                    //                    "jenises_prev"        => base64_encode(serialize(array($prevProp['jenis']))),
                    //                    "jenises_prev_intext" => print_r(array($prevProp['jenis'], true)),
                );

                foreach ($masterReplacers as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }


                //region penomoran receipt #2
                //<editor-fold desc="==========penomoran">
                $this->load->model("CustomCounter");
                $cn = new CustomCounter("transaksi");
                $cn->setType("transaksi");

                $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                    die(__LINE__ . " Used number should be registered in 'counters' config as well");
                }

                foreach ($counterForNumber as $i => $cRawParams) {
                    $cParams = explode("|", $cRawParams);
                    $cValues = array();
                    foreach ($cParams as $param) {
                        //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                        $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
                    }
                    $cRawValues = implode("|", $cValues[$i]);
                    $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                }

                $tmpNomorNota2 = $paramSpec['paramString'];


                //</editor-fold>
                //endregion

                //region dynamic counters #2
                // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                $cn = new CustomCounter("transaksi");
                $cn->setType("transaksi");
                $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                $configCustomParams[] = "stepCode";
                if (sizeof($configCustomParams) > 0) {
                    $cContent = array();
                    foreach ($configCustomParams as $i => $cRawParams) {
                        $cParams = explode("|", $cRawParams);
                        $cValues = array();
                        foreach ($cParams as $param) {
                            $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                        }
                        $cRawValues = implode("|", $cValues[$i]);
                        $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                        $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                        switch ($paramSpec['id']) {
                            case 0: //===counter type is new
                                $paramKeyRaw = print_r($cParams, true);
                                $paramValuesRaw = print_r($cValues[$i], true);
                                $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                break;
                            default: //===counter to be updated
                                $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                break;
                        }
                        //echo "<hr>";
                    }
                }
                $appliedCounters2 = base64_encode(serialize($cContent));
                $appliedCounters_inText2 = print_r($cContent, true);
                // </editor-fold>
                //endregion


                $addValues = array(
                    'counters' => $appliedCounters2,
                    'counters_intext' => $appliedCounters_inText2,
                    'nomer' => $tmpNomorNota,
                    'dtime' => date("Y-m-d H:i:s"),
                    'fulldate' => date("Y-m-d"),
                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

                //===cloning nota cab1 ke cab2
                //===daftar perbedaan
                //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,

                //==replace kedua
                $masterReplacers = array(
                    "nomer" => $tmpNomorNota2,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                foreach ($masterReplacers as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

                //===cloning detail/items cabang1 ke cabang2
                //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                $detailReplacers = array(
                    "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                    "sub_step_current" => 1,
                    "sub_step_number" => 1,
                    "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                    "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                    "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                    "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                    //                    "next_substep_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                    //                    "next_substep_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                    //                    "next_subgroup_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                );
                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                    //                    cekmerah("tulis rincian transaksi kedua");
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                        foreach ($dSpec as $key => $val) {
                            $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                        }
                    }
                }
                else {
                    //                    cekmerah("GAGAL tulis rincian transaksi kedua");
                }


                //region ----------write transaksi & transaksi_data #2
                if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                    $tr = new MdlTransaksi();
                    $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                    $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                    cekUngu(__LINE__ . " " . $this->db->last_query());
                    $epID = $tr->writeMainEntries_entryPoint($insertID, $masterID, $_SESSION[$cCode]['tableIn_master']);
                    $mongoListConnect['main'] = array($insertID, $epID);
                    $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                    $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                    cekmerah("tulis transaksi kedua :: trID $insertID");
                    cekmerah(__LINE__ . " " . $this->db->last_query());
                    if ($insertID < 1) {
                        die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                    }
                }
                else {
                    cekmerah("GAGAL tulis transaksi kedua");
                }

                if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                    foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $inserMainValues[] = $dd;
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                }


                if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                    foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                        $dd = $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                        $inserMainValues[] = $dd;
                        $mongoListConnect['mainValues'][] = $dd;
                    }
                }
                if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                    foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                        $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                    }
                }

                if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                    //                    cekMerah("ada mainElements");
                    foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                        $tr->writeMainElements($insertID, array(
                            "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                            "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                            "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                            "name" => $aSpec['name'],
                            "label" => $aSpec['label'],
                            "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                            "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                        ));
                    }
                }
                else {
                    //                    cekMerah("TAK ada mainElements");
                }

                if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                    $insertIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                        $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                        $insertIDs[] = $insertDetailID;
                        $mongoListConnect['detail'][] = $insertDetailID;
                        if ($epID != 999) {
                            $insertDetailID = $tr->writeDetailEntries($epID, $dSpec);
                            $insertIDs[] = $insertDetailID;
                            $mongoListConnect['detail'][] = $insertDetailID;
                        }
                    }
                }

                if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                    $insertIDs = array();
                    foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                        $insertDetailID = $tr->writeDetailEntries($insertID, $dSpec);
                        $insertIDs[] = $insertDetailID;
                        $mongoListConnect['detail'][] = $insertDetailID;
                        if ($epID != 999) {
                            $insertDetailID = $tr->writeDetailEntries($epID, $dSpec);
                            $insertIDs[] = $insertDetailID;
                            $mongoListConnect['detail'][] = $insertDetailID;
                        }
                    }
                }

                if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                    foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                            foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => $dSpec[$src],
                                ));
                                $insertIDs[] = $dd;
                                $mongoListConnect['detailValues'][] = $dd;

                            }
                        }
                    }
                }


                if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                    foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                            foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                $dd = $tr->writeDetailValues($insertID, array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => $dSpec[$src],
                                ));
                                $insertIDs[] = $dd;
                                $mongoListConnect['detailValues'][] = $dd;

                            }
                        }
                    }
                }

                //
                //region nulis paymentSource
                //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                $paymentSources = $this->config->item("payment_source");
                if (array_key_exists($stepCode, $paymentSources)) {

                    $payConfigs = $paymentSources[$stepCode];
                    if (sizeof($payConfigs) > 0) {
                        foreach ($payConfigs as $paymentSrcConfig) {
                            //					$paymentSrcConfig = $paymentSources[$stepCode];
                            $valueSrc = $paymentSrcConfig['valueSrc'];
                            $externSrc = $paymentSrcConfig['externSrc'];
                            $tr->writePaymentSrc($insertID, array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $tmpNomorNota2,
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                "terbayar" => 0,
                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                "terbayar_valas" => 0,
                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                            ));
                        }
                    }


                    //cekMerah(__LINE__. " " .$this->db->last_query());

                }
                else {
                    //cekMerah("TIDAK nulis paymentSrc");
                }
                //endregion


                //region nulis paymentAntiSource
                //                $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
                $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                $paymentSources = $this->config->item("payment_antiSource");
                if (array_key_exists($stepCode, $paymentSources)) {
                    $payConfigs = $paymentSources[$stepCode];
                    if (sizeof($payConfigs) > 0) {
                        foreach ($payConfigs as $paymentSrcConfig) {
                            //					$paymentSrcConfig = $paymentSources[$stepCode];
                            $valueSrc = $paymentSrcConfig['valueSrc'];
                            $externSrc = $paymentSrcConfig['externSrc'];
                            $tr->writePaymentAntiSrc($insertID, array(
                                "jenis" => $stepCode,
                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                "nomer" => $tmpNomorNota2,
                                "label" => $paymentSrcConfig['label'],
                                "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                "terbayar" => 0,
                                "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                "oleh_id" => $this->session->login['id'],
                                "oleh_nama" => $this->session->login['nama'],
                                "dtime" => date("Y-m-d H:i:s"),
                                "fulldate" => date("Y-m-d"),
                            ));
                        }
                    }


                    //cekMerah(__LINE__. " " .$this->db->last_query());

                }
                else {
                    //cekMerah("TIDAK nulis paymentSrc");
                }
                //endregion


                $idHis_decode[$stepNum] = array(
                    "step" => $stepNum,
                    "trID" => $insertID,
                    "nomer" => $tmpNomorNota2,
                    "counters" => $appliedCounters2,
                    "counters_intext" => $appliedCounters_inText2,
                );
                $idHis_blob = blobEncode($idHis_decode);
                $idHis_intext = print_r($idHis_decode, true);

                $_SESSION[$cCode]['tableIn_master']['ids_his'] = $idHis_blob;
                $_SESSION[$cCode]['tableIn_master']['ids_his_intext'] = $idHis_intext;

                $tr = new MdlTransaksi();
                $dupState = $tr->updateData(array("id" => $insertID), array(
                    "id_master" => $masterID,
                    "id_top" => $insertID,

                    "ids_his" => $idHis_blob,
                    "ids_his_intext" => $idHis_intext,

                )) or die("Failed to update tr next-state!");

                //                if($seluruhnya){
                //                    $dupState = $tr->updateData(array("id" => $insertID), array(
                //                        "tail_number" => $nextStepNum,
                //                        "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$nextStepNum]['target'],
                //
                //                    )) or die("Failed to update trans tail!");
                //                }
                //cekHijau(__LINE__. " " .$this->db->last_query());


                $baseRegistries = array(
                    'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                    'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                    'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                    'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                    'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                    'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                    'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                    'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                    'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                    'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                    'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                    'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                    'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                    'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                    'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                    'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                    'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                    'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                    'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                    'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                    'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                    "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                    "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                    "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                    "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                );
                $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
                $mongRegIDConnect = $doWriteReg;
                //endregion
            }
            else {
                //cekMerah("to be delayed to connect to $connector");
            }
        }
        else {
            //cekKuning("not connecting to any tCode");
        }

        //endregion

        //region nonactive allowed shipment
        $cekvalidateOverDue = validateOverDue($_SESSION[$cCode]['main']['customerID']);
        if ($cekvalidateOverDue['status'] = "allowed") {
            $this->load->model("Mdls/MdlOverDuePass");
            $od = new MdlOverDuePass();
            $where = array(
                "customers_id" => $_SESSION[$cCode]['main']['customerID'],
                "jenis" => "forever",
            );
            $arrUpdate = array(
                "status" => "0",
                "used_byID" => $_SESSION['login']['nama'],
                "used_byNama" => $_SESSION['login']['nama'],
                "used_id" => $insertID,
                "nomor" => $tmpNomorNota,

            );
            $od->updateData($where, $arrUpdate, $od->getTableName());
        }


        //endregion


        //==================================================================================================
        //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
        if ($transaksiID_reference > 0) {

            $this->load->model("Mdls/MdlLockerTransaksi");
            $lt = New MdlLockerTransaksi();
            $lt->execLocker($_SESSION[$cCode]['main'], 0, $transaksiID_reference, NULL);

        }
        //==================================================================================================


        //==tampilkan receipt
        cekOrange("-- DONE --");
        //region writelog
        $this->load->model("Mdls/" . "MdlActivityLog");
        $hTmp = new MdlActivityLog();
        $tmpHData = array(
            "title" => $_SESSION[$cCode]['main']['jenisTrName'],
            "sub_title" => "Saving followup process",
            "uid" => $this->session->login['id'],
            "uname" => $this->session->login['nama'],
            "dtime" => date("Y-m-d H:i:s"),
            "transaksi_id" => $insertID,
            "deskripsi_old" => "",
            "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
            "jenis" => $this->jenisTr,
            "ipadd" => $_SERVER['REMOTE_ADDR'],
            "devices" => $_SERVER['HTTP_USER_AGENT'],
            "category" => "transaksi",
            "controller" => $this->uri->segment(1),
            "method" => $this->uri->segment(2),
            "url" => current_url(),

        );
        $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Line: " . __LINE__ . " - Gagal menulis riwayat data", __FILE__));
        //endregion


        //        cekMerah("minggiiirr");
        //                mati_disini("*** stopp belon comit ***");

        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        //region cloning ke mongo
        //region update transaksi transaksi data mongo prev step
        if (sizeof($mongUpdateList) > 0) {
            $mong = new MdlMongoMother();
            foreach ($mongUpdateList as $metode => $tmpData) {
                if ($metode == "update") {
                    if (sizeof($tmpData) > 0) {
                        foreach ($tmpData as $gate => $fildsData) {
                            //                            arrPrint($fildsData);
                            $mong->setTableName($this->mongoTableList[$gate]);
                            foreach ($fildsData as $mongUpadte) {
                                $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                            }
                        }
                    }
                }

            }
        }
        //endregion

        //region write transaksional mongo
        if (sizeof($mongoList) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongoList as $gateList => $listIDSData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$gateList]);
                $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$gateList]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        //                        cekLime("nulis ke mongo broo:");
                        //                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }
                //                    cekHitam($listedTable[$gateList]);
                //                    cekLime($gateList);

            }

            //                matiHEre();

        }
        //endregion

        //region write Registry mongo current
        if (sizeof($mongRegID) > 0) {
            //            $mongRegID = $mongoList['main'];
            $tr->setTableName("transaksi_registry");
            $tr->setFilters(array());
            $tr->setSortBy(array());
            $tr->addFilter("id in (" . implode(",", $mongRegID) . ")");
            $tmpTrm = $tr->lookUpAll()->result();

            $mong->setTableName("transaksi_registry");
            if (sizeof($tmpTrm) > 0) {
                foreach ($tmpTrm as $tmpMain) {
                    $transksi_main = json_decode(json_encode($tmpMain), true);
                    //                    arrPrint($transksi_main);
                    $mong->addData($transksi_main);
                }
            }

        }
        //endregion

        //region mongo Connected
        if (sizeof($mongoListConnect) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongoListConnect as $connGate => $connData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$connGate]);
                $tr->addFilter("id in (" . implode(",", $connData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();
                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$connGate]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        $mong->addData($transksi_main);
                    }
                }
            }
        }
        if (sizeof($mongRegIDConnect) > 0) {
            //            $mongRegID = $mongRegIDConnect['main'];
            $tr->setTableName("transaksi_registry");
            $tr->setFilters(array());
            $tr->setSortBy(array());
            $tr->addFilter("id in (" . implode(",", $mongRegIDConnect) . ")");
            $tmpTrm = $tr->lookUpAll()->result();
            $mong->setTableName("transaksi_registry");
            if (sizeof($tmpTrm) > 0) {
                foreach ($tmpTrm as $tmpMain) {
                    $transksi_main = json_decode(json_encode($tmpMain), true);
                    $mong->addData($transksi_main);
                }
            }

        }


        //endregion

        //region pre purcash
        if (sizeof($mongPrePurcash) > 0) {
            $mong = new MdlMongoMother();
            $tr = new MdlTransaksi();
            foreach ($mongPrePurcash as $gateList => $listIDSData) {
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->setTableName($this->mongoTableList[$gateList]);
                $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                $tmpTrm = $tr->lookUpAll()->result();

                if (sizeof($tmpTrm) > 0) {
                    $mong->setTableName($this->mongoTableList[$gateList]);
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        $mong->addData($transksi_main);
                    }
                }
            }
            //            matiHere("pre purcash");
        }
        if (sizeof($mongPrePurcashReg) > 0) {
            //            $mongRegID = $mongPrePurcashReg['main'];
            $tr->setTableName("transaksi_registry");
            $tr->setFilters(array());
            $tr->setSortBy(array());
            $tr->addFilter("id in (" . implode(",", $mongPrePurcashReg) . ")");
            $tmpTrm = $tr->lookUpAll()->result();
            $mong->setTableName("transaksi_registry");
            if (sizeof($tmpTrm) > 0) {
                foreach ($tmpTrm as $tmpMain) {
                    $transksi_main = json_decode(json_encode($tmpMain), true);
                    $mong->addData($transksi_main);
                }
            }
        }

        //endregion

        //endregion
        if (isset($_SESSION[$cCode])) {
            unset($_SESSION[$cCode]);
        }
        if (isset($oldCode)) {
            if (isset($_SESSION[$oldCode])) {
                unset($_SESSION[$oldCode]);
            }
        }


        //region feedback msg
        $this->session->errMsg = "transaction entry has been saved<br>";
        $nextNum = $nextProp["num"];
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;

        }
        else {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;

        }
        $trBackClick = "location.href='$trBackLink'";
        //        $this->session->errMsg .= "<br><a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
        //endregion

        if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum])) {
            $printLocation = $this->config->item('heTransaksi_layout')[$this->jenisTr]['printLocation'];
            $printSettings = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum] : array();
            if (isset($printSettings['size'])) {
                switch ($printSettings['size']) {
                    case "normal":
                        //                        cekkuning("size: NORMAL");
                        echo "<script>";
                        echo "top.popBig('" . base_url() . $printLocation . "$tmpNomorNota2');";
                        echo "top.location.reload();";
                        echo "</script>";
                        break;
                    case "small":
                        //                        cekkuning("size: SMALL");
                        echo "<script>";
                        echo "top.popSmall('" . base_url() . $printLocation . "$tmpNomorNota2');";
                        echo "top.location.reload();";
                        echo "</script>";
                        break;
                    default:
                        //                        cekkuning("size: UNKNOWN");
                        break;
                }
            }
            else {
                $arrAlert = array(
                    "type" => "success",
                    "title" => "Transaction saved",
                    //                        "html" => "your order has been saved and ready to process",
                    "html" => $this->session->errMsg,
                    "timer" => "1500",
                    "showConfirmButton" => false,
                    "allowOutsideClick" => false,
                );
                echo swalAlert($arrAlert);
                echo "<script>topReload(1500)</script>";
                echo topReload();
                echo "</script>";
                unset($this->session->errMsg);
            }

        }
        else {
            $arrAlert = array(
                "type" => "success",
                "title" => "Transaction saved",
                //                        "html" => "your order has been saved and ready to process",
                "html" => $this->session->errMsg,
                "timer" => "1500",
                "showConfirmButton" => false,
                "allowOutsideClick" => false,
            );
            echo swalAlert($arrAlert);
            echo "<script>topReload(1500)</script>";
            echo topReload();
            echo "</script>";
            unset($this->session->errMsg);
        }


    }

    public function doPreEdit()
    {
        $no = rtrim($this->uri->segment(3), "-");

        //$targetStepNum = $this->uri->segment(4);
        $stepNumber = $this->uri->segment(4);
        $currentStepNum = $this->uri->segment(5);

        $rawBuilderURL = blobEncode(current_url());
        $editMode = array(
            "edit" => "$no",
        );


        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tmpTr = $tr->lookupJoined()->result();


        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {
                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }

        $rawItems = array();

        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $cCode = "_TR_" . $this->jenisTr;
            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber] : null;
            $measurementDetails = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"] : array();
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;
            $afterTargetStepNum = ($currentStepNum + 1);


            //==periksa apakah ada ganjalan
            $trA = new MdlTransaksi();
            //            $extSteps = $trA->lookupExtSteps($masterID);
            $extSteps = $trA->lookupExtSteps($trID);
            if (sizeof($extSteps) > 0) {
                cekmerah("ada ganjalan step sebanyak " . sizeof($extSteps));
            }
            else {
                cekhijau("TAK ada ganjalan step");
            }
            //            $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");
            $paySrcs = $trA->lookupPaymentSrcs($trID, $this->jenisTr . "_");
            if (sizeof($paySrcs) > 0) {
                cekmerah("ada ganjalan paymentSrc sebanyak " . sizeof($paySrcs));
            }
            else {
                cekhijau("TAK ada ganjalan paymentSrc");
            }


            $allowEdit = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit'] : false;
            $editableFields = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber] : array();


            //region valid items
            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            //            $tr->addFilter("transaksi_id='" . $trID . "'");
            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            //            $tr->addFilter("id_master='" . $masterID . "'");
            //            $tr->addFilter("step_number='" . $currentStepNum . "'");
            //            $tr->addFilter("sub_step_number='" . $currentStepNum . "'");
            //            $tr->addFilter("next_substep_code='" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['target'] . "'");
            //            $tr->addFilter("next_substep_num='$stepNumber'");
            $tr->addFilter("valid_qty>0");

            $tmpTr = $tr->lookupJoined()->result();
            //            cekhitam($this->db->last_query());


            $extractedItems = array();//==untuk urusan update transaksi referer
            $validItems = array();
            $validItemSends = array();
            if (sizeof($tmpTr) > 0) {
                cekmerah("ada yang mau diekstrak");
                foreach ($tmpTr as $row) {
                    if (!isset($validItems[$row->produk_id])) {
                        $validItems[$row->produk_id] = 0;
                    }
                    if (!isset($validItemSends[$row->produk_id])) {
                        $validItemSends[$row->produk_id] = 0;
                    }
                    $validItems[$row->produk_id] += $row->valid_qty;
                    $validItemSends[$row->produk_id] += $row->produk_ord_jml - $row->valid_qty;

                    if (!isset($extractedItems[$row->produk_id])) {
                        $extractedItems[$row->produk_id] = array();
                    }
                    $extractedItems[$row->produk_id][$row->id] = array(
                        "id" => $row->id,
                        "produk_id" => $row->produk_id,
                        "qty" => $row->produk_ord_jml,
                        "valid_qty" => $row->valid_qty,
                        "transaksi_id" => $row->transaksi_id,
                        "sent_qty" => $row->produk_ord_jml - $row->valid_qty,
                    );
                }
            }
            else {
                cekmerah("TIDAK ada yang mau diekstrak");
            }
            //            arrprint($validItems);
            //die();
            //            die();
            //endregion


            //
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //            //cekMerah($this->db->last_query());
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //            arrPrint($detailValues);
            //endregion


            //region take from registries
            //==ambil value-gate
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            //            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $tmpReg = $trr->lookupRegistries()->result();
            //            $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();
            cekKuning($this->db->last_query());
            $main = array();

            $items = array();
            $items2 = array();
            $items2_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();

            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();
            //            $mainApplets = array();
            $mainElements = array();
            $mainInputs = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = $main + unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = $items + unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = $items2 + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems"://
                            $rsltItems = $rsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems2"://
                            $rsltItems2 = $rsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = $items2_sum + unserialize(base64_decode($row->values));
                            break;

                        case "tableIn_master"://
                            $masterTableInParams = $masterTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = $childTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems"://
                            $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems2"://
                            $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems"://
                            $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems2"://
                            $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = $masterAddValues + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = $masterAddFields + unserialize(base64_decode($row->values));
                            break;
                        //                        case "main_applets"://
                        //                            $mainApplets = unserialize(base64_decode($row->values));
                        //                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "main_inputs"://
                            $mainInputs = unserialize(base64_decode($row->values));
                            break;
                    }
                }

            }
            else {
                die("Cannot read the registry entries from $masterID!");
            }
            //endregion


            $masterReplacers = array(
                "jenisTrMaster" => $this->jenisTr,
                "jenisTrTop" => $masterTableInParams['jenis_top'],
                "harga" => 0,
                "masterID" => $masterID,
            );
            foreach ($masterReplacers as $key => $src) {
                $main[$key] = $src;
                $mainValues[$key] = $src;
                $masterGates[$key] = $src;
            }


            //==revalidate items
            $this->load->library("FieldCalculator");
            $this->load->helper("he_angka");
            $cal = new FieldCalculator();


            if (sizeof($items) > 0) {
                //                $tipeSize =array();
                foreach ($items as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $tipeSize = isset($iSpec['detilSize']) && sizeof($iSpec['detilSize']) > 0 ? $iSpec['detilSize'] : "";

                    if (array_key_exists($id, $validItems)) {
                        $items[$id]['jml'] = $validItems[$id];
                        $items[$id]['max_jml'] = $validItems[$id];
                        $items[$id]['sent_jml'] = $validItemSends[$id];
                        if (sizeof($editableFields) > 0) {
                            foreach ($editableFields as $fName) {
                                $items[$id]["max_$fName"] = isset($iSpec[$fName]) ? $iSpec[$fName] : 0;
                            }
                        }

                        if (sizeof($measurementDetails)) {
                            if (in_array($stepNumber, $measurementDetails["allowView"]) && isset($measurementDetails[$tipeSize])) {
                                $selectedColl = $measurementDetails[$tipeSize];
                                foreach ($selectedColl as $colSelected => $tempHelper) {
                                    //                                    cekHitam("$heAngka");

                                    foreach ($tempHelper as $newKey => $heAngka) {
                                        cekHitam($newKey);
                                        $items[$id][$newKey] = $heAngka($iSpec[$colSelected]);
                                    }
                                    //
                                }
                            }

                        }


                        //                        if ($subAmountConfig != null) {
                        //                            $tmpEx = $cal->multiExplode($subAmountConfig);
                        //                            if (sizeof($tmpEx) > 1) {
                        //                                //                            echo lgShowAlert("menghitung subtotal pakai rumus $subAmountConfig di step ke # $stepNumber");
                        //                                $newSrc = $subAmountConfig;
                        //                                foreach ($tmpEx as $key2 => $val2) {
                        //                                    if (isset($items[$id][$val2])) {
                        //                                        $newSrc = str_replace($val2, $items[$id][$val2], $newSrc);
                        //
                        //                                    }
                        //                                    else {
                        //                                        if (isset($tmp[$val2])) {
                        //                                            $newSrc = str_replace($val2, $items[$val2], $newSrc);
                        //
                        //                                        }
                        //                                        else {
                        //                                            $newSrc = str_replace($val2, "0", $newSrc);
                        //
                        //                                        }
                        //                                    }
                        //
                        //
                        //                                }
                        //                                $subtotal = $cal->calculate($newSrc);
                        //
                        //
                        //                            }
                        //                            else {
                        //                                //                            echo lgShowAlert("memasang subtotal dari $subAmountConfig");
                        //                                $subtotal = $items[$id][$subAmountConfig];
                        //
                        //                            }
                        //                       }
                        //                        else {
                        //                            //                        echo lgShowAlert("tidak mengapa-apakan subtotal");
                        //                            $subtotal = 0;
                        //
                        //                        }
                        //                        //                    echo lgShowAlert("isi subtotal: $subtotal");
                        //                        $items[$id]['subtotal'] = $subtotal;
                    }
                    else {
                        unset($items[$id]);
                        unset($childGates[$id]);
                        unset($childTableInParams[$id]);
                        unset($childTableInValueParams[$id]);

                    }


                }
            }


            //region session-swapper
            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => $extractedItems,


                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                //        ""=>$childAddValues ,
                "main_add_fields" => $masterAddFields,
                //                "main_applets"          => $mainApplets,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                //
                "extSteps" => $extSteps,
                "paySrcs" => $paySrcs,
                "mode" => $editMode,

            );
            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;

            }
            //endregion


            //==init replacer
            //==recover nilai HARGA master
            $_SESSION[$cCode]['main']['harga'] = 0;

            if (sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);
                    //                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);
                }
            }

        }
        else {
            die(lgShowAlert("No such transaction. You may want to refresh the browser to re-fetch actual content."));
        }

        //            $link = base_url() . "Transaksi/editForm/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "?rawBuilderURL=$rawBuilderURL";
        $link = base_url() . "Transaksi/createForm/" . $this->uri->segment(4);
        topRedirect($link);

        die();


    }

    public function editForm()
    {

        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        arrPrint($this->uri->segment_array());
        //cekHitam("putihhh");
        //===pageView options
        if (!isset($_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'])) {
            $viewModeConfig = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['defaultViewMode']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['defaultViewMode'] : "list";
            $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] = isset($_GET['viewMode']) ? $_GET['viewMode'] : $viewModeConfig;
        }
        //        die();
        $viewModeSpec = array(
            "icon" => "",
            "url" => "",
        );
        $thisPage = base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3);
        switch ($_SESSION["opt_" . $this->jenisTr]['opt']['viewMode']) {
            case "list":
                $viewModeSpec = array(
                    "icon" => "	glyphicon glyphicon-th-large",
                    "url" => $thisPage . "?viewMode=thumbnail",
                );
                break;
            case "thumbnail":
                $viewModeSpec = array(
                    "icon" => "glyphicon glyphicon-align-justify",
                    "url" => $thisPage . "?viewMode=list",
                );
                break;
        }
        $viewModeSwitch = "<a href='javascript:void(0)' onclick=\"location.href='" . $viewModeSpec['url'] . "';\"><span class='" . $viewModeSpec['icon'] . "'></span></a>";


        if (!isset($this->session->login['id'])) {
            redirect(base_url() . "Login");
        }
        //die();

        $jenisTr = $this->uri->segment(4);
        $this->jenisTr = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;
        //        arrPrint($_SESSION[$cCode]);
        //        matiHere();
        //        heInitCart($jenisTr);
        //        arrPrint($jenisTr);
        heInitGates($this->jenisTr);

        $pairRegistries = isset($this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['pairRegistries'] : array();
        $historyFields = $this->config->item("heTransaksi_ui")[$jenisTr]['shortHistoryFields'];
        $glanceHistoryFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['glanceHistoryFields'] : array("nomer" => "receipt no");
        $glanceHistoryFields2 = array("nomer" => "receipt no"); //init;
        $selectorProcessor = base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]['selectorProcessor'] . "/$jenisTr";
        $mb = New MobileDetect();
        $isMob = $mb->isMobile();
        if ($isMob) {
            $historyFields = isset($this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['compactHistoryFields'] : array();
        }
        //
        //region lookup on-going transactions

        $arrayOnprogress = array();
        $progressFields = $historyFields;
        $progressFields['state'] = "status";
        $progressFields['action'] = "action";
        $steps = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'];
        //        if (sizeof($steps) > 1) {
        //            $stepCodes = array();
        //            $jmlStep = count($steps);
        //            foreach ($steps as $stepNumber => $stepSpec) {
        //                if ($stepNumber < $jmlStep) {
        //                    $stepCodes[] = $stepSpec['target'];
        //                }
        //
        //            }
        //
        //
        //            $this->load->model("MdlTransaksi");
        //            $tr = new MdlTransaksi();
        //            $tr->addFilter("jenis_top='" . $steps[1]['target'] . "'");
        //            $tr->addFilter("next_substep_code<>''");
        //            $tmpHist = $tr->lookupRecentUndoneEntries_joined($this->session->login['cabang_id'], $this->session->login['gudang_id'])->result();
        //
        //            $arrayOnprogress = array();
        //            if (sizeof($tmpHist) > 0) {
        //                foreach ($tmpHist as $row) {
        //                    $tmp = array();
        //                    foreach ($historyFields as $fName => $fLabel) {
        //                        //$tmp[$fName] = $row->$fName;
        //                        $tmp[$fName] = formatField($fName, $row->$fName);
        //                    }
        ////                    $tmp['state'] = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->step_current]['stateLabel'];
        //                    if ($row->sub_step_number > 0) {
        //                        $tmp['state'] = "<span style='color:" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateColor'] . "'>" . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$row->sub_step_number]['stateLabel'] . "</span>";
        //                        $tmp['state'] .= "<br>" . createStateSign($row->sub_step_number, $row->step_avail);
        //                    } else {
        //                        $tmp['state'] = "<span style='color:#777777'>canceled</span>";
        //                    }
        //
        //                    $tmp['action'] = "";
        //                    $nextStepNum = ($row->next_substep_num);
        //                    $currentStepNum = ($row->sub_step_number);
        ////                    echo $currentStepNum." vs ".$nextStepNum."<br>";
        //                    $allowJoin = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$nextStepNum]['allowJoin'] : false;
        //
        //
        //                    $allowFollowup = false;
        //                    if ($row->sub_step_number > 0) {
        //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
        //                            $allowFollowup = true;
        //                            $actionLabel = "review " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
        //                        }
        //                    }
        //
        //                    if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum])) {
        //                        if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['userGroup'], $this->session->login['membership'])) {
        //                            $allowFollowup = true;
        //                            $actionLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['actionLabel'];
        //
        //                        }
        //                    }
        //
        //                    if ($allowFollowup) {
        //                        $stepLabel = $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$nextStepNum]['label'];
        //
        //                        $followupLink = "top.$('#result').load('" . base_url() . "Transaksi/followupPrePreview/" . $row->transaksi_id . "/$nextStepNum/" . $row->sub_step_number . "');";
        ////                        $tmp['action'] = "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"$followupLink\">" . $actionLabel . "</a>";
        //                        $tmp['action'] = "<div class='input-group'>";
        //                        $tmp['action'] .= "<a class='btn btn-primary btn-block' title='turn this entry into $stepLabel' href='javascript:void(0)' onClick =\"$followupLink\">" . $actionLabel . "</a>";
        //                        if ($allowJoin) {
        //                            $tmp['action'] .= "<span class='input-group-addon'>";
        //                            $tmp['action'] .= "<a title='process many items at once' href='" . base_url() . "Transaksi/viewIncomplete/" . $this->jenisTr . "/$currentStepNum'><span class='fa fa-dedent'></span></a>";
        //                            $tmp['action'] .= "</span class='input-group-addon'>";
        //                        }
        //                    }
        //                    $arrayOnprogress[] = $tmp;
        //                }
        //            }
        //        } else {
        //            $arrayOnprogress = array();
        //        }
        //endregion

        //

        //region menambah supplier/customer (kalau berwenang)
        $pihakModel = $this->config->item('heTransaksi_ui')[$this->jenisTr]['pihakModel'];
        $dataAccess = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel] : array(
            "viewers" => array(),
            "creators" => array(),
            "creatorAdmins" => array(),
            "updaters" => array(),
            "updaterAdmins" => array(),
            "deleters" => array(),
            "deleterAdmins" => array(),
            "historyViewers" => array(),
        );
        $dataLabel = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel]['label'] : $pihakModel;
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $addPihakStr = "";
        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $pihakModel);
        //        arrprint($dataAccess['creators']);
        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $dataLabel . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        }
                                        );";
                $addPihakStr = "<span class='input-group-btn'>
                                        <a href='javascript:void(0)' title='add $dataLabel' data-toggle='tooltip' data-placement='right' class='btn btn-default' onclick=\"$addClick\">
                                            <span class='fa fa-user-plus'>                                            
                                             </span>
                                        </a>
                                </span>";
            }
        }
        //endregion

        //region menambah item/produk (kalau berwenang)
        $pihakModel = $this->config->item('heTransaksi_ui')[$this->jenisTr]['selectorModel'];
        $dataAccess = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel] : array(
            "viewers" => array(),
            "creators" => array(),
            "creatorAdmins" => array(),
            "updaters" => array(),
            "updaterAdmins" => array(),
            "deleters" => array(),
            "deleterAdmins" => array(),
            "historyViewers" => array(),
        );
        $dataLabel = isset($this->config->item('heDataBehaviour')[$pihakModel]) ? $this->config->item('heDataBehaviour')[$pihakModel]['label'] : $pihakModel;
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $addItemStr = "";
        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $pihakModel);
        //        arrprint($dataAccess['creators']);
        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $dataLabel . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        }
                                        );";
                $addItemStr = "<span class='input-group-btn'>
                                        <a href='javascript:void(0)' title='add $dataLabel' data-toggle='tooltip' data-placement='right' class='btn btn-default' onclick=\"$addClick\">
                                            <span class='fa fa-plus-circle'>                                            
                                             </span>
                                        </a>
                                </span>";
            }
        }
        //endregion


        //
        //region lookup on-going from connected requests
        $progress2Fields = array();
        $arrayOnprogress2 = array();
        $needToClear = false;
        //endregion

        //
        //region lookup histories
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
        $tr->addFilter("transaksi.gudang_id='" . $this->session->login['gudang_id'] . "'");
        $tr->addFilter("transaksi.jenis_master='" . $this->jenisTr . "'");

        //        $tr->addFilter("transaksi.next_step_code=''");
        $tmpHist = $tr->lookupRecentHistories(5)->result();

        // print_r($tmpHist);die();
        $arrayHistory = array();
        if (sizeof($tmpHist) > 0) {
            foreach ($tmpHist as $row) {
                if (sizeof($pairRegistries) > 0) {
                    $trReg = new MdlTransaksi();
                    $trReg->setFilters(array());
                    $trReg->addFilter("param in ('" . implode("','", $pairRegistries) . "')");
                    $trReg->addFilter("transaksi_id='" . $row->id . "'");
                    $tmpReg = $trReg->lookupRegistries()->result();
                    if (sizeof($tmpReg) > 0) {
                        foreach ($tmpReg as $regRow) {
                            $param = $regRow->param;
                            $$param = blobDecode($regRow->values);
                        }
                        foreach ($pairRegistries as $eReg) {
                            foreach ($$eReg as $k => $v) {
                                if (!isset($row->$k)) {

                                    $row->$k = $v;
                                }
                            }
                        }
                    }
                }
                $tmp = array();
                foreach ($historyFields as $fName => $fLabel) {
                    $tmp[$fName] = isset($row->$fName) ? formatField($fName, $row->$fName) : formatField($fName, 0);
                }
                $arrayHistory[] = $tmp;
            }
        }

        //endregion
        //


        $barcodeSettings = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['barcodeSettings']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['barcodeSettings'] : array();

        //==mobile scan (if possible)
        $mobScanStr = sizeof($barcodeSettings) ? "<span class='input-group-btn'>
                                        <a href='javascript:void(0)' class='btn btn-default' onclick=\"getScan()\">
                                            <span class='glyphicon glyphicon-qrcode'>                                            
                                             </span>
                                        </a>
                                </span>" : "";


        //
        //region external tool
        if (isset($this->config->item("heTransaksi_ui")[$jenisTr]['extTool'])) {
            $extToolConfig = $this->config->item("heTransaksi_ui")[$jenisTr]['extTool'];
            $srcVar = $extToolConfig['sentParam'];
            $srcField = $extToolConfig['sentField'];
            $externSrc = $extToolConfig['externSrc'];
            $rawParam = array();
            $backUrl = base_url() . $extToolConfig['backUrl'];
            if (isset($_SESSION[$cCode][$srcVar]) && sizeof($_SESSION[$cCode][$srcVar]) > 0) {

                foreach ($_SESSION[$cCode][$srcVar] as $id => $rSpec) {
                    if (isset($rSpec[$srcField])) {
                        $rawParam[$id] = $rSpec[$srcField];
                    }
                }
            }
            //            arrPrint($rawParam);die();
            if (sizeof($rawParam) > 0) {
                $param = base64_encode(serialize($rawParam));
                $backUrl = base64_encode(serialize($backUrl));
                $extTool = "<a class='btn btn-default' href='javascript:void(0)' onclick=\"window.open('" . $extToolConfig['url'] . "?param=$param&extern=" . $_SESSION[$cCode]['main'][$externSrc] . "&back=$backUrl','wTool');\" >" . $extToolConfig['label'] . "</a>";
            }
            else {
                $extTool = "<a class='btn btn-default' disabled>" . $extToolConfig['label'] . "</a>";
            }

        }
        else {
            //            //cekMerah("extTool doesnt exist");
            $extTool = "";
        }
        //endregion

        $allowTmpSave = isset($this->config->item("heTransaksi_ui")[$jenisTr]['allowTmpSave']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['allowTmpSave'] : false;
        //region prepare params to viewer

        $data = array(
            "mode" => $this->uri->segment(2),
            "isMobile" => $isMob,
            "errMsg" => $this->session->errMsg,
            //            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "template" => "application/template/transaksi_edit.html",
            "title" => " ",
            "subTitle" => "Edit " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "jenisTransaksi" => $jenisTr,
            "selectedID" => $this->uri->segment(3),
            "trName" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            //            "selectorCaller" => base_url() . "_selectorItem/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],
            "selectorCaller" => base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel"],

            "selectorLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel"],
            "selectorCaller2" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller2"]) ? base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorCaller2"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["selectorModel2"] : "",
            //            "pihakCaller" => base_url() . "_selectorPihak/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel"],
            "selectorLabel2" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel2"]) ? $this->config->item("heTransaksi_ui")[$jenisTr]["selectorLabel2"] : "",
            "pihakCaller" => base_url() . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakCaller"] . "/$jenisTr/" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakModel"],
            "pihakCallerDelete" => base_url() . "Selectors/_processPihak/remove/$jenisTr",
            // "pihakLabel"=>$this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "pihakLabel" => isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] . "(" . $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"] . ")" : $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "arrayHistoryLabels" => $historyFields,
            "arrayHistory" => $arrayHistory,
            "arrayProgressLabels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progressFields : $glanceHistoryFields,
            "arrayProgress2Labels" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'] == "list" ? $progress2Fields : $glanceHistoryFields2,
            "arrayOnProgress" => $arrayOnprogress,
            "arrayOnProgress2" => $arrayOnprogress2,
            "reqFormTarget" => isset($reqFormTarget) ? $reqFormTarget : "",

            //            "strPaymentMethod" => $strPaymentMethod,
            "extTool" => $extTool,
            "columnRecorderTarget" => base_url() . "ValueGate/recordColumn/" . $this->jenisTr . "/",
            "defaultDescription" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            "allowJoin" => isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['allowJoin']) && $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['allowJoin'] == true ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['allowJoin'] : false,
            "allowTmpSave" => $allowTmpSave,
            "needToClear" => $needToClear,
            "addPihakStr" => $addPihakStr,
            "addItemStr" => $addItemStr,
            "mobScanStr" => $mobScanStr,
            "thisPage" => base_url() . get_class($this) . "/" . $this->uri->segment(2) . "/" . $this->uri->segment(3),
            "viewMode" => $_SESSION["opt_" . $this->jenisTr]['opt']['viewMode'],
            "viewModeSwitch" => $viewModeSwitch,
            "barcodeSettings" => $barcodeSettings,
            "selectorProcessor" => $selectorProcessor,

        );
        //endregion
        //        arrPrint($data);
        $this->load->view("transaksi", $data);
        //        $this->session->errMsg = "";
    }

    public function editPreview()
    {
        //cekHitam("ini broo live edit");
        //arrPrint($this->uri->segment_array());
        $this->jenisTr = $this->uri->segment(3);
        $selectedID = $this->uri->segment(4);
        $cCode = "_TR_" . $this->jenisTr;
        $stepNumber = isset($_SESSION[$cCode]['tableIn_master']['step_number']) ? $_SESSION[$cCode]['tableIn_master']['step_number'] : 1;
        $itemLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields'][$stepNumber] : array();
        $itemLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartFields2'][$stepNumber] : array();
        $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
        $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$stepNumber] : array();

        $appletConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['applets']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['applets'] : array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
        $imageEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled'] == true ? true : false;

        $inputLabels = array();
        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
        cekHitam($rawPrevURL);
        //matiHere();
        //
        //region lookup items from shopping cart sessions

        //        cekbiru($rawPrevURL);

        $main = array();
        $items = array();
        $items2 = array();
        $items2_sum = array();
        if (isset($_SESSION[$cCode])) {
            if (isset($_SESSION[$cCode]['items'])) {
                foreach ($_SESSION[$cCode]['items'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",

                        "stok" => isset($iSpec['stok']) ? $iSpec['stok'] : "",
                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = $iSpec['subtotal'];


                    $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                    $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];

                    $items[] = $tmp;
                }
            }
            if (isset($_SESSION[$cCode]['items2'])) {
                foreach ($_SESSION[$cCode]['items2'] as $iSpec) {
                    if (isset($iSpec['id'])) {
                        $tmp = array(
                            "id" => $iSpec['id'],
                            "nama" => $iSpec['nama'],
                            "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                            "jml" => $iSpec['jml'],
                            "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",

                        );
                        if (sizeof($itemNumLabels) > 0) {
                            foreach ($itemNumLabels as $key => $label) {
                                $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                                if (!isset($main[$key])) {
                                    $main[$key] = 0;
                                }
                                $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                            }
                        }
                        if ($noteEnabled) {
                            if (isset($iSpec['note'])) {
                                $tmp['note'] = $iSpec['note'];
                            }
                        }
                        if ($imageEnabled) {
                            if (isset($iSpec['images'])) {
                                $tmp['images'] = $iSpec['images'];
                            }
                        }
                        $tmp['subtotal'] = $iSpec['subtotal'];


                        $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                        $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];

                        $items2[] = $tmp;
                    }
                }
            }
            if (isset($_SESSION[$cCode]['items2_sum'])) {
                foreach ($_SESSION[$cCode]['items2_sum'] as $iSpec) {
                    $tmp = array(
                        "id" => $iSpec['id'],
                        "nama" => $iSpec['nama'],
                        "satuan" => isset($iSpec['satuan']) ? $iSpec['satuan'] : "n/a",
                        "jml" => $iSpec['jml'],
                        "produk_kode" => isset($iSpec['produk_kode']) ? $iSpec['produk_kode'] : "n/a",
                        "harga" => isset($iSpec['harga']) ? $iSpec['harga'] : "",
                        "referensi" => isset($iSpec['pihakName']) ? $iSpec['pihakName'] : "",

                    );
                    if (sizeof($itemNumLabels) > 0) {
                        foreach ($itemNumLabels as $key => $label) {
                            $tmp[$key] = isset($iSpec[$key]) ? $iSpec[$key] : 0;
                            if (!isset($main[$key])) {
                                $main[$key] = 0;
                            }
                            $main[$key] += isset($iSpec[$key]) ? ($iSpec['jml'] * $iSpec[$key]) : 0;

                        }
                    }
                    if ($noteEnabled) {
                        if (isset($iSpec['note'])) {
                            $tmp['note'] = $iSpec['note'];
                        }
                    }
                    if ($imageEnabled) {
                        if (isset($iSpec['images'])) {
                            $tmp['images'] = $iSpec['images'];
                        }
                    }
                    $tmp['subtotal'] = isset($iSpec['subtotal']) ? $iSpec['subtotal'] : 0;


                    $tmp["editTarget"] = base_url() . $iSpec['handler'] . "/select/" . $this->jenisTr . "?id=" . $iSpec['id'] . "&newQty=";
                    $tmp["removeTarget"] = base_url() . $iSpec['handler'] . "/remove/" . $this->jenisTr . "?id=" . $iSpec['id'];

                    $items2_sum[] = $tmp;
                }
            }
        }
        //endregion

        //region labels for preview's bottom elements
        $jenisTr = $this->jenisTr;
        //        $buttonLabel = $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['actionLabel'];
        $buttonLabel = "Edit " . $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['actionLabel'];
        if (sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']) > 1) {
            $saveWarning = "clicking <strong>$buttonLabel</strong> button will make transaction state to: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['stateLabel'] . "</strong>";
            $saveWarning .= "<br>It would need to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][2]['userGroup'] . "</strong>";
        }
        else {
            $saveWarning = "clicking <strong>$buttonLabel</strong> button will instantly make transaction state to <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['stateLabel'] . "</strong>";
        }
        //endregion
        //        arrPrint($main);die();

        $stepLabels = array();
        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $num => $sSpec) {
            $stepLabels[$num] = $sSpec['label'];
        }

        //
        //region prepare params to viewer

        $tmpTableIn_master = isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array();
        $tmpTableIn_masterValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        $main = array_merge(array_filter($main), array_filter($tmpTableIn_master), array_filter($tmpTableIn_masterValues), array_filter($_SESSION[$cCode]['main']));
        $mainAddValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
            $mainAddValues = array_merge(array_filter($mainAddValues), array_filter($_SESSION[$cCode]['main_add_values']));
        }


        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            //            cekbiru("hendak memeriksa relative impacts");
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                //                cekbiru("memeriksa $eName:");
                if (array_key_exists($eName, $relElementConfigs)) {
                    //                    cekhijau("$eName memiliki relative impacts");
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    //                    cekmerah($currentValue);
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //                        cekhijau("memenuhi syarat");
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            //                            cekmerah("memeriksa $eName, $currentValue");
                            //                            $rcCtr = 0;
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                //                                $elKey = $eName . "_" . $currentValue . "_" . $rcID;
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                                //                                $rcCtr++;
                            }
                        }
                    }
                    else {
                        //                        cekmerah("TIDAK memenuhi syarat");
                    }
                }

                if (array_key_exists($eName, $relOptionConfigs)) {
                    //					cekhijau("$eName terdaftar pada relInputs");


                    if (isset($relOptionConfigs[$eName][$currentValue])) {
                        if (sizeof($relOptionConfigs[$eName][$currentValue]) > 0) {
                            foreach ($relOptionConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                $inputLabels[$oValueName] = $oValSpec['label'];
                            }
                        }
                    }
                    else {
                        //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                    }

                }
                else {
                    //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                }
            }
        }


        //        arrprint($elementConfigs);


        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$stepNumber] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
        }

        //		arrprint($inputLabels);die();

        $pairedItemTarget = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName'] : "items2";
        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "itemLabels" => $itemLabels,
            "itemLabels2" => $itemLabels2,
            "noteEnabled" => $noteEnabled,
            "imageEnabled" => $imageEnabled,
            "main" => $main,
            "items" => $items,
            //            "items2" => $items2,
            "items2" => $$pairedItemTarget,
            "buttonLabel" => $buttonLabel,
            "saveWarning" => $saveWarning,
            //            "sumRows" => $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$stepNumber],
            "sumRows" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][1]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][1] : $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1],
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            //            "mainAddValues" => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
            "mainAddValues" => $mainAddValues,
            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            //            "mainApplets"    => isset($_SESSION[$cCode]['main_applets']) ? $_SESSION[$cCode]['main_applets'] : array(),
            "mainElements" => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
            "actionTarget" => base_url() . $this->uri->segment(1) . "/doEdit/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "?rawPrev=$rawPrevURL",
            "appletConfig" => $appletConfigs,
            "elementConfig" => $elementConfigs,
            "mainInputs" => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
            "grandTotal" => isset($_SESSION[$cCode]['main']['grand_total']) ? $_SESSION[$cCode]['main']['grand_total'] : 0,
            "headerRows" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptMainFields'][$stepNumber]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptMainFields'][$stepNumber] : array(),
            "description" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",
            "stepLabels" => $stepLabels,
            "currentStep" => 1,
            "pairedValue" => isset($_SESSION[$cCode]['pairs']) ? $_SESSION[$cCode]['pairs'] : array(),
        );
        //arrPrint($data);
        if (isset($_SESSION[$cCode]['main'])) {
            $data['pihakID'] = isset($_SESSION[$cCode]['main']['pihakID']) ? $_SESSION[$cCode]['main']['pihakID'] : 0;
            $data['pihakName'] = isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : "";
        }
        //endregion
        $this->load->view("transaksi", $data);
    }

    public function doEdit()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }

        echo "<script>top.open_holdon()</script>";
        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        //region marking
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $inputLabels = array();
        $inputAuthConfigs = array();

        $this->load->library("FieldCalculator");
        $cal = new FieldCalculator();

        $rawPrevURL = isset($_GET['rawPrev']) ? $_GET['rawPrev'] : "";
        $prevUrl = blobDecode($rawPrevURL);
        $mongUpdateList = array();
        $mongoList = array();
        if (isset($_SESSION[$cCode])) {

            if (!isset($_SESSION[$cCode]['items'])) {
                die("belum ada item yang dipilih");
            }
            else {
                if (sizeof($_SESSION[$cCode]['items']) < 1) {
                    die("belum ada item yang dipilih");
                }
            }
            echo("now processing your transaction..<br>");


            //region build table rekening
            $buildTablesMaster = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master'] : array();
            $buildTablesDetail = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail'] : array();
            $addMasterTables = array(
                "rugilaba",
                "laba ditahan",
                "rugilaba lain lain",
            );
            foreach ($addMasterTables as $trek) {
                $buildTablesMaster[] = array(
                    "comName" => "RugiLaba",
                    "loop" => array(
                        "$trek" => .0,
                    ),
                );
            }
            if (sizeof($buildTablesMaster) > 0) {
                //                arrprint($buildTablesMaster);
                $bCtr = 0;
                foreach ($buildTablesMaster as $buildTablesMaster_specs) {
                    //                    arrprint($buildTablesMaster_specs);
                    $bCtr++;
                    $mdlName = $buildTablesMaster_specs['comName'];
                    if (substr($mdlName, 0, 1) == "{") {
                        //                        cekkuning("mengandung kurawal");
                        $mdlName = trim($mdlName, "{");
                        $mdlName = trim($mdlName, "}");
                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                    }
                    else {
                        //                        cekkuning("TIDAK mengandung kurawal");
                    }
                    $mdlName = "Com" . $mdlName;
                    //                    cekHitam("# $bCtr - model: $mdlName");
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();


                    if (isset($buildTablesMaster_specs['loop']) && sizeof($buildTablesMaster_specs['loop']) > 0) {
                        foreach ($buildTablesMaster_specs['loop'] as $key => $val) {
                            if (substr($key, 0, 1) == "{") {
                                $oldParam = $buildTablesMaster_specs['loop'][$key];
                                unset($buildTablesMaster_specs['loop'][$key]);
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                $buildTablesMaster_specs['loop'][$key] = $oldParam;
                            }
                        }
                    }


                    if (method_exists($m, "getTableNameMaster")) {
                        if (sizeof($m->getTableNameMaster())) {
                            $m->buildTables($buildTablesMaster_specs);
                        }
                    }
                }
            }
            if (sizeof($buildTablesDetail) > 0) {
                foreach ($buildTablesDetail as $buildTablesDetail_specs) {
                    foreach ($_SESSION[$cCode]['items'] as $itemSpec) {

                        $mdlName = $buildTablesDetail_specs['comName'];
                        if (substr($mdlName, 0, 1) == "{") {
                            $mdlName = trim($mdlName, "{");
                            $mdlName = trim($mdlName, "}");
                            $mdlName = str_replace($mdlName, $itemSpec[$mdlName], $mdlName);
                            //                        $mdlName = str_replace($mdlName, $_SESSION[$cCode]['main'][$mdlName], $mdlName);
                        }
                        $mdlName = "Com" . $mdlName;
                        cekbiru("model: $mdlName");
                        $this->load->model("Coms/" . $mdlName);
                        $m = new $mdlName();

                        if (isset($buildTablesDetail_specs['loop']) && sizeof($buildTablesDetail_specs['loop']) > 0) {
                            foreach ($buildTablesDetail_specs['loop'] as $key => $val) {
                                if (substr($key, 0, 1) == "{") {
                                    $oldParam = $buildTablesDetail_specs['loop'][$key];
                                    unset($buildTablesDetail_specs['loop'][$key]);
                                    $key = trim($key, "{");
                                    $key = trim($key, "}");
                                    $key = str_replace($key, $itemSpec[$key], $key);
                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                    $buildTablesDetail_specs['loop'][$key] = $oldParam;
                                }
                            }
                        }
                        if (method_exists($m, "getTableNameMaster")) {
                            if (sizeof($m->getTableNameMaster())) {
                                $m->buildTables($buildTablesDetail_specs);
                            }
                        }
                    }
                }
            }
            //endregion


            $this->db->trans_start();

            //region set trash registry, transaksi, transaksi data, payment source, extend step, lockerstok
            if (isset($_SESSION[$cCode]['mode']['edit']) && sizeof($_SESSION[$cCode]['mode']['edit']) > 0) {
                $masterID = $_SESSION[$cCode]['mode']['edit'];
                $trTrash = new MdlTransaksi();
                $where = "transaksi_id='$masterID'";
                $dataTrash = array("trash" => "1");
                $trTrash->setFilters(array());
                $trTrash->setTableName("transaksi_registry");
                $updateReistry = $trTrash->updateData($where, $dataTrash) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  updte  params registries"));
                $mongUpdateList['update']['registry'][] = array(
                    "where" => array(
                        "transaksi_id" => $masterID,
                    ),
                    "value" => $dataTrash,
                );
                //                cekHijau($this->db->last_query() . " [" . $this->db->affected_rows() . "]");


                if ($updateReistry) {
                    $trTrash->setFilters(array());
                    $trTrash->setTableName("transaksi_data");
                    $dataItems = array(
                        "valid_qty" => "0",
                        "trash" => "1",
                        "sub_step_number" => "",
                        "sub_step_current" => "",
                        "sub_step_avail" => "",
                        "next_substep_num" => "",
                    );
                    $updateItems = $trTrash->updateData($where, $dataItems) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  updte  params registries"));
                    $mongUpdateList['update']['detail'][] = array(
                        "where" => array("transaksi_id" => $masterID),
                        "value" => $dataItems,
                    );
                    cekHitam($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                }

                // region netralisasi payment source
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $paymentSrc = $tr->lookupPaymentSrcByTransID($masterID)->result();
                cekBiru($this->db->last_query());
                if (sizeof($paymentSrc) > 0) {
                    //                    arrPrint($paymentSrc);
                    foreach ($paymentSrc as $pSpec) {
                        if ($pSpec->terbayar == 0) {
                            $where = array(
                                "id" => $pSpec->id,
                                "transaksi_id" => $pSpec->transaksi_id,
                            );
                            $data = array(
                                "sisa" => 0,
                                "returned" => $pSpec->sisa,
                                "sisa_valas" => 0,
                                "returned_valas" => $pSpec->sisa_valas,
                            );

                            $tra = New MdlTransaksi();
                            $tra->setFilters(array());
                            $tra->updatePaymentSrc($where, $data);
                            cekUngu(":: mereject payment source bila ada...");
                            cekUngu($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                        }
                        else {
                            mati_disini("transaksi gagal karena " . $pSpec->_key . " telah diterima oleh finance.");
                        }
                    }
                }
                else {
                    cekBiru(":: tidak ada payment source... ::");
                }
                // endregion netralisasi payment source

                // region netralisasi extended step
                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $exTmp = $tr->lookupExtStepByTrID($masterID);
                cekUngu($this->db->last_query());
                if (sizeof($exTmp) > 0) {
                    foreach ($exTmp as $exSpec) {
                        $tra = New MdlTransaksi();
                        $tra->setFilters(array());
                        $tra->rejectExtStepByID($exSpec['id']);
                        $mongUpdateList['update']['extra'][] = array(
                            "where" => array(
                                "id" => $exSpec['id'],
                            ),
                            "value" => array(
                                "state" => "-1",
                            ),
                        );
                        cekUngu(":: mereject extended step bila ada...");
                        cekUngu($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                    }
                }
                else {
                    cekBiru(":: tidak ada extended step... ::");
                }
                // endregion netralisasi extended step

                // region reverse locket stok FG or SUpplies
                $this->load->model("Mdls/MdlLockerStock");
                $this->load->model("Mdls/MdlLockerStockSupplies");

                $fg = New MdlLockerStock();
                $fg->addFilter("state='hold'");
                $fg->addFilter("transaksi_id='$masterID'");
                $fgTmp = $fg->lookupAll()->result();
                cekUngu($this->db->last_query());
                if (sizeof($fgTmp) > 0) {
                    $fgLocker = array();
                    foreach ($fgTmp as $fgSpec) {
                        $fgLocker[] = array(
                            "loop" => array(),
                            "static" => array(
                                "cabang_id" => $fgSpec->cabang_id,
                                "jenis" => $fgSpec->jenis,
                                "state" => "hold",
                                "jumlah" => -$fgSpec->jumlah,
                                "produk_id" => $fgSpec->produk_id,
                                "nama" => $fgSpec->nama,
                                "satuan" => $fgSpec->satuan,
                                "oleh_id" => "0",
                                "oleh_nama" => "0",
                                "transaksi_id" => $fgSpec->transaksi_id,
                                "nomer" => $fgSpec->nomer,
                                "gudang_id" => $fgSpec->gudang_id,
                            ),
                        );
                        $this->load->model("Coms/ComLockerStock");
                        $m = New ComLockerStock();
                        $m->pair($fgLocker) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        cekBiru($this->db->last_query());
                    }
                }
                else {
                    cekHitam("FG locker $masterID, kosong...");
                }


                $sp = New MdlLockerStockSupplies();
                $sp->addFilter("state='hold'");
                $sp->addFilter("transaksi_id='$masterID'");
                $spTmp = $sp->lookupAll()->result();
                cekOrange($this->db->last_query());
                if (sizeof($spTmp) > 0) {
                    $spLocker = array();
                    foreach ($spTmp as $spSpec) {
                        $spLocker[] = array(
                            "loop" => array(),
                            "static" => array(
                                "cabang_id" => $spSpec->cabang_id,
                                "jenis" => $spSpec->jenis,
                                "state" => "hold",
                                "jumlah" => -$spSpec->jumlah,
                                "produk_id" => $spSpec->produk_id,
                                "nama" => $spSpec->nama,
                                "satuan" => $spSpec->satuan,
                                "oleh_id" => "0",
                                "oleh_nama" => "0",
                                "transaksi_id" => $spSpec->transaksi_id,
                                "nomer" => $spSpec->nomer,
                                "gudang_id" => $spSpec->gudang_id,
                            ),
                        );
                        $this->load->model("Coms/ComLockerStockSupplies");
                        $mp = New ComLockerStockSupplies();
                        $mp->pair($spLocker) or die("Tidak berhasil memasang  values pada post-processor:");
                        $mp->exec() or die("Gagal saat berusaha  exec values pada post-processor:");
                        cekBiru($this->db->last_query());
                    }
                }
                else {
                    cekHitam("SP locker $masterID, kosong...");
                }
                // endregion reverse locket stok FG or SUpplies


            }

            //endregion

            //region pre-processors (master)
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['master'])) {
                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['master'] : array();
                $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();


                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();
                        $subParams = array();

                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                $subParams['static'][$key] = $realValue;

                            }

                            if (!isset($subParams['static']["transaksi_id"])) {
                                //									$subParams['static']["transaksi_id"] = $masterID;
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                        }
                        $tmpOutParams[$cCtr] = $subParams;

                        $mdlName = "Pre" . ucfirst($comName);
                        $this->load->model("Preprocs/" . $mdlName);
                        $m = new $mdlName($resultParams);


                        if (sizeof($tmpOutParams[$cCtr]) > 0) {
                            $tobeExecuted = true;
                        }
                        else {
                            $tobeExecuted = false;
                        }

                        if ($tobeExecuted) {
                            $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                            $gotParams = $m->exec();

                            cekbiru("gotparams dari pre-proc $comName");
                            arrprint($gotParams);

                            if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor
                                foreach ($gotParams as $gateName => $gSpec) {
                                    //										$id=$gSpec['id'];
                                    if (isset($_SESSION[$cCode]['main'])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $_SESSION[$cCode]['main'][$key] = $val;
                                            }
                                        }
                                    }
                                    //==inject gotParams to child gate
                                    if (isset($_SESSION[$cCode]['main'])) {
                                        if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                            foreach ($gSpec as $key => $val) {
                                                $_SESSION[$cCode]['main'][$key] = $val;
                                            }
                                        }
                                    }
                                    //cekMerah("REBUILDING VALUES..");
                                    if (sizeof($itemNumLabels) > 0) {
                                        //cekHijau("REBUILDING SUBS FOR ITEMS");
                                        foreach ($itemNumLabels as $key => $label) {
                                            //cekHere("$id === $key => $label");
                                            if (isset($_SESSION[$cCode]['main'][$key])) {
                                                $_SESSION[$cCode]['main']['sub_' . $key] = ($_SESSION[$cCode]['main']['jml'] * $_SESSION[$cCode]['main'][$key]);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }
                $this->load->helper("he_value_builder");
                fillValues($this->jenisTr, 1, 1);
            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion


            //
            //region pre-processors (item)
            if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail'])) {
                //                $procList = $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1];

                $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['preProcessor'][1]['detail'] : array();
                $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'] : array();
                echo "ITEM NUM LABELS";

                if (sizeof($iterator) > 0) {
                    foreach ($iterator as $cCtr => $tComSpec) {
                        $comName = $tComSpec['comName'];
                        $srcGateName = $tComSpec['srcGateName'];
                        $srcRawGateName = $tComSpec['srcRawGateName'];

                        echo "sub-preproc: $comName, initializing values <br>";

                        foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                            $tmpOutParams[$cCtr] = array();

                            //                            $id = $dSpec['id'];
                            $id = $xid;
                            $subParams = array();

                            if (isset($tComSpec['static'])) {
                                foreach ($tComSpec['static'] as $key => $value) {

                                    $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                    $subParams['static'][$key] = $realValue;

                                }

                                if (!isset($subParams['static']["transaksi_id"])) {
                                    //									$subParams['static']["transaksi_id"] = $masterID;
                                }


                                $subParams['static']["fulldate"] = date("Y-m-d");
                                $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                                $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " oleh " . $this->session->login['nama'];
                            }
                            cekLime(":: cetak preprocc... $comName :: $srcGateName ::");
                            arrPrint($subParams);
                            //mati_disini();
                            if (sizeof($subParams) > 0) {
                                $tmpOutParams[$cCtr][] = $subParams;


                                $comName = $tComSpec['comName'];
                                $srcGateName = $tComSpec['srcGateName'];
                                $srcRawGateName = $tComSpec['srcRawGateName'];
                                $resultParams = isset($tComSpec['resultParams']) ? $tComSpec['resultParams'] : array();

                                //                                echo "sub preproc #$it: $comName, sending values <br>";

                                $mdlName = "Pre" . ucfirst($comName);
                                $this->load->model("Preprocs/" . $mdlName);
                                $m = new $mdlName($resultParams);


                                if (sizeof($tmpOutParams[$cCtr]) > 0) {
                                    $tobeExecuted = true;
                                }
                                else {
                                    $tobeExecuted = false;
                                }

                                if ($tobeExecuted) {
                                    $m->pair(0, $tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada pre-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                                    $gotParams = $m->exec();

                                    cekmerah("gotparams dari pre-proc $comName");
                                    arrprint($gotParams);


                                    if (sizeof($gotParams) > 0) {//==gotParams means result from preprocessor

                                        foreach ($gotParams as $gateName => $paramSpec) {
                                            cekBiru(":: getParams inject ke $gateName ::");
                                            if (!isset($_SESSION[$cCode][$gateName])) {
                                                $_SESSION[$cCode][$gateName] = array();
                                                //                                    cekhijau("building the session: $gateName");
                                            }
                                            else {
                                                //                                    cekhijau("NOT building the session: $gateName");
                                            }

                                            foreach ($paramSpec as $id => $gSpec) {
                                                //										$id=$gSpec['id'];


                                                if (!isset($_SESSION[$cCode][$gateName][$id])) {
                                                    $_SESSION[$cCode][$gateName][$id] = array();
                                                }


                                                if (isset($_SESSION[$cCode][$gateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            cekHere(":: injecte ke $gateName, ::: $key diisi dengan $val");
                                                            $_SESSION[$cCode][$gateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }
                                                //==inject gotParams to child gate
                                                cekHitam("srcGateName = $srcGateName :: " . __LINE__);
                                                if (isset($_SESSION[$cCode][$srcGateName][$id])) {
                                                    if (is_array($gSpec) && sizeof($gSpec) > 0) {
                                                        foreach ($gSpec as $key => $val) {
                                                            $_SESSION[$cCode][$srcGateName][$id][$key] = $val;
                                                        }

                                                    }
                                                }

                                                //cekMerah("REBUILDING VALUES..");
                                                if (sizeof($itemNumLabels) > 0) {
                                                    //cekHijau("REBUILDING SUBS FOR ITEMS");
                                                    foreach ($itemNumLabels as $key => $label) {
                                                        //cekHere("$id === $key => $label");
                                                        if (isset($_SESSION[$cCode][$gateName][$id][$key])) {
                                                            $_SESSION[$cCode][$gateName][$id]['sub_' . $key] = ($_SESSION[$cCode][$gateName][$id]['jml'] * $_SESSION[$cCode][$gateName][$id][$key]);
                                                        }
                                                        //                                        die();
                                                    }
                                                }
                                            }
                                            //                                    arrPrint($items);die();
                                        }


                                    }

                                }
                                else {
                                    cekBiru("sub-komponem $comName tidak memenuhi syarat untuk ditulis");
                                }


                            }
                        }
                    }
                }
                else {
                    //cekKuning("sub-preproc is not set");
                }


                $this->load->helper("he_value_builder");
                fillValues($this->jenisTr, 1, 1);


            }
            else {
                echo("no processor defined. skipping preprocessor..<br>");
            }
            //endregion

            $this->midValidate();
            $this->unionValidate();
            //===finalisasi sebelum masuk tabel beneran
            //===isinya ada pembentukan nomor nota dll

            //            mati_disini(":: TEST PREPROC reverse");
            //
            //region penomoran receipt
            //            //<editor-fold desc="==========penomoran">
            //            $this->load->model("CustomCounter");
            //            $cn = new CustomCounter("transaksi");
            //            $cn->setType("transaksi");
            //
            //            $counterForNumber = array($this->config->item('heTransaksi_core')[$this->jenisTr]['formatNota']);
            //            if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$this->jenisTr]['counters'])) {
            //                die(__LINE__." Used number should be registered in 'counters' config as well");
            //            }
            //            echo "<div style='background:#ff7766;'>";
            //            foreach ($counterForNumber as $i => $cRawParams) {
            //                $cParams = explode("|", $cRawParams);
            //                $cValues = array();
            //                foreach ($cParams as $param) {
            //                    //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
            //                    //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
            //                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
            //                    //                    echo "filling $param with " . $_SESSION[$cCode]['main'][$param] . "<br>";
            //                }
            //                $cRawValues = implode("|", $cValues[$i]);
            //                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);
            //
            //            }
            //            echo "</div style='background:#ff7766;'>";
            //
            //            $stepNumber = 1;
            //
            //            $tmpNomorNota = $paramSpec['paramString'];
            //
            //            //            $_SESSION[$cCode]['tableIn_master']['nomer'] = $tmpNomorNota;
            //
            //
            if (isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2])) {
                $nextProp = array(
                    "num" => 2,
                    "code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['target'],
                    "label" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['label'],
                    "groupID" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][2]['userGroup'],
                );
            }
            else {
                $nextProp = array(
                    "num" => 0,
                    "code" => "",
                    "label" => "",
                    "groupID" => "",
                );
            }

            //endregion off

            //region dynamic counters

            //region addition on master
            $addValues = array(

                "status_edit" => 1,
                "edit_id" => $this->session->login['id'],
                "edit_name" => $this->session->login['nama'],
                "edit_dtime" => date("Y-m-d H:i:s"),
                //                "tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['target'],


            );
            foreach ($addValues as $key => $val) {
                $_SESSION[$cCode]['tableIn_master'][$key] = $val;
            }
            //endregion

            //
            //region addition on detail
            $addSubValues = array(
                "sub_step_number" => 1,
                "sub_step_current" => 1,
                "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps']),
                "next_substep_num" => $nextProp['num'],
                "next_substep_code" => $nextProp['code'],
                "next_substep_label" => $nextProp['label'],
                "next_subgroup_code" => $nextProp['groupID'],
                "sub_tail_number" => 1,
                "sub_tail_code" => $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['target'],


            );
            foreach ($_SESSION[$cCode]['tableIn_detail'] as $id => $dSpec) {
                foreach ($addSubValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_detail'][$id][$key] = $val;
                }
            }
            //endregion
            // </editor-fold>
            //endregion


            //
            //region ----------write transaksi, transaksi_data, main_fields, main_values, main_applets, etc
            if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                $tr = new MdlTransaksi();
                $tr->setFilters(array());
                //                $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                $tr->setTableName("transaksi");
                $updateMain = $tr->updateData("id='$masterID'", $addValues);
                $mongUpdateList['update']['main'][] = array(
                    "where" => array(
                        "id" => $masterID,
                    ),
                    "value" => $addValues,
                );
                cekHijau($this->db->last_query());
                //                matiHere();
                //                $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                //                $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                //                $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                //                $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                //                if ($insertID < 1) {
                //                    die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                //                }
                //==transaksi_id dan nomor nota diinject kan ke gate utama
                $injectors = array(
                    "transaksi_id" => $masterID,
                    //                    "nomer" => $tmpNomorNota,
                );
                $arrInjectorsTarget = array(
                    "items",
                    "items2_sum",
                    "rsltItems",
                );
                foreach ($injectors as $key => $val) {
                    $_SESSION[$cCode]['main'][$key] = $val;
                    foreach ($arrInjectorsTarget as $target) {
                        if (isset($_SESSION[$cCode][$target])) {
                            foreach ($_SESSION[$cCode][$target] as $xid => $iSpec) {
                                $id = isset($iSpec['id']) && $iSpec['id'] > 0 ? $iSpec['id'] : $xid;
                                if (isset($_SESSION[$cCode][$target][$id])) {
                                    $_SESSION[$cCode][$target][$id][$key] = $val;
                                }
                            }
                        }
                    }
                }


                $addValues = array(

                    //===references
                    "id_master" => $masterID,
                    "id_top" => $masterID,
                    "ids_prev" => "",
                    "ids_prev_intext" => "",
                    "nomer_top" => $_SESSION[$cCode]['main']['nomer'],
                    "nomers_prev" => "",
                    "nomers_prev_intext" => "",
                    //                    "jenis_top"           => $this->jenisTr,
                    "jenises_prev" => "",
                    "jenises_prev_intext" => "",
                    //

                );
                foreach ($addValues as $key => $val) {
                    $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                }

            }

            if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {

                if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['mainValues'])) {
                    foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['mainValues'] as $key => $src) {
                        if (isset($_SESSION[$cCode]['tableIn_master_values'][$key])) {
                            $tr->setTableName("transaksi_values");
                            $tr->updateData("transaksi_id='$masterID'", array(
                                "key" => $key,
                                "value" => $_SESSION[$cCode]['tableIn_master_values'][$key],
                            ));
                            $mongUpdateList['update']['mainValues'][] = array(
                                "where" => array(
                                    "transaksi_id" => $masterID,
                                ),
                                "value" => $_SESSION[$cCode]['tableIn_master_values'][$key],
                            );
                            cekHitam($this->db->last_query());
                        }
                    }
                }
            }

            if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                    $tr->setTableName("transaksi_values");
                    $tr->updateData("transaksi_id='$masterID'", array("key" => $key, "value" => $val));
                    $mongUpdateList['update']['mainValues'][] = array(
                        "where" => array(
                            "transaksi_id" => $masterID,
                        ),
                        "value" => array("key" => $key, "value" => $val),
                    );
                }
            }

            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                    $tr->setTableName("transaksi_values");
                    $tr->updateData("transaksi_id='$masterID'", array("key" => $key, "value" => $val));

                    //                    cekkuning("making a clone for input key $key / $val");
                    //                    $tmpTableIn=$_SESSION[$cCode]['tableIn_master'];
                    //                    $replacers=array(
                    //                        "nomer"=>$_SESSION[$cCode]['tableIn_master']['nomer']."_$key",
                    //                    );
                    //                    foreach($replacers as $key=>$val){
                    //                        $tmpTableIn[$key]=$val;
                    //                    }
                    //                    $subInputInsertID = $tr->writeMainEntries($tmpTableIn);
                }
            }

            if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                $tr->setTableName("transaksi_fields");
                foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                    $tr->writeMainFields("transaksi_id='$masterID'", array("key" => $key, "value" => $val));
                }
            }

            if (isset($_SESSION[$cCode]['main_applets']) && sizeof($_SESSION[$cCode]['main_applets']) > 0) {
                $tr->setTableName("transaksi_applets");
                foreach ($_SESSION[$cCode]['main_applets'] as $amdl => $aSpec) {

                    $tr->updateData("transaksi_id='$masterID'", array(
                        "mdl_name" => $amdl,
                        "key" => $aSpec['key'],
                        "label" => $aSpec['labelValue'],
                        "description" => $aSpec['description'],
                    ));
                }
            }

            if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                $tr->setTableName("transaksi_element");
                foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {

                    $tr->updateData("transaksi_id='$masterID'", array(
                        "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                        "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                        "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                        "name" => $aSpec['name'],
                        "label" => $aSpec['label'],
                        "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                        "contents_intext" => isset($aSpec['contents_intext']) ? $aSpec['contents_intext'] : "",

                    ));


                    //==nebeng bikin inputLabels
                    $currentValue = "";
                    switch ($aSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $aSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $aSpec['value'];
                            break;
                    }
                    if (array_key_exists($elName, $relOptionConfigs)) {
                        //					cekhijau("$eName terdaftar pada relInputs");


                        if (isset($relOptionConfigs[$elName][$currentValue])) {
                            if (sizeof($relOptionConfigs[$elName][$currentValue]) > 0) {
                                foreach ($relOptionConfigs[$elName][$currentValue] as $oValueName => $oValSpec) {
                                    $inputLabels[$oValueName] = $oValSpec['label'];
                                    if (isset($oValSpec['auth'])) {
                                        if (isset($oValSpec['auth']['groupID'])) {
                                            $inputAuthConfigs[$oValueName] = $oValSpec['auth']['groupID'];
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                        }

                    }

                }
            }


            if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                // membaca transaksi data, terakhir sebelum mulai menyimpan


                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                    //                    arrPrint($dSpec);
                    $insertIDs[] = $tr->writeDetailEntries($masterID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    cekUngu($this->db->last_query() . " [" . $this->db->affected_rows() . "]");
                }
            }

            if (isset($_SESSION[$cCode]['tableIn_detail2']) && sizeof($_SESSION[$cCode]['tableIn_detail2']) > 0) {
                $insertIDs = array();
                foreach ($_SESSION[$cCode]['tableIn_detail2'] as $dSpec) {

                    $insertIDs[] = $tr->writeDetailEntries($masterID, $dSpec);
                    $mongoList['detail'] = $insertIDs;
                    cekUngu($this->db->last_query());
                }
            }


            if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                $insertIDs = array();
                $tr->setTableName("transaksi_data");
                foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                    $tr->updateData("transaksi_id='$masterID'", $dSpec);
                    $mongUpdateList['update']['detail'][] = array(
                        "where" => array(
                            "transaksi_id" => $masterID,
                        ),
                        "value" => $dSpec,
                    );


                }
            }

            if (isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) && sizeof($_SESSION[$cCode]['tableIn_detail_rsltItems']) > 0) {
                //                $insertIDs = array();
                $tr->setTableName("transaksi_data");
                foreach ($_SESSION[$cCode]['tableIn_detail_rsltItems'] as $dSpec) {
                    $insertIDs[] = $tr->updateData("transaksi_id='$masterID'", $dSpec);
                    $mongUpdateList['update']['detail'][] = array(
                        "where" => array(
                            "transaksi_id" => $masterID,
                        ),
                        "value" => $dSpec,
                    );
                    //                    if ($epID != 999) {
                    //                        $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                    //                    }
                    cekUngu($this->db->last_query());
                }
            }

            if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                $tr->setTableName("transaksi_data_values");
                foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                            if (isset($_SESSION[$cCode]['tableIn_detail'][$pID])) {
                                $tr->updateData("transaksi_id='$masterID'", array(
                                    "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                    "produk_id" => $pID,
                                    "key" => $key,
                                    "value" => $dSpec[$src],
                                ));
                                $mongUpdateList['update']['detailValues'][] = array(
                                    "where" => array(
                                        "transaksi_id" => $masterID,
                                    ),
                                    "value" => array(
                                        "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                        "produk_id" => $pID,
                                        "key" => $key,
                                        "value" => $dSpec[$src],),
                                );

                            }
                        }
                    }


                }
            }

            if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                    if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                        foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                            $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                "produk_id" => $pID,
                                "key" => $key,
                                "value" => $dSpec[$src],
                            ));
                            $mongoList['detailValues'] = $insertIDs;

                        }
                    }


                }
            }

            //endregion


            //===components akan langsung dieksekusi jika steps-nya tidak pakai approval
            $steps = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'];

            //
            //region processing sub-components, if in single step
            //<editor-fold desc="----------subcomponents">

            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $filterNeeded = false;

            //region processing sub-components
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['detail'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $tmpOutParams[$cCtr] = array();

                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {
                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            //                            $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
                        }
                        cekHitam(":: $comName ::");
                        $mdlName = "Com" . ucfirst($comName);
                        if (in_array($mdlName, $compValidators)) {//perlu validasi filter
                            $filterNeeded = true;
                        }
                        else {
                            $filterNeeded = false;
                        }
                        echo "sub-component: $comName, initializing values <br>";
                        //                        cekHitam(__LINE__);
                        //                        $tmpOutParams[$cCtr] = array();

                        //                        cekhitam("$comName filterneeded: $filterNeeded");
                        //                        cekhitam("mau mengiterasi $srcGateName");
                        //                        cekhitam("telah mengiterasi $srcGateName");
                        //
                        $subParams = array();
                        if (isset($tComSpec['loop'])) {
                            foreach ($tComSpec['loop'] as $key => $value) {
                                cekMerah(":: $key => $value ::");
                                if (substr($key, 0, 1) == "{") {
                                    $key = trim($key, "{");
                                    $key = trim($key, "}");
                                    //                                    $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                                    $key = str_replace($key, $_SESSION[$cCode][$srcGateName][$id][$key], $key);
                                }

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['loop'][$key] = $realValue;

                                if ($filterNeeded) {
                                    if ($subParams['loop'][$key] == 0) {
                                        unset($subParams['loop'][$key]);
                                    }
                                }
                            }
                        }
                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['static'][$key] = $realValue;

                            }
                            if (!isset($subParams['static']["transaksi_id"])) {
                                $subParams['static']["transaksi_id"] = $insertID;
                            }
                            if (!isset($subParams['static']["transaksi_no"])) {
                                $subParams['static']["transaksi_no"] = $insertNum;
                            }

                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];
                        }
                        //arrPrint($subParams);
                        if (sizeof($subParams) > 0) {
                            arrprint($subParams);
                            cekhitam("subparam ada isinya");
                            if ($filterNeeded) {
                                if (isset($subParams['loop']) && sizeof($subParams['loop']) > 0) {
                                    $tmpOutParams[$cCtr][] = $subParams;
                                }
                            }
                            else {
                                $tmpOutParams[$cCtr][] = $subParams;
                            }
                        }
                        else {
                            cekhitam("subparam TIDAK ada isinya");
                        }
                    }
                }
                //cekHitam("cetak tmpOutParams");
                //arrPrint($tmpOutParams);
                //cekHitam();
                foreach ($iterator as $cCtr => $tComSpec) {
                    $srcGateName = $tComSpec['srcGateName'];
                    foreach ($_SESSION[$cCode][$srcGateName] as $id => $dSpec) {

                        $srcRawGateName = $tComSpec['srcRawGateName'];
                        $comName = $tComSpec['comName'];
                        if (substr($comName, 0, 1) == "{") {
                            $comName = trim($comName, "{");
                            $comName = trim($comName, "}");
                            $comName = str_replace($comName, $_SESSION[$cCode][$srcGateName][$id][$comName], $comName);
                            //                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                        }
                    }
                    echo "sub component: $comName, sending values <br>";

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();
                    //===filter value nol, jika harus difilter
                    if (sizeof($tmpOutParams[$cCtr]) > 0) {
                        $tobeExecuted = true;
                    }
                    else {
                        $tobeExecuted = false;
                    }

                    if ($tobeExecuted) {
                        cekMerah("$comName dieksekusiii");
                        arrPrint($tmpOutParams[$cCtr]);
                        $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }
                    else {
                        cekMerah("$comName tidak eksekusi");
                    }

                }
            }
            else {
                //cekKuning("subcomponents is not set");
            }
            //endregion
            //die();
            //</editor-fold>
            //endregion

            //
            //region processing main components, if in single step


            //==filter nilai, jika NOL tidak dikirim, sesuai config==
            $compValidators = ($this->config->item('transaksi_value_required_components') != null) ? $this->config->item('transaksi_value_required_components') : array();
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][1]['master'] : array();
            if (sizeof($iterator) > 0) {

                $cCtr = 0;
                foreach ($iterator as $cCtr => $tComSpec) {
                    $cCtr++;
                    $comName = $tComSpec['comName'];
                    if (substr($comName, 0, 1) == "{") {
                        $comName = trim($comName, "{");
                        $comName = trim($comName, "}");
                        $comName = str_replace($comName, $_SESSION[$cCode]['main'][$comName], $comName);
                    }
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "component # $cCtr: $comName<br>";

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            if (substr($key, 0, 1) == "{") {
                                $key = trim($key, "{");
                                $key = trim($key, "}");
                                $key = str_replace($key, $_SESSION[$cCode]['main'][$key], $key);
                            }

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;
                            //                            cekKuning("LOOP $key diisi dengan $realValue");
                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //===filter value nol, jika harus difilter
                    $tobeExecuted = true;

                    if (in_array($mdlName, $compValidators)) {

                        $loopParams = isset($tmpOutParams['loop']) ? $tmpOutParams['loop'] : array();
                        if (sizeof($loopParams) > 0) {
                            foreach ($loopParams as $key => $val) {
                                cekmerah("$comName : $key = $val ");
                                if ($val == 0) {
                                    unset($tmpOutParams['loop'][$key]);
                                }
                            }
                        }
                        if (sizeof($tmpOutParams['loop']) < 1) {
                            $tobeExecuted = false;
                        }

                    }

                    if ($tobeExecuted) {

                        //cekBiru("kiriman komponem $comName");
                        //                        arrPrint($tmpOutParams);
                        $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                        $m->exec() or die("Gagal saat berusaha  exec values pada komponen: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    }


                }
            }
            else {
                //cekKuning("components is not set");
            }


            //endregion

            //
            //region processing sub-post-processors, always
            //<editor-fold desc="----------sub postProc">
            //matiHere($_SESSION[$cCode]['main']['nomer']);
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['detail']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['detail'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "sub-postProcessor: $comName, initializing values <br>";
                    $tmpOutParams[$cCtr] = array();
                    foreach ($_SESSION[$cCode][$srcGateName] as $xid => $dSpec) {
                        $id = $dSpec['id'];
                        $subParams = array();
                        if (isset($tComSpec['loop'])) {
                            foreach ($tComSpec['loop'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['loop'][$key] = $realValue;

                            }
                        }
                        if (isset($tComSpec['static'])) {
                            foreach ($tComSpec['static'] as $key => $value) {

                                $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$id], $_SESSION[$cCode][$srcGateName][$id], 0);
                                $subParams['static'][$key] = $realValue;

                            }
                            if (!isset($subParams['static']["transaksi_id"])) {
                                $subParams['static']["transaksi_id"] = $masterID;
                            }
                            if (!isset($subParams['static']["transaksi_no"])) {
                                $subParams['static']["transaksi_no"] = $_SESSION[$cCode]['main']['nomer'];
                            }
                            $subParams['static']["fulldate"] = date("Y-m-d");
                            $subParams['static']["dtime"] = date("Y-m-d H:i:s");
                            $subParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $_SESSION[$cCode]['main']['nomer'] . " oleh " . $this->session->login['nama'];
                        }

                        if (sizeof($subParams) > 0) {
                            $tmpOutParams[$cCtr][] = $subParams;
                        }
                    }
                }

                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "sub-postProcessor: $comName, sending values <br>";

                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();


                    //                                        arrprint($tmpOutParams[$cCtr]);
                    //                                        matiHere();

                    $m->pair($tmpOutParams[$cCtr]) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                }
            }

            //</editor-fold>
            //endregion

            //
            //region processing main-post-processors, always
            //<editor-fold desc="----------postProc">
            $iterator = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['postProcessor'][1]['master'] : array();
            if (sizeof($iterator) > 0) {
                foreach ($iterator as $cCtr => $tComSpec) {
                    $comName = $tComSpec['comName'];
                    $srcGateName = $tComSpec['srcGateName'];
                    $srcRawGateName = $tComSpec['srcRawGateName'];
                    echo "post-processor: $comName<br>";

                    $dSpec = $_SESSION[$cCode][$srcGateName];
                    $tmpOutParams = array();
                    if (isset($tComSpec['loop'])) {
                        foreach ($tComSpec['loop'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['loop'][$key] = $realValue;

                        }
                    }
                    if (isset($tComSpec['static'])) {
                        foreach ($tComSpec['static'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName], $_SESSION[$cCode][$srcGateName], 0);
                            $tmpOutParams['static'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static']["transaksi_id"])) {
                            $tmpOutParams['static']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static']["transaksi_no"])) {
                            $tmpOutParams['static']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][1]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }
                    if (isset($tComSpec['static2'])) {
                        //cekHere("DISINI OIII");
                        foreach ($tComSpec['static2'] as $key => $value) {

                            $realValue = makeValue($value, $_SESSION[$cCode][$srcGateName][$cCtr], $_SESSION[$cCode][$srcGateName][$cCtr], 0);
                            $tmpOutParams['static2'][$key] = $realValue;

                        }
                        if (!isset($tmpOutParams['static2']["transaksi_id"])) {
                            $tmpOutParams['static2']["transaksi_id"] = $insertID;
                        }
                        if (!isset($tmpOutParams['static2']["transaksi_no"])) {
                            $tmpOutParams['static2']["transaksi_no"] = $insertNum;
                        }

                        $tmpOutParams['static2']["fulldate"] = date("Y-m-d");
                        $tmpOutParams['static2']["dtime"] = date("Y-m-d H:i:s");
                        $tmpOutParams['static2']["keterangan"] = $this->config->item('heTransaksi_ui')[$this->jenisTr]['steps'][$stepNum]['label'] . " nomor " . $tmpNomorNota . " oleh " . $this->session->login['nama'];


                    }

                    //lgShowError("Ada kesalahan",);
                    $mdlName = "Com" . ucfirst($comName);
                    $this->load->model("Coms/" . $mdlName);
                    $m = new $mdlName();

                    //cekBiru("kiriman komponem $comName");
                    //                    arrPrint($tmpOutParams);
                    $m->pair($tmpOutParams) or die("Tidak berhasil memasang  values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);
                    $m->exec() or die("Gagal saat berusaha  exec values pada post-processor: $comName/" . $this->jenisTr . "/" . __FUNCTION__ . "/" . __LINE__);


                }
            }
            else {

            }


            //</editor-fold>
            //endregion

            //region nulis paymentSource
            $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_source");
            $insertID = $masterID;
            if (array_key_exists($stepCode, $paymentSources)) {

                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs as $paymentSrcConfig) {
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        arrPrint($externSrc);
                        $tr->writePaymentSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $_SESSION[$cCode]['main']['nomer'],
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                            "terbayar" => 0,
                            "sisa" => isset($_SESSION[$cCode]['main'][$valueSrc]) ? $_SESSION[$cCode]['main'][$valueSrc] : 0,
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => (isset($externSrc['valasId']) && isset($_SESSION[$cCode]['main'][$externSrc['valasId']])) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => (isset($externSrc['valasLabel']) && isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']])) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => (isset($externSrc['valasValue']) && isset($_SESSION[$cCode]['main'][$externSrc['valasValue']])) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : 0,
                            "tagihan_valas" => (isset($externSrc['valasTagihan']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : 0,
                            "terbayar_valas" => (isset($externSrc['valasTerbayar']) && isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']])) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : 0,
                            "sisa_valas" => (isset($externSrc['valasSisa']) && isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']])) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : 0,

                        ));
                        cekMerah($this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion


            //
            //region nulis paymentAntiSource
            $stepCode = $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][1]['target'];
            $paymentSources = $this->config->item("payment_antiSource") != null ? $this->config->item("payment_antiSource") : array();
            $insertID = $masterID;
            if (array_key_exists($stepCode, $paymentSources)) {
                cekHitam(":: starting PAYMENT ANTI SOURCE");
                $payConfigs = $paymentSources[$stepCode];
                if (sizeof($payConfigs) > 0) {
                    foreach ($payConfigs as $paymentSrcConfig) {
                        $valueSrc = $paymentSrcConfig['valueSrc'];
                        $externSrc = $paymentSrcConfig['externSrc'];
                        $tr->writePaymentAntiSrc($insertID, array(
                            "jenis" => $stepCode,
                            "target_jenis" => $paymentSrcConfig['jenisTarget'],
                            "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                            "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                            "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                            "nomer" => $_SESSION[$cCode]['main']['nomer'],
                            "label" => $paymentSrcConfig['label'],
                            "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                            "terbayar" => 0,
                            "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                            "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                            "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                            "oleh_id" => $this->session->login['id'],
                            "oleh_nama" => $this->session->login['nama'],
                            "dtime" => date("Y-m-d H:i:s"),
                            "fulldate" => date("Y-m-d"),
                            "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                            "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                            "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                            "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                            "terbayar_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTerbayar']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTerbayar']] : '',
                            "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',

                        ));
                        //cekMerah($this->db->last_query());
                    }
                }


            }
            else {
                //cekMerah("TIDAK nulis paymentSrc");
            }
            //endregion


            //====registri value-gate
            $baseRegistries = array(
                'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields'][1] : array(),
                "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][1] : array(),
                "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptDetailFields2'][1] : array(),
                "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields2'][1] : array(),
            );

            //===
            $doWriteReg = $tr->writeRegistries($masterID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
            $mongRegID = $doWriteReg;
            cekHijau($this->db->last_query());

            //========extended steps (if any)
            //region extended steps
            if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                foreach ($_SESSION[$cCode]['main_inputs'] as $iKey => $iVal) {
                    if ($iVal > 0) {

                        cekbiru("evaluating $iKey ($iVal) for paymentSrc..");
                        $stepCode = $this->jenisTr . "_";
                        $paymentSources = $this->config->item("payment_source");


                        if (array_key_exists($stepCode, $paymentSources)) {
                            $payConfigs = $paymentSources[$stepCode];
                            cekbiru("$stepCode registered");


                            //===kalau melibatkan payment-source
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    if ($paymentSrcConfig['valueSrc'] == $iKey) {
                                        cekhijau($paymentSrcConfig['valueSrc'] . "/$iKey akan dieksekusi");
                                        $valueSrc = $paymentSrcConfig['valueSrc'];
                                        $externSrc = $paymentSrcConfig['externSrc'];
                                        if ($tr->paymentSrcExistsInMaster($insertID, $stepCode, $paymentSrcConfig['label'])) {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID sudah ada, tidak perlu ditulis");
                                        }
                                        else {
                                            cekhijau($paymentSrcConfig['label'] . " pada $stepCode $insertID BELUM ada, ditulis sekarang");
                                            $tr->writePaymentSrc($insertID, array(
                                                "_key" => $iKey,
                                                "jenis" => $stepCode,
                                                "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                                "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                                "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                                "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                                "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                                "label" => $paymentSrcConfig['label'],
                                                "tagihan" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "terbayar" => 0,
                                                "sisa" => $_SESSION[$cCode]['main_inputs'][$valueSrc],
                                                "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                                "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                                "oleh_id" => $this->session->login['id'],
                                                "oleh_nama" => $this->session->login['nama'],
                                                "dtime" => date("Y-m-d H:i:s"),
                                                "fulldate" => date("Y-m-d"),
                                                "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                                "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                                "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                                "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                                "terbayar_valas" => 0,
                                                "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                            ));
                                        }
                                        //									cekMerah("paySrc: ".$this->db->last_query());

                                    }
                                    else {
                                        cekmerah($paymentSrcConfig['valueSrc'] . "/$iKey tidak untuk dieksekusi");
                                    }
                                }
                            }

                        }
                        else {
                            cekbiru("$stepCode NOT registered");
                        }


                        //==periksa apakah mainInput memerlukan auth
                        if (array_key_exists($iKey, $inputAuthConfigs)) {
                            $gID = $inputAuthConfigs[$iKey];
                            if (strlen($gID) > 0) {
                                cekhijau("input $iKey bernilai $iVal memerlukan auth dari $gID");
                                $trA = new MdlTransaksi();
                                $exTmp = $trA->extStepExistsInMaster($insertID, $iKey);
                                cekhijau($this->db->last_query());
                                if ($exTmp) {
                                    cekhijau("extStep SUDAH terdaftar, sekarang nggak akan ditulis");
                                }
                                else {
                                    cekhijau("extStep belum terdaftar, sekarang hendak ditulis");
                                    $insertNew = $trA->writeExtStep($insertID, array(
                                        "master_id" => $insertID,
                                        "transaksi_id" => $insertID,
                                        "_key" => $iKey,
                                        "_label" => $inputLabels[$iKey],
                                        "_value" => $iVal,
                                        "group_id" => $gID,
                                        "state" => "0",
                                        "proposed_by" => $this->session->login['id'],
                                        "proposed_dtime" => date("Y-m-d H:i:s"),
                                        "done_by",
                                        "done_dtime",
                                    ));
                                    $mongoList['extras'][] = $insertNew;
                                    cekhijau($this->db->last_query());
                                }
                            }

                        }
                    }

                }
            }
            //endregion


            //==================================================================================================
            //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
            if ($masterID > 0) {

                $this->load->model("Mdls/MdlLockerTransaksi");
                $lt = New MdlLockerTransaksi();
                $lt->execLocker($_SESSION[$cCode]['main'], 0, $masterID, NULL);

            }
            //==================================================================================================
            //==========================================================================================================

            $pakai_ini = 0;
            if ($pakai_ini == 1) {
                //region connecting antar cabang


                $connector = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['connectTo']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['connectTo'] : "";
                if (strlen($connector) > 0) {
                    cekMerah(":: CONNECTING BEGIN...");
                    //cekMerah("to be connected to $connector");
                    if (sizeof($steps) == 1) {
                        //cekMerah("now connecting to $connector");
                        if (!array_key_exists($connector, $this->config->item("heTransaksi_ui"))) {
                            die("kode connector tidak dikenali!");
                        }
                        if (sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']) < 2) {
                            die("konfigurasi connector harus memiliki step lebih dari satu!");
                        }


                        $oldCode = $cCode;
                        $cCode = "_TR_" . $connector;


                        if (isset($_SESSION[$cCode])) {
                            $_SESSION[$cCode] = null;
                            unset($_SESSION[$cCode]);
                            $_SESSION[$cCode] = array();
                        }

                        $_SESSION[$cCode] = array(
                            "main" => $_SESSION[$oldCode]['main'],
                            "items" => $_SESSION[$oldCode]['items'],
                            //

                            "tableIn_master" => $_SESSION[$oldCode]['tableIn_master'],
                            "tableIn_detail" => $_SESSION[$oldCode]['tableIn_detail'],
                            //
                            "rsltItems" => $_SESSION[$oldCode]['rsltItems'],
                            //                        "out_detail_rsltItems" => $_SESSION[$oldCode]['out_detail_rsltItems'],
                            "tableIn_detail_rsltItems" => $_SESSION[$oldCode]['tableIn_detail_rsltItems'],
                            //
                            "tableIn_master_values" => $_SESSION[$oldCode]['tableIn_master_values'],
                            "tableIn_detail_values" => $_SESSION[$oldCode]['tableIn_detail_values'],
                            "tableIn_detail_values_rsltItems" => isset($_SESSION[$oldCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$oldCode]['tableIn_detail_values_rsltItems'] : array(),
                        );


                        //==replace pertama
                        $masterReplacersO = array(
                            "jenisTr" => $connector,
                            "jenisTrMaster" => $connector,
                            "jenisTrTop" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                            "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "stepCode" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "placeID" => $_SESSION[$oldCode]['main']['place2ID'],
                            "placeName" => $_SESSION[$oldCode]['main']['place2Name'],
                            "place2ID" => $_SESSION[$oldCode]['main']['placeID'],
                            "place2Name" => $_SESSION[$oldCode]['main']['placeName'],
                            "cabangID" => $_SESSION[$oldCode]['main']['place2ID'],
                            "cabangName" => $_SESSION[$oldCode]['main']['place2Name'],
                            "cabang2ID" => $_SESSION[$oldCode]['main']['placeID'],
                            "cabang2Name" => $_SESSION[$oldCode]['main']['placeName'],
                            //
                            "gudang2ID" => $_SESSION[$cCode]['main']['gudangID'],
                            "gudang2Name" => $_SESSION[$cCode]['main']['gudangName'],
                            "gudangID" => $_SESSION[$cCode]['main']['gudang2ID'],
                            "gudangName" => $_SESSION[$cCode]['main']['gudang2Name'],
                        );
                        foreach ($masterReplacersO as $key => $val) {
                            $_SESSION[$cCode]['main'][$key] = $val;
                            $_SESSION[$cCode]['main'][$key] = $val;
                        }
                        $masterReplacers = array(
                            //                        "referensi_id" => $masterID, (dimatikan)
                            "inv" => $tmpNomorNota,
                            //                        "jenis_master"    => $connector,

                            "jenis_master" => $connector,
                            "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            //                        "jenis_top" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "jenis_label" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['label'],
                            "transaksi_jenis" => $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'],
                            "cabang_id" => $_SESSION[$oldCode]['tableIn_master']['cabang2_id'],
                            "cabang_nama" => $_SESSION[$oldCode]['tableIn_master']['cabang2_nama'],
                            "cabang2_id" => $_SESSION[$oldCode]['tableIn_master']['cabang_id'],
                            "cabang2_nama" => $_SESSION[$oldCode]['tableIn_master']['cabang_nama'],
                            "gudang_id" => $_SESSION[$oldCode]['tableIn_master']['gudang2_id'],
                            "gudang_nama" => $_SESSION[$oldCode]['tableIn_master']['gudang2_nama'],
                            "gudang2_id" => $_SESSION[$oldCode]['tableIn_master']['gudang_id'],
                            "gudang2_nama" => $_SESSION[$oldCode]['tableIn_master']['gudang_nama'],

                            "step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                            "step_current" => 1,
                            "step_number" => 1,
                            "next_step_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                            "next_step_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                            "next_group_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                            "next_step_num" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? 2 : "0",
                        );
                        foreach ($masterReplacers as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }
                        arrPrint($_SESSION[$cCode]['tableIn_master']);

                        //region penomoran receipt #2
                        //<editor-fold desc="==========penomoran">
                        $this->load->model("CustomCounter");
                        $cn = new CustomCounter("transaksi");
                        $cn->setType("transaksi");

                        $counterForNumber = array($this->config->item('heTransaksi_core')[$connector]['formatNota']);
                        if (!in_array($counterForNumber[0], $this->config->item('heTransaksi_core')[$connector]['counters'])) {
                            die(__LINE__ . " Used number should be registered in 'counters' config as well");
                        }

                        foreach ($counterForNumber as $i => $cRawParams) {
                            $cParams = explode("|", $cRawParams);
                            $cValues = array();
                            foreach ($cParams as $param) {
                                $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                            }
                            $cRawValues = implode("|", $cValues[$i]);
                            $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                        }

                        $tmpNomorNota2 = $paramSpec['paramString'];


                        //</editor-fold>
                        //endregion

                        //region dynamic counters #2
                        // <editor-fold defaultstate="collapsed" desc="==========__init+update dynamic-counters ">
                        $cn = new CustomCounter("transaksi");
                        $cn->setType("transaksi");
                        $configCustomParams = $this->config->item('heTransaksi_core')[$connector]['counters'];
                        $configCustomParams[] = "stepCode";
                        if (sizeof($configCustomParams) > 0) {
                            $cContent = array();
                            foreach ($configCustomParams as $i => $cRawParams) {
                                $cParams = explode("|", $cRawParams);
                                $cValues = array();
                                foreach ($cParams as $param) {
                                    $cValues[$i][$param] = $_SESSION[$cCode]['main'][$param];
                                }
                                $cRawValues = implode("|", $cValues[$i]);
                                $paramSpec = $cn->getNewCount($cParams, $cValues[$i]);

                                $cContent[$cRawParams][$cRawValues] = $paramSpec['value'];
                                switch ($paramSpec['id']) {
                                    case 0: //===counter type is new
                                        $paramKeyRaw = print_r($cParams, true);
                                        $paramValuesRaw = print_r($cValues[$i], true);
                                        $cn->writeNewCount($cParams, $cValues[$i], $paramKeyRaw, $paramValuesRaw);
                                        break;
                                    default: //===counter to be updated
                                        $cn->updateCount($paramSpec['id'], $paramSpec['value']);
                                        break;
                                }
                                //echo "<hr>";
                            }
                        }
                        $appliedCounters2 = base64_encode(serialize($cContent));
                        $appliedCounters_inText2 = print_r($cContent, true);
                        // </editor-fold>
                        //endregion


                        $addValues = array(
                            'counters' => $appliedCounters,
                            'counters_intext' => $appliedCounters_inText,
                            'nomer' => $tmpNomorNota,
                            'dtime' => date("Y-m-d H:i:s"),
                            'fulldate' => date("Y-m-d"),
                        );
                        foreach ($addValues as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }

                        //===cloning nota cab1 ke cab2
                        //===daftar perbedaan
                        //== referensi_id, inv, jenis, nomer, counters, counters_inText, cabang_id, cabang_nama, cabang2_id, cabang2_nama,


                        //==replace kedua

                        $masterReplacers = array(
                            "nomer" => $tmpNomorNota2,
                            "counters" => $appliedCounters2,
                            "counters_intext" => $appliedCounters_inText2,
                        );
                        foreach ($masterReplacers as $key => $val) {
                            $_SESSION[$cCode]['tableIn_master'][$key] = $val;
                        }

                        //===cloning detail/items cabang1 ke cabang2
                        //===yang direplace: sub_step_number, sub_step_current, sub_step_avail, next_substep_num, next_substep_code, next_substep_label, next_subgroup_code
                        $detailReplacers = array(
                            "sub_step_avail" => sizeof($this->config->item("heTransaksi_ui")[$connector]['steps']),
                            "sub_step_current" => 1,
                            "sub_step_number" => 1,
                            "next_substep_num" => $_SESSION[$cCode]['tableIn_master']['next_step_num'],
                            "next_substep_code" => $_SESSION[$cCode]['tableIn_master']['next_step_code'],
                            "next_substep_label" => $_SESSION[$cCode]['tableIn_master']['next_step_label'],
                            "next_subgroup_code" => $_SESSION[$cCode]['tableIn_master']['next_group_code'],
                            //                    "next_substep_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['target'] : "",
                            //                    "next_substep_label" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['label'] : "",
                            //                    "next_subgroup_code" => isset($this->config->item("heTransaksi_ui")[$connector]['steps'][2]) ? $this->config->item("heTransaksi_ui")[$connector]['steps'][2]['userGroup'] : "",
                        );
                        if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $k => $dSpec) {
                                foreach ($dSpec as $key => $val) {
                                    $_SESSION[$cCode]['tableIn_detail'][$k][$key] = isset($detailReplacers[$key]) ? $detailReplacers[$key] : $val;
                                }
                            }
                        }

                        //region ----------write transaksi & transaksi_data #2
                        if (isset($_SESSION[$cCode]['tableIn_master']) && sizeof($_SESSION[$cCode]['tableIn_master']) > 0) {
                            $tr = new MdlTransaksi();
                            $tr->addFilter("transaksi.cabang_id='" . $this->session->login['cabang_id'] . "'");
                            $insertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                            $epID = $tr->writeMainEntries_entryPoint($insertID, $insertID, $_SESSION[$cCode]['tableIn_master']);
                            $insertNum = $_SESSION[$cCode]['tableIn_master']['nomer'];
                            $_SESSION[$cCode]['main']['nomer'] = $insertNum;
                            if ($insertID < 1) {
                                die("Gagal saat berusaha  write transaction entry pada " . __FILE__ . " baris " . __LINE__);
                            }
                        }
                        if (isset($_SESSION[$cCode]['tableIn_master_values']) && sizeof($_SESSION[$cCode]['tableIn_master_values']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_master_values'] as $key => $val) {
                                $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            }
                        }

                        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
                            foreach ($_SESSION[$cCode]['main_add_values'] as $key => $val) {
                                $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                            }
                        }

                        if (isset($_SESSION[$cCode]['main_inputs']) && sizeof($_SESSION[$cCode]['main_inputs']) > 0) {
                            cekkuning("main_inputs detected");
                            foreach ($_SESSION[$cCode]['main_inputs'] as $key => $val) {
                                $tr->writeMainValues($insertID, array("key" => $key, "value" => $val));
                                //                            cekkuning("making a clone for input key $key / $val");
                                //                            $subInputInsertID = $tr->writeMainEntries($_SESSION[$cCode]['tableIn_master']);
                            }
                        }

                        if (isset($_SESSION[$cCode]['main_add_fields']) && sizeof($_SESSION[$cCode]['main_add_fields']) > 0) {
                            foreach ($_SESSION[$cCode]['main_add_fields'] as $key => $val) {
                                $tr->writeMainFields($insertID, array("key" => $key, "value" => $val));
                            }
                        }


                        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
                            foreach ($_SESSION[$cCode]['main_elements'] as $elName => $aSpec) {
                                $tr->writeMainElements($insertID, array(
                                    "mdl_name" => isset($aSpec['mdl_name']) ? $aSpec['mdl_name'] : "",
                                    "key" => isset($aSpec['key']) ? $aSpec['key'] : 0,
                                    "value" => isset($aSpec['value']) ? $aSpec['value'] : "",
                                    "name" => $aSpec['name'],
                                    "label" => $aSpec['label'],
                                    "contents" => isset($aSpec['contents']) ? $aSpec['contents'] : "",
                                    "contents_intext" => isset($aSpec['contents_intext']) ? print_r($aSpec['contents_intext'], true) : "",

                                ));
                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail']) && sizeof($_SESSION[$cCode]['tableIn_detail']) > 0) {
                            $insertIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail'] as $dSpec) {
                                $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                                if ($epID != 999) {
                                    $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                }
                            }
                        }
                        if (isset($_SESSION[$cCode]['tableIn_detail2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail2_sum']) > 0) {
                            $insertIDs = array();
                            foreach ($_SESSION[$cCode]['tableIn_detail2_sum'] as $dSpec) {
                                $insertIDs[] = $tr->writeDetailEntries($insertID, $dSpec);
                                if ($epID != 999) {
                                    $insertIDs[] = $tr->writeDetailEntries($epID, $dSpec);
                                }
                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail_values']) && sizeof($_SESSION[$cCode]['tableIn_detail_values']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_detail_values'] as $pID => $dSpec) {
                                if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'])) {
                                    foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues'] as $key => $src) {
                                        $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                            "produk_jenis" => $_SESSION[$cCode]['tableIn_detail'][$pID]['produk_jenis'],
                                            "produk_id" => $pID,
                                            "key" => $key,
                                            "value" => $dSpec[$src],
                                        ));
                                    }
                                }


                            }
                        }

                        if (isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) && sizeof($_SESSION[$cCode]['tableIn_detail_values2_sum']) > 0) {
                            foreach ($_SESSION[$cCode]['tableIn_detail_values2_sum'] as $pID => $dSpec) {
                                if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'])) {
                                    foreach ($this->config->item('heTransaksi_core')[$this->jenisTr]['tableIn']['detailValues2_sum'] as $key => $src) {
                                        $insertIDs[] = $tr->writeDetailValues($insertID, array(
                                            "produk_jenis" => $_SESSION[$cCode]['tableIn_detail2_sum'][$pID]['produk_jenis'],
                                            "produk_id" => $pID,
                                            "key" => $key,
                                            "value" => $dSpec[$src],
                                        ));
                                    }
                                }


                            }
                        }

                        $tr = new MdlTransaksi();
                        $dupState = $tr->updateData(array("id" => $insertID), array(
                            "id_master" => $masterID,
                            "id_top" => $insertID,

                        )) or die("Failed to update tr next-state!");
                        //cekHijau($this->db->last_query());

                        $baseRegistries = array(
                            'main' => isset($_SESSION[$cCode]['main']) ? $_SESSION[$cCode]['main'] : array(),
                            'items' => isset($_SESSION[$cCode]['items']) ? $_SESSION[$cCode]['items'] : array(),
                            'items2' => isset($_SESSION[$cCode]['items2']) ? $_SESSION[$cCode]['items2'] : array(),
                            'items2_sum' => isset($_SESSION[$cCode]['items2_sum']) ? $_SESSION[$cCode]['items2_sum'] : array(),
                            'rsltItems' => isset($_SESSION[$cCode]['rsltItems']) ? $_SESSION[$cCode]['rsltItems'] : array(),
                            'rsltItems2' => isset($_SESSION[$cCode]['rsltItems2']) ? $_SESSION[$cCode]['rsltItems2'] : array(),

                            'tableIn_master' => isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array(),
                            'tableIn_detail' => isset($_SESSION[$cCode]['tableIn_detail']) ? $_SESSION[$cCode]['tableIn_detail'] : array(),
                            'tableIn_detail2_sum' => isset($_SESSION[$cCode]['tableIn_detail2_sum']) ? $_SESSION[$cCode]['tableIn_detail2_sum'] : array(),
                            'tableIn_detail_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems'] : array(),
                            'tableIn_detail_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_rsltItems2'] : array(),
                            'tableIn_master_values' => isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array(),
                            'tableIn_detail_values' => isset($_SESSION[$cCode]['tableIn_detail_values']) ? $_SESSION[$cCode]['tableIn_detail_values'] : array(),
                            'tableIn_detail_values_rsltItems' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems'] : array(),
                            'tableIn_detail_values_rsltItems2' => isset($_SESSION[$cCode]['tableIn_detail_values_rsltItems2']) ? $_SESSION[$cCode]['tableIn_detail_values_rsltItems2'] : array(),
                            'tableIn_detail_values2_sum' => isset($_SESSION[$cCode]['tableIn_detail_values2_sum']) ? $_SESSION[$cCode]['tableIn_detail_values2_sum'] : array(),
                            'main_add_values' => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
                            'main_add_fields' => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
                            'main_elements' => isset($_SESSION[$cCode]['main_elements']) ? $_SESSION[$cCode]['main_elements'] : array(),
                            'main_inputs' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                            'main_inputs_orig' => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
                            "receiptDetailFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields'][1] : array(),
                            "receiptSumFields" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields'][1] : array(),
                            "receiptDetailFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptDetailFields2'][1] : array(),
                            "receiptSumFields2" => isset($this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1]) ? $this->config->item("heTransaksi_layout")[$connector]['receiptSumFields2'][1] : array(),
                        );
                        //                    cekHitam("cetak transaksi $cCode");
                        $doWriteReg = $tr->writeRegistries($insertID, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));

                        //endregion

                        //
                        //region nulis paymentSource
                        //                    $stepCode = $connector;
                        $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                        $paymentSources = $this->config->item("payment_source");
                        cekHitam(":: $stepCode ::");
                        if (array_key_exists($stepCode, $paymentSources)) {

                            $payConfigs = $paymentSources[$stepCode];
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                                    $valueSrc = $paymentSrcConfig['valueSrc'];
                                    $externSrc = $paymentSrcConfig['externSrc'];
                                    $tr->writePaymentSrc($insertID, array(
                                        "jenis" => $connector,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                        "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                        "label" => $paymentSrcConfig['label'],
                                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "terbayar" => 0,
                                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                        "oleh_id" => $this->session->login['id'],
                                        "oleh_nama" => $this->session->login['nama'],
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                        "valas_id" => isset($_SESSION[$cCode]['main'][$externSrc['valasId']]) ? $_SESSION[$cCode]['main'][$externSrc['valasId']] : '',
                                        "valas_nama" => isset($_SESSION[$cCode]['main'][$externSrc['valasLabel']]) ? $_SESSION[$cCode]['main'][$externSrc['valasLabel']] : '',
                                        "valas_nilai" => isset($_SESSION[$cCode]['main'][$externSrc['valasValue']]) ? $_SESSION[$cCode]['main'][$externSrc['valasValue']] : '',
                                        "tagihan_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasTagihan']]) ? $_SESSION[$cCode]['main'][$externSrc['valasTagihan']] : '',
                                        "terbayar_valas" => 0,
                                        "sisa_valas" => isset($_SESSION[$cCode]['main'][$externSrc['valasSisa']]) ? $_SESSION[$cCode]['main'][$externSrc['valasSisa']] : '',
                                    ));
                                    //cekMerah($this->db->last_query());
                                }
                            }


                        }
                        else {
                            //cekMerah("TIDAK nulis paymentSrc");
                        }
                        //endregion


                        //region nulis paymentAntiSource
                        //                    $stepCode = $connector;
                        $stepCode = $this->config->item("heTransaksi_ui")[$connector]['steps'][1]['target'];
                        $paymentSources = $this->config->item("payment_antiSource");
                        if (array_key_exists($stepCode, $paymentSources)) {

                            $payConfigs = $paymentSources[$stepCode];
                            if (sizeof($payConfigs) > 0) {
                                foreach ($payConfigs as $paymentSrcConfig) {
                                    //					$paymentSrcConfig = $paymentSources[$stepCode];
                                    $valueSrc = $paymentSrcConfig['valueSrc'];
                                    $externSrc = $paymentSrcConfig['externSrc'];
                                    $tr->writePaymentAntiSrc($insertID, array(
                                        "jenis" => $connector,
                                        "target_jenis" => $paymentSrcConfig['jenisTarget'],
                                        "reference_jenis" => $paymentSrcConfig['jenisSrc'],
                                        "extern_id" => $_SESSION[$cCode]['main'][$externSrc['id']],
                                        "extern_nama" => $_SESSION[$cCode]['main'][$externSrc['nama']],
                                        "nomer" => $_SESSION[$cCode]['main']['nomer'],
                                        "label" => $paymentSrcConfig['label'],
                                        "tagihan" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "terbayar" => 0,
                                        "sisa" => $_SESSION[$cCode]['main'][$valueSrc],
                                        "cabang_id" => $_SESSION[$cCode]['main']['placeID'],
                                        "cabang_nama" => $_SESSION[$cCode]['main']['placeName'],
                                        "oleh_id" => $this->session->login['id'],
                                        "oleh_nama" => $this->session->login['nama'],
                                        "dtime" => date("Y-m-d H:i:s"),
                                        "fulldate" => date("Y-m-d"),
                                    ));
                                    //cekMerah($this->db->last_query());
                                }
                            }


                        }
                        else {
                            //cekMerah("TIDAK nulis paymentSrc");
                        }
                        //endregion


                    }
                    else {
                        //cekMerah("to be delayed to connect to $connector");
                    }
                }
                else {
                    //cekKuning("not connecting to any tCode");
                }

                //endregion
            }


            cekMerah("TRANSAKSI DONE");

            //region writelog
            $this->load->model("Mdls/" . "MdlActivityLog");
            $hTmp = new MdlActivityLog();
            $tmpHData = array(
                "title" => $_SESSION[$cCode]['main']['jenisTrName'],
                "sub_title" => "Saving new transaction",
                "uid" => $this->session->login['id'],
                "uname" => $this->session->login['nama'],
                "dtime" => date("Y-m-d H:i:s"),
                "transaksi_id" => $masterID,
                "deskripsi_old" => "",
                "deskripsi_new" => base64_encode(serialize($_SESSION[$cCode])),
                "jenis" => $this->jenisTr,
                "ipadd" => $_SERVER['REMOTE_ADDR'],
                "devices" => $_SERVER['HTTP_USER_AGENT'],
                "category" => "transaksi",
                "controller" => $this->uri->segment(1),
                "method" => $this->uri->segment(2),
                "url" => current_url(),

            );
            $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Gagal menulis riwayat data", __FILE__));
            //endregion

            validateAllBalances();
            //            arrPrint($mongUpdateList['update']['detail']);
            //                                    mati_disini("EDIT transaction under maintenance");

            $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
            //region cloning update mongo
            if (sizeof($mongUpdateList) > 0) {
                $mong = new MdlMongoMother();
                foreach ($mongUpdateList as $metode => $tmpData) {
                    if ($metode == "update") {
                        if (sizeof($tmpData) > 0) {
                            foreach ($tmpData as $gate => $fildsData) {
                                $mong->setTableName($this->mongoTableList[$gate]);
                                foreach ($fildsData as $mongUpadte) {
                                    $mong->updateData($mongUpadte['where'], $mongUpadte['value']);
                                }
                            }
                        }
                    }

                }
            }

            //endregion
            //region cloning ke mongo
            if (sizeof($mongoList) > 0) {
                $mong = new MdlMongoMother();
                $tr = new MdlTransaksi();
                foreach ($mongoList as $gateList => $listIDSData) {
                    $tr->setFilters(array());
                    $tr->setSortBy(array());
                    $tr->setTableName($this->mongoTableList[$gateList]);
                    $tr->addFilter("id in (" . implode(",", $listIDSData) . ")");
                    $tmpTrm = $tr->lookUpAll()->result();

                    if (sizeof($tmpTrm) > 0) {
                        $mong->setTableName($this->mongoTableList[$gateList]);
                        foreach ($tmpTrm as $tmpMain) {
                            $transksi_main = json_decode(json_encode($tmpMain), true);
                            //                            arrPrint($transksi_main);
                            $mong->addData($transksi_main);
                        }
                    }
                    //                    cekHitam($listedTable[$gateList]);
                    //                    cekLime($gateList);

                }
            }
            if (sizeof($mongRegID) > 0) {
                //                $arrMainID = $mongoList['main'];
                $tr->setTableName("transaksi_registry");
                $tr->setFilters(array());
                $tr->setSortBy(array());
                $tr->addFilter("id in (" . implode(",", $mongRegID) . ")");
                $tmpTrm = $tr->lookUpAll()->result();

                $mong->setTableName("transaksi_registry");
                if (sizeof($tmpTrm) > 0) {
                    foreach ($tmpTrm as $tmpMain) {
                        $transksi_main = json_decode(json_encode($tmpMain), true);
                        arrPrint($transksi_main);
                        $mong->addData($transksi_main);
                    }
                }

            }
            //endregion


            if (isset($_SESSION[$cCode])) {
                unset($_SESSION[$cCode]);
            }
            if (isset($oldCode)) {
                if (isset($_SESSION[$oldCode])) {
                    unset($_SESSION[$oldCode]);
                }
            }
            echo "<script>top.close_holdon()</script>";

            //region feedback msg
            $this->session->errMsg = "transaction entry has been saved<br>";
            $nextNum = $nextProp["num"];
            if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
                $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
                $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;

            }
            else {
                $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
                $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;

            }
            $trBackClick = "location.href='$trBackLink'";
            //            $this->session->errMsg .= "<a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
            //endregion
            $arrAlert = array(
                "type" => "success",
                "title" => "Transaction saved",
                //                        "html" => "your order has been saved and ready to process",
                "html" => $this->session->errMsg,
                "timer" => "1500",
                "showConfirmButton" => false,
                "allowOutsideClick" => false,
            );
            echo swalAlert($arrAlert);
            echo "<script>topReload(1500)</script>";
            echo topReload();
            echo "</script>";
            unset($this->session->errMsg);


        }
        else {
            die("the gate index you want to debug has not been formed yet!");
        }
    }

    //editor faktur, no more step avail
    public function preMainFaktur()
    {

        //        $no = rtrim($this->uri->segment(3), "-");
        $no = $_GET["id"];
        //cekHitam(":: $no");

        //        $targetStepNum = $this->uri->segment(4);
        $stepNumber = $this->uri->segment(4);
        //        $currentStepNum = $this->uri->segment(5);

        $rawBuilderURL = blobEncode(current_url());

        //
        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();

        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        //        $tr->addFilter("step_number='" . $currentStepNum . "'");
        $tmpTr = $tr->lookupJoined()->result();
        cekBiru($this->db->last_query());
        //        arrprint($tr->getFilters());
        //endregion


        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        //        cekKuning($this->db->last_query());
        if (sizeof($tmpSign) > 0) {
            $sCtr = 0;
            foreach ($tmpSign as $row) {

                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }

        $rawItems = array();

        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;
            $cCode = "_TR_" . $this->jenisTr;
            if (isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = null;
                unset($_SESSION[$cCode]);
            }

            //            $stepNumber = isset($_SESSION[$cCode]['tableIn_master']['step_number']) ? $_SESSION[$cCode]['tableIn_master']['step_number'] : 1;
            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            //endregion

            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$stepNumber] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$stepNumber] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$stepNumber] : null;
            //            $masterID = isset($tmpTr[0]->referensi_id) && $tmpTr[0]->referensi_id > 0 ? $tmpTr[0]->referensi_id : $tmpTr[0]->transaksi_id;
            $measurementDetails = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["receiptMesurementRows"] : array();
            $validatePaymentLocker = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["validatePaymentSource"][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["validatePaymentSource"][$stepNumber] : array();
            $itemsChild = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fields']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["shopingCartDetailFields"][$stepNumber]['fields'] : array();//dipake detil pembelian aset
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            $currentStepNum = $tmpTr[0]->step_number;


            $allowEdit = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowEdit'] : false;
            $allowCancel = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$stepNumber]['allowCancel'] : false;
            $editableFields = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$stepNumber] : array();


            //region valid items
            $this->load->model("MdlTransaksi");
            $tr = new MdlTransaksi();
            $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");


            $tmpTr = $tr->lookupJoined()->result();
            cekhitam($this->db->last_query());

            $id_top = isset($tmpTr[0]->id_top) ? $tmpTr[0]->id_top : "";


            //            arrPrint($tmpTr);


            $extractedItems = array();//==untuk urusan update transaksi referer
            $validItems = array();
            $validItemSends = array();
            $validItemReqCancels = array();
            $validItemCancels = array();
            $validItemPreCancels = array();
            $validItemSents = array();

            if (sizeof($tmpTr) > 0) {
                foreach ($tmpTr as $row) {
                    if (!isset($validItems[$row->produk_id])) {
                        $validItems[$row->produk_id] = 0;
                    }
                    if (!isset($validItemSends[$row->produk_id])) {
                        $validItemSends[$row->produk_id] = 0;
                    }
                    if (!isset($validItemCancels[$row->produk_id])) {
                        $validItemCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemReqCancels[$row->produk_id])) {
                        $validItemReqCancels[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPackeds[$row->produk_id])) {
                        $validItemPackeds[$row->produk_id] = 0;
                    }
                    if (!isset($validItemPreCancels[$row->produk_id])) {
                        $validItemPreCancels[$row->produk_id] = 0;
                    }

                    $validItems[$row->produk_id] += isset($row->valid_qty) ? $row->valid_qty : 0;
                    $validItemSends[$row->produk_id] += isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0;
                    $validItemCancels[$row->produk_id] += isset($row->cancel_qty) ? $row->cancel_qty : 0;
                    $validItemReqCancels[$row->produk_id] += isset($row->req_cancel_qty) ? $row->req_cancel_qty : 0;
                    $validItemPreCancels[$row->produk_id] += isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0;
                    $validItemPackeds[$row->produk_id] += isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0;

                    if (!isset($extractedItems[$row->produk_id])) {
                        $extractedItems[$row->produk_id] = array();
                    }
                    $extractedItems[$row->produk_id][$row->id] = array(
                        "id" => $row->id,
                        "produk_id" => $row->produk_id,
                        "qty" => $row->produk_ord_jml,
                        "valid_qty" => $row->valid_qty,
                        "transaksi_id" => $row->transaksi_id,
                        "packed_qty" => isset($arrTmp__['582pkd'][$row->produk_id]) ? $arrTmp__['582pkd'][$row->produk_id] : 0,
                        "sent_qty" => isset($arrTmp__['582spd'][$row->produk_id]) ? $arrTmp__['582spd'][$row->produk_id] : 0,
                        "req_cancel_qty" => isset($arrPreTmp__['1982'][$row->produk_id]) ? $arrPreTmp__['1982'][$row->produk_id] : 0,
                        "cancel_qty" => $row->cancel_qty,
                        "outstanding" => $row->produk_ord_jml - ($row->produk_ord_jml - $row->valid_qty),
                    );
                }
            }
            else {
                cekmerah("TIDAK ada yang mau diekstrak");
            }

            //endregion


            //
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //            //cekMerah($this->db->last_query());
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //            arrPrint($detailValues);
            //endregion


            //region take from registries
            //==ambil value-gate
            $trr = new MdlTransaksi();
            $trr->setFilters(array());
            $trr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
            //            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $tmpReg = $trr->lookupRegistries()->result();
            //            $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();
            //            cekKuning($this->db->last_query());
            //            matiHere();
            $main = array();

            $items = array();
            $items2 = array();
            $items2_sum = array();
            $items3 = array();
            $items3_sum = array();
            $rsltItems = array();
            $rsltItems2 = array();

            $masterGates = array();
            $childGates = array();
            $childGates2 = array();
            $childGates2_sum = array();
            $childGatesRsltItems = array();
            $childGatesRsltItems2 = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $childTableInParamsRsltItems = array();
            $childTableInParamsRsltItems2 = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $childTableInValueParamsRsltItems = array();
            $childTableInValueParamsRsltItems2 = array();
            $masterAddValues = array();
            $masterAddFields = array();
            //            $mainApplets = array();
            $mainElements = array();
            $mainInputs = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = $main + unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = $items + unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = $items2 + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems"://
                            $rsltItems = $rsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "rsltItems2"://
                            $rsltItems2 = $rsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = $items2_sum + unserialize(base64_decode($row->values));
                            break;
                        case "items3"://
                            $items3 = $items3 + unserialize(base64_decode($row->values));
                            break;
                        case "items3_sum"://
                            $items3_sum = $items3_sum + unserialize(base64_decode($row->values));
                            break;

                        case "tableIn_master"://
                            $masterTableInParams = $masterTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = $childTableInParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems"://
                            $childTableInParamsRsltItems = $childTableInParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_rsltItems2"://
                            $childTableInParamsRsltItems2 = $childTableInParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = $masterTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = $childTableInValueParams + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems"://
                            $childTableInValueParamsRsltItems = $childTableInValueParamsRsltItems + unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values_rsltItems2"://
                            $childTableInValueParamsRsltItems2 = $childTableInValueParamsRsltItems2 + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = $masterAddValues + unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = $masterAddFields + unserialize(base64_decode($row->values));
                            break;
                        //                        case "main_applets"://
                        //                            $mainApplets = unserialize(base64_decode($row->values));
                        //                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                        case "main_inputs"://
                            $mainInputs = unserialize(base64_decode($row->values));
                            break;
                    }
                }

            }
            else {
                die("Cannot read the registry entries from** $masterID!");
            }
            //endregion
            //region replacer Downpayment avail
            if (isset($mainInputs['dp'])) {
                if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["updateDownpayment"][$stepNumber])) {
                    //                    arrPrint($mainInputs);
                    $this->load->model("Coms/ComLockerValue");
                    $mi = new ComLockerValue();
                    $mi->addFilter("produk_id='" . $main['masterID'] . "'");
                    $mainInputAvail = $mi->fetchBalances("downpayment");
                    $lockerVal = $mainInputAvail[0]->nilai;
                    //                    $mainValTmp = reversePpn($mainInputs['dp'],"10");
                    $mainValTmp_dp = $main['dp_value'];
                    $mainValTmp_dp_ppn = $main['dp_ppn_value'];

                    if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                        cekOrange();
                        $validate = round($mainInputAvail[0]->nilai - $mainValTmp_dp, 2);
                        if ($lockerVal > 0) {
                            $valnew = $main['new_net1'] - $lockerVal > 0 ? 0 : $main['new_net1'];
                            $main['dp_value'] = $valnew;
                            $main['dp_ppn_value'] = $valnew * 10 / 100;
                        }
                        else {
                            $main['dp_value'] = 0;
                            $main['dp_ppn_value'] = 0;
                            //                        $main['valid_dp'] = 0;
                        }

                        if ($validate > 0) {
                            $mainInputs['dp'] = $mainInputAvail[0]->nilai;

                        }
                        else {
                            if ($validate < 0) {
                                if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                                    $main['downpayment'] = $mainInputs['dp'];
                                    $mainInputs['downpayment'] = $mainInputs['dp'];
                                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['dp_ppn_value'];

                                }
                                unset($mainInputs['dp']);
                                //                                cekhere("sini po");
                            }
                            //                        if(!isset($main['valid_dp'])){
                            //                            $main['valid_dp'] = $mainInputAvail[0]->nilai;
                            //                        }

                        }
                    }
                    else {
                        //                         $mainInputs['dp'] = 0;
                        $main['dp_value'] = 0;
                        $main['dp_ppn_value'] = 0;
                        unset ($mainInputs['dp']);
                    }

                    if (!isset($main['valid_dp'])) {
                        $main['valid_dp'] = $mainInputAvail[0]->nilai;
                    }
                }


            }
            else {
                if (isset($main['valid_dp']) && $main['valid_dp'] > 0) {
                    $main['downpayment'] = $main['dp'];
                    $mainInputs['downpayment'] = $main['dp'];
                    //                    $main['total_ui'] = $masterTableInValueParams['tagihan'] - $masterTableInValueParams['nilai_tambah_ppn_out'];
                    $main['total_ui'] = $masterTableInValueParams['new_net1'] - $main['valid_dp'];
                    cekBiru($masterTableInValueParams['new_net1'] . " - " . $main['valid_dp']);
                }
            }
            //endregion

            $masterReplacers = array(
                "jenisTrMaster" => $this->jenisTr,
                "jenisTrTop" => $masterTableInParams['jenis_top'],
                "harga" => 0,
                "masterID" => $masterID,
            );
            foreach ($masterReplacers as $key => $src) {
                $main[$key] = $src;
                $mainValues[$key] = $src;
                $masterGates[$key] = $src;
            }


            //==revalidate items
            $this->load->library("FieldCalculator");
            $this->load->helper("he_angka");
            $cal = new FieldCalculator();

            //arrPrint($items);
            $itemChildData = array();
            if (sizeof($items) > 0) {

                foreach ($items as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $tipeSize = isset($iSpec['detilSize']) && sizeof($iSpec['detilSize']) > 0 ? $iSpec['detilSize'] : "";

                    if (array_key_exists($id, $validItems)) {
                        $items[$id]['jml'] = $validItems[$id];
                        //                        $items[$id]['jml'] = $validItems[$id]-(int)$validItemPreCancels[$id];
                        $items[$id]['max_jml'] = $validItems[$id];
                        //                        $items[$id]['max_jml'] = $validItems[$id]-(int)$validItemPreCancels[$id];
                        $items[$id]['packed_jml'] = $validItemPackeds[$id];
                        $items[$id]['sent_jml'] = $validItemSends[$id];
                        $items[$id]['cancel_jml'] = $validItemCancels[$id];
                        $items[$id]['req_cancel_jml'] = $validItemPreCancels[$id];
                        if (sizeof($editableFields) > 0) {
                            foreach ($editableFields as $fName) {
                                $items[$id]["max_$fName"] = isset($iSpec[$fName]) ? $iSpec[$fName] : 0;
                            }
                        }

                        if (sizeof($measurementDetails)) {
                            if (in_array($stepNumber, $measurementDetails["allowView"]) && isset($measurementDetails[$tipeSize])) {
                                $selectedColl = $measurementDetails[$tipeSize];
                                foreach ($selectedColl as $colSelected => $tempHelper) {
                                    //                                    cekHitam("$heAngka");

                                    foreach ($tempHelper as $newKey => $heAngka) {
                                        cekHitam($newKey);
                                        $items[$id][$newKey] = $heAngka($iSpec[$colSelected]);
                                    }
                                    //
                                }
                            }

                        }


                        if ($subAmountConfig != null) {
                            $tmpEx = $cal->multiExplode($subAmountConfig);
                            if (sizeof($tmpEx) > 1) {
                                //                            echo lgShowAlert("menghitung subtotal pakai rumus $subAmountConfig di step ke # $stepNumber");
                                $newSrc = $subAmountConfig;
                                foreach ($tmpEx as $key2 => $val2) {
                                    if (isset($items[$id][$val2])) {
                                        $newSrc = str_replace($val2, $items[$id][$val2], $newSrc);

                                    }
                                    else {
                                        if (isset($tmp[$val2])) {
                                            $newSrc = str_replace($val2, $items[$val2], $newSrc);

                                        }
                                        else {
                                            $newSrc = str_replace($val2, "0", $newSrc);

                                        }
                                    }


                                }
                                $subtotal = $cal->calculate($newSrc);


                            }
                            else {
                                //                            echo lgShowAlert("memasang subtotal dari $subAmountConfig");
                                $subtotal = $items[$id][$subAmountConfig];

                            }
                        }
                        else {
                            //                        echo lgShowAlert("tidak mengapa-apakan subtotal");
                            $subtotal = 0;

                        }

                        $items[$id]['subtotal'] = $subtotal;
                        //region item child
                        if (sizeof($itemsChild) > 0) {
                            for ($x = 1; $x <= $validItems[$id]; $x++) {
                                foreach ($itemsChild as $col => $col_label) {
                                    $itemChildData[$id][$x][$col] = isset($items[$id][$col]) ? $items[$id][$col] : "";
                                    $itemChildData[$id][$x]["jml"] = 1;
                                    $itemChildData[$id][$x]["qty"] = 1;
                                    $itemChildData[$id][$x]["folders"] = $main['pihakMainID'];
                                }

                            }
                            //                            arrPrint($itemsChild);
                            //                        foreach ($itemsChild as )
                        }

                        //endregion
                    }
                    else {
                        cekUngu(":: masuk sini, UNSET semua ::");
                        unset($items[$id]);
                        unset($childGates[$id]);
                        unset($childTableInParams[$id]);
                        unset($childTableInValueParams[$id]);

                    }


                }
            }

            //            arrPrint($items);
            //            matiHere();

            //region session-swapper
            $swappers = array(
                "main" => $main,
                "items" => $items,
                "items2" => $items2,
                "items2_sum" => $items2_sum,
                "items3" => $items3,
                "items3_sum" => $items3_sum,
                "items_child" => $itemChildData,
                "rsltItems" => $rsltItems,
                "rsltItems2" => $rsltItems2,
                "extractedItems" => $extractedItems,


                "tableIn_master" => $masterTableInParams,
                "tableIn_detail" => $childTableInParams,
                "tableIn_detail_rsltItems" => $childTableInParamsRsltItems,
                "tableIn_detail_rsltItems2" => $childTableInParamsRsltItems2,
                "tableIn_master_values" => $masterTableInValueParams,
                "tableIn_detail_values" => $childTableInValueParams,
                "tableIn_detail_values_rsltItems" => $childTableInValueParamsRsltItems,
                "tableIn_detail_values_rsltItems2" => $childTableInValueParamsRsltItems2,
                "main_add_values" => $masterAddValues,
                //        ""=>$childAddValues ,
                "main_add_fields" => $masterAddFields,
                //                "main_applets"          => $mainApplets,
                "main_elements" => $mainElements,
                "main_inputs" => $mainInputs,
                //
                "extSteps" => $extSteps,
                "paySrcs" => $paySrcs,
                "lockerPayment" => $tempBtnUndo,
            );
            foreach ($swappers as $targetVar => $src) {
                $_SESSION[$cCode][$targetVar] = $src;

            }
            //endregion


            //==init replacer


            //==recover nilai HARGA master
            $_SESSION[$cCode]['main']['harga'] = 0;


            //==default load dari nota, maka dianggap langsung done
            $_SESSION[$cCode]['main']['status_4'] = 1;
            $_SESSION[$cCode]['main']['trash_4'] = 0;
            if (sizeof($_SESSION[$cCode]['items']) > 0) {
                foreach ($_SESSION[$cCode]['items'] as $xid => $iSpec) {
                    $id = $iSpec['id'];
                    $_SESSION[$cCode]['main']['harga'] += ($iSpec['jml'] * $iSpec['harga']);

                }
            }

            $this->load->helper("he_value_builder");
            resetValues($this->jenisTr);

            fillValues($this->jenisTr, $this->uri->segment(5), $this->uri->segment(4));


            $actionTarget = "top.BootstrapDialog.closeAll();top.BootstrapDialog.show(
                                   {
                                       title:'Followup preview',
                                       message: " . 'top.$' . "('<div></div>').load('" . base_url() . "Transaksi/editMainFaktur/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "?rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        type:top.BootstrapDialog.TYPE_DEFAULT,
                                        draggable:true,
                                        closable:false,
                                        
                                        
                                        }
                                        );";
            //        echo "</script>";

            //            echo "<html>";
            //            echo "<head>";
            //            echo "<script src=\"" . cdn_suport() . "AdminLTE-2.3.11/plugins/jQuery/jquery-2.2.3.min.js\"></script>";
            //            echo "</head>";
            //            echo "<body onload=\"$actionTarget\">";
            echo "<script>top.close_holdon();$actionTarget</script>";
            //            echo "</body>";
            //            echo "</html>";
        }
        else {
            die(lgShowAlert("No such transaction. You may want to refresh the browser to re-fetch actual content."));
        }
    }

    public function editMainFaktur()
    {
        $no = rtrim($this->uri->segment(5), "-");
        //        $no = $this->uri->segment(3);
        arrPrint($this->uri->segment_array());
        //         $currentStepNum = $this->uri->segment(4);
        $currentStepNum = $this->uri->segment(4);

        $rawPrevURL = blobEncode(current_url());
        $rawBuilderURL = $_GET['rawBuilderURL'];

        //
        //region read items from existing model
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tr->addFilter("sub_step_number='" . $currentStepNum . "'");

        $tmpTr = $tr->lookupJoined()->result();
        cekKuning($this->db->last_query());
        //endregion


        $signNumbers = array();
        $trs = new MdlTransaksi();
        $trs->setFilters(array());
        $tmpSign = $trs->lookupSignaturesByMasterID($no)->result();
        if (sizeof($tmpSign) > 0) {
            //            cekkuning("ada signs");
            $sCtr = 0;
            foreach ($tmpSign as $row) {

                $signNumbers[$sCtr] = "" . $row->step_number;
                $sCtr++;
            }
        }
        else {
            //            cekkuning("TAK ada signs");
        }


        $rawItems = array();
        //region detail elements of preview
        if (sizeof($tmpTr) > 0) {
            $this->jenisTr = $tmpTr[0]->jenis_master;

            $pelaku = $tmpTr[0]->oleh_id;

            $cCode = "_TR_" . $this->jenisTr;


            //region session init
            if (!isset($_SESSION[$cCode])) {
                $_SESSION[$cCode] = array(
                    "items" => array(),
                    "items2" => array(),
                    "main" => array(),
                );
            }
            if (!isset($_SESSION[$cCode]['main'])) {
                $_SESSION[$cCode]['main'] = array();
            }
            if (!isset($_SESSION[$cCode]['items'])) {
                $_SESSION[$cCode]['items'] = array();
            }
            if (!isset($_SESSION[$cCode]['items2'])) {
                $_SESSION[$cCode]['items2'] = array();
            }
            //endregion
            $detailSizeKey = isset($_SESSION[$cCode]['main_elements']['detilSize']['key']) ? $_SESSION[$cCode]['main_elements']['detilSize']['key'] : array();
            $trID = $tmpTr[0]->transaksi_id;
            $itemLabels = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields'][$currentStepNum] : array();
            $itemLabels2 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields2'][$currentStepNum] : array();
            $itemLabels3 = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['receiptDetailFields3'][$currentStepNum] : array();
            $itemNumLabels = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields'][$currentStepNum] : array();
            $itemNumLabels2 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields2'][$currentStepNum] : array();
            $itemNumLabels3 = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNumFields3'][$currentStepNum] : array();
            $subAmountConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartAmountValue'][$currentStepNum] : null;
            $noteEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEnabled'] == true ? true : false;
            $noteEditabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEditabled'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteEditabled'][$currentStepNum] : false;
            $noteType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartNoteType'] : "text";
            $addRowsConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['additionalRows'] : array();
            $imageEnabled = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled']) && $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageEnabled'] == true ? true : false;
            $imageType = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageType']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartImageType'] : "text";
            //            $masterID = isset($tmpTr[0]->referensi_id) && $tmpTr[0]->referensi_id > 0 ? $tmpTr[0]->referensi_id : $tmpTr[0]->transaksi_id;
            $masterID = $tmpTr[0]->id_master;
            $topID = $tmpTr[0]->id_top;
            $tmpNomorNota = $tmpTr[0]->nomer;
            $origJenis = $tmpTr[0]->jenis_master;
            //             $currentStepNum = $tmpTr[0]->step_number;


            //
            //region tabel2 tarikan untuk kolom2 nilai (hpp, ppn, dll)
            $tmpVal_main = $tr->lookupMainValuesByTransID($trID)->result();
            $tmpVal_detail = $tr->lookupDetailValuesByTransID($trID)->result();
            //            //cekMerah($this->db->last_query());
            $mainValues = array();
            if (sizeof($tmpVal_main) > 0) {
                foreach ($tmpVal_main as $row) {
                    $mainValues[$row->key] = $row->value;
                }
            }
            $detailValues = array();
            if (sizeof($tmpVal_detail) > 0) {
                foreach ($tmpVal_detail as $row) {
                    $detailValues[$row->produk_id][$row->key] = $row->value;
                }
            }
            //            arrPrint($detailValues);
            //endregion

            //            arrPrint($mainValues);die();

            //region take from registries
            //==ambil value-gate
            //            $tmpReg = $tr->lookupRegistriesByMasterID($trID)->result();
            $tr->setFilters(array());
            $tr->addFilter("trash='0'");
            $tmpReg = $tr->lookupRegistriesByMasterID($masterID)->result();
            //            cekKuning($this->db->last_query());
            $main = array();
            $items = array();
            $masterGates = array();
            $childGates = array();
            $masterTableInParams = array();
            $childTableInParams = array();
            $masterTableInValueParams = array();
            $childTableInValueParams = array();
            $masterAddValues = array();
            $masterAddFields = array();
            //            $mainApplets = array();
            $mainElements = array();
            if (sizeof($tmpReg) > 0) {
                foreach ($tmpReg as $row) {
                    switch ($row->param) {
                        case "main"://
                            $main = unserialize(base64_decode($row->values));
                            break;
                        case "items"://
                            $items = unserialize(base64_decode($row->values));
                            break;
                        case "items2"://
                            $items2 = unserialize(base64_decode($row->values));
                            break;
                        case "items2_sum"://
                            $items2_sum = unserialize(base64_decode($row->values));
                            break;

                        case "tableIn_master"://
                            $masterTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail"://
                            $childTableInParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_master_values"://
                            $masterTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "tableIn_detail_values"://
                            $childTableInValueParams = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_values"://
                            $masterAddValues = unserialize(base64_decode($row->values));
                            break;
                        case "main_add_fields"://
                            $masterAddFields = unserialize(base64_decode($row->values));
                            break;
                        //                        case "main_applets"://
                        //                            $mainApplets = unserialize(base64_decode($row->values));
                        //                            break;
                        case "main_elements"://
                            $mainElements = unserialize(base64_decode($row->values));
                            break;
                    }
                }
            }
            else {
                die("Cannot read the registry entries from &*&^% $masterID!");
            }
            //endregion

            $arrTest = array();
            foreach ($tmpTr as $row) {
                $id = $row->produk_id;
                $tmp = array();
                if (sizeof($itemLabels) > 0) {
                    foreach ($itemLabels as $key => $val) {
                        if (isset($_SESSION[$cCode]['tableIn_detail_values'][$row->produk_id][$key])) {
                            $fieldValue = $_SESSION[$cCode]['tableIn_detail_values'][$row->produk_id][$key];
                        }
                        else {
                            if (isset($row->$key)) {
                                $fieldValue = $row->$key;
                            }
                            else {
                                $fieldValue = "";
                            }
                        }
                        $tmp[$key] = $fieldValue;
                    }
                }

                //region calculate subtotal
                //                arrPrint($childGates[$id]);
                //===perhitungan subtotal
                $this->load->library("FieldCalculator");
                $cal = new FieldCalculator();


                if ($subAmountConfig != null) {

                    $arrChildGates[$id] = isset($childGates[$id]) ? $childGates[$id] : array();
                    $subtotal = makeValue($subAmountConfig, $arrChildGates[$id], $arrChildGates[$id], 0);
                }
                else {
                    $subtotal = 0;
                    //                    //cekHijau("subtotal NOL");
                }
                $tmp["subtotal"] = $subtotal;
                //endregion


                switch ($detailSizeKey) {
                    default:
                    case "ckd":

                        $replaceValue = array(
                            "volume_new" => isset($tmp['volume_gross']) ? $tmp['volume_gross'] : 0,
                            "sub_volume_new" => isset($tmp['sub_volume_gross']) ? $tmp['sub_volume_gross'] : 0,
                            "berat_new" => isset($tmp['berat_gross']) ? $tmp['berat_gross'] : "0",
                            "sub_berat_new" => isset($tmp['sub_berat_gross']) ? $tmp['sub_berat_gross'] : "0",
                        );
                        $tmp = array_replace($tmp, $replaceValue);

                        break;
                    case "cbu":
                        break;
                }

                $tmp = array();

                $rawItems[$row->produk_id] = $tmp;


            }
            cekHEre("uhuiii");

        }
        else {

            $errMsg = "the entry you are trying to access does not exist.<br>";
            $errMsg .= "you may try to refresh the browser by pressing F5 button on your keyboard.<br>";
            $errMsg .= "if this error re-occurs, please contact system developer.<br>";


            echo "<script>top.BootstrapDialog.closeAll();</script>";
            die(lgShowAlert($errMsg));
        }
        //endregion


        $items = array();
        $items2 = array();

        $jenisTr = $this->jenisTr;
        $_SESSION[$cCode]['main']['currentID'] = $no;


        //region deteksi tombol2 followup


        $currentStepIndex = array_search($currentStepNum, $signNumbers, true);

        //region ========================approve, reject, undo====================================
        $origTCode = heGetOriginTCode($this->jenisTr);
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
        $thisStepGID = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup'] : "";
        $nextStepGID = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup'] : "";

        $preProcRevConfig = null != $this->config->item("hePreProcessors");
        $preCompRevConfig = null != $this->config->item("heComponents");
        $approvalSpec = array(
            "label" => "cannot approve",
            "targetUrl" => "",
            "warning" => "",
        );
        $editSpec = array(
            "label" => "cannot edit",
            "targetUrl" => "",
            "warning" => "",
        );


        //        evaluatePreProcessors($trID,($currentStepNum-1));

        //        cekmerah("$currentStepNum vs. $currentStepNum");
        //        cekmerah("origTCode: $origTCode");
        //        cekmerah("pelaku: $pelaku");
        //

        $evPre = evaluatePreProcessors($this->jenisTr, $currentStepNum);
        $evPost = evaluatePostProcessors($this->jenisTr, $currentStepNum);
        $evCom = evaluateComponents($this->jenisTr, $currentStepNum);

        //        cekmerah("evPre: $evPre, evPos: $evPost, evCom: $evCom");
        //        cekmerah(placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum));

        //==approve
        $approvalSpec = array(
            //                                        "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['actionLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['actionLabel'] : "continue to next step",
            "label" => isset($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['actionLabel'],
            "targetUrl" => base_url() . $this->uri->segment(1) . "/doEditMainFaktur/$no/$currentStepNum",
            "warning" => "pressing green button will saving new data. continue?",
        );


        //endregion
        if (sizeof($signNumbers) > 0) {
            if ($currentStepIndex > 0) {
                $beforeCurrentIndex = ($currentStepIndex - 1);
                $beforeCurrentStep = $signNumbers[$beforeCurrentIndex];
            }
            else {

                $beforeCurrentStep = 0;
            }

            $masterRevertStep = $beforeCurrentStep;

            if (placeCanFollowupTrans($this->session->login['membership'], $this->session->login['cabang_id'], $this->session->login['gudang_id'], $this->jenisTr, $currentStepNum)) {
                //                if (in_array($this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['userGroup'], $this->session->login['membership'])) {
                $mComponents = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master'] : array();

                if (sizeof($mComponents) > 0) {
                    $comNames = array();
                    foreach ($mComponents as $cSpec) {
                        $comNames[] = $cSpec['comName'];
                    }
                    if (in_array("Jurnal", $comNames)) {
                        //==tidak bisa di-revert
                    }
                    else {
                        $allowRevert = true;
                        //                        $revertLabel = $masterRevertStep . "undo " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                        $revertLabel = "undo";
                        $childRevertStep = -($currentStepNum);
                        $revertTarget = base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";

                    }
                }
                else {
                    $allowRevert = true;
                    //                    $revertLabel = $masterRevertStep . "undo " . $this->config->item("heTransaksi_ui")[$jenisTr]['steps'][$currentStepNum]['label'];
                    $revertLabel = "undo";
                    $childRevertStep = -($currentStepNum);
                    $revertTarget = base_url() . $this->uri->segment(1) . "/doRevert/$no/$jenisTr/$masterRevertStep/$childRevertStep/$currentStepNum";
                }

            }
            //            }
        }
        //endregion

        cekHitam("biruuu");
        //region check if i may approve or unapprove current transaction

        //endregion

        //region prevalidator
        $items = $rawItems;


        if (isset($this->config->item('heTransaksi_core')[$this->jenisTr]['preValidator'][$currentStepNum])) {
            $procList = $this->config->item('heTransaksi_core')[$this->jenisTr]['preValidator'][$currentStepNum];

            if (sizeof($procList) > 0) {
                foreach ($procList as $procName) {
                    $mdlProcName = "PreValidator" . $procName;
                    $this->load->model($mdlProcName);
                    if (isset($childGates) && sizeof($childGates) > 0) {
                        $prc = new $mdlProcName();
                        $requiredParams = $prc->getRequiredParams();
                        if (sizeof($requiredParams) > 0) {
                            $sentParams = array();
                            foreach ($childGates as $odSpec) {
                                $tmp = array();
                                foreach ($requiredParams as $key) {
                                    $tmp[$key] = $odSpec[$key];
                                }

                                $sentParams[] = $tmp;
                            }

                            $prc->pair($masterID, $sentParams);
                            $gotParams = $prc->exec();
                            if (isset($gotParams['items2']) && sizeof($gotParams['items2']) > 0) {
                                $items2 = $gotParams['items2'];
                                foreach ($gotParams['items2'] as $id => $iSpec) {
                                    //										$id=$iSpec['id'];
                                    if (isset($_SESSION[$cCode]['items'][$id])) {

                                        $items2[$id]['produk_ord_jml'] = $iSpec['produk_ord_jml'];
                                        $items2[$id]['produk_nama'] = $rawItems[$id]['produk_nama'];
                                        $items2[$id]['satuan'] = $rawItems[$id]['satuan'];


                                        $items[$id]['produk_ord_jml'] -= $iSpec['produk_ord_jml'];
                                        $_SESSION[$cCode]['items'][$id]['jml'] -= $iSpec['produk_ord_jml'];
                                        if ($items[$id]['produk_ord_jml'] < 1) {
                                            unset($items[$id]);
                                        }
                                        if ($_SESSION[$cCode]['items'][$id]['jml'] < 1) {
                                            unset($_SESSION[$cCode]['items'][$id]);
                                        }
                                    }
                                }
                            }

                        }
                        else {
                            die("preval $procName does not have requiredParams!");
                        }

                    }
                    else {
                        die("out_detail contains nothing!. skipping preprocessor");
                    }
                }
            }


            //<editor-fold desc="re-build values">


            //</editor-fold>

        }
        else {
            //                echo("no preval defined. skipping preval..<br>");
        }

        //endregion


        //
        //region preview bottom elements

        $saveWarning = "";
        $buttonLabel = isset($this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]['buttonLabel']) ? $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]['buttonLabel'] : $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][$currentStepNum]['actionLabel'];
        cekBiru($buttonLabel);
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum])) {
            $saveWarning .= "clicking <strong>$buttonLabel</strong> button will make transaction state to: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['stateLabel'] . "</strong>";
            $saveWarning .= "<br>It would need to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['userGroup'] . "</strong>";
        }
        else {
            $saveWarning .= "clicking <strong>$buttonLabel</strong> button will instantly make transaction state to <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['stateLabel'] . "</strong>";
        }

        //endregion

        //region warn if irreverseble
        $mComponents = isset($this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master']) ? $this->config->item('heTransaksi_core')[$this->jenisTr]['components'][$currentStepNum]['master'] : array();
        if (sizeof($mComponents) > 0) {
            $comNames = array();
            $reks = array();
            foreach ($mComponents as $cSpec) {
                $comNames[] = $cSpec['comName'];
                if ($cSpec['comName'] == "Jurnal") {
                    if (isset($cSpec['loop']) && sizeof($cSpec['loop']) > 0) {
                        foreach ($cSpec['loop'] as $rek => $v) {
                            if (substr($rek, 0, 1) == "{") {
                                $rek = trim($rek, "{");
                                $rek = trim($rek, "}");
                                $rek = str_replace($rek, $_SESSION[$cCode]['main'][$rek], $rek);
                            }
                            else {
                                //                        cekkuning("TIDAK mengandung kurawal");
                            }
                            $reks[$rek] = $rek;
                        }
                    }
                }
            }
            if (in_array("Jurnal", $comNames)) {
                //==tidak bisa di-revert
                $saveWarning .= "<br><span class='text-danger'>starting from this point, you can not undo the change made on this entry.</span>";
                if (sizeof($reks) > 0) {
                    $saveWarning .= "<br><h6><span class='text-blue'>these accounts will be affected at journal: <strong>" . implode(", ", $reks) . ".</strong></span></h6>";
                }
            }
        }
        //endregion


        $msgWarning = $this->validate2();

        //
        //region replace main labels with properties from future/next step
        $mainProp = $tmpTr[0];
        $mainPropReplacers = array(//===replace khusus kebutuhan preview next step
            "jenis_label" => $tmpTr[0]->next_step_label,
            "nomer" => "(to be generated)",
            "dtime" => date("Y-m-d H:i:s"),
        );
        foreach ($mainPropReplacers as $key => $val) {
            $mainProp->$key = $val;
        }
        //endregion
        //
        //region prepare params for viewer

        $editableAddVals = array();
        if (isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) && sizeof($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) > 0) {
            foreach ($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] as $exName => $exSpec) {
                if ($exSpec['useAt'] == $currentStepNum) {
                    $editableAddVals[] = $exName;
                }
            }
        }
        else {

        }


        $editableElements = array();
        $elementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['receiptElements'] : array();
        $relElementConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeElements'] : array();
        $relOptionConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['relativeOptions'] : array();
        $xShipmentConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['xShipmentConfig']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['xShipmentConfig'] : array();
        $itemsChildLabel = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$currentStepNum]['fields']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$currentStepNum]['fields'] : array();
        $itemsChildEditable = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$currentStepNum]['editable']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shopingCartDetailFields'][$currentStepNum]['editable'] : array();
        //            $appletConfigs = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['applets']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['applets'] : array();
        if (sizeof($_SESSION[$cCode]['main_elements']) > 0) {

            if (sizeof($elementConfigs) > 0) {
                foreach ($elementConfigs as $aKey => $aSpec) {
                    if (array_key_exists($aKey, $mainElements) && in_array($currentStepNum, $aSpec['editPoints'])) {
                        $editableElements[] = $aKey;
                    }
                    if (isset($relElementConfigs[$aKey])) {
                        foreach ($relElementConfigs[$aKey] as $mainRel => $relData) {
                            foreach ($relData as $relKey => $relDetails) {
                                if (in_array("o_seller_spv", $mems)) {
                                    if (array_key_exists($relKey, $mainElements) && in_array($currentStepNum, $relDetails['editPoints'])) {
                                        $editableElements[] = $relKey;
                                    }
                                }
                            }
                        }
                    }
                }
            }

        }

        //region elements editor

        $elStr = array();
        $elements = array();
        $aFilter = array();

        if (sizeof($elementConfigs) > 0) {
            foreach ($elementConfigs as $eName => $eSpec) {
                switch ($eSpec['elementType']) {
                    case "dataModel":
                        $addStr = "";
                        $editStr = "";
                        $amdlName = $eSpec['mdlName'];
                        $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();

                        $elStr[$eName] = "";
                        $this->load->model("Mdls/" . $amdlName);
                        $labelSrc = $eSpec['labelSrc'];
                        $keySrc = $eSpec['key'];
                        $oo = new $amdlName();
                        $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $amdlName);
                        //                        $realFilter = "";
                        if (sizeof($aFilter) > 0) {
                            foreach ($aFilter as $filter) {
                                $exFilter = explode("=", $filter);
                                if (sizeof($exFilter) > 1) {
                                    if (isset($_SESSION[$cCode]['main'][$exFilter[1]])) {
                                        $oo->addFilter($exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'");
                                        //                                    $realFilter = $exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'";
                                        $addLink .= "?reqField=" . $exFilter[0] . "&reqVal=" . $_SESSION[$cCode]['main'][$exFilter[1]];
                                    }
                                }
                            }
                        }
                        $addClick = "";
                        $dataAccess = isset($this->config->item('heDataBehaviour')[$amdlName]) ? $this->config->item('heDataBehaviour')[$amdlName] : array(
                            "viewers" => array(),
                            "creators" => array(),
                            "creatorAdmins" => array(),
                            "updaters" => array(),
                            "updaterAdmins" => array(),
                            "deleters" => array(),
                            "deleterAdmins" => array(),
                            "historyViewers" => array(),
                        );
                        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
                        if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
                            if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                                $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        }
                                        );";
                                $addStr = "<a href='javascript:void(0)' class='btn btn-default' onclick=\"$addClick\"><span class='glyphicon glyphicon-plus'></span></a>";
                            }
                        }
                        //                        if (strlen($realFilter) > 0) {
                        //                            $oo->addFilter($realFilter);
                        //                        }
                        $tmpo = $oo->lookupAll()->result();
                        $elPair[$amdlName] = array();
                        $selectorTarget = base_url() . get_class($this) . "/fetchElement/" . $this->jenisTr . "/$eName/$amdlName/?key='+this.value";
                        //                        $elStr[$eName] .= "<div class='box'>";
                        $elStr[$eName] .= "<div class='box-body'>";
                        $elStr[$eName] .= "<select class='form-control' onchange=\"top.$('#result').load('$selectorTarget');\">";
                        $elStr[$eName] .= "<option value=''>-select-</option>";
                        if (sizeof($tmpo) > 0) {
                            foreach ($tmpo as $row) {
                                //                                cekHitam($keySrc);
                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $row->$labelSrc . "</option>";
                                //                                $elStr[$eName] .= "<option value='" . $row->id . "' $selected>" . $row->$labelSrc . "</option>";
                            }
                        }
                        $elStr[$eName] .= "</select>";
                        $elStr[$eName] .= "</div class='box-header'>";

                        $defKey = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : 0;
                        $defValue = "";
                        if (isset($_SESSION[$cCode]['main_elements'][$eName]['key']) && $_SESSION[$cCode]['main_elements'][$eName]['contents']) {
                            if (isset($elementConfigs[$eName]['usedFields']) && sizeof($elementConfigs[$eName]['usedFields']) > 0) {
                                $defValue .= "<table class='table table-condensed no-padding' style='padding:0px;margin:0px;'>";
                                $contents[$eName] = unserialize(base64_decode($_SESSION[$cCode]['main_elements'][$eName]['contents']));
                                foreach ($elementConfigs[$eName]['usedFields'] as $src => $label) {
                                    $fieldLabel = isset($contents[$eName][$src]) ? $contents[$eName][$src] : "-";
                                    $defValue .= "<tr>";
                                    $defValue .= "<td align='left'>$label";
                                    $defValue .= "</td>";
                                    $defValue .= "<td align='left'>" . $fieldLabel;
                                    $defValue .= "</td>";
                                    $defValue .= "</tr>";
                                }
                                $defValue .= "</table>";
                            }
                        }


                        if ($defKey > 0) {
                            if (sizeof($mems) > 0 && sizeof($dataAccess['updaters']) > 0) {
                                $editLink = base_url() . "Data/edit/" . str_replace("Mdl", "", $amdlName) . "/$defKey";
                                if (sizeof(array_intersect($mems, $dataAccess['updaters'])) > 0) {
                                    $editClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $editLink . "'),
                                        draggable:true,
                                        size:BootstrapDialog.SIZE_WIDE,
                                        closable:true,
                                        }
                                        );";

                                    $editStr = "<a href='javascript:void(0)' class='btn btn-default' onclick=\"$editClick\"><span class='glyphicon glyphicon-pencil'></span></a>";
                                }
                            }
                        }

                        $elStr[$eName] .= "<div id='divel_$eName' style='padding:2px;font-size:smaller;'>$defValue";
                        $elStr[$eName] .= "</div id='el$amdlName'>";
                        $elStr[$eName] .= "<div class='box-footer'>";

                        $elStr[$eName] .= "<span class='pull-right'>$editStr $addStr</span>";
                        $elStr[$eName] .= "</div class='box-footer'>";

                        $elements[$eName] = array(
                            "mdlName" => $eSpec['mdlName'],
                            "label" => $eSpec['label'],
                            "string" => $elStr[$eName],
                        );


                        break;
                    case "dataField":
                        $elStr[$eName] = "";
                        $defaultValue = isset($eSpec['defaultValue']) ? $eSpec['defaultValue'] : "";
                        $selectorTarget = "'" . base_url() . get_class($this) . "/recordFieldElement/" . $this->jenisTr . "/$eName/$amdlName/?val='+this.value";
                        //                        $elStr[$eName] .="<div class='box'>";

                        $elStr[$eName] .= "<div class='box-body'>";
                        switch ($eSpec['inputType']) {
                            case "text":
                                $elStr[$eName] .= "<input type=text class='form-control' value='$defaultValue' onblur=\"top.$('#result').load($selectorTarget);\">";
                                break;
                            case "date":
                                $elStr[$eName] .= "<input type=date class='form-control' value='$defaultValue' onblur=\"top.$('#result').load($selectorTarget);\">";
                                break;
                        }
                        $elStr[$eName] .= "</div class='box-body'>";

                        $elements[] = array(
                            "mdlName" => null,
                            "label" => $eSpec['label'],
                            "string" => $elStr[$eName],
                        );
                        break;
                }
            }
        }

        //endregion

        $xShipmentBtn = array();
        if ($xShipmentConfig) {
            foreach ($xShipmentConfig as $num => $val) {
                $xShipmentBtn_str = array(
                    "label" => "close/fullfillment transaksi",
                    "targetUrl" => base_url() . $this->uri->segment(1) . "/preCancelPacking/$no/$jenisTr/1982/$currentStepNum",
                    "warning" => "You may cancel the Packing with the remaining items that have not been Packed to Shipping. continue cancel this packing?",
                );
                $xShipmentBtn = $num == $currentStepNum ? $xShipmentBtn_str : "";
            }
        }

        $stepLabels = array();
        foreach ($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'] as $num => $sSpec) {
            $stepLabels[$num] = $sSpec['label'];
        }

        $tmpTableIn_master = isset($_SESSION[$cCode]['tableIn_master']) ? $_SESSION[$cCode]['tableIn_master'] : array();
        $tmpTableIn_masterValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        $main = array_merge(array_filter($main), array_filter($tmpTableIn_master), array_filter($tmpTableIn_masterValues));
        $mainAddValues = isset($_SESSION[$cCode]['tableIn_master_values']) ? $_SESSION[$cCode]['tableIn_master_values'] : array();
        if (isset($_SESSION[$cCode]['main_add_values']) && sizeof($_SESSION[$cCode]['main_add_values']) > 0) {
            $mainAddValues = array_merge(array_filter($mainAddValues), array_filter($_SESSION[$cCode]['main_add_values']));
        }


        //==iterasi untuk memasukkan element relatif
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            //            cekbiru("hendak memeriksa relative impacts");
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                //                cekbiru("memeriksa $eName:");
                if (array_key_exists($eName, $relElementConfigs)) {
                    //                    cekhijau("$eName memiliki relative impacts");
                    $currentValue = "";
                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $currentValue = $eSpec['key'];
                            break;
                        case "dataField":
                            $currentValue = $eSpec['value'];
                            break;
                    }
                    if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                        //                        cekhijau("memenuhi syarat");
                        //===daftarkan ke elementConfig
                        if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                            //                            cekmerah("memeriksa $eName, $currentValue");
                            //                            $rcCtr = 0;
                            foreach ($relElementConfigs[$eName][$currentValue] as $rcID => $rcSpec) {
                                //                                $elKey = $eName . "_" . $currentValue . "_" . $rcID;
                                $elKey = $rcID;
                                $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rcID];
                                //                                $rcCtr++;
                            }
                        }
                    }
                    else {
                        //                        cekmerah("TIDAK memenuhi syarat");
                    }
                }
            }
        }


        //==ini dua benda ini dibikin ulang di sini karena nantinya harus selalu refresh tanpa memanggil PrePreview lagi
        $trA = new MdlTransaksi();
        $extSteps = $trA->lookupExtSteps($masterID);
        $paySrcs = $trA->lookupPaymentSrcs($masterID, $this->jenisTr . "_");


        $_SESSION[$cCode]['extSteps'] = $extSteps;
        $_SESSION[$cCode]['paySrcs'] = $paySrcs;

        //create followup buttons for relative inputs
        //region buttons for relative inputs
        $extBtns = array();
        $extNewBtns = array();
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        if (isset($_SESSION[$cCode]['extSteps']) && sizeof($_SESSION[$cCode]['extSteps']) > 0) {
            foreach ($_SESSION[$cCode]['extSteps'] as $xSpec) {
                if (in_array($xSpec['groupID'], $mems)) {
                    $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'review " . $xSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/previewValue/" . $this->jenisTr . "/$masterID/" . $xSpec['id'] . "/" . $this->uri->segment(5) . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                    $extBtns[$xSpec['key']] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> review " . $xSpec['label'] . "</a>";
                }
                else {
                    $extBtns[$xSpec['key']] = "<a class='btn btn-default text-muted'><i>unreviewable " . $xSpec['label'] . "</i></a>";
                }
            }
        }
        if (isset($_SESSION[$cCode]['main_elements']) && sizeof($_SESSION[$cCode]['main_elements']) > 0) {
            foreach ($_SESSION[$cCode]['main_elements'] as $eName => $eSpec) {
                if (array_key_exists($eName, $relOptionConfigs)) {
                    //                    cekhijau("$eName terdaftar pada relInputs");
                    if (isset($relOptionConfigs[$eName][$currentValue]) && sizeof($relOptionConfigs[$eName][$currentValue]) > 0) {
                        foreach ($relOptionConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                            if (isset($oValSpec['addPoints']) && in_array($currentStepNum, $oValSpec['addPoints'])) {
                                if (in_array($oValSpec['auth']['groupID'], $mems)) {
                                    $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'add " . $oValSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/addValue/" . $this->jenisTr . "/$masterID/" . "0" . "/" . $this->uri->segment(5) . "?rawPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                                    $extNewBtns[$oValueName] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> add " . $oValSpec['label'] . "</a>";
                                }
                                else {
                                    //                                    cekmerah("you are not allowed");
                                }
                            }
                            else {
                                //                                cekhijau("$oValueName TIDAK memenuhi syarat");
                            }
                        }
                    }
                }
            }
        }
        //endregion

        //create followup buttons for paymentSrc-related
        //region buttons for paymentSrc-related
        $payBtns = array();
        $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();

        if (isset($_SESSION[$cCode]['paySrcs']) && sizeof($_SESSION[$cCode]['paySrcs']) > 0) {
            foreach ($_SESSION[$cCode]['paySrcs'] as $xSpec) {
                if ($xSpec['sisa'] > 0) {

                    //                arrprint($xSpec);
                    $xSpec['groupID'] = $this->config->item("heTransaksi_ui")[$xSpec['targetJenis']]['steps'][1]['userGroup'];
                    if (in_array($xSpec['groupID'], $mems)) {
                        $actionTarget = "
                                    top.BootstrapDialog.show(
                                   {
                                       title:'do " . $xSpec['label'] . "',
                                       message: " . '$' . "('<div></div>').load('" . base_url() . "Transaksi/selectPaymentSrc/" . $xSpec['targetJenis'] . "/" . $xSpec['extID'] . "/$masterID?rawPrev=$rawPrevURL'),
                                        size:top.BootstrapDialog.SIZE_WIDE,
                                        draggable:false,
                                        closable:true,
                                        }
                                        );";
                        //                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-warning' href='javascript:void(0)' onclick=\"$actionTarget\"><span class='glyphicon glyphicon-triangle-right'></span> do " . $xSpec['label'] . "</a>";
                    }
                    else {
                        //                        $payBtns[$xSpec['targetJenis']] = "<a class='btn btn-default text-muted'><i>" . $xSpec['label'] . "</i></a>";
                    }
                }
            }
        }
        //endregion

        //region additional row
        //        cekHitam($cCode . " $currentStepNum " . $currentStepNum);
        $selectedService = isset($_SESSION[$cCode]['main']['shippingService']) ? $_SESSION[$cCode]['main']['shippingService'] : "";

        //        arrPrint($selectedService);
        $allowEditRowa = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["additionalRows"]["shippingService"][$selectedService]["shipping_service"]['editPoints']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["additionalRows"]["shippingService"][$selectedService]["shipping_service"]['editPoints'] : array();
        $addRows = array();
        $addRowLabels = array();
        if (in_array($currentStepNum, $allowEditRowa)) {
            if (sizeof($elementConfigs) > 0) {
                foreach ($elementConfigs as $eName => $eSpec) {
                    //reset dulu kalau yg tidak ada
                    if (array_key_exists($eName, $relElementConfigs)) {
                        //                    cekkuning("$eName ada dalam elementConfig, reset dulu adik2nya<br>");
                        switch ($eSpec['elementType']) {
                            case "dataModel":
                                $currentValue = $eSpec['key'];
                                break;
                            case "dataField":
                                $currentValue = $eSpec['value'];
                                break;
                        }
                        if (sizeof($relElementConfigs[$eName]) > 0) {
                            foreach ($relElementConfigs[$eName] as $valID => $valSpec) {

                                //                            cekkuning("chek if i should reset $valID..");

                                if ($currentValue == $valID) {
                                    //                                cekkuning("i wont reset $valID..");
                                }
                                else {


                                }
                            }

                        }
                        //					$currentValue = "";

                        if (array_key_exists($currentValue, $relElementConfigs[$eName])) {
                            //                        echo("-- $currentValue ada dalam elementConfig $eName<br>");
                            //===daftarkan ke elementConfig
                            if (sizeof($relElementConfigs[$eName][$currentValue]) > 0) {
                                //                            echo("---- memeriksa $eName, $currentValue<br>");
                                //                            $rcCtr=0;
                                foreach ($relElementConfigs[$eName][$currentValue] as $rKey => $rcSpec) {
                                    //                                $elKey = $eName . "_" . $currentValue . "_" . $rKey;
                                    $elKey = $rKey;
                                    $elementConfigs[$elKey] = $relElementConfigs[$eName][$currentValue][$rKey];
                                    //                                echo "elKey: $elKey";
                                    //                                $rcCtr++;


                                }
                            }
                            else {
                                //                            echo("---- TIDAK PERLU memeriksa $eName, $currentValue<br>");
                            }

                        }
                        else {
                            //                        echo("-- $currentValue TIDAK ada dalam elementConfig $eName<br>");
                        }
                    }
                    else {
                        //                    echo("$eName TIDAK ada dalam elementConfig<br>");
                    }

                    if (array_key_exists($eName, $addRowsConfigs)) {
                        switch ($elementConfigs[$eName]['elementType']) {
                            case "dataModel":
                                $currentValue = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : "";
                                break;
                            case "dataField":
                                $currentValue = $_SESSION[$cCode]['main_elements'][$eName]['value'];
                                break;
                        }
                        //                    cekhijau("currentValue: $currentValue");
                        if (isset($addRowsConfigs[$eName][$currentValue])) {
                            //                        cekmerah("aturan untuk $currentValue ada");
                            if (sizeof($addRowsConfigs[$eName][$currentValue]) > 0) {

                                foreach ($addRowsConfigs[$eName][$currentValue] as $oValueName => $oValSpec) {
                                    //                                cekhijau($oValueName);
                                    //                                arrprint($oValSpec);
                                    if (isset($oValSpec['editPoints']) && in_array($currentStepNum, $oValSpec['editPoints'])) {

                                        //                                        $relInputTarget = "'" . base_url() . get_class($this) . "/recordAddRow/" . $this->jenisTr . "/$oValueName/?val='+this.value+'&ravPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'";
                                        $relInputTarget = "'" . base_url() . "_shoppingCart/recordAddRow/" . $this->jenisTr . "/$oValueName/?val='+this.value+'&ravPrev=$rawPrevURL&rawBuilderURL=$rawBuilderURL'";


                                        //==init value and params
                                        //region default value
                                        if (isset($oValSpec['defaultValue'])) {
                                            $origDefValue = makeValue($oValSpec['defaultValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                        }
                                        //endregion

                                        //                                    cekmerah("$oValueName = ".$origDefValue);


                                        //region max-value
                                        $maxValue = $origDefValue;
                                        if (isset($oValSpec['maxValue'])) {
                                            $maxValue = makeValue($oValSpec['maxValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);

                                        }
                                        else {
                                            $maxValue = "";
                                        }

                                        //endregion


                                        //region min-value
                                        $minValue = $origDefValue;
                                        if (isset($oValSpec['minValue'])) {
                                            $minValue = makeValue($oValSpec['minValue'], $_SESSION[$cCode]['main'], $_SESSION[$cCode]['main'], 0);
                                        }
                                        else {
                                            $minValue = "";
                                        }
                                        //endregion

                                        $minValStr = $minValue != "" ? "min='$minValue'" : "";
                                        $maxValStr = $maxValue != "" ? "max='$maxValue'" : "";

                                        //region inisiasi keystroke
                                        $keyupAct = "";
                                        if (isset($oValSpec['keyupAction']) && strlen($oValSpec['keyupAction']) > 0) {
                                            $keyupAct = $oValSpec['keyupAction'];
                                        }

                                        $keyupStr = "";
                                        if ($maxValue != "") {
                                            $keyupStr .= "if(parseInt(this.value)>$maxValue){this.value='$origDefValue';this.select();} ";
                                        }
                                        $keyupStr .= $keyupAct;


                                        $disabled = "";
                                        if (isset($oValSpec['disabled'])) {
                                            $disabled = $oValSpec['disabled'];
                                        }


                                        $blurStr = "";
                                        if ($minValue != "") {
                                            $blurStr = "if(this.value!=this.defaultValue){if(parseInt(this.value)>=$minValue){hiliteDiv(this);top.$('#result').load($relInputTarget);}else{this.value='$minValue';this.focus();}}";
                                        }
                                        else {
                                            $blurStr = "if(this.value!=this.defaultValue){hiliteDiv(this);top.$('#result').load($relInputTarget);}";

                                        }
                                        //endregion

                                        $defVal = isset($_SESSION[$cCode]['main'][$oValueName]) && $_SESSION[$cCode]['main'][$oValueName] > 0 ? ($_SESSION[$cCode]['main'][$oValueName] + 0) : $origDefValue;
                                        if (isset($addRowsConfigs[$eName][$currentValue][$oValueName]['role']) && $addRowsConfigs[$eName][$currentValue][$oValueName]['role'] == "minus") {
                                            $defVal = "(" . $defVal . ")";
                                        }
                                        //                                    $defVal = $origDefValue;
                                        $addRows[$oValueName] = "<input type=text autocomplete='off' id='$oValueName' class='form-control text-right' style='font-size:17px;' $disabled placeholder='$oValueName' value='$defVal' $minValStr $maxValStr 
onfocusssss='this.select()' onkeyup=\"$keyupStr\" onfocus=\"$keyupStr\"
onblur=\"$blurStr\"
onmouseout=\"$blurStr\"
>";
                                        $_SESSION[$cCode]['add_rows'][$oValueName] = $defVal;
                                        $addRowLabels[$oValueName] = $oValSpec['label'];

                                    }

                                }

                            }
                        }
                        else {
                            //						cekKuning("option $currentValue pada $eName TIDAK ada pilihannya");
                            //                        cekmerah("aturan untuk $currentValue TIDAK ada");
                        }

                    }
                    else {
                        //					cekKuning("$eName TIDAK terdaftar pada relInputs");
                    }


                    switch ($eSpec['elementType']) {
                        case "dataModel":
                            $addStr = "";
                            $editStr = "";
                            $amdlName = $eSpec['mdlName'];
                            $aFilter = isset($eSpec['mdlFilter']) ? $eSpec['mdlFilter'] : array();

                            $elStr[$eName] = "";
                            $this->load->model("Mdls/" . $amdlName);
                            $labelSrc = $eSpec['labelSrc'];
                            $keySrc = $eSpec['key'];
                            $oo = new $amdlName();
                            $addLink = base_url() . "Data/add/" . str_replace("Mdl", "", $amdlName);

                            if (sizeof($aFilter) > 0) {
                                foreach ($aFilter as $filter) {
                                    $exFilter = explode("=", $filter);
                                    if (sizeof($exFilter) > 1) {
                                        if (substr($exFilter[1], 0, 1) == ".") {
                                            //                                        $oo->addFilter($exFilter[0] . "='" . ltrim($exFilter[1], ".") . "'");
                                        }
                                        else {
                                            if (isset($_SESSION[$cCode]['main'][$exFilter[1]])) {
                                                //                                            $oo->addFilter($exFilter[0] . "='" . $_SESSION[$cCode]['main'][$exFilter[1]] . "'");
                                                $addLink .= "?reqField=" . $exFilter[0] . "&reqVal=" . $_SESSION[$cCode]['main'][$exFilter[1]];
                                            }
                                            else {
                                                //                                            $oo->addFilter($exFilter[0] . "='none'");
                                            }
                                        }
                                    }
                                }
                                $oo = makeFilter($aFilter, $_SESSION[$cCode]['main'], $oo);
                            }

                            $addClick = "";
                            $dataAccess = isset($this->config->item('heDataBehaviour')[$amdlName]) ? $this->config->item('heDataBehaviour')[$amdlName] : array(
                                "viewers" => array(),
                                "creators" => array(),
                                "creatorAdmins" => array(),
                                "updaters" => array(),
                                "updaterAdmins" => array(),
                                "deleters" => array(),
                                "deleterAdmins" => array(),
                                "historyViewers" => array(),
                            );
                            $mems = isset($this->session->login['membership']) ? $this->session->login['membership'] : array();
                            if (sizeof($mems) > 0 && sizeof($dataAccess['creators']) > 0) {
                                if (sizeof(array_intersect($mems, $dataAccess['creators'])) > 0) {
                                    $addClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $addLink . "'),
                                        draggable:true,
                                        closable:true,
                                        type:top.BootstrapDialog.TYPE_SUCCESS,
                                        }
                                        );";
                                    $addStr = "<a href='javascript:void(0)' class='btn btn-tool' onclick=\"$addClick\"><span class='glyphicon glyphicon-plus'></span></a>";
                                }
                            }

                            //                        cekmerah("pre..");
                            $tmpo = $oo->lookupAll()->result();
                            //                        cekmerah($this->db->last_query());
                            $elPair[$amdlName] = array();
                            $selectorTarget = "'" . base_url() . get_class($this) . "/fetchElement/" . $this->jenisTr . "/$eName/$amdlName/?key='+this.value";

                            $elStr[$eName] .= "<div class='box-body'>";

                            switch ($eSpec['inputType']) {
                                case "combo":
                                    $elStr[$eName] .= "<select class='form-control' onchange=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">";
                                    $elStr[$eName] .= "<option value=''>-select-</option>";
                                    if (sizeof($tmpo) > 0) {
                                        foreach ($tmpo as $row) {

                                            $ex = explode("/", $elementConfigs[$eName]['labelSrc']);
                                            if (sizeof($ex) > 1) {
                                                $labelValue = "";
                                                foreach ($ex as $col) {

                                                    $labelValue .= $row->$col . " / ";
                                                }
                                                $labelValue = rtrim($labelValue, " / ");
                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";

                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $labelValue . "</option>";
                                                //                                            $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $$labelValue . "</option>";

                                            }
                                            else {
                                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "selected" : "";
                                                $elStr[$eName] .= "<option value='" . $row->$keySrc . "' $selected>" . $row->$labelSrc . "</option>";
                                            }


                                        }
                                    }
                                    $elStr[$eName] .= "</select>";
                                    break;
                                case "radio":

                                    if (sizeof($tmpo) > 0) {
                                        foreach ($tmpo as $row) {
                                            $ex = explode("/", $elementConfigs[$eName]['labelSrc']);
                                            if (sizeof($ex) > 1) {
                                                $labelValue = "";
                                                foreach ($ex as $col) {

                                                    $labelValue .= $row->$col . " / ";
                                                }
                                                $labelValue = rtrim($labelValue, " / ");
                                                $elPair[$amdlName][$row->$keySrc] = $labelValue;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";
                                                $elStr[$eName] .= "<label class='badge' style='padding:4px 6px 4px 6px;color:#454545;background:#e0e0e0;'><input type='radio' name='$eName' value='" . $row->$keySrc . "' $selected onclick=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">" . $labelValue . "</label>&nbsp;";
                                            }
                                            else {
                                                $elPair[$amdlName][$row->$keySrc] = $row->$labelSrc;
                                                $selected = isset($_SESSION[$cCode]['main_elements'][$eName]) && $_SESSION[$cCode]['main_elements'][$eName]['key'] == $row->$keySrc ? "checked" : "";
                                                $elStr[$eName] .= "<label class='badge' style='padding:4px 6px 4px 6px;color:#454545;background:#e0e0e0;'><input type='radio' name='$eName' value='" . $row->$keySrc . "' $selected onclick=\"hiliteDiv(this);top.$('#result').load($selectorTarget);\">" . $row->$labelSrc . "</label>&nbsp;";
                                            }

                                        }
                                    }
                                    break;
                            }


                            $elStr[$eName] .= "</div class='box-header'>";

                            $defKey = isset($_SESSION[$cCode]['main_elements'][$eName]['key']) ? $_SESSION[$cCode]['main_elements'][$eName]['key'] : 0;
                            $defValue = "";
                            if (isset($_SESSION[$cCode]['main_elements'][$eName]['key']) && $_SESSION[$cCode]['main_elements'][$eName]['contents']) {
                                if (isset($elementConfigs[$eName]['usedFields']) && sizeof($elementConfigs[$eName]['usedFields']) > 0) {
                                    //								$defValue .= "<table class='table table-condensed no-padding' style='padding:0px;margin:0px;'>";
                                    $defValue .= "<div class='panel-body'>";
                                    $defValue .= "<table cellspacing='0' cellpadding='0' border='0'>";
                                    $contents[$eName] = unserialize(base64_decode($_SESSION[$cCode]['main_elements'][$eName]['contents']));
                                    foreach ($elementConfigs[$eName]['usedFields'] as $src => $label) {
                                        $fieldLabel = isset($contents[$eName][$src]) ? $contents[$eName][$src] : "-";
                                        //                                    if(is_numeric($fieldLabel)){
                                        //                                        $fieldLabel=number_format($fieldLabel);
                                        //                                    }
                                        $defValue .= "<tr>";
                                        $defValue .= "<td align='left'>$label";
                                        $defValue .= "&nbsp;</td>";
                                        $defValue .= "<td align='left'>:&nbsp;" . $fieldLabel;
                                        $defValue .= "</td>";
                                        $defValue .= "</tr>";
                                    }
                                    $defValue .= "</table>";
                                    $defValue .= "</div class='panel-body'>";
                                }
                            }
                            else {//menentukan nilai default

                            }

                            if ($defKey > 0) {
                                if (sizeof($mems) > 0 && sizeof($dataAccess['updaters']) > 0) {
                                    $editLink = base_url() . "Data/edit/" . str_replace("Mdl", "", $amdlName) . "/$defKey";
                                    if (sizeof(array_intersect($mems, $dataAccess['updaters'])) > 0) {
                                        $editClick = "
                    BootstrapDialog.show(
                                   {
                                        title:'New " . $eSpec['label'] . "',
                                        message: $('<div></div>').load('" . $editLink . "'),
                                        draggable:true,
                                        size:BootstrapDialog.SIZE_WIDE,
                                        closable:true,
                                        type:top.BootstrapDialog.TYPE_SUCCESS,
                                        }
                                        );";

                                        $editStr = "<a href='javascript:void(0)' class='btn btn-tool' onclick=\"$editClick\"><span class='glyphicon glyphicon-pencil'></span></a>";
                                    }
                                }
                            }

                            $elStr[$eName] .= "<div id='divel_$eName' style='padding:2px;font-size:smaller;'>$defValue";
                            $elStr[$eName] .= "</div id='el$amdlName'>";

                            $elements[$eName] = array(
                                "mdlName" => $eSpec['mdlName'],
                                "label" => $eSpec['label'],
                                "string" => $elStr[$eName],
                                "editStr" => $editStr,
                                "addStr" => $addStr,
                                "bgColor" => $defValue == "" ? "#fcfce0" : "#f5fff9",
                            );


                            break;
                        case "dataField":
                            $elStr[$eName] = "";
                            $initValue = isset($eSpec['defaultValue']) ? $eSpec['defaultValue'] : "";
                            //                        $defaultValue = isset($_SESSION[$cCode]['main_elements'][$eName]['value']) ? $_SESSION[$cCode]['main_elements'][$eName]['value'] : "";
                            $defaultValue = isset($_SESSION[$cCode]['main'][$eName]) ? $_SESSION[$cCode]['main'][$eName] : 0;
                            $selectorTarget = "'" . base_url() . get_class($this) . "/recordFieldElement/" . $this->jenisTr . "/$eName/$amdlName/?val='+this.value";
                            //                        $elStr[$eName] .="<div class='box'>";

                            $maxValue = isset($eSpec['maxValue']) && isset($_SESSION[$cCode]['main'][$eSpec['maxValue']]) ? $_SESSION[$cCode]['main'][$eSpec['maxValue']] : "";

                            $elStr[$eName] .= "<div class='box-body'>";
                            switch ($eSpec['inputType']) {
                                case "text":
                                    $elStr[$eName] .= "<input type=text class='form-control' value='$defaultValue' onfocus='this.select()' oonclick=\"this.value='$defaultValue';\" 
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                                case "number":
                                    $maxValStr = $maxValue != "" ? " max='" . $maxValue . "''" : "";
                                    $maxValValidator = $maxValue != "" ? " onkeyup=\"if(this.value>$maxValue){this.value='$maxValue';}\" " : "";
                                    $elStr[$eName] .= "<input type=number class='form-control' value='$defaultValue' onfocus='this.select()' $maxValStr $maxValValidator oonclick=\"this.value='$defaultValue';\" 
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                                case "date":
                                    $elStr[$eName] .= "<input type=date class='form-control' value='$defaultValue' onfocus='this.select()' oonclick=\"this.value='$defaultValue';\" 
onblur=\"if(this.value!=this.defaultValue){if(this.value.length<1){this.value='$initValue'};hiliteDiv(this);top.$('#result').load($selectorTarget);}\">";
                                    break;
                            }
                            $elStr[$eName] .= "</div class='box-body'>";

                            $elements[$eName] = array(
                                "mdlName" => null,
                                "label" => $eSpec['label'],
                                "string" => $elStr[$eName],
                                "editStr" => "",
                                "addStr" => "",
                                "bgColor" => $defaultValue == "" ? "#fcfce0" : "#fcfcff",
                            );
                            break;
                    }
                }
            }
        }


        //endregion.

        //region add mainData
        //        cekHitam($currentStepNum." ".$this->jenisTr);
        $addMainSource = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$currentStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$currentStepNum] : array();
        $addMainSourceField = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$currentStepNum]["fields"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$currentStepNum]["fields"] : array();
        $addMainSourceEdit = isset($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$currentStepNum]["editableFields"]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"][$currentStepNum]["editableFields"] : array();

        //        arrPrint($this->config->item("heTransaksi_ui")[$this->jenisTr]["addMainSource"]);


        //endregion

        //        arrPrint($mainElements['detilSize']['key']);
        $detilSizeBar = array();
        $measureConf = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartMeasurement'][$currentStepNum]) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartMeasurement'][$currentStepNum] : false;
        //        cekHere($currentStepNum);
        if ($measureConf) {
            if (isset($elements['detilSize'])) {
                $detilSizeBar = array(
                    "volume_gross" => isset($main['volume_gross']) ? number_format(conv_mmc_mc($main['volume_gross']), 2) : 0,
                    "berat_gross" => isset($main['berat_gross']) ? conv_g_kg($main['berat_gross']) : 0,
                );
            }
        }


        $itemLabels = $itemLabels + $itemNumLabels + array("subtotal" => "sub-amount");
        $itemLabels2 = $itemLabels2 + $itemNumLabels2 + array("subtotal" => "sub-amount");
        $itemLabels3 = $itemLabels3 + $itemNumLabels3 + array("subtotal" => "sub-amount");
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount']) && $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartHideSubamount'][$currentStepNum] == true) {
            unset($itemLabels['subtotal']);
            unset($itemLabels2['subtotal']);
            unset($itemLabels3['subtotal']);
        }

        $pairedItemTarget = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['shoppingCartPairedItem']['targetGateName'] : "items2";

        $itemsEditableConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupItemEditable']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupItemEditable'] : "_followupLiveEdit/updateItemField/";
        $mainEditableConfig = isset($this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainEditable']) ? $this->config->item('heTransaksi_ui')[$this->jenisTr]['followupMainEditable'] : "_followupLiveEdit/updateMainField/";


        $data = array(
            "mode" => $this->uri->segment(2),
            "template" => $this->config->item("heTransaksi_ui")[$jenisTr]["template"],
            "title" => $this->config->item("heTransaksi_ui")[$jenisTr]["label"],
            "subTitle" => $this->config->item("heTransaksi_ui")[$jenisTr]["steps"][1]['label'],
            "jenisTr" => $jenisTr,
            "pihakLabel" => $this->config->item("heTransaksi_ui")[$jenisTr]["pihakLabel"],
            "mainLabels" => $this->config->item("heTransaksi_layout")[$jenisTr]["receiptMainFields"],
            "main" => $mainProp,
            "mainValues" => $_SESSION[$cCode]['main'],
            "detailValues" => $_SESSION[$cCode]['tableIn_detail_values'],
            "itemLabels" => $itemLabels,
            "itemLabels2" => $itemLabels2,
            "itemLabels3" => $itemLabels3,
            "noteEnabled" => $noteEnabled,
            "noteEditabled" => $noteEditabled,
            "noteType" => $noteType,
            "imageEnabled" => $imageEnabled,
            "imageType" => $imageType,


            "items" => $_SESSION[$cCode]['items'],
            "items2" => isset($_SESSION[$cCode][$pairedItemTarget]) ? $_SESSION[$cCode][$pairedItemTarget] : array(),
            "items3" => isset($_SESSION[$cCode]['items3_sum']) ? $_SESSION[$cCode]['items3_sum'] : array(),
            "items_child" => isset($_SESSION[$cCode]['items_child']) ? $_SESSION[$cCode]['items_child'] : array(),
            "itemsChildLabel" => $itemsChildLabel,
            "itemsChildLabelEditable" => $itemsChildEditable,
            "buttonLabel" => $buttonLabel,
            "saveWarning" => $saveWarning,
            "sumRows" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][$currentStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields'][$currentStepNum] : $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields'][$currentStepNum],
            "sumRows3" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields3'][$currentStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartSumFields3'][$currentStepNum] : isset($this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields3'][$currentStepNum]) ? $this->config->item("heTransaksi_layout")[$this->jenisTr]['receiptSumFields3'][$currentStepNum] : array(),
            "extValueLabels" => isset($this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues']) ? $this->config->item("heTransaksi_core")[$this->jenisTr]['externalValues'] : array(),
            "extEditableFields" => $editableAddVals,
            //            "mainAddValues" => isset($_SESSION[$cCode]['main_add_values']) ? $_SESSION[$cCode]['main_add_values'] : array(),
            //            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            "mainAddValues" => $mainAddValues,
            "mainAddFields" => isset($_SESSION[$cCode]['main_add_fields']) ? $_SESSION[$cCode]['main_add_fields'] : array(),
            //            "mainApplets"       => $mainApplets,
            //            "editableApplets"   => $editableApplets,
            "mainElements" => $_SESSION[$cCode]['main_elements'],
            "elements" => $elements,
            "editableElements" => $editableElements,
            "elementConfig" => $elementConfigs,
            "mainInputs" => isset($_SESSION[$cCode]['main_inputs']) ? $_SESSION[$cCode]['main_inputs'] : array(),
            "elementEditTarget" => base_url() . "_followupLiveEdit/selectElement/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            //            "actionTarget" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$currentStepNum",
            "actionTarget" => base_url() . $this->uri->segment(1) . "/doFollowup/$no/$currentStepNum/$currentStepNum",
            "paymentMethod" => isset($tmpTr[0]->pembayaran) ? $tmpTr[0]->pembayaran : "",
            "grandTotal" => isset($_SESSION[$cCode]['main']['grand_total']) ? $_SESSION[$cCode]['main']['grand_total'] : 0,
            //            "description" => isset($main['description']) ? $main['description'] : "",
            "description" => isset($_SESSION[$cCode]['main']['description']) ? $_SESSION[$cCode]['main']['description'] : "",

            "allowEdit" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowEdit']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowEdit'] : false,
            "allowRemove" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowRemove']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowRemove'] : true,
            "allowCancel" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowCancel']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowCancel'] : false,
            "allowIncrement" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowIncrement']) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$currentStepNum]['allowIncrement'] : false,
            "editableFields" => isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$currentStepNum]) ? $this->config->item("heTransaksi_ui")[$this->jenisTr]['shoppingCartEditableFields'][$currentStepNum] : array(),
            "stepLabels" => $stepLabels,
            "rawPrevURL" => $rawPrevURL,
            "rawBuilderURL" => $rawBuilderURL,
            "currentStep" => $currentStepNum,
            "extSteps" => isset($_SESSION[$cCode]['extSteps']) ? $_SESSION[$cCode]['extSteps'] : array(),
            "paySrcs" => isset($_SESSION[$cCode]['paySrcs']) ? $_SESSION[$cCode]['paySrcs'] : array(),
            "extBtns" => $extBtns,
            "extNewBtns" => $extNewBtns,
            "payBtns" => $payBtns,
            "xShipmentBtn" => $xShipmentBtn,
            //==================liveEdit========================
            "followupSegments" => array(
                $this->uri->segment(3),
                $this->uri->segment(4),
                $this->uri->segment(5),
            ),
            "removeItemTarget" => base_url() . "_followupLiveEdit/removeItem/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateItemFieldTarget" => base_url() . "$itemsEditableConfig" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateItemChildTarget" => base_url() . "_followupLiveEdit/updateChildField/" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateMainFieldTarget" => base_url() . "$mainEditableConfig" . $this->jenisTr . "/" . $this->uri->segment(3) . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "updateMainSourceTarget" => base_url() . "_followupLiveEdit/editSourceField/" . $this->jenisTr . "/" . $this->uri->segment(4) . "/" . $this->uri->segment(5) . "/",
            "clearContentTarget" => base_url() . get_class($this) . "/clearContent/" . $this->jenisTr,
            "msgWarning" => isset($msgWarning) ? $msgWarning : array(),

            "msgWarning2" => isset($msgWarning2) ? $msgWarning2 : array(),
            //
            "addRows" => $addRows,
            "addRowLabels" => $addRowLabels,
            "deleteSpec" => $deleteSpec,
            "undoSpec" => $undoSpec,
            "rejectionSpec" => $rejectionSpec,
            "approvalSpec" => $approvalSpec,
            "editSpec" => $editSpec,
            "detailSizeKey" => $detailSizeKey,
            "detilSizeBar" => $detilSizeBar,
            "addMainSourceField" => $addMainSourceField,
            "addMainSourceEdit" => $addMainSourceEdit,

        );


        if (isset($_SESSION[$cCode]['main'])) {
            $data['pihakID'] = isset($_SESSION[$cCode]['main']['pihakID']) ? $_SESSION[$cCode]['main']['pihakID'] : 0;
            $data['pihakName'] = isset($_SESSION[$cCode]['main']['pihakName']) ? $_SESSION[$cCode]['main']['pihakName'] : "";
        }
        //endregion


        $this->load->view("transaksi", $data);
    }

    public function doEditMainFaktur()
    {
        if ($this->transaksiMaintenance === true) {
            $msg = $this->transaksiMaintenanceMsg['title'] . "<br>" . $this->transaksiMaintenanceMsg['mesage'];
            mati_disini($msg);
        }
        $transaksiID_reference = $no = rtrim($this->uri->segment(3), "-");
        $stepNum = $this->uri->segment(4);
        $stepNumCurrent = $this->uri->segment(4);
        $this->load->model("MdlTransaksi");
        $tr = new MdlTransaksi();
        $tr->addFilter("transaksi_id in (" . implode(",", explode("-", $no)) . ")");
        $tr->addFilter("step_number='" . $stepNumCurrent . "'");
        $tr->addFilter("transaksi_data.trash='0'");
        $tmpTr = $tr->lookupJoined()->result();
        //        arrPrint($tmpTr);
        $this->jenisTr = $tmpTr[0]->jenis_master;

        $cCode = "_TR_" . $this->jenisTr;
        $masterID = $_SESSION[$cCode]['main']['masterID'];
        $topID = $tmpTr[0]->id_top;
        $tmpNomorNota = $tmpTr[0]->nomer;
        $origJenis = $tmpTr[0]->jenis_master;

        //            $trID = $tmpTr[0]->id_master;
        $trID = $tmpTr[0]->transaksi_id;
        $this->db->trans_start();
        $dwsign = $tr->writeSignature($masterID, array(
            "nomer" => "edit",
            "step_number" => $stepNum,
            "step_code" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['target'],
            "step_name" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'],
            "group_code" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['userGroup'],
            "oleh_id" => $this->session->login['id'],
            "oleh_nama" => $this->session->login['nama'],
            "keterangan" => $this->config->item("heTransaksi_ui")[$origJenis]['steps'][$stepNum]['label'] . " oleh " . $this->session->login['nama'],
            "transaksi_id" => $masterID,
        )) or die("Failed to write signature");
        //        $no = $this->uri->segment(3);
        cekLime($this->db->last_query());

        //        arrPrint($this->uri->segment_array());
        $tr->setFilters(array());
        $tr->addFilter("transaksi_id='$no'");
        $tr->addFilter("param='main'");
        $sourceMain = $tr->lookupRegistries()->result();
        $sourceValues = blobDecode($sourceMain[0]->values);


        $selectedReplacer = array(
            "dateFaktur" => $_SESSION[$cCode]['main']['dateFaktur'],
            "eFaktur" => $_SESSION[$cCode]['main']['eFaktur'],
            "olehID" => $this->session->login['id'],
            "olehName" => $this->session->login['nama'],
        );


        foreach ($selectedReplacer as $key => $val) {
            $sourceValues[$key] = $val;
        }
        $baseRegistries = array(
            'main' => $sourceValues,
        );

        //set trash 1 untuk main
        $dataStatus = array(
            //             "status" =>" 0",
            "trash" => "1",

        );
        $condite = "transaksi_id='$no' and param='main'";
        $doUpdateReg = $tr->updateRegistry($condite, $dataStatus);
        cekHitam($this->db->last_query());

        $doWriteReg = $tr->writeRegistries($no, $baseRegistries) or die(lgShowError("Ada kesalahan", "Gagal saat berusaha  write base params into registries"));
        //        cekLime($this->db->last_query());
        //        matiHEre();


        //==================================================================================================
        //==MENULIS LOCKER TRANSAKSI ACTIVE=================================================================
        if ($transaksiID_reference > 0) {
            $this->load->model("Mdls/MdlLockerTransaksi");
            $lt = New MdlLockerTransaksi();
            $lt->execLocker($_SESSION[$cCode]['main'], $nextProp['num'], $transaksiID_reference, NULL);
        }
        //==========================================================================================================


        //region writelog
        $this->load->model("Mdls/" . "MdlActivityLog");
        $hTmp = new MdlActivityLog();
        $tmpHData = array(
            "title" => $sourceValues['jenisTrName'],
            "sub_title" => "Saving edit faktur",
            "uid" => $this->session->login['id'],
            "uname" => $this->session->login['nama'],
            "dtime" => date("Y-m-d H:i:s"),
            "transaksi_id" => $no,
            "deskripsi_old" => "",
            "deskripsi_new" => base64_encode(serialize($sourceValues)),
            "jenis" => $this->jenisTr,
            "ipadd" => $_SERVER['REMOTE_ADDR'],
            "devices" => $_SERVER['HTTP_USER_AGENT'],
            "category" => "transaksi",
            "controller" => $this->uri->segment(1),
            "method" => $this->uri->segment(2),
            "url" => current_url(),

        );
        $logID = $hTmp->addData($tmpHData, $hTmp->getTableName()) or die(lgShowError("Gagal menulis riwayat data", __FILE__));
        cekHitam($this->db->last_query());
        //endregion
        //        matiHEre();
        $this->db->trans_complete() or die("Gagal saat berusaha  commit transaction!");
        if (isset($_SESSION[$cCode])) {
            unset($_SESSION[$cCode]);
        }

        if (isset($_SESSION["_TR_" . $origJenis])) {
            unset($_SESSION["_TR_" . $origJenis]);
        }

        if (isset($oldCode)) {
            if (isset($_SESSION[$oldCode])) {
                unset($_SESSION[$oldCode]);
            }
        }

        //region feedback msg
        $this->session->errMsg = "transaction entry has been saved<br>";
        $nextNum = $nextProp["num"];
        if (isset($this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum])) {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $this->session->errMsg .= "This entry needs to be authorized by <strong class='text-blue'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['userGroup'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewIncomplete/" . $this->jenisTr;

        }
        else {
            $this->session->errMsg .= "transaction state: <strong class='badge bg-grey text-white'>" . $this->config->item("heTransaksi_ui")[$this->jenisTr]['steps'][$nextNum]['stateLabel'] . "</strong><br>";
            $trBackLink = base_url() . get_class($this) . "/viewHistory/" . $this->jenisTr;

        }
        $trBackClick = "location.href='$trBackLink'";
        if (isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum])) {
            $printLocation = $this->config->item('heTransaksi_layout')[$this->jenisTr]['printLocation'];
            $printException = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['printException'][$stepNum]) ? "/" . $this->config->item('heTransaksi_layout')[$this->jenisTr]['printException'][$stepNum] : "";
            $printSettings = isset($this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum]) ? $this->config->item('heTransaksi_layout')[$this->jenisTr]['allowPrint'][$stepNum] : array();
            if (isset($printSettings['size'])) {
                switch ($printSettings['size']) {
                    case "normal":
                        //                        cekkuning("size: NORMAL");
                        echo "<script>";
                        echo "top.popBig('" . base_url() . $printLocation . "$tmpNomorNota2$printException');";
                        echo "top.location.reload();";
                        echo "</script>";
                        break;
                    case "small":
                        //                        cekkuning("size: SMALL");
                        echo "<script>";
                        echo "top.popSmall('" . base_url() . $printLocation . "$tmpNomorNota2$printException');";
                        echo "top.location.reload();";
                        echo "</script>";
                        break;
                    default:
                        //                        cekkuning("size: UNKNOWN");
                        break;
                }
            }
            else {
                $arrAlert = array(
                    "type" => "success",
                    "title" => "Transaction saved",
                    //                        "html" => "your order has been saved and ready to process",
                    "html" => $this->session->errMsg,
                    "timer" => "1500",
                    "showConfirmButton" => false,
                    "allowOutsideClick" => false,
                );
                echo swalAlert($arrAlert);
                echo "<script>topReload(1500)</script>";
                echo topReload();
                echo "</script>";
                unset($this->session->errMsg);
            }

        }
        else {
            $arrAlert = array(
                "type" => "success",
                "title" => "Transaction saved",
                //                        "html" => "your order has been saved and ready to process",
                "html" => $this->session->errMsg,
                "timer" => "1500",
                "showConfirmButton" => false,
                "allowOutsideClick" => false,
            );
            echo swalAlert($arrAlert);
            echo "<script>topReload(1500)</script>";
            echo topReload();
            echo "</script>";
            unset($this->session->errMsg);
        }
        //        $this->session->errMsg .= "<br><a href='javascript:void(0)' onclick=\"$trBackClick\">view entry</a><br>";
        //endregion
    }




    //    public function recordAddRow()
    //    {
    //
    //        $jenisTr = $this->uri->segment(3);
    //        $cCode = "_TR_" . $jenisTr;
    //        $rowName = $this->uri->segment(4);
    //
    //
    //        $val = ($_GET['val']);
    //
    //        if (!isset($_SESSION[$cCode]['add_rows'])) {
    //            $_SESSION[$cCode]['add_rows'] = array();
    //        }
    //        $_SESSION[$cCode]['add_rows'][$rowName] = $val;
    //
    //        //==masukkan ke gerbang utama
    //        $_SESSION[$cCode]["main"][$rowName] = $val;
    //        //        $_SESSION[$cCode]["main"][$rowName] = $val;
    //
    //
    //        //        echo "<script>";
    //        //        echo "top.getData('" . base_url() . "_shoppingCart/viewCart/$jenisTr/?kAhHJASAGHSGfags=kak','shopping_cart')";
    //        //        echo "</script>";
    //
    //        echo "<script>";
    //        echo "top.$('#result').load('" . base_url() . "ValueGate/buildValues/" . $jenisTr . "?epreketek=yes');";
    //        echo "</script>";
    //
    //    }

    public function debugBayar() //print values from sessions
    {
        echo "<table border='1'>";
        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $totals = array(
            "hpp" => 0,
            "labakotor" => 0,
            "nilaibayar" => 0,
            "harusnya" => 0,
            "selisih" => 0,
        );
        if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
            foreach ($_SESSION[$cCode]['items'] as $iID => $iSpec) {

                if ($iSpec['__hpp'] < 1 || $iSpec['__laba_kotor'] < 1) {
                    //                if($iSpec['__hpp']>0 || $iSpec['__laba_kotor']>0){
                    echo "<tr>";

                    $harus = ($iSpec['__hpp'] + $iSpec['__laba_kotor']);
                    $selisih = ($harus - $iSpec['nilai_bayar']);

                    echo "<td>" . $iSpec['id'] . "</td>";
                    echo "<td>" . $iSpec['nama'] . "</td>";
                    echo "<td>" . $iSpec['persenValue'] . "</td>";
                    echo "<td>" . $iSpec['__hpp'] . "</td>";
                    echo "<td>" . $iSpec['__laba_kotor'] . "</td>";
                    echo "<td>" . $iSpec['nilai_bayar'] . "</td>";
                    $bgColor = $harus == $iSpec['nilai_bayar'] ? "#ddffdd" : "#ffdddd";
                    echo "<td bgcolor='$bgColor'>" . $harus . "</td>";
                    echo "<td bgcolor='$bgColor'>" . number_format($selisih, 10) . "</td>";

                    echo "</tr>";


                    $totals["hpp"] += $iSpec['__hpp'];
                    $totals["labakotor"] += $iSpec['__laba_kotor'];
                    $totals["nilaibayar"] += $iSpec['nilai_bayar'];
                    $totals["harusnya"] += $harus;
                    $totals["selisih"] += $selisih;
                }


            }
        }


        echo "<tr bgcolor=#e0e0e0>";
        echo "<td></td>";
        echo "<td></td>";
        echo "<td></td>";
        echo "<td>" . $totals['hpp'] . "</td>";
        echo "<td>" . $totals['labakotor'] . "</td>";
        echo "<td>" . $totals['nilaibayar'] . "</td>";
        echo "<td>" . $totals['harusnya'] . "</td>";
        echo "<td>" . $totals['selisih'] . "</td>";
        echo "</tr bgcolor=#e0e0e0>";

        echo "</table border=1>";

    }

    public function debugBayarInject() //print values from sessions
    {
        echo "<table border='1'>";
        $this->jenisTr = $this->uri->segment(3);
        $cCode = "_TR_" . $this->jenisTr;

        $totals = array(
            "hpp" => 0,
            "labakotor" => 0,
            "nilaibayar" => 0,
            "harusnya" => 0,
            "selisih" => 0,
        );
        $arrIDs = array();
        if (isset($_SESSION[$cCode]['items']) && sizeof($_SESSION[$cCode]['items']) > 0) {
            $no = 0;
            foreach ($_SESSION[$cCode]['items'] as $iID => $iSpec) {

                if ($iSpec['__hpp'] < 1 || $iSpec['__laba_kotor'] < 1) {
                    $no++;
                    $arrIDs[$no] = $iSpec['id'];

                    //                if($iSpec['__hpp']>0 || $iSpec['__laba_kotor']>0){
                    echo "<tr>";

                    $harus = ($iSpec['__hpp'] + $iSpec['__laba_kotor']);
                    $selisih = ($harus - $iSpec['nilai_bayar']);

                    echo "<td>" . $iSpec['id'] . "</td>";
                    echo "<td>" . $iSpec['nama'] . "</td>";
                    echo "<td>" . $iSpec['persenValue'] . "</td>";
                    echo "<td>" . $iSpec['__hpp'] . "</td>";
                    echo "<td>" . $iSpec['__laba_kotor'] . "</td>";
                    echo "<td>" . $iSpec['nilai_bayar'] . "</td>";
                    $bgColor = $harus == $iSpec['nilai_bayar'] ? "#ddffdd" : "#ffdddd";
                    echo "<td bgcolor='$bgColor'>" . $harus . "</td>";
                    echo "<td bgcolor='$bgColor'>" . number_format($selisih, 10) . "</td>";

                    echo "</tr>";


                    $totals["hpp"] += $iSpec['__hpp'];
                    $totals["labakotor"] += $iSpec['__laba_kotor'];
                    $totals["nilaibayar"] += $iSpec['nilai_bayar'];
                    $totals["harusnya"] += $harus;
                    $totals["selisih"] += $selisih;
                }


            }
        }

        echo "<tr bgcolor=#e0e0e0>";
        echo "<td></td>";
        echo "<td></td>";
        echo "<td></td>";
        echo "<td>" . $totals['hpp'] . "</td>";
        echo "<td>" . $totals['labakotor'] . "</td>";
        echo "<td>" . $totals['nilaibayar'] . "</td>";
        echo "<td>" . $totals['harusnya'] . "</td>";
        echo "<td>" . $totals['selisih'] . "</td>";
        echo "</tr bgcolor=#e0e0e0>";

        echo "</table border=1>";


        //        arrPrint($arrIDs);
        if (sizeof($arrIDs) > 0) {
            $this->load->model("MdlTransaksi");
            $tr = New MdlTransaksi();
            $tr->setFilters(array());
            $tr->addFilter("transaksi_id in (" . implode(",", $arrIDs) . ")");
            $tr->addFilter("param='items'");
            $tmpRegistries = $tr->lookupRegistries()->result();
            //            arrPrint($tmpRegistries);
            $tmpReg = array();
            if (sizeof($tmpRegistries) > 0) {
                foreach ($tmpRegistries as $tmpRegSpec) {
                    $tmpReg[$tmpRegSpec->transaksi_id] = blobDecode($tmpRegSpec->values);
                }
                //                arrPrint($tmpReg);
                //                $regItemsID = array();
                //                $regItemsRasio = array();
                foreach ($tmpReg as $trID_749 => $regSpec) {
                    foreach ($regSpec as $x => $regSpecItems) {
                        $trID_580 = $regSpecItems["id"];
                        $rasio = ($regSpecItems["nilai_bayar"] / $regSpecItems["sisa"]) * 100;
                        $regItemsID[$x] = $trID_580;
                        $regItemsRasio[$trID_749][$trID_580] = $rasio;
                    }
                }
                //                arrPrint($regItemsID);
                //                arrPrint($regItemsRasio);

                $tr = New MdlTransaksi();
                $tr->setFilters(array());
                $tr->addFilter("transaksi_id in (" . implode(",", $regItemsID) . ")");
                $tr->addFilter("param='main'");
                $tmpMainRegistries = $tr->lookupRegistries()->result();
                //                arrPrint($tmpMainRegistries);
                if (sizeof($tmpMainRegistries) > 0) {
                    $tmpMainReg = array();
                    foreach ($tmpMainRegistries as $tmpMainRegSpec) {
                        $tmpMainReg[$tmpMainRegSpec->transaksi_id] = blobDecode($tmpMainRegSpec->values);
                    }
                    //                    arrPrint($tmpMainReg);
                    $resultMainReg = array();
                    foreach ($regItemsRasio as $trID_749 => $regRasioSpec) {
                        foreach ($regRasioSpec as $trID_580 => $rasio) {
                            if (array_key_exists($trID_580, $tmpMainReg)) {
                                $resultMainReg[$trID_749][$trID_580] = array(
                                    "hpp" => $tmpMainReg[$trID_580]["hpp"] * ($rasio / 100),
                                    "harga" => $tmpMainReg[$trID_580]["tagihan"] * ($rasio / 100),
                                    "laba_kotor" => ($tmpMainReg[$trID_580]["tagihan"] - $tmpMainReg[$trID_580]["hpp"]) * ($rasio / 100),
                                );
                            }
                        }
                    }
                    arrPrint($resultMainReg);
                }
            }
        }

    }
}
